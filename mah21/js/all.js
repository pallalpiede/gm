!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).pc={})}(this,function(e){function t(e){var t,i=[],s=e.length;for(t=0;t<s;++t)i.push(e[t]);return i}function i(e){if(null===e)return"null";var t=typeof e;return"undefined"===t||"number"===t||"string"===t||"boolean"===t?t:Br[Object.prototype.toString.call(e)]}function s(e,t){var n;for(n in t){var r=t[n];"object"==i(r)?e[n]=s({},r):"array"==i(r)?e[n]=s([],r):e[n]=r}return e}function n(e){return void 0!==e}function r(){this._callbacks={},this._callbackActive={}}function a(e,t){var i=e.length;if(0>(t=t||0)||t>=i)return null;var s=e.charCodeAt(t);return 1<i&&55296<=s&&56319>=s&&(56320<=(e=e.charCodeAt(t+1))&&57343>=e)?{code:1024*(s-55296)+e-56320+65536,long:!0}:{code:s,long:!1}}function o(e,t,i){return!!e&&(!!(e=a(e))&&((e=e.code)>=t&&e<=i))}function h(e,t,i,s){var n=e&&e.length;3===n||4===n?(this.r=e[0],this.g=e[1],this.b=e[2],this.a=void 0!==e[3]?e[3]:1):(this.r=e||0,this.g=t||0,this.b=i||0,this.a=void 0!==s?s:1)}function l(){this._list=[],this._index={}}function c(e){this._index={},this._key=e||null}function d(e){r.call(this),this._index={},this._list=[],this._parent=e}function u(){this._isRunning=!1,this._b=this._a=0}function p(e){e=e.match(/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/),this.scheme=e[2],this.authority=e[4],this.path=e[5],this.query=e[7],this.fragment=e[9],this.toString=function(){var e="";return this.scheme&&(e+=this.scheme+":"),this.authority&&(e+="//"+this.authority),e+=this.path,this.query&&(e+="?"+this.query),this.fragment&&(e+="#"+this.fragment),e},this.getQuery=function(){var e,t={};this.query&&decodeURIComponent(this.query).split("&").forEach(function(i,s,n){e=i.split("="),t[e[0]]=e[1]},this);return t},this.setQuery=function(e){var t,i="";for(t in e)e.hasOwnProperty(t)&&(""!==i&&(i+="&"),i+=encodeURIComponent(t)+"="+encodeURIComponent(e[t]));this.query=i}}function f(){}function m(e,t){this._curve=e,this._left=-1/0,this._right=1/0,this._m1=this._m0=this._p1=this._p0=this._recip=0,this._reset(t||0)}function _(e){if(this.keys=[],this.type=1,this.tension=.5,this._eval=new m(this),e)for(var t=0;t<e.length-1;t+=2)this.keys.push([e[t],e[t+1]]);this.sort()}function g(){var e;if(this.curves=[],this._type=1,1<arguments.length)for(e=0;e<arguments.length;e++)this.curves.push(new _(arguments[e]));else if(0===arguments.length)this.curves.push(new _);else{var t=arguments[0];if("number"===pc.type(t))for(e=0;e<t;e++)this.curves.push(new _);else for(e=0;e<t.length;e++)this.curves.push(new _(t[e]))}}function y(){var e=new Float32Array(9);e[0]=e[4]=e[8]=1,this.data=e}function v(e,t,i){e&&3===e.length?(this.x=e[0],this.y=e[1],this.z=e[2]):(this.x=e||0,this.y=t||0,this.z=i||0)}function b(e,t,i,s){e&&4===e.length?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e||0,this.y=t||0,this.z=i||0,this.w=s||0)}function x(){var e=new Float32Array(16);e[0]=e[5]=e[10]=e[15]=1,this.data=e}function S(e,t,i,s){e&&4===e.length?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=void 0===e?0:e,this.y=void 0===t?0:t,this.z=void 0===i?0:i,this.w=void 0===s?1:s)}function T(e,t){e&&2===e.length?(this.x=e[0],this.y=e[1]):(this.x=e||0,this.y=t||0)}function w(e,t){this.center=e||new v(0,0,0),this.halfExtents=t||new v(.5,.5,.5),this._min=new v,this._max=new v}function M(e,t){this.center=e||new v(0,0,0),this.radius=void 0===t?.5:t}function P(e,t){e=e||(new x).setPerspective(90,16/9,.1,1e3),t=t||new x,this.planes=[];for(var i=0;6>i;i++)this.planes[i]=[];this.update(e,t)}function A(e,t){this.origin=e||new v(0,0,0),this.direction=t||new v(0,0,-1)}function E(e,t){this.halfExtents=t||new v(.5,.5,.5),e=e||oa.setIdentity(),this._modelTransform=e.clone().invert(),this._worldTransform=e.clone(),this._aabb=new w(new v,this.halfExtents)}function C(e,t){this.normal=t||new v(0,0,1),this.point=e||new v(0,0,0)}function I(e,t,i,s,n){this.usage=s||0,this.format=t,this.numVertices=i,this.numBytes=t.verticesByteSize?t.verticesByteSize:t.size*i,e._vram.vb+=this.numBytes,this.device=e,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this)}function O(e){for(var t=0,i=0,s=e.length;i<s;i++)t=(t<<5)-t+e.charCodeAt(i),t|=0;return t}function R(e,t,i){var s;this.elements=[],this.hasTangents=this.hasColor=this.hasUv1=this.hasUv0=!1,this._defaultInstancingFormat=null,this.verticesByteSize=0,this.vertexCount=i,this.interleaved=!i,this.size=t.reduce(function(e,t){return e+4*Math.ceil(t.components*ca[t.type]/4)},0);var n=0,r=0;for(s=t.length;r<s;r++){var a=t[r],o=a.components*ca[a.type];i&&(n=pc.math.roundUp(n,o));var h={name:a.semantic,offset:i?n:a.hasOwnProperty("offset")?a.offset:n,stride:i?o:a.hasOwnProperty("stride")?a.stride:this.size,stream:-1,scopeId:e.scope.resolve(a.semantic),dataType:a.type,numComponents:a.components,normalize:void 0!==a.normalize&&a.normalize,size:o};this.elements.push(h),n=i?n+o*i:n+4*Math.ceil(o/4),"TEXCOORD0"===a.semantic?this.hasUv0=!0:"TEXCOORD1"===a.semantic?this.hasUv1=!0:"COLOR"===a.semantic?this.hasColor=!0:"TANGENT"===a.semantic&&(this.hasTangents=!0)}i&&(this.verticesByteSize=n),this.batchingHash=this._evaluateBatchingHash()}function D(e,t,i){switch(this.index=0,this.numComponents=t.numComponents,this.array=i.interleaved?new la[t.dataType](e,t.offset):new la[t.dataType](e,t.offset,i.vertexCount*t.numComponents),this.stride=t.stride/this.array.constructor.BYTES_PER_ELEMENT,t.numComponents){case 1:this.set=L,this.getToArray=G,this.setFromArray=k;break;case 2:this.set=F,this.getToArray=j,this.setFromArray=U;break;case 3:this.set=B,this.getToArray=W,this.setFromArray=z;break;case 4:this.set=N,this.getToArray=H,this.setFromArray=V}}function L(e){this.array[this.index]=e}function F(e,t){this.array[this.index]=e,this.array[this.index+1]=t}function B(e,t,i){this.array[this.index]=e,this.array[this.index+1]=t,this.array[this.index+2]=i}function N(e,t,i,s){this.array[this.index]=e,this.array[this.index+1]=t,this.array[this.index+2]=i,this.array[this.index+3]=s}function k(e,t,i){this.array[e]=t[i]}function U(e,t,i){this.array[e]=t[i],this.array[e+1]=t[i+1]}function z(e,t,i){this.array[e]=t[i],this.array[e+1]=t[i+1],this.array[e+2]=t[i+2]}function V(e,t,i){this.array[e]=t[i],this.array[e+1]=t[i+1],this.array[e+2]=t[i+2],this.array[e+3]=t[i+3]}function G(e,t,i){t[i]=this.array[e]}function j(e,t,i){t[i]=this.array[e],t[i+1]=this.array[e+1]}function W(e,t,i){t[i]=this.array[e],t[i+1]=this.array[e+1],t[i+2]=this.array[e+2]}function H(e,t,i){t[i]=this.array[e],t[i+1]=this.array[e+1],t[i+2]=this.array[e+2],t[i+3]=this.array[e+3]}function X(e){this.vertexBuffer=e,this.vertexFormatSize=e.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={},e=this.vertexBuffer.getFormat();for(var t=0;t<e.elements.length;t++){var i=e.elements[t];this.accessors[t]=new D(this.buffer,i,e),this.element[i.name]=this.accessors[t]}}function q(e,t,i,s,n,r){if(null===pa){var a=new R(e,[{semantic:"POSITION",components:2,type:6}]);(a=new X(pa=new I(e,a,4))).element.POSITION.set(-1,-1),a.next(),a.element.POSITION.set(1,-1),a.next(),a.element.POSITION.set(-1,1),a.next(),a.element.POSITION.set(1,1),a.end()}if(a=e.renderTarget,e.setRenderTarget(t),e.updateBegin(),s)var o=s.x,h=s.y,l=s.z,c=s.w;else l=t?t.width:e.width,c=t?t.height:e.height,h=o=0;if(n)var d=n.x,u=n.y,p=n.z,f=n.w;else d=o,u=h,p=l,f=c;n=e.vx,s=e.vy,t=e.vw;var m=e.vh;e.setViewport(o,h,l,c),l=e.sx,o=e.sy,h=e.sw,c=e.sh,e.setScissor(d,u,p,f),d=e.getDepthTest(),u=e.getDepthWrite(),p=e.getCullMode(),f=e.writeRed;var _=e.writeGreen,g=e.writeBlue,y=e.writeAlpha;e.setDepthTest(!1),e.setDepthWrite(!1),e.setCullMode(0),e.setColorWrite(!0,!0,!0,!0),r||e.setBlending(!1),e.setVertexBuffer(pa,0),e.setShader(i),e.draw(fa),e.setDepthTest(d),e.setDepthWrite(u),e.setCullMode(p),e.setColorWrite(f,_,g,y),e.updateEnd(),e.setRenderTarget(a),e.updateBegin(),e.setViewport(n,s,t,m),e.setScissor(l,o,h,c)}function Y(e,t){this.device=e,this.definition=t,this.attributes=[],this.uniforms=[],this.samplers=[],this.ready=!1,this.device.createShader(this)}function K(e,t){this.device=e,this.name=null,this._height=this._width=4,this._depth=1,this._format=7,this.type="default",this.fixCubemapSeams=this._volume=this._cubemap=!1,this._flipY=!0,this._premultiplyAlpha=!1,this._mipmaps=!0,this._minFilter=5,this._anisotropy=this._magFilter=1,this._addressW=this._addressV=this._addressU=0,this._compareOnRead=!1,this._compareFunc=1,void 0!==t&&(void 0!==t.name&&(this.name=t.name),this._width=void 0!==t.width?t.width:this._width,this._height=void 0!==t.height?t.height:this._height,this._format=void 0!==t.format?t.format:this._format,t.hasOwnProperty("type")?this.type=t.type:t.hasOwnProperty("rgbm")?this.type=t.rgbm?"rgbm":"default":t.hasOwnProperty("swizzleGGGR")&&(this.type=t.swizzleGGGR?"swizzleGGGR":"default"),this._mipmaps=void 0!==t.mipmaps?t.mipmaps:void 0!==t.autoMipmap?t.autoMipmap:this._mipmaps,this._levels=t.levels,this._cubemap=void 0!==t.cubemap?t.cubemap:this._cubemap,this.fixCubemapSeams=void 0!==t.fixCubemapSeams?t.fixCubemapSeams:this.fixCubemapSeams,this._minFilter=void 0!==t.minFilter?t.minFilter:this._minFilter,this._magFilter=void 0!==t.magFilter?t.magFilter:this._magFilter,this._anisotropy=void 0!==t.anisotropy?t.anisotropy:this._anisotropy,this._addressU=void 0!==t.addressU?t.addressU:this._addressU,this._addressV=void 0!==t.addressV?t.addressV:this._addressV,this._compareOnRead=void 0!==t.compareOnRead?t.compareOnRead:this._compareOnRead,this._compareFunc=void 0!==t._compareFunc?t._compareFunc:this._compareFunc,this._flipY=void 0!==t.flipY?t.flipY:this._flipY,this._premultiplyAlpha=void 0!==t.premultiplyAlpha?t.premultiplyAlpha:this._premultiplyAlpha,e.webgl2&&(this._depth=void 0!==t.depth?t.depth:this._depth,this._volume=void 0!==t.volume?t.volume:this._volume,this._addressW=void 0!==t.addressW?t.addressW:this._addressW)),this._compressed=8===this._format||9===this._format||10===this._format||21<=this._format,this._invalid=!1,this._lockedLevel=-1,this._levels||(this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]),this.dirtyAll(),this._gpuSize=0}function Z(e,t,i,s,n){if(this.usage=s||0,this.format=t,this.numIndices=i,this.device=e,i=this.device.gl,0===t){var r=1;this.glFormat=i.UNSIGNED_BYTE}else 1===t?(r=2,this.glFormat=i.UNSIGNED_SHORT):2===t&&(r=4,this.glFormat=i.UNSIGNED_INT);this.bytesPerIndex=r,this.numBytes=this.numIndices*r,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),e._vram.ib+=this.numBytes,this.device.buffers.push(this)}function $(){this.initDefaults()}function Q(e,t,i,s){this.data=e,this.componentCount=t,this.dataType=i,this.dataTypeNormalize=s}function J(e){this._refCount=0,this.id=Ca++,this.device=e||Ln.getApplication().graphicsDevice,this.vertexBuffer=null,this.indexBuffer=[null],this.primitive=[{type:0,base:0,count:0}],this._geometryData=this.morph=this.skin=null,this._aabb=new w,this.boneAabb=null}function ee(e,t,i){this._key=[0,0],this._shader=[null,null,null],this.isStatic=!1,this._staticSource=this._staticLightList=null,this.node=e,this._mesh=t,t.incReference(),this.material=i,this._shaderDefs=65536,this._shaderDefs|=t.vertexBuffer.format.hasUv0?4:0,this._shaderDefs|=t.vertexBuffer.format.hasUv1?8:0,this._shaderDefs|=t.vertexBuffer.format.hasColor?16:0,this._shaderDefs|=t.vertexBuffer.format.hasTangents?512:0,this._lightHash=0,this.visible=!0,this.layer=15,this.renderStyle=0,this.castShadow=!1,this._receiveShadow=!0,this._noDepthDrawGl1=this._screenSpace=!1,this._updateAabb=this.pick=this.cull=!0,this._calculateSortDistance=this._updateAabbFunc=null,this.updateKey(),this.instancingData=this._morphInstance=this._skinInstance=null,this.aabb=new w,this._aabbVer=-1,this.visibleThisFrame=this.drawOrder=0,this.isVisibleFunc=null,this.parameters={},this.stencilBack=this.stencilFront=null,this.flipFaces=!1}function te(e,t,i){this._key=[],this._key[0]=(15&e)<<27|(3===t?1:0)<<26|33554432,this.command=i}function ie(e){this.count=e,this.vertexBuffer=null,this.offset=0}function se(e,t){this.device=t||Ln.getApplication().graphicsDevice,this._targets=e,this.device.supportsMorphTargetTexturesCore&&(this.device.extTextureHalfFloat&&this.device.textureHalfFloatRenderable?this._renderTextureFormat=se.FORMAT_HALF_FLOAT:this.device.extTextureFloat&&this.device.textureFloatRenderable&&(this._renderTextureFormat=se.FORMAT_FLOAT),this.device.extTextureHalfFloat&&this.device.textureHalfFloatUpdatable?this._textureFormat=se.FORMAT_HALF_FLOAT:this.device.extTextureFloat&&(this._textureFormat=se.FORMAT_FLOAT),void 0!==this._renderTextureFormat&&void 0!==this._textureFormat&&(this._useTextureMorph=!0)),this._init(),this._updateMorphFlags(),this._calculateAabb()}function ne(e){this.morph=e,this.device=e.device,this.meshInstance=null,this._weights=[];for(var t=0;t<e._targets.length;t++)this.setWeight(t,e._targets[t].defaultWeight);if(this._activeTargets=[],e.useTextureMorph){for(this.shaderCache={},this.maxSubmitCount=this.device.maxTextures,this.maxSubmitCount=2,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount),t=function(t,i){return this[i]=e._createTexture(t,e._renderTextureFormat===se.FORMAT_FLOAT?14:12),new Bu({colorBuffer:this[i],depth:!1})}.bind(this),e.morphPositions&&(this.rtPositions=t("MorphRTPos","texturePositions")),e.morphNormals&&(this.rtNormals=t("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([e.morphTextureWidth,e.morphTextureHeight,1/e.morphTextureWidth,1/e.morphTextureHeight]),t=0;t<this.maxSubmitCount;t++)this["morphBlendTex"+t]=this.device.scope.resolve("morphBlendTex"+t);this.morphFactor=this.device.scope.resolve("morphFactor[0]")}else this.maxSubmitCount=8,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount),this._shaderMorphWeightsA=new Float32Array(this._shaderMorphWeights.buffer,0,4),this._shaderMorphWeightsB=new Float32Array(this._shaderMorphWeights.buffer,16,4),this._activeVertexBuffers=Array(this.maxSubmitCount)}function re(e,t,i){this.device=e,this.inverseBindPose=t,this.boneNames=i}function ae(e){this._dirty=!0,e&&this.initSkin(e)}function oe(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=!1}function he(e,t,i){this.origMeshInstances=e,this._aabb=new w,this.model=this.meshInstance=null,this.dynamic=t,this.batchGroupId=i,this.refCounter=0}function le(e,t,i,s,n){this.dynamic=i,this.maxAabbSize=s,this.id=e,this.name=t,this.layers=void 0===n?[0]:n,this._sprite=this._ui=!1,this._obj={model:[],element:[],sprite:[]}}function ce(e,t,i){ae.call(this),ae.prototype.init.call(this,e,t.length),this.device=e,this.rootNode=i,this.bones=t}function de(e,t,i){this.device=e,this.rootNode=t,this.scene=i,this._init=!1,this._batchGroups={},this._batchGroupCounter=0,this._batchList=[],this._dirtyGroups=[]}function ue(e,t){if(e&&!t||!e&&t)return!1;if((e=e.data)===(t=t.data))return!0;if(e instanceof Float32Array&&t instanceof Float32Array){if(e.length!==t.length)return!1;for(var i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}return!1}function pe(e,t){for(var i in e)if(e.hasOwnProperty(i)&&!ue(e[i],t[i]))return!1;for(i in t)if(t.hasOwnProperty(i)&&!ue(t[i],e[i]))return!1;return!0}function fe(e,t){var i;for(i=0;i<e.length;i++)if(0>t.indexOf(e[i]))return!1;for(i=0;i<t.length;i++)if(0>e.indexOf(t[i]))return!1;return!0}function me(e){return(e=e.node.worldTransform).getX(Da),e.getY(La),e.getZ(Fa),Da.cross(Da,La),0<=Da.dot(Fa)?1:-1}function _e(){this._projection=0,this._nearClip=.1,this._farClip=1e4,this._shaderParams=new Float32Array(4),this._fov=45,this._orthoHeight=10,this._aspect=16/9,this._aspectRatioMode=0,this.frustumCulling=this._horizontalFov=!1,this.cullingMask=4294967295,this._renderDepthRequests=0,this._projMatDirty=!0,this._projMat=new x,this._projMatSkybox=new x,this._viewMatDirty=!0,this._viewMat=new x,this._viewProjMatDirty=!0,this._viewProjMat=new x,this.vrDisplay=null,this._rect={x:0,y:0,width:1,height:1},this._scissorRect={x:0,y:0,width:1,height:1},this.frustum=new P(this._projMat,this._viewMat),this._depthTarget=this.renderTarget=null,this._clearOptions={color:[.5,.5,.5,1],depth:1,stencil:0,flags:7},this.calculateTransform=this._node=null,this.overrideCalculateTransform=!1,this.calculateProjection=null,this.overrideCalculateProjection=!1,this._cullFaces=!0,this._flipFaces=!1,this._component=null}function ge(e){r.call(this),this.name="string"==typeof e?e:"Untitled",this.tags=new d(this),this._labels={},this.localPosition=new v(0,0,0),this.localRotation=new S(0,0,0,1),this.localScale=new v(1,1,1),this.localEulerAngles=new v(0,0,0),this.position=new v(0,0,0),this.rotation=new S(0,0,0,1),this.eulerAngles=new v(0,0,0),this._scale=null,this.localTransform=new x,this._dirtyLocal=!1,this._aabbVer=0,this._frozen=!1,this.worldTransform=new x,this._dirtyWorld=!1,this.normalMatrix=new y,this._dirtyNormal=!0,this._parent=this._forward=this._up=this._right=null,this._children=[],this._graphDepth=0,this._enabled=!0,this.scaleCompensation=this._enabledInHierarchy=!1}function ye(e,t){return e.priority-t.priority}function ve(e,t){return t.key-e.key}function be(){this.list=[],this.length=0,this.done=!1}function xe(){this.opaqueMeshInstances=[],this.transparentMeshInstances=[],this.shadowCasters=[],this.visibleOpaque=[],this.visibleTransparent=[]}function Se(e){void 0!==(e=e||{}).id?(this.id=e.id,Ja=Math.max(this.id+1,Ja)):this.id=Ja++,this.name=e.name,this._refCounter=(this._enabled=void 0===e.enabled||e.enabled)?1:0,this.opaqueSortMode=void 0===e.opaqueSortMode?2:e.opaqueSortMode,this.transparentSortMode=void 0===e.transparentSortMode?3:e.transparentSortMode,this.renderTarget=e.renderTarget,this.shaderPass=void 0===e.shaderPass?0:e.shaderPass,this.passThrough=void 0!==e.passThrough&&e.passThrough,this.overrideClear=void 0!==e.overrideClear&&e.overrideClear,this._clearColor=new h(0,0,0,1),e.clearColor&&this._clearColor.copy(e.clearColor),this._clearColorBuffer=void 0!==e.clearColorBuffer&&e.clearColorBuffer,this._clearDepthBuffer=void 0!==e.clearDepthBuffer&&e.clearDepthBuffer,this._clearStencilBuffer=void 0!==e.clearStencilBuffer&&e.clearStencilBuffer,this._clearOptions={color:[this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearColor.a],depth:1,stencil:0,flags:(this._clearColorBuffer?1:0)|(this._clearDepthBuffer?2:0)|(this._clearStencilBuffer?4:0)},this.onPreCull=e.onPreCull,this.onPreRender=e.onPreRender,this.onPreRenderOpaque=e.onPreRenderOpaque,this.onPreRenderTransparent=e.onPreRenderTransparent,this.onPostCull=e.onPostCull,this.onPostRender=e.onPostRender,this.onPostRenderOpaque=e.onPostRenderOpaque,this.onPostRenderTransparent=e.onPostRenderTransparent,this.onDrawCall=e.onDrawCall,this.onEnable=e.onEnable,this.onDisable=e.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.instances=(this.layerReference=e.layerReference)?e.layerReference.instances:new xe,this.cullingMask=e.cullingMask?e.cullingMask:4294967295,this.opaqueMeshInstances=this.instances.opaqueMeshInstances,this.transparentMeshInstances=this.instances.transparentMeshInstances,this.shadowCasters=this.instances.shadowCasters,this.customCalculateSortValues=this.customSortCallback=null,this._lightComponents=[],this._lights=[],this._sortedLights=[[],[],[]],this.cameras=[],this._dirtyCameras=this._dirtyLights=this._dirty=!1,this._staticLightHash=this._lightHash=this._cameraHash=0,this._needsStaticPrepare=!0,this._staticPrepareDone=!1,this._shaderVersion=-1,this._version=0,this._lightCube=null}function Te(e,t,i,s){var n=3===s?14:2===s?12:4===s||0===s&&e.webgl2?16:7,r=function(e,t){return 0!==t||e.webgl2?3===t?e.extTextureFloatLinear?1:0:2===t?e.extTextureHalfFloatLinear?1:0:1:0}(e,s);return(t=new K(e,{format:n,width:t,height:i,mipmaps:!1,minFilter:r,magFilter:r,addressU:1,addressV:1})).name="shadowmap",4===s||0===s&&e.webgl2?(t.compareOnRead=!0,t.compareFunc=1,new Bu({depthBuffer:t})):new Bu({colorBuffer:t,depth:!0})}function we(e,t){(e=new K(e,{format:7,width:t,height:t,cubemap:!0,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})).name="shadowcube",t=[];for(var i,s=0;6>s;s++)i=new Bu({colorBuffer:e,face:s,depth:!0}),t.push(i);return t}function Me(e,t,i,s){s||(s=0),s=1e4*s+t;var n=fo[i][s];return n||(n=Te(e,t,t,i||0),fo[i][s]=n),n}function Pe(e,t){if(1===t._type){if(0<t._shadowType&&(t._shadowType=0),t._cacheShadowMap){var i=Vo[t._shadowResolution];i||(i=we(e,t._shadowResolution),Vo[t._shadowResolution]=i)}else i=we(e,t._shadowResolution);t._shadowCamera.renderTarget=i[0],t._shadowCubeMap=i}else i=t._cacheShadowMap?Me(e,t._shadowResolution,t._shadowType):Te(e,t._shadowResolution,t._shadowResolution,t._shadowType),t._shadowCamera.renderTarget=i;t._isCachedShadowMap=t._cacheShadowMap}function Ae(e){e=this.device=e,this._instancingTime=this._morphTime=this._skinTime=this._sortTime=this._cullTime=this._forwardTime=this._depthMapTime=this._shadowMapTime=this._shadowMapUpdates=this._materialSwitches=this._camerasRendered=this._skinDrawCalls=this._forwardDrawCalls=this._shadowDrawCalls=0,this.library=e.getProgramLibrary(),e=e.scope,this.projId=e.resolve("matrix_projection"),this.projSkyboxId=e.resolve("matrix_projectionSkybox"),this.viewId=e.resolve("matrix_view"),this.viewId3=e.resolve("matrix_view3"),this.viewInvId=e.resolve("matrix_viewInverse"),this.viewProjId=e.resolve("matrix_viewProjection"),this.viewPos=new Float32Array(3),this.viewPosId=e.resolve("view_position"),this.nearClipId=e.resolve("camera_near"),this.farClipId=e.resolve("camera_far"),this.cameraParamsId=e.resolve("camera_params"),this.shadowMapLightRadiusId=e.resolve("light_radius"),this.fogColorId=e.resolve("fog_color"),this.fogStartId=e.resolve("fog_start"),this.fogEndId=e.resolve("fog_end"),this.fogDensityId=e.resolve("fog_density"),this.modelMatrixId=e.resolve("matrix_model"),this.normalMatrixId=e.resolve("matrix_normal"),this.poseMatrixId=e.resolve("matrix_pose[0]"),this.boneTextureId=e.resolve("texture_poseMap"),this.boneTextureSizeId=e.resolve("texture_poseMapSize"),this.morphWeightsA=e.resolve("morph_weights_a"),this.morphWeightsB=e.resolve("morph_weights_b"),this.morphPositionTex=e.resolve("morphPositionTex"),this.morphNormalTex=e.resolve("morphNormalTex"),this.morphTexParams=e.resolve("morph_tex_params"),this.alphaTestId=e.resolve("alpha_ref"),this.opacityMapId=e.resolve("texture_opacityMap"),this.ambientId=e.resolve("light_globalAmbient"),this.exposureId=e.resolve("exposure"),this.skyboxIntensityId=e.resolve("skyboxIntensity"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightShadowMatrixVsId=[],this.lightShadowParamsVsId=[],this.lightDirVs=[],this.lightDirVsId=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightPosVsId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.depthMapId=e.resolve("uDepthMap"),this.screenSizeId=e.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.sourceId=e.resolve("source"),this.pixelOffsetId=e.resolve("pixelOffset"),this.weightId=e.resolve("weight[0]");var t=Ma;this.blurVsmShaderCode=[t.blurVSMPS,"#define GAUSS\n"+t.blurVSMPS],this.blurPackedVsmShaderCode=["#define PACKED\n"+this.blurVsmShaderCode[0],"#define PACKED\n"+this.blurVsmShaderCode[1]],this.blurVsmShader=[{},{}],this.blurPackedVsmShader=[{},{}],this.blurVsmWeights={},this.polygonOffsetId=e.resolve("polygonOffset"),this.polygonOffset=new Float32Array(2),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3),this.tempSemanticArray=[]}function Ee(e,t){e.data[0]=t.data[0],e.data[1]=t.data[1],e.data[2]=t.data[2],e.data[3]=t.data[4],e.data[4]=t.data[5],e.data[5]=t.data[6],e.data[6]=t.data[8],e.data[7]=t.data[9],e.data[8]=t.data[10]}function Ce(){Fn.call(this),this.color=new h(1,1,1,1),this.colorUniform=new Float32Array(4),this.colorMap=null,this.vertexColors=!1}function Ie(e){this.lineVertexFormat=new R(e,[{semantic:"POSITION",components:3,type:6},{semantic:"COLOR",components:4,type:1,normalize:!0}]),this.lineBatches=[],this.layers=[],this.layerToBatch={},this.cubeWorldPos=this.cubeLocalPos=this.quadMesh=null,this.identityGraphNode=new ge}function Oe(){this.numLinesAllocated=128,this.mesh=this.vbRam=this.vb=null,this.linesUsed=0,this.layer=this.meshInstance=this.material=null}function Re(){r.call(this),this.layerList=[],this.subLayerList=[],this.subLayerEnabled=[],this._opaqueOrder={},this._transparentOrder={},this._dirtyCameras=this._dirtyLights=this._dirtyBlend=this._dirty=!1,this._meshInstances=[],this._lights=[],this.cameras=[],this._sortedLights=[[],[],[]],this._lightShadowCasters=[],this._globalLightCameras=[],this._globalLightCameraIds=[],this._renderedRt=[],this._renderedByCam=[],this._renderedLayer=[],this._renderList=[],this._renderListCamera=[]}function De(e,t,i,s){if(e.enabled){var n;if(e.model&&e.model.model&&e.model.enabled&&(s&&s.push(e),e.model.lightmapped&&t)){var r=!0,a=e.model.model.meshInstances;for(n=0;n<a.length;n++)if(!a[n].mesh.vertexBuffer.format.hasUv1){r=!1;break}if(r){var o=[];for(n=0;n<a.length;n++){var h=!1;for(r=0;r<a.length;r++)n!==r&&a[n].mesh===a[r].mesh&&(h=!0);h?(t.push(e),i.push([a[n]])):o.push(a[n])}0<o.length&&(t.push(e),i.push(o))}}for(n=0;n<e._children.length;n++)De(e._children[n],t,i,s)}}function Le(e,t,i,s,n){this.device=e,this.root=t,this.scene=i,this.renderer=s,this.assets=n}function Fe(e){return e-Math.floor(e)}function Be(e,t){return e-t*Math.floor(e/t)}function Ne(e){return[Fe(e)-(e=Fe(255*e))/255,e-e/255]}function ke(e){this._emitter=e}function Ue(e,t){t.data[0]=e.data[0],t.data[1]=e.data[1],t.data[2]=e.data[2],t.data[3]=e.data[4],t.data[4]=e.data[5],t.data[5]=e.data[6],t.data[6]=e.data[8],t.data[7]=e.data[9],t.data[8]=e.data[10]}function ze(e,t){this._emitter=e,this.frameRandomUniform=new Float32Array(3),this.emitterPosUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),this.worldBoundsMulUniform=new Float32Array(3),this.worldBoundsAddUniform=new Float32Array(3),this.inBoundsSizeUniform=new Float32Array(3),this.inBoundsCenterUniform=new Float32Array(3),this.constantParticleTexIN=t.scope.resolve("particleTexIN"),this.constantParticleTexOUT=t.scope.resolve("particleTexOUT"),this.constantEmitterPos=t.scope.resolve("emitterPos"),this.constantEmitterScale=t.scope.resolve("emitterScale"),this.constantSpawnBounds=t.scope.resolve("spawnBounds"),this.constantSpawnPosInnerRatio=t.scope.resolve("spawnPosInnerRatio"),this.constantSpawnBoundsSphere=t.scope.resolve("spawnBoundsSphere"),this.constantSpawnBoundsSphereInnerRatio=t.scope.resolve("spawnBoundsSphereInnerRatio"),this.constantInitialVelocity=t.scope.resolve("initialVelocity"),this.constantFrameRandom=t.scope.resolve("frameRandom"),this.constantDelta=t.scope.resolve("delta"),this.constantRate=t.scope.resolve("rate"),this.constantRateDiv=t.scope.resolve("rateDiv"),this.constantLifetime=t.scope.resolve("lifetime"),this.constantGraphSampleSize=t.scope.resolve("graphSampleSize"),this.constantGraphNumSamples=t.scope.resolve("graphNumSamples"),this.constantInternalTex0=t.scope.resolve("internalTex0"),this.constantInternalTex1=t.scope.resolve("internalTex1"),this.constantInternalTex2=t.scope.resolve("internalTex2"),this.constantInternalTex3=t.scope.resolve("internalTex3"),this.constantEmitterMatrix=t.scope.resolve("emitterMatrix"),this.constantEmitterMatrixInv=t.scope.resolve("emitterMatrixInv"),this.constantNumParticles=t.scope.resolve("numParticles"),this.constantNumParticlesPot=t.scope.resolve("numParticlesPot"),this.constantLocalVelocityDivMult=t.scope.resolve("localVelocityDivMult"),this.constantVelocityDivMult=t.scope.resolve("velocityDivMult"),this.constantRotSpeedDivMult=t.scope.resolve("rotSpeedDivMult"),this.constantSeed=t.scope.resolve("seed"),this.constantStartAngle=t.scope.resolve("startAngle"),this.constantStartAngle2=t.scope.resolve("startAngle2"),this.constantOutBoundsMul=t.scope.resolve("outBoundsMul"),this.constantOutBoundsAdd=t.scope.resolve("outBoundsAdd"),this.constantInBoundsSize=t.scope.resolve("inBoundsSize"),this.constantInBoundsCenter=t.scope.resolve("inBoundsCenter"),this.constantMaxVel=t.scope.resolve("maxVel"),this.constantFaceTangent=t.scope.resolve("faceTangent"),this.constantFaceBinorm=t.scope.resolve("faceBinorm")}function Ve(e,t){Sh[e]=void 0!==Th[e]&&null!==Th[e]?Th[e]:t}function Ge(e,t){for(var i=e.length/3,s=Array(4*i),n=0;n<i;n++)s[4*n]=e[3*n],s[4*n+1]=e[3*n+1],s[4*n+2]=e[3*n+2],s[4*n+3]=(255*t[3*n]<<16|255*t[3*n+1]<<8|255*t[3*n+2])/16777216;return s}function je(e,t){var i,s,n=t.length,r=e.length/n;for(i=0;i<r;i++)for(s=0;s<n;s++)t[s]=Math.max(t[s],Math.abs(e[i*n+s]))}function We(e,t,i){for(var s=new Float32Array(t.length),n=0;n<t.length;n++)s[n]=t[n]-e[n];je(s,i),e=i.length;var r=s.length/e;for(t=0;t<r;t++)for(n=0;n<e;n++)s[t*e+n]/=0===i[n]?1:i[n],s[t*e+n]*=.5,s[t*e+n]+=.5;return s}function He(e,t){var i,s=t.length/3,n=e.length/3,r=new v,a=new v,o=new v,h=new v,l=new v,c=new v,d=[];for(i=0;i<e.length;i++)d[i]=0;for(i=0;i<s;i++){var u=t[3*i],p=t[3*i+1],f=t[3*i+2];r.set(e[3*u],e[3*u+1],e[3*u+2]),a.set(e[3*p],e[3*p+1],e[3*p+2]),o.set(e[3*f],e[3*f+1],e[3*f+2]),h.sub2(a,r),l.sub2(o,r),c.cross(h,l).normalize(),d[3*u]+=c.x,d[3*u+1]+=c.y,d[3*u+2]+=c.z,d[3*p]+=c.x,d[3*p+1]+=c.y,d[3*p+2]+=c.z,d[3*f]+=c.x,d[3*f+1]+=c.y,d[3*f+2]+=c.z}for(i=0;i<n;i++)e=d[3*i],t=d[3*i+1],s=d[3*i+2],e=1/Math.sqrt(e*e+t*t+s*s),d[3*i]*=e,d[3*i+1]*=e,d[3*i+2]*=e;return d}function Xe(e,t,i,s){var n,r=s.length/3,a=e.length/3,o=new v,h=new v,l=new v,c=new v,d=new v,u=new T,p=new T,f=new T,m=new Float32Array(3*a),_=new Float32Array(3*a),g=[];for(n=0;n<r;n++){var y=s[3*n],b=s[3*n+1],x=s[3*n+2];l.set(e[3*y],e[3*y+1],e[3*y+2]),c.set(e[3*b],e[3*b+1],e[3*b+2]),d.set(e[3*x],e[3*x+1],e[3*x+2]),u.set(i[2*y],i[2*y+1]),p.set(i[2*b],i[2*b+1]),f.set(i[2*x],i[2*x+1]);var S=c.x-l.x,w=d.x-l.x,M=c.y-l.y,P=d.y-l.y,A=c.z-l.z,E=d.z-l.z,C=p.x-u.x,I=f.x-u.x,O=p.y-u.y,R=f.y-u.y,D=C*R-I*O;0==D?(o.set(0,1,0),h.set(1,0,0)):(D=1/D,o.set((R*S-O*w)*D,(R*M-O*P)*D,(R*A-O*E)*D),h.set((C*w-I*S)*D,(C*P-I*M)*D,(C*E-I*A)*D)),m[3*y]+=o.x,m[3*y+1]+=o.y,m[3*y+2]+=o.z,m[3*b]+=o.x,m[3*b+1]+=o.y,m[3*b+2]+=o.z,m[3*x]+=o.x,m[3*x+1]+=o.y,m[3*x+2]+=o.z,_[3*y]+=h.x,_[3*y+1]+=h.y,_[3*y+2]+=h.z,_[3*b]+=h.x,_[3*b+1]+=h.y,_[3*b+2]+=h.z,_[3*x]+=h.x,_[3*x+1]+=h.y,_[3*x+2]+=h.z}for(O=new v,R=new v,e=new v,i=new v,n=0;n<a;n++)e.set(t[3*n],t[3*n+1],t[3*n+2]),O.set(m[3*n],m[3*n+1],m[3*n+2]),R.set(_[3*n],_[3*n+1],_[3*n+2]),s=e.dot(O),i.copy(e).scale(s),i.sub2(O,i).normalize(),g[4*n]=i.x,g[4*n+1]=i.y,g[4*n+2]=i.z,i.cross(e,O),g[4*n+3]=0>i.dot(R)?-1:1;return g}function qe(e,t,i){var s=i&&void 0!==i.normals?i.normals:null,n=i&&void 0!==i.tangents?i.tangents:null,r=i&&void 0!==i.colors?i.colors:null,a=i&&void 0!==i.uvs?i.uvs:null,o=i&&void 0!==i.uvs1?i.uvs1:null,h=i&&void 0!==i.indices?i.indices:null,l=i&&void 0!==i.blendIndices?i.blendIndices:null,c=i&&void 0!==i.blendWeights?i.blendWeights:null;i=[{semantic:"POSITION",components:3,type:6}],null!==s&&i.push({semantic:"NORMAL",components:3,type:6}),null!==n&&i.push({semantic:"TANGENT",components:4,type:6}),null!==r&&i.push({semantic:"COLOR",components:4,type:1,normalize:!0}),null!==a&&i.push({semantic:"TEXCOORD0",components:2,type:6}),null!==o&&i.push({semantic:"TEXCOORD1",components:2,type:6}),null!==l&&i.push({semantic:"BLENDINDICES",components:2,type:1}),null!==c&&i.push({semantic:"BLENDWEIGHT",components:2,type:6});for(var d=new R(e,i),u=new X(d=new I(e,d,i=t.length/3)),p=0;p<i;p++)u.element.POSITION.set(t[3*p],t[3*p+1],t[3*p+2]),null!==s&&u.element.NORMAL.set(s[3*p],s[3*p+1],s[3*p+2]),null!==n&&u.element.TANGENT.set(n[4*p],n[4*p+1],n[4*p+2],n[4*p+3]),null!==r&&u.element.COLOR.set(r[4*p],r[4*p+1],r[4*p+2],r[4*p+3]),null!==a&&u.element.TEXCOORD0.set(a[2*p],a[2*p+1]),null!==o&&u.element.TEXCOORD1.set(o[2*p],o[2*p+1]),null!==l&&u.element.BLENDINDICES.set(l[2*p],l[2*p+1]),null!==c&&u.element.BLENDWEIGHT.set(c[2*p],c[2*p+1]),u.next();return u.end(),s=null,(n=null!==h)&&(s=new Z(e,1,h.length),new Uint16Array(s.lock()).set(h),s.unlock()),(r=new w).compute(t),(e=new J(e)).vertexBuffer=d,e.indexBuffer[0]=s,e.primitive[0].type=4,e.primitive[0].base=0,e.primitive[0].count=n?h.length:i,e.primitive[0].indexed=n,e.aabb=r,e}function Ye(e,t){var i=t&&void 0!==t.tubeRadius?t.tubeRadius:.2,s=t&&void 0!==t.ringRadius?t.ringRadius:.3,n=t&&void 0!==t.segments?t.segments:30,r=t&&void 0!==t.sides?t.sides:20;t=!(!t||void 0===t.calculateTangents)&&t.calculateTangents;var a,o,h=[],l=[],c=[],d=[];for(a=0;a<=r;a++)for(o=0;o<=n;o++){var u=Math.cos(2*Math.PI*o/n)*(s+i*Math.cos(2*Math.PI*a/r)),p=Math.sin(2*Math.PI*a/r)*i,f=Math.sin(2*Math.PI*o/n)*(s+i*Math.cos(2*Math.PI*a/r)),m=Math.cos(2*Math.PI*o/n)*Math.cos(2*Math.PI*a/r),_=Math.sin(2*Math.PI*a/r),g=Math.sin(2*Math.PI*o/n)*Math.cos(2*Math.PI*a/r),y=a/r,v=1-o/n;h.push(u,p,f),l.push(m,_,g),c.push(y,v),a<r&&o<n&&(u=a*(n+1)+o,p=(a+1)*(n+1)+o,f=a*(n+1)+(o+1),m=(a+1)*(n+1)+(o+1),d.push(u,p,f),d.push(p,m,f))}return i={normals:l,uvs:c,indices:d},t&&(i.tangents=t(h,l,c,d)),qe(e,h,i)}function Ke(e,t,i,s,n,r){var a,o,h=new v,l=new v,c=new v,d=[],u=[],p=[],f=[],m=[];if(0<i)for(a=0;a<=s;a++)for(o=0;o<=n;o++){var _=o/n*2*Math.PI-Math.PI,g=Math.sin(_),y=new v(g*e,-i/2,(_=Math.cos(_))*e),b=new v(g*t,i/2,_*t);h.lerp(y,b,a/s),l.sub2(b,y).normalize(),g=new v(_,0,-g),c.cross(g,l).normalize(),d.push(h.x,h.y,h.z),u.push(c.x,c.y,c.z),b=o/n,y=a/s,p.push(b,y),g=y,y=b,b=g,b=.875*(b/=3)+.0625,y=.875*y+.0625,f.push(b,y),a<s&&o<n&&(g=a*(n+1)+o,_=a*(n+1)+(o+1),b=(a+1)*(n+1)+o,y=(a+1)*(n+1)+(o+1),m.push(g,_,b),m.push(_,y,b))}if(r){for(e=Math.floor(n/2),a=i/2,i=0;i<=e;i++)for(_=i*Math.PI*.5/e,g=Math.sin(_),_=Math.cos(_),h=0;h<=n;h++)r=2*h*Math.PI/n-Math.PI/2,b=Math.sin(r),r=Math.cos(r),r*=g,o=_,c=b*g,b=1-h/n,y=1-i/e,d.push(r*t,o*t+a,c*t),u.push(r,o,c),p.push(b,y),b=.875*(b/=3)+.0625,y=.875*(y/=3)+.0625,b+=1/3,f.push(b,y);for(l=(s+1)*(n+1),i=0;i<e;++i)for(h=0;h<n;++h)_=(g=i*(n+1)+h)+n+1,m.push(l+g+1,l+_,l+g),m.push(l+g+1,l+_+1,l+_);for(i=0;i<=e;i++)for(_=.5*Math.PI+i*Math.PI*.5/e,g=Math.sin(_),_=Math.cos(_),h=0;h<=n;h++)r=2*h*Math.PI/n-Math.PI/2,b=Math.sin(r),r=Math.cos(r),r*=g,o=_,c=b*g,b=1-h/n,y=1-i/e,d.push(r*t,o*t-a,c*t),u.push(r,o,c),p.push(b,y),b=.875*(b/=3)+.0625,y=.875*(y/=3)+.0625,b+=2/3,f.push(b,y);for(l=(s+1)*(n+1)+(n+1)*(e+1),i=0;i<e;++i)for(h=0;h<n;++h)_=(g=i*(n+1)+h)+n+1,m.push(l+g+1,l+_,l+g),m.push(l+g+1,l+_+1,l+_)}else{if(l=(s+1)*(n+1),0<e)for(a=0;a<n;a++)_=a/n*2*Math.PI,o=-i/2,b=1-((r=Math.sin(_))+1)/2,y=((c=Math.cos(_))+1)/2,d.push(r*e,o,c*e),u.push(0,-1,0),p.push(b,y),b=.875*(b/=3)+.0625,y=.875*(y/=3)+.0625,b+=1/3,f.push(b,y),1<a&&m.push(l,l+a,l+a-1);if(l+=n,0<t)for(a=0;a<n;a++)_=a/n*2*Math.PI,o=i/2,b=1-((r=Math.sin(_))+1)/2,y=((c=Math.cos(_))+1)/2,d.push(r*t,o,c*t),u.push(0,1,0),p.push(b,y),b=.875*(b/=3)+.0625,y=.875*(y/=3)+.0625,b+=2/3,f.push(b,y),1<a&&m.push(l,l+a-1,l+a)}return{positions:d,normals:u,uvs:p,uvs1:f,indices:m}}function Ze(e,t){var i=t&&(t.radius||t.baseRadius);i=void 0!==i?i:.5;var s=!(!t||void 0===t.calculateTangents)&&t.calculateTangents;return t=Ke(i,i,t&&void 0!==t.height?t.height:1,t&&void 0!==t.heightSegments?t.heightSegments:5,t&&void 0!==t.capSegments?t.capSegments:20,!1),s&&(t.tangents=s(t.positions,t.normals,t.uvs,t.indices)),qe(e,t.positions,t)}function $e(e,t){var i=t&&void 0!==t.radius?t.radius:.3,s=!(!t||void 0===t.calculateTangents)&&t.calculateTangents;return t=Ke(i,i,(t&&void 0!==t.height?t.height:1)-2*i,t&&void 0!==t.heightSegments?t.heightSegments:1,t&&void 0!==t.sides?t.sides:20,!0),s&&(t.tangents=s(t.positions,t.normals,t.uvs,t.indices)),qe(e,t.positions,t)}function Qe(e,t){var i=!(!t||void 0===t.calculateTangents)&&t.calculateTangents;return t=Ke(t&&void 0!==t.baseRadius?t.baseRadius:.5,t&&void 0!==t.peakRadius?t.peakRadius:0,t&&void 0!==t.height?t.height:1,t&&void 0!==t.heightSegments?t.heightSegments:5,t&&void 0!==t.capSegments?t.capSegments:18,!1),i&&(t.tangents=i(t.positions,t.normals,t.uvs,t.indices)),qe(e,t.positions,t)}function Je(e,t){var i=t&&void 0!==t.radius?t.radius:.5,s=t&&void 0!==t.latitudeBands?t.latitudeBands:16,n=t&&void 0!==t.longitudeBands?t.longitudeBands:16;t=!(!t||void 0===t.calculateTangents)&&t.calculateTangents;var r,a=[],o=[],h=[],l=[];for(r=0;r<=s;r++){var c=r*Math.PI/s,d=Math.sin(c),u=Math.cos(c);for(c=0;c<=n;c++){var p=2*c*Math.PI/n-Math.PI/2,f=Math.sin(p);p=Math.cos(p),p*=d;var m=u;f*=d;var _=1-c/n,g=1-r/s;a.push(p*i,m*i,f*i),o.push(p,m,f),h.push(_,g)}}for(r=0;r<s;++r)for(c=0;c<n;++c)d=(i=r*(n+1)+c)+n+1,l.push(i+1,d,i),l.push(i+1,d+1,d);return s={normals:o,uvs:h,uvs1:h,indices:l},t&&(s.tangents=t(a,o,h,l)),qe(e,a,s)}function et(e,t){var i=t&&void 0!==t.halfExtents?t.halfExtents:new T(.5,.5),s=t&&void 0!==t.widthSegments?t.widthSegments:5,n=t&&void 0!==t.lengthSegments?t.lengthSegments:5;t=!(!t||void 0===t.calculateTangents)&&t.calculateTangents;var r,a,o=[],h=[],l=[],c=[],d=0;for(r=0;r<=s;r++)for(a=0;a<=n;a++){var u=-i.x+2*i.x*r/s,p=-(-i.y+2*i.y*a/n),f=r/s,m=a/n;o.push(u,0,p),h.push(0,1,0),l.push(f,m),r<s&&a<n&&(c.push(d+n+1,d+1,d),c.push(d+n+1,d+n+2,d+1)),d++}return i={normals:h,uvs:l,uvs1:l,indices:c},t&&(i.tangents=t(o,h,l,c)),qe(e,o,i)}function tt(e,t){var i=t&&void 0!==t.halfExtents?t.halfExtents:new v(.5,.5,.5),s=t&&void 0!==t.widthSegments?t.widthSegments:1,n=t&&void 0!==t.lengthSegments?t.lengthSegments:1,r=t&&void 0!==t.heightSegments?t.heightSegments:1;t=!(!t||void 0===t.calculateTangents)&&t.calculateTangents;var a=[new v(-i.x,-i.y,i.z),new v(i.x,-i.y,i.z),new v(i.x,i.y,i.z),new v(-i.x,i.y,i.z),new v(i.x,-i.y,-i.z),new v(-i.x,-i.y,-i.z),new v(-i.x,i.y,-i.z),new v(i.x,i.y,-i.z)],o=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],h=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],l=[],c=[],d=[],u=[],p=[],f=0;return(i=function(e,t,i){var s,n;for(s=0;s<=t;s++)for(n=0;n<=i;n++){var r=new v,m=new v,_=new v,g=new v;r.lerp(a[o[e][0]],a[o[e][1]],s/t),m.lerp(a[o[e][0]],a[o[e][2]],n/i),_.sub2(m,a[o[e][0]]),g.add2(r,_),r=s/t,m=n/i,l.push(g.x,g.y,g.z),c.push(h[e][0],h[e][1],h[e][2]),d.push(r,m),r=.875*(r/=3)+.0625,m=.875*(m/=3)+.0625,r+=e%3/3,m+=Math.floor(e/3)/3,u.push(r,m),s<t&&n<i&&(p.push(f+i+1,f+1,f),p.push(f+i+1,f+i+2,f+1)),f++}})(0,s,r),i(1,s,r),i(2,s,n),i(3,s,n),i(4,n,r),i(5,n,r),s={normals:c,uvs:d,uvs1:u,indices:p},t&&(s.tangents=t(l,c,d,p)),qe(e,l,s)}function it(){r.call(this),this.root=null,this._gravity=new v(0,-9.8,0),this._layers=null,this._fog="none",this.fogColor=new h(0,0,0),this.fogStart=1,this.fogEnd=1e3,this.fogDensity=0,this.ambientLight=new h(0,0,0),this._toneMapping=this._gammaCorrection=0,this.exposure=1,this._skyboxPrefiltered=[null,null,null,null,null,null],this._firstUpdateSkybox=!0,this.skyboxModel=this._skyboxCubeMap=null,this._skyboxIntensity=1,this._skyboxMip=0,this.lightmapSizeMultiplier=1,this.lightmapMaxResolution=2048,this.lightmapMode=1,this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,lastStaticPrepareFullTime:0,lastStaticPrepareSearchTime:0,lastStaticPrepareWriteTime:0,lastStaticPrepareTriAabbTime:0,lastStaticPrepareCombineTime:0,updateShadersTime:0},this.updateSkybox=this.updateShaders=!0,this._shaderVersion=0,this._statsUpdated=!1,this._models=[],this.defaultMaterial=new Nn,this.defaultMaterial.name="Default Material",this.defaultMaterial.shadingModel=1}function st(){return"undefined"!=typeof Audio}function nt(){return!("undefined"==typeof AudioContext&&"undefined"==typeof webkitAudioContext)}function rt(e){this.position=new v,this.velocity=new v,this.orientation=new x,nt()&&(this.listener=e.context.listener)}function at(e){if(r.call(this),nt()||e.forceWebAudioApi){if("undefined"!=typeof AudioContext?this.context=new AudioContext:"undefined"!=typeof webkitAudioContext&&(this.context=new webkitAudioContext),this.context){var t=this.context;if(this.resumeContext=function(){this.context.resume(),window.removeEventListener("mousedown",this.resumeContext),window.removeEventListener("touchend",this.resumeContext)}.bind(this),window.addEventListener("mousedown",this.resumeContext),window.addEventListener("touchend",this.resumeContext),Vr.ios){var i=function(){var e=t.createBuffer(1,1,44100),s=t.createBufferSource();s.buffer=e,s.connect(t.destination),s.start(0),s.disconnect(),window.removeEventListener("touchend",i)};window.addEventListener("touchend",i)}}}else console.warn("No support for 3D audio found");st()||console.warn("No support for 2D audio found"),this.listener=new rt(this),this._volume=1,this.suspended=!1}function ot(e,t,i,s){this.time=e,this.position=t,this.rotation=i,this.scale=s}function ht(){this._name="",this._keys=[]}function lt(){this.name="",this.duration=0,this._nodes=[],this._nodeDict={}}function ct(e){2===arguments.length&&(e=arguments[1]),this.options=e,this.name=e.name,this.defaultWeight=e.defaultWeight||0,this.aabb=e.aabb,this.aabb||(this.aabb=new w,e.deltaPositions&&this.aabb.compute(e.deltaPositions)),this.deltaPositions=e.deltaPositions}function dt(){}function ut(e,t){if(ge.call(this,e),e instanceof Ln&&(t=e),this._batchHandle=null,this.c={},this._app=t,!t&&(this._app=Ln.getApplication(),!this._app))throw Error("Couldn't find current application");this._guid=null,this._destroying=!1}function pt(e,t){this._components=e,this._data=t}function ft(){this._left=1/0,this._right=-1/0,this._t=this._p1=this._p0=this._recip=this._len=0,this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}function mt(e,t,i,s){this._paths=e,this._input=t,this._output=i,this._interpolation=s}function _t(e,t,i,s,n){this._name=e,this._duration=t,this._inputs=i,this._outputs=s,this._curves=n}function gt(e){var t;for(this._name=e.name+"Snapshot",this._time=-1,this._cache=[],this._results=[],t=0;t<e._inputs.length;++t)this._cache[t]=new ft;var i=e._curves;for(e=e._outputs,t=0;t<i.length;++t){for(var s=e[i[t]._output],n=[],r=0;r<s._components;++r)n[r]=0;this._results[t]=n}}function yt(e,t,i,s,n){this._name=e.name,this._track=e,this._snapshot=new gt(e),this._playing=s,this._time=t,this._speed=i,this._loop=n,this._blendWeight=1,this._blendOrder=0}function vt(e,t,i){this._func=e,this._type=t,this._components=i}function bt(){}function xt(e){var t={},i=function(e){t[e.name]={node:e,count:0};for(var s=0;s<e.children.length;++s)i(e.children[s])};i(e),this.nodes=t,this.activeNodes=[],this.handlers={localPosition:function(e){var t=e.localPosition;return new vt(function(e){t.set.apply(t,e)},"vector",3)},localRotation:function(e){var t=e.localRotation;return new vt(function(e){t.set.apply(t,e)},"quaternion",4)},localScale:function(e){var t=e.localScale;return new vt(function(e){t.set.apply(t,e)},"vector",3)},weights:function(e){for(var t=e;t&&t.constructor!==ut;)t=t.parent;if(!(t&&t.model&&t.model.model&&t.model.model.morphInstances))return null;t=t.model.meshInstances;for(var i,s=0;s<t.length;++s)if(t[s].node.name===e.name){i=t[s].morphInstance;break}return i?new vt(function(e){for(var t=0;t<e.length;++t)i.setWeight(t,e[t])},"vector",i.morph._targets.length):null}},this.propertyLocator=new dt}function St(e){this._binder=e,this._clips=[],this._inputs=[],this._outputs=[],this._targets={}}function Tt(){}function wt(e){r.call(this),this.locale=Wh,this._translations={},this._availableLangs={},this._app=e,this._assets=[],this._parser=new Tt}function Mt(e){this.asset=e}function Pt(e,t,i,s,n){r.call(this),this._id=Zh--,this.name=e||"",this.type=t,this.tags=new d(this),this._preload=!1,this.variants=new Mt(this),this._file=null,this._data=s||{},this.options=n||{},this._resources=[],this._i18n={},this.loading=this.loaded=!1,this.registry=null,i&&(this.file=i)}function At(){}function Et(){this.retryRequests=!1}function Ct(){this.retryRequests=!1}function It(e){this._layers=[],this._parameters={},e&&(e.states?(this._layers=[],this._layers.push({name:"DEFAULT_LAYER",states:e.states,transitions:e.transitions})):this._layers=e.layers,this._parameters=Object.assign({},e.parameters))}function Ot(){this.retryRequests=!1}function Rt(e){e instanceof Audio?this.audio=e:this.buffer=e}function Dt(e){this.manager=e,this.retryRequests=!1}function Lt(){this.retryRequests=!1}function Ft(e){this._blobUrls={};for(var t=0,i=e.length;t<i;t++)e[t].url&&(this._blobUrls[e[t].name]=e[t].url)}function Bt(e){function t(e){this._fields=e}function i(e){this._arrayBuffer=e||new ArrayBuffer(0),this._bufferView=new DataView(this._arrayBuffer),this._paxHeader=this._globalPaxHeader=null,this._bytesRead=0}if("undefined"!=typeof TextDecoder)var s=new TextDecoder("utf-8"),n=new TextDecoder("windows-1252");else console.warn("TextDecoder not supported - pc.Untar module will not work");t.parse=function(e,i,n){for(var r=new Uint8Array(e,i,n),a=0,o=[];a<n;){var h;for(h=a;h<n&&32!=r[h];h++);if(h>=n)throw Error("Invalid PAX header data format.");var l=parseInt(s.decode(new Uint8Array(e,i+a,h-a)),10);if(2!==(h=s.decode(new Uint8Array(e,i+h+1,l-(h-a)-2)).split("=")).length)throw Error("Invalid PAX header data format.");0===h[1].length&&(h[1]=null),o.push({name:h[0],value:h[1]}),a+=l}return new t(o)},t.prototype.applyHeader=function(e){for(var t=0;t<this._fields.length;t++){var i=this._fields[t].name,s=this._fields[t].value;"path"===i&&(i="name"),null===s?delete e[i]:e[i]=s}},e||(vl=i),i.prototype._hasNext=function(){return this._bytesRead+4<this._arrayBuffer.byteLength&&0!==this._bufferView.getUint32(this._bytesRead)},i.prototype._readNextFile=function(){var i=new DataView(this._arrayBuffer,this._bytesRead,512),s=n.decode(i);this._bytesRead+=512,i=s.substr(0,100).replace(/\0/g,"");var r=s.substr(257,6),a=parseInt(s.substr(124,12),8),o=s.substr(156,1),h=this._bytesRead,l=null,c=!1;switch(o){case"0":case"":c=!0,e||(l=new Blob([this._arrayBuffer.slice(this._bytesRead,this._bytesRead+a)]),l=URL.createObjectURL(l));break;case"g":this._globalPaxHeader=t.parse(this._arrayBuffer,this._bytesRead,a);break;case"x":this._paxHeader=t.parse(this._arrayBuffer,this._bytesRead,a)}return this._bytesRead+=a,0!==(o=a%512)&&(this._bytesRead+=512-o),c?(-1!==r.indexOf("ustar")&&(0<(s=s.substr(345,155).replace(/\0/g,"")).length&&(i=s.trim()+i.trim())),i={name:i,start:h,size:a,url:l},this._globalPaxHeader&&this._globalPaxHeader.applyHeader(i),this._paxHeader&&(this._paxHeader.applyHeader(i),this._paxHeader=null),i):null},i.prototype.untar=function(e){if(!s)return console.error("Cannot untar because TextDecoder interface is not available for this platform."),[];for(var t=[];this._hasNext();){var i=this._readNextFile();i&&(e&&i.name&&(i.name=e+i.name),t.push(i))}return t},e&&(self.onmessage=function(e){var t=e.data.id;try{var s=new i(e.data.arrayBuffer).untar(e.data.prefix);postMessage({id:t,files:s,arrayBuffer:e.data.arrayBuffer},[e.data.arrayBuffer])}catch(e){postMessage({id:t,error:e.toString()})}})}function Nt(e){if(this._requestId=0,this._pendingRequests={},this._filenamePrefix=e,e=Worker,!bl){var t=new Blob(["("+Bt.toString()+")(true)\n\n"],{type:"application/javascript"});bl=URL.createObjectURL(t)}this._worker=new e(bl),this._worker.addEventListener("message",this._onMessage.bind(this))}function kt(e){this._assets=e,this._worker=null,this.retryRequests=!1}function Ut(e){this.data=e,this.model=null,this.materials=[],this.textures=[],this.animations=[],this.registry=null}function zt(e,t){this._device=e,this._defaultMaterial=t}function Vt(){this.retryRequests=!1}function Gt(e,t,i){this._device=e,this._assets=t,this._loader=i}function jt(){}function Wt(e,t){this.type=t&&t.type||"msdf",this.em=1,this.textures=e,this.intensity=0,this._data=null,this.data=t}function Ht(e){return 3>e.version&&(2>e.version&&(e.info.maps=e.info.maps||[{width:e.info.width,height:e.info.height}]),e.chars=Object.keys(e.chars||{}).reduce(function(t,i){var s=e.chars[i];return i=void 0!==s.letter?s.letter:Wr.fromCodePoint(i),2>e.version&&(s.map=s.map||0),t[i]=s,t},{}),e.version=3),e}function Xt(e){this._loader=e,this.retryRequests=!1}function qt(e,t){if(r.call(this),this._assets=[],this._registry=t,this._loaded=!1,this._total=this._count=0,this._failed=[],this._waitingAssets=[],e.length&&e[0]instanceof Pt)this._assets=e;else for(var i=0;i<e.length;i++){var s=t.get(e[i]);s?this._assets.push(s):(this._waitForAsset(e[i]),this._total++)}}function Yt(e,t){this._app=e,this._isTemplate=t}function Kt(e){this._app=e,this.retryRequests=!1}function Zt(){this.retryRequests=!1}function $t(){this.retryRequests=!1}function Qt(e,t,i,s,n){this.propertyName=e,this.parent=t,this._scope=n,this._registry=i,this.asset=this.url=this.id=null,this._onAssetLoad=s.load,this._onAssetAdd=s.add,this._onAssetRemove=s.remove}function Jt(){this.valid=this.removeInvalid=!0,this.enumValidators={occludeSpecular:this._createEnumValidator([0,1,2]),cull:this._createEnumValidator([0,1,2,3]),blendType:this._createEnumValidator([0,1,2,3,4,5,6,7,8,9,10]),shadingModel:this._createEnumValidator([0,1])}}function ei(){this._validator=null}function ti(e){this._assets=e.assets,this._device=e.graphicsDevice,this._placeholderTextures=null,this._parser=new ei,this.retryRequests=!1}function ii(e){this._device=e,this._defaultMaterial=Ln.getApplication().scene.defaultMaterial}function si(){this.index=0,this.boneIndices=[0,0,0,0]}function ni(){this.indexCount=this.indexStart=this.vertexCount=this.vertexStart=this.partition=0,this.boneIndices=[],this.vertices=[],this.indices=[],this.indexMap={}}function ri(e,t,i){var s,n;!function(e){var t=e.vertices,i=e.skins,s=e.meshes,n=e.meshInstances;for(e=0;e<s.length;e++)s[e].vertices=t[s[e].vertices],void 0!==s[e].skin&&(s[e].skin=i[s[e].skin]);for(e=0;e<n.length;e++)n[e].mesh=s[n[e].mesh]}(e);var r=e.vertices,a=e.skins,o=e.meshes,h=e.meshInstances,l=function(e){var t=new si;return t.index=e,t};for(s=a.length-1;0<=s;s--)if(a[s].boneNames.length>i){var c=a.splice(s,1)[0],d=[];for(n=0;n<o.length;n++)o[n].skin===c&&d.push(o[n]);for(n=0;n<d.length;n++){var u=o.indexOf(d[n]);-1!==u&&o.splice(u,1)}if(0===d.length)throw Error("partitionSkin: There should be at least one mesh that references a skin");var p=d[0].vertices;for(n=1;n<d.length;n++)if(d[n].vertices!==p)throw Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");var f,m=[],_=[],g=[],y=0;for(n=0;n<d.length;n++){for(var v=d[n],b=v.indices,x=v.base;x<v.base+v.count;){u=b[x++],_[0]=l(u),g[0]=u,u=b[x++],_[1]=l(u),g[1]=u,u=b[x++],_[2]=l(u),g[2]=u;for(var S=!1,T=y;T<m.length;T++)if((u=m[T]).addPrimitive(_,g,p,i)){S=!0;break}S||((u=new ni).originalMesh=v,u.addPrimitive(_,g,p,i),m.push(u))}y=m.length}for(v=[],d=[],n=0;n<m.length;n++)if((u=m[n]).vertices.length&&u.indices.length){for(_=v.length,g=u.vertices.length,y=d.length,b=u.indices.length,u.partition=n,u.vertexStart=_,u.vertexCount=g,u.indexStart=y,u.indexCount=b,x=0,S=_;x<g;)v[S++]=u.vertices[x++];for(x=0,S=y;x<b;)d[S++]=u.indices[x++]+_}for(_=[],n=0;n<m.length;n++){for(u=m[n],y=[],b=[],g=0;g<u.boneIndices.length;g++)y.push(c.inverseBindMatrices[u.boneIndices[g]]),b.push(c.boneNames[u.boneIndices[g]]);u={inverseBindMatrices:y,boneNames:b},_.push(u),a.push(u)}for(f in c={},p)c[f]={components:p[f].components,data:[],type:p[f].type};for(f in p)if("blendIndices"===f)for(u=c[f].data,n=0;n<v.length;n++)g=v[n].boneIndices,u.push(g[0],g[1],g[2],g[3]);else for(y=(n=p[f]).data,b=n.components,n=0;n<v.length;n++)for(u=v[n].index,g=0;g<b;g++)c[f].data.push(y[u*b+g]);for(r[r.indexOf(p)]=c,n=0;n<m.length;n++)for(u=m[n],v={aabb:{min:[0,0,0],max:[0,0,0]},vertices:c,skin:_[n],indices:d.splice(0,u.indexCount),type:"triangles",base:0,count:u.indexCount},o.push(v),g=h.length-1;0<=g;g--)h[g].mesh===u.originalMesh&&(h.push({mesh:v,node:h[g].node}),t&&t.push({material:t[g].material,path:t[g].path}));for(n=0;n<m.length;n++)for(u=m[n],g=h.length-1;0<=g;g--)h[g].mesh===u.originalMesh&&(h.splice(g,1),t&&t.splice(g,1))}!function(e){var t=e.vertices,i=e.skins,s=e.meshes,n=e.meshInstances;for(e=0;e<s.length;e++)s[e].vertices=t.indexOf(s[e].vertices),void 0!==s[e].skin&&(s[e].skin=i.indexOf(s[e].skin));for(e=0;e<n.length;e++)n[e].mesh=s.indexOf(n[e].mesh)}(e)}function ai(e){this._device=e,this._defaultMaterial=Ln.getApplication().scene.defaultMaterial}function oi(e,t){this._device=e,this._parsers=[],this._defaultMaterial=t,this.retryRequests=!1,this.addParser(new ai(this._device),function(e,t){return".json"===zr.getExtension(e)}),this.addParser(new ii(this._device),function(e,t){return".glb"===zr.getExtension(e)})}function hi(e){this._handlers={},this._requests={},this._cache={},this._app=e}function li(e){this._app=e,this.retryRequests=!1}function ci(e){this._app=e,this.retryRequests=!1}function di(e){this._app=e,this._scripts={},this._cache={}}function ui(){this.retryRequests=!1}function pi(e,t){r.call(this),this._device=e,this._pixelsPerUnit=t&&void 0!==t.pixelsPerUnit?t.pixelsPerUnit:1,this._renderMode=t&&void 0!==t.renderMode?t.renderMode:0,this._atlas=t&&void 0!==t.atlas?t.atlas:null,this._frameKeys=t&&void 0!==t.frameKeys?t.frameKeys:null,this._meshes=[],this._meshesDirty=this._updatingProperties=!1,this._atlas&&this._frameKeys&&this._createMeshes()}function fi(e,t){this._assets=e,this._device=t,this.retryRequests=!1}function mi(e){this.resource&&(this.resource.atlas=e.resource)}function _i(e){this.registry.load(e)}function gi(e,t){this._app=e,this._data=t,this._expandedData={},this._templateRoot=null}function yi(e){this._app=e}function vi(){this.retryRequests=!1}function bi(){r.call(this),this._frames=this._texture=null}function xi(e){this._loader=e,this.retryRequests=!1}function Si(e,t){this.retryRequests=!!t}function Ti(e,t){this.crossOrigin=e.prefix?"anonymous":null,this.retryRequests=!!t}function wi(e,t){this.retryRequests=!!t}function Mi(e,t){this.retryRequests=t}function Pi(){}function Ai(e,t,i){this._device=e,this._assets=t,this._loader=i,this.imgParser=new Ti(t,!1),this.parsers={dds:new Mi(t,!1),ktx:new wi(t,!1),basis:new Si(t,!1)}}function Ei(e){r.call(this),this._loader=e,this._assets=[],this._cache={},this._names={},this._tags=new c("_id"),this._urls={},this.prefix=null}function Ci(e){this._assets=e,this._bundleAssets={},this._assetsInBundles={},this._urlsInBundles={},this._fileRequests={},this._assets.on("add",this._onAssetAdded,this),this._assets.on("remove",this._onAssetRemoved,this)}function Ii(e){r.call(this),this.app=e,this._scripts={},this._list=[]}function Oi(e,t){r.call(this);var i=this;this._app=e,this._device=e.graphicsDevice,this.id=t.displayId,this._frameData=null,window.VRFrameData&&(this._frameData=new window.VRFrameData),this.display=t,this._camera=null,this.sitToStandInv=new x,this.leftView=new x,this.leftProj=new x,this.leftViewInv=new x,this.leftPos=new v,this.rightView=new x,this.rightProj=new x,this.rightViewInv=new x,this.rightPos=new v,this.combinedPos=new v,this.combinedView=new x,this.combinedProj=new x,this.combinedViewInv=new x,this.combinedAspect=this.combinedFov=0,this.presenting=!1,i._presentChange=function(e){if((e.display?e.display:e.detail&&e.detail.display?e.detail.display:e.detail&&e.detail.vrdisplay?e.detail.vrdisplay:i.display)===i.display){if(i.presenting=i.display&&i.display.isPresenting,i.presenting){e=i.display.getEyeParameters("left");var t=i.display.getEyeParameters("right");i._app.graphicsDevice.setResolution(2*Math.max(e.renderWidth,t.renderWidth),Math.max(e.renderHeight,t.renderHeight)),i._app._allowResize=!1}else i._app.setCanvasResolution("AUTO"),i._app._allowResize=!0;i.fire("beforepresentchange",i),i.fire("presentchange",i)}},window.addEventListener("vrdisplaypresentchange",i._presentChange,!1)}function Ri(e){r.call(this);var t=this;this.isSupported=Ri.isSupported,this._index={},this.displays=[],this.display=null,this._app=e,this._onDisplayConnect=this._onDisplayConnect.bind(this),this._onDisplayDisconnect=this._onDisplayDisconnect.bind(this),t._attach(),this._getDisplays(function(e,i){if(e)t.fire("error",e);else{for(e=0;e<i.length;e++)t._addDisplay(i[e]);t.fire("ready",t.displays)}})}function Di(e,t,i){r.call(this),this.manager=e,this._xrHitTestSource=t,this._transient=i}function Li(e){r.call(this),this.manager=e,this._supported=!(!window.XRSession||!window.XRSession.prototype.requestHitTestSource),this._session=null,this.sources=[],this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}function Fi(e,t){r.call(this),this._id=++$l,this._manager=e,this._xrInputSource=t,this._ray=new A,this._rayLocal=new A,this._grip=!1,this._worldTransform=this._localTransform=null,this._position=new v,this._rotation=new S,this._localRotation=this._localPosition=null,this._dirtyLocal=!0,this._selecting=!1,this._elementInput=!0,this._elementEntity=null,this._hitTestSources=[]}function Bi(e){r.call(this);var t=this;this.manager=e,this._session=null,this._inputSources=[],this._onInputSourcesChangeEvt=function(e){t._onInputSourcesChange(e)},this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this)}function Ni(e){r.call(this),this._manager=e,this._lightProbeRequested=this._available=this._supported=!1,this._lightProbe=null,this._intensity=0,this._rotation=new S,this._color=new h,this._sphericalHarmonics=new Float32Array(27),this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}function ki(e){r.call(this);var t=this;this.app=e,this._supported=!!navigator.xr,this._available={},this._available[Hl]=!1,this._available[Xl]=!1,this._available[ql]=!1,this._referenceSpace=this._baseLayer=this._session=this._spaceType=this._type=null,this.input=new Bi(this),this.hitTest=new Li(this),this.lightEstimation=new Ni(this),this._camera=null,this.views=[],this.viewsPool=[],this._localPosition=new v,this._localRotation=new S,this._depthNear=.1,this._depthFar=1e3,this._height=this._width=0,this._supported&&(navigator.xr.addEventListener("devicechange",function(){t._deviceAvailabilityCheck()}),this._deviceAvailabilityCheck())}function Ui(e,t){r.call(this),this.system=e,this.entity=t,this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",function(e,t,i){this.fire("set_"+e,e,t,i)}),this.on("set_enabled",this.onSetEnabled,this)}function zi(e){r.call(this),this.app=e,this.store={},this.schema=[]}function Vi(e,t){if(!e)return e;switch(t){case"rgb":return e instanceof h?e.clone():new h(e[0],e[1],e[2]);case"rgba":return e instanceof h?e.clone():new h(e[0],e[1],e[2],e[3]);case"vec2":return e instanceof T?e.clone():new T(e[0],e[1]);case"vec3":return e instanceof v?e.clone():new v(e[0],e[1],e[2]);case"vec4":return e instanceof b?e.clone():new b(e[0],e[1],e[2],e[3]);case"boolean":case"number":case"string":case"entity":return e;default:throw Error("Could not convert unhandled type: "+t)}}function Gi(){this._written=!1,this._name="",this._keyFrames=[],this._quat=new S,this._pos=new v,this._scale=new v,this._targetNode=null}function ji(e){this._animation=null,this._time=0,this.looping=!0,this._interpolatedKeys=[],this._interpolatedKeyDict={},this._currKeyIndices={},this.graph=null;var t=this;!function e(i){var s=new Gi;for(s._name=i.name,t._interpolatedKeys.push(s),t._interpolatedKeyDict[i.name]=s,s=t._currKeyIndices[i.name]=0;s<i._children.length;s++)e(i._children[s])}(e)}function Wi(e,t){Ui.call(this,e,t),this.animationsIndex={},this.on("set_animations",this.onSetAnimations,this),this.on("set_assets",this.onSetAssets,this),this.on("set_loop",this.onSetLoop,this)}function Hi(){this.assets=[],this.speed=1,this.enabled=this.activate=this.loop=!0,this.animations={},this.currAnim=this.prevAnim=this.model=null,this.blending=!1,this.blendSpeed=this.blend=0,this.playing=!1,this.animEvaluator=this.toSkel=this.fromSkel=this.skeleton=null}function Xi(e){zi.call(this,e),this.id="animation",this.description="Specifies the animation assets that can run on the model specified by the Entity's model Component.",this.ComponentType=Wi,this.DataType=Hi,this.schema=ic,this.on("beforeremove",this.onBeforeRemove,this),this.on("update",this.onUpdate,this),zi.bind("update",this.onUpdate,this)}function qi(e,t){this.animComponent=e,t?xt.call(this,t):this.propertyLocator=new dt}function Yi(e,t,i){this._name=e,this._controller=t,this._component=i}function Ki(e,t,i){this._controller=e,this._name=t,this._animations=[],this._speed=i||1}function Zi(e,t,i,s,n,r,a,o,h){this._controller=e,this._from=t,this._to=i,this._time=s,this._priority=n,this._conditions=r||[],this._exitTime=a||null,this._transitionOffset=o||null,this._interruptionSource=h||"NONE"}function $i(e,t,i,s,n){for(this._animEvaluator=e,this._states={},this._stateNames=[],e=0;e<t.length;e++)this._states[t[e].name]=new Ki(this,t[e].name,t[e].speed),this._stateNames.push(t[e].name);this._transitions=i.map(function(e){return new Zi(this,e.from,e.to,e.time,e.priority,e.conditions,e.exitTime,e.transitionOffset,e.interruptionSource)}.bind(this)),this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._parameters=s,this._previousStateName=null,this._activeStateName="START",this._playing=!1,this._activate=n,this._totalTransitionTime=this._currTransitionTime=1,this._isTransitioning=!1,this._transitionInterruptionSource="NONE",this._transitionPreviousStates=[],this._timeInStateBefore=this._timeInState=0}function Qi(e,t){Ui.call(this,e,t)}function Ji(){this.stateGraphAsset=null,this.speed=1,this.enabled=this.activate=!0,this.playing=!1,this.stateGraph=null,this.layers=[],this.layerIndices={},this.parameters={}}function es(e){zi.call(this,e),this.id="anim",this.description="State based animation system that can animate the models and component properties of this entity and its children",this.ComponentType=Qi,this.DataType=Ji,this.schema=sc,this.on("beforeremove",this.onBeforeRemove,this),this.on("animationUpdate",this.onAnimationUpdate,this),zi.bind("animationUpdate",this.onAnimationUpdate,this)}function ts(e,t){Ui.call(this,e,t)}function is(){this.enabled=!0}function ss(e,t){zi.call(this,e),this.id="audiolistener",this.description="Specifies the location of the listener for 3D audio playback.",this.ComponentType=ts,this.DataType=is,this.schema=nc,this.manager=t,this.current=null,zi.bind("update",this.onUpdate,this)}function ns(e,t){Ui.call(this,e,t),this.on("set_assets",this.onSetAssets,this),this.on("set_loop",this.onSetLoop,this),this.on("set_volume",this.onSetVolume,this),this.on("set_pitch",this.onSetPitch,this),this.on("set_minDistance",this.onSetMinDistance,this),this.on("set_maxDistance",this.onSetMaxDistance,this),this.on("set_rollOffFactor",this.onSetRollOffFactor,this),this.on("set_distanceModel",this.onSetDistanceModel,this),this.on("set_3d",this.onSet3d,this)}function rs(){this.enabled=!0,this.assets=[],this.activate=!0,this.pitch=this.volume=1,this.loop=!1,this["3d"]=!0,this.minDistance=1,this.maxDistance=1e4,this.rollOffFactor=1,this.distanceModel=kh,this.paused=!0,this.sources={},this.channel=this.currentSource=null}function as(e,t){zi.call(this,e),this.id="audiosource",this.description="Specifies audio assets that can be played at the position of the Entity.",this.ComponentType=ns,this.DataType=rs,this.schema=rc,this.manager=t,this.initialized=!1,zi.bind("initialize",this.onInitialize,this),zi.bind("update",this.onUpdate,this),this.on("remove",this.onRemove,this)}function os(e,t,i){if(!(e&&e instanceof Ui))throw Error("The parentComponent argument is required and must be a Component");if(!t||"string"!=typeof t)throw Error("The propertyName argument is required and must be a string");if(i&&"object"!=typeof i)throw Error("If provided, the eventConfig argument must be an object");this._parentComponent=e,this._entityPropertyName=t,this._entity=null,this._app=e.system.app,this._configureEventListeners(i||{},{"entity#destroy":this._onEntityDestroy}),this._toggleLifecycleListeners("on")}function hs(e,t){Ui.call(this,e,t),this._visualState=oc.DEFAULT,this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._defaultTint=new h(1,1,1,1),this._defaultSpriteAsset=null,this._defaultSpriteFrame=0,this._imageReference=new os(this,"imageEntity",{"element#gain":this._onImageElementGain,"element#lose":this._onImageElementLose,"element#set:color":this._onSetColor,"element#set:opacity":this._onSetOpacity,"element#set:spriteAsset":this._onSetSpriteAsset,"element#set:spriteFrame":this._onSetSpriteFrame}),this._toggleLifecycleListeners("on",e)}function ls(){this.active=this.enabled=!0,this.imageEntity=null,this.hitPadding=new b,this.transitionMode=ac,this.hoverTint=new h(.75,.75,.75),this.pressedTint=new h(.5,.5,.5),this.inactiveTint=new h(.25,.25,.25),this.fadeDuration=0,this.hoverSpriteAsset=null,this.hoverSpriteFrame=0,this.pressedSpriteAsset=null,this.pressedSpriteFrame=0,this.inactiveSpriteAsset=null,this.inactiveSpriteFrame=0}function cs(e){zi.call(this,e),this.id="button",this.ComponentType=hs,this.DataType=ls,this.schema=dc,this.on("beforeremove",this._onRemoveComponent,this),zi.bind("update",this.onUpdate,this)}function ds(){this.clearColor=new h(.722,.722,.722,1),this.clearStencilBuffer=this.clearDepthBuffer=this.clearColorBuffer=!0,this.nearClip=.1,this.farClip=1e3,this.fov=45,this.orthoHeight=100,this.priority=this.projection=0,this.rect=new b(0,0,1,1),this.scissorRect=new b(0,0,1,1),this.enabled=!0,this.frustumCulling=!1,this.cullFaces=!0,this.flipFaces=!1,this.layers=[0,1,2,4,3],this.camera=null,this.aspectRatio=16/9,this.aspectRatioMode=0,this.postEffects=this.renderTarget=null,this.isRendering=!1,this.calculateProjection=this.calculateTransform=null}function us(e,t){var i=this;this.app=e,this.camera=t,this.effects=[],this.enabled=!1,this.depthTarget=null,this.renderTargetScale=1,this.resizeTimeout=null,this.resizeLast=0,this._resizeTimeoutCallback=function(){i.resizeRenderTargets()},t.on("set_rect",this.onCameraRectChanged,this),this._origStencilColorBuffer=this._origDepthColorBuffer=this._origClearColorBuffer=this._origOverrideClear=!1}function ps(){this.enabled=!0,this.type="box",this.halfExtents=new v(.5,.5,.5),this.radius=.5,this.axis=1,this.height=2,this.model=this.shape=this.asset=null,this.initialized=!1}function fs(e,t,i){this.entity=t.entity,this.component=t,this.app=e,"undefined"==typeof Ammo||yc||(yc=new Ammo.btVector3,vc=new Ammo.btQuaternion,bc=new Ammo.btTransform),this.initialize(i)}function ms(){this.list=[]}function _s(e){this.func=void 0===e.func?7:e.func,this.ref=e.ref||0,this.readMask=void 0===e.readMask?255:e.readMask,this.writeMask=void 0===e.writeMask?255:e.writeMask,this.fail=e.fail||0,this.zfail=e.zfail||0,this.zpass=e.zpass||0}function gs(e,t,i){this._entity=e,this._element=e.element,this.model=new oe,this.node=new ge,this.model.graph=this.node,this.mesh=t,this.meshInstance=new ee(this.node,this.mesh,i),this.meshInstance.name="ImageElement: "+e.name,this.meshInstance.castShadow=!1,this._meshDirty=this.meshInstance.receiveShadow=!1,this.model.meshInstances.push(this.meshInstance),this._entity.addChild(this.model.graph),this.model._entity=this._entity,this.unmaskMeshInstance=null}function ys(e){this._element=e,this._entity=e.entity,this._system=e.system,this._sprite=this._spriteAsset=this._material=this._materialAsset=this._texture=this._textureAsset=null,this._spriteFrame=0,this._pixelsPerUnit=null,this._rect=new b(0,0,1,1),this._mask=!1,this._maskRef=0,this._outerScale=new T,this._outerScaleUniform=new Float32Array(2),this._innerOffset=new b,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new b,this._atlasRectUniform=new Float32Array(4),this._defaultMesh=this._createMesh(),this._renderable=new gs(this._entity,this._defaultMesh,this._material),this._color=new h(1,1,1,1),this._colorUniform=new Float32Array([1,1,1]),this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",1),this._updateAabbFunc=this._updateAabb.bind(this),this._onScreenChange(this._element.screen),this._element.on("resize",this._onParentResizeOrPivotChange,this),this._element.on("set:pivot",this._onParentResizeOrPivotChange,this),this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.on("set:screen",this._onScreenChange,this),this._element.on("set:draworder",this._onDrawOrderChange,this),this._element.on("screen:set:resolution",this._onResolutionChange,this)}function vs(e){r.call(this),this._app=e,e.i18n.on("set:locale",this._onSetLocale,this),this._disableLocalization=this._autoLoad=!1,this._localizedAsset=this._defaultAsset=null}function bs(e){this._symbols=e,this._last=this._index=0,this._cur=0<this._symbols.length?this._symbols[0]:null,this._buf=[],this._mode="text",this._error=null}function xs(e,t){for(var i in t)if(t.hasOwnProperty(i)){var s=t[i];s instanceof Object?(e.hasOwnProperty(i)||(e[i]={}),xs(e[i],t[i])):e[i]=s}}function Ss(e){if(0===e.length)return null;for(var t={},i=0;i<e.length;++i){var s=e[i],n={};n[s.name]={value:s.value,attributes:s.attributes},xs(t,n)}return t}function Ts(e){var t=new kc(e),i=[],s=[];return t.parse(i,s)?(t=s.find(function(e){return null===e.end}))?(console.warn("Markup error: found unclosed tag='"+t.name+"'"),{symbols:e,tags:null}):(e=function(e,t){function i(e){o=o.filter(function(t){return void 0===e.find(function(e){return e===t})})}function s(e){for(var t=0;t<e.length;++t)o.push(e[t])}var n;if(0===e.length)return null;var r={};for(n=0;n<e.length;++n){var a=e[n];r.hasOwnProperty(a.start)?null===r[a.start].open?r[a.start].open=[a]:r[a.start].open.push(a):r[a.start]={open:[a],close:null},r.hasOwnProperty(a.end)?null===r[a.end].close?r[a.end].close=[a]:r[a.end].close.push(a):r[a.end]={open:null,close:[a]}}var o=[];for(a=Object.keys(r).sort(function(e,t){return e-t}),e=[],n=0;n<a.length;++n){var h=r[a[n]];null!==h.close&&i(h.close),null!==h.open&&s(h.open),e.push({start:a[n],tags:Ss(o)})}for(r=[],a=null,n=0;n<e.length;++n){for(h=e[n];r.length<h.start;)r.push(a?a.tags:null);a=h}for(;r.length<t;)r.push(null);return r}(s,i.length),{symbols:i,tags:e}):(console.warn(t.error()),{symbols:e,tags:null})}function ws(){}function Ms(){this.quad=this.count=0,this.lines={},this.positions=[],this.normals=[],this.uvs=[],this.colors=[],this.indices=[],this.meshInstance=null}function Ps(e){this._element=e,this._system=e.system,this._entity=e.entity,this._text="",this._symbols=[],this._colorPalette=[],this._i18nKey=this._symbolColors=null,this._fontAsset=new vs(this._system.app),this._fontAsset.disableLocalization=!0,this._fontAsset.on("load",this._onFontLoad,this),this._fontAsset.on("change",this._onFontChange,this),this._fontAsset.on("remove",this._onFontRemove,this),this._font=null,this._color=new h(1,1,1,1),this._colorUniform=new Float32Array(3),this._spacing=1,this._fontSize=32,this._fontMaxY=this._fontMinY=0,this._maxFontSize=this._originalFontSize=32,this._minFontSize=8,this._autoFitHeight=this._autoFitWidth=!1,this._maxLines=-1,this._scaledLineHeight=this._lineHeight=32,this._wrapLines=!1,this._drawOrder=0,this._alignment=new T(.5,.5),this._autoHeight=this._autoWidth=!0,this.height=this.width=0,this._node=new ge,this._model=new oe,this._model.graph=this._node,this._entity.addChild(this._node),this._meshInfo=[],this._material=null,this._aabbDirty=!0,this._aabb=new w,this._noResize=!1,this._maskedMaterialSrc=this._currentMaterialType=null,this._rtl=this._unicodeConverter=this._rtlReorder=!1,this._outlineColor=new h(0,0,0,1),this._outlineColorUniform=new Float32Array(4),this._outlineThicknessScale=.2,this._outlineThickness=0,this._shadowColor=new h(0,0,0,1),this._shadowColorUniform=new Float32Array(4),this._shadowOffsetScale=.005,this._shadowOffset=new T(0,0),this._shadowOffsetUniform=new Float32Array(2),this._enableMarkup=!1,this._onScreenChange(this._element.screen),e.on("resize",this._onParentResize,this),e.on("set:screen",this._onScreenChange,this),e.on("screen:set:screenspace",this._onScreenSpaceChange,this),e.on("set:draworder",this._onDrawOrderChange,this),e.on("set:pivot",this._onPivotChange,this),this._system.app.i18n.on("set:locale",this._onLocaleSet,this),this._system.app.i18n.on("data:add",this._onLocalizationData,this),this._system.app.i18n.on("data:remove",this._onLocalizationData,this),this._rangeEnd=this._rangeStart=0}function As(e,t){Ui.call(this,e,t),this._beingInitialized=!1,this._anchor=new b,this._localAnchor=new b,this._pivot=new T,this._height=this._calculatedHeight=this._width=this._calculatedWidth=32,this._margin=new b(0,0,-32,-32),this._modelTransform=new x,this._screenToWorld=new x,this._anchorTransform=new x,this._anchorDirty=!0,this._parentWorldTransform=new x,this._screenTransform=new x,this._screenCorners=[new v,new v,new v,new v],this._canvasCorners=[new T,new T,new T,new T],this._worldCorners=[new v,new v,new v,new v],this._worldCornersDirty=this._canvasCornersDirty=this._cornersDirty=!0,this.entity.on("insert",this._onInsert,this),this._patch(),this.screen=null,this._type=Nc,this._group=this._text=this._image=null,this._drawOrder=0,this._useInput=!1,this._layers=[4],this._addedModels=[],this._batchGroupId=-1,this._offsetReadAt=0,this._maskOffset=.5,this._maskedBy=null}function Es(){this.enabled=!0}function Cs(e){zi.call(this,e),this.id="element",this.ComponentType=As,this.DataType=Es,this.schema=Kc,this._rtlReorder=this._unicodeConverter=null,this._defaultTexture=new K(e.graphicsDevice,{width:1,height:1,format:7}),this._defaultTexture.name="element-system",e=this._defaultTexture.lock();var t=new Uint8Array(4);t[0]=255,t[1]=255,t[2]=255,t[3]=255,e.set(t),this._defaultTexture.unlock(),this.defaultScreenSpaceBitmapTextMaterial=this.defaultScreenSpaceTextMaterial=this.defaultBitmapTextMaterial=this.defaultTextMaterial=this.defaultScreenSpaceImageMaskMaterial=this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImageMask9SlicedMaterial=this.defaultScreenSpaceImage9TiledMaterial=this.defaultScreenSpaceImage9SlicedMaterial=this.defaultScreenSpaceImageMaterial=this.defaultImage9TiledMaskMaterial=this.defaultImage9SlicedMaskMaterial=this.defaultImageMaskMaterial=this.defaultImage9TiledMaterial=this.defaultImage9SlicedMaterial=this.defaultImageMaterial=null,this.defaultImageMaterials=[],this.on("beforeremove",this.onRemoveComponent,this)}function Is(e,t){Ui.call(this,e,t),this._minHeight=this._minWidth=0,this._maxHeight=this._maxWidth=null,this._fitHeightProportion=this._fitWidthProportion=0,this._excludeFromLayout=!1}function Os(e){var t="_"+e;Object.defineProperty(Is.prototype,e,{get:function(){return this[t]},set:function(e){this[t]!==e&&(this[t]=e,this.fire("resize"))}})}function Rs(){this.enabled=!0}function Ds(){}function Ls(e){function t(e){return!(e=e.entity.layoutchild)||!e.enabled||!e.excludeFromLayout}function i(e,t,i){switch(e){case Qc:return id.NONE;case 1:return t<i?id.APPLY_STRETCHING:id.NONE;case 2:return t>=i?id.APPLY_SHRINKING:id.NONE;case 3:return t<i?id.APPLY_STRETCHING:t>=i?id.APPLY_SHRINKING:id.NONE;default:throw Error("Unrecognized fitting mode: "+e)}}function s(e,t){return l(e,t.size)+(e.length-1)*m.spacing[t.axis]}function n(e,t,i){var s=d(e,i.maxSize),n=c(e,i.fittingProportion),r=f(n,s);t=sd[i.axis]-t;for(var o=0;o<e.length;++o){var h=s[o],l=a(h,t,n,r),u=e[h][i.size]+l,p=Math.min(u,e[h][i.maxSize]);e[h][i.size]=p,t-=l-Math.max(u-p,0)}}function r(e,t,i){var s=d(e,i.minSize,!0),n=c(e,i.fittingProportion);if(1===n.length)n=[1];else{for(var r=[],o=n.length,h=0;h<o;++h)r.push((1-n[h])/(o-1));n=r}for(r=f(n,s),t-=sd[i.axis],o=0;o<e.length;++o){var l=a(h=s[o],t,n,r),u=e[h][i.size]-l,p=Math.max(u,e[h][i.minSize]);e[h][i.size]=p,t-=l-Math.max(p-u,0)}}function a(e,t,i,s){return i=i[e],e=s[e],1e-5>Math.abs(i)&&1e-5>Math.abs(e)?t:t*i/e}function o(e){for(var t=[],i=0;i<e.length;++i){var s=e[i],n=Math.max(h(s,"minWidth"),0),r=Math.max(h(s,"minHeight"),0),a=Math.max(h(s,"maxWidth"),n),o=Math.max(h(s,"maxHeight"),r),l=h(s,"width");l=Math.min(Math.max(l,n),a);var c=h(s,"height");c=Math.min(Math.max(c,r),o);var d=h(s,"fitWidthProportion");s=h(s,"fitHeightProportion"),t.push({minWidth:n,minHeight:r,maxWidth:a,maxHeight:o,width:l,height:c,fitWidthProportion:d,fitHeightProportion:s})}return t}function h(e,t){var i=e.entity.layoutchild;return i&&i.enabled&&void 0!==i[t]&&null!==i[t]?i[t]:void 0!==e[t]?e[t]:td[t]}function l(e,t){return e.reduce(function(e,i){return e+i[t]},0)}function c(e,t){var i,s=l(e,t),n=[],r=e.length;if(0===s)for(i=0;i<r;++i)n.push(1/r);else for(i=0;i<r;++i)n.push(e[i][t]/s);return n}function d(e,t,i){return e.forEach(u),e.slice().sort(function(e,s){return i?s[t]-e[t]:e[t]-s[t]}).map(p)}function u(e,t){e.index=t}function p(e){return e.index}function f(e,t){var i=[];i[t[e.length-1]]=e[t[e.length-1]];for(var s=e.length-2;0<=s;--s)i[t[s]]=i[t[s+1]]+e[t[s]];return i}var m,_=Jc[e],g=Jc[ed[e]];return function(e,a){e=e.filter(t),m=a,sd.x=m.containerSize.x-m.padding.x-m.padding.z,sd.y=m.containerSize.y-m.padding.y-m.padding.w,a=e;for(var h=0;h<a.length;++h){var l=a[h],c=l.anchor;0===c.x&&0===c.y&&0===c.z&&0===c.w||(l.anchor=b.ZERO)}if(m.wrap){a=[[]],h=o(e),l=0,c=2===m[_.fitting];for(var d=0;d<e.length;++d){0<a[a.length-1].length&&(l+=m.spacing[_.axis]);var u=h[d][_.size];l+=u,!c&&l>sd[_.axis]&&0!==a[a.length-1].length&&(l=u,a.push([])),a[a.length-1].push(e[d]),c&&l>sd[_.axis]&&d!==e.length-1&&(l=0,a.push([]))}e=a}else e=[e];if(a=0===m.orientation&&m.reverseX||1===m.orientation&&m.reverseY,h=0===m.orientation&&m.reverseY||1===m.orientation&&m.reverseX,a)for(l=0;l<e.length;++l)a&&e[l].reverse();for(h&&e.reverse(),a=[],h=0;h<e.length;++h)c=s(l=o(e[h]),_),(d=i(m[_.fitting],c,sd[_.axis]))===id.APPLY_STRETCHING?n(l,c,_):d===id.APPLY_SHRINKING&&r(l,c,_),a.push(l);for(u=[],d=[],l=0;l<e.length;++l){for((c=e[l]).largestElement=null,c.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY},h=0;h<c.length;++h){var p=a[l][h];p[g.size]>c.largestSize[g.size]&&(c.largestElement=c[h],c.largestSize=p)}u.push(c.largestElement),d.push(c.largestSize)}for(h=s(d,g),(l=i(m[g.fitting],h,sd[g.axis]))===id.APPLY_STRETCHING?n(d,h,g):l===id.APPLY_SHRINKING&&r(d,h,g),l=0;l<e.length;++l)for(c=e[l],h=0;h<c.length;++h)d=a[l][h],u=1===e.length?sd[g.axis]:c.largestSize[g.size],(p=i(m[g.fitting],d[g.size],u))===id.APPLY_STRETCHING?d[g.size]=Math.min(u,d[g.maxSize]):p===id.APPLY_SHRINKING&&(d[g.size]=Math.max(u,d[g.minSize]));e:{for((h={})[_.axis]=0,h[g.axis]=0,e[_.size]=Number.NEGATIVE_INFINITY,l=[],c=0;c<e.length;++c){if(0===(d=e[c]).length){h=void 0;break e}u=[],p=a[c];for(var f=0;f<d.length;++f){var y=d[f],v=p[f];h[g.axis]-=-v[g.size]*y.pivot[g.axis],h[_.axis]-=-v[_.size]*y.pivot[_.axis],u[f]={},u[f][_.axis]=h[_.axis],u[f][g.axis]=h[g.axis],h[g.axis]+=-v[g.size]*y.pivot[g.axis],h[_.axis]+=v[_.size]*(1-y.pivot[_.axis])+m.spacing[_.axis]}d[_.size]=h[_.axis]-m.spacing[_.axis],d[g.size]=d.largestSize[g.size],e[_.size]=Math.max(e[_.size],d[_.size]),h[_.axis]=0,h[g.axis]+=d[g.size]+m.spacing[g.axis],l.push(u)}e[g.size]=h[g.axis]-m.spacing[g.axis],h=l}for(l=h,c=m.alignment[_.axis],d=m.alignment[g.axis],u=m.padding[_.axis],p=m.padding[g.axis],f=0;f<e.length;++f){y=e[f],v=a[f];for(var x=l[f],S=(sd[_.axis]-y[_.size])*c+u,T=(sd[g.axis]-e[g.size])*d+p,w=0;w<y.length;++w){var M=(y[g.size]-v[w][g.size])*m.alignment[g.axis];x[w][_.axis]+=S,x[w][g.axis]+=T+M}}for(l=0;l<e.length;++l)for(c=e[l],d=a[l],u=h[l],p=0;p<c.length;++p)(f=c[p])[_.calculatedSize]=d[p][_.size],f[g.calculatedSize]=d[p][g.size],0===m.orientation?f.entity.setLocalPosition(u[p][_.axis],u[p][g.axis],f.entity.getLocalPosition().z):f.entity.setLocalPosition(u[p][g.axis],u[p][_.axis],f.entity.getLocalPosition().z);return a=e.width,e=e.height,{bounds:new b((sd.x-a)*m.alignment.x+m.padding.x,(sd.y-e)*m.alignment.y+m.padding.y,a,e)}}}function Fs(e,t){Ui.call(this,e,t),this._orientation=0,this._reverseX=!1,this._reverseY=!0,this._alignment=new T(0,1),this._padding=new b,this._spacing=new T,this._heightFitting=this._widthFitting=Qc,this._wrap=!1,this._layoutCalculator=new Ds,this._listenForReflowEvents(this.entity,"on"),this.entity.children.forEach(function(e){this._listenForReflowEvents(e,"on")}.bind(this)),this.entity.on("childinsert",this._onChildInsert,this),this.entity.on("childremove",this._onChildRemove,this),e.app.systems.element.on("add",this._onElementOrLayoutComponentAdd,this),e.app.systems.element.on("beforeremove",this._onElementOrLayoutComponentRemove,this),e.app.systems.layoutchild.on("add",this._onElementOrLayoutComponentAdd,this),e.app.systems.layoutchild.on("beforeremove",this._onElementOrLayoutComponentRemove,this)}function Bs(e){return e.element}function Ns(e){return e.enabled&&e.element&&e.element.enabled}function ks(e){var t="_"+e;Object.defineProperty(Fs.prototype,e,{get:function(){return this[t]},set:function(e){this[t]!==e&&(this[t]=e,this._scheduleReflow())}})}function Us(){this.enabled=!0}function zs(e){zi.call(this,e),this.id="layoutgroup",this.ComponentType=Fs,this.DataType=Us,this.schema=rd,this._reflowQueue=[],this.on("beforeremove",this._onRemoveComponent,this),zi.bind("postUpdate",this._onPostUpdate,this)}function Vs(e,t){Ui.call(this,e,t),this._cookieAssetId=this._cookieAsset=null,this._cookieAssetAdd=!1,this._cookieMatrix=null}function Gs(){for(var e,t=fd,i=md,s=0;s<t.length;s++)e=i[s],this[t[s]]=e&&e.clone?e.clone():e}function js(e){zi.call(this,e),this.id="light",this.description="Enables the Entity to emit light.",this.ComponentType=Vs,this.DataType=Gs,this.on("beforeremove",this._onRemoveComponent,this)}function Ws(e,t){Ui.call(this,e,t),this._type="asset",this._model=this._asset=null,this._mapping={},this._receiveShadows=this._castShadows=!0,this._materialAsset=null,this._material=e.defaultMaterial,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this._isStatic=!1,this._layers=[0],this._batchGroupId=-1,this._area=null,this._assetOld=0,this._materialEvents=null,this._clonedModel=this._dirtyMaterialAsset=this._dirtyModelAsset=!1,t.on("remove",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this)}function Hs(){this.enabled=!0}function Xs(e){zi.call(this,e),this.id="model",this.description="Renders a 3D model at the location of the Entity.",this.ComponentType=Ws,this.DataType=Hs,this.schema=gd,this.sphere=this.plane=this.cylinder=this.cone=this.capsule=this.box=null,this.defaultMaterial=e.scene.defaultMaterial,this.on("beforeremove",this.onRemove,this)}function qs(){this.rate=this.numParticles=1,this.rate2=null,this.startAngle=0,this.startAngle2=null,this.lifetime=50,this.emitterExtents=new v,this.emitterExtentsInner=new v,this.initialVelocity=this.emitterShape=this.emitterRadiusInner=this.emitterRadius=0,this.wrapBounds=new v,this.localSpace=!1,this.normalMapAsset=this.normalMap=this.colorMapAsset=this.colorMap=null,this.loop=!0,this.preWarm=!1,this.mode=this.sort=0,this.scene=null,this.halfLambert=this.lighting=!1,this.intensity=1,this.stretch=0,this.alignToMotion=!1,this.depthSoftening=0,this.mesh=this.meshAsset=null,this.noFog=this.depthWrite=!1,this.orientation=0,this.particleNormal=new v(0,1,0),this.animTilesY=this.animTilesX=1,this.animStartFrame=0,this.animNumAnimations=this.animNumFrames=1,this.animIndex=0,this.randomizeAnimIndex=!1,this.animSpeed=1,this.animLoop=!0,this.radialSpeedGraph2=this.radialSpeedGraph=this.rotationSpeedGraph2=this.rotationSpeedGraph=this.velocityGraph2=this.velocityGraph=this.localVelocityGraph2=this.localVelocityGraph=this.alphaGraph2=this.alphaGraph=this.colorGraph2=this.colorGraph=this.scaleGraph2=this.scaleGraph=null,this.blendType=2,this.model=null,this.enabled=!0,this.paused=!1,this.autoPlay=!0,this.layers=[0]}function Ys(e){zi.call(this,e),this.id="particlesystem",this.description="Updates and renders particle system in the scene.",this.ComponentType=Td,this.DataType=qs,this.schema=Cd,this.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"},this.on("beforeremove",this.onBeforeRemove,this),zi.bind("update",this.onUpdate,this)}function Ks(e,t){this._constructor=e,this._pool=[],this._count=0,this._resize(t)}function Zs(e,t){Ui.call(this,e,t),"undefined"==typeof Ammo||wd||(wd=new Ammo.btTransform,Md=new Ammo.btVector3,Pd=new Ammo.btVector3,Ad=new Ammo.btQuaternion,Ed=new Ammo.btVector3(0,0,0)),this.on("set_mass",this.onSetMass,this),this.on("set_linearDamping",this.onSetLinearDamping,this),this.on("set_angularDamping",this.onSetAngularDamping,this),this.on("set_linearFactor",this.onSetLinearFactor,this),this.on("set_angularFactor",this.onSetAngularFactor,this),this.on("set_friction",this.onSetFriction,this),this.on("set_restitution",this.onSetRestitution,this),this.on("set_type",this.onSetType,this),this.on("set_group",this.onSetGroupOrMask,this),this.on("set_mask",this.onSetGroupOrMask,this),this.on("set_body",this.onSetBody,this),this._linearVelocity=new v(0,0,0),this._angularVelocity=new v(0,0,0)}function $s(){this.enabled=!0,this.mass=1,this.angularDamping=this.linearDamping=0,this.linearFactor=new v(1,1,1),this.angularFactor=new v(1,1,1),this.friction=.5,this.restitution=0,this.type=xc,this.group=Sc,this.mask=Tc,this.body=null,this.simulationEnabled=!1}function Qs(e,t,i){this.entity=e,this.point=t,this.normal=i}function Js(e,t,i){0===arguments.length?(this.b=this.a=null,this.localPointA=new v,this.localPointB=new v,this.pointA=new v,this.pointB=new v,this.normal=new v):(this.a=e,this.b=t,this.localPointA=i.localPoint,this.localPointB=i.localPointOther,this.pointA=i.point,this.pointB=i.pointOther,this.normal=i.normal)}function en(e,t,i,s,n){0===arguments.length?(this.localPoint=new v,this.localPointOther=new v,this.point=new v,this.pointOther=new v,this.normal=new v):(this.localPoint=e,this.localPointOther=t,this.point=i,this.pointOther=s,this.normal=n)}function tn(e,t){this.other=e,this.contacts=t}function sn(e){zi.call(this,e),this.id="rigidbody",this.description="Adds the entity to the scene's physical simulation.",this._stats=e.stats.frame,this.ComponentType=Zs,this.DataType=$s,this.singleContactResultPool=this.contactResultPool=this.contactPointPool=null,this.schema=Ld,this.maxSubSteps=10,this.fixedTimeStep=1/60,this.gravity=new v(0,-9.81,0),this._dynamic=[],this._kinematic=[],this._triggers=[],this._compounds=[],this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this)}function nn(e,t){Ui.call(this,e,t),this._resolution=new T(640,320),this._referenceResolution=new T(640,320),this._scaleMode=Fd,this.scale=1,this._scaleBlend=.5,this._priority=0,this.cull=this._screenSpace=!1,this._screenMatrix=new x,e.app.graphicsDevice.on("resizecanvas",this._onResize,this)}function rn(){this.enabled=!0}function an(e){zi.call(this,e),this.id="screen",this.ComponentType=nn,this.DataType=rn,this.schema=Nd,this.windowResolution=new T,this._drawOrderSyncQueue=new l,this.app.graphicsDevice.on("resizecanvas",this._onResize,this),zi.bind("update",this._onUpdate,this),this.on("beforeremove",this.onRemoveComponent,this)}function on(e){this.scriptType=e,this.index={}}function hn(e){r.call(this);var t=this.constructor;this.app=e.app,this.entity=e.entity,this._enabled="boolean"!=typeof e.enabled||e.enabled,this._enabledOld=this.enabled,this.__destroyed=!1,this.__attributes={},this.__attributesRaw=e.attributes||{},this.__scriptType=t,this.__executionOrder=-1}function ln(e,t){if(Rl.legacy)return null;if(ln.reservedScripts[e])throw Error("script name: '"+e+"' is reserved, please change script name");var i=function(e){hn.call(this,e)};return(i.prototype=Object.create(hn.prototype)).constructor=i,i.extend=hn.extend,i.attributes=new on(i),cn(i,e,t),i}function cn(e,t,i){if(!e.legacy){if("function"!=typeof e)throw Error("script class: '"+e+"' must be a constructor function (i.e. class).");if(!(e.prototype instanceof hn))throw Error("script class: '"+hn.__getScriptName(e)+"' does not extend pc.ScriptType.");if(t=t||e.__name||hn.__getScriptName(e),ln.reservedScripts[t])throw Error("script name: '"+t+"' is reserved, please change script name");e.__name=t,(i?i.scripts:Ln.getApplication().scripts).add(e),di._push(e)}}function dn(e){this._sortBy=e.sortBy,this.items=[],this.length=0,this.loopIndex=-1,this._sortHandler=this._doSort.bind(this)}function un(e,t){Ui.call(this,e,t),this._scripts=[],this._updateList=new dn({sortBy:"__executionOrder"}),this._postUpdateList=new dn({sortBy:"__executionOrder"}),this._scriptsIndex={},this._destroyedScripts=[],this._destroyed=!1,this._scriptsData=null,this._enabled=this._oldState=!0,this._isLoopingThroughScripts=this._beingEnabled=!1,this._executionOrder=-1,this.on("set_enabled",this._onSetEnabled,this)}function pn(){this.enabled=!0}function fn(e){zi.call(this,e),this.id="script",this.ComponentType=un,this.DataType=pn,this._components=new dn({sortBy:"_executionOrder"}),this._enabledComponents=new dn({sortBy:"_executionOrder"}),this.preloading=!0,this.on("beforeremove",this._onBeforeRemove,this),zi.bind("initialize",this._onInitialize,this),zi.bind("postInitialize",this._onPostInitialize,this),zi.bind("update",this._onUpdate,this),zi.bind("postUpdate",this._onPostUpdate,this)}function mn(e,t){Ui.call(this,e,t),this.on("set_scripts",this.onSetScripts,this)}function _n(){this.scripts=[],this.enabled=!0,this.instances={},this._instances={},this.runInTools=!1,this.attributes={},this.areScriptsLoaded=this.postInitialized=this.initialized=!1}function gn(e,t){if(r.call(this),!(e&&e instanceof As))throw Error("Element was null or not an ElementComponent");if(t&&"x"!==t&&"y"!==t)throw Error("Unrecognized axis: "+t);this._element=e,this._app=e.system.app,this._axis=t||null,this._enabled=!0,this._dragScale=new v,this._dragStartMousePosition=new v,this._dragStartHandlePosition=new v,this._deltaMousePosition=new v,this._deltaHandlePosition=new v,this._isDragging=!1,this._toggleLifecycleListeners("on")}function yn(e,t){Ui.call(this,e,t),this._viewportReference=new os(this,"viewportEntity",{"element#gain":this._onViewportElementGain,"element#resize":this._onSetContentOrViewportSize}),this._contentReference=new os(this,"contentEntity",{"element#gain":this._onContentElementGain,"element#lose":this._onContentElementLose,"element#resize":this._onSetContentOrViewportSize}),this._scrollbarUpdateFlags={},this._scrollbarReferences={},this._scrollbarReferences[0]=new os(this,"horizontalScrollbarEntity",{"scrollbar#set:value":this._onSetHorizontalScrollbarValue,"scrollbar#gain":this._onHorizontalScrollbarGain}),this._scrollbarReferences[1]=new os(this,"verticalScrollbarEntity",{"scrollbar#set:value":this._onSetVerticalScrollbarValue,"scrollbar#gain":this._onVerticalScrollbarGain}),this._prevContentSizes={},this._prevContentSizes[0]=null,this._prevContentSizes[1]=null,this._scroll=new T,this._velocity=new v,this._dragStartPosition=new v,this._disabledContentInput=!1,this._disabledContentInputEntities=[],this._toggleLifecycleListeners("on",e),this._toggleElementListeners("on")}function vn(){this.enabled=!0}function bn(e,t){Ui.call(this,e,t),this._app=e.app,this._handleReference=new os(this,"handleEntity",{"element#gain":this._onHandleElementGain,"element#lose":this._onHandleElementLose,"element#set:anchor":this._onSetHandleAlignment,"element#set:margin":this._onSetHandleAlignment,"element#set:pivot":this._onSetHandleAlignment}),this._toggleLifecycleListeners("on")}function xn(){this.enabled=!0}function Sn(e){zi.call(this,e),this.id="scrollbar",this.ComponentType=bn,this.DataType=xn,this.schema=nu,this.on("beforeremove",this._onRemoveComponent,this)}function Tn(e,t,i){r.call(this),i=i||{},this._component=e,this._assets=e.system.app.assets,this._manager=e.system.manager,this._name=t||"Untitled",this._volume=void 0!==i.volume?Hr.clamp(Number(i.volume)||0,0,1):1,this._pitch=void 0!==i.pitch?Math.max(.01,Number(i.pitch)||0):1,this._loop=!(void 0===i.loop||!i.loop),this._duration=0<i.duration?i.duration:null,this._startTime=Math.max(0,Number(i.startTime)||0),this._overlap=!!i.overlap,this._autoPlay=!!i.autoPlay,this._lastNode=this._firstNode=null,this._asset=i.asset,this._asset instanceof Pt&&(this._asset=this._asset.id),this._onInstancePlayHandler=this._onInstancePlay.bind(this),this._onInstancePauseHandler=this._onInstancePause.bind(this),this._onInstanceResumeHandler=this._onInstanceResume.bind(this),this._onInstanceStopHandler=this._onInstanceStop.bind(this),this._onInstanceEndHandler=this._onInstanceEnd.bind(this),this.instances=[]}function wn(e,t){Ui.call(this,e,t),this.on("set_slots",this.onSetSlots,this),this.on("set_volume",this.onSetVolume,this),this.on("set_pitch",this.onSetPitch,this),this.on("set_refDistance",this.onSetRefDistance,this),this.on("set_maxDistance",this.onSetMaxDistance,this),this.on("set_rollOffFactor",this.onSetRollOffFactor,this),this.on("set_distanceModel",this.onSetDistanceModel,this),this.on("set_positional",this.onSetPositional,this)}function Mn(){this.enabled=!0,this.pitch=this.volume=1,this.positional=!0,this.refDistance=1,this.maxDistance=1e4,this.rollOffFactor=1,this.distanceModel="linear",this.slots={},this.playingBeforeDisable={}}function Pn(e,t){r.call(this),this._component=e,this._frame=0,this._spriteAsset=this._sprite=null,this.spriteAsset=t.spriteAsset,this.name=t.name,this.fps=t.fps||0,this.loop=t.loop||!1,this._paused=this._playing=!1,this._time=0}function An(){this.enabled=!0}function En(e){zi.call(this,e),this.id="sprite",this.ComponentType=lu,this.DataType=An,this.schema=cu,this._default9SlicedMaterialTiledMode=this._default9SlicedMaterialSlicedMode=this._defaultMaterial=this._defaultTexture=null,zi.bind("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)}function Cn(e,t){Ui.call(this,e,t),this._oldState=!0,this._size=new v,this.on("set_enabled",this._onSetEnabled,this)}function In(){this.enabled=!0}function On(e){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.vram=e._vram,this.shaders=e._shaderStats,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this,"scene",{get:function(){return Ln._currentApplication.scene._stats}}),Object.defineProperty(this,"lightmapper",{get:function(){return Ln._currentApplication.lightmapper._stats}}),Object.defineProperty(this,"batcher",{get:function(){return Ln._currentApplication.batcher._stats}})}function Rn(e,t){this.name=e,this.url=t}function Dn(e){this._app=e,this._list=[],this._index={},this._urlIndex={}}function Ln(t,i){r.call(this),i=i||{},console.log("Powered by PlayCanvas 1.30.0 878f4ce"),Ln._applications[t.id]=this,Ln._currentApplication=this,e.app=this,this._time=0,this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.autoRender=!0,this.renderNextFrame=!1,this.useLegacyScriptAttributeCloning=Rl.legacy,this._librariesLoaded=!1,this._fillMode=jl,this._resolutionMode=Wl,this._allowResize=!0,this.context=this,i.graphicsDeviceOptions||(i.graphicsDeviceOptions={}),i.graphicsDeviceOptions.xrCompatible=!0,this.graphicsDevice=new Lu(t,i.graphicsDeviceOptions),this.stats=new On(this.graphicsDevice),this._soundManager=new at(i),this.loader=new hi(this),this._entityIndex={},this.scene=new it,this.root=new ut(this),this.root._enabledInHierarchy=!0,this._enableList=[],this._enableList.size=0,this.assets=new Ei(this.loader),i.assetPrefix&&(this.assets.prefix=i.assetPrefix),this.bundles=new Ci(this.assets),this.enableBundles="undefined"!=typeof TextDecoder,this.scriptsOrder=i.scriptsOrder||[],this.scripts=new Ii(this),this.i18n=new wt(this),this.scenes=new Dn(this);var s=this;this.defaultLayerWorld=new Se({name:"World",id:0}),this.graphicsDevice.webgl2?(this.defaultLayerDepth=new Se({enabled:!1,name:"Depth",id:1,onEnable:function(){if(!this.renderTarget){var e=new K(s.graphicsDevice,{format:17,width:s.graphicsDevice.width,height:s.graphicsDevice.height});e.name="rt-depth2",e.minFilter=0,e.magFilter=0,e.addressU=1,e.addressV=1,this.renderTarget=new Bu({colorBuffer:null,depthBuffer:e,autoResolve:!1}),s.graphicsDevice.scope.resolve("uDepthMap").setValue(e)}},onDisable:function(){this.renderTarget&&(this.renderTarget._depthBuffer.destroy(),this.renderTarget.destroy(),this.renderTarget=null)},onPreRenderOpaque:function(e){var t=s.graphicsDevice.gl;this.srcFbo=t.getParameter(t.FRAMEBUFFER_BINDING),this.renderTarget&&this.renderTarget.width===s.graphicsDevice.width&&this.renderTarget.height===s.graphicsDevice.height||(this.onDisable(),this.onEnable()),this.oldClear=this.cameras[e].camera._clearOptions,this.cameras[e].camera._clearOptions=this.depthClearOptions},onPostRenderOpaque:function(e){this.renderTarget&&(this.cameras[e].camera._clearOptions=this.oldClear,e=s.graphicsDevice.gl,s.graphicsDevice.setRenderTarget(this.renderTarget),s.graphicsDevice.updateBegin(),e.bindFramebuffer(e.READ_FRAMEBUFFER,this.srcFbo),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this.renderTarget._glFrameBuffer),e.blitFramebuffer(0,0,this.renderTarget.width,this.renderTarget.height,0,0,this.renderTarget.width,this.renderTarget.height,e.DEPTH_BUFFER_BIT,e.NEAREST))}}),this.defaultLayerDepth.depthClearOptions={flags:0}):(this.defaultLayerDepth=new Se({enabled:!1,name:"Depth",id:1,shaderPass:2,onEnable:function(){if(!this.renderTarget){var e=new K(s.graphicsDevice,{format:7,width:s.graphicsDevice.width,height:s.graphicsDevice.height});e.name="rt-depth1",e.minFilter=0,e.magFilter=0,e.addressU=1,e.addressV=1,this.renderTarget=new Bu(s.graphicsDevice,e,{depth:!0,stencil:s.graphicsDevice.supportsStencil}),s.graphicsDevice.scope.resolve("uDepthMap").setValue(e)}},onDisable:function(){this.renderTarget&&(this.renderTarget._colorBuffer.destroy(),this.renderTarget.destroy(),this.renderTarget=null)},onPostCull:function(e){var t=this.instances.visibleOpaque[e],i=t.list,n=0,r=s.scene.layers.layerList,a=s.scene.layers.subLayerEnabled,o=s.scene.layers.subLayerList,h=s.defaultLayerWorld.renderTarget;e=this.cameras[e];for(var l,c,d,u,p=0;p<r.length&&(l=r[p])!==this;p++)if(l.renderTarget===h&&l.enabled&&a[p]&&!(0>(c=l.cameras.indexOf(e))))for(c=o[p]?l.instances.visibleTransparent[c]:l.instances.visibleOpaque[c],d=c.length,c=c.list,l=0;l<d;l++)(u=c[l]).material&&u.material.depthWrite&&!u._noDepthDrawGl1&&(i[n]=u,n++);t.length=n},onPreRenderOpaque:function(e){this.renderTarget&&this.renderTarget.width===s.graphicsDevice.width&&this.renderTarget.height===s.graphicsDevice.height||(this.onDisable(),this.onEnable()),this.oldClear=this.cameras[e].camera._clearOptions,this.cameras[e].camera._clearOptions=this.rgbaDepthClearOptions},onDrawCall:function(){s.graphicsDevice.setColorWrite(!0,!0,!0,!0)},onPostRenderOpaque:function(e){this.renderTarget&&(this.cameras[e].camera._clearOptions=this.oldClear)}}),this.defaultLayerDepth.rgbaDepthClearOptions={color:[254/255,254/255,254/255,254/255],depth:1,flags:3}),this.defaultLayerSkybox=new Se({enabled:!1,name:"Skybox",id:2,opaqueSortMode:0}),this.defaultLayerUi=new Se({enabled:!0,name:"UI",id:4,transparentSortMode:1,passThrough:!1}),this.defaultLayerImmediate=new Se({enabled:!0,name:"Immediate",id:3,opaqueSortMode:0,passThrough:!0}),this.defaultLayerComposition=new Re,this.defaultLayerComposition.pushOpaque(this.defaultLayerWorld),this.defaultLayerComposition.pushOpaque(this.defaultLayerDepth),this.defaultLayerComposition.pushOpaque(this.defaultLayerSkybox),this.defaultLayerComposition.pushTransparent(this.defaultLayerWorld),this.defaultLayerComposition.pushOpaque(this.defaultLayerImmediate),this.defaultLayerComposition.pushTransparent(this.defaultLayerImmediate),this.defaultLayerComposition.pushTransparent(this.defaultLayerUi),this.scene.layers=this.defaultLayerComposition,this._immediateLayer=this.defaultLayerImmediate,this.scene.on("set:layers",function(e,t){e=t.layerList;for(var i=0;i<e.length;i++)switch(t=e[i],t.id){case 1:t.onEnable=s.defaultLayerDepth.onEnable,t.onDisable=s.defaultLayerDepth.onDisable,t.onPreRenderOpaque=s.defaultLayerDepth.onPreRenderOpaque,t.onPostRenderOpaque=s.defaultLayerDepth.onPostRenderOpaque,t.depthClearOptions=s.defaultLayerDepth.depthClearOptions,t.rgbaDepthClearOptions=s.defaultLayerDepth.rgbaDepthClearOptions,t.shaderPass=s.defaultLayerDepth.shaderPass,t.onPostCull=s.defaultLayerDepth.onPostCull,t.onDrawCall=s.defaultLayerDepth.onDrawCall;break;case 4:t.passThrough=s.defaultLayerUi.passThrough;break;case 3:t.passThrough=s.defaultLayerImmediate.passThrough}}),this.renderer=new Ae(this.graphicsDevice),this.renderer.scene=this.scene,this.lightmapper=new Le(this.graphicsDevice,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this),this.batcher=new de(this.graphicsDevice,this.root,this.scene),this.once("prerender",this._firstBatch,this),this.keyboard=i.keyboard||null,this.mouse=i.mouse||null,this.touch=i.touch||null,this.gamepads=i.gamepads||null,(this.elementInput=i.elementInput||null)&&(this.elementInput.app=this),this.vr=null,this.xr=new ki(this),this.elementInput&&this.elementInput.attachSelectEvents(),this._inTools=!1,this._skyboxLast=0,this._scriptPrefix=i.scriptPrefix||"",this.enableBundles&&this.loader.addHandler("bundle",new kt(this.assets)),this.loader.addHandler("animation",new Et),this.loader.addHandler("animclip",new Ct),this.loader.addHandler("animstategraph",new Ot),this.loader.addHandler("model",new oi(this.graphicsDevice,this.scene.defaultMaterial)),this.loader.addHandler("material",new ti(this)),this.loader.addHandler("texture",new Ai(this.graphicsDevice,this.assets,this.loader)),this.loader.addHandler("text",new vi),this.loader.addHandler("json",new $t),this.loader.addHandler("audio",new Dt(this._soundManager)),this.loader.addHandler("script",new di(this)),this.loader.addHandler("scene",new li(this)),this.loader.addHandler("cubemap",new Gt(this.graphicsDevice,this.assets,this.loader)),this.loader.addHandler("html",new Zt),this.loader.addHandler("css",new Vt),this.loader.addHandler("shader",new ui),this.loader.addHandler("hierarchy",new Kt(this)),this.loader.addHandler("scenesettings",new ci(this)),this.loader.addHandler("folder",new jt),this.loader.addHandler("font",new Xt(this.loader)),this.loader.addHandler("binary",new Lt),this.loader.addHandler("textureatlas",new xi(this.loader)),this.loader.addHandler("sprite",new fi(this.assets,this.graphicsDevice)),this.loader.addHandler("template",new yi(this)),this.loader.addHandler("container",new zt(this.graphicsDevice,this.scene.defaultMaterial)),this.systems=new ms,this.systems.add(new sn(this)),this.systems.add(new Bc(this)),this.systems.add(new Xi(this)),this.systems.add(new es(this)),this.systems.add(new Xs(this)),this.systems.add(new _c(this)),this.systems.add(new js(this)),Rl.legacy?this.systems.add(new Xd(this)):this.systems.add(new fn(this)),this.systems.add(new as(this,this._soundManager)),this.systems.add(new hu(this,this._soundManager)),this.systems.add(new ss(this,this._soundManager)),this.systems.add(new Ys(this)),this.systems.add(new an(this)),this.systems.add(new Cs(this)),this.systems.add(new cs(this)),this.systems.add(new su(this)),this.systems.add(new Sn(this)),this.systems.add(new En(this)),this.systems.add(new zs(this)),this.systems.add(new $c(this)),this.systems.add(new uu(this)),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),"undefined"!=typeof document&&(void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1))),this.meshInstanceArray=[],this.tick=gu(this)}function Fn(){this.name="Untitled",this.id=yu++,this._shader=null,this.variants={},this.parameters={},this.alphaTest=0,this.blend=this.alphaToCoverage=!1,this.blendSrc=1,this.blendEquation=this.blendDst=0,this.separateAlphaBlend=!1,this.blendSrcAlpha=1,this.blendAlphaEquation=this.blendDstAlpha=0,this.cull=1,this.depthWrite=this.depthTest=!0,this.stencilBack=this.stencilFront=null,this.slopeDepthBias=this.depthBias=0,this.alphaWrite=this.blueWrite=this.greenWrite=this.redWrite=!0,this.meshInstances=[],this._shaderVersion=0,this._scene=null,this._dirtyBlend=!1,this.dirty=!0}function Bn(){this._mapXForms=null}function Nn(){Fn.call(this),this._assetReferences={},this._validator=null,this.shaderOptBuilder=new Bn,this.reset()}function kn(e){this._device=e,this._cache={},this._generators={},this._precached=this._isClearingCache=!1,this._programsCollection=[],this._defaultStdMatOption={},this._defaultStdMatOptionMin={};var t=new Nn;t.shaderOptBuilder.updateRef(this._defaultStdMatOption,e,{},t,null,[],0,null,null),t.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,e,{},t,null,[],3,null,null)}function Un(){this.revision=this.globalId=0}function zn(){Ru++,this.version=new Un,this.version.globalId=Ru}function Vn(e){this.name=e,this.value=null,this.versionObject=new zn}function Gn(e){this.name=e,this.variables={},this.namespaces={}}function jn(e,t,i,s){this.locationId=s,this.scopeId=e.scope.resolve(t),this.version=new Un,2===i&&"[0]"===t.substr(t.length-3)&&(i=17),this.dataType=i,this.value=[null,null,null,null],this.array=[]}function Wn(e,t){var i=!0,s=e.createTexture();return e.bindTexture(e.TEXTURE_2D,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,2,2,0,e.RGBA,t,null),t=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,t),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,s,0),e.checkFramebufferStatus(e.FRAMEBUFFER)!==e.FRAMEBUFFER_COMPLETE&&(i=!1),e.bindTexture(e.TEXTURE_2D,null),e.deleteTexture(s),e.bindFramebuffer(e.FRAMEBUFFER,null),e.deleteFramebuffer(t),i}function Hn(e,t,i){var s=t._colorBuffer;if(7==s.format){var n=new Uint8Array(s.width*s.height*4),r=e.gl;e.setFramebuffer(t._glFrameBuffer),r.readPixels(0,0,s.width,s.height,r.RGBA,r.UNSIGNED_BYTE,n),s._levels||(s._levels=[]),s._levels[0]||(s._levels[0]=[]),s._levels[0][i]=n}}function Xn(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}function qn(e,t){var i=e.width;if(7!=e.format)console.error("ERROR: SH: cubemap must be RGBA8");else{if(e._levels[0]){if(!e._levels[0][0].length){if(!(e._levels[0][0]instanceof HTMLImageElement))return void console.error("ERROR: SH: cubemap must be composed of arrays or images");var s=Ln.getApplication().graphicsDevice,n=s.gl,r=Ma,a=r.createShaderFromCode(s,r.fullscreenQuadVS,r.fullscreenQuadPS,"fsQuadSimple"),o=s.scope.resolve("source");for(r=0;6>r;r++){var h=e._levels[0][r],l=new K(s,{cubemap:!1,type:"default",format:e.format,width:i,height:i,mipmaps:!1});l.name="prefiltered-cube",l._levels[0]=h,l.upload(),(h=new K(s,{cubemap:!1,type:"default",format:e.format,width:i,height:i,mipmaps:!1})).name="prefiltered-cube",h=new Bu(s,h,{depth:!1}),o.setValue(l),q(s,h,a);var c=new Uint8Array(i*i*4);n.bindFramebuffer(n.FRAMEBUFFER,h._glFrameBuffer),n.readPixels(0,0,l.width,l.height,n.RGBA,n.UNSIGNED_BYTE,c),e._levels[0][r]=c}}for(a=[],n=0;n<i;n++)for(s=0;s<i;s++)a[n*i+s]=new v(s/(i-1)*2-1,n/(i-1)*2-1,1).normalize();for(o=new Float32Array(27),r=h=0;6>r;r++)for(n=0;n<i;n++)for(s=0;s<i;s++){l=n*i+s;var d=n,u=i,p=(2*((c=s)+.5)/u-1)*(1-1/u),f=(2*(d+.5)/u-1)*(1-1/u),m=1/u,_=p-m,g=f-m;if(p+=m,f+=m,_=Xn(_,g)-Xn(_,f)-Xn(p,g)+Xn(p,f),0===c&&0===d||c===u-1&&0===d||0===c&&d===u-1||c===u-1&&d===u-1?_/=3:0!==c&&0!==d&&c!==u-1&&d!==u-1||(_*=.5),d=4*(c=_)/17,u=8*c/17,_=15*c/17,g=5*c/68,f=15*c/68,m=a[l],0==r)var y=m.z,b=-m.y,x=-m.x;else 1==r?(y=-m.z,b=-m.y,x=m.x):2==r?(y=m.x,b=m.z,x=m.y):3==r?(y=m.x,b=-m.z,x=-m.y):4==r?(y=m.x,b=-m.y,x=m.z):5==r&&(y=-m.x,b=-m.y,x=-m.z);for(t||(y=-y),p=e._levels[0][r][4*l+3]/255,m=0;3>m;m++){var S=e._levels[0][r][4*l+m]/255;"rgbm"===e.type?(S*=8*p,S*=S):S=Math.pow(S,2.2),o[0+m]+=S*d,o[3+m]+=S*u*y,o[6+m]+=S*u*b,o[9+m]+=S*u*x,o[12+m]+=S*_*y*x,o[15+m]+=S*_*x*b,o[18+m]+=S*_*b*y,o[21+m]+=S*g*(3*x*x-1),o[24+m]+=S*f*(y*y-b*b),h+=c}}for(m=0;m<o.length;m++)o[m]*=4*Math.PI/h;return o}console.error("ERROR: SH: cubemap must be synced to CPU")}}function Yn(e){this.device=e,this.depthMap=this.shader=null,this.vertexBuffer=Kn(e),this.needsDepthBuffer=!1}function Kn(e){var t=new R(e,[{semantic:"POSITION",components:2,type:6}]);return(t=new X(e=new I(e,t,4))).element.POSITION.set(-1,-1),t.next(),t.element.POSITION.set(1,-1),t.next(),t.element.POSITION.set(-1,1),t.next(),t.element.POSITION.set(1,1),t.end(),e}function Zn(e,t,i,s,n){var r=e.getRenderTarget();e.setRenderTarget(t),e.updateBegin();var a=null!==t?t.width:e.width,o=null!==t?t.height:e.height,h=0,l=0;n&&(h=n.x*a,l=n.y*o,a*=n.z,o*=n.w),n=e.vx,t=e.vy;var c=e.vw,d=e.vh;e.setViewport(h,l,a,o);var u=e.sx,p=e.sy,f=e.sw,m=e.sh;e.setScissor(h,l,a,o),a=e.getBlending(),o=e.getDepthTest(),h=e.getDepthWrite(),l=e.getCullMode();var _=e.writeRed,g=e.writeGreen,y=e.writeBlue,v=e.writeAlpha;e.setBlending(!1),e.setDepthTest(!1),e.setDepthWrite(!1),e.setCullMode(0),e.setColorWrite(!0,!0,!0,!0),e.setVertexBuffer(i,0),e.setShader(s),e.draw(Nu),e.setBlending(a),e.setDepthTest(o),e.setDepthWrite(h),e.setCullMode(l),e.setColorWrite(_,g,y,v),e.updateEnd(),e.setRenderTarget(r),e.updateBegin(),e.setViewport(n,t,c,d),e.setScissor(u,p,f,m)}function $n(e,t){t=t||3,this.device=e.device;var i=this.device.gl;this._inputBuffer=e,3===t&&e.usage!==t&&(i.bindBuffer(i.ARRAY_BUFFER,e.bufferId),i.bufferData(i.ARRAY_BUFFER,e.storage,i.DYNAMIC_COPY)),this._outputBuffer=new I(e.device,e.format,e.numVertices,t,e.storage)}function Qn(){Fn.call(this)}function Jn(e,t,i){e instanceof Lu&&(e=Ln.getApplication()),this.app=e;var s=this.device=e.graphicsDevice;this.library=s.getProgramLibrary(),this.pickColor=new Float32Array(4),this.pickColor[3]=1,this.scene=null,this.drawCalls=[],this.layerComp=this.layer=null,this.clearOptions={color:[1,1,1,1],depth:1,flags:3};var n=this;this._clearDepthOptions={depth:1,flags:2},this.clearDepthCommand=new te(0,0,function(){s.clear(n._clearDepthOptions)}),this.resize(t,i),this._ignoreOpacityFor=null}function er(){var e={astc:10,dxt:2,etc2:0,etc1:0,pvr:8,atc:11,none:14},t={astc:10,dxt:3,etc2:1,etc1:16,pvr:9,atc:12,none:16},i={0:21,1:23,2:8,3:10,8:26,9:27,10:28,11:29,12:30,13:7,14:3,16:5},s="undefined"!=typeof performance,n=function(n,r,a,o,h){var l=s?performance.now():0,c=new n.BasisFile(new Uint8Array(o));n=c.getImageWidth(0,0),o=c.getImageHeight(0,0);var d=c.getNumImages(),u=c.getNumLevels(0),p=!!c.getHasAlpha();if(!(n&&o&&d&&u))throw c.close(),c.delete(),Error("Invalid image dimensions url="+r+" width="+n+" height="+o+" images="+d+" levels="+u);if(8!==(a=p?t[a]:e[a])&&9!==a||0==(n&n-1)&&n===o||(a=8===a?14:13),h&&h.unswizzleGGGR&&(a=13),!c.startTranscoding())throw c.close(),c.delete(),Error("Failed to start transcoding url="+r);p=[];for(var f=0;f<u;++f){var m=c.getImageTranscodedSizeInBytes(0,f,a),_=new Uint8Array(m);if(!c.transcodeImage(_,0,f,a,1,0))throw c.close(),c.delete(),Error("Failed to transcode image url="+r);if(14===a||16===a){var g=new Uint16Array(m/2);for(d=0;d<m/2;++d)g[d]=_[2*d]+256*_[2*d+1];_=g}p.push(_)}if(c.close(),c.delete(),h&&h.unswizzleGGGR)for(a=14,d=0;d<p.length;++d){for(h=d,c=p[d],u=0;u<c.length;u+=4)m=c[u+3],f=c[u+1],c[u+0]=m,m=2/255*m-1,f=2/255*f-1,c[u+2]=Math.max(0,Math.min(255,Math.floor(127.5*(Math.sqrt(1-Math.min(1,m*m+f*f))+1)))),c[u+3]=255;for(u=new Uint16Array(c.length/4),f=0;f<c.length;f+=4)u[f/4]=(248&c[f+0])<<8|(252&c[f+1])<<3|c[f+2]>>3;p[h]=u}return{format:i[a],width:n+3&-4,height:o+3&-4,levels:p,cubemap:!1,mipmaps:!0,transcodeTime:s?performance.now()-l:0,url:r}},r=null,a=[],o=function(e,t,i,s){try{var a=n(r,e,t,i,s);a.levels=a.levels.map(function(e){return e.buffer}),self.postMessage({url:e,data:a},a.levels)}catch(t){self.postMessage({url:e.toString(),err:t.toString()})}};self.onmessage=function(e){switch((e=e.data).type){case"init":!function(e){self.BASIS(e?{instantiateWasm:function(t,i){return WebAssembly.instantiate(e,t).then(function(e){i(e)}),{}}}:null).then(function(e){for((r=e).initializeBasis(),e=0;e<a.length;++e)o(a[e].url,a[e].format,a[e].data,a[e].options);a=[]})}(e.module);break;case"transcode":r?o(e.url,e.format,e.data,e.options):a.push(e)}}}function tr(){if(!Gu){var e=Ln.getApplication().graphicsDevice;Gu=e.extCompressedTextureASTC?"astc":e.extCompressedTextureS3TC?"dxt":e.extCompressedTextureETC?"etc2":e.extCompressedTextureETC1?"etc1":e.extCompressedTexturePVRTC?"pvr":e.extCompressedTextureATC?"atc":"none"}return Gu}function ir(e){var t=e.data.url,i=e.data.err;e=e.data.data;var s,n=Vu[t];if(n)if(i)for(s=0;s<n.length;++s)n[s](i);else{for(e.levels=3===e.format||5===e.format?e.levels.map(function(e){return new Uint16Array(e)}):e.levels.map(function(e){return new Uint8Array(e)}),s=0;s<n.length;++s)n[s](null,e);delete Vu[t]}else console.error("internal logical error encountered in basis transcoder")}function sr(e,t,i,s){Vu.hasOwnProperty(e)?Vu[e].push(i):(Vu[e]=[i],zu.postMessage({type:"transcode",url:e,format:tr(),data:t,options:s},[t]))}function nr(e,t,i){for(e=["/* basis.js */",e,"/* mappings */\nvar PIXELFORMAT_ETC1 = 21;\nvar PIXELFORMAT_ETC2_RGBA = 23;\nvar PIXELFORMAT_DXT1 = 8;\nvar PIXELFORMAT_DXT5 = 10;\nvar PIXELFORMAT_PVRTC_4BPP_RGB_1 = 26;\nvar PIXELFORMAT_PVRTC_4BPP_RGBA_1 = 27;\nvar PIXELFORMAT_ASTC_4x4 = 28;\nvar PIXELFORMAT_ATC_RGB = 29;\nvar PIXELFORMAT_ATC_RGBA = 30;\nvar PIXELFORMAT_R8_G8_B8_A8 = 7;\nvar PIXELFORMAT_R5_G6_B5 = 3;\nvar PIXELFORMAT_R4_G4_B4_A4 = 5;\n\n/* worker */","("+er.toString()+")()\n\n"].join("\n"),e=new Blob([e],{type:"application/javascript"}),e=URL.createObjectURL(e),(zu=new Worker(e)).addEventListener("message",ir),zu.postMessage({type:"init",module:t}),i&&i(),t=0;t<ju.length;++t)sr((i=ju[t]).url,i.data,i.callback,i.options)}function rr(e,t,i,s){if(Uu&&console.warn("basis module is being downloaded more than once"),Uu=!0,ku){var n=null,r=null,a=function(){n&&r&&nr(n,r,s)},o=function(){qr.get(t,{cache:!0,responseType:"arraybuffer",retry:!1},function(e,t){t&&WebAssembly.compile(t).then(function(e){r=e,a()})})};WebAssembly.compileStreaming?WebAssembly.compileStreaming(fetch(t)).then(function(e){r=e,a()}).catch(function(e){console.error(e),console.warn("compileStreaming() failed for "+t+", falling back to arraybuffer download..."),o()}):o(),qr.get(e,{cache:!0,responseType:"text",retry:!1},function(e,t){n=t,a()})}else qr.get(i,{cache:!0,responseType:"text",retry:!1},function(e,t){t&&nr(t,null,s)})}function ar(e){var t=((window.config?window.config.wasmModules:window.PRELOAD_MODULES)||[]).find(function(e){return"BASIS"===e.moduleName});if(t){var i=window.ASSET_PREFIX?window.ASSET_PREFIX:"";rr(i+t.glueUrl,i+t.wasmUrl,i+t.fallbackUrl,e)}}function or(){}function hr(e,t){t?(this.key=t.keyCode,this.element=t.target,this.event=t):this.event=this.element=this.key=null}function lr(e){return Wu.key=e.keyCode,Wu.element=e.target,Wu.event=e,Wu}function cr(e){return"string"==typeof e?e.toUpperCase().charCodeAt(0):e}function dr(e,t){r.call(this),t=t||{},this._element=null,this._keyDownHandler=this._handleKeyDown.bind(this),this._keyUpHandler=this._handleKeyUp.bind(this),this._keyPressHandler=this._handleKeyPress.bind(this),this._keymap={},this._lastmap={},e&&this.attach(e),this.preventDefault=t.preventDefault||!1,this.stopPropagation=t.stopPropagation||!1}function ur(e,t){var i={x:0,y:0};if(t){if(t instanceof ur)throw Error("Expected MouseEvent");i=e._getTargetCoords(t)}else t={};if(i)this.x=i.x,this.y=i.y;else{if(!pr.isPointerLocked())return;this.y=this.x=0}this.wheelDelta=0,"wheel"===t.type&&(0<t.deltaY?this.wheelDelta=1:0>t.deltaY&&(this.wheelDelta=-1)),pr.isPointerLocked()?(this.dx=t.movementX||t.webkitMovementX||t.mozMovementX||0,this.dy=t.movementY||t.webkitMovementY||t.mozMovementY||0):(this.dx=this.x-e._lastX,this.dy=this.y-e._lastY),this.button="mousedown"===t.type||"mouseup"===t.type?t.button:-1,this.buttons=e._buttons.slice(0),this.element=t.target,this.ctrlKey=t.ctrlKey||!1,this.altKey=t.altKey||!1,this.shiftKey=t.shiftKey||!1,this.metaKey=t.metaKey||!1,this.event=t}function pr(e){r.call(this),this._lastY=this._lastX=0,this._buttons=[!1,!1,!1],this._lastbuttons=[!1,!1,!1],this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._contextMenuHandler=function(e){e.preventDefault()},this._target=null,this._attached=!1,this.attach(e)}function fr(e,t){t=t||{},this._keyboard=t.keyboard||null,this._mouse=t.mouse||null,this._gamepads=t.gamepads||null,this._element=null,this._actions={},this._axes={},this._axesValues={},e&&this.attach(e)}function mr(e,t,i){this.event=e,this.element=t,this.camera=i,this._stopPropagation=!1}function _r(e,t,i,s,n,r,a){mr.call(this,e,t,i),this.x=s,this.y=n,this.ctrlKey=e.ctrlKey||!1,this.altKey=e.altKey||!1,this.shiftKey=e.shiftKey||!1,this.metaKey=e.metaKey||!1,this.button=e.button,pr.isPointerLocked()?(this.dx=e.movementX||e.webkitMovementX||e.mozMovementX||0,this.dy=e.movementY||e.webkitMovementY||e.mozMovementY||0):(this.dx=s-r,this.dy=n-a),this.wheelDelta=0,"wheel"===e.type&&(0<e.deltaY?this.wheelDelta=1:0>e.deltaY&&(this.wheelDelta=-1))}function gr(e,t,i,s,n,r){mr.call(this,e,t,i),this.touches=e.touches,this.changedTouches=e.changedTouches,this.x=s,this.y=n,this.touch=r}function yr(e,t,i,s){mr.call(this,e,t,i),this.inputSource=s}function vr(e,t){this._app=null,this._attached=!1,this._target=null,this._enabled=!0,this._lastY=this._lastX=0,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._touchstartHandler=this._handleTouchStart.bind(this),this._touchcancelHandler=this._touchendHandler=this._handleTouchEnd.bind(this),this._touchmoveHandler=this._handleTouchMove.bind(this),this._sortHandler=this._sortElements.bind(this),this._elements=[],this._pressedElement=this._hoveredElement=null,this._touchedElements={},this._touchesForWhichTouchLeaveHasFired={},this._selectedElements={},this._selectedPressedElements={},this._useMouse=!t||!1!==t.useMouse,this._useTouch=!t||!1!==t.useTouch,this._useXr=!t||!1!==t.useXr,this._selectEventsAttached=!1,Vr.touch&&(this._clickedEntities={}),this.attach(e)}function br(){this.gamepadsSupported=!!navigator.getGamepads||!!navigator.webkitGetGamepads,this.current=[],this.previous=[],this.deadZone=.25}function xr(e){var t=wr(e);this.id=e.identifier,this.x=t.x,this.y=t.y,this.target=e.target,this.touch=e}function Sr(e,t){if(this.element=t.target,this.event=t,this.touches=[],this.changedTouches=[],t){var i=t.touches.length;for(e=0;e<i;e++)this.touches.push(new xr(t.touches[e]));for(i=t.changedTouches.length,e=0;e<i;e++)this.changedTouches.push(new xr(t.changedTouches[e]))}}function Tr(e){r.call(this),this._element=null,this._startHandler=this._handleTouchStart.bind(this),this._endHandler=this._handleTouchEnd.bind(this),this._moveHandler=this._handleTouchMove.bind(this),this._cancelHandler=this._handleTouchCancel.bind(this),this.attach(e)}function wr(e){for(var t=0,i=0,s=e.target;!(s instanceof HTMLElement);)s=s.parentNode;do{t+=s.offsetLeft-s.scrollLeft,i+=s.offsetTop-s.scrollTop,s=s.offsetParent}while(s);return{x:e.pageX-t,y:e.pageY-i}}function Mr(e,t){r.call(this),this.type="bitmap",this.app=e,this.intensity=0,t=t||{},this.fontWeight=t.fontWeight||"normal",this.glyphSize=this.fontSize=parseInt(t.fontSize,10),this.fontName=t.fontName||"Arial",this.color=t.color||new h(1,1,1),this.padding=t.padding||0,e=4096<t.width?4096:t.width||512;var i=4096<t.height?4096:t.height||512;(t=document.createElement("canvas")).height=i,t.width=e,(e=new K(this.app.graphicsDevice,{format:7,autoMipmap:!0})).name="font",e.setSource(t),e.minFilter=5,e.magFilter=1,e.addressU=1,e.addressV=1,this.textures=[e],this.chars="",this.data={}}function Pr(){}function Ar(e,t,i){(t=new K(t,{format:i,width:t.width,height:t.height})).name="posteffect-pass",t.minFilter=0,t.magFilter=0,t.addressU=1,t.addressV=1,vp[e]._colorBuffer=t}function Er(e){e=e.match(Ap)||[];for(var t,i,s=[],n=0;n<e.length;n++)t=e[n].search(Ep),i=e[n].search(Cp),"uColorBuffer"!==(t=e[n].substr(t,i-t))&&s.push(t);return s}function Cr(e,t){this.app=e,this.srcRenderTarget=t.srcRenderTarget,this.hdr=t.hdr,this.blending=t.blending,this.shader=t.shader,this.setup=t.setup;var i=this,s=e.graphicsDevice;if(this.layer=new Se({opaqueSortMode:0,transparentSortMode:0,passThrough:!0,name:t.name,onPostRender:function(){if(i.srcRenderTarget?(xp.x=i.srcRenderTarget.width,xp.y=i.srcRenderTarget.height,xp.z=1/i.srcRenderTarget.width,xp.w=1/i.srcRenderTarget.height):(xp.x=s.width,xp.y=s.height,xp.z=1/s.width,xp.w=1/s.height),Sp[0]=xp.x,Sp[1]=xp.y,Sp[2]=xp.z,Sp[3]=xp.w,yp.setValue(Sp),this._postEffectCombined&&0>this._postEffectCombined)i.setup&&i.setup(s,i,xp,null,this.renderTarget);else{var t=this._postEffectCombinedSrc?this._postEffectCombinedSrc:i.srcRenderTarget?i.srcRenderTarget:vp[this._backbufferRtId];1<t._samples&&t.resolve(!0,!1);var n=t._colorBuffer;if(n.magFilter=(this._postEffectCombinedShader?this._postEffectCombinedBilinear:this.postEffectBilinear)?1:0,bp.setValue(n),i.setup&&i.setup(s,i,xp,t,this.renderTarget),(t=this._postEffectCombinedShader?this._postEffectCombinedShader:this.shader)&&q(s,this.renderTarget,t,null,null,i.blending),!i.srcRenderTarget)for(t=e.scene.layers.layerList,n=0;n<t.length&&t[n]!==i.layer;n++)t[n].renderTarget!==vp[0]&&t[n].renderTarget!==vp[1]||(t[n].renderTarget=null)}}}),this.layer._generateCameraHash(),this.layer.isPostEffect=!0,this.layer.unmodifiedUvs=t.unmodifiedUvs,this.layer.postEffectBilinear=t.bilinear,this.layer.postEffect=this,this.layer.shader=t.shader,this.layer.renderTarget=t.destRenderTarget,!bp){bp=s.scope.resolve("uColorBuffer"),yp=s.scope.resolve("uScreenSize"),t=s.supportsMsaa?4:1;for(var n=0;2>n;n++)vp[n]=new Bu({depth:!0,stencil:s.supportsStencil,samples:t,autoResolve:!1}),vp[n].name="backbuffer"+n;e.on("prerender",function(){var t,i=e.scene.layers.layerList,n=0,r=0;Pp=Mp=wp=!1;var a=7;if(e.scene.layers._dirty){var o=0;for(t=0;t<i.length;t++){var h,l=!1;if((h=i[t].isPostEffect)&&!(h=0===o)&&(h=i[t].unmodifiedUvs&&i[t].shader)){e:{var c,d,u,p=i,f=Tp,m=o,_=Er(i[t].shader.definition.fshader);if(0!==_.length)for(u=0;u<m;u++)for(d=0;d<_.length;d++){h=_[d];var g=Er(p[f[u]].shader.definition.fshader);for(c=0;c<g.length;c++)if(g[c]===h){h=!0;break e}}h=!1}h=!h}if(h?(Tp[o]=t,o++,t===i.length-1&&(l=!0)):0<o&&(l=!0),l){if(1<o){for(h="post_",l=0;l<o;l++)h+=(g=i[Tp[l]]).name?g.name:g.id,l<o-1&&(h+="_");if(!(g=s.programLib._cache[h])){for(c="vec4 shaderOutput;\n",d="void main() {\n",u=[],l=0;l<o;l++){var y;g=(g=i[Tp[l]].shader.definition.fshader+"\n").replace(Lp,"//").replace(Fp,"//").replace(Bp,"//").replace(Np,"shaderOutput"),0<l&&(g=g.replace(kp,"//").replace(Up,"//").replace(zp,"shaderOutput;//")),f=u;var v=(_=g=g.replace(Vp,"void main"+l)).length,b=0,x=y=0;for(m="",p=0;p<v;p++){var S=_.charAt(p);"{"===S?(0===y&&(b=p),y++):"}"===S&&(1===y&&(S=p,m+=_.substr(x,b-x+1),x=S),y--)}for(b=null,x=(m+=_.substr(x,_.length-x+1)).match(Ip)||[],p=0;p<x.length;p++)for(_=x[p].split(","),v=0;v<_.length;v++)y=_[v].replace(Op,"").trim(),0<=f.indexOf(y)?(b||(b=[]),b.push(y)):f.push(y);for(m=m.match(Rp)||[],p=0;p<m.length;p++)for(_=m[p].split(","),v=0;v<_.length;v++)y=_[v].replace(Dp,"").trim(),0<=(y=f.indexOf(y))&&f.splice(y,1);if(p=b)for(f=0;f<p.length;f++)g=g.replace(new RegExp("\\b"+p[f]+"\\b","g"),p[f]+"NNNN"+l);c+=g,d+="main"+l+"();\n"}d+="gl_FragColor = shaderOutput;\n}\n",g=Ma.createShaderFromCode(s,Ma.fullscreenQuadVS,c+d,h)}for(l=0;l<o;l++)i[Tp[l]]._postEffectCombined=l===o-1?1:-1;i[Tp[o-1]]._postEffectCombinedShader=g,i[Tp[o-1]]._postEffectCombinedBilinear=i[Tp[0]].postEffectBilinear,i[Tp[o-1]]._postEffectCombinedSrc=i[Tp[0]].postEffect.srcRenderTarget}Tp[0]=t,o=1}}}for(t=0;t<i.length;t++){if(i[t].isPostEffect&&(!i[t].postEffect.srcRenderTarget&&!i[t]._postEffectCombined||!i[t].postEffect._postEffectCombinedSrc&&0<=i[t]._postEffectCombined)){for(l=t-1;l>=n;l--)i[l].renderTarget||(i[l].renderTarget=vp[r]);i[t]._backbufferRtId=r,n=t,wp=!0,1===r&&(Mp=!0),i[t].postEffect.hdr&&(a=s.webgl2&&s.textureFloatRenderable?18:s.extTextureHalfFloatLinear&&s.textureHalfFloatRenderable?12:7),i[t].postEffect.shader&&!i[t].renderTarget&&(r=1-r)}else i[t].isPostEffect||i[t].renderTarget||!wp||(i[t].renderTarget=vp[r]);i[t].isPostEffect&&!i[t].renderTarget&&(Pp=!0)}wp&&(vp[0].colorBuffer?vp[0].width===s.width&&vp[0].height===s.height&&vp[0]._colorBuffer._format===a||(vp[0].colorBuffer.destroy(),vp[0].destroy(),Ar(0,s,a)):Ar(0,s,a)),Mp&&(vp[1].colorBuffer?vp[1].width===s.width&&vp[1].height===s.height&&vp[1]._colorBuffer._format===a||(vp[1].colorBuffer.destroy(),vp[1].destroy(),Ar(1,s,a)):Ar(1,s,a))},this),e.on("postrender",function(){var t=e.graphicsDevice;if(wp&&!Pp){for(var i,s=e.scene.layers.layerList,n=s.length-1;0<=n&&((i=s[n].renderTarget)!==vp[0]&&i!==vp[1]);n--);i&&(1<i._samples&&i.resolve(!0,!1),t.copyRenderTarget(i,null,!0,!1))}},this)}}function Ir(e){this.name="UnsupportedBrowserError",this.message=e||""}function Or(e){this.name="ContextCreationError",this.message=e||""}Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(e,t){if(null==this)throw TypeError('"this" is null or not defined');var i=Object(this),s=i.length>>>0;if("function"!=typeof e)throw TypeError("predicate must be a function");for(var n=0;n<s;){var r=i[n];if(e.call(t,r,n,i))return r;n++}},configurable:!0,writable:!0}),Math.log2=Math.log2||function(e){return Math.log(e)*Math.LOG2E},Math.sign||(Math.sign=function(e){return(0<e)-(0>e)||+e}),"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(e,t){if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(e),s=1;s<arguments.length;s++){var n=arguments[s];if(null!=n)for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(i[r]=n[r])}return i},writable:!0,configurable:!0}),function(){if("undefined"!=typeof navigator&&"undefined"!=typeof document){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var e=function(){var e=document.createEvent("CustomEvent");e.initCustomEvent("pointerlockchange",!0,!1,null),document.dispatchEvent(e)},t=function(){var e=document.createEvent("CustomEvent");e.initCustomEvent("pointerlockerror",!0,!1,null),document.dispatchEvent(e)};document.addEventListener("webkitpointerlockchange",e,!1),document.addEventListener("webkitpointerlocklost",e,!1),document.addEventListener("mozpointerlockchange",e,!1),document.addEventListener("mozpointerlocklost",e,!1),document.addEventListener("webkitpointerlockerror",t,!1),document.addEventListener("mozpointerlockerror",t,!1),Element.prototype.requestPointerLock=Element.prototype.mozRequestPointerLock?function(){this.mozRequestPointerLock()}:Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock,!Element.prototype.requestPointerLock&&navigator.pointer&&(Element.prototype.requestPointerLock=function(){document.pointerLockElement=this,navigator.pointer.lock(this,e,t)}),document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock,document.exitPointerLock||(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=null,navigator.pointer.unlock())})}}(),function(){if("undefined"!=typeof window){for(var e=0,t=["ms","moz","webkit","o"],i=0;i<t.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[t[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[i]+"CancelAnimationFrame"]||window[t[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,i){var s=(new Date).getTime(),n=Math.max(0,16-(s-e));return i=window.setTimeout(function(){t(s+n)},n),e=s+n,i}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}}(),String.prototype.endsWith||(String.prototype.endsWith=function(e,t){return(void 0===t||t>this.length)&&(t=this.length),this.substring(t-e.length,t)===e}),String.prototype.includes||(String.prototype.includes=function(e,t){return"number"!=typeof t&&(t=0),!(t+e.length>this.length)&&-1!==this.indexOf(e,t)}),String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return this.substr(!t||0>t?0:+t,e.length)===e});var Rr,Dr,Lr,Fr,Br=function(){for(var e={},t="Array Object Function Date RegExp Float32Array".split(" "),i=0;i<t.length;i++)e["[object "+t[i]+"]"]=t[i].toLowerCase();return e}(),Nr=(Rr=null,Dr=null,Lr=null,Fr=null,{display:function(e){for(var t in Rr||(Rr=document.createElement("table"),Dr=document.createElement("tr"),Lr=document.createElement("td"),Fr=document.createElement("td"),Rr.style.cssText="position:absolute;font-family:sans-serif;font-size:12px;color:#cccccc",Rr.style.top="0px",Rr.style.left="0px",Rr.style.border="thin solid #cccccc",document.body.appendChild(Rr)),Rr.innerHTML="",e){var i=Dr.cloneNode(),s=Lr.cloneNode(),n=Fr.cloneNode();s.textContent=t,n.textContent=e[t],i.appendChild(s),i.appendChild(n),Rr.appendChild(i)}}});Object.assign(r.prototype,{_addCallback:function(e,t,i,s){e&&"string"==typeof e&&t&&(this._callbacks[e]||(this._callbacks[e]=[]),this._callbackActive[e]&&this._callbackActive[e]===this._callbacks[e]&&(this._callbackActive[e]=this._callbackActive[e].slice()),this._callbacks[e].push({callback:t,scope:i||this,once:s||!1}))},on:function(e,t,i){return this._addCallback(e,t,i,!1),this},off:function(e,t,i){if(e)this._callbackActive[e]&&this._callbackActive[e]===this._callbacks[e]&&(this._callbackActive[e]=this._callbackActive[e].slice());else for(var s in this._callbackActive)this._callbacks[s]&&this._callbacks[s]===this._callbackActive[s]&&(this._callbackActive[s]=this._callbackActive[s].slice());if(e)if(t){if(!(e=this._callbacks[e]))return this;s=e.length;for(var n=0;n<s;n++)e[n].callback===t&&(i&&e[n].scope!==i||(e[n--]=e[--s]));e.length=s}else this._callbacks[e]&&(this._callbacks[e]=[]);else this._callbacks={};return this},fire:function(e,t,i,s,n,r,a,o,h){if(!e||!this._callbacks[e])return this;if(this._callbackActive[e]){this._callbackActive[e]===this._callbacks[e]&&(this._callbackActive[e]=this._callbackActive[e].slice());var l=this._callbacks[e].slice()}else this._callbackActive[e]=this._callbacks[e];for(var c=0;(l||this._callbackActive[e])&&c<(l||this._callbackActive[e]).length;c++){var d=(l||this._callbackActive[e])[c];d.callback.call(d.scope,t,i,s,n,r,a,o,h),d.once&&(-1!==(d=this._callbacks[e].indexOf(d))&&(this._callbackActive[e]===this._callbacks[e]&&(this._callbackActive[e]=this._callbackActive[e].slice()),this._callbacks[e].splice(d,1)))}return l||(this._callbackActive[e]=null),this},once:function(e,t,i){return this._addCallback(e,t,i,!0),this},hasEvent:function(e){return this._callbacks[e]&&0!==this._callbacks[e].length||!1}});var kr={attach:function(e){var t=kr;return e._addCallback=t._addCallback,e.on=t.on,e.off=t.off,e.fire=t.fire,e.once=t.once,e.hasEvent=t.hasEvent,e._callbacks={},e._callbackActive={},e},_addCallback:r.prototype._addCallback,on:r.prototype.on,off:r.prototype.off,fire:r.prototype.fire,once:r.prototype.once,hasEvent:r.prototype.hasEvent},Ur={create:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}},zr={delimiter:"/",join:function(){var e,t=arguments.length,i=arguments[0];for(e=0;e<t-1;++e){var s=arguments[e],r=arguments[e+1];if(!n(s)||!n(r))throw Error("undefined argument to pc.path.join");i=r[0]===zr.delimiter?r:s&&r&&s[s.length-1]!==zr.delimiter&&r[0]!==zr.delimiter?i+(zr.delimiter+r):i+r}return i},normalize:function(e){var t=e.startsWith(zr.delimiter),i=e.endsWith(zr.delimiter);e=e.split("/");for(var s=[],n=0;n<e.length;n++)""!==e[n]&&"."!==e[n]&&(".."===e[n]&&0<s.length?s=s.slice(0,s.length-2):(0<n&&s.push(zr.delimiter),s.push(e[n])));return e=s.join(""),t||e[0]!==zr.delimiter||(e=e.slice(1)),i&&e[e.length-1]!==zr.delimiter&&(e+=zr.delimiter),e},split:function(e){var t=(e=e.split(zr.delimiter)).slice(e.length-1)[0];return[e.slice(0,e.length-1).join(zr.delimiter),t]},getBasename:function(e){return zr.split(e)[1]},getDirectory:function(e){return(e=e.split(zr.delimiter)).slice(0,e.length-1).join(zr.delimiter)},getExtension:function(e){var t=e.split("?")[0].split(".").pop();return t!==e?"."+t:""},isRelativePath:function(e){return"/"!==e.charAt(0)&&null===e.match(/:\/\//)},extractPath:function(e){var t="",i=e.split("/");if(1<i.length)if(zr.isRelativePath(e))if("."===i[0])for(e=0;e<i.length-1;++e)t+=0===e?i[e]:"/"+i[e];else if(".."===i[0])for(e=0;e<i.length-1;++e)t+=0===e?i[e]:"/"+i[e];else for(t=".",e=0;e<i.length-1;++e)t+="/"+i[e];else for(e=0;e<i.length-1;++e)t+=0===e?i[e]:"/"+i[e];return t}},Vr={desktop:!1,mobile:!1,ios:!1,android:!1,windows:!1,xbox:!1,gamepads:!1,touch:!1,workers:!1,passiveEvents:!1};if("undefined"!=typeof navigator){var Gr=navigator.userAgent;/(windows|mac os|linux|cros)/i.test(Gr)&&(Vr.desktop=!0),/xbox/i.test(Gr)&&(Vr.xbox=!0),/(windows phone|iemobile|wpdesktop)/i.test(Gr)?(Vr.desktop=!1,Vr.mobile=!0,Vr.windows=!0):/android/i.test(Gr)?(Vr.desktop=!1,Vr.mobile=!0,Vr.android=!0):/ip([ao]d|hone)/i.test(Gr)&&(Vr.desktop=!1,Vr.mobile=!0,Vr.ios=!0),"undefined"!=typeof window&&(Vr.touch="ontouchstart"in window||"maxTouchPoints"in navigator&&0<navigator.maxTouchPoints),Vr.gamepads="getGamepads"in navigator,Vr.workers="undefined"!=typeof Worker;try{var jr=Object.defineProperty({},"passive",{get:function(){return Vr.passiveEvents=!0,!1}});window.addEventListener("testpassive",null,jr),window.removeEventListener("testpassive",null,jr)}catch(Rr){}}var Wr={ASCII_LOWERCASE:"abcdefghijklmnopqrstuvwxyz",ASCII_UPPERCASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",ASCII_LETTERS:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",format:function(e){for(var t=1;t<arguments.length;t++)e=e.replace("{"+(t-1)+"}",arguments[t]);return e},toBool:function(e,t){if("true"===e)return!0;if(t){if("false"===e)return!1;throw new TypeError("Not a boolean string")}return!1},getCodePoint:function(e,t){return(e=a(e,t))&&e.code},getCodePoints:function(e){if("string"!=typeof e)throw new TypeError("Not a string");for(var t,i=0,s=[];t=a(e,i);)s.push(t.code),i+=t.long?2:1;return s},getSymbols:function(e){if("string"!=typeof e)throw new TypeError("Not a string");for(var t,i=0,s=e.length,n=[],r=0;i<s;){t=r;var a=e,h=i+r;h===a.length-1?r=1:o(a[h],55296,56319)?(r=a.substring(h,h+2),r=o(a=a.substring(h+2,h+4),127995,127999)||o(r,127462,127487)&&o(a,127462,127487)?4:o(a,65024,65039)?3:2):r=o(a[h+1],65024,65039)?2:1,o(t=e[i+(r=t+r)],8400,8447)&&(t=e[i+r++]),o(t,65024,65039)&&(t=e[i+r++]),t&&8205===t.charCodeAt(0)?r++:(t=e.substring(i,i+r),n.push(t),i+=r,r=0)}return n},fromCodePoint:function(){for(var e,t,i=[],s=0;s<arguments.length;++s)t=(e=Number(arguments[s]))-65536,e=65535<e?[55296+(t>>10),t%1024+56320]:[e],i.push(String.fromCharCode.apply(null,e));return i.join("")}},Hr={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(e,t,i){return e>=i?i:e<=t?t:e},intToBytes24:function(e){return[e>>16&255,e>>8&255,255&e]},intToBytes32:function(e){return[e>>24&255,e>>16&255,e>>8&255,255&e]},bytesToInt24:function(e,t,i){return e.length&&(i=e[2],t=e[1],e=e[0]),e<<16|t<<8|i},bytesToInt32:function(e,t,i,s){return e.length&&(s=e[3],i=e[2],t=e[1],e=e[0]),(e<<24|t<<16|i<<8|s)>>>32},lerp:function(e,t,i){return e+(t-e)*Hr.clamp(i,0,1)},lerpAngle:function(e,t,i){return 180<t-e&&(t-=360),-180>t-e&&(t+=360),pc.math.lerp(e,t,Hr.clamp(i,0,1))},powerOfTwo:function(e){return 0!==e&&!(e&e-1)},nextPowerOfTwo:function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},random:function(e,t){return Math.random()*(t-e)+e},smoothstep:function(e,t,i){return i<=e?0:i>=t?1:(i=(i-e)/(t-e))*i*(3-2*i)},smootherstep:function(e,t,i){return i<=e?0:i>=t?1:(i=(i-e)/(t-e))*i*i*(i*(6*i-15)+10)},roundUp:function(e,t){return 0===t?e:Math.ceil(e/t)*t},float2Half:function(){var e=new Float32Array(1),t=new Int32Array(e.buffer);return function(i){e[0]=i;var s=(i=t[0])>>16&32768,n=i>>12&2047,r=i>>23&255;return 103>r?s:142<r?31744|s|((255==r?0:1)&&8388607&i):113>r?s|((n|=2048)>>114-r)+(n>>113-r&1):s=(s|r-112<<10|n>>1)+(1&n)}}()};Object.assign(h.prototype,{clone:function(){return new h(this.r,this.g,this.b,this.a)},copy:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this},equals:function(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a},set:function(e,t,i,s){return this.r=e,this.g=t,this.b=i,this.a=void 0===s?1:s,this},lerp:function(e,t,i){return this.r=e.r+i*(t.r-e.r),this.g=e.g+i*(t.g-e.g),this.b=e.b+i*(t.b-e.b),this.a=e.a+i*(t.a-e.a),this},fromString:function(e){var t=parseInt(e.replace("#","0x"),16);return 7<e.length?e=Hr.intToBytes32(t):(e=Hr.intToBytes24(t))[3]=255,this.set(e[0]/255,e[1]/255,e[2]/255,e[3]/255),this},toString:function(e){var t="#"+(16777216+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1);return!0===e&&(e=Math.round(255*this.a).toString(16),t=this.a<16/255?t+"0"+e:t+e),t}}),Object.assign(l.prototype,{push:function(e,t){if(this._index[e])throw Error("Key already in index "+e);t=this._list.push(t)-1,this._index[e]=t},has:function(e){return void 0!==this._index[e]},get:function(e){return void 0!==(e=this._index[e])?this._list[e]:null},remove:function(e){var t=this._index[e];if(void 0!==t){for(e in this._list.splice(t,1),delete this._index[e],this._index){var i=this._index[e];i>t&&(this._index[e]=i-1)}return!0}return!1},list:function(){return this._list},clear:function(){for(var e in this._list.length=0,this._index)delete this._index[e]}}),Object.assign(c.prototype,{addItem:function(e){for(var t=e.tags._list,i=0;i<t.length;i++)this.add(t[i],e)},removeItem:function(e){for(var t=e.tags._list,i=0;i<t.length;i++)this.remove(t[i],e)},add:function(e,t){this._index[e]&&-1!==this._index[e].list.indexOf(t)||(this._index[e]||(this._index[e]={list:[]},this._key&&(this._index[e].keys={})),this._index[e].list.push(t),this._key&&(this._index[e].keys[t[this._key]]=t))},remove:function(e,t){if(this._index[e]&&(!this._key||this._index[e].keys[t[this._key]])){var i=this._index[e].indexOf(t);-1!==i&&(this._index[e].list.splice(i,1),this._key&&delete this._index[e].keys[t[this._key]],0===this._index[e].list.length&&delete this._index[e])}},find:function(e){var t,i,s=this,n={},r=[],a=function(e,t){return s._index[e].list.length-s._index[t].list.length};for(t=0;t<e.length;t++){var o=e[t];if(o instanceof Array){if(0===o.length)continue;if(1!==o.length){var h=!1;for(i=0;i<o.length;i++)if(!this._index[o[i]]){h=!0;break}if(h)continue;var l=(o=o.slice(0).sort(a)).slice(1);for(1===l.length&&(l=l[0]),i=0;i<this._index[o[0]].list.length;i++)h=this._index[o[0]].list[i],(this._key?!n[h[this._key]]:-1===r.indexOf(h))&&h.tags.has(l)&&(this._key&&(n[h[this._key]]=!0),r.push(h));continue}o=o[0]}if(o&&"string"==typeof o&&this._index[o])for(i=0;i<this._index[o].list.length;i++)h=this._index[o].list[i],this._key?n[h[this._key]]||(n[h[this._key]]=!0,r.push(h)):-1===r.indexOf(h)&&r.push(h)}return r}}),d.prototype=Object.create(r.prototype),d.prototype.constructor=d,Object.assign(d.prototype,{add:function(){var e=!1,t=this._processArguments(arguments,!0);if(!t.length)return e;for(var i=0;i<t.length;i++)this._index[t[i]]||(e=!0,this._index[t[i]]=!0,this._list.push(t[i]),this.fire("add",t[i],this._parent));return e&&this.fire("change",this._parent),e},remove:function(){var e=!1;if(!this._list.length)return e;var t=this._processArguments(arguments,!0);if(!t.length)return e;for(var i=0;i<t.length;i++)this._index[t[i]]&&(e=!0,delete this._index[t[i]],this._list.splice(this._list.indexOf(t[i]),1),this.fire("remove",t[i],this._parent));return e&&this.fire("change",this._parent),e},clear:function(){if(this._list.length){var e=this._list.slice(0);this._list=[],this._index={};for(var t=0;t<e.length;t++)this.fire("remove",e[t],this._parent);this.fire("change",this._parent)}},has:function(){return!!this._list.length&&this._has(this._processArguments(arguments))},_has:function(e){if(!this._list.length||!e.length)return!1;for(var t=0;t<e.length;t++)if(1===e[t].length){if(this._index[e[t][0]])return!0}else{for(var i=!0,s=0;s<e[t].length;s++)if(!this._index[e[t][s]]){i=!1;break}if(i)return!0}return!1},list:function(){return this._list.slice(0)},_processArguments:function(e,t){var i=[],s=[];if(!e||!e.length)return i;for(var n=0;n<e.length;n++)if(e[n]instanceof Array){t||(s=[]);for(var r=0;r<e[n].length;r++)"string"==typeof e[n][r]&&(t?i.push(e[n][r]):s.push(e[n][r]));!t&&s.length&&i.push(s)}else"string"==typeof e[n]&&(t?i.push(e[n]):i.push([e[n]]));return i}}),Object.defineProperty(d.prototype,"size",{get:function(){return this._list.length}});var Xr="undefined"!=typeof window&&window.performance&&window.performance.now&&window.performance.timing?function(){return window.performance.now()}:Date.now;Object.assign(u.prototype,{start:function(){this._isRunning=!0,this._a=Xr()},stop:function(){this._isRunning=!1,this._b=Xr()},getMilliseconds:function(){return this._b-this._a}}),f.ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",JPEG:"image/jpeg",DDS:"image/dds",JSON:"application/json",PNG:"image/png",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",MP4:"audio/mp4",AAC:"audio/aac",BIN:"application/octet-stream",BASIS:"image/basis",GLB:"model/gltf-binary"},f.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"},f.binaryExtensions=".model .wav .ogg .mp3 .mp4 .m4a .aac .dds .basis .glb".split(" "),f.retryDelay=100,Object.assign(f.prototype,{ContentType:f.ContentType,ResponseType:f.ResponseType,binaryExtensions:f.binaryExtensions,get:function(e,t,i){return"function"==typeof t&&(i=t,t={}),this.request("GET",e,t,i)},post:function(e,t,i,s){return"function"==typeof i&&(s=i,i={}),i.postdata=t,this.request("POST",e,i,s)},put:function(e,t,i,s){return"function"==typeof i&&(s=i,i={}),i.postdata=t,this.request("PUT",e,i,s)},del:function(e,t,i){return"function"==typeof t&&(i=t,t={}),this.request("DELETE",e,t,i)},request:function(e,t,i,n){var r=!1;if("function"==typeof i&&(n=i,i={}),i.retry&&(i=Object.assign({retries:0,maxRetries:5},i)),i.callback=n,null==i.async&&(i.async=!0),null==i.headers&&(i.headers={}),null!=i.postdata)if(i.postdata instanceof Document)var a=i.postdata;else if(i.postdata instanceof FormData)a=i.postdata;else if(i.postdata instanceof Object)switch(a=i.headers["Content-Type"],void 0===a&&(i.headers["Content-Type"]=f.ContentType.FORM_URLENCODED,a=i.headers["Content-Type"]),a){case f.ContentType.FORM_URLENCODED:for(o in a="",n=!0,i.postdata)i.postdata.hasOwnProperty(o)&&(n?n=!1:a+="&",a+=escape(o)+"="+escape(i.postdata[o]));break;default:case f.ContentType.JSON:null==a&&(i.headers["Content-Type"]=f.ContentType.JSON),a=JSON.stringify(i.postdata)}else a=i.postdata;if(!1===i.cache){n=Xr();var o=new p(t);o.query=o.query?o.query+"&ts="+n:"ts="+n,t=o.toString()}i.query&&(n=s((o=new p(t)).getQuery(),i.query),o.setQuery(n),t=o.toString());var h=new XMLHttpRequest;for(var l in h.open(e,t,i.async),h.withCredentials=void 0!==i.withCredentials&&i.withCredentials,h.responseType=i.responseType||this._guessResponseType(t),i.headers)i.headers.hasOwnProperty(l)&&h.setRequestHeader(l,i.headers[l]);h.onreadystatechange=function(){this._onReadyStateChange(e,t,i,h)}.bind(this),h.onerror=function(){this._onError(e,t,i,h),r=!0}.bind(this);try{h.send(a)}catch(e){r||i.error(h.status,h,e)}return h},_guessResponseType:function(e){return e=new p(e),e=zr.getExtension(e.path),0<=f.binaryExtensions.indexOf(e)?f.ResponseType.ARRAY_BUFFER:".xml"===e?f.ResponseType.DOCUMENT:f.ResponseType.TEXT},_isBinaryContentType:function(e){return 0<=[f.ContentType.MP4,f.ContentType.WAV,f.ContentType.OGG,f.ContentType.MP3,f.ContentType.BIN,f.ContentType.DDS,f.ContentType.BASIS,f.ContentType.GLB].indexOf(e)},_onReadyStateChange:function(e,t,i,s){if(4===s.readyState)switch(s.status){case 0:"/"!=t[0]?this._onSuccess(e,t,i,s):this._onError(e,t,i,s);break;case 200:case 201:case 206:case 304:this._onSuccess(e,t,i,s);break;default:this._onError(e,t,i,s)}},_onSuccess:function(e,t,i,s){if(e=s.getResponseHeader("Content-Type")){var n=e.split(";");n=n[0].trim()}try{if(n===this.ContentType.JSON||t.split("?")[0].endsWith(".json"))var r=JSON.parse(s.responseText);else this._isBinaryContentType(n)?r=s.response:(n&&console.warn("responseType: "+s.responseType+" being served with Content-Type: "+n),r=s.responseType===f.ResponseType.ARRAY_BUFFER?s.response:s.responseType===f.ResponseType.BLOB||s.responseType===f.ResponseType.JSON?s.response:s.responseType===f.ResponseType.DOCUMENT||n===this.ContentType.XML?s.responseXML:s.responseText);i.callback(null,r)}catch(e){i.callback(e)}},_onError:function(e,t,i,s){if(!i.retrying)if(i.retry&&i.retries<i.maxRetries){i.retries++,i.retrying=!0;var n=Hr.clamp(Math.pow(2,i.retries)*f.retryDelay,0,i.maxRetryDelay||5e3);console.log(e+": "+t+" - Error "+s.status+". Retrying in "+n+" ms"),setTimeout(function(){i.retrying=!1,this.request(e,t,i,i.callback)}.bind(this),n)}else i.callback(0===s.status?"Network error":s.status,null)}});var qr=new f;Object.assign(m.prototype,{evaluate:function(e,t){return(t||e<this._left||e>=this._right)&&this._reset(e),5===(t=this._curve.type)?e=this._p0:(e=0===this._recip?0:(e-this._left)*this._recip,e=0===t?pc.math.lerp(this._p0,this._p1,e):1===t?pc.math.lerp(this._p0,this._p1,e*e*(3-2*e)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,e)),e},_reset:function(e){var t=this._curve.keys,i=t.length;if(i)if(e<t[0][0])this._left=-1/0,this._right=t[0][0],this._recip=0,this._p0=this._p1=t[0][1],this._m0=this._m1=0;else if(e>=t[i-1][0])this._left=t[i-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=t[i-1][1],this._m0=this._m1=0;else{for(i=0;e>=t[i+1][0];)i++;this._left=t[i][0],this._right=t[i+1][0],e=1/(this._right-this._left),this._recip=isFinite(e)?e:0,this._p0=t[i][1],this._p1=t[i+1][1],this._isHermite()&&this._calcTangents(t,i)}else this._left=-1/0,this._right=1/0,this._p0=this._p1=this._m0=this._m1=this._recip=0},_isHermite:function(){return 2===this._curve.type||3===this._curve.type||4===this._curve.type},_calcTangents:function(e,t){var i=e[t],s=e[t+1],n=0===t?[e[0][0]+(e[0][0]-e[1][0]),e[0][1]+(e[0][1]-e[1][1])]:e[t-1];if(e=t==e.length-2?[e[t+1][0]+(e[t+1][0]-e[t][0]),e[t+1][1]+(e[t+1][1]-e[t][1])]:e[t+2],4===this._curve.type){t=2*(s[0]-i[0])/(s[0]-n[0]);var r=2*(s[0]-i[0])/(e[0]-i[0]);this._m0=this._curve.tension*(isFinite(t)?t:0)*(s[1]-n[1]),this._m1=this._curve.tension*(isFinite(r)?r:0)*(e[1]-i[1])}else r=(s[0]-i[0])/(i[0]-n[0]),t=(s[0]-i[0])/(e[0]-s[0]),n=i[1]+(n[1]-i[1])*(isFinite(r)?r:0),e=s[1]+(e[1]-s[1])*(isFinite(t)?t:0),t=2===this._curve.type?.5:this._curve.tension,this._m0=t*(s[1]-n),this._m1=t*(e-i[1])},_evaluateHermite:function(e,t,i,s,n){var r=n*n,a=n+n,o=1-n;return e*(1+a)*(o*=o)+i*n*o+t*r*(3-a)+s*r*(n-1)}}),Object.assign(_.prototype,{add:function(e,t){for(var i=this.keys,s=i.length,n=0;n<s&&!(i[n][0]>e);n++);return e=[e,t],this.keys.splice(n,0,e),e},get:function(e){return this.keys[e]},sort:function(){this.keys.sort(function(e,t){return e[0]-t[0]})},value:function(e){return this._eval.evaluate(e,!0)},closest:function(e){for(var t=this.keys,i=t.length,s=2,n=null,r=0;r<i;r++){var a=Math.abs(e-t[r][0]);if(!(s>=a))break;s=a,n=t[r]}return n},clone:function(){var e=new _;return e.keys=pc.extend(e.keys,this.keys),e.type=this.type,e.tension=this.tension,e},quantize:function(e){e=Math.max(e,2);var t=new Float32Array(e),i=1/(e-1);t[0]=this._eval.evaluate(0,!0);for(var s=1;s<e;s++)t[s]=this._eval.evaluate(i*s);return t},quantizeClamped:function(e,t,i){e=this.quantize(e);for(var s=0;s<e.length;++s)e[s]=Math.min(i,Math.max(t,e[s]));return e}}),Object.defineProperty(_.prototype,"length",{get:function(){return this.keys.length}}),Object.assign(g.prototype,{get:function(e){return this.curves[e]},value:function(e,t){var i=this.curves.length;(t=t||[]).length=i;for(var s=0;s<i;s++)t[s]=this.curves[s].value(e);return t},clone:function(){var e=new g;e.curves=[];for(var t=0;t<this.curves.length;t++)e.curves.push(this.curves[t].clone());return e._type=this._type,e},quantize:function(e){e=Math.max(e,2);for(var t=this.curves.length,i=new Float32Array(e*t),s=1/(e-1),n=0;n<t;n++)for(var r=new m(this.curves[n]),a=0;a<e;a++)i[a*t+n]=r.evaluate(s*a);return i},quantizeClamped:function(e,t,i){e=this.quantize(e);for(var s=0;s<e.length;++s)e[s]=Math.min(i,Math.max(t,e[s]));return e}}),Object.defineProperty(g.prototype,"length",{get:function(){return this.curves.length}}),Object.defineProperty(g.prototype,"type",{get:function(){return this._type},set:function(e){this._type=e;for(var t=0;t<this.curves.length;t++)this.curves[t].type=e}}),Object.assign(y.prototype,{clone:function(){return(new y).copy(this)},copy:function(e){e=e.data;var t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],this},set:function(e){var t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],this},equals:function(e){var t=this.data;return e=e.data,t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]},isIdentity:function(){var e=this.data;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&1===e[4]&&0===e[5]&&0===e[6]&&0===e[7]&&1===e[8]},setIdentity:function(){var e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this},toString:function(){for(var e="[",t=0;9>t;t++)e+=this.data[t],e+=8!==t?", ":"";return e+"]"},transpose:function(){var e=this.data,t=e[1];return e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}}),Object.defineProperties(y,{ZERO:{value:(new y).set([0,0,0,0,0,0,0,0,0])},IDENTITY:{value:new y}}),Object.assign(v.prototype,{add:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},add2:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this},clone:function(){return(new v).copy(this)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},cross:function(e,t){var i=e.x,s=e.y;e=e.z;var n=t.x,r=t.y;return t=t.z,this.x=s*t-r*e,this.y=e*n-t*i,this.z=i*r-n*s,this},distance:function(e){var t=this.x-e.x,i=this.y-e.y;return e=this.z-e.z,Math.sqrt(t*t+i*i+e*e)},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},equals:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},lerp:function(e,t,i){return this.x=e.x+i*(t.x-e.x),this.y=e.y+i*(t.y-e.y),this.z=e.z+i*(t.z-e.z),this},mul:function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this},mul2:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this},normalize:function(){var e=this.x*this.x+this.y*this.y+this.z*this.z;return 0<e&&(e=1/Math.sqrt(e),this.x*=e,this.y*=e,this.z*=e),this},project:function(e){var t=(this.x*e.x+this.y*e.y+this.z*e.z)/(e.x*e.x+e.y*e.y+e.z*e.z);return this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this},scale:function(e){return this.x*=e,this.y*=e,this.z*=e,this},set:function(e,t,i){return this.x=e,this.y=t,this.z=i,this},sub:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},sub2:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},toString:function(){return"["+this.x+", "+this.y+", "+this.z+"]"}}),Object.defineProperties(v,{ZERO:{value:new v(0,0,0)},ONE:{value:new v(1,1,1)},UP:{value:new v(0,1,0)},DOWN:{value:new v(0,-1,0)},RIGHT:{value:new v(1,0,0)},LEFT:{value:new v(-1,0,0)},FORWARD:{value:new v(0,0,-1)},BACK:{value:new v(0,0,1)}}),Object.assign(b.prototype,{add:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},add2:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this},clone:function(){return(new b).copy(this)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},equals:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},lerp:function(e,t,i){return this.x=e.x+i*(t.x-e.x),this.y=e.y+i*(t.y-e.y),this.z=e.z+i*(t.z-e.z),this.w=e.w+i*(t.w-e.w),this},mul:function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},mul2:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this.w=e.w*t.w,this},normalize:function(){var e=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;return 0<e&&(e=1/Math.sqrt(e),this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},scale:function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},set:function(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this},sub:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},sub2:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this},toString:function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}}),Object.defineProperties(b,{ZERO:{value:new b(0,0,0,0)},ONE:{value:new b(1,1,1,1)}}),Object.assign(x.prototype,{add2:function(e,t){e=e.data,t=t.data;var i=this.data;return i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3]+t[3],i[4]=e[4]+t[4],i[5]=e[5]+t[5],i[6]=e[6]+t[6],i[7]=e[7]+t[7],i[8]=e[8]+t[8],i[9]=e[9]+t[9],i[10]=e[10]+t[10],i[11]=e[11]+t[11],i[12]=e[12]+t[12],i[13]=e[13]+t[13],i[14]=e[14]+t[14],i[15]=e[15]+t[15],this},add:function(e){return this.add2(this,e)},clone:function(){return(new x).copy(this)},copy:function(e){e=e.data;var t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this},equals:function(e){var t=this.data;return e=e.data,t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]},isIdentity:function(){var e=this.data;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]},mul2:function(e,t){var i=e.data,s=t.data,n=this.data;t=i[0],e=i[1];var r=i[2],a=i[3],o=i[4],h=i[5],l=i[6],c=i[7],d=i[8],u=i[9],p=i[10],f=i[11],m=i[12],_=i[13],g=i[14];i=i[15];var y=s[0],v=s[1],b=s[2],x=s[3];return n[0]=t*y+o*v+d*b+m*x,n[1]=e*y+h*v+u*b+_*x,n[2]=r*y+l*v+p*b+g*x,n[3]=a*y+c*v+f*b+i*x,y=s[4],v=s[5],b=s[6],x=s[7],n[4]=t*y+o*v+d*b+m*x,n[5]=e*y+h*v+u*b+_*x,n[6]=r*y+l*v+p*b+g*x,n[7]=a*y+c*v+f*b+i*x,y=s[8],v=s[9],b=s[10],x=s[11],n[8]=t*y+o*v+d*b+m*x,n[9]=e*y+h*v+u*b+_*x,n[10]=r*y+l*v+p*b+g*x,n[11]=a*y+c*v+f*b+i*x,y=s[12],v=s[13],b=s[14],x=s[15],n[12]=t*y+o*v+d*b+m*x,n[13]=e*y+h*v+u*b+_*x,n[14]=r*y+l*v+p*b+g*x,n[15]=a*y+c*v+f*b+i*x,this},mul:function(e){return this.mul2(this,e)},transformPoint:function(e,t){var i=this.data,s=e.x,n=e.y;return e=e.z,(t=void 0===t?new v:t).x=s*i[0]+n*i[4]+e*i[8]+i[12],t.y=s*i[1]+n*i[5]+e*i[9]+i[13],t.z=s*i[2]+n*i[6]+e*i[10]+i[14],t},transformVector:function(e,t){var i=this.data,s=e.x,n=e.y;return e=e.z,(t=void 0===t?new v:t).x=s*i[0]+n*i[4]+e*i[8],t.y=s*i[1]+n*i[5]+e*i[9],t.z=s*i[2]+n*i[6]+e*i[10],t},transformVec4:function(e,t){var i=this.data,s=e.x,n=e.y,r=e.z;return e=e.w,(t=void 0===t?new b:t).x=s*i[0]+n*i[4]+r*i[8]+e*i[12],t.y=s*i[1]+n*i[5]+r*i[9]+e*i[13],t.z=s*i[2]+n*i[6]+r*i[10]+e*i[14],t.w=s*i[3]+n*i[7]+r*i[11]+e*i[15],t},setLookAt:function(){var e=new v,t=new v,i=new v;return function(s,n,r){return i.sub2(s,n).normalize(),t.copy(r).normalize(),e.cross(t,i).normalize(),t.cross(i,e),(n=this.data)[0]=e.x,n[1]=e.y,n[2]=e.z,n[3]=0,n[4]=t.x,n[5]=t.y,n[6]=t.z,n[7]=0,n[8]=i.x,n[9]=i.y,n[10]=i.z,n[11]=0,n[12]=s.x,n[13]=s.y,n[14]=s.z,n[15]=1,this}}(),setFrustum:function(e,t,i,s,n,r){var a=2*n,o=t-e,h=s-i,l=r-n,c=this.data;return c[0]=a/o,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=a/h,c[6]=0,c[7]=0,c[8]=(t+e)/o,c[9]=(s+i)/h,c[10]=(-r-n)/l,c[11]=-1,c[12]=0,c[13]=0,c[14]=-a*r/l,c[15]=0,this},setPerspective:function(e,t,i,s,n){return n?n=(e=i*Math.tan(e*Math.PI/360))/t:e=(n=i*Math.tan(e*Math.PI/360))*t,this.setFrustum(-e,e,-n,n,i,s)},setOrtho:function(e,t,i,s,n,r){var a=this.data;return a[0]=2/(t-e),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(s-i),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/(r-n),a[11]=0,a[12]=-(t+e)/(t-e),a[13]=-(s+i)/(s-i),a[14]=-(r+n)/(r-n),a[15]=1,this},setFromAxisAngle:function(e,t){t*=pc.math.DEG_TO_RAD;var i=e.x,s=e.y;e=e.z;var n=Math.cos(t);t=Math.sin(t);var r=1-n,a=r*i,o=r*s,h=this.data;return h[0]=a*i+n,h[1]=a*s+t*e,h[2]=a*e-t*s,h[3]=0,h[4]=a*s-t*e,h[5]=o*s+n,h[6]=o*e+t*i,h[7]=0,h[8]=a*e+t*s,h[9]=o*e-i*t,h[10]=r*e*e+n,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,this},setTranslate:function(e,t,i){var s=this.data;return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=e,s[13]=t,s[14]=i,s[15]=1,this},setScale:function(e,t,i){var s=this.data;return s[0]=e,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=t,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=i,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,this},invert:function(){var e=this.data,t=e[0],i=e[1],s=e[2],n=e[3],r=e[4],a=e[5],o=e[6],h=e[7],l=e[8],c=e[9],d=e[10],u=e[11],p=e[12],f=e[13],m=e[14],_=e[15],g=t*a-i*r,y=t*o-s*r,v=t*h-n*r,b=i*o-s*a,x=i*h-n*a,S=s*h-n*o,T=l*f-c*p,w=l*m-d*p,M=l*_-u*p,P=c*m-d*f,A=c*_-u*f,E=d*_-u*m,C=g*E-y*A+v*P+b*M-x*w+S*T;return 0===C?this.setIdentity():(C=1/C,e[0]=(a*E-o*A+h*P)*C,e[1]=(-i*E+s*A-n*P)*C,e[2]=(f*S-m*x+_*b)*C,e[3]=(-c*S+d*x-u*b)*C,e[4]=(-r*E+o*M-h*w)*C,e[5]=(t*E-s*M+n*w)*C,e[6]=(-p*S+m*v-_*y)*C,e[7]=(l*S-d*v+u*y)*C,e[8]=(r*A-a*M+h*T)*C,e[9]=(-t*A+i*M-n*T)*C,e[10]=(p*x-f*v+_*g)*C,e[11]=(-l*x+c*v-u*g)*C,e[12]=(-r*P+a*w-o*T)*C,e[13]=(t*P-i*w+s*T)*C,e[14]=(-p*b+f*y-m*g)*C,e[15]=(l*b-c*y+d*g)*C),this},set:function(e){var t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this},setIdentity:function(){var e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},setTRS:function(e,t,i){var s=e.x,n=e.y;e=e.z;var r=t.x,a=t.y,o=t.z,h=t.w;t=i.x;var l=i.y;i=i.z;var c=r+r,d=a+a,u=o+o,p=r*c,f=r*d;r*=u;var m=a*d;return a*=u,o*=u,c*=h,d*=h,h*=u,(u=this.data)[0]=(1-(m+o))*t,u[1]=(f+h)*t,u[2]=(r-d)*t,u[3]=0,u[4]=(f-h)*l,u[5]=(1-(p+o))*l,u[6]=(a+c)*l,u[7]=0,u[8]=(r+d)*i,u[9]=(a-c)*i,u[10]=(1-(p+m))*i,u[11]=0,u[12]=s,u[13]=n,u[14]=e,u[15]=1,this},transpose:function(){var e=this.data,t=e[1];return e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},invertTo3x3:function(e){var t=this.data;e=e.data;var i=t[0],s=t[1],n=t[2],r=t[4],a=t[5],o=t[6],h=t[8],l=t[9],c=t[10],d=-c*r+o*h,u=l*r-a*h,p=i*(t=c*a-o*l)+s*d+n*u;return 0===p?this:(p=1/p,e[0]=p*t,e[1]=p*(-c*s+n*l),e[2]=p*(o*s-n*a),e[3]=p*d,e[4]=p*(c*i-n*h),e[5]=p*(-o*i+n*r),e[6]=p*u,e[7]=p*(-l*i+s*h),e[8]=p*(a*i-s*r),this)},getTranslation:function(e){return(e=void 0===e?new v:e).set(this.data[12],this.data[13],this.data[14])},getX:function(e){return(e=void 0===e?new v:e).set(this.data[0],this.data[1],this.data[2])},getY:function(e){return(e=void 0===e?new v:e).set(this.data[4],this.data[5],this.data[6])},getZ:function(e){return(e=void 0===e?new v:e).set(this.data[8],this.data[9],this.data[10])},getScale:function(){var e=new v,t=new v,i=new v;return function(s){return s=void 0===s?new v:s,this.getX(e),this.getY(t),this.getZ(i),s.set(e.length(),t.length(),i.length()),s}}(),setFromEulerAngles:function(e,t,i){e*=pc.math.DEG_TO_RAD,t*=pc.math.DEG_TO_RAD,i*=pc.math.DEG_TO_RAD;var s=Math.sin(-e);e=Math.cos(-e);var n=Math.sin(-t);t=Math.cos(-t);var r=Math.sin(-i);i=Math.cos(-i);var a=this.data;return a[0]=t*i,a[1]=-t*r,a[2]=n,a[3]=0,a[4]=e*r+i*s*n,a[5]=e*i-s*n*r,a[6]=-t*s,a[7]=0,a[8]=s*r-e*i*n,a[9]=i*s+e*n*r,a[10]=e*t,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,this},getEulerAngles:function(){var e=new v;return function(t){t=void 0===t?new v:t,this.getScale(e);var i=e.x,s=e.y,n=e.z,r=this.data,a=Math.asin(-r[2]/i),o=.5*Math.PI;return a<o?a>-o?(s=Math.atan2(r[6]/s,r[10]/n),i=Math.atan2(r[1]/i,r[0]/i)):(i=0,s=-Math.atan2(r[4]/s,r[5]/s)):(i=0,s=Math.atan2(r[4]/s,r[5]/s)),t.set(s,a,i).scale(pc.math.RAD_TO_DEG)}}(),toString:function(){var e,t="[";for(e=0;16>e;e+=1)t+=this.data[e],t+=15!==e?", ":"";return t+"]"}}),Object.defineProperties(x,{ZERO:{value:(new x).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])},IDENTITY:{value:new x}}),Object.assign(S.prototype,{clone:function(){return new S(this.x,this.y,this.z,this.w)},conjugate:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},equals:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},getAxisAngle:function(e){var t=2*Math.acos(this.w),i=Math.sin(t/2);return 0!==i?(e.x=this.x/i,e.y=this.y/i,e.z=this.z/i,(0>e.x||0>e.y||0>e.z)&&(e.x*=-1,e.y*=-1,e.z*=-1,t*=-1)):(e.x=1,e.y=0,e.z=0),t*Hr.RAD_TO_DEG},getEulerAngles:function(e){e=void 0===e?new v:e;var t=this.x,i=this.y,s=this.z,n=this.w,r=2*(n*i-t*s);if(-.99999>=r){var a=2*Math.atan2(t,n);r=-Math.PI/2,t=0}else.99999<=r?(a=2*Math.atan2(t,n),r=Math.PI/2,t=0):(a=Math.atan2(2*(n*t+i*s),1-2*(t*t+i*i)),r=Math.asin(r),t=Math.atan2(2*(n*s+t*i),1-2*(i*i+s*s)));return e.set(a,r,t).scale(Hr.RAD_TO_DEG)},invert:function(){return this.conjugate().normalize()},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},mul:function(e){var t=this.x,i=this.y,s=this.z,n=this.w,r=e.x,a=e.y,o=e.z;return e=e.w,this.x=n*r+t*e+i*o-s*a,this.y=n*a+i*e+s*r-t*o,this.z=n*o+s*e+t*a-i*r,this.w=n*e-t*r-i*a-s*o,this},mul2:function(e,t){var i=e.x,s=e.y,n=e.z;e=e.w;var r=t.x,a=t.y,o=t.z;return t=t.w,this.x=e*r+i*t+s*o-n*a,this.y=e*a+s*t+n*r-i*o,this.z=e*o+n*t+i*a-s*r,this.w=e*t-i*r-s*a-n*o,this},normalize:function(){var e=this.length();return 0===e?(this.x=this.y=this.z=0,this.w=1):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},set:function(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this},setFromAxisAngle:function(e,t){t*=.5*Hr.DEG_TO_RAD;var i=Math.sin(t);return t=Math.cos(t),this.x=i*e.x,this.y=i*e.y,this.z=i*e.z,this.w=t,this},setFromEulerAngles:function(e,t,i){var s=.5*Hr.DEG_TO_RAD;e*=s,t*=s,i*=s,s=Math.sin(e),e=Math.cos(e);var n=Math.sin(t);t=Math.cos(t);var r=Math.sin(i);return i=Math.cos(i),this.x=s*t*i-e*n*r,this.y=e*n*i+s*t*r,this.z=e*t*r-s*n*i,this.w=e*t*i+s*n*r,this},setFromMat4:function(e){var t=(e=e.data)[0],i=e[1],s=e[2],n=e[4],r=e[5],a=e[6],o=e[8],h=e[9];e=e[10];var l=t*t+i*i+s*s;if(0===l)return this;l=1/Math.sqrt(l);var c=n*n+r*r+a*a;if(0===c)return this;c=1/Math.sqrt(c);var d=o*o+h*h+e*e;return 0===d?this:(i*=l,s*=l,n*=c,a*=c,o*=d=1/Math.sqrt(d),h*=d,0<=(l=(t*=l)+(r*=c)+(e*=d))?(t=Math.sqrt(l+1),this.w=.5*t,t=.5/t,this.x=(a-h)*t,this.y=(o-s)*t,this.z=(i-n)*t):t>r?t>e?(t=Math.sqrt(t-(r+e)+1),this.x=.5*t,t=.5/t,this.w=(a-h)*t,this.y=(i+n)*t,this.z=(s+o)*t):(t=Math.sqrt(e-(t+r)+1),this.z=.5*t,t=.5/t,this.w=(i-n)*t,this.x=(o+s)*t,this.y=(h+a)*t):r>e?(t=Math.sqrt(r-(e+t)+1),this.y=.5*t,t=.5/t,this.w=(o-s)*t,this.z=(a+h)*t,this.x=(n+i)*t):(t=Math.sqrt(e-(t+r)+1),this.z=.5*t,t=.5/t,this.w=(i-n)*t,this.x=(o+s)*t,this.y=(h+a)*t),this)},slerp:function(e,t,i){var s=e.x,n=e.y,r=e.z;e=e.w;var a=t.x,o=t.y,h=t.z,l=e*(t=t.w)+s*a+n*o+r*h;if(0>l&&(t=-t,a=-a,o=-o,h=-h,l=-l),1<=Math.abs(l))return this.w=e,this.x=s,this.y=n,this.z=r,this;var c=Math.acos(l),d=Math.sqrt(1-l*l);return.001>Math.abs(d)?(this.w=.5*e+.5*t,this.x=.5*s+.5*a,this.y=.5*n+.5*o,this.z=.5*r+.5*h,this):(l=Math.sin((1-i)*c)/d,i=Math.sin(i*c)/d,this.w=e*l+t*i,this.x=s*l+a*i,this.y=n*l+o*i,this.z=r*l+h*i,this)},transformVector:function(e,t){void 0===t&&(t=new v);var i=e.x,s=e.y,n=e.z;e=this.x;var r=this.y,a=this.z,o=this.w,h=o*i+r*n-a*s,l=o*s+a*i-e*n,c=o*n+e*s-r*i;return i=-e*i-r*s-a*n,t.x=h*o+i*-e+l*-a-c*-r,t.y=l*o+i*-r+c*-e-h*-a,t.z=c*o+i*-a+h*-r-l*-e,t},toString:function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}}),Object.defineProperties(S,{ZERO:{value:new S(0,0,0,0)},IDENTITY:{value:new S(0,0,0,1)}}),Object.assign(T.prototype,{add:function(e){return this.x+=e.x,this.y+=e.y,this},add2:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this},clone:function(){return(new T).copy(this)},copy:function(e){return this.x=e.x,this.y=e.y,this},distance:function(e){var t=this.x-e.x;return e=this.y-e.y,Math.sqrt(t*t+e*e)},dot:function(e){return this.x*e.x+this.y*e.y},equals:function(e){return this.x===e.x&&this.y===e.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},lengthSq:function(){return this.x*this.x+this.y*this.y},lerp:function(e,t,i){return this.x=e.x+i*(t.x-e.x),this.y=e.y+i*(t.y-e.y),this},mul:function(e){return this.x*=e.x,this.y*=e.y,this},mul2:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this},normalize:function(){var e=this.x*this.x+this.y*this.y;return 0<e&&(e=1/Math.sqrt(e),this.x*=e,this.y*=e),this},scale:function(e){return this.x*=e,this.y*=e,this},set:function(e,t){return this.x=e,this.y=t,this},sub:function(e){return this.x-=e.x,this.y-=e.y,this},sub2:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this},toString:function(){return"["+this.x+", "+this.y+"]"}}),Object.defineProperties(T,{ZERO:{value:new T(0,0)},ONE:{value:new T(1,1)},UP:{value:new T(0,1)},DOWN:{value:new T(0,-1)},RIGHT:{value:new T(1,0)},LEFT:{value:new T(-1,0)}});var Yr=new v,Kr=new v,Zr=new v,$r=new v,Qr=new v;Object.assign(w.prototype,{add:function(e){var t=this.center,i=t.x,s=t.y,n=t.z,r=this.halfExtents,a=r.x,o=r.y,h=r.z,l=i-a;i+=a,a=s-o,s+=o,o=n-h,n+=h;var c=(h=e.center).x,d=h.y;h=h.z;var u=(e=e.halfExtents).x,p=e.y,f=e.z;(e=c-u)<l&&(l=e),(c+=u)>i&&(i=c),(u=d-p)<a&&(a=u),(d+=p)>s&&(s=d),(p=h-f)<o&&(o=p),(h+=f)>n&&(n=h),t.x=.5*(l+i),t.y=.5*(a+s),t.z=.5*(o+n),r.x=.5*(i-l),r.y=.5*(s-a),r.z=.5*(n-o)},copy:function(e){this.center.copy(e.center),this.halfExtents.copy(e.halfExtents),this.type=e.type},clone:function(){return new w(this.center.clone(),this.halfExtents.clone())},intersects:function(e){var t=this.getMax(),i=this.getMin(),s=e.getMax();return e=e.getMin(),i.x<=s.x&&t.x>=e.x&&i.y<=s.y&&t.y>=e.y&&i.z<=s.z&&t.z>=e.z},_intersectsRay:function(e,t){var i=Yr.copy(this.getMin()).sub(e.origin),s=Kr.copy(this.getMax()).sub(e.origin),n=e.direction;return 0===n.x?(i.x=0>i.x?-Number.MAX_VALUE:Number.MAX_VALUE,s.x=0>s.x?-Number.MAX_VALUE:Number.MAX_VALUE):(i.x/=n.x,s.x/=n.x),0===n.y?(i.y=0>i.y?-Number.MAX_VALUE:Number.MAX_VALUE,s.y=0>s.y?-Number.MAX_VALUE:Number.MAX_VALUE):(i.y/=n.y,s.y/=n.y),0===n.z?(i.z=0>i.z?-Number.MAX_VALUE:Number.MAX_VALUE,s.z=0>s.z?-Number.MAX_VALUE:Number.MAX_VALUE):(i.z/=n.z,s.z/=n.z),n=Zr.set(Math.min(i.x,s.x),Math.min(i.y,s.y),Math.min(i.z,s.z)),i=$r.set(Math.max(i.x,s.x),Math.max(i.y,s.y),Math.max(i.z,s.z)),s=Math.max(Math.max(n.x,n.y),n.z),(i=Math.min(Math.min(i.x,i.y),i.z)>=s&&0<=s)&&t.copy(e.direction).scale(s).add(e.origin),i},_fastIntersectsRay:function(e){var t=e.direction;return Yr.sub2(e.origin,this.center),$r.set(Math.abs(Yr.x),Math.abs(Yr.y),Math.abs(Yr.z)),Zr.mul2(Yr,t),!($r.x>this.halfExtents.x&&0<=Zr.x||$r.y>this.halfExtents.y&&0<=Zr.y||$r.z>this.halfExtents.z&&0<=Zr.z)&&(Qr.set(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z)),Kr.cross(t,Yr),Kr.set(Math.abs(Kr.x),Math.abs(Kr.y),Math.abs(Kr.z)),!(Kr.x>this.halfExtents.y*Qr.z+this.halfExtents.z*Qr.y||Kr.y>this.halfExtents.x*Qr.z+this.halfExtents.z*Qr.x||Kr.z>this.halfExtents.x*Qr.y+this.halfExtents.y*Qr.x))},intersectsRay:function(e,t){return t?this._intersectsRay(e,t):this._fastIntersectsRay(e)},setMinMax:function(e,t){this.center.add2(t,e).scale(.5),this.halfExtents.sub2(t,e).scale(.5)},getMin:function(){return this._min.copy(this.center).sub(this.halfExtents)},getMax:function(){return this._max.copy(this.center).add(this.halfExtents)},containsPoint:function(e){var t=this.getMin(),i=this.getMax();return!(e.x<t.x||e.x>i.x||e.y<t.y||e.y>i.y||e.z<t.z||e.z>i.z)},setFromTransformedAabb:function(e,t){var i=this.center,s=this.halfExtents,n=e.center;e=e.halfExtents;var r=(t=t.data)[0],a=t[4],o=t[8],h=t[1],l=t[5],c=t[9],d=t[2],u=t[6],p=t[10],f=Math.abs(r),m=Math.abs(a),_=Math.abs(o),g=Math.abs(h),y=Math.abs(l),v=Math.abs(c),b=Math.abs(d),x=Math.abs(u),S=Math.abs(p);i.set(t[12]+r*n.x+a*n.y+o*n.z,t[13]+h*n.x+l*n.y+c*n.z,t[14]+d*n.x+u*n.y+p*n.z),s.set(f*e.x+m*e.y+_*e.z,g*e.x+y*e.y+v*e.z,b*e.x+x*e.y+S*e.z)},compute:function(e,t){if(0<(t=void 0===t?e.length/3:t)){for(var i=Yr.set(e[0],e[1],e[2]),s=Kr.set(e[0],e[1],e[2]),n=1;n<t;n++){var r=e[3*n],a=e[3*n+1],o=e[3*n+2];r<i.x&&(i.x=r),a<i.y&&(i.y=a),o<i.z&&(i.z=o),r>s.x&&(s.x=r),a>s.y&&(s.y=a),o>s.z&&(s.z=o)}this.setMinMax(i,s)}},intersectsBoundingSphere:function(e){return this._distanceToBoundingSphereSq(e)<=e.radius*e.radius},_distanceToBoundingSphereSq:function(e){for(var t=this.getMin(),i=this.getMax(),s=0,n=["x","y","z"],r=0;3>r;++r){var a=0,o=e.center[n[r]],h=t[n[r]],l=i[n[r]];o<h&&(a+=(h-=o)*h),o>l&&(a+=(h=o-l)*h),s+=a}return s},_expand:function(e,t){Yr.add2(this.getMin(),e),Kr.add2(this.getMax(),t),this.setMinMax(Yr,Kr)}});var Jr=new v,ea=new v,ta=new v,ia=new v;Object.assign(M.prototype,{containsPoint:function(e){e=Jr.sub2(e,this.center).lengthSq();var t=this.radius;return e<t*t},compute:function(e){var t,i=e.length/3;for(t=0;t<i;t++)Jr.set(e[3*t],e[3*t+1],e[3*t+2]),ta.addSelf(Jr),0==t%100&&(ta.scale(1/i),ea.add(ta),ta.set(0,0,0));ta.scale(1/i),ea.add(ta),this.center.copy(ea);var s=0;for(t=0;t<i;t++)Jr.set(e[3*t],e[3*t+1],e[3*t+2]),ia.sub2(Jr,this.center),s=Math.max(ia.lengthSq(),s);this.radius=Math.sqrt(s)},intersectsRay:function(e,t){var i=Jr.copy(e.origin).sub(this.center),s=i.dot(ea.copy(e.direction).normalize());return 0<(i=i.dot(i)-this.radius*this.radius)&&0<s?null:!(0>(i=s*s-i))&&(s=Math.abs(-s-Math.sqrt(i)),t&&t.copy(e.direction).scale(s).add(e.origin),!0)},intersectsBoundingSphere:function(e){return Jr.sub2(e.center,this.center),e=e.radius+this.radius,Jr.lengthSq()<=e*e}});var sa=new x;Object.assign(P.prototype,{update:function(e,t){sa.mul2(e,t),e=sa.data,this.planes[0][0]=e[3]-e[0],this.planes[0][1]=e[7]-e[4],this.planes[0][2]=e[11]-e[8],this.planes[0][3]=e[15]-e[12],t=Math.sqrt(this.planes[0][0]*this.planes[0][0]+this.planes[0][1]*this.planes[0][1]+this.planes[0][2]*this.planes[0][2]),this.planes[0][0]/=t,this.planes[0][1]/=t,this.planes[0][2]/=t,this.planes[0][3]/=t,this.planes[1][0]=e[3]+e[0],this.planes[1][1]=e[7]+e[4],this.planes[1][2]=e[11]+e[8],this.planes[1][3]=e[15]+e[12],t=Math.sqrt(this.planes[1][0]*this.planes[1][0]+this.planes[1][1]*this.planes[1][1]+this.planes[1][2]*this.planes[1][2]),this.planes[1][0]/=t,this.planes[1][1]/=t,this.planes[1][2]/=t,this.planes[1][3]/=t,this.planes[2][0]=e[3]+e[1],this.planes[2][1]=e[7]+e[5],this.planes[2][2]=e[11]+e[9],this.planes[2][3]=e[15]+e[13],t=Math.sqrt(this.planes[2][0]*this.planes[2][0]+this.planes[2][1]*this.planes[2][1]+this.planes[2][2]*this.planes[2][2]),this.planes[2][0]/=t,this.planes[2][1]/=t,this.planes[2][2]/=t,this.planes[2][3]/=t,this.planes[3][0]=e[3]-e[1],this.planes[3][1]=e[7]-e[5],this.planes[3][2]=e[11]-e[9],this.planes[3][3]=e[15]-e[13],t=Math.sqrt(this.planes[3][0]*this.planes[3][0]+this.planes[3][1]*this.planes[3][1]+this.planes[3][2]*this.planes[3][2]),this.planes[3][0]/=t,this.planes[3][1]/=t,this.planes[3][2]/=t,this.planes[3][3]/=t,this.planes[4][0]=e[3]-e[2],this.planes[4][1]=e[7]-e[6],this.planes[4][2]=e[11]-e[10],this.planes[4][3]=e[15]-e[14],t=Math.sqrt(this.planes[4][0]*this.planes[4][0]+this.planes[4][1]*this.planes[4][1]+this.planes[4][2]*this.planes[4][2]),this.planes[4][0]/=t,this.planes[4][1]/=t,this.planes[4][2]/=t,this.planes[4][3]/=t,this.planes[5][0]=e[3]+e[2],this.planes[5][1]=e[7]+e[6],this.planes[5][2]=e[11]+e[10],this.planes[5][3]=e[15]+e[14],t=Math.sqrt(this.planes[5][0]*this.planes[5][0]+this.planes[5][1]*this.planes[5][1]+this.planes[5][2]*this.planes[5][2]),this.planes[5][0]/=t,this.planes[5][1]/=t,this.planes[5][2]/=t,this.planes[5][3]/=t},containsPoint:function(e){for(var t=0;6>t;t++)if(0>=this.planes[t][0]*e.x+this.planes[t][1]*e.y+this.planes[t][2]*e.z+this.planes[t][3])return!1;return!0},containsSphere:function(e){var t=0,i=e.radius,s=e.center;e=s.x;var n=s.y,r=s.z,a=this.planes;for(s=0;6>s;s++){var o=a[s];if((o=o[0]*e+o[1]*n+o[2]*r+o[3])<=-i)return 0;o>i&&t++}return 6===t?2:1}}),A.prototype.set=function(e,t){return this.origin.copy(e),this.direction.copy(t),this};var na=new A,ra=new v,aa=new M,oa=new x;Object.assign(E.prototype,{intersectsRay:function(e,t){return this._modelTransform.transformPoint(e.origin,na.origin),this._modelTransform.transformVector(e.direction,na.direction),t?(e=this._aabb._intersectsRay(na,t),oa.copy(this._modelTransform).invert().transformPoint(t,t),e):this._aabb._fastIntersectsRay(na)},containsPoint:function(e){return this._modelTransform.transformPoint(e,ra),this._aabb.containsPoint(ra)},intersectsBoundingSphere:function(e){return this._modelTransform.transformPoint(e.center,aa.center),aa.radius=e.radius,!!this._aabb.intersectsBoundingSphere(aa)}}),Object.defineProperty(E.prototype,"worldTransform",{get:function(){return this._worldTransform},set:function(e){this._worldTransform.copy(e),this._modelTransform.copy(e).invert()}});var ha=new v;Object.assign(C.prototype,{intersectsLine:function(e,t,i){var s=-this.normal.dot(this.point),n=this.normal.dot(e)+s;return(s=0<=(n/=n-(s=this.normal.dot(t)+s))&&1>=n)&&i&&i.lerp(e,t,n),s},intersectsRay:function(e,t){var i=ha.sub2(this.point,e.origin),s=0<=(i=this.normal.dot(i)/this.normal.dot(e.direction));return s&&t&&t.copy(e.direction).scale(i).add(e.origin),s}});var la=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array],ca=[1,1,2,2,4,4,4],da={Int8Array:0,Uint8Array:1,Int16Array:2,Uint16Array:3,Int32Array:4,Uint32Array:5,Float32Array:6},ua=[Uint8Array,Uint16Array,Uint32Array];Object.assign(I.prototype,{destroy:function(){var e=this.device,t=e.buffers.indexOf(this);if(-1!==t&&e.buffers.splice(t,1),this.bufferId){for(var i in(t=e.gl).deleteBuffer(this.bufferId),e._vram.vb-=this.storage.byteLength,this.bufferId=null,e.boundBuffer=null,e.vertexBuffers.length=0,e.vbOffsets.length=0,e.attributesInvalidated=!0,e.enabledAttributes)t.disableVertexAttribArray(Number(i));e.enabledAttributes={}}},getFormat:function(){return this.format},getUsage:function(){return this.usage},getNumVertices:function(){return this.numVertices},lock:function(){return this.storage},unlock:function(){var e=this.device.gl;switch(this.bufferId||(this.bufferId=e.createBuffer()),this.usage){case 0:var t=e.STATIC_DRAW;break;case 1:t=e.DYNAMIC_DRAW;break;case 2:t=e.STREAM_DRAW;break;case 3:t=this.device.webgl2?e.DYNAMIC_COPY:e.STATIC_DRAW}e.bindBuffer(e.ARRAY_BUFFER,this.bufferId),e.bufferData(e.ARRAY_BUFFER,this.storage,t)},setData:function(e){return e.byteLength!==this.numBytes?(console.error("VertexBuffer: wrong initial data size: expected "+this.numBytes+", got "+e.byteLength),!1):(this.storage=e,this.unlock(),!0)}}),R.init=function(e){this._defaultInstancingFormat=new R(e,[{semantic:"TEXCOORD2",components:4,type:6},{semantic:"TEXCOORD3",components:4,type:6},{semantic:"TEXCOORD4",components:4,type:6},{semantic:"TEXCOORD5",components:4,type:6}])},Object.defineProperty(R,"defaultInstancingFormat",{get:function(){return this._defaultInstancingFormat}}),Object.assign(R.prototype,{_evaluateBatchingHash:function(){var e,t=[],i=this.elements.length;for(e=0;e<i;e++){var s=this.elements[e],n=s.name;n+=s.dataType,n+=s.numComponents,n+=s.normalize,t.push(n)}return t.sort(),O(t.join())}}),D.prototype.get=function(e){return this.array[this.index+e]},D.prototype.set=function(e,t,i,s){},D.prototype.setFromArray=function(e,t,i){},D.prototype.getToArray=function(e,t,i){},Object.assign(X.prototype,{next:function(e){void 0===e&&(e=1);for(var t=0,i=this.accessors,s=this.accessors.length;t<s;){var n=i[t++];n.index+=e*n.stride}},end:function(){this.vertexBuffer.unlock()},writeData:function(e,t,i){if(e=this.element[e]){i>this.vertexBuffer.numVertices&&(i=this.vertexBuffer.numVertices);var s,n=e.numComponents;if(this.vertexBuffer.getFormat().interleaved){var r=0;for(s=0;s<i;s++)e.setFromArray(r,t,s*n),r+=e.stride}else if(t.length>i*n)if(i*=n,ArrayBuffer.isView(t))t=t.subarray(0,i),e.array.set(t);else for(s=0;s<i;s++)e.array[s]=t[s];else e.array.set(t)}},readData:function(e,t){var i=0;if(e=this.element[e]){i=this.vertexBuffer.numVertices;var s,n=e.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(t)&&(t.length=0);var r=e.index=0;for(s=0;s<i;s++)e.getToArray(r,t,s*n),r+=e.stride}else if(ArrayBuffer.isView(t))t.set(e.array);else for(t.length=0,n*=i,s=0;s<n;s++)t[s]=e.array[s]}return i}});var pa=null,fa={type:5,base:0,count:4,indexed:!1},ma=function(e,t,i){return"\n#ifdef MAPFLOAT\n"+e+"\n#else\n"+Ma[t]+"\n#endif\n"},_a=function(e,t,i){return"\n#ifdef MAPCOLOR\n"+e+"\n#else\n"+Ma[t]+"\n#endif\n"},ga=function(e,t,i){return"\n#ifdef MAPTEXTURE\n"+e+"\n#else\n"+Ma[t]+"\n#endif\n"},ya=function(e,t,i){return"#undef MAPTEXTURECOLOR\n#ifdef MAPTEXTURE\n#ifdef MAPCOLOR\n#define MAPTEXTURECOLOR\n#endif\n#endif\n#ifdef MAPTEXTURECOLOR\n"+e+"\n#else\n"+Ma[t]+"\n#endif\n"},va=function(e,t,i){return"#undef MAPTEXTUREFLOAT\n#ifdef MAPTEXTURE\n#ifdef MAPFLOAT\n#define MAPTEXTUREFLOAT\n#endif\n#endif\n#ifdef MAPTEXTUREFLOAT\n"+e+"\n#else\n"+Ma[t]+"\n#endif\n"},ba=function(e,t,i){return"\n#ifdef MAPVERTEX\n"+e+"\n#else\n"+Ma[t]+"\n#endif\n"},xa=function(e,t,i){return"#undef MAPVERTEXCOLOR\n#ifdef MAPVERTEX\n#ifdef MAPCOLOR\n#define MAPVERTEXCOLOR\n#endif\n#endif\n#ifdef MAPVERTEXCOLOR\n"+e+"\n#else\n"+Ma[t]+"\n#endif\n"},Sa=function(e,t,i){return"#undef MAPVERTEXFLOAT\n#ifdef MAPVERTEX\n#ifdef MAPFLOAT\n#define MAPVERTEXFLOAT\n#endif\n#endif\n#ifdef MAPVERTEXFLOAT\n"+e+"\n#else\n"+Ma[t]+"\n#endif\n"},Ta=[],wa={gammaCode:function(e,t){return t||(t=Ma),1===e||2===e?t.gamma2_2PS?t.gamma2_2PS:Ma.gamma2_2PS:3===e?"#define HDR\n"+(t.gamma2_2PS?t.gamma2_2PS:Ma.gamma2_2PS):t.gamma1_0PS?t.gamma1_0PS:Ma.gamma1_0PS},tonemapCode:function(e,t){return t||(t=Ma),1===e?t.tonemappingFilmicPS?t.tonemappingFilmicPS:Ma.tonemappingFilmicPS:0===e?t.tonemappingLinearPS?t.tonemappingLinearPS:Ma.tonemappingLinearPS:2===e?t.tonemappingHejlPS?t.tonemappingHejlPS:Ma.tonemappingHejlPS:3===e?t.tonemappingAcesPS?t.tonemappingAcesPS:Ma.tonemappingAcesPS:4===e?t.tonemappingAces2PS?t.tonemappingAces2PS:Ma.tonemappingAces2PS:t.tonemapingNonePS?t.tonemapingNonePS:Ma.tonemappingNonePS},fogCode:function(e,t){return t||(t=Ma),"linear"===e?t.fogLinearPS?t.fogLinearPS:Ma.fogLinearPS:"exp"===e?t.fogExpPS?t.fogExpPS:Ma.fogExpPS:"exp2"===e?t.fogExp2PS?t.fogExp2PS:Ma.fogExp2PS:t.fogNonePS?t.fogNonePS:Ma.fogNonePS},skinCode:function(e,t){return t||(t=Ma),e.supportsBoneTextures?t.skinTexVS:"#define BONE_LIMIT "+e.getBoneLimit()+"\n"+t.skinConstVS},precisionCode:function(e){var t="precision "+e.precision+" float;\n";return e.webgl2&&(t+="#ifdef GL2\nprecision "+e.precision+" sampler2DShadow;\n#endif\n"),t},versionCode:function(e){return e.webgl2?"#version 300 es\n":""},dummyFragmentCode:function(){return"void main(void) {gl_FragColor = vec4(0.0);}"},begin:function(){return"void main(void)\n{\n"},end:function(){return"}\n"},basic:{generateKey:function(e){var t="basic";return e.fog&&(t+="_fog"),e.alphaTest&&(t+="_atst"),e.vertexColors&&(t+="_vcol"),e.diffuseMap&&(t+="_diff"),t+"_"+e.pass},createShaderDefinition:function(e,t){var i={vertex_position:"POSITION"};t.skin&&(i.vertex_boneWeights="BLENDWEIGHT",i.vertex_boneIndices="BLENDINDICES"),t.vertexColors&&(i.vertex_color="COLOR"),t.diffuseMap&&(i.vertex_texCoord0="TEXCOORD0");var s=Ma,n=""+s.transformDeclVS;t.skin?(n+=wa.skinCode(e),n+=s.transformSkinnedVS):n+=s.transformVS,t.vertexColors&&(n+="attribute vec4 vertex_color;\nvarying vec4 vColor;\n"),t.diffuseMap&&(n+="attribute vec2 vertex_texCoord0;\nvarying vec2 vUv0;\n"),2===t.pass&&(n+="varying float vDepth;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n\n#endif\n"),n+=wa.begin(),n+="   gl_Position = getPosition();\n",2===t.pass&&(n+="\tvDepth = -(matrix_view * vec4(getWorldPosition(),1.0)).z * camera_params.x;\n"),t.vertexColors&&(n+="\tvColor = vertex_color;\n"),t.diffuseMap&&(n+="\tvUv0 = vertex_texCoord0;\n");var r=n+=wa.end();return n=wa.precisionCode(e),n=t.vertexColors?n+"varying vec4 vColor;\n":n+"uniform vec4 uColor;\n",t.diffuseMap&&(n+="varying vec2 vUv0;\nuniform sampler2D texture_diffuseMap;\n"),t.fog&&(n+=wa.fogCode(t.fog)),t.alphatest&&(n+=s.alphaTestPS),2===t.pass&&(n=n+"varying float vDepth;\n"+s.packDepthPS),n+=wa.begin(),n=t.vertexColors?n+"\tgl_FragColor = vColor;\n":n+"\tgl_FragColor = uColor;\n",t.diffuseMap&&(n+="\tgl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n"),t.alphatest&&(n+="   alphaTest(gl_FragColor.a);\n"),18!==t.pass&&(2===t.pass?n+="\tgl_FragColor = packFloat(vDepth);\n":t.fog&&(n+="   glFragColor.rgb = addFog(gl_FragColor.rgb);\n")),{attributes:i,vshader:r,fshader:n+=wa.end()}}},particle:{generateKey:function(e){var t,i="particle";for(t in e)e.hasOwnProperty(t)&&(i+=e[t]);return i},_animTex:function(e,t){return(e=""+(e.animTexLoop?t.particleAnimFrameLoopVS:t.particleAnimFrameClampVS))+t.particleAnimTexVS},createShaderDefinition:function(e,t){var i=Ma,s="",n=wa.precisionCode(e)+"\n";return e.webgl2&&(s+="#define GL2\n",n+="#define GL2\n"),s+="#define VERTEXSHADER\n",t.mesh&&(s+="#define USE_MESH\n"),t.localSpace&&(s+="#define LOCAL_SPACE\n"),t.animTex&&(s+="\nuniform vec2 animTexTilesParams;\n"),t.animTex&&(s+="\nuniform vec4 animTexParams;\n"),t.animTex&&(s+="\nuniform vec2 animTexIndexParams;\n"),2==t.normal&&(s+="\nvarying mat3 ParticleMat;\n"),1==t.normal&&(s+="\nvarying vec3 Normal;\n"),t.soft&&(s+="\nvarying float vDepth;\n"),e=t.customFace?i.particle_customFaceVS:i.particle_billboardVS,t.useCpu?(0<t.soft&&(s+=i.screenDepthPS),s+=i.particle_cpuVS,t.localSpace&&(s+=i.particle_localShiftVS),t.animTex&&(s+=this._animTex(t,i)),t.alignToMotion&&(s+=i.particle_pointAlongVS),s+=t.mesh?i.particle_meshVS:e,1==t.normal&&(s+=i.particle_normalVS),2==t.normal&&(s+=i.particle_TBNVS),0<t.stretch&&(s+=i.particle_stretchVS),s+=i.particle_cpu_endVS):(s+=i.particle_initVS,s+=t.pack8?i.particleInputRgba8PS:i.particleInputFloatPS,0<t.soft&&(s+=i.screenDepthPS),s+=i.particleVS,t.localSpace&&(s+=i.particle_localShiftVS),t.animTex&&(s+=this._animTex(t,i)),t.wrap&&(s+=i.particle_wrapVS),t.alignToMotion&&(s+=i.particle_pointAlongVS),s+=t.mesh?i.particle_meshVS:e,1==t.normal&&(s+=i.particle_normalVS),2==t.normal&&(s+=i.particle_TBNVS),0<t.stretch&&(s+=i.particle_stretchVS),s+=i.particle_endVS),0<t.soft&&(s+=i.particle_softVS),s+="}\n",0<t.normal&&(1==t.normal?n+="\nvarying vec3 Normal;\n":2==t.normal&&(n+="\nvarying mat3 ParticleMat;\n"),n+="\nuniform vec3 lightCube[6];\n"),t.soft&&(n+="\nvarying float vDepth;\n"),0===t.normal&&"none"===t.fog&&(t.srgb=!1),n+=wa.gammaCode(t.gamma),n+=wa.tonemapCode(t.toneMap),n="linear"===t.fog?n+i.fogLinearPS:"exp"===t.fog?n+i.fogExpPS:"exp2"===t.fog?n+i.fogExp2PS:n+i.fogNonePS,2==t.normal&&(n+="\nuniform sampler2D normalMap;\n"),0<t.soft&&(n+=i.screenDepthPS),n+=i.particlePS,0<t.soft&&(n+=i.particle_softPS),1==t.normal&&(n+="\nvec3 normal = Normal;\n"),2==t.normal&&(n+=i.particle_normalMapPS),0<t.normal&&(n+=t.halflambert?i.particle_halflambertPS:i.particle_lambertPS),0<t.normal&&(n+=i.particle_lightingPS),2==t.blend?n+=i.particle_blendNormalPS:1==t.blend?n+=i.particle_blendAddPS:5==t.blend&&(n+=i.particle_blendMultiplyPS),n+=i.particle_endPS,{attributes:Ma.collectAttribs(s),vshader:s,fshader:n}}},skybox:{generateKey:function(e){return"skybox"+e.rgbm+" "+e.hdr+" "+e.fixSeams+e.toneMapping+e.gamma+e.useIntensity+e.mip},createShaderDefinition:function(e,t){var i=Ma;return{attributes:{aPosition:"POSITION"},vshader:i.skyboxVS,fshader:wa.precisionCode(e)+(t.mip?i.fixCubemapSeamsStretchPS:i.fixCubemapSeamsNonePS)+(t.useIntensity?i.envMultiplyPS:i.envConstPS)+wa.gammaCode(t.gamma)+wa.tonemapCode(t.toneMapping)+i.rgbmPS+i.skyboxHDRPS.replace(/\$textureCubeSAMPLE/g,t.rgbm?"textureCubeRGBM":t.hdr?"textureCube":"textureCubeSRGB").replace(/\$FIXCONST/g,1-1/[128,64,16,8,4,2][t.mip]+"")}}}};wa.standard={_oldChunkToNew:{aoTexPS:{n:"aoPS",f:ga},aoVertPS:{n:"aoPS",f:ba},diffuseConstPS:{n:"diffusePS",f:_a},diffuseTexPS:{n:"diffusePS",f:ga},diffuseTexConstPS:{n:"diffusePS",f:ya},diffuseVertPS:{n:"diffusePS",f:ba},diffuseVertConstPS:{n:"diffusePS",f:xa},emissiveConstPS:{n:"emissivePS",f:_a},emissiveTexPS:{n:"emissivePS",f:ga},emissiveTexConstPS:{n:"emissivePS",f:ya},emissiveTexConstFloatPS:{n:"emissivePS",f:va},emissiveVertPS:{n:"emissivePS",f:ba},emissiveVertConstPS:{n:"emissivePS",f:xa},emissiveVertConstFloatPS:{n:"emissivePS",f:Sa},glossConstPS:{n:"glossPS",f:ma},glossTexPS:{n:"glossPS",f:ga},glossTexConstPS:{n:"glossPS",f:va},glossVertPS:{n:"glossPS",f:ba},glossVertConstPS:{n:"glossPS",f:Sa},metalnessConstPS:{n:"metalnessPS",f:ma},metalnessTexPS:{n:"metalnessPS",f:ga},metalnessTexConstPS:{n:"metalnessPS",f:va},metalnessVertPS:{n:"metalnessPS",f:ba},metalnessVertConstPS:{n:"metalnessPS",f:Sa},opacityConstPS:{n:"opacityPS",f:ma},opacityTexPS:{n:"opacityPS",f:ga},opacityTexConstPS:{n:"opacityPS",f:va},opacityVertPS:{n:"opacityPS",f:ba},opacityVertConstPS:{n:"opacityPS",f:Sa},specularConstPS:{n:"specularPS",f:_a},specularTexPS:{n:"specularPS",f:ga},specularTexConstPS:{n:"specularPS",f:ya},specularVertPS:{n:"specularPS",f:ba},specularVertConstPS:{n:"specularPS",f:xa},transformBatchSkinnedVS:{n:"transformVS",f:function(e,t,i){return"\n#ifdef DYNAMICBATCH\n"+e+"\n#else\n"+Ma[t]+"\n#endif\n"}},transformInstancedVS:{n:"transformVS",f:function(e,t,i){return"\n#ifdef INSTANCING\n"+e+"\n#else\n"+Ma[t]+"\n#endif\n"}},transformPixelSnapVS:{n:"transformVS",f:function(e,t,i){return"\n#ifdef PIXELSNAP\n"+e+"\n#else\n"+Ma[t]+"\n#endif\n"}},transformScreenSpaceVS:{n:"transformVS",f:function(e,t,i){return"\n#ifdef SCREENSPACE\n"+e+"\n#else\n"+Ma[t]+"\n#endif\n"}},transformScreenSpaceBatchSkinned:{n:"transformVS",f:function(e,t,i){return"#undef SCREENSPACEBATCH\n#ifdef SCREENSPACE\n#ifdef BATCH\n#define SCREENSPACEBATCH\n#endif\n#endif\n#ifdef SCREENSPACEBATCH\n"+e+"\n#else\n"+Ma[t]+"\n#endif\n"}},transformSkinned:{n:"transformVS",f:function(e,t,i){return"\n#ifdef SKIN\n"+e+"\n#else\n"+Ma[t]+"\n#endif\n"}},transformUv1:{n:"transformVS",f:function(e,t,i){return"\n#ifdef UV1LAYOUT\n"+e+"\n#else\n"+Ma[t]+"\n#endif\n"}}},optionsContext:{},optionsContextMin:{},generateKey:function(e){var t,i=function(e){var t,i=[];for(t in e)e.hasOwnProperty(t)&&"chunks"!==t&&"lights"!==t&&i.push(t);return i.sort()};if(e===this.optionsContextMin){this.propsMin||(this.propsMin=i(e));var s=this.propsMin}else e===this.optionsContext?(this.props||(this.props=i(e)),s=this.props):s=i(e);for(i="standard",t=0;t<s.length;t++)e[s[t]]&&(i+=s[t]+e[s[t]]);if(e.chunks){for(var n in s=[],e.chunks)e.chunks.hasOwnProperty(n)&&s.push(n+e.chunks[n]);s.sort(),i+=s}if(e.lights)for(t=0;t<e.lights.length;t++)i+=e.lights[t].key;return O(i)},_correctChannel:function(e,t){if(0<Ta[e]){if(Ta[e]<t.length)return t.substring(0,Ta[e]);if(Ta[e]>t.length){var i=t.charAt(t.length-1);e=Ta[e]-t.length;for(var s=0;s<e;s++)t+=i;return t}return t}},_setMapTransform:function(e,t,i,s){e[0]+="uniform vec4 texture_"+t+"MapTransform;\n";var n=i+100*s;return e[3][n]||(e[1]+="varying vec2 vUV"+s+"_"+i+";\n",e[2]+="   vUV"+s+"_"+i+" = uv"+s+" * texture_"+t+"MapTransform.xy + texture_"+t+"MapTransform.zw;\n",e[3][n]=!0),e},_getUvSourceExpression:function(e,t,i){var s=i[e];t=i[t];var n=0===i.pass||1===i.pass;return n&&1===i.nineSlicedMode?s="nineSlicedUv":n&&2===i.nineSlicedMode?s="nineSlicedUv, -1000.0":(s=0===s?"vUv"+t:"vUV"+t+"_"+s,i.heightMap&&"heightMapTransform"!==e&&(s+=" + dUvOffset")),s},_addMapDef:function(e,t){var i="\n#undef "+e+"\n";return t&&(i+=" #define "+e+"\n"),i},_addMapDefs:function(e,t,i,s){return e=""+this._addMapDef("MAPFLOAT",e),e+=this._addMapDef("MAPCOLOR",t),(e+=this._addMapDef("MAPVERTEX",i))+this._addMapDef("MAPTEXTURE",s)},_addMap:function(e,t,i,s,n){var r=e+"Map",a=r+"Uv",o=r+"Transform",h=r+"Channel",l=e+"VertexColorChannel",c=i[e+"Tint"],d=i[e+"VertexColor"];return r=i[r],e=i[e+"Mode"],t=s[t],r&&(a=this._getUvSourceExpression(o,a,i),t=t.replace(/\$UV/g,a).replace(/\$CH/g,i[h]),void 0!==n&&(t=t.replace(/\$texture2DSAMPLE/g,0===n?"texture2DSRGB":1===n?"texture2DRGBM":"texture2D"))),d&&(t=t.replace(/\$VC/g,i[l])),e&&(t=t.replace(/\$DETAILMODE/g,e)),(t=this._addMapDefs(1===c,3===c,d,r)+t).replace(/\$/g,"")},_nonPointShadowMapProjection:function(e,t,i){return!t._normalOffsetBias||t._isVsm?2===t._type?t._isPcf&&(e.webgl2||e.extStandardDerivatives)?"\t   getShadowCoordPerspZbuffer"+i:"\t   getShadowCoordPersp"+i:"\t   getShadowCoordOrtho"+i:2===t._type?t._isPcf&&(e.webgl2||e.extStandardDerivatives)?"\t   getShadowCoordPerspZbufferNormalOffset"+i:"\t   getShadowCoordPerspNormalOffset"+i:"\t   getShadowCoordOrthoNormalOffset"+i},_addVaryingIfNeeded:function(e,t,i){return 0<=e.indexOf(i)?"varying "+t+" "+i+";\n":""},_vsAddTransformCode:function(e,t,i,s){return e+i.transformVS},_vsAddBaseCode:function(e,t,i,s){return e+=i.baseVS,1!==s.nineSlicedMode&&2!==s.nineSlicedMode||(e+=i.baseNineSlicedVS),e},_fsAddBaseCode:function(e,t,i,s){return e+=i.basePS,1===s.nineSlicedMode?e+=i.baseNineSlicedPS:2===s.nineSlicedMode&&(e+=i.baseNineSlicedTiledPS),e},_fsAddStartCode:function(e,t,i,s){return e+=i.startPS,1===s.nineSlicedMode?e+=i.startNineSlicedPS:2===s.nineSlicedMode&&(e+=i.startNineSlicedTiledPS),e},createShaderDefinition:function(e,t){var i=0<t.lights.length;t.dirLightMap&&(i=!0,t.useSpecular=!0),0===t.shadingModel?(t.fresnelModel=0,t.specularAntialias=!1,t.prefilteredCubemap=!1,t.dpAtlas=!1,t.ambientSH=!1):t.fresnelModel=0===t.fresnelModel?2:t.fresnelModel;var s=(t.cubeMap||t.prefilteredCubemap&&t.useSpecular)&&!t.sphereMap&&!t.dpAtlas,n=t.sphereMap||s||t.dpAtlas,r=t.useTexCubeLod;t.cubeMap&&(t.sphereMap=null),t.dpAtlas&&(t.prefilteredCubemap=null),t.useSpecular||(t.specularMap=t.glossMap=null);var a=i||n||t.ambientSH||t.prefilteredCubemap||t.heightMap||t.enableGGXSpecular,o=3<=t.pass&&17>=t.pass;this.options=t;var h="",l="",c="",d=Ma,u={vertex_position:"POSITION"};if(t.chunks){var p={};for(b in d)if(d.hasOwnProperty(b))if(t.chunks[b]){var f=t.chunks[b];0<=f.indexOf("vertex_normal")&&(u.vertex_normal="NORMAL"),0<=f.indexOf("vertex_tangent")&&(u.vertex_tangent="TANGENT"),0<=f.indexOf("vertex_texCoord0")&&(u.vertex_texCoord0="TEXCOORD0"),0<=f.indexOf("vertex_texCoord1")&&(u.vertex_texCoord1="TEXCOORD1"),0<=f.indexOf("vertex_color")&&(u.vertex_color="COLOR"),0<=f.indexOf("vertex_boneWeights")&&(u.vertex_boneWeights="BLENDWEIGHT"),0<=f.indexOf("vertex_boneIndices")&&(u.vertex_boneIndices="BLENDINDICES"),p[b]=f}else p[b]=d[b];for(b in t.chunks)(d=this._oldChunkToNew[b])&&(p[d.n]=d.f(t.chunks[b],d.n,b));d=p}if(h=this._vsAddBaseCode(h,e,d,t),p=-1,!t.noShadow&&!t.twoSidedLighting){for(f=0;f<t.lights.length;f++){var m=t.lights[f]._type;if(t.lights[f].castShadows&&0===m){h+="uniform mat4 light"+f+"_shadowMatrixVS;\n",h+="uniform vec3 light"+f+"_shadowParamsVS;\n",h+="uniform vec3 light"+f+(0===m?"_directionVS":"_positionVS")+";\n",p=f;break}}0<=p&&(h+=d.shadowCoordVS)}l+="   vPositionW\t= getWorldPosition();\n",2===t.pass&&(h+="varying float vDepth;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n\n#endif\n",l+="\tvDepth = -(matrix_view * vec4(vPositionW,1.0)).z * camera_params.x;\n"),t.useInstancing&&(u.instance_line1="TEXCOORD2",u.instance_line2="TEXCOORD3",u.instance_line3="TEXCOORD4",u.instance_line4="TEXCOORD5",h+=d.instancingVS),a&&(u.vertex_normal="NORMAL",l+="   vNormalW\t= dNormalW = getNormal();\n",t.sphereMap&&16>=e.fragmentUniformsCount&&(h+=d.viewNormalVS,l+="   vNormalV\t= getViewNormal();\n"),(t.heightMap||t.normalMap||t.enableGGXSpecular)&&t.hasTangents?(u.vertex_tangent="TANGENT",h+=d.tangentBinormalVS,l+="   vTangentW   = getTangent();\n   vBinormalW  = getBinormal();\n"):t.enableGGXSpecular&&(h+=d.tangentBinormalVS,l+="   vObjectSpaceUpW  = getObjectSpaceUp();\n"),0<=p&&(l=(0===(m=t.lights[p]._type)?l+"   dLightDirNormW = light"+p+"_directionVS;\n":l+"   getLightDirPoint(light"+p+"_positionVS);\n")+this._nonPointShadowMapProjection(e,t.lights[p],"(light"+p+"_shadowMatrixVS, light"+p+"_shadowParamsVS);\n"))),m=[];var _=[];for(b in Ta){if(f=b+"Map",t[b+"VertexColor"]){var g=b+"VertexColorChannel";t[g]=this._correctChannel(b,t[g])}if(t[f]){g=f+"Channel";var y=f+"Transform",v=f+"Uv";t[v]=Math.min(t[v],1),t[g]=this._correctChannel(b,t[g]),m[v=t[v]]=!0,_[v]=_[v]||t[f]&&!t[y]}}for(t.forceUv1&&(m[1]=!0),f=0;2>f;f++)m[f]&&(u["vertex_texCoord"+f]=pc["SEMANTIC_TEXCOORD"+f],h+=d["uv"+f+"VS"],l+="   vec2 uv"+f+" = getUv"+f+"();\n"),_[f]&&(l+="   vUv"+f+" = uv"+f+";\n");for(b in m=[h,c,l,[]],Ta)t[f=b+"Map"]&&(t[y=f+"Transform"]&&(v=f+"Uv",this._setMapTransform(m,b,t[y],t[v])));h=m[0],c=m[1],l=m[2],t.vertexColors&&(u.vertex_color="COLOR",l+="   vVertexColor = vertex_color;\n"),(t.useMorphPosition||t.useMorphNormal)&&(t.useMorphTextureBased?(h+="#define MORPHING_TEXTURE_BASED\n",t.useMorphPosition&&(h+="#define MORPHING_TEXTURE_BASED_POSITION\n"),t.useMorphNormal&&(h+="#define MORPHING_TEXTURE_BASED_NORMAL\n"),u.morph_vertex_id="ATTR0",h+="attribute float morph_vertex_id;\n"):(h+="#define MORPHING\n",t.useMorphPosition?(u.morph_pos0="ATTR0",u.morph_pos1="ATTR1",u.morph_pos2="ATTR2",u.morph_pos3="ATTR3",h+="#define MORPHING_POS03\nattribute vec3 morph_pos0;\nattribute vec3 morph_pos1;\nattribute vec3 morph_pos2;\nattribute vec3 morph_pos3;\n"):t.useMorphNormal&&(u.morph_nrm0="ATTR0",u.morph_nrm1="ATTR1",u.morph_nrm2="ATTR2",u.morph_nrm3="ATTR3",h+="#define MORPHING_NRM03\nattribute vec3 morph_nrm0;\nattribute vec3 morph_nrm1;\nattribute vec3 morph_nrm2;\nattribute vec3 morph_nrm3;\n"),t.useMorphNormal?(u.morph_nrm4="ATTR4",u.morph_nrm5="ATTR5",u.morph_nrm6="ATTR6",u.morph_nrm7="ATTR7",h+="#define MORPHING_NRM47\nattribute vec3 morph_nrm4;\nattribute vec3 morph_nrm5;\nattribute vec3 morph_nrm6;\nattribute vec3 morph_nrm7;\n"):(u.morph_pos4="ATTR4",u.morph_pos5="ATTR5",u.morph_pos6="ATTR6",u.morph_pos7="ATTR7",h+="#define MORPHING_POS47\nattribute vec3 morph_pos4;\nattribute vec3 morph_pos5;\nattribute vec3 morph_pos6;\nattribute vec3 morph_pos7;\n"))),t.skin?(u.vertex_boneWeights="BLENDWEIGHT",u.vertex_boneIndices="BLENDINDICES",h+=wa.skinCode(e,d),h+="#define SKIN\n"):t.useInstancing&&(h+="#define INSTANCING\n"),t.screenSpace&&(h+="#define SCREENSPACE\n"),t.pixelSnap&&(h+="#define PIXELSNAP\n"),h=this._vsAddTransformCode(h,e,d,t),a&&(h+=d.normalVS);var b=h=(h=h+"\n"+d.startVS)+l+"}";if(f=c,c=""+this._addVaryingIfNeeded(h,"vec4","vMainShadowUv"),c+=this._addVaryingIfNeeded(h,"vec4","vVertexColor"),c+=this._addVaryingIfNeeded(h,"vec3","vPositionW"),c+=this._addVaryingIfNeeded(h,"vec3","vNormalV"),c+=this._addVaryingIfNeeded(h,"vec3","vNormalW"),c+=this._addVaryingIfNeeded(h,"vec3","vTangentW"),c+=this._addVaryingIfNeeded(h,"vec3","vBinormalW"),c+=this._addVaryingIfNeeded(h,"vec3","vObjectSpaceUpW"),c+=this._addVaryingIfNeeded(h,"vec2","vUv0"),c+=this._addVaryingIfNeeded(h,"vec2","vUv1"),b=(c+=f)+b,h="",e.webgl2?(h=wa.versionCode(e),d.extensionVS&&(h+=d.extensionVS+"\n"),b=h+d.gles3VS+b):(d.extensionVS&&(h=d.extensionVS+"\n"),b=h+b),t.forceFragmentPrecision&&"highp"!=t.forceFragmentPrecision&&"mediump"!==t.forceFragmentPrecision&&"lowp"!==t.forceFragmentPrecision&&(t.forceFragmentPrecision=null),t.forceFragmentPrecision&&("highp"===t.forceFragmentPrecision&&"highp"!==e.maxPrecision&&(t.forceFragmentPrecision="mediump"),"mediump"===t.forceFragmentPrecision&&"lowp"===e.maxPrecision&&(t.forceFragmentPrecision="lowp")),h="",e.webgl2&&(h+=wa.versionCode(e)),e.extStandardDerivatives&&!e.webgl2&&(h+="#extension GL_OES_standard_derivatives : enable\n\n"),d.extensionPS&&(h+=d.extensionPS+"\n"),e.webgl2&&(h+=d.gles3PS),h+=t.forceFragmentPrecision?"precision "+t.forceFragmentPrecision+" float;\n\n":wa.precisionCode(e),18===t.pass)return h=h+"uniform vec4 uColor;\n"+c,t.alphaTest&&(h=h+"float dAlpha;\n"+this._addMap("opacity","opacityPS",t,d),h+=d.alphaTestPS),h+=wa.begin(),t.alphaTest&&(h+="   getOpacity();\n   alphaTest(dAlpha);\n"),{attributes:u,vshader:b,fshader:h=h+"\tgl_FragColor = uColor;\n"+wa.end()};if(2===t.pass)return h=h+"varying float vDepth;\n"+c+d.packDepthPS,t.alphaTest&&(h+="float dAlpha;\n",h+=this._addMap("opacity","opacityPS",t,d),h+=d.alphaTestPS),h+=wa.begin(),t.alphaTest&&(h+="   getOpacity();\n",h+="   alphaTest(dAlpha);\n"),h+="\tgl_FragColor = packFloat(vDepth);\n",{attributes:u,vshader:b,fshader:h+=wa.end()};if(o)return s=t.pass-3,s-=5*(m=Math.floor(s/5)),e.extStandardDerivatives&&!e.webgl2&&(h+="uniform vec2 polygonOffset;\n"),3===s?h=e.textureFloatHighPrecision?h+"#define VSM_EXPONENT 15.0\n\n":h+"#define VSM_EXPONENT 5.54\n\n":2===s&&(h+="#define VSM_EXPONENT 5.54\n\n"),0!==m&&(h+="uniform vec3 view_position;\n",h+="uniform float light_radius;\n"),h+=c,t.alphaTest&&(h+="float dAlpha;\n",h+=this._addMap("opacity","opacityPS",t,d),h+=d.alphaTestPS),0!==s||e.webgl2&&1!==m?1===s&&(h+="vec2 encodeFloatRG( float v ) {\n",h+="\tvec2 enc = vec2(1.0, 255.0) * v;\n",h+="\tenc = fract(enc);\n",h+="\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n",h+="\treturn enc;\n",h+="}\n\n"):h+=d.packDepthPS,h+=wa.begin(),t.alphaTest&&(h+="   getOpacity();\n",h+="   alphaTest(dAlpha);\n"),h=1===m||(1===s||2===s||3===s)&&0!==m?h+"   float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n":h+"   float depth = gl_FragCoord.z;\n",0!==s||e.webgl2&&1!==m?h=0===s||4===s?h+"   gl_FragColor = vec4(1.0);\n":1===s?h+"   gl_FragColor = vec4(encodeFloatRG(depth), encodeFloatRG(depth*depth));\n":h+d.storeEVSMPS:(e.extStandardDerivatives&&!e.webgl2&&(h+="   float minValue = 2.3374370500153186e-10; //(1.0 / 255.0) / (256.0 * 256.0 * 256.0);\n",h+="   depth += polygonOffset.x * max(abs(dFdx(depth)), abs(dFdy(depth))) + minValue * polygonOffset.y;\n"),h+="   gl_FragColor = packFloat(depth);\n"),{attributes:u,vshader:b,fshader:h+=wa.end()};if(t.customFragmentShader)return{attributes:u,vshader:b,fshader:e=h+t.customFragmentShader,tag:1};for(h=this._fsAddBaseCode(h+c,e,d,t),t.detailModes&&(h+=d.detailModesPS),c=h,h="",0<t.clearCoat&&(h+="#define CLEARCOAT\n"),_=0,y=[],g=v=!1,f=0;f<t.lights.length;f++)h+="uniform vec3 light"+f+"_color;\n",0===(m=(l=t.lights[f])._type)?h+="uniform vec3 light"+f+"_direction;\n":(h+="uniform vec3 light"+f+"_position;\n",h+="uniform float light"+f+"_radius;\n",2===m&&(h+="uniform vec3 light"+f+"_direction;\n",h+="uniform float light"+f+"_innerConeAngle;\n",h+="uniform float light"+f+"_outerConeAngle;\n")),l.castShadows&&!t.noShadow&&(h+="uniform mat4 light"+f+"_shadowMatrix;\n",h=0!==m?h+"uniform vec4 light"+f+"_shadowParams;\n":h+"uniform vec3 light"+f+"_shadowParams;\n",h=1===m?h+"uniform samplerCube light"+f+"_shadowMap;\n":l._isPcf&&e.webgl2?h+"uniform sampler2DShadow light"+f+"_shadowMap;\n":h+"uniform sampler2D light"+f+"_shadowMap;\n",_++,y[l._shadowType]=!0,l._isVsm&&(v=!0),l._isPcf&&(e.webgl2||e.extStandardDerivatives)&&2===m&&(g=!0)),l._cookie&&(l._cookie._cubemap?1===m&&(h+="uniform samplerCube light"+f+"_cookie;\n",h+="uniform float light"+f+"_cookieIntensity;\n",!l.castShadows||t.noShadow)&&(h+="uniform mat4 light"+f+"_shadowMatrix;\n"):2===m&&(h+="uniform sampler2D light"+f+"_cookie;\n",h+="uniform float light"+f+"_cookieIntensity;\n",l.castShadows&&!t.noShadow||(h+="uniform mat4 light"+f+"_shadowMatrix;\n"),l._cookieTransform&&(h+="uniform vec4 light"+f+"_cookieMatrix;\n",h+="uniform vec2 light"+f+"_cookieOffset;\n")));h+="\n",o=!t.hasTangents&&e.extStandardDerivatives?d.TBNderivativePS:t.fastTbn?d.TBNfastPS:d.TBNPS,a&&(t.normalMap?(h+=t.packedNormal?d.normalXYPS:d.normalXYZPS,t.normalDetail&&(h+=this._addMap("normalDetail","normalDetailMapPS",t,d)),f=this._getUvSourceExpression("normalMapTransform","normalMapUv",t),h=t.normalizeNormalMap?h+d.normalMapPS.replace(/\$UV/g,f):h+d.normalMapFastPS.replace(/\$UV/g,f),t.hasTangents||(o=o.replace(/\$UV/g,f)),h+=o):(h+=d.normalVertexPS,t.enableGGXSpecular&&(h+=d.TBNObjectSpacePS))),h+=wa.gammaCode(t.gamma,d),h+=wa.tonemapCode(t.toneMap,d),h+=wa.fogCode(t.fog,d),t.useRgbm&&(h+=d.rgbmPS),(s||t.prefilteredCubemap)&&(h+=t.fixSeams?d.fixCubemapSeamsStretchPS:d.fixCubemapSeamsNonePS),a&&(h+=0<t.cubeMapProjection?d.cubeMapProjectBoxPS:d.cubeMapProjectNonePS,h+=t.skyboxIntensity?d.envMultiplyPS:d.envConstPS),t.diffuseDetail&&(h+=this._addMap("diffuseDetail","diffuseDetailMapPS",t,d)),h+=this._addMap("diffuse","diffusePS",t,d),(3!==t.blendType||t.alphaTest||t.alphaToCoverage)&&(h+=this._addMap("opacity","opacityPS",t,d)),h+=this._addMap("emissive","emissivePS",t,d,t.emissiveFormat),t.useSpecular&&(i||n)&&(h=t.specularAntialias&&t.normalMap?t.normalizeNormalMap&&a?h+d.specularAaToksvigPS:h+d.specularAaToksvigFastPS:h+d.specularAaNonePS,f=t.useMetalness?"metalness":"specular",h+=this._addMap(f,f+"PS",t,d),h+=this._addMap("gloss","glossPS",t,d),2===t.fresnelModel&&(h+=d.fresnelSchlickPS)),t.heightMap&&(t.normalMap||(f=this._getUvSourceExpression("heightMapTransform","heightMapUv",t),t.hasTangents||(o=o.replace(/\$UV/g,f)),h+=o),h+=this._addMap("height","parallaxPS",t,d)),(o=t.aoMap||t.aoVertexColor)&&(h+=this._addMap("ao","aoPS",t,d),t.occludeSpecular&&(h=1===t.occludeSpecular?h+(t.occludeSpecularFloat?d.aoSpecOccSimplePS:d.aoSpecOccConstSimplePS):h+(t.occludeSpecularFloat?d.aoSpecOccPS:d.aoSpecOccConstPS))),f=t.rgbmReflection?"decodeRGBM":t.hdrReflection?"":"gammaCorrectInput",t.sphereMap?h+=f=(f=16<e.fragmentUniformsCount?d.reflectionSpherePS:d.reflectionSphereLowPS).replace(/\$texture2DSAMPLE/g,t.rgbmReflection?"texture2DRGBM":t.hdrReflection?"texture2D":"texture2DSRGB"):s?h=t.prefilteredCubemap?r?h+d.reflectionPrefilteredCubeLodPS.replace(/\$DECODE/g,f):h+d.reflectionPrefilteredCubePS.replace(/\$DECODE/g,f):h+d.reflectionCubePS.replace(/\$textureCubeSAMPLE/g,t.rgbmReflection?"textureCubeRGBM":t.hdrReflection?"textureCube":"textureCubeSRGB"):t.dpAtlas&&(h+=d.reflectionDpAtlasPS.replace(/\$texture2DSAMPLE/g,t.rgbmReflection?"texture2DRGBM":t.hdrReflection?"texture2D":"texture2DSRGB")),(s||t.sphereMap||t.dpAtlas)&&(0<t.clearCoat&&(h+=d.reflectionCCPS),t.refraction&&(h+=d.refractionPS)),0<_&&(y[0]&&(h+=d.shadowStandardPS),y[4]&&(h+=d.shadowStandardGL2PS),v&&(h+=d.shadowVSM_commonPS,y[1]&&(h+=d.shadowVSM8PS),y[2]&&(h+=e.extTextureHalfFloatLinear?d.shadowEVSMPS.replace(/\$/g,"16"):d.shadowEVSMnPS.replace(/\$/g,"16")),y[3]&&(h+=e.extTextureFloatLinear?d.shadowEVSMPS.replace(/\$/g,"32"):d.shadowEVSMnPS.replace(/\$/g,"32"))),e.webgl2||e.extStandardDerivatives||(h+=d.biasConstPS),h+=d.shadowCoordPS+d.shadowCommonPS,g&&(h+=d.shadowCoordPerspZbufferPS),0<=p&&(y[0]&&(h+=d.shadowStandardVSPS),y[4]&&(h+=d.shadowStandardGL2VSPS),v&&(y[1]&&(h+=d.shadowVSMVSPS.replace(/\$VSM/g,"VSM8").replace(/\$/g,"8")),y[2]&&(h+=d.shadowVSMVSPS.replace(/\$VSM/g,"VSM16").replace(/\$/g,"16")),y[3]&&(h+=d.shadowVSMVSPS.replace(/\$VSM/g,"VSM32").replace(/\$/g,"32"))))),t.enableGGXSpecular&&(h+="uniform float material_anisotropy;\n"),i&&(h+=d.lightDiffuseLambertPS),f=!1,t.useSpecular?(i&&(h+=0===t.shadingModel?d.lightSpecularPhongPS:t.enableGGXSpecular?d.lightSpecularAnisoGGXPS:d.lightSpecularBlinnPS),t.sphereMap||s||t.dpAtlas||0<t.fresnelModel?h=0<t.fresnelModel?t.conserveEnergy?h+d.combineDiffuseSpecularPS:h+d.combineDiffuseSpecularNoConservePS:h+d.combineDiffuseSpecularOldPS:t.diffuseMap?h+=d.combineDiffuseSpecularNoReflPS:(h+=d.combineDiffuseSpecularNoReflSeparateAmbientPS,f=!0)):h+=d.combineDiffusePS,0<t.clearCoat&&(h+=d.combineClearCoatPS),m=!0,(t.lightMap||t.lightVertexColor)&&(h+=this._addMap("light",t.dirLightMap?"lightmapDirPS":"lightmapSinglePS",t,d,t.lightMapFormat),m=t.lightMapWithoutAmbient),m&&(l=t.rgbmAmbient?"decodeRGBM":t.hdrAmbient?"":"gammaCorrectInput",h=t.ambientSH?h+d.ambientSHPS:t.prefilteredCubemap?r?h+d.ambientPrefilteredCubeLodPS.replace(/\$DECODE/g,l):h+d.ambientPrefilteredCubePS.replace(/\$DECODE/g,l):h+d.ambientConstantPS),t.ambientTint&&!f&&(h+="uniform vec3 material_ambient;\n"),t.alphaTest&&(h+=d.alphaTestPS),t.msdf&&(h+=d.msdfPS),a&&(h+=d.viewDirPS,t.useSpecular&&(h+=t.enableGGXSpecular?d.reflDirAnisoPS:d.reflDirPS)),g=v=y=_=r=!1,h=this._fsAddStartCode(h,e,d,t),a&&(h=t.twoSidedLighting?h+"   dVertexNormalW = gl_FrontFacing ? vNormalW : -vNormalW;\n":h+"   dVertexNormalW = vNormalW;\n",(t.heightMap||t.normalMap)&&t.hasTangents&&(t.twoSidedLighting?(h+="   dTangentW = gl_FrontFacing ? vTangentW : -vTangentW;\n",h+="   dBinormalW = gl_FrontFacing ? vBinormalW : -vBinormalW;\n"):(h+="   dTangentW = vTangentW;\n",h+="   dBinormalW = vBinormalW;\n"))),l=!1,3!==t.blendType||t.alphaTest||t.alphaToCoverage?t.heightMap&&t.opacityMap?l=!0:(h+="   getOpacity();\n",t.alphaTest&&(h+="   alphaTest(dAlpha);\n")):h+="   dAlpha = 1.0;\n";var x=!1;if(a&&(h+="   getViewDir();\n",(t.heightMap||t.normalMap||t.enableGGXSpecular)&&(h+="   getTBN();\n"),t.heightMap&&(h+="   getParallax();\n"),l&&(h+="   getOpacity();\n",t.alphaTest&&(h+="   alphaTest(dAlpha);\n")),h+="   getNormal();\n",t.useSpecular&&(t.enableGGXSpecular&&(h+="   getGlossiness();\n",x=!0),h+="   getReflDir();\n")),h+="   getAlbedo();\n",(i&&t.useSpecular||n)&&(h+="   getSpecularity();\n",x||(h+="   getGlossiness();\n"),0<t.fresnelModel&&(h+="   getFresnel();\n")),m&&(h+="   addAmbient();\n"),t.ambientTint&&!f&&(h+="   dDiffuseLight *= material_ambient;\n"),o&&!t.occludeDirect&&(h+="\tapplyAO();\n"),(t.lightMap||t.lightVertexColor)&&(h+="   addLightMap();\n"),i||n){for((s||t.sphereMap||t.dpAtlas)&&(0<t.clearCoat&&(h+="   addReflectionCC();\n"),h+="   addReflection();\n"),t.dirLightMap&&(h+="   addDirLightMap();\n"),f=0;f<t.lights.length;f++){if(n=!1,0===(m=(l=t.lights[f])._type)?(h+="   dLightDirNormW = light"+f+"_direction;\n",h+="   dAtten = 1.0;\n"):(l._cookie&&(2!==m||l._cookie._cubemap?1===m&&l._cookie._cubemap&&(n=g=!0):n=g=!0),h+="   getLightDirPoint(light"+f+"_position);\n",r=!0,n&&(h=2===m?h+"   dAtten3 = getCookie2D"+(l._cookieFalloff?"":"Clip")+(l._cookieTransform?"Xform":"")+"(light"+f+"_cookie, light"+f+"_shadowMatrix, light"+f+"_cookieIntensity"+(l._cookieTransform?", light"+f+"_cookieMatrix, light"+f+"_cookieOffset":"")+")."+l._cookieChannel+";\n":h+"   dAtten3 = getCookieCube(light"+f+"_cookie, light"+f+"_shadowMatrix, light"+f+"_cookieIntensity)."+l._cookieChannel+";\n"),0===l._falloffMode?(h+="   dAtten = getFalloffLinear(light"+f+"_radius);\n",_=!0):(h+="   dAtten = getFalloffInvSquared(light"+f+"_radius);\n",y=!0),h+="   if (dAtten > 0.00001) {\n",2!==m||n&&!l._cookieFalloff||(h+="\t   dAtten *= getSpotEffect(light"+f+"_direction, light"+f+"_innerConeAngle, light"+f+"_outerConeAngle);\n",v=!0)),h+="\t   dAtten *= getLightDiffuse();\n",l.castShadows&&!t.noShadow){if(1===l._shadowType){a="VSM8";var S="0.0"}else 2===l._shadowType?(a="VSM16",S="5.54"):3===l._shadowType?(a="VSM32",S=e.textureFloatHighPrecision?"15.0":"5.54"):a=4===l._shadowType?"PCF5x5":"PCF3x3";null!==a&&(1===m?(i="(light"+f+"_shadowMap, light"+f+"_shadowParams);\n",l._normalOffsetBias&&(h+="\t   normalOffsetPointShadow(light"+f+"_shadowParams);\n"),h+="\t   dAtten *= getShadowPoint"+a+i):(p===f?a+="VS":(i="(light"+f+"_shadowMatrix, light"+f+"_shadowParams);\n",h+=this._nonPointShadowMapProjection(e,t.lights[f],i)),2===m&&(a="Spot"+a),h+="\t   dAtten *= getShadow"+a+"(light"+f+"_shadowMap, light"+f+"_shadowParams"+(l._isVsm?", "+S:"")+");\n"))}h+="\t   dDiffuseLight += dAtten * light"+f+"_color"+(n?" * dAtten3":"")+";\n",0<t.clearCoat&&(h+="\t   ccSpecularLight += getLightSpecularCC() * dAtten * light"+f+"_color"+(n?" * dAtten3":"")+";\n"),t.useSpecular&&(h+="\t   dAtten *= getLightSpecular();\n",h+="\t   dSpecularLight += dAtten * light"+f+"_color"+(n?" * dAtten3":"")+";\n"),0!==m&&(h+="   }\n"),h+="\n"}(s||t.sphereMap||t.dpAtlas)&&t.refraction&&(h+="   addRefraction();\n")}return h+="\n",o&&(t.occludeDirect&&(h+="\tapplyAO();\n"),t.occludeSpecular&&(h+="\toccludeSpecular();\n")),h+=d.endPS,h=2===t.blendType||6===t.blendType||t.alphaToCoverage?h+d.outputAlphaPS:4===t.blendType?h+d.outputAlphaPremulPS:h+d.outputAlphaOpaquePS,t.msdf&&(h+="   gl_FragColor = applyMsdf(gl_FragColor);\n"),h+="\n",h+=wa.end(),r&&(h=d.lightDirPointPS+h),_&&(h=d.falloffLinearPS+h),y&&(h=d.falloffInvSquaredPS+h),v&&(h=d.spotPS+h),g&&(h=d.cookiePS+h),e="",h.includes("dReflection")&&(e+="vec4 dReflection;\n"),h.includes("dTBN")&&(e+="mat3 dTBN;\n"),h.includes("dAlbedo")&&(e+="vec3 dAlbedo;\n"),h.includes("dEmission")&&(e+="vec3 dEmission;\n"),h.includes("dNormalW")&&(e+="vec3 dNormalW;\n"),h.includes("dVertexNormalW")&&(e+="vec3 dVertexNormalW;\n"),h.includes("dTangentW")&&(e+="vec3 dTangentW;\n"),h.includes("dBinormalW")&&(e+="vec3 dBinormalW;\n"),h.includes("dViewDirW")&&(e+="vec3 dViewDirW;\n"),h.includes("dReflDirW")&&(e+="vec3 dReflDirW;\n"),h.includes("dDiffuseLight")&&(e+="vec3 dDiffuseLight;\n"),h.includes("dSpecularLight")&&(e+="vec3 dSpecularLight;\n"),h.includes("dLightDirNormW")&&(e+="vec3 dLightDirNormW;\n"),h.includes("dLightDirW")&&(e+="vec3 dLightDirW;\n"),h.includes("dLightPosW")&&(e+="vec3 dLightPosW;\n"),h.includes("dShadowCoord")&&(e+="vec3 dShadowCoord;\n"),h.includes("dNormalMap")&&(e+="vec3 dNormalMap;\n"),h.includes("dSpecularity")&&(e+="vec3 dSpecularity;\n"),h.includes("dUvOffset")&&(e+="vec2 dUvOffset;\n"),h.includes("dGlossiness")&&(e+="float dGlossiness;\n"),h.includes("dAlpha")&&(e+="float dAlpha;\n"),h.includes("dAtten")&&(e+="float dAtten;\n"),h.includes("dAtten3")&&(e+="vec3 dAtten3;\n"),h.includes("dAo")&&(e+="float dAo;\n"),h.includes("dMsdf")&&(e+="vec4 dMsdf;\n"),h.includes("ccReflection")&&(e+="vec4 ccReflection;\n"),h.includes("ccNormalW")&&(e+="vec3 ccNormalW;\n"),h.includes("ccReflDirW")&&(e+="vec3 ccReflDirW;\n"),h.includes("ccSpecularLight")&&(e+="vec3 ccSpecularLight;\n"),h.includes("ccSpecularity")&&(e+="vec3 ccSpecularity;\n"),h.includes("ccGlossiness")&&(e+="float ccGlossiness=0.9;\n"),{attributes:u,vshader:b,fshader:e=h=c+e+h,tag:1}}},Object.assign(Y.prototype,{destroy:function(){this.device.destroyShader(this)}});var Ma={alphaTestPS:"uniform float alpha_ref;\nvoid alphaTest(float a) {\n    if (a < alpha_ref) discard;\n}\n\n",ambientConstantPS:"\nvoid addAmbient() {\n    dDiffuseLight += light_globalAmbient;\n}\n",ambientPrefilteredCubePS:"#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nvoid addAmbient() {\n    vec3 fixedReflDir = fixSeamsStatic(dNormalW, 1.0 - 1.0 / 4.0);\n    fixedReflDir.x *= -1.0;\n    dDiffuseLight += processEnvironment($DECODE(textureCube(texture_prefilteredCubeMap4, fixedReflDir)).rgb);\n}\n\n",ambientPrefilteredCubeLodPS:"#ifndef PMREM4\n#define PMREM4\n#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nvoid addAmbient() {\n    vec3 fixedReflDir = fixSeamsStatic(dNormalW, 1.0 - 1.0 / 4.0);\n    fixedReflDir.x *= -1.0;\n    dDiffuseLight += processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, 5.0) ).rgb);\n}\n\n",ambientSHPS:"uniform vec3 ambientSH[9];\nvoid addAmbient() {\n    vec3 n = dNormalW;\n\n    vec3 color =\n                        ambientSH[0] +\n                        ambientSH[1] * n.x +\n                        ambientSH[2] * n.y +\n                        ambientSH[3] * n.z +\n                        ambientSH[4] * n.x * n.z +\n                        ambientSH[5] * n.z * n.y +\n                        ambientSH[6] * n.y * n.x +\n                        ambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n                        ambientSH[8] * (n.x * n.x - n.y * n.y);\n\n    dDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n}\n\n",aoPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_aoMap;\n#endif\n\nvoid applyAO() {\n    dAo = 1.0;\n\n    #ifdef MAPTEXTURE\n        dAo *= texture2D(texture_aoMap, $UV).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n        dAo *= saturate(vVertexColor.$VC);\n    #endif\n\n    dDiffuseLight *= dAo;\n}\n\n",aoSpecOccPS:"uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n    // approximated specular occlusion from AO\n    float specPow = exp2(dGlossiness * 11.0);\n    // http://research.tri-ace.com/Data/cedec2011_RealtimePBR_Implementation_e.pptx\n    float specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n    specOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n\n",aoSpecOccConstPS:"void occludeSpecular() {\n    // approximated specular occlusion from AO\n    float specPow = exp2(dGlossiness * 11.0);\n    // http://research.tri-ace.com/Data/cedec2011_RealtimePBR_Implementation_e.pptx\n    float specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n\n",aoSpecOccConstSimplePS:"void occludeSpecular() {\n    float specOcc = dAo;\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n\n",aoSpecOccSimplePS:"uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n    float specOcc = mix(1.0, dAo, material_occludeSpecularIntensity);\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n\n",bakeDirLmEndPS:"\n    vec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n\n    if (bakeDir > 0.5) {\n        if (dAtten > 0.00001) {\n            dirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n            dAtten = saturate(dAtten);\n            gl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n            gl_FragColor.a = dirLm.w + dAtten;\n            gl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n        } else {\n            gl_FragColor = dirLm;\n        }\n    } else {\n        gl_FragColor.rgb = dirLm.xyz;\n        gl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);\n    }\n\n",bakeLmEndPS:"\ngl_FragColor.rgb = dDiffuseLight;\ngl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\ngl_FragColor.rgb /= 8.0;\ngl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\ngl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\ngl_FragColor.rgb /= gl_FragColor.a;\n\n",basePS:"\nuniform vec3 view_position;\n\nuniform vec3 light_globalAmbient;\n\nfloat square(float x) {\n    return x*x;\n}\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nvec3 saturate(vec3 x) {\n    return clamp(x, vec3(0.0), vec3(1.0));\n}\n\n",baseVS:"\nattribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\n\nvec3 dPositionW;\nmat4 dModelMatrix;\nmat3 dNormalMatrix;\nvec3 dLightPosW;\nvec3 dLightDirNormW;\nvec3 dNormalW;\n\n",baseNineSlicedPS:"#define NINESLICED\n\n\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n\nvec2 nineSlicedUv;\n",baseNineSlicedVS:"#define NINESLICED\n\n\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n",baseNineSlicedTiledPS:"#define NINESLICED\n#define NINESLICETILED\n\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n\nvec2 nineSlicedUv;\n",biasConstPS:"#define SHADOWBIAS\nfloat getShadowBias(float resolution, float maxBias) {\n    return maxBias;\n}\n\n",blurVSMPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\n\n#ifdef PACKED\nfloat decodeFloatRG(vec2 rg) {\n    return rg.y*(1.0/255.0) + rg.x;\n}\n\nvec2 encodeFloatRG( float v ) {\n  vec2 enc = vec2(1.0, 255.0) * v;\n  enc = fract(enc);\n  enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n  return enc;\n}\n#endif\n\nvoid main(void) {\n    vec3 moments = vec3(0.0);\n    vec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n    for(int i=0; i<SAMPLES; i++) {\n        vec4 c = texture2D(source, uv + pixelOffset * float(i));\n\n        #ifdef PACKED\n        c.xy = vec2(decodeFloatRG(c.xy), decodeFloatRG(c.zw));\n        #endif\n\n        #ifdef GAUSS\n        moments += c.xyz * weight[i];\n        #else\n        moments += c.xyz;\n        #endif\n    }\n\n    #ifndef GAUSS\n    moments /= float(SAMPLES);\n    #endif\n\n    #ifdef PACKED\n    gl_FragColor = vec4(encodeFloatRG(moments.x), encodeFloatRG(moments.y));\n    #else\n    gl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n    #endif\n}\n\n",combineClearCoatPS:"vec3 combineColorCC() {\n    return combineColor()+(ccSpecularLight*ccSpecularity+ccReflection.rgb*ccSpecularity*ccReflection.a);\n}\n",combineDiffusePS:"vec3 combineColor() {\n    return dAlbedo * dDiffuseLight;\n}\n\n",combineDiffuseSpecularPS:"vec3 combineColor() {\n    return mix(dAlbedo * dDiffuseLight, dSpecularLight + dReflection.rgb * dReflection.a, dSpecularity);\n}\n\n",combineDiffuseSpecularNoConservePS:"vec3 combineColor() {\n    return dAlbedo * dDiffuseLight + (dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity;\n}\n\n",combineDiffuseSpecularNoReflPS:"vec3 combineColor() {\n    return dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity;\n}\n\n",combineDiffuseSpecularNoReflSeparateAmbientPS:"uniform vec3 material_ambient;\nvec3 combineColor() {\n    return (dDiffuseLight - light_globalAmbient) * dAlbedo + dSpecularLight * dSpecularity + material_ambient * light_globalAmbient;\n}\n\n",combineDiffuseSpecularOldPS:"vec3 combineColor() {\n    return mix(dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity, dReflection.rgb, dReflection.a);\n}\n\n",cookiePS:"vec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\n\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n    return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\n\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    projPos.xy += cookieOffset;\n    vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n    return mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\n\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    projPos.xy += cookieOffset;\n    if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n    vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n    return mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\n\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n    return mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n\n",cubeMapProjectBoxPS:"uniform vec3 envBoxMin, envBoxMax;\n\nvec3 cubeMapProject(vec3 nrdir) {\n    vec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n    vec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n\n    vec3 rbminmax;\n    rbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n    rbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n    rbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n\n    float fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\n    vec3 posonbox = vPositionW + nrdir * fa;\n    vec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n    return posonbox - envBoxPos;\n}\n\n",cubeMapProjectNonePS:"vec3 cubeMapProject(vec3 dir) {\n    return dir;\n}\n\n",detailModesPS:"vec3 detailMode_mul(vec3 c1, vec3 c2) {\n    return c1 * c2;\n}\n\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n    return c1 + c2;\n}\n\n// https://en.wikipedia.org/wiki/Blend_modes#Screen\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n    return 1.0 - (1.0 - c1)*(1.0 - c2);\n}\n\n// https://en.wikipedia.org/wiki/Blend_modes#Overlay\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n    return mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));\n}\n\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n    return min(c1, c2);\n}\n\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n    return max(c1, c2);\n}\n\n",diffusePS:"#ifdef MAPCOLOR\nuniform vec3 material_diffuse;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseMap;\n#endif\n\nvoid getAlbedo() {\n    dAlbedo = vec3(1.0);\n\n    #ifdef MAPCOLOR\n        dAlbedo *= material_diffuse.rgb;\n    #endif\n\n    #ifdef MAPTEXTURE\n        dAlbedo *= gammaCorrectInput(addAlbedoDetail(texture2D(texture_diffuseMap, $UV).$CH));\n    #endif\n\n    #ifdef MAPVERTEX\n        dAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));\n    #endif\n}\n\n",diffuseDetailMapPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseDetailMap;\n#endif\n\nvec3 addAlbedoDetail(vec3 albedo) {\n    #ifdef MAPTEXTURE\n        vec3 albedoDetail = vec3(texture2D(texture_diffuseDetailMap, $UV).$CH);\n        return detailMode_$DETAILMODE(albedo, albedoDetail);\n    #else\n        return albedo;\n    #endif\n}\n\n",dilatePS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nvoid main(void) {\n    vec4 c = texture2D(source, vUv0);\n    c = c.a>0.0? c : texture2D(source, vUv0 - pixelOffset);\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, -pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, 0));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, 0));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + pixelOffset);\n    gl_FragColor = c;\n}\n\n",dpAtlasQuadPS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec4 params;\n\nvoid main(void) {\n    vec2 uv = vUv0;\n    uv = uv * 2.0 - vec2(1.0);\n    uv *= params.xy;\n    uv = uv * 0.5 + 0.5;\n    gl_FragColor = texture2D(source, uv);\n}\n",emissivePS:"#ifdef MAPCOLOR\nuniform vec3 material_emissive;\n#endif\n\n#ifdef MAPFLOAT\nuniform float material_emissiveIntensity;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_emissiveMap;\n#endif\n\nvec3 getEmission() {\n    vec3 emission = vec3(1.0);\n\n    #ifdef MAPFLOAT\n        emission *= material_emissiveIntensity;\n    #endif\n\n    #ifdef MAPCOLOR\n        emission *= material_emissive;\n    #endif\n\n    #ifdef MAPTEXTURE\n        emission *= $texture2DSAMPLE(texture_emissiveMap, $UV).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n        emission *= gammaCorrectInput(saturate(vVertexColor.$VC));\n    #endif\n\n    return emission;\n}\n\n",endPS:"  #ifdef CLEARCOAT\n   gl_FragColor.rgb = combineColorCC();\n  #else\n   gl_FragColor.rgb = combineColor();\n  #endif \n   gl_FragColor.rgb += getEmission();\n   gl_FragColor.rgb = addFog(gl_FragColor.rgb);\n   #ifndef HDR\n    gl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n    gl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n   #endif\n",envConstPS:"vec3 processEnvironment(vec3 color) {\n    return color;\n}\n\n",envMultiplyPS:"uniform float skyboxIntensity;\nvec3 processEnvironment(vec3 color) {\n    return color * skyboxIntensity;\n}\n\n",extensionPS:"",extensionVS:"\n",falloffInvSquaredPS:"float getFalloffInvSquared(float lightRadius) {\n    float sqrDist = dot(dLightDirW, dLightDirW);\n    float falloff = 1.0 / (sqrDist + 1.0);\n    float invRadius = 1.0 / lightRadius;\n\n    falloff *= 16.0;\n    falloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n\n    return falloff;\n}\n\n",falloffLinearPS:"float getFalloffLinear(float lightRadius) {\n    float d = length(dLightDirW);\n    return max(((lightRadius - d) / lightRadius), 0.0);\n}\n\n",fixCubemapSeamsNonePS:"vec3 fixSeams(vec3 vec, float mipmapIndex) {\n    return vec;\n}\n\nvec3 fixSeams(vec3 vec) {\n    return vec;\n}\n\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n    return vec;\n}\n",fixCubemapSeamsStretchPS:"vec3 fixSeams(vec3 vec, float mipmapIndex) {\n    float scale = 1.0 - exp2(mipmapIndex) / 128.0;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n\nvec3 fixSeams(vec3 vec) {\n    float scale = 1.0 - 1.0 / 128.0;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n    float scale = invRecMipSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n\n",fogExpPS:"uniform vec3 fog_color;\nuniform float fog_density;\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = exp(-depth * fog_density);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    return mix(fog_color, color, fogFactor);\n}\n",fogExp2PS:"uniform vec3 fog_color;\nuniform float fog_density;\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = exp(-depth * depth * fog_density * fog_density);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    return mix(fog_color, color, fogFactor);\n}\n",fogLinearPS:"uniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = (fog_end - depth) / (fog_end - fog_start);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    fogFactor = gammaCorrectInput(fogFactor);\n    return mix(fog_color, color, fogFactor);\n}\n",fogNonePS:"vec3 addFog(vec3 color) {\n    return color;\n}\n\n\n",fresnelSchlickPS:"// Schlick's approximation\nuniform float material_fresnelFactor; // unused\nvoid getFresnel() {\n    float fresnel = 1.0 - max(dot(dNormalW, dViewDirW), 0.0);\n    float fresnel2 = fresnel * fresnel;\n    fresnel *= fresnel2 * fresnel2;\n    fresnel *= dGlossiness * dGlossiness;\n    dSpecularity = dSpecularity + (1.0 - dSpecularity) * fresnel;\n    #ifdef CLEARCOAT\n        fresnel = 1.0 - max(dot(ccNormalW, dViewDirW), 0.0);\n        fresnel2 = fresnel * fresnel;\n        fresnel *= fresnel2 * fresnel2;\n        fresnel *= ccGlossiness * ccGlossiness;\n        ccSpecularity = ccSpecularity + (1.0 - ccSpecularity) * fresnel;\n    #endif\n}\n",fullscreenQuadPS:"varying vec2 vUv0;\nuniform sampler2D source;\n\nvoid main(void) {\n    gl_FragColor = texture2D(source, vUv0);\n}\n",fullscreenQuadVS:"attribute vec2 vertex_position;\n\nvarying vec2 vUv0;\n\nvoid main(void)\n{\n    gl_Position = vec4(vertex_position, 0.5, 1.0);\n    vUv0 = vertex_position.xy*0.5+0.5;\n}\n\n",gamma1_0PS:"vec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n    return texture2D(tex, uv);\n}\n\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n    return texture2D(tex, uv, bias);\n}\n\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n    return textureCube(tex, uvw);\n}\n\nvec3 gammaCorrectOutput(vec3 color) {\n    return color;\n}\n\nvec3 gammaCorrectInput(vec3 color) {\n    return color;\n}\n\nfloat gammaCorrectInput(float color) {\n    return color;\n}\n\nvec4 gammaCorrectInput(vec4 color) {\n    return color;\n}\n",gamma2_2PS:"vec3 gammaCorrectInput(vec3 color) {\n    return pow(color, vec3(2.2));\n}\n\nfloat gammaCorrectInput(float color) {\n    return pow(color, 2.2);\n}\n\nvec4 gammaCorrectInput(vec4 color) {\n    return vec4(pow(color.rgb, vec3(2.2)), color.a);\n}\n\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n    vec4 rgba = texture2D(tex, uv);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\n\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n    vec4 rgba = texture2D(tex, uv, bias);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\n\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n    vec4 rgba = textureCube(tex, uvw);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\n\nvec3 gammaCorrectOutput(vec3 color) {\n#ifdef HDR\n    return color;\n#else\n    color += vec3(0.0000001);\n    return pow(color, vec3(0.45));\n#endif\n}\n",genParaboloidPS:"varying vec2 vUv0;\n\nuniform samplerCube source;\nuniform vec4 params; // x = mip\n\nvoid main(void) {\n\n    vec2 uv = vUv0;\n\n    float side = uv.x < 0.5? 1.0 : -1.0;\n    vec2 tc;\n    tc.x = fract(uv.x * 2.0) * 2.0 - 1.0;\n    tc.y = uv.y * 2.0 - 1.0;\n\n    // scale projection a bit to have a little overlap for filtering\n    const float scale = 1.1;\n    tc *= scale;\n\n    vec3 dir;\n    dir.y = (dot(tc, tc) - 1.0) * side; // from 1.0 center to 0.0 borders quadratically\n    dir.xz = tc * -2.0;\n\n    dir.x *= -side * params.y; // flip original cubemap x instead of doing it at runtime\n\n    dir = fixSeams(dir, params.x);\n\n    vec4 color = textureCube(source, dir, -100.0);\n    gl_FragColor = color;\n}\n",gles3PS:"#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n#define GL2\n",gles3VS:"#define attribute in\n#define varying out\n#define texture2D texture\n#define GL2\n#define VERTEXSHADER\n",glossPS:"#ifdef MAPFLOAT\nuniform float material_shininess;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_glossMap;\n#endif\n\n#ifdef CLEARCOAT\nuniform float material_clearCoatGlossiness;\n#endif\n\nvoid getGlossiness() {\n    dGlossiness = 1.0;\n\n    #ifdef MAPFLOAT\n        dGlossiness *= material_shininess;\n    #endif\n\n    #ifdef MAPTEXTURE\n        dGlossiness *= texture2D(texture_glossMap, $UV).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n        dGlossiness *= saturate(vVertexColor.$VC);\n    #endif\n\n    dGlossiness += 0.0000001;\n\n    #ifdef CLEARCOAT\n        ccGlossiness = 1.0;\n        ccGlossiness *= material_clearCoatGlossiness;\n        ccGlossiness += 0.0000001;\n    #endif\n}\n\n",instancingVS:"\nattribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\n\n",lightDiffuseLambertPS:"float getLightDiffuse() {\n    return max(dot(dNormalW, -dLightDirNormW), 0.0);\n}\n\n",lightDirPointPS:"void getLightDirPoint(vec3 lightPosW) {\n    dLightDirW = vPositionW - lightPosW;\n    dLightDirNormW = normalize(dLightDirW);\n    dLightPosW = lightPosW;\n}\n\n",lightmapDirPS:"uniform sampler2D texture_lightMap;\nuniform sampler2D texture_dirLightMap;\n\nvoid addLightMap() {\n\n    vec3 color = $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n    vec4 dir = texture2D(texture_dirLightMap, $UV);\n\n    if (dot(dir.xyz,vec3(1.0)) < 0.00001) {\n        dDiffuseLight += color;\n        return;\n    }\n\n    dLightDirNormW = normalize(dir.xyz * 2.0 - vec3(1.0));\n\n    float vlight = saturate(dot(dLightDirNormW, -dVertexNormalW));\n    float flight = saturate(dot(dLightDirNormW, -dNormalW));\n    float nlight = (flight / max(vlight,0.01)) * 0.5;\n\n    dDiffuseLight += color * nlight * 2.0;\n}\n\nvoid addDirLightMap() {\n    vec4 dir = texture2D(texture_dirLightMap, $UV);\n    if (dot(dir.xyz,vec3(1.0)) < 0.00001) return;\n    vec3 color = $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n\n    dLightDirNormW = normalize(dir.xyz * 2.0 - vec3(1.0));\n    dSpecularLight += vec3(getLightSpecular()) * color;\n}\n\n",lightmapSinglePS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_lightMap;\n#endif\n\nvoid addLightMap() {\n    vec3 lm = vec3(1.0);\n\n    #ifdef MAPTEXTURE\n        lm *= $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n        lm *= saturate(vVertexColor.$VC);\n    #endif\n    \n    dDiffuseLight += lm;\n}\n\n",lightmapSingleVertPS:"void addLightMap() {\n    dDiffuseLight += saturate(vVertexColor.$CH);\n}\n\n",lightSpecularAnisoGGXPS:"// Anisotropic GGX\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n    float PI = 3.141592653589793;\n    float roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n    float anisotropy = material_anisotropy * roughness;\n \n    float at = max((roughness + anisotropy), roughness / 4.0);\n    float ab = max((roughness - anisotropy), roughness / 4.0);\n\n    vec3 h = normalize(normalize(-dLightDirNormW) + normalize(dViewDirW));\n\n    float NoH = dot(tNormalW, h);\n    float ToH = dot(dTBN[0], h);\n    float BoH = dot(dTBN[1], h);\n\n    float a2 = at * ab;\n    vec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n    float v2 = dot(v, v);\n    float w2 = a2 / v2;\n    float D = a2 * w2 * w2 * (1.0 / PI);\n\n    float ToV = dot(dTBN[0], dViewDirW);\n    float BoV = dot(dTBN[1], dViewDirW);\n    float ToL = dot(dTBN[0], -dLightDirNormW);\n    float BoL = dot(dTBN[1], -dLightDirNormW);\n    float NoV = dot(tNormalW, dViewDirW);\n    float NoL = dot(tNormalW, -dLightDirNormW);\n\n    float lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n    float lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n    float G = 0.5 / (lambdaV + lambdaL);\n\n    return D * G;\n}\n\nfloat getLightSpecular() {\n    return calcLightSpecular(dGlossiness, dNormalW);\n}\n\nfloat getLightSpecularCC() {\n    return calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",lightSpecularBlinnPS:"// Energy-conserving (hopefully) Blinn-Phong\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n    vec3 h = normalize( -dLightDirNormW + dViewDirW );\n    float nh = max( dot( h, tNormalW ), 0.0 );\n\n    float specPow = exp2(tGlossiness * 11.0); // glossiness is linear, power is not; 0 - 2048\n    specPow = antiAliasGlossiness(specPow);\n\n    // Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n    specPow = max(specPow, 0.0001);\n\n    return pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\n\nfloat getLightSpecular() {\n    return calcLightSpecular(dGlossiness, dNormalW);\n}\n\nfloat getLightSpecularCC() {\n    return calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",lightSpecularPhongPS:"float calcLightSpecular(float tGlossiness, vec3 tReflDirW) {\n    float specPow = tGlossiness;\n\n    specPow = antiAliasGlossiness(specPow);\n\n    // Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n    return pow(max(dot(tReflDirW, -dLightDirNormW), 0.0), specPow + 0.0001);\n}\n\nfloat getLightSpecular() {\n    return calcLightSpecular(dGlossiness, dReflDirW);\n}\n\nfloat getLightSpecularCC() {\n    return calcLightSpecular(ccGlossiness, ccReflDirW);\n}\n",metalnessPS:"void processMetalness(float metalness) {\n    const float dielectricF0 = 0.04;\n    dSpecularity = mix(vec3(dielectricF0), dAlbedo, metalness);\n    dAlbedo *= 1.0 - metalness;\n}\n\n#ifdef MAPFLOAT\nuniform float material_metalness;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_metalnessMap;\n#endif\n\n#ifdef CLEARCOAT\nuniform float material_clearCoatSpecularity;\n#endif\n\nvoid getSpecularity() {\n    float metalness = 1.0;\n\n    #ifdef MAPFLOAT\n        metalness *= material_metalness;\n    #endif\n\n    #ifdef MAPTEXTURE\n        metalness *= texture2D(texture_metalnessMap, $UV).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n        metalness *= saturate(vVertexColor.$VC);\n    #endif\n\n    processMetalness(metalness);\n\n    #ifdef CLEARCOAT\n        ccSpecularity = vec3(1.0);\n        ccSpecularity *= material_clearCoatSpecularity;\n    #endif\n}\n\n",msdfPS:"uniform sampler2D texture_msdfMap;\n\n#ifdef GL_OES_standard_derivatives\n#define USE_FWIDTH\n#endif\n\n#ifdef GL2\n#define USE_FWIDTH\n#endif\n\nfloat median(float r, float g, float b) {\n    return max(min(r, g), min(max(r, g), b));\n}\n\nfloat map (float min, float max, float v) {\n    return (v - min) / (max - min);\n}\n\n\nuniform float font_sdfIntensity; // intensity is used to boost the value read from the SDF, 0 is no boost, 1.0 is max boost\nuniform float font_pxrange;      // the number of pixels between inside and outside the font in SDF\nuniform float font_textureWidth; // the width of the texture atlas\n\nuniform vec4 outline_color;\nuniform float outline_thickness;\nuniform vec4 shadow_color;\nuniform vec2 shadow_offset;\n\nvec4 applyMsdf(vec4 color) {\n    // sample the field\n    vec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n    vec2 uvShdw = vUv0 - shadow_offset;\n    vec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n    // get the signed distance value\n    float sigDist = median(tsample.r, tsample.g, tsample.b);\n    float sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n\n    #ifdef USE_FWIDTH\n        // smoothing depends on size of texture on screen\n        vec2 w = fwidth(vUv0);\n        float smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, 0.5);\n    #else\n        float font_size = 16.0; // TODO fix this\n        // smoothing gets smaller as the font size gets bigger\n        // don't have fwidth we can approximate from font size, this doesn't account for scaling\n        // so a big font scaled down will be wrong...\n\n        float smoothing = clamp(font_pxrange / font_size, 0.0, 0.5);\n    #endif\n    float mapMin = 0.05;\n    float mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n\n    // remap to a smaller range (used on smaller font sizes)\n    float sigDistInner = map(mapMin, mapMax, sigDist);\n    float sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n    sigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n\n    float center = 0.5;\n    // calculate smoothing and use to generate opacity\n    float inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n    float outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n    float shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n\n    vec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n    tcolor = mix(tcolor, color, inside);\n\n    vec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n    tcolor = mix(scolor, tcolor, outline);\n    \n    return tcolor;\n}",normalVS:"#ifdef MORPHING_TEXTURE_BASED_NORMAL\n    uniform highp sampler2D morphNormalTex;\n#endif\n\nvec3 getNormal() {\n    #ifdef SKIN\n        dNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n    #elif defined(INSTANCING)\n        dNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n    #else\n        dNormalMatrix = matrix_normal;\n    #endif\n\n    vec3 tempNormal = vertex_normal;\n\n    #ifdef MORPHING\n        #ifdef MORPHING_NRM03\n            tempNormal += morph_weights_a[0] * morph_nrm0;\n            tempNormal += morph_weights_a[1] * morph_nrm1;\n            tempNormal += morph_weights_a[2] * morph_nrm2;\n            tempNormal += morph_weights_a[3] * morph_nrm3;\n        #endif\n        #ifdef MORPHING_NRM47\n            tempNormal += morph_weights_b[0] * morph_nrm4;\n            tempNormal += morph_weights_b[1] * morph_nrm5;\n            tempNormal += morph_weights_b[2] * morph_nrm6;\n            tempNormal += morph_weights_b[3] * morph_nrm7;\n        #endif\n    #endif\n\n    #ifdef MORPHING_TEXTURE_BASED_NORMAL\n        // apply morph offset from texture\n        vec2 morphUV = getTextureMorphCoords();\n        vec3 morphNormal = texture2D(morphNormalTex, morphUV).xyz;\n        tempNormal += morphNormal;\n    #endif\n\n    return normalize(dNormalMatrix * tempNormal);\n}\n\n",normalDetailMapPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_normalDetailMap;\nuniform float material_normalDetailMapBumpiness;\n\nvec3 blendNormals(vec3 n1, vec3 n2) {\n    // https://blog.selfshadow.com/publications/blending-in-detail/#detail-oriented\n    n1 += vec3(0, 0, 1);\n    n2 *= vec3(-1, -1, 1);\n    return normalize(n1*dot(n1, n2)/n1.z - n2);\n}\n#endif\n\nvec3 addNormalDetail(vec3 normalMap) {\n    #ifdef MAPTEXTURE\n        vec3 normalDetailMap = unpackNormal(texture2D(texture_normalDetailMap, $UV));\n        normalDetailMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness));\n        return blendNormals(normalMap, normalDetailMap);\n    #else\n        return normalMap;\n    #endif\n}\n\n",normalInstancedVS:"vec3 getNormal() {\n    dNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n    return normalize(dNormalMatrix * vertex_normal);\n}\n\n",normalMapPS:"uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n    vec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n    normalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness));\n    dNormalMap = addNormalDetail(normalMap);\n    dNormalW = dTBN * dNormalMap;\n    #ifdef CLEARCOAT\n        ccNormalW = normalize(dVertexNormalW);\n    #endif\n}\n",normalMapFastPS:"uniform sampler2D texture_normalMap;\nvoid getNormal() {\n    vec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n    dNormalMap = addNormalDetail(normalMap);\n    dNormalW = dTBN * dNormalMap;\n    #ifdef CLEARCOAT\n        ccNormalW = normalize(dVertexNormalW);\n    #endif\n}\n",normalSkinnedVS:"vec3 getNormal() {\n    dNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n    return normalize(dNormalMatrix * vertex_normal);\n}\n\n",normalVertexPS:"void getNormal() {\n    dNormalW = normalize(dVertexNormalW);\n    #ifdef CLEARCOAT\n        ccNormalW = dNormalW;\n    #endif\n}\n\n",normalXYPS:"vec3 unpackNormal(vec4 nmap) {\n    vec3 normal;\n    normal.xy = nmap.wy * 2.0 - 1.0;\n    normal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n    return normal;\n}\n\n",normalXYZPS:"vec3 unpackNormal(vec4 nmap) {\n    return nmap.xyz * 2.0 - 1.0;\n}\n\n",opacityPS:"#ifdef MAPFLOAT\nuniform float material_opacity;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_opacityMap;\n#endif\n\nvoid getOpacity() {\n    dAlpha = 1.0;\n\n    #ifdef MAPFLOAT\n        dAlpha *= material_opacity;\n    #endif\n\n    #ifdef MAPTEXTURE\n        dAlpha *= texture2D(texture_opacityMap, $UV).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n        dAlpha *= clamp(vVertexColor.$VC, 0.0, 1.0);\n    #endif\n}\n\n",outputAlphaPS:"gl_FragColor.a = dAlpha;\n",outputAlphaOpaquePS:"gl_FragColor.a = 1.0;\n",outputAlphaPremulPS:"gl_FragColor.rgb *= dAlpha;\ngl_FragColor.a = dAlpha;\n",outputCubemapPS:"varying vec2 vUv0;\n\nuniform samplerCube source;\nuniform vec4 params;\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nvec4 encodeRGBM(vec4 color) { // modified RGBM\n    color.rgb = pow(color.rgb, vec3(0.5));\n    color.rgb *= 1.0 / 8.0;\n\n    color.a = saturate( max( max( color.r, color.g ), max( color.b, 1.0 / 255.0 ) ) );\n    color.a = ceil(color.a * 255.0) / 255.0;\n\n    color.rgb /= color.a;\n    return color;\n}\n\nvoid main(void) {\n\n    vec2 st = vUv0 * 2.0 - 1.0;\n    float face = params.x;\n\n    vec3 vec;\n    if (face==0.0) {\n        vec = vec3(1, -st.y, -st.x);\n    } else if (face==1.0) {\n        vec = vec3(-1, -st.y, st.x);\n    } else if (face==2.0) {\n        vec = vec3(st.x, 1, st.y);\n    } else if (face==3.0) {\n        vec = vec3(st.x, -1, -st.y);\n    } else if (face==4.0) {\n        vec = vec3(st.x, -st.y, 1);\n    } else {\n        vec = vec3(-st.x, -st.y, -1);\n    }\n\n    gl_FragColor = textureCube(source, vec);\n    if (params.w >= 2.0) gl_FragColor = encodeRGBM(gl_FragColor);\n}\n\n",outputTex2DPS:"varying vec2 vUv0;\n\nuniform sampler2D source;\n\nvoid main(void) {\n    gl_FragColor = texture2D(source, vUv0);\n}\n\n",packDepthPS:"// Packing a float in GLSL with multiplication and mod\n// http://blog.gradientstudios.com/2012/08/23/shadow-map-improvement\nvec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\n    // combination of mod and multiplication and division works better\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res -= res.xxyz * bit_mask;\n    return res;\n}\n\n\n",packDepthMaskPS:"vec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\n    // combination of mod and multiplication and division works better\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res.x = 0.0;\n    res -= res.xxyz * bit_mask;\n    return res;\n}\n\n",parallaxPS:"uniform sampler2D texture_heightMap;\nuniform float material_heightMapFactor;\nvoid getParallax() {\n    float parallaxScale = material_heightMapFactor;\n\n    float height = texture2D(texture_heightMap, $UV).$CH;\n    height = height * parallaxScale - parallaxScale*0.5;\n    vec3 viewDirT = dViewDirW * dTBN;\n\n    viewDirT.z += 0.42;\n    dUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n\n",particlePS:"varying vec4 texCoordsAlphaLife;\n\nuniform sampler2D colorMap;\nuniform sampler2D colorParam;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n\nuniform float softening;\nuniform float colorMult;\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    float depth = dot(rgbaDepth, bitShift);\n    return depth;\n}\n#endif\n\nvoid main(void) {\n    vec4 tex         = texture2DSRGB(colorMap, texCoordsAlphaLife.xy);\n    vec4 ramp     = texture2DSRGB(colorParam, vec2(texCoordsAlphaLife.w, 0.0));\n    ramp.rgb *= colorMult;\n\n    ramp.a += texCoordsAlphaLife.z;\n\n    vec3 rgb =     tex.rgb * ramp.rgb;\n    float a =         tex.a * ramp.a;\n",particleVS:"\nvec3 unpack3NFloats(float src) {\n    float r = fract(src);\n    float g = fract(src * 256.0);\n    float b = fract(src * 65536.0);\n    return vec3(r, g, b);\n}\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc) {\n    return mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\n\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc, out vec3 w) {\n    vec4 a = texture2D(tex,tc);\n    vec4 b = texture2D(tex,tc + graphSampleSize);\n    float c = fract(tc.x*graphNumSamples);\n\n    vec3 unpackedA = unpack3NFloats(a.w);\n    vec3 unpackedB = unpack3NFloats(b.w);\n    w = mix(unpackedA, unpackedB, c);\n\n    return mix(a, b, c);\n}\n\n\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n    float c = cos(pRotation);\n    float s = sin(pRotation);\n\n    mat2 m = mat2(c, -s, s, c);\n    rotMatrix = m;\n\n    return m * quadXY;\n}\n\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n   vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n   return pos;\n}\n\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY) {\n    vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n    return pos;\n}\n\nvec2 safeNormalize(vec2 v) {\n    float l = length(v);\n    return (l > 1e-06) ? v / l : v;\n}\n\nvoid main(void) {\n    vec3 meshLocalPos = particle_vertexData.xyz;\n    float id = floor(particle_vertexData.w);\n\n    float rndFactor = fract(sin(id + 1.0 + seed));\n    vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\n    float uv = id / numParticlesPot;\n    readInput(uv);\n\n#ifdef LOCAL_SPACE\n    inVel = mat3(matrix_model) * inVel;\n#endif\n    vec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy); // should be removed by compiler if align/stretch is not used\n\n    float particleLifetime = lifetime;\n\n    if (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n    vec2 quadXY = meshLocalPos.xy;\n    float nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n\n    vec3 paramDiv;\n    vec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n    float scale = params.y;\n    float scaleDiv = paramDiv.x;\n    float alphaDiv = paramDiv.z;\n\n    scale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n\n#ifndef USE_MESH\n    texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#else\n    texCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#endif\n\n    vec3 particlePos = inPos;\n    vec3 particlePosMoved = vec3(0.0);\n\n    mat2 rotMatrix;\n",particleAnimFrameClampVS:"\n    float animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);\n\n",particleAnimFrameLoopVS:"\n    float animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));\n\n",particleAnimTexVS:"\n    float animationIndex;\n\n    if (animTexIndexParams.y == 1.0) {\n        animationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);\n    } else {\n        animationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);\n    }\n\n    float atlasX = (animationIndex + animFrame) * animTexTilesParams.x;\n    float atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;\n    atlasX = fract(atlasX);\n\n    texCoordsAlphaLife.xy *= animTexTilesParams.xy;\n    texCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n\n",particleInputFloatPS:"void readInput(float uv) {\n    vec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n    vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n\n    inPos = tex.xyz;\n    inVel = tex2.xyz;\n    inAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n    inShow = tex.w >= 0.0;\n    inLife = tex2.w;\n}\n\n",particleInputRgba8PS:"//RG=X, BA=Y\n//RG=Z, BA=A\n//RGB=V, A=visMode\n//RGBA=life\n\n#define PI2 6.283185307179586\n\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\n\nuniform float maxVel;\n\nfloat decodeFloatRG(vec2 rg) {\n    return rg.y*(1.0/255.0) + rg.x;\n}\n\nfloat decodeFloatRGBA( vec4 rgba ) {\n  return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\n\nvoid readInput(float uv) {\n    vec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n    vec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n    vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n    vec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n\n    inPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n    inPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n\n    inVel = tex2.xyz;\n    inVel = (inVel - vec3(0.5)) * maxVel;\n\n    inAngle = decodeFloatRG(tex1.ba) * PI2;\n    inShow = tex2.a > 0.5;\n\n    inLife = decodeFloatRGBA(tex3);\n    float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n    float maxPosLife = lifetime+1.0;\n    inLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n\n",particleOutputFloatPS:"void writeOutput() {\n    if (gl_FragCoord.y<1.0) {\n        gl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n    } else {\n        gl_FragColor = vec4(outVel, outLife);\n    }\n}\n\n",particleOutputRgba8PS:"uniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\n\nvec2 encodeFloatRG( float v ) {\n  vec2 enc = vec2(1.0, 255.0) * v;\n  enc = fract(enc);\n  enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n  return enc;\n}\n\nvec4 encodeFloatRGBA( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n  return enc;\n}\n\nvoid writeOutput() {\n    //outPos = (outPos - outBoundsCenter) / outBoundsSize + vec3(0.5);\n\n    outPos = outPos * outBoundsMul + outBoundsAdd;\n    outAngle = fract(outAngle / PI2);\n\n    outVel = (outVel / maxVel) + vec3(0.5); // TODO: mul\n\n    float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n    float maxPosLife = lifetime+1.0;\n    outLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n\n    if (gl_FragCoord.y < 1.0) {\n        gl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n    } else if (gl_FragCoord.y < 2.0) {\n        gl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n    } else if (gl_FragCoord.y < 3.0) {\n        gl_FragColor = vec4(outVel, visMode*0.5+0.5);\n    } else {\n        gl_FragColor = encodeFloatRGBA(outLife);\n    }\n}\n\n",particleUpdaterAABBPS:"uniform mat3 spawnBounds;\nuniform vec3 spawnPosInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n    vec3 pos = inBounds - vec3(0.5);\n\n    vec3 posAbs = abs(pos);\n    vec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));\n\n    vec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;\n\n    //pos = edge * mix(2.0 * pos, sign(pos), equal(maxPos, posAbs));\n    pos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);\n    pos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);\n    pos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);\n\n#ifndef LOCAL_SPACE\n    return emitterPos + spawnBounds * pos;\n#else\n    return spawnBounds * pos;\n#endif\n}\n\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n    localVelocity -= vec3(0, 0, initialVelocity);\n}\n\n",particleUpdaterEndPS:"\n    writeOutput();\n}\n\n",particleUpdaterInitPS:"varying vec2 vUv0;\n\nuniform highp sampler2D particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform highp sampler2D internalTex3;\n\nuniform mat3 emitterMatrix, emitterMatrixInv;\nuniform vec3 emitterScale;\n\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, radialSpeedDivMult, seed;\nuniform float startAngle, startAngle2;\nuniform float initialVelocity;\n\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n\n\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\n\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n",particleUpdaterNoRespawnPS:"    if (outLife >= lifetime) {\n        outLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n        visMode = -1.0;\n    }\n",particleUpdaterOnStopPS:"    visMode = outLife < 0.0? -1.0: visMode;\n\n",particleUpdaterRespawnPS:"    if (outLife >= lifetime) {\n        outLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n        visMode = 1.0;\n    }\n    visMode = outLife < 0.0? 1.0: visMode;\n\n",particleUpdaterSpherePS:"uniform float spawnBoundsSphere;\nuniform float spawnBoundsSphereInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n    float rnd4 = fract(rndFactor * 1000.0);\n    vec3 norm = normalize(inBounds.xyz - vec3(0.5));\n    float r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;\n#ifndef LOCAL_SPACE\n    return emitterPos + norm * r * spawnBoundsSphere;\n#else\n    return norm * r * spawnBoundsSphere;\n#endif\n}\n\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n    localVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n\n",particleUpdaterStartPS:"float saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nvec3 unpack3NFloats(float src) {\n    float r = fract(src);\n    float g = fract(src * 256.0);\n    float b = fract(src * 65536.0);\n    return vec3(r, g, b);\n}\n\nvec3 tex1Dlod_lerp(sampler2D tex, vec2 tc, out vec3 w) {\n    vec4 a = texture2D(tex, tc);\n    vec4 b = texture2D(tex, tc + graphSampleSize);\n    float c = fract(tc.x * graphNumSamples);\n\n    vec3 unpackedA = unpack3NFloats(a.w);\n    vec3 unpackedB = unpack3NFloats(b.w);\n    w = mix(unpackedA, unpackedB, c);\n\n    return mix(a.xyz, b.xyz, c);\n}\n\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n    vec4 p4 = fract(vec4(p) * HASHSCALE4);\n    p4 += dot(p4, p4.wzxy+19.19);\n    return fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\n\n\nvoid main(void)\n{\n    if (gl_FragCoord.x > numParticles) discard;\n\n    readInput(vUv0.x);\n    visMode = inShow? 1.0 : -1.0;\n\n    vec4 rndFactor = hash41(gl_FragCoord.x + seed);\n\n    float particleRate = rate + rateDiv * rndFactor.x;\n\n    outLife = inLife + delta;\n    float nlife = clamp(outLife / lifetime, 0.0, 1.0);\n\n    vec3 localVelocityDiv;\n    vec3 velocityDiv;\n    vec3 paramDiv;\n    vec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);\n    vec3 velocity =      tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);\n    vec3 params =        tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n    float rotSpeed = params.x;\n    float rotSpeedDiv = paramDiv.y;\n\n    vec3 radialParams = tex1Dlod_lerp(internalTex3, vec2(nlife, 0), paramDiv);\n    float radialSpeed = radialParams.x;\n    float radialSpeedDiv = radialParams.y;\n\n    bool respawn = inLife <= 0.0 || outLife >= lifetime;\n    inPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;\n    inAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;\n\n#ifndef LOCAL_SPACE\n    vec3 radialVel = inPos - emitterPos;\n#else\n    vec3 radialVel = inPos;\n#endif\n    radialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);\n    radialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;\n\n    localVelocity +=    (localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n    velocity +=         (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n    rotSpeed +=         (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n\n    addInitialVelocity(localVelocity, rndFactor.xyz);\n\n#ifndef LOCAL_SPACE\n    outVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;\n#else\n    outVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;\n#endif\n\n    outPos = inPos + outVel * delta;\n    outAngle = inAngle + rotSpeed * delta;\n",particle_billboardVS:"\n    quadXY = rotate(quadXY, inAngle, rotMatrix);\n    vec3 localPos = billboard(particlePos, quadXY);\n\n",particle_blendAddPS:"\n    rgb *= saturate(gammaCorrectInput(a));\n    if ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n\n",particle_blendMultiplyPS:"\n    rgb = mix(vec3(1.0), rgb, vec3(a));\n    if (rgb.r + rgb.g + rgb.b > 2.99) discard;\n\n",particle_blendNormalPS:"\n    if (a < 0.01) discard;\n",particle_cpuVS:"attribute vec4 particle_vertexData;     // XYZ = world pos, W = life\nattribute vec4 particle_vertexData2;     // X = angle, Y = scale, Z = alpha, W = velocity.x\nattribute vec4 particle_vertexData3;     // XYZ = particle local pos, W = velocity.y\nattribute float particle_vertexData4;     // particle id\n#ifndef USE_MESH\n#define VDATA5TYPE vec2\n#else\n#define VDATA5TYPE vec4\n#endif\nattribute VDATA5TYPE particle_vertexData5;     // VDATA4TYPE depends on useMesh property. Start with X = velocity.z, Y = particle ID and for mesh particles proceeds with Z = mesh UV.x, W = mesh UV.y\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\nuniform float seed;\n//uniform float graphSampleSize;\n//uniform float graphNumSamples;\nuniform vec3 wrapBounds, emitterScale, faceTangent, faceBinorm;\nuniform sampler2D texLifeAndSourcePosOUT;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform vec3 emitterPos;\n\nvarying vec4 texCoordsAlphaLife;\n\n\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n    float c = cos(pRotation);\n    float s = sin(pRotation);\n    //vec4 rotationMatrix = vec4(c, -s, s, c);\n\n    mat2 m = mat2(c, -s, s, c);\n    rotMatrix = m;\n\n    return m * quadXY;\n}\n\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n    vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n    return pos;\n}\n\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY)\n{\n    vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n    return pos;\n}\n\nvoid main(void)\n{\n    vec3 particlePos = particle_vertexData.xyz;\n    vec3 inPos = particlePos;\n    vec3 vertPos = particle_vertexData3.xyz;\n    vec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);\n\n    float id = floor(particle_vertexData4);\n    float rndFactor = fract(sin(id + 1.0 + seed));\n    vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\n#ifdef LOCAL_SPACE\n    inVel = mat3(matrix_model) * inVel;\n#endif\n    vec2 velocityV = normalize((mat3(matrix_view) * inVel).xy); // should be removed by compiler if align/stretch is not used\n\n    vec2 quadXY = vertPos.xy;\n    \n#ifndef USE_MESH\n    texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n#else\n    texCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);\n#endif\n    mat2 rotMatrix;\n\n    float inAngle = particle_vertexData2.x;\n    vec3 particlePosMoved = vec3(0.0);\n    vec3 meshLocalPos = particle_vertexData3.xyz;\n\n",particle_cpu_endVS:"\n    localPos *= particle_vertexData2.y * emitterScale;\n    localPos += particlePos;\n\n    gl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n",particle_customFaceVS:"\n    quadXY = rotate(quadXY, inAngle, rotMatrix);\n    vec3 localPos = customFace(particlePos, quadXY);\n",particle_endPS:"    rgb = addFog(rgb);\n    rgb = toneMap(rgb);\n    rgb = gammaCorrectOutput(rgb);\n    gl_FragColor = vec4(rgb, a);\n}\n",particle_endVS:"\n    localPos *= scale * emitterScale;\n    localPos += particlePos;\n\n    gl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n",particle_halflambertPS:"\n    vec3 negNormal = normal*0.5+0.5;\n    vec3 posNormal = -normal*0.5+0.5;\n    negNormal *= negNormal;\n    posNormal *= posNormal;\n\n\n",particle_initVS:"attribute vec4 particle_vertexData; // XYZ = particle position, W = particle ID + random factor\n#ifdef USE_MESH\nattribute vec2 particle_uv;         // mesh UV\n#endif\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale, emitterPos, faceTangent, faceBinorm;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed, delta;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\n\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n\nvarying vec4 texCoordsAlphaLife;\n\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n\n",particle_lambertPS:"\n    vec3 negNormal = max(normal, vec3(0.0));\n    vec3 posNormal = max(-normal, vec3(0.0));\n\n\n",particle_lightingPS:"\n    vec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n                        negNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n                        negNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n\n\n    rgb *= light;\n\n\n",particle_localShiftVS:"    particlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;\n\n",particle_meshVS:"\n    vec3 localPos = meshLocalPos;\n    localPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n    localPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n\n    billboard(particlePos, quadXY);\n\n\n",particle_normalVS:"\n    Normal = normalize(localPos + matrix_viewInverse[2].xyz);\n",particle_normalMapPS:"\n    vec3 normalMap         = normalize( texture2D(normalMap, texCoordsAlphaLife.xy).xyz * 2.0 - 1.0 );\n    vec3 normal = ParticleMat * normalMap;\n\n\n\n\n",particle_pointAlongVS:"    inAngle = atan(velocityV.x, velocityV.y); // not the fastest way, but easier to plug in; TODO: create rot matrix right from vectors\n\n",particle_softPS:"\n    float depth = getLinearScreenDepth();\n    float particleDepth = vDepth;\n    float depthDiff = saturate(abs(particleDepth - depth) * softening);\n    a *= depthDiff;\n",particle_softVS:"\n    vDepth = getLinearDepth(localPos);\n",particle_stretchVS:"    vec3 moveDir = inVel * stretch;\n    vec3 posPrev = particlePos - moveDir;\n    posPrev += particlePosMoved;\n\n    vec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n\n    float interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n\n    particlePos = mix(particlePos, posPrev, interpolation);\n\n",particle_TBNVS:"\n    mat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0,        rotMatrix[1][0], rotMatrix[1][1], 0.0,        0.0, 0.0, 1.0);\n    ParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n\n",particle_wrapVS:"\n    vec3 origParticlePos = particlePos;\n    particlePos -= matrix_model[3].xyz;\n    particlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n    particlePos += matrix_model[3].xyz;\n    particlePosMoved = particlePos - origParticlePos;\n\n\n",precisionTestPS:"void main(void) {\n    gl_FragColor = vec4(2147483648.0);\n}\n\n",precisionTest2PS:"uniform sampler2D source;\n\nvec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res -= res.xxyz * bit_mask;\n    return res;\n}\n\nvoid main(void) {\n    float c = texture2D(source, vec2(0.0)).r;\n    float diff = abs(c - 2147483648.0) / 2147483648.0;\n    gl_FragColor = packFloat(diff);\n}\n\n",prefilterCubemapPS:"varying vec2 vUv0;\n\nuniform samplerCube source;\nuniform vec4 params;\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nfloat rnd(vec2 uv) {\n    return fract(sin(dot(uv, vec2(12.9898, 78.233) * 2.0)) * 43758.5453);\n}\n\nconst float PI = 3.14159265358979;\nvec3 hemisphereSample_cos(vec2 uv, mat3 vecSpace, vec3 cubeDir, float gloss) { // cos + lerped cone size (better than just lerped)\n    float phi = uv.y * 2.0 * PI;\n    float cosTheta = sqrt(1.0 - uv.x);\n    float sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n    vec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n    return normalize(mix(vecSpace * sampleDir, cubeDir, params.y));\n}\n\nvec3 hemisphereSample_phong(vec2 uv, mat3 vecSpace, vec3 cubeDir, float specPow) {\n    float phi = uv.y * 2.0 * PI;\n    float cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n    float sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n    vec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n    return vecSpace * sampleDir;\n}\n\nmat3 matrixFromVector(vec3 n) { // frisvad\n    float a = 1.0 / (1.0 + n.z);\n    float b = -n.x * n.y * a;\n    vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n    vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n    return mat3(b1, b2, n);\n}\n\nvec4 encodeRGBM(vec3 color) { // modified RGBM\n    vec4 encoded;\n    encoded.rgb = pow(color.rgb, vec3(0.5));\n    encoded.rgb *= 1.0 / 8.0;\n\n    encoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n    encoded.a = ceil(encoded.a * 255.0) / 255.0;\n\n    encoded.rgb /= encoded.a;\n    return encoded;\n}\n\nvoid main(void) {\n\n    vec2 st = vUv0 * 2.0 - 1.0;\n\n    if (params.w==1.0 || params.w==3.0) {\n        st = 2.0 * floor(gl_FragCoord.xy) / (params.z - 1.0) - 1.0;\n    }\n\n    float face = params.x;\n\n    vec3 vec;\n    if (face==0.0) {\n        vec = vec3(1, -st.y, -st.x);\n    } else if (face==1.0) {\n        vec = vec3(-1, -st.y, st.x);\n    } else if (face==2.0) {\n        vec = vec3(st.x, 1, st.y);\n    } else if (face==3.0) {\n        vec = vec3(st.x, -1, -st.y);\n    } else if (face==4.0) {\n        vec = vec3(st.x, -st.y, 1);\n    } else {\n        vec = vec3(-st.x, -st.y, -1);\n    }\n\n    mat3 vecSpace = matrixFromVector(normalize(vec));\n\n    vec3 color = vec3(0.0);\n    const int samples = $NUMSAMPLES;\n    vec3 vect;\n    for(int i=0; i<samples; i++) {\n        float sini = sin(float(i));\n        float cosi = cos(float(i));\n        float rand = rnd(vec2(sini, cosi));\n\n        vect = hemisphereSample_$METHOD(vec2(float(i) / float(samples), rand), vecSpace, vec, params.y);\n\n        color += $textureCube(source, vect).rgb;\n    }\n    color /= float(samples);\n\n    gl_FragColor = params.w < 2.0? vec4(color, 1.0) : encodeRGBM(color);\n}\n",reflDirPS:"void getReflDir() {\n    dReflDirW = normalize(-reflect(dViewDirW, dNormalW));\n    #ifdef CLEARCOAT\n        ccReflDirW = normalize(-reflect(dViewDirW, ccNormalW));\n    #endif    \n}\n\n",reflDirAnisoPS:"void getReflDir() {\n    float roughness = sqrt(1.0 - min(dGlossiness, 1.0));\n    float anisotropy = material_anisotropy * roughness;\n    vec3 anisotropicDirection = anisotropy >= 0.0 ? dTBN[1] : dTBN[0];\n    vec3 anisotropicTangent = cross(anisotropicDirection, dViewDirW);\n    vec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n    vec3 bentNormal = normalize(mix(normalize(dNormalW), normalize(anisotropicNormal), anisotropy));\n    dReflDirW = reflect(-dViewDirW, bentNormal);\n    #ifdef CLEARCOAT\n        ccReflDirW = normalize(-reflect(dViewDirW, ccNormalW));\n    #endif    \n}\n\n",reflectionCCPS:"#ifdef CLEARCOAT\nuniform float material_clearCoatReflectivity;\nvoid addReflectionCC() {    \n    ccReflection += vec4(calcReflection(ccReflDirW, ccGlossiness), material_clearCoatReflectivity); \n}\n#endif\n",reflectionCubePS:"uniform samplerCube texture_cubeMap;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n    vec3 lookupVec = fixSeams(cubeMapProject(tReflDirW));\n    lookupVec.x *= -1.0;\n    return $textureCubeSAMPLE(texture_cubeMap, lookupVec).rgb;\n}\n\nuniform float material_reflectivity;\nvoid addReflection() {   \n    dReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionDpAtlasPS:"uniform sampler2D texture_sphereMap;\n\nvec2 getDpAtlasUv(vec2 uv, float mip) {\n\n    vec4 rect;\n    float sx = saturate(mip - 2.0);\n    rect.x = sx * 0.5;\n\n    float t = mip - rect.x * 6.0;\n    float i = 1.0 - rect.x;\n    rect.y = min(t * 0.5, 0.75) * i + rect.x;\n\n    float st = saturate(t);\n    rect.z = (1.0 - st * 0.5) * i;\n    rect.w = rect.z * 0.5;\n\n    float rcRectZ = 1.0 / rect.z;\n    float scaleFactor = 0.00390625 * rcRectZ; // 0.0078125 = (256 + 2) / 256 - 1, 0.00390625 same for 512\n    vec2 scale = vec2(scaleFactor, scaleFactor * 2.0);\n    uv = uv * (vec2(1.0) - scale) + scale * 0.5;\n\n    uv = uv * rect.zw + rect.xy;\n\n    return uv;\n}\n\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n    vec3 reflDir = normalize(cubeMapProject(tReflDirW));\n\n    // Convert vector to DP coords\n    bool up = reflDir.y > 0.0;\n    float scale = 0.90909090909090909090909090909091;// 1.0 / 1.1;\n    vec3 reflDirWarp = reflDir.xzx * vec3(-0.25, 0.5, 0.25);\n    float reflDirVer = abs(reflDir.y) + 1.0;\n    reflDirWarp /= reflDirVer;\n    reflDirWarp *= scale;\n    reflDirWarp = vec3(0.75, 0.5, 0.25) - reflDirWarp;\n    vec2 tc = up? reflDirWarp.xy : reflDirWarp.zy;\n\n    float bias = saturate(1.0 - tGlossiness) * 5.0; // multiply by max mip level\n\n    float mip = floor(bias);\n    vec3 tex1 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n\n    mip = min(mip + 1.0, 5.0);\n    vec3 tex2 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n\n    tex1 = mix(tex1, tex2, fract(bias));\n    tex1 = processEnvironment(tex1);\n\n    return tex1;\n}\n\nuniform float material_reflectivity;\nvoid addReflection() {   \n    dReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionPrefilteredCubePS:"uniform samplerCube texture_prefilteredCubeMap128;\nuniform samplerCube texture_prefilteredCubeMap64;\nuniform samplerCube texture_prefilteredCubeMap32;\nuniform samplerCube texture_prefilteredCubeMap16;\nuniform samplerCube texture_prefilteredCubeMap8;\n#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n    // Unfortunately, WebGL doesn't allow us using textureCubeLod. Therefore bunch of nasty workarounds is required.\n    // We fix mip0 to 128x128, so code is rather static.\n    // Mips smaller than 4x4 aren't great even for diffuse. Don't forget that we don't have bilinear filtering between different faces.\n\n    float bias = saturate(1.0 - tGlossiness) * 5.0; // multiply by max mip level\n    int index1 = int(bias);\n    int index2 = int(min(bias + 1.0, 7.0));\n\n    vec3 fixedReflDir = fixSeams(cubeMapProject(tReflDirW), bias);\n    fixedReflDir.x *= -1.0;\n\n    vec4 cubes[6];\n    cubes[0] = textureCube(texture_prefilteredCubeMap128, fixedReflDir);\n    cubes[1] = textureCube(texture_prefilteredCubeMap64, fixedReflDir);\n    cubes[2] = textureCube(texture_prefilteredCubeMap32, fixedReflDir);\n    cubes[3] = textureCube(texture_prefilteredCubeMap16, fixedReflDir);\n    cubes[4] = textureCube(texture_prefilteredCubeMap8, fixedReflDir);\n    cubes[5] = textureCube(texture_prefilteredCubeMap4, fixedReflDir);\n\n    // Also we don't have dynamic indexing in PS, so...\n    vec4 cube[2];\n    for(int i = 0; i < 6; i++) {\n        if (i == index1) {\n            cube[0] = cubes[i];\n        }\n        if (i == index2) {\n            cube[1] = cubes[i];\n        }\n    }\n\n    // another variant\n    /*if (index1==0){ cube[0]=cubes[0];\n    }else if (index1==1){ cube[0]=cubes[1];\n    }else if (index1==2){ cube[0]=cubes[2];\n    }else if (index1==3){ cube[0]=cubes[3];\n    }else if (index1==4){ cube[0]=cubes[4];\n    }else if (index1==5){ cube[0]=cubes[5];}\n\n    if (index2==0){ cube[1]=cubes[0];\n    }else if (index2==1){ cube[1]=cubes[1];\n    }else if (index2==2){ cube[1]=cubes[2];\n    }else if (index2==3){ cube[1]=cubes[3];\n    }else if (index2==4){ cube[1]=cubes[4];\n    }else if (index2==5){ cube[1]=cubes[5];}*/\n\n    vec4 cubeFinal = mix(cube[0], cube[1], fract(bias));\n    vec3 refl = processEnvironment($DECODE(cubeFinal).rgb);\n\n    return refl;\n}\n\nuniform float material_reflectivity;\nvoid addReflection() {   \n    dReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionPrefilteredCubeLodPS:"\n#ifndef PMREM4\n#define PMREM4\n#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n    float bias = saturate(1.0 - tGlossiness) * 5.0; // multiply by max mip level\n    vec3 fixedReflDir = fixSeams(cubeMapProject(tReflDirW), bias);\n    fixedReflDir.x *= -1.0;\n\n    vec3 refl = processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, bias) ).rgb);\n\n    return refl;\n}\n\nuniform float material_reflectivity;\nvoid addReflection() {   \n    dReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionSpherePS:"#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n    vec3 reflDirV = (mat3(matrix_view) * tReflDirW).xyz;\n\n    float m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n    vec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\n    return $texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb;\n}\n\nuniform float material_reflectivity;\nvoid addReflection() {   \n    dReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionSphereLowPS:"uniform sampler2D texture_sphereMap;\n\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n    vec3 reflDirV = vNormalV;\n\n    vec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;\n    return $texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb;\n}\n\nuniform float material_reflectivity;\nvoid addReflection() {   \n    dReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",refractionPS:"uniform float material_refraction, material_refractionIndex;\n\nvec3 refract2(vec3 viewVec, vec3 Normal, float IOR) {\n    float vn = dot(viewVec, Normal);\n    float k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n    vec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * Normal;\n    return refrVec;\n}\n\nvoid addRefraction() {\n\n    // use same reflection code with refraction vector\n    vec3 tmp = dReflDirW;\n    vec4 tmp2 = dReflection;\n    dReflection = vec4(0.0);\n    dReflDirW = refract2(-dViewDirW, dNormalW, material_refractionIndex);\n\n    addReflection();\n\n    dDiffuseLight = mix(dDiffuseLight, dReflection.rgb * dAlbedo, material_refraction);\n    dReflDirW = tmp;\n    dReflection = tmp2;\n}\n\n",rgbmPS:"vec3 decodeRGBM(vec4 rgbm) {\n    vec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n    return color * color;\n}\n\nvec3 texture2DRGBM(sampler2D tex, vec2 uv) {\n    return decodeRGBM(texture2D(tex, uv));\n}\n\nvec3 textureCubeRGBM(samplerCube tex, vec3 uvw) {\n    return decodeRGBM(textureCube(tex, uvw));\n}\n\n",screenDepthPS:"uniform sampler2D uDepthMap;\n\n#ifndef SCREENSIZE\n#define SCREENSIZE\nuniform vec4 uScreenSize;\n#endif\n\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params; // 1 / camera_far,      camera_far,     (1 - f / n) / 2,        (1 + f / n) / 2\n#endif\n\n#ifdef GL2\n    float linearizeDepth(float z) {\n        z = z * 2.0 - 1.0;\n        return 1.0 / (camera_params.z * z + camera_params.w);\n    }\n#else\n    #ifndef UNPACKFLOAT\n    #define UNPACKFLOAT\n    float unpackFloat(vec4 rgbaDepth) {\n        const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n        return dot(rgbaDepth, bitShift);\n    }\n    #endif\n#endif\n\n// Retrieves rendered linear camera depth by UV\nfloat getLinearScreenDepth(vec2 uv) {\n    #ifdef GL2\n        return linearizeDepth(texture2D(uDepthMap, uv).r) * camera_params.y;\n    #else\n        return unpackFloat(texture2D(uDepthMap, uv)) * camera_params.y;\n    #endif\n}\n\n#ifndef VERTEXSHADER\n// Retrieves rendered linear camera depth under the current pixel\nfloat getLinearScreenDepth() {\n    vec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n    return getLinearScreenDepth(uv);\n}\n#endif\n\n// Generates linear camera depth for the given world position\nfloat getLinearDepth(vec3 pos) {\n    return -(matrix_view * vec4(pos, 1.0)).z;\n}\n",shadowCommonPS:"void normalOffsetPointShadow(vec4 shadowParams) {\n    float distScale = length(dLightDirW);\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale; //0.02\n    vec3 dir = wPos - dLightPosW;\n    dLightDirW = dir;\n}\n\n",shadowCoordPS:"void _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    dShadowCoord = (shadowMatrix * vec4(wPos, 1.0)).xyz;\n    dShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\n    #ifdef SHADOWBIAS\n        dShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n    #endif\n}\n\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    projPos.xy /= projPos.w;\n    dShadowCoord.xy = projPos.xy;\n    dShadowCoord.z = length(dLightDirW) * shadowParams.w;\n\n    #ifdef SHADOWBIAS\n        dShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n    #endif\n}\n\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\n\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams) {\n    _getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\n\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n    float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\n    _getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\n\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0); //0.08\n\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n\n",shadowCoordVS:"void getLightDirPoint(vec3 lightPosW) {\n    vec3 lightDirW = vPositionW - lightPosW;\n    dLightDirNormW = normalize(lightDirW);\n    dLightPosW = lightPosW;\n}\n\nvoid _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    vMainShadowUv = projPos;\n}\n\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    vMainShadowUv = projPos;\n}\n\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\n\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\n\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n    float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n    vec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\n    _getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\n\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n    vec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0); //0.08\n\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n\n",shadowCoordPerspZbufferPS:"void _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    projPos.xyz /= projPos.w;\n    dShadowCoord = projPos.xyz;\n    // depth bias is already applied on render\n}\n\nvoid getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n    float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n    _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\n\nvoid getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams) {\n    _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, vPositionW);\n}\n\n",shadowEVSMPS:"float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n    vec3 moments = texture2D(tex, texCoords).xyz;\n    return calculateEVSM(moments, Z, vsmBias, exponent);\n}\n\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\n\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n\n",shadowEVSMnPS:"float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n    float pixelSize = 1.0 / resolution;\n    texCoords -= vec2(pixelSize);\n    vec3 s00 = texture2D(tex, texCoords).xyz;\n    vec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;\n    vec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;\n    vec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;\n    vec2 fr = fract(texCoords * resolution);\n    vec3 h0 = mix(s00, s10, fr.x);\n    vec3 h1 = mix(s01, s11, fr.x);\n    vec3 moments = mix(h0, h1, fr.y);\n    return calculateEVSM(moments, Z, vsmBias, exponent);\n}\n\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\n\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n\n",shadowStandardPS:"vec3 lessThan2(vec3 a, vec3 b) {\n    return clamp((b - a)*1000.0, 0.0, 1.0); // softer version\n}\n\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    return dot(rgbaDepth, bitShift);\n}\n#endif\n\n// ----- Direct/Spot Sampling -----\n\n#ifdef GL2\n    float _getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n        float z = dShadowCoord.z;\n        vec2 uv = dShadowCoord.xy * shadowParams.x; // 1 unit - 1 texel\n        float shadowMapSizeInv = 1.0 / shadowParams.x;\n        vec2 base_uv = floor(uv + 0.5);\n        float s = (uv.x + 0.5 - base_uv.x);\n        float t = (uv.y + 0.5 - base_uv.y);\n        base_uv -= vec2(0.5);\n        base_uv *= shadowMapSizeInv;\n\n        float sum = 0.0;\n\n        float uw0 = (3.0 - 2.0 * s);\n        float uw1 = (1.0 + 2.0 * s);\n\n        float u0 = (2.0 - s) / uw0 - 1.0;\n        float u1 = s / uw1 + 1.0;\n\n        float vw0 = (3.0 - 2.0 * t);\n        float vw1 = (1.0 + 2.0 * t);\n\n        float v0 = (2.0 - t) / vw0 - 1.0;\n        float v1 = t / vw1 + 1.0;\n\n        u0 = u0 * shadowMapSizeInv + base_uv.x;\n        v0 = v0 * shadowMapSizeInv + base_uv.y;\n\n        u1 = u1 * shadowMapSizeInv + base_uv.x;\n        v1 = v1 * shadowMapSizeInv + base_uv.y;\n\n        sum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n        sum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n        sum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n        sum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\n        sum *= 1.0f / 16.0;\n        return sum;\n    }\n\n    float getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams);\n    }\n\n    float getShadowSpotPCF3x3(sampler2DShadow shadowMap, vec4 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n    }\n#else\n    float _xgetShadowPCF3x3(mat3 depthKernel, sampler2D shadowMap, vec3 shadowParams) {\n        mat3 shadowKernel;\n        vec3 shadowCoord = dShadowCoord;\n        vec3 shadowZ = vec3(shadowCoord.z);\n        shadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));\n        shadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));\n        shadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));\n\n        vec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );\n\n        shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n        shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\n        vec4 shadowValues;\n        shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n        shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n        shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n        shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\n        return dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n    }\n\n    float _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n        vec3 shadowCoord = dShadowCoord;\n\n        float xoffset = 1.0 / shadowParams.x; // 1/shadow map width\n        float dx0 = -xoffset;\n        float dx1 = xoffset;\n\n        mat3 depthKernel;\n        depthKernel[0][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n        depthKernel[0][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n        depthKernel[0][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n        depthKernel[1][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n        depthKernel[1][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy));\n        depthKernel[1][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n        depthKernel[2][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n        depthKernel[2][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n        depthKernel[2][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n\n        return _xgetShadowPCF3x3(depthKernel, shadowMap, shadowParams);\n    }\n\n    float getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams);\n    }\n\n    float getShadowSpotPCF3x3(sampler2D shadowMap, vec4 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n    }\n#endif\n\n\n// ----- Point Sampling -----\n\nfloat _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {\n\n    vec3 tc = normalize(dir);\n    vec3 tcAbs = abs(tc);\n\n    vec4 dirX = vec4(1,0,0, tc.x);\n    vec4 dirY = vec4(0,1,0, tc.y);\n    float majorAxisLength = tc.z;\n    if ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n        dirX = vec4(0,0,1, tc.z);\n        dirY = vec4(0,1,0, tc.y);\n        majorAxisLength = tc.x;\n    } else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n        dirX = vec4(1,0,0, tc.x);\n        dirY = vec4(0,0,1, tc.z);\n        majorAxisLength = tc.y;\n    }\n\n    float shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);\n\n    vec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);\n    vec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);\n    vec3 dx0 = -xoffset;\n    vec3 dy0 = -yoffset;\n    vec3 dx1 = xoffset;\n    vec3 dy1 = yoffset;\n\n    mat3 shadowKernel;\n    mat3 depthKernel;\n\n    depthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n    depthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n    depthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n    depthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n    depthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n    depthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n    depthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n    depthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n    depthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n\n    vec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);\n\n    shadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n    shadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n    shadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n\n    vec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n\n    vec2 fractionalCoord = fract( uv * shadowParams.x );\n\n    shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n    shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\n    vec4 shadowValues;\n    shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n    shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n    shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n    shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\n    return 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\n\nfloat getShadowPointPCF3x3(samplerCube shadowMap, vec4 shadowParams) {\n    return _getShadowPoint(shadowMap, shadowParams, dLightDirW);\n}\n\n",shadowStandardGL2PS:"float _getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n    // http://the-witness.net/news/2013/09/shadow-mapping-summary-part-1/\n\n    float z = dShadowCoord.z;\n    vec2 uv = dShadowCoord.xy * shadowParams.x; // 1 unit - 1 texel\n    float shadowMapSizeInv = 1.0 / shadowParams.x;\n    vec2 base_uv = floor(uv + 0.5);\n    float s = (uv.x + 0.5 - base_uv.x);\n    float t = (uv.y + 0.5 - base_uv.y);\n    base_uv -= vec2(0.5);\n    base_uv *= shadowMapSizeInv;\n\n\n    float uw0 = (4.0 - 3.0 * s);\n    float uw1 = 7.0;\n    float uw2 = (1.0 + 3.0 * s);\n\n    float u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n    float u1 = (3.0 + s) / uw1;\n    float u2 = s / uw2 + 2.0;\n\n    float vw0 = (4.0 - 3.0 * t);\n    float vw1 = 7.0;\n    float vw2 = (1.0 + 3.0 * t);\n\n    float v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n    float v1 = (3.0 + t) / vw1;\n    float v2 = t / vw2 + 2.0;\n\n    float sum = 0.0;\n\n    u0 = u0 * shadowMapSizeInv + base_uv.x;\n    v0 = v0 * shadowMapSizeInv + base_uv.y;\n\n    u1 = u1 * shadowMapSizeInv + base_uv.x;\n    v1 = v1 * shadowMapSizeInv + base_uv.y;\n\n    u2 = u2 * shadowMapSizeInv + base_uv.x;\n    v2 = v2 * shadowMapSizeInv + base_uv.y;\n\n    sum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n    sum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n    sum += uw2 * vw0 * texture(shadowMap, vec3(u2, v0, z));\n\n    sum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n    sum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n    sum += uw2 * vw1 * texture(shadowMap, vec3(u2, v1, z));\n\n    sum += uw0 * vw2 * texture(shadowMap, vec3(u0, v2, z));\n    sum += uw1 * vw2 * texture(shadowMap, vec3(u1, v2, z));\n    sum += uw2 * vw2 * texture(shadowMap, vec3(u2, v2, z));\n\n    sum *= 1.0f / 144.0;\n\n    sum = gammaCorrectInput(sum); // gives softer gradient\n    sum = saturate(sum);\n\n    return sum;\n}\n\nfloat getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n    return _getShadowPCF5x5(shadowMap, shadowParams);\n}\n\nfloat getShadowSpotPCF5x5(sampler2DShadow shadowMap, vec4 shadowParams) {\n    return _getShadowPCF5x5(shadowMap, shadowParams.xyz);\n}\n",shadowStandardGL2VSPS:"float getShadowPCF5x5VS(sampler2DShadow shadowMap, vec3 shadowParams) {\n    dShadowCoord = vMainShadowUv.xyz;\n    dShadowCoord.z = saturate(dShadowCoord.z) - 0.0001; // prevent going to dark after the far plane\n    return _getShadowPCF5x5(shadowMap, shadowParams);\n}\n\n",shadowStandardVSPS:"#ifdef GL2\n#define SHADOW_SAMPLERVS sampler2DShadow\n#else\n#define SHADOW_SAMPLERVS sampler2D\n#endif\n\nfloat getShadowPCF3x3VS(SHADOW_SAMPLERVS shadowMap, vec3 shadowParams) {\n    dShadowCoord = vMainShadowUv.xyz;\n    dShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\n    #ifdef SHADOWBIAS\n        dShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n    #endif\n\n    return _getShadowPCF3x3(shadowMap, shadowParams);\n}\n\n",shadowVSM8PS:"float calculateVSM8(vec3 moments, float Z, float vsmBias) {\n    float VSMBias = vsmBias;//0.01 * 0.25;\n    float depthScale = VSMBias * Z;\n    float minVariance1 = depthScale * depthScale;\n    return chebyshevUpperBound(moments.xy, Z, minVariance1, 0.1);\n}\n\nfloat decodeFloatRG(vec2 rg) {\n    return rg.y*(1.0/255.0) + rg.x;\n}\n\nfloat VSM8(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n    vec4 c = texture2D(tex, texCoords);\n    vec3 moments = vec3(decodeFloatRG(c.xy), decodeFloatRG(c.zw), 0.0);\n    return calculateVSM8(moments, Z, vsmBias);\n}\n\nfloat getShadowVSM8(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    return VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, 0.0);\n}\n\nfloat getShadowSpotVSM8(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n    return VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, 0.0);\n}\n",shadowVSMVSPS:"float getShadowVSM$VS(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    dShadowCoord = vMainShadowUv.xyz;\n    dShadowCoord.z += shadowParams.z;\n    dShadowCoord.xyz /= vMainShadowUv.w;\n    dShadowCoord.z = min(dShadowCoord.z, 1.0);\n\n    return $VSM(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\n\n",shadowVSM_commonPS:"float linstep(float a, float b, float v) {\n    return saturate((v - a) / (b - a));\n}\n\nfloat reduceLightBleeding(float pMax, float amount) {\n  // Remove the [0, amount] tail and linearly rescale (amount, 1].\n   return linstep(amount, 1.0, pMax);\n}\n\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n    // Compute variance\n    float variance = moments.y - (moments.x * moments.x);\n    variance = max(variance, minVariance);\n\n    // Compute probabilistic upper bound\n    float d = mean - moments.x;\n    float pMax = variance / (variance + (d * d));\n\n    pMax = reduceLightBleeding(pMax, lightBleedingReduction);\n\n    // One-tailed Chebyshev\n    return (mean <= moments.x ? 1.0 : pMax);\n}\n\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n    Z = 2.0 * Z - 1.0;\n    float warpedDepth = exp(exponent * Z);\n\n    moments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n\n    float VSMBias = vsmBias;//0.01 * 0.25;\n    float depthScale = VSMBias * exponent * warpedDepth;\n    float minVariance1 = depthScale * depthScale;\n    return chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\n\n",skinBatchConstVS:"attribute float vertex_boneIndices;\nuniform mat4 matrix_pose[BONE_LIMIT];\nmat4 getBoneMatrix(const in float i) {\n    mat4 bone = matrix_pose[int(i)];\n    return bone;\n}\n\n",skinBatchTexVS:"attribute float vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec2 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i) {\n    float j = i * 4.0;\n    float x = mod(j, float(texture_poseMapSize.x));\n    float y = floor(j / float(texture_poseMapSize.x));\n\n    float dx = 1.0 / float(texture_poseMapSize.x);\n    float dy = 1.0 / float(texture_poseMapSize.y);\n\n    y = dy * (y + 0.5);\n\n    vec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n    vec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n    vec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n    vec4 v4 = texture2D(texture_poseMap, vec2(dx * (x + 3.5), y));\n\n    mat4 bone = mat4(v1, v2, v3, v4);\n\n    return bone;\n}\n\n",skinConstVS:"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\n\nuniform mat4 matrix_pose[BONE_LIMIT];\n\nmat4 getBoneMatrix(const in float i)\n{\n    mat4 bone = matrix_pose[int(i)];\n\n    return bone;\n}\n\n",skinTexVS:"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\n\nuniform highp sampler2D texture_poseMap;\nuniform vec2 texture_poseMapSize;\n\nmat4 getBoneMatrix(const in float i)\n{\n    float j = i * 4.0;\n    float x = mod(j, float(texture_poseMapSize.x));\n    float y = floor(j / float(texture_poseMapSize.x));\n\n    float dx = 1.0 / float(texture_poseMapSize.x);\n    float dy = 1.0 / float(texture_poseMapSize.y);\n\n    y = dy * (y + 0.5);\n\n    vec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n    vec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n    vec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n    vec4 v4 = texture2D(texture_poseMap, vec2(dx * (x + 3.5), y));\n\n    mat4 bone = mat4(v1, v2, v3, v4);\n\n    return bone;\n}\n\n",skyboxPS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\n\nvoid main(void) {\n    gl_FragColor = textureCube(texture_cubeMap, fixSeams(vViewDir));\n}\n\n",skyboxVS:"attribute vec3 aPosition;\n\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\nuniform mat4 matrix_projectionSkybox;\n\nvarying vec3 vViewDir;\n\nvoid main(void)\n{\n    mat4 view = matrix_view;\n    view[3][0] = view[3][1] = view[3][2] = 0.0;\n    gl_Position = matrix_projectionSkybox * view * vec4(aPosition, 1.0);\n\n    // Force skybox to far Z, regardless of the clip planes on the camera\n    // Subtract a tiny fudge factor to ensure floating point errors don't\n    // still push pixels beyond far Z. See:\n    // http://www.opengl.org/discussion_boards/showthread.php/171867-skybox-problem\n\n    gl_Position.z = gl_Position.w - 0.00001;\n    vViewDir = aPosition;\n    vViewDir.x *= -1.0;\n}\n\n",skyboxHDRPS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\n\nvoid main(void) {\n    vec3 color = processEnvironment($textureCubeSAMPLE(texture_cubeMap, fixSeamsStatic(vViewDir, $FIXCONST)).rgb);\n    color = toneMap(color);\n    color = gammaCorrectOutput(color);\n    gl_FragColor = vec4(color, 1.0);\n}\n\n",skyboxPrefilteredCubePS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\n\nvec3 fixSeamsStretch(vec3 vec, float mipmapIndex, float cubemapSize) {\n    float scale = 1.0 - exp2(mipmapIndex) / cubemapSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n\nvoid main(void) {\n    vec3 color = textureCubeRGBM(texture_cubeMap, fixSeamsStretch(vViewDir, 0.0, 128.0));\n    color = toneMap(color);\n    color = gammaCorrectOutput(color);\n    gl_FragColor = vec4(color, 1.0);\n}\n\n",specularPS:"#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularMap;\n#endif\n\n#ifdef CLEARCOAT\nuniform float material_clearCoatSpecularity;\n#endif\n\nvoid getSpecularity() {\n    dSpecularity = vec3(1.0);\n\n    #ifdef MAPCOLOR\n        dSpecularity *= material_specular;\n    #endif\n\n    #ifdef MAPTEXTURE\n        dSpecularity *= texture2D(texture_specularMap, $UV).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n        dSpecularity *= saturate(vVertexColor.$VC);\n    #endif\n\n    #ifdef CLEARCOAT\n        ccSpecularity = vec3(1.0);\n        ccSpecularity *= material_clearCoatSpecularity;\n    #endif\n}\n\n",specularAaNonePS:"float antiAliasGlossiness(float power) {\n    return power;\n}\n\n",specularAaToksvigPS:"float antiAliasGlossiness(float power) {\n    float rlen = 1.0 / saturate(length(dNormalMap));\n    float toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n    return power * mix(1.0, toksvig, material_bumpiness);\n}\n\n",specularAaToksvigFastPS:"float antiAliasGlossiness(float power) {\n    float rlen = 1.0 / saturate(length(dNormalMap));\n    float toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n    return power * toksvig;\n}\n\n",spotPS:"float getSpotEffect(vec3 lightSpotDirW, float lightInnerConeAngle, float lightOuterConeAngle) {\n    float cosAngle = dot(dLightDirNormW, lightSpotDirW);\n    return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n\n",startPS:"\nvoid main(void) {\n    dDiffuseLight = vec3(0);\n    dSpecularLight = vec3(0);\n    dReflection = vec4(0);\n    dSpecularity = vec3(0);\n    #ifdef CLEARCOAT\n        ccSpecularLight = vec3(0);\n        ccReflection = vec4(0);\n        ccSpecularity = vec3(0);\n    #endif\n    ",startVS:"\nvoid main(void) {\n    gl_Position = getPosition();\n",startNineSlicedPS:"    nineSlicedUv = vUv0;\n\n",startNineSlicedTiledPS:"\n    vec2 tileMask = step(vMask, vec2(0.99999));\n    vec2 clampedUv = mix(innerOffset.xy*0.5, vec2(1.0) - innerOffset.zw*0.5, fract(vTiledUv));\n    clampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n    nineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n\n",storeEVSMPS:"float exponent = VSM_EXPONENT;\n\ndepth = 2.0 * depth - 1.0;\ndepth =  exp(exponent * depth);\ngl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n\n",tangentBinormalVS:"\nvec3 getTangent() {\n    return normalize(dNormalMatrix * vertex_tangent.xyz);\n}\n\nvec3 getBinormal() {\n    return cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\n\nvec3 getObjectSpaceUp() {\n    return normalize(dNormalMatrix * vec3(0, 1, 0));\n}\n\n",TBNPS:"void getTBN() {\n    dTBN = mat3(normalize(dTangentW), normalize(dBinormalW), normalize(dVertexNormalW));\n}\n\n",TBNderivativePS:"// http://www.thetenthplanet.de/archives/1180\nvoid getTBN() {\n    vec2 uv = $UV;\n\n    // get edge vectors of the pixel triangle\n    vec3 dp1 = dFdx( vPositionW );\n    vec3 dp2 = dFdy( vPositionW );\n    vec2 duv1 = dFdx( uv );\n    vec2 duv2 = dFdy( uv );\n\n    // solve the linear system\n    vec3 dp2perp = cross( dp2, dVertexNormalW );\n    vec3 dp1perp = cross( dVertexNormalW, dp1 );\n    vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n    vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\n    // construct a scale-invariant frame\n    float invmax = 1.0 / sqrt( max( dot(T,T), dot(B,B) ) );\n    dTBN = mat3( T * invmax, B * invmax, dVertexNormalW );\n}\n\n",TBNfastPS:"void getTBN() {\n    dTBN = mat3(dTangentW, dBinormalW, dVertexNormalW);\n}\n\n",TBNObjectSpacePS:"void getTBN() {\n\n    vec3 B = cross(dVertexNormalW, vObjectSpaceUpW);\n    vec3 T = cross(dVertexNormalW, B);\n\n    if (dot(B,B)==0.0) // deal with case when vObjectSpaceUpW dVertexNormalW are parallel\n    {\n        float major=max(max(dVertexNormalW.x, dVertexNormalW.y),dVertexNormalW.z);\n\n        if (dVertexNormalW.x==major)\n        {\n            B=cross(dVertexNormalW, vec3(0,1,0));\n            T=cross(dVertexNormalW, B);\n        }\n        else if (dVertexNormalW.y==major)\n        {\n            B=cross(dVertexNormalW, vec3(0,0,1));\n            T=cross(dVertexNormalW, B);\n        }\n        else if (dVertexNormalW.z==major)\n        {\n            B=cross(dVertexNormalW, vec3(1,0,0));\n            T=cross(dVertexNormalW, B);\n        }\n    }\n\n    dTBN = mat3(normalize(T), normalize(B), normalize(dVertexNormalW));\n}\n\n",tonemappingAcesPS:"uniform float exposure;\n\nvec3 toneMap(vec3 color) {\n    float tA = 2.51;\n    float tB = 0.03;\n    float tC = 2.43;\n    float tD = 0.59;\n    float tE = 0.14;\n    vec3 x = color * exposure;\n    return (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",tonemappingAces2PS:"uniform float exposure;\n\n// ACES approximation by Stephen Hill\n\n// sRGB => XYZ => D65_2_D60 => AP1 => RRT_SAT\nconst mat3 ACESInputMat = mat3(\n    0.59719, 0.35458, 0.04823,\n    0.07600, 0.90834, 0.01566,\n    0.02840, 0.13383, 0.83777\n);\n\n// ODT_SAT => XYZ => D60_2_D65 => sRGB\nconst mat3 ACESOutputMat = mat3(\n     1.60475, -0.53108, -0.07367,\n    -0.10208,  1.10813, -0.00605,\n    -0.00327, -0.07276,  1.07602\n);\n\nvec3 RRTAndODTFit(vec3 v) {\n    vec3 a = v * (v + 0.0245786) - 0.000090537;\n    vec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n    return a / b;\n}\n\nvec3 toneMap(vec3 color) {\n    color *= exposure;\n    color = color * ACESInputMat;\n\n    // Apply RRT and ODT\n    color = RRTAndODTFit(color);\n    color = color * ACESOutputMat;\n\n    // Clamp to [0, 1]\n    color = clamp(color, 0.0, 1.0);\n\n    return color;\n}\n",tonemappingFilmicPS:"const float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\n\nuniform float exposure;\n\nvec3 uncharted2Tonemap(vec3 x) {\n   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\n\nvec3 toneMap(vec3 color) {\n    color = uncharted2Tonemap(color * exposure);\n    vec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n    color = color * whiteScale;\n\n    return color;\n}\n\n",tonemappingHejlPS:"uniform float exposure;\n\nvec3 toneMap(vec3 color) {\n    color *= exposure;\n    const float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n    const float Scl = 1.25;\n\n    vec3 h = max( vec3(0.0), color - vec3(0.004) );\n    return (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n\n",tonemappingLinearPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n    return color * exposure;\n}\n\n",tonemappingNonePS:"vec3 toneMap(vec3 color) {\n    return color;\n}\n\n",transformVS:"#ifdef PIXELSNAP\n    uniform vec4 uScreenSize;\n#endif\n\n#ifdef MORPHING\n    uniform vec4 morph_weights_a;\n    uniform vec4 morph_weights_b;\n#endif\n\n#ifdef MORPHING_TEXTURE_BASED\n    uniform vec4 morph_tex_params;\n\n    vec2 getTextureMorphCoords() {\n        float vertexId = morph_vertex_id;\n        vec2 textureSize = morph_tex_params.xy;\n        vec2 invTextureSize = morph_tex_params.zw;\n\n        // turn vertexId into int grid coordinates\n        float morphGridV = floor(vertexId * invTextureSize.x);\n        float morphGridU = vertexId - (morphGridV * textureSize.x);\n\n        // convert grid coordinates to uv coordinates with half pixel offset\n        return (vec2(morphGridU, morphGridV) * invTextureSize) + (0.5 * invTextureSize);\n    }\n#endif\n\n#ifdef MORPHING_TEXTURE_BASED_POSITION\n    uniform highp sampler2D morphPositionTex;\n#endif\n\nmat4 getModelMatrix() {\n    #ifdef DYNAMICBATCH\n        return getBoneMatrix(vertex_boneIndices);\n    #elif defined(SKIN)\n        return matrix_model * (getBoneMatrix(vertex_boneIndices.x) * vertex_boneWeights.x +\n               getBoneMatrix(vertex_boneIndices.y) * vertex_boneWeights.y +\n               getBoneMatrix(vertex_boneIndices.z) * vertex_boneWeights.z +\n               getBoneMatrix(vertex_boneIndices.w) * vertex_boneWeights.w);\n    #elif defined(INSTANCING)\n        return mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n    #else\n        return matrix_model;\n    #endif\n}\n\nvec4 getPosition() {\n    dModelMatrix = getModelMatrix();\n    vec3 localPos = vertex_position;\n\n    #ifdef NINESLICED\n        // outer and inner vertices are at the same position, scale both\n        localPos.xz *= outerScale;\n\n        // offset inner vertices inside\n        // (original vertices must be in [-1;1] range)\n        vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n        vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n        localPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\n        vTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0; // uv = local pos - inner corner\n\n        localPos.xz *= -0.5; // move from -1;1 to -0.5;0.5\n        localPos = localPos.xzy;\n    #endif\n\n    #ifdef MORPHING\n        #ifdef MORPHING_POS03\n            localPos.xyz += morph_weights_a[0] * morph_pos0;\n            localPos.xyz += morph_weights_a[1] * morph_pos1;\n            localPos.xyz += morph_weights_a[2] * morph_pos2;\n            localPos.xyz += morph_weights_a[3] * morph_pos3;\n        #endif\n        #ifdef MORPHING_POS47\n            localPos.xyz += morph_weights_b[0] * morph_pos4;\n            localPos.xyz += morph_weights_b[1] * morph_pos5;\n            localPos.xyz += morph_weights_b[2] * morph_pos6;\n            localPos.xyz += morph_weights_b[3] * morph_pos7;\n        #endif\n    #endif\n\n    #ifdef MORPHING_TEXTURE_BASED_POSITION\n        // apply morph offset from texture\n        vec2 morphUV = getTextureMorphCoords();\n        vec3 morphPos = texture2D(morphPositionTex, morphUV).xyz;\n        localPos += morphPos;\n    #endif\n\n    vec4 posW = dModelMatrix * vec4(localPos, 1.0);\n    #ifdef SCREENSPACE\n        posW.zw = vec2(0.0, 1.0);\n    #endif\n    dPositionW = posW.xyz;\n\n    vec4 screenPos;\n    #ifdef UV1LAYOUT\n        screenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n    #else\n        #ifdef SCREENSPACE\n            screenPos = posW;\n        #else\n            screenPos = matrix_viewProjection * posW;\n        #endif\n\n        #ifdef PIXELSNAP\n            // snap vertex to a pixel boundary\n            screenPos.xy = (screenPos.xy * 0.5) + 0.5;\n            screenPos.xy *= uScreenSize.xy;\n            screenPos.xy = floor(screenPos.xy);\n            screenPos.xy *= uScreenSize.zw;\n            screenPos.xy = (screenPos.xy * 2.0) - 1.0;\n        #endif\n    #endif\n\n    return screenPos;\n}\n\nvec3 getWorldPosition() {\n    return dPositionW;\n}\n",transformDeclVS:"attribute vec3 vertex_position;\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\n\nvec3 dPositionW;\nmat4 dModelMatrix;\n\n",uv0VS:"#ifdef NINESLICED\nvec2 getUv0() {\n    vec2 uv = vertex_position.xz;\n\n    // offset inner vertices inside\n    // (original vertices must be in [-1;1] range)\n    vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n    vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n    uv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\n    uv = uv * -0.5 + 0.5;\n    uv = uv * atlasRect.zw + atlasRect.xy;\n\n    vMask = vertex_texCoord0.xy;\n\n    return uv;\n}\n#else\nvec2 getUv0() {\n    return vertex_texCoord0;\n}\n#endif\n\n",uv1VS:"\nvec2 getUv1() {\n    return vertex_texCoord1;\n}\n",viewDirPS:"void getViewDir() {\n    dViewDirW = normalize(view_position - vPositionW);\n}\n\n",viewNormalVS:"\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\nvec3 getViewNormal() {\n    return mat3(matrix_view) * vNormalW;\n}\n"},Pa={vertex_position:"POSITION",vertex_normal:"NORMAL",vertex_tangent:"TANGENT",vertex_texCoord0:"TEXCOORD0",vertex_texCoord1:"TEXCOORD1",vertex_texCoord2:"TEXCOORD2",vertex_texCoord3:"TEXCOORD3",vertex_texCoord4:"TEXCOORD4",vertex_texCoord5:"TEXCOORD5",vertex_texCoord6:"TEXCOORD6",vertex_texCoord7:"TEXCOORD7",vertex_color:"COLOR",vertex_boneIndices:"BLENDINDICES",vertex_boneWeights:"BLENDWEIGHT"};Ma.collectAttribs=function(e){for(var t={},i=0,s=e.indexOf("attribute");0<=s&&!(0<s&&"/"===e[s-1]);){var n=e.indexOf(";",s),r=e.lastIndexOf(" ",n);n=e.substr(r+1,n-(r+1)),void 0!==(r=Pa[n])?t[n]=r:(t[n]="ATTR"+i,i++),s=e.indexOf("attribute",s+1)}return t},Ma.createShader=function(e,t,i,s){t=Ma[t],i=wa.precisionCode(e)+"\n"+Ma[i];var n=this.collectAttribs(t);return e.webgl2&&(t=wa.versionCode(e)+this.gles3VS+t,i=wa.versionCode(e)+this.gles3PS+i),new Y(e,{attributes:n,vshader:t,fshader:i,useTransformFeedback:s})},Ma.createShaderFromCode=function(e,t,i,s,n){var r=e.programLib._cache,a=r[s];return void 0!==a?a:(i=wa.precisionCode(e)+"\n"+(i||wa.dummyFragmentCode()),a=this.collectAttribs(t),e.webgl2&&(t=wa.versionCode(e)+this.gles3VS+t,i=wa.versionCode(e)+this.gles3PS+i),r[s]=new Y(e,{attributes:a,vshader:t,fshader:i,useTransformFeedback:n}),r[s])},Object.defineProperties(K.prototype,{minFilter:{get:function(){return this._minFilter},set:function(e){this._minFilter!==e&&(this._minFilter=e,this._parameterFlags|=1)}},magFilter:{get:function(){return this._magFilter},set:function(e){this._magFilter!==e&&(this._magFilter=e,this._parameterFlags|=2)}},addressU:{get:function(){return this._addressU},set:function(e){this._addressU!==e&&(this._addressU=e,this._parameterFlags|=4)}},addressV:{get:function(){return this._addressV},set:function(e){this._addressV!==e&&(this._addressV=e,this._parameterFlags|=8)}},addressW:{get:function(){return this._addressW},set:function(e){this.device.webgl2&&this._volume&&e!==this._addressW&&(this._addressW=e,this._parameterFlags|=16)}},compareOnRead:{get:function(){return this._compareOnRead},set:function(e){this._compareOnRead!==e&&(this._compareOnRead=e,this._parameterFlags|=32)}},compareFunc:{get:function(){return this._compareFunc},set:function(e){this._compareFunc!==e&&(this._compareFunc=e,this._parameterFlags|=64)}},anisotropy:{get:function(){return this._anisotropy},set:function(e){this._anisotropy!==e&&(this._anisotropy=e,this._parameterFlags|=128)}},autoMipmap:{get:function(){return this._mipmaps},set:function(e){this._mipmaps=e}},mipmaps:{get:function(){return this._mipmaps},set:function(e){this._mipmaps!==e&&(this._mipmaps=e,this._minFilterDirty=!0,e&&(this._needsMipmapsUpload=!0))}},width:{get:function(){return this._width}},height:{get:function(){return this._height}},depth:{get:function(){return this._depth}},format:{get:function(){return this._format}},cubemap:{get:function(){return this._cubemap}},gpuSize:{get:function(){return K.calcGpuSize(this._width,this._height,this._depth,this._format,this.pot&&(this._mipmaps||2===this._minFilter||3===this._minFilter||4===this._minFilter||5===this._minFilter)&&!(this._compressed&&1===this._levels.length),this._cubemap)}},volume:{get:function(){return this._volume}},flipY:{get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._needsUpload=!0)}},premultiplyAlpha:{get:function(){return this._premultiplyAlpha},set:function(e){this._premultiplyAlpha!==e&&(this._premultiplyAlpha=e,this._needsUpload=!0)}},pot:{get:function(){return pc.math.powerOfTwo(this._width)&&pc.math.powerOfTwo(this._height)}}});var Aa=null,Ea=null;Object.assign(K,{calcGpuSize:function(e,t,i,s,n,r){Aa||(Aa=[1,1,1,2,2,2,4,4,,,,8,8,16,16,4,4,4,4,4,4]),Ea||((Ea=[])[21]=8,Ea[22]=8,Ea[24]=8,Ea[25]=8,Ea[26]=8,Ea[27]=8,Ea[8]=8,Ea[29]=8,Ea[23]=16,Ea[9]=16,Ea[10]=16,Ea[28]=16,Ea[30]=16);for(var a=Aa.hasOwnProperty(s)?Aa[s]:0,o=Ea.hasOwnProperty(s)?Ea[s]:0,h=0;;){if(0<a)h+=e*t*i*a;else{var l=Math.floor((e+3)/4),c=Math.floor((t+3)/4),d=Math.floor((i+3)/4);24!==s&&25!==s||(l=Math.floor(l/2,1)),h+=l*c*d*o}if(!n||1===e&&1===t&&1===i)break;e=Math.max(Math.floor(e/2),1),t=Math.max(Math.floor(t/2),1),i=Math.max(Math.floor(i/2),1)}return h*(r?6:1)}}),Object.assign(K.prototype,{destroy:function(){this.device&&this.device.destroyTexture(this),this._levels=this.device=null},dirtyAll:function(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this._parameterFlags=255},lock:function(e){if(void 0===(e=e||{level:0,face:0,mode:2}).level&&(e.level=0),void 0===e.face&&(e.face=0),void 0===e.mode&&(e.mode=2),this._lockedLevel=e.level,null===this._levels[e.level])switch(this._format){case 0:case 1:this._levels[e.level]=new Uint8Array(this._width*this._height*this._depth);break;case 2:this._levels[e.level]=new Uint8Array(this._width*this._height*this._depth*2);break;case 3:case 4:case 5:this._levels[e.level]=new Uint16Array(this._width*this._height*this._depth);break;case 6:this._levels[e.level]=new Uint8Array(this._width*this._height*this._depth*3);break;case 7:this._levels[e.level]=new Uint8Array(this._width*this._height*this._depth*4);break;case 8:this._levels[e.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*8*this._depth);break;case 9:case 10:this._levels[e.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*16*this._depth);break;case 11:this._levels[e.level]=new Uint16Array(this._width*this._height*this._depth*3);break;case 13:this._levels[e.level]=new Float32Array(this._width*this._height*this._depth*3);break;case 12:this._levels[e.level]=new Uint16Array(this._width*this._height*this._depth*4);break;case 14:this._levels[e.level]=new Float32Array(this._width*this._height*this._depth*4)}return this._levels[e.level]},setSource:function(e,t){var i,s=!1;if(t=t||0,this._cubemap){if(e[0]){var n=e[0].width||0,r=e[0].height||0;for(i=0;6>i;i++){var a=e[i];if(!a||a.width!==n||a.height!==r||!("undefined"!=typeof HTMLImageElement&&a instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&a instanceof HTMLCanvasElement||"undefined"!=typeof HTMLVideoElement&&a instanceof HTMLVideoElement)){s=!0;break}}}else s=!0;if(!s)for(i=0;6>i;i++)this._levels[t][i]!==e[i]&&(this._levelsUpdated[t][i]=!0)}else"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement||(s=!0),s||(e!==this._levels[t]&&(this._levelsUpdated[t]=!0),n=e.width,r=e.height);if(s)if(this._height=this._width=4,this._cubemap)for(i=0;6>i;i++)this._levels[t][i]=null,this._levelsUpdated[t][i]=!0;else this._levels[t]=null,this._levelsUpdated[t]=!0;else 0===t&&(this._width=n,this._height=r),this._levels[t]=e;this._invalid===s&&s||(this._invalid=s,this.upload())},getSource:function(e){return this._levels[e||0]},unlock:function(){this.upload(),this._lockedLevel=-1},upload:function(){this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps},getDds:function(){7!==this.format&&console.error("This format is not implemented yet");for(var e,t,i=128,s=0;this._levels[s];){if(this.cubemap)for(t=0;6>t;t++){if(!this._levels[s][t])return void console.error("No level data for mip "+s+", face "+t);if(!(e=this._levels[s][t].length))return void console.error("No byte array for mip "+s+", face "+t);i+=e}else{if(!(e=this._levels[s].length))return void console.error("No byte array for mip "+s);i+=e}i+=this._levels[s].length,s++}i=new ArrayBuffer(i),t=new Uint32Array(i,0,32),s=528391,1<this._levels.length&&(s|=131072),e=4096,1<this._levels.length&&(e|=4194304),(1<this._levels.length||this.cubemap)&&(e|=8);var n=this.cubemap?65024:0;for(t[0]=542327876,t[1]=124,t[2]=s,t[3]=this.height,t[4]=this.width,t[5]=this.width*this.height*4,t[6]=0,t[7]=this._levels.length,s=0;11>s;s++)t[8+s]=0;if(t[19]=32,t[20]=65,t[21]=0,t[22]=32,t[23]=16711680,t[24]=65280,t[25]=255,t[26]=4278190080,t[27]=e,t[28]=n,t[29]=0,t[30]=0,t[31]=0,n=128,this.cubemap)for(t=0;6>t;t++)for(s=0;s<this._levels.length;s++){var r=this._levels[s][t],a=new Uint8Array(i,n,r.length);for(e=0;e<r.length;e++)a[e]=r[e];n+=r.length}else for(s=0;s<this._levels.length;s++){for(r=this._levels[s],a=new Uint8Array(i,n,r.length),e=0;e<r.length;e++)a[e]=r[e];n+=r.length}return i}}),Object.assign(Z.prototype,{destroy:function(){var e=this.device,t=e.buffers.indexOf(this);-1!==t&&e.buffers.splice(t,1),this.bufferId&&(this.device.gl.deleteBuffer(this.bufferId),this.device._vram.ib-=this.storage.byteLength,this.bufferId=null,this.device.indexBuffer===this&&(this.device.indexBuffer=null))},getFormat:function(){return this.format},getNumIndices:function(){return this.numIndices},lock:function(){return this.storage},unlock:function(){var e=this.device.gl;switch(this.bufferId||(this.bufferId=e.createBuffer()),this.usage){case 0:var t=e.STATIC_DRAW;break;case 1:t=e.DYNAMIC_DRAW;break;case 2:t=e.STREAM_DRAW;break;case 3:t=this.device.webgl2?e.DYNAMIC_COPY:e.STATIC_DRAW}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.bufferId),e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.storage,t)},setData:function(e){return e.byteLength!==this.numBytes?(console.error("IndexBuffer: wrong initial data size: expected "+this.numBytes+", got "+e.byteLength),!1):(this.storage=e,this.unlock(),!0)},_lockTypedArray:function(){var e=this.lock();return 2===this.format?new Uint32Array(e):1===this.format?new Uint16Array(e):new Uint8Array(e)},writeData:function(e,t){var i=this._lockTypedArray();if(e.length>t)if(ArrayBuffer.isView(e))e=e.subarray(0,t),i.set(e);else{var s;for(s=0;s<t;s++)i[s]=e[s]}else i.set(e);this.unlock()},readData:function(e){var t,i=this._lockTypedArray(),s=this.numIndices;if(ArrayBuffer.isView(e))e.set(i);else for(e.length=0,t=0;t<s;t++)e[t]=i[t];return s}});var Ca=0;Object.assign($.prototype,{initDefaults:function(){this.recreate=!1,this.indexCount=this.vertexCount=this.maxIndices=this.maxVertices=this.indicesUsage=this.verticesUsage=0,this.indexStreamUpdated=this.vertexStreamsUpdated=!1,this.vertexStreamDictionary={},this.indices=null},_validateVertexCount:function(e,t){},_changeVertexCount:function(e,t){this.vertexCount?this._validateVertexCount(e,t):this.vertexCount=e}}),Object.defineProperties($,{DEFAULT_COMPONENTS_POSITION:{value:3},DEFAULT_COMPONENTS_NORMAL:{value:3},DEFAULT_COMPONENTS_UV:{value:2},DEFAULT_COMPONENTS_COLORS:{value:4}}),Object.defineProperties(J.prototype,{aabb:{get:function(){return this._aabb},set:function(e){this._aabb=e}},refCount:{get:function(){return this._refCount}}}),Object.assign(J.prototype,{incReference:function(){this._refCount++},decReference:function(){this._refCount--},destroy:function(){var e,t;for(this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null),e=0;e<this.indexBuffer.length;e++)(t=this.indexBuffer[e])&&t.destroy();this.indexBuffer.length=0,this._geometryData=null},_initBoneAabbs:function(e){this.boneAabb=[],this.boneUsed=[];var t,i,s,n,r,a=this.vertexBuffer.numVertices,o=[],h=[],l=this.boneUsed,c=this.skin.boneNames.length;for(t=0;t<c;t++)o[t]=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),h[t]=new v(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);var d=new X(this.vertexBuffer),u=d.element.POSITION,p=d.element.BLENDWEIGHT,f=d.element.BLENDINDICES;for(t=0;t<a;t++){for(i=0;4>i;i++){var m=p.array[p.index+i];if(0<m){var _=f.array[f.index+i];l[_]=!0;var g=u.array[u.index],y=u.array[u.index+1],b=u.array[u.index+2];if(m=h[_],(_=o[_]).x>g&&(_.x=g),_.y>y&&(_.y=y),_.z>b&&(_.z=b),m.x<g&&(m.x=g),m.y<y&&(m.y=y),m.z<b&&(m.z=b),e){g=s=g,y=n=y;var x=r=b;for(b=0;b<e.length;b++){var S=e[b],T=S.deltaPositions[3*t],M=S.deltaPositions[3*t+1];0>T?g+=T:s+=T,0>M?y+=M:n+=M,0>(S=S.deltaPositions[3*t+2])?x+=S:r+=S}_.x>g&&(_.x=g),_.y>y&&(_.y=y),_.z>x&&(_.z=x),m.x<s&&(m.x=s),m.y<n&&(m.y=n),m.z<r&&(m.z=r)}}}d.next()}for(t=0;t<c;t++)(e=new w).setMinMax(o[t],h[t]),this.boneAabb.push(e)},_initGeometryData:function(){this._geometryData||(this._geometryData=new $,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),0<this.indexBuffer.length&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))},clear:function(e,t,i,s){this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=!0,this._geometryData.maxVertices=i||0,this._geometryData.maxIndices=s||0,this._geometryData.verticesUsage=e?0:1,this._geometryData.indicesUsage=t?0:1},setVertexStream:function(e,t,i,s,n,r){this._initGeometryData(),this._geometryData._changeVertexCount(s||t.length/i,e),this._geometryData.vertexStreamsUpdated=!0,this._geometryData.vertexStreamDictionary[e]=new Q(t,i,n||6,r||!1)},getVertexStream:function(e,t){var i=0,s=!1;if(this._geometryData){var n=this._geometryData.vertexStreamDictionary[e];n&&(s=!0,i=this._geometryData.vertexCount,ArrayBuffer.isView(t)?t.set(n.data):(t.length=0,t.push(n.data)))}return s||this.vertexBuffer&&(i=new X(this.vertexBuffer).readData(e,t)),i},setPositions:function(e,t,i){this.setVertexStream("POSITION",e,t||$.DEFAULT_COMPONENTS_POSITION,i,6,!1)},setNormals:function(e,t,i){this.setVertexStream("NORMAL",e,t||$.DEFAULT_COMPONENTS_NORMAL,i,6,!1)},setUvs:function(e,t,i,s){this.setVertexStream("TEXCOORD"+e,t,i||$.DEFAULT_COMPONENTS_UV,s,6,!1)},setColors:function(e,t,i){this.setVertexStream("COLOR",e,t||$.DEFAULT_COMPONENTS_COLORS,i,6,!1)},setColors32:function(e,t){this.setVertexStream("COLOR",e,$.DEFAULT_COMPONENTS_COLORS,t,1,!0)},setIndices:function(e,t){this._initGeometryData(),this._geometryData.indexStreamUpdated=!0,this._geometryData.indices=e,this._geometryData.indexCount=t||e.length},getPositions:function(e){return this.getVertexStream("POSITION",e)},getNormals:function(e){return this.getVertexStream("NORMAL",e)},getUvs:function(e,t){return this.getVertexStream("TEXCOORD"+e,t)},getColors:function(e){return this.getVertexStream("COLOR",e)},getIndices:function(e){var t=0;if(this._geometryData&&this._geometryData.indices){var i=this._geometryData.indices;t=this._geometryData.indexCount,ArrayBuffer.isView(e)?e.set(i):(e.length=0,e.push(i))}else 0<this.indexBuffer.length&&this.indexBuffer[0]&&(t=this.indexBuffer[0].readData(e));return t},update:function(e,t){this._geometryData&&((t||void 0===t)&&(t=this._geometryData.vertexStreamDictionary.POSITION)&&3==t.componentCount&&this._aabb.compute(t.data,this._geometryData.vertexCount),t=this._geometryData.recreate,this._geometryData.vertexCount>this._geometryData.maxVertices&&(t=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),t&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null),t=this._geometryData.recreate,this._geometryData.indexCount>this._geometryData.maxIndices&&(t=!0,this._geometryData.maxIndices=this._geometryData.indexCount),t&&0<this.indexBuffer.length&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=void 0===e?4:e,0<this.indexBuffer.length&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1)},_buildVertexFormat:function(e){var t,i=[];for(t in this._geometryData.vertexStreamDictionary){var s=this._geometryData.vertexStreamDictionary[t];i.push({semantic:t,components:s.componentCount,type:s.dataType,normalize:s.dataTypeNormalize})}return new R(this.device,i,e)},_updateVertexBuffer:function(){if(!this.vertexBuffer){var e=this._geometryData.maxVertices,t=this._buildVertexFormat(e);this.vertexBuffer=new I(this.device,t,e,this._geometryData.verticesUsage)}for(var i in e=new X(this.vertexBuffer),t=this._geometryData.vertexCount,this._geometryData.vertexStreamDictionary)e.writeData(i,this._geometryData.vertexStreamDictionary[i].data,t),delete this._geometryData.vertexStreamDictionary[i];e.end()},_updateIndexBuffer:function(){(0>=this.indexBuffer.length||!this.indexBuffer[0])&&(this.indexBuffer[0]=new Z(this.device,65535<this._geometryData.maxVertices?2:1,this._geometryData.maxIndices,this._geometryData.indicesUsage));var e=this._geometryData.indices;e&&(this.indexBuffer[0].writeData(e,this._geometryData.indexCount),this._geometryData.indices=null)},generateWireframe:function(){var e=function(e){switch(e.format){case 0:return new Uint8Array(e.storage);case 1:return new Uint16Array(e.storage);case 2:return new Uint32Array(e.storage);default:return null}},t=[];if(0<this.indexBuffer.length&&this.indexBuffer[0]){for(var i=[[0,1],[1,2],[2,0]],s=this.primitive[0].base,n=this.primitive[0].count,r=this.indexBuffer[0],a=e(r),o={},h=s;h<s+n;h+=3)for(var l=0;3>l;l++){var c=a[h+i[l][0]],d=a[h+i[l][1]],u=c>d?d<<16|c:c<<16|d;void 0===o[u]&&(o[u]=0,t.push(c,d))}i=r.format}else{for(i=0;i<this.vertexBuffer.numVertices;i+=3)t.push(i,i+1,i+1,i+2,i+2,i);i=65535<t.length?2:1}e(i=new Z(this.vertexBuffer.device,i,t.length)).set(t),i.unlock(),this.primitive[1]={type:1,base:0,count:t.length,indexed:!0},this.indexBuffer[1]=i}});var Ia=new w,Oa=new w;Object.defineProperty(ee.prototype,"mesh",{get:function(){return this._mesh},set:function(e){this._mesh&&this._mesh.decReference(),(this._mesh=e)&&e.incReference()}}),Object.defineProperty(ee.prototype,"aabb",{get:function(){var e;if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);if(this.skinInstance){this.mesh.boneAabb||this.mesh._initBoneAabbs(this._morphInstance?this._morphInstance.morph._targets:null);var t=this.mesh.boneUsed,i=this.node.getWorldTransform(),s=!0;for(e=0;e<this.mesh.boneAabb.length;e++)t[e]&&(Oa.setFromTransformedAabb(this.mesh.boneAabb[e],this.skinInstance.matrices[e]),s?(s=!1,Ia.center.copy(Oa.center),Ia.halfExtents.copy(Oa.halfExtents)):Ia.add(Oa));this._aabb.setFromTransformedAabb(Ia,i)}else this.node._aabbVer!==this._aabbVer&&(this.mesh?(Ia.center.copy(this.mesh.aabb.center),Ia.halfExtents.copy(this.mesh.aabb.halfExtents)):(Ia.center.set(0,0,0),Ia.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph&&Ia._expand(this.mesh.morph.aabb.getMin(),this.mesh.morph.aabb.getMax()),this._aabb.setFromTransformedAabb(Ia,this.node.getWorldTransform()),this._aabbVer=this.node._aabbVer);return this._aabb},set:function(e){this._aabb=e}}),Object.defineProperty(ee.prototype,"material",{get:function(){return this._material},set:function(e){var t;for(t=0;t<this._shader.length;t++)this._shader[t]=null;if(this._material){var i=this._material.meshInstances;-1!==(t=i.indexOf(this))&&i.splice(t,1)}t=this._material,(this._material=e)&&(this._material.meshInstances.push(this),this.updateKey(),(t&&3!==t.blendType)!==(3!==this._material.blendType)&&(!(e=this._material._scene)&&t&&t._scene&&(e=t._scene),e?e.layers._dirtyBlend=!0:this._material._dirtyBlend=!0))}}),Object.defineProperty(ee.prototype,"layer",{get:function(){return this._layer},set:function(e){this._layer=e,this.updateKey()}}),Object.defineProperty(ee.prototype,"calculateSortDistance",{get:function(){return this._calculateSortDistance},set:function(e){this._calculateSortDistance=e}}),Object.defineProperty(ee.prototype,"receiveShadow",{get:function(){return this._receiveShadow},set:function(e){this._shaderDefs=(this._receiveShadow=e)?-2&this._shaderDefs:1|this._shaderDefs,this._shader[0]=null,this._shader[1]=null}}),Object.defineProperty(ee.prototype,"skinInstance",{get:function(){return this._skinInstance},set:function(e){for(this._shaderDefs=(this._skinInstance=e)?2|this._shaderDefs:-3&this._shaderDefs,e=0;e<this._shader.length;e++)this._shader[e]=null}}),Object.defineProperty(ee.prototype,"morphInstance",{get:function(){return this._morphInstance},set:function(e){for((this._morphInstance=e)&&(this._morphInstance.meshInstance=this),this._shaderDefs=e&&e.morph.useTextureMorph?4096|this._shaderDefs:-4097&this._shaderDefs,this._shaderDefs=e&&e.morph.morphPositions?1024|this._shaderDefs:-1025&this._shaderDefs,this._shaderDefs=e&&e.morph.morphNormals?2048|this._shaderDefs:-2049&this._shaderDefs,e=0;e<this._shader.length;e++)this._shader[e]=null}}),Object.defineProperty(ee.prototype,"screenSpace",{get:function(){return this._screenSpace},set:function(e){this._shaderDefs=(this._screenSpace=e)?256|this._shaderDefs:-257&this._shaderDefs,this._shader[0]=null}}),Object.defineProperty(ee.prototype,"key",{get:function(){return this._key[0]},set:function(e){this._key[0]=e}}),Object.defineProperty(ee.prototype,"mask",{get:function(){return this._shaderDefs>>16},set:function(e){this._shaderDefs=65535&this._shaderDefs|e<<16,this._shader[0]=null,this._shader[1]=null}}),Object.defineProperty(ee.prototype,"instancingCount",{get:function(){return this.instancingData?this.instancingData.count:0},set:function(e){this.instancingData&&(this.instancingData.count=e)}}),Object.assign(ee.prototype,{syncAabb:function(){},updateKey:function(){var e=this.material;this._key[0]=(15&this.layer)<<27|(3===(e.alphaToCoverage||e.alphaTest?2:e.blendType)?1:0)<<26|0|(33554431&e.id)<<0},setInstancing:function(e){e?(this.instancingData=new ie(e.numVertices),this.instancingData.offset=0,this.instancingData.vertexBuffer=e,this.cull=!1):(this.instancingData=null,this.cull=!0)},clearParameters:function(){this.parameters={}},getParameters:function(){return this.parameters},getParameter:function(e){return this.parameters[e]},setParameter:function(e,t,i){if(void 0===i&&(i=-524285),void 0===t&&"object"==typeof e){if((t=e).length){for(e=0;e<t.length;e++)this.setParameter(t[e]);return}e=t.name,t=t.value}var s=this.parameters[e];s?(s.data=t,s.passFlags=i):this.parameters[e]={scopeId:null,data:t,passFlags:i}},deleteParameter:function(e){this.parameters[e]&&delete this.parameters[e]},setParameters:function(){for(var e in this.parameters){var t=this.parameters[e];t.scopeId.setValue(t.data)}}}),Object.defineProperty(te.prototype,"key",{get:function(){return this._key[0]},set:function(e){this._key[0]=e}}),Object.defineProperties(se,{FORMAT_FLOAT:{value:0},FORMAT_HALF_FLOAT:{value:1}}),Object.defineProperties(se.prototype,{morphPositions:{get:function(){return this._morphPositions}},morphNormals:{get:function(){return this._morphNormals}},maxActiveTargets:{get:function(){return this._useTextureMorph?this._targets.length:this._morphPositions&&this._morphNormals?4:8}},useTextureMorph:{get:function(){return this._useTextureMorph}}}),Object.assign(se.prototype,{_init:function(){var e;if(this._useTextureMorph&&(this._useTextureMorph=this._initTextureBased()),!this._useTextureMorph)for(e=0;e<this._targets.length;e++)this._targets[e]._initVertexBuffers(this.device);for(e=0;e<this._targets.length;e++)this._targets[e]._postInit()},_initTextureBased:function(){var e,t=[],i=[];for(e=0;e<this._targets.length;e++){var s=this._targets[e];s.options.deltaPositions&&(t.push(s.options.deltaPositions),i.push({target:s,name:"texturePositions"})),s.options.deltaNormals&&(t.push(s.options.deltaNormals),i.push({target:s,name:"textureNormals"}))}var n=[],r=[],a=1,o=t[0].length;for(s=0;s<o;s+=3){var h=!1;for(e=0;e<t.length;e++){var l=t[e];if(0!==l[s]||0!==l[s+1]||0!==l[s+2]){h=!0;break}}h?(n.push(a),r.push(s/3),a++):n.push(0)}if(e=Math.min(this.device.maxTextureSize,4096),s=Math.ceil(Math.sqrt(a)),s=Math.min(s,e),(l=Math.ceil(a/s))>e)return!1;this.morphTextureWidth=s,this.morphTextureHeight=l,a=!1,h=3,o=Hr.float2Half,this._textureFormat===se.FORMAT_HALF_FLOAT&&(a=!0,h=4),e=this.morphTextureWidth*this.morphTextureHeight*h;var c=a?new Uint16Array(e):new Float32Array(e);for(e=0;e<t.length;e++){for(l=t[e],s=0;s<r.length;s++){var d=r[s];a?(c[s*h+h]=o(l[3*d]),c[s*h+h+1]=o(l[3*d+1]),c[s*h+h+2]=o(l[3*d+2])):(c[s*h+h]=l[3*d],c[s*h+h+1]=l[3*d+1],c[s*h+h+2]=l[3*d+2])}(s=i[e].target)._setTexture(i[e].name,this._createTexture("MorphTarget",this._textureFormat===se.FORMAT_FLOAT?13:12,c))}return this.vertexBufferIds=new I(this.device,new R(this.device,[{semantic:"ATTR0",components:1,type:6}]),n.length,0,new Float32Array(n)),!0},destroy:function(){this.vertexBufferIds&&(this.vertexBufferIds.destroy(),this.vertexBufferIds=null);for(var e=0;e<this._targets.length;e++)this._targets[e].destroy();this._targets.length=0},getTarget:function(e){return this._targets[e]},_updateMorphFlags:function(){this._morphNormals=this._morphPositions=!1;for(var e,t=0;t<this._targets.length;t++)(e=this._targets[t]).morphPositions&&(this._morphPositions=!0),e.morphNormals&&(this._morphNormals=!0)},_calculateAabb:function(){this.aabb=new w(new v(0,0,0),new v(0,0,0));for(var e,t=0;t<this._targets.length;t++)e=this._targets[t],this.aabb._expand(e.aabb.getMin(),e.aabb.getMax())},_createTexture:function(e,t,i){return(t=new K(this.device,{width:this.morphTextureWidth,height:this.morphTextureHeight,format:t,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})).name=e,i&&(t.lock().set(i),t.unlock()),t}}),Object.assign(ne.prototype,{destroy:function(){this.shader=this.meshInstance=null,this.morph&&(this.morph.destroy(),this.morph=null),this.rtPositions&&(this.rtPositions.destroy(),this.rtPositions=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.rtNormals&&(this.rtNormals.destroy(),this.rtNormals=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)},getWeight:function(e){return this._weights[e]},setWeight:function(e,t){this._weights[e]=t,this._dirty=!0},_getFragmentShader:function(e){var t,i="";for(0<e&&(i+="varying vec2 uv0;\nuniform highp float morphFactor["+e+"];\n"),t=0;t<e;t++)i+="uniform highp sampler2D morphBlendTex"+t+";\n";for(i+="void main (void) {\n\thighp vec4 color = vec4(0, 0, 0, 1);\n",t=0;t<e;t++)i+="\tcolor.xyz += morphFactor["+t+"] * texture2D(morphBlendTex"+t+", uv0).xyz;\n";return i+"\tgl_FragColor = color;\n}\n"},_getShader:function(e){var t=this.shaderCache[e];return t||(t=this._getFragmentShader(e),t=Ma.createShaderFromCode(this.device,"attribute vec2 vertex_position;\nvarying vec2 uv0;\nvoid main(void) {\n\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\tuv0 = vertex_position.xy * 0.5 + 0.5;\n}\n",t,"textureMorph"+e),this.shaderCache[e]=t),t},_updateTextureRenderTarget:function(e,t){for(var i=this.device,s=function(t,s){this.morphFactor.setValue(this._shaderMorphWeights),i.setBlending(s),s&&(i.setBlendFunction(1,1),i.setBlendEquation(0)),t=this._getShader(t),q(i,e,t,void 0,void 0,s)}.bind(this),n=0,r=!1,a=this._activeTargets.length,o=0;o<a;o++){var h=this._activeTargets[o],l=h.target[t];l&&(this["morphBlendTex"+n].setValue(l),this._shaderMorphWeights[n]=h.weight,++n>=this.maxSubmitCount&&(s(n,r),n=0,r=!0))}0<n&&s(n,r)},_updateTextureMorph:function(){0<this._activeTargets.length&&(this._updateTextureRenderTarget(this.rtPositions,"texturePositions"),this._updateTextureRenderTarget(this.rtNormals,"textureNormals"))},_updateVertexMorph:function(){var e,t=this.maxSubmitCount;for(e=0;e<t;e++)this._shaderMorphWeights[e]=0,this._activeVertexBuffers[e]=null;t=0;var i=this.morph.morphPositions?4:0;for(e=0;e<this._activeTargets.length;e++){var s=this._activeTargets[e].target;s._vertexBufferPositions&&(this._activeVertexBuffers[t]=s._vertexBufferPositions,this._shaderMorphWeights[t]=this._activeTargets[e].weight,t++),s._vertexBufferNormals&&(this._activeVertexBuffers[i]=s._vertexBufferNormals,this._shaderMorphWeights[i]=this._activeTargets[e].weight,i++)}},update:function(){this._dirty=!1;var e,t=this.morph._targets,i=0;for(e=0;e<t.length;e++){var s=Math.abs(this.getWeight(e));if(1e-5<s){this._activeTargets.length<=i&&(this._activeTargets[i]={});var n=this._activeTargets[i++];n.absWeight=s,n.weight=this.getWeight(e),n.target=t[e]}}this._activeTargets.length=i,t=this.morph.maxActiveTargets,this._activeTargets.length>t&&(this._activeTargets.sort(function(e,t){return e.absWeight<t.absWeight?1:t.absWeight<e.absWeight?-1:0}),this._activeTargets.length=t),this.morph.useTextureMorph?this._updateTextureMorph():this._updateVertexMorph()}});var Ra=new x;Object.assign(ae.prototype,{init:function(e,t){e.supportsBoneTextures?(t=16<t?Hr.nextPowerOfTwo(Math.ceil(Math.sqrt(4*t))):8,this.boneTexture=new K(e,{width:t,height:t,format:14,mipmaps:!1,minFilter:0,magFilter:0}),this.boneTexture.name="skin",this.matrixPalette=this.boneTexture.lock()):this.matrixPalette=new Float32Array(16*t)},initSkin:function(e){this.skin=e,this.bones=[];var t=e.inverseBindPose.length;for(this.init(e.device,t),this.matrices=[],e=0;e<t;e++)this.matrices[e]=new x},uploadBones:function(e){e.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())},updateMatrices:function(e){for(Ra.copy(e.getWorldTransform()).invert(),e=this.bones.length-1;0<=e;e--)this.matrices[e].mul2(Ra,this.bones[e].getWorldTransform()),this.matrices[e].mul2(this.matrices[e],this.skin.inverseBindPose[e])},updateMatrixPalette:function(){for(var e,t,i=this.matrixPalette,s=this.bones.length-1;0<=s;s--)e=this.matrices[s].data,i[t=16*s]=e[0],i[t+1]=e[1],i[t+2]=e[2],i[t+3]=e[3],i[t+4]=e[4],i[t+5]=e[5],i[t+6]=e[6],i[t+7]=e[7],i[t+8]=e[8],i[t+9]=e[9],i[t+10]=e[10],i[t+11]=e[11],i[t+12]=e[12],i[t+13]=e[13],i[t+14]=e[14],i[t+15]=e[15];this.uploadBones(this.skin.device)}}),Object.assign(oe.prototype,{getGraph:function(){return this.graph},setGraph:function(e){this.graph=e},getCameras:function(){return this.cameras},setCameras:function(e){this.cameras=e},getLights:function(){return this.lights},setLights:function(e){this.lights=e},getMaterials:function(){var e,t=[];for(e=0;e<this.meshInstances.length;e++){var i=this.meshInstances[e];-1===t.indexOf(i.material)&&t.push(i.material)}return t},clone:function(){var e,t,i=[],s=[],n=function(e){var t=e.clone();i.push(e),s.push(t);for(var r=0;r<e._children.length;r++)t.addChild(n(e._children[r]));return t},r=n(this.graph),a=[],o=[],h=[];for(e=0;e<this.skinInstances.length;e++){var l=this.skinInstances[e].skin,c=new ae(l),d=[];for(t=0;t<l.boneNames.length;t++){var u=r.findByName(l.boneNames[t]);d.push(u)}c.bones=d,o.push(c)}for(e=0;e<this.morphInstances.length;e++)t=new ne(this.morphInstances[e].morph),h.push(t);for(e=0;e<this.meshInstances.length;e++)t=this.meshInstances[e],l=i.indexOf(t.node),l=new ee(s[l],t.mesh,t.material),t.skinInstance&&(c=this.skinInstances.indexOf(t.skinInstance),l.skinInstance=o[c]),t.morphInstance&&(t=this.morphInstances.indexOf(t.morphInstance),l.morphInstance=h[t]),a.push(l);return(e=new oe).graph=r,e.meshInstances=a,e.skinInstances=o,e.morphInstances=h,e.getGraph().syncHierarchy(),e},destroy:function(){for(var e,t,i=this.meshInstances,s=0;s<i.length;s++)(t=(e=i[s]).mesh)&&(e.mesh=null,1>t.refCount&&t.destroy()),(t=e.skinInstance)&&(t=t.boneTexture)&&t.destroy(),e.skinInstance=null,(t=e.morphInstance)&&t.destroy(),e.morphInstance=null,e.material=null},generateWireframe:function(){var e,t=[];for(e=0;e<this.meshInstances.length;e++){var i=this.meshInstances[e].mesh;-1===t.indexOf(i)&&t.push(i)}for(e=0;e<t.length;++e)(i=t[e]).primitive[1]||i.generateWireframe()}}),le.MODEL="model",le.ELEMENT="element",le.SPRITE="sprite",ce.prototype=Object.create(ce.prototype),ce.prototype.constructor=ce,Object.assign(ce.prototype,{updateMatrices:function(e){},updateMatrixPalette:function(){for(var e,t,i=this.matrixPalette,s=this.bones.length-1;0<=s;s--)e=this.bones[s].getWorldTransform().data,i[t=16*s]=e[0],i[t+1]=e[1],i[t+2]=e[2],i[t+3]=e[3],i[t+4]=e[4],i[t+5]=e[5],i[t+6]=e[6],i[t+7]=e[7],i[t+8]=e[8],i[t+9]=e[9],i[t+10]=e[10],i[t+11]=e[11],i[t+12]=e[12],i[t+13]=e[13],i[t+14]=e[14],i[t+15]=e[15];ae.prototype.uploadBones.call(this,this.device)}}),de.prototype.destroyManager=function(){this.scene=this.rootNode=this.device=null,this._batchGroups={},this._batchList=[],this._dirtyGroups=[]},de.prototype.addGroup=function(e,t,i,s,n){if(void 0===s&&(s=this._batchGroupCounter,this._batchGroupCounter++),!this._batchGroups[s])return this._batchGroups[s]=new le(s,e,t,i,n)},de.prototype.removeGroup=function(e){if(this._batchGroups[e]){for(var t=[],i=0;i<this._batchList.length;i++)this._batchList[i].batchGroupId!==e?t.push(this._batchList[i]):this.destroy(this._batchList[i]);this._batchList=t,this._removeModelsFromBatchGroup(this.rootNode,e),delete this._batchGroups[e]}},de.prototype.markGroupDirty=function(e){0>this._dirtyGroups.indexOf(e)&&this._dirtyGroups.push(e)},de.prototype.getGroupByName=function(e){var t,i=this._batchGroups;for(t in i)if(i.hasOwnProperty(t)&&i[t].name===e)return i[t];return null},de.prototype.getBatches=function(e){for(var t=[],i=this._batchList.length,s=0;s<i;s++){var n=this._batchList[s];n.batchGroupId===e&&t.push(n)}return t},de.prototype._removeModelsFromBatchGroup=function(e,t){if(e.enabled){e.model&&e.model.batchGroupId===t&&(e.model.batchGroupId=-1),e.element&&e.element.batchGroupId===t&&(e.element.batchGroupId=-1),e.sprite&&e.sprite.batchGroupId===t&&(e.sprite.batchGroupId=-1);for(var i=0;i<e._children.length;i++)this._removeModelsFromBatchGroup(e._children[i],t)}},de.prototype.insert=function(e,t,i){var s=this._batchGroups[t];s&&0>s._obj[e].indexOf(i)&&(s._obj[e].push(i),this.markGroupDirty(t))},de.prototype.remove=function(e,t,i){var s=this._batchGroups[t];s&&(0<=(i=s._obj[e].indexOf(i))&&(s._obj[e].splice(i,1),this.markGroupDirty(t)))},de.prototype._extractModel=function(e,t,i,s){if(!e.model||!e.model.model)return t;if(e.model.isStatic){s=this.scene.drawCalls;var n=e.model.meshInstances;for(i=0;i<s.length;i++)s[i]._staticSource&&(0>n.indexOf(s[i]._staticSource)||t.push(s[i]));for(i=0;i<n.length;i++)0<=s.indexOf(n[i])&&t.push(n[i])}else t=s[e.model.batchGroupId]=t.concat(e.model.meshInstances);return e.model.removeModelFromLayers(),t},de.prototype._extractElement=function(e,t,i){if(e.element){var s=!1;e.element._text&&0<e.element._text._model.meshInstances.length?(t.push(e.element._text._model.meshInstances[0]),e.element.removeModelFromLayers(e.element._text._model),s=!0):e.element._image&&(t.push(e.element._image._renderable.meshInstance),e.element.removeModelFromLayers(e.element._image._renderable.model),e.element._image._renderable.unmaskMeshInstance&&(t.push(e.element._image._renderable.unmaskMeshInstance),e.element._image._renderable.unmaskMeshInstance.stencilFront&&e.element._image._renderable.unmaskMeshInstance.stencilBack||(e.element._dirtifyMask(),e.element._onPrerender())),s=!0),s&&(i._ui=!0)}},de.prototype._collectAndRemoveModels=function(e,t){for(var i,s,n,r=0;r<t.length;r++)if(i=t[r],s=this._batchGroups[i]){for((n=e[i])||(n=e[i]=[]),i=0;i<s._obj.model.length;i++)n=this._extractModel(s._obj.model[i],n,s,e);for(i=0;i<s._obj.element.length;i++)this._extractElement(s._obj.element[i],n,s);for(var a=0;a<s._obj.sprite.length;a++)(i=s._obj.sprite[a]).sprite&&i.sprite._meshInstance&&(s.dynamic||0===i.sprite.sprite._renderMode)&&(n.push(i.sprite._meshInstance),i.sprite.removeModelFromLayers(),s._sprite=!0,i.sprite._batchGroup=s)}},de.prototype.generate=function(e){var t,i={};e||(e=Object.keys(this._batchGroups));var s,n,r=[];for(t=0;t<this._batchList.length;t++)0>e.indexOf(this._batchList[t].batchGroupId)?r.push(this._batchList[t]):this.destroy(this._batchList[t]);if(this._batchList=r,this._collectAndRemoveModels(i,e),e===this._dirtyGroups)this._dirtyGroups.length=0;else{for(r=[],t=0;t<this._dirtyGroups.length;t++)0>e.indexOf(this._dirtyGroups[t])&&r.push(this._dirtyGroups[t]);this._dirtyGroups=r}for(n in i)if(i.hasOwnProperty(n)&&(t=i[n],e=this._batchGroups[n])){var a=this.prepare(t,e.dynamic,e.maxAabbSize,e._ui||e._sprite);for(t=0;t<a.length;t++)if(s=this.create(a[t],e.dynamic,parseInt(n,10)))for(r=0;r<e.layers.length;r++){var o=this.scene.layers.getLayerById(e.layers[r]);o&&o.addMeshInstances(s.model.meshInstances)}}};var Da=new v,La=new v,Fa=new v;de.prototype.prepare=function(e,t,i,s){if(0===e.length)return[];void 0===i&&(i=Number.POSITIVE_INFINITY),i*=.5;var n,r,a=this.device.supportsBoneTextures?1024:this.device.boneLimit,o=this.device.extUintElement?4294967295:65535,h=new w,l=new w,c=null,d=[],u=0;s&&e.sort(function(e,t){return e.drawOrder-t.drawOrder});for(var p,f=e,m=s?function(e){c?c.add(e.aabb):c=e.aabb.clone(),p.push(e)}:function(e){p.push(e)};0<f.length;){d[u]=[f[0]],p=[],e=f[0].material;var _=f[0].layer,g=f[0]._shaderDefs,y=f[0].parameters,v=f[0].stencilFront,b=f[0]._staticLightList,x=f[0].mesh.vertexBuffer.getNumVertices(),S=f[0].drawOrder;h.copy(f[0].aabb);var T=me(f[0]),M=f[0].mesh.vertexBuffer.format.batchingHash,P=f[0].mesh.primitive[0].indexed;for(c=null,r=1;r<f.length;r++){var A=f[r];if(t&&d[u].length>=a){p=p.concat(f.slice(r));break}if(e!==A.material||_!==A.layer||M!==A.mesh.vertexBuffer.format.batchingHash||P!==A.mesh.primitive[0].indexed||g!==A._shaderDefs||x+A.mesh.vertexBuffer.getNumVertices()>o)m(A);else if(l.copy(h),l.add(A.aabb),l.halfExtents.x>i||l.halfExtents.y>i||l.halfExtents.z>i)m(A);else if(!v||(n=A.stencilFront)&&v.func==n.func&&v.zpass==n.zpass)if(T!=me(A))m(A);else if(pe(y,A.parameters)){var E=A._staticLightList;if(b&&E){if(!fe(b,E)){m(A);continue}}else if(b||E){m(A);continue}s&&c&&c.intersects(A.aabb)&&A.drawOrder!==S?m(A):(h.add(A.aabb),x+=A.mesh.vertexBuffer.getNumVertices(),d[u].push(A))}else m(A);else m(A)}u++,f=p}return d},de.prototype.create=function(e,t,i){this._init||(this.transformVS="#define BONE_LIMIT "+this.device.getBoneLimit()+"\n#define DYNAMICBATCH\n"+Ma.transformVS,this.skinTexVS=Ma.skinBatchTexVS,this.skinConstVS=Ma.skinBatchConstVS,this.vertexFormats={},this._init=!0);var s,n,r=null,a=null,o=0,h=0,l=null;for(s=0;s<e.length;s++)if(e[s].visible){var c=e[s].mesh,d=c.vertexBuffer.numVertices;if(o+=d,h+=c.primitive[0].indexed?c.primitive[0].count:6==c.primitive[0].type&&4===c.primitive[0].count?6:0,!r){for(a=e[s].material,r={},d=c.vertexBuffer.format.elements,n=0;n<d.length;n++){var u=d[n].name;r[u]={numComponents:d[n].numComponents,dataType:d[n].dataType,normalize:d[n].normalize,count:0}}t&&(r.BLENDINDICES={numComponents:1,dataType:6,normalize:!1,count:0})}}if(r){l=new he(e,t,i),this._batchList.push(l);var p,f=0,m=0,_=new v;for(u in h=new(65535>=o?Uint16Array:Uint32Array)(h),r){var g=r[u];g.typeArrayType=la[g.dataType],g.elementByteSize=ca[g.dataType],g.buffer=new g.typeArrayType(o*g.numComponents)}for(s=0;s<e.length;s++)if(e[s].visible){for(u in d=(c=e[s].mesh).vertexBuffer.numVertices,t||(p=e[s].node.getWorldTransform()),r)if("BLENDINDICES"!==u){o=new(g=r[u]).typeArrayType(g.buffer.buffer,g.elementByteSize*g.count);var y=c.getVertexStream(u,o)*g.numComponents;if(g.count+=y,!t&&3<=g.numComponents&&("POSITION"==u||"NORMAL"==u||"TANGENT"==u))for(p.transformFunction="POSITION"==u?x.prototype.transformPoint:x.prototype.transformVector,n=0;n<y;n+=g.numComponents)_.set(o[n],o[n+1],o[n+2]),p.transformFunction(_,_),o[n]=_.x,o[n+1]=_.y,o[n+2]=_.z}if(t)for(g=r.BLENDINDICES,n=0;n<d;n++)g.buffer[g.count++]=s;if(c.primitive[0].indexed)g=c.primitive[0].base,o=c.primitive[0].count,n=c.indexBuffer[0].getFormat(),c=new ua[n](c.indexBuffer[0].storage);else{if(6!=c.primitive[0].type||4!==c.primitive[0].count)continue;g=0,o=6,c=[0,1,3,2,3,1]}for(n=0;n<o;n++)h[n+m]=c[g+n]+f;m+=o,f+=d}for(u in c=new J(this.device),r)g=r[u],c.setVertexStream(u,g.buffer,g.numComponents,void 0,g.dataType,g.normalize);if(0<h.length&&c.setIndices(h),c.update(4,!1),t&&((a=a.clone()).chunks.transformVS=this.transformVS,a.chunks.skinTexVS=this.skinTexVS,a.chunks.skinConstVS=this.skinConstVS,a.update()),(e=new ee(this.rootNode,c,a)).castShadow=l.origMeshInstances[0].castShadow,e.parameters=l.origMeshInstances[0].parameters,e.isStatic=l.origMeshInstances[0].isStatic,e.layer=l.origMeshInstances[0].layer,e._staticLightList=l.origMeshInstances[0]._staticLightList,e._shaderDefs=l.origMeshInstances[0]._shaderDefs,e.cull=l.origMeshInstances[0].cull,(s=this._batchGroups[i])&&s._ui&&(e.cull=!1),t){for(t=[],s=0;s<l.origMeshInstances.length;s++)t.push(l.origMeshInstances[s].node);e.skinInstance=new ce(this.device,t,this.rootNode)}e._updateAabb=!1,e.drawOrder=l.origMeshInstances[0].drawOrder,e.stencilFront=l.origMeshInstances[0].stencilFront,e.stencilBack=l.origMeshInstances[0].stencilBack,e.flipFaces=0>me(l.origMeshInstances[0]),l.meshInstance=e,this.update(l),(t=new oe).meshInstances=[l.meshInstance],t.castShadows=l.origMeshInstances[0].castShadows,l.model=t}return l},de.prototype.update=function(e){e._aabb.copy(e.origMeshInstances[0].aabb);for(var t=1;t<e.origMeshInstances.length;t++)e._aabb.add(e.origMeshInstances[t].aabb);e.meshInstance.aabb=e._aabb,e._aabb._radiusVer=-1,e.meshInstance._aabbVer=0},de.prototype.updateAll=function(){0<this._dirtyGroups.length&&this.generate(this._dirtyGroups);for(var e=0;e<this._batchList.length;e++)this._batchList[e].dynamic&&this.update(this._batchList[e])},de.prototype.clone=function(e,t){var i=new he(t,e.dynamic,e.batchGroupId);this._batchList.push(i);for(var s=[],n=0;n<t.length;n++)s.push(t[n].node);return i.meshInstance=new ee(e.meshInstance.node,e.meshInstance.mesh,e.meshInstance.material),i.meshInstance._updateAabb=!1,i.meshInstance.parameters=t[0].parameters,i.meshInstance.isStatic=t[0].isStatic,i.meshInstance.cull=t[0].cull,i.meshInstance.layer=t[0].layer,i.meshInstance._staticLightList=t[0]._staticLightList,e.dynamic&&(i.meshInstance.skinInstance=new ce(this.device,s,this.rootNode)),i.meshInstance.castShadow=e.meshInstance.castShadow,i.meshInstance._shader=e.meshInstance._shader,(t=new oe).meshInstances=[i.meshInstance],t.castShadows=e.origMeshInstances[0].castShadows,i.model=t,i},de.prototype.destroy=function(e){if(e.refCounter=0,e.model){for(var t=this._batchGroups[e.batchGroupId].layers,i=0;i<t.length;i++){var s=this.scene.layers.getLayerById(t[i]);s&&s.removeMeshInstances(e.model.meshInstances)}e.model.destroy()}},de.prototype.decrement=function(e){e.refCounter--,0===e.refCounter&&this.destroy(e)};var Ba=new v,Na=new v,ka=new v,Ua=new x;Object.assign(_e.prototype,{clone:function(){var e=new _e;return e.projection=this._projection,e.nearClip=this._nearClip,e.farClip=this._farClip,e._shaderParams=this._shaderParams.slice(),e.fov=this._fov,e.aspectRatio=this._aspect,e._aspectRatioMode=this._aspectRatioMode,e.renderTarget=this.renderTarget,e.setClearOptions(this.getClearOptions()),e.frustumCulling=this.frustumCulling,e.cullingMask=this.cullingMask,e},worldToScreen:function(e,t,i,s){if(void 0===s&&(s=new v),this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty){var n=this.getProjectionMatrix(),r=this.getViewMatrix();this._viewProjMat.mul2(n,r),this._viewProjMatDirty=!1}return this._viewProjMat.transformPoint(e,s),n=this._viewProjMat.data,e=e.x*n[3]+e.y*n[7]+e.z*n[11]+1*n[15],s.x=.5*(s.x/e+1)*t,s.y=.5*(1-s.y/e)*i,s},screenToWorld:function(e,t,i,s,n,r){if(void 0===r&&(r=new v),this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty){var a=this.getProjectionMatrix(),o=this.getViewMatrix();this._viewProjMat.mul2(a,o),this._viewProjMatDirty=!1}return Ua.copy(this._viewProjMat).invert(),0===this._projection?(Na.set(e/s*2-1,(n-t)/n*2-1,1),Ua.transformPoint(Na,ka),ka.scale(1/(Na.x*Ua.data[3]+Na.y*Ua.data[7]+Na.z*Ua.data[11]+Ua.data[15])),e=i/this._farClip,r.lerp(this._node.getPosition(),ka,e)):(Ba.set(e/s,(n-t)/n,i/(this._farClip-this._nearClip)),Ba.scale(2),Ba.sub(v.ONE),Ua.transformPoint(Ba,r)),r},getClearOptions:function(){return this._clearOptions},_evaluateProjectionMatrix:function(){if(this._projMatDirty){if(0===this._projection)this._projMat.setPerspective(this._fov,this._aspect,this._nearClip,this._farClip,this._horizontalFov),this._projMatSkybox.copy(this._projMat);else{var e=this._orthoHeight,t=e*this._aspect;this._projMat.setOrtho(-t,t,-e,e,this._nearClip,this._farClip),this._projMatSkybox.setPerspective(this._fov,this._aspect,this._nearClip,this._farClip)}e=this._nearClip,t=this._farClip,this._shaderParams[0]=1/t,this._shaderParams[1]=t,this._shaderParams[2]=(1-t/e)/2,this._shaderParams[3]=(1+t/e)/2,this._projMatDirty=!1}},getProjectionMatrix:function(){return this._evaluateProjectionMatrix(),this._projMat},getProjectionMatrixSkybox:function(){return this._evaluateProjectionMatrix(),this._projMatSkybox},getViewMatrix:function(){if(this._viewMatDirty){var e=this._node.getWorldTransform();this._viewMat.copy(e).invert(),this._viewMatDirty=!1}return this._viewMat},getRect:function(){return this._rect},setClearOptions:function(e){this._clearOptions.color[0]=e.color[0],this._clearOptions.color[1]=e.color[1],this._clearOptions.color[2]=e.color[2],this._clearOptions.color[3]=e.color[3],this._clearOptions.depth=e.depth,this._clearOptions.stencil=e.stencil,this._clearOptions.flags=e.flags},setRect:function(e,t,i,s){this._rect.x=e,this._rect.y=t,this._rect.width=i,this._rect.height=s},setScissorRect:function(e,t,i,s){this._scissorRect.x=e,this._scissorRect.y=t,this._scissorRect.width=i,this._scissorRect.height=s},requestDepthMap:function(){this._renderDepthRequests++},releaseDepthMap:function(){this._renderDepthRequests--}}),Object.defineProperty(_e.prototype,"aspectRatio",{get:function(){return this._aspect},set:function(e){this._aspect!==e&&(this._aspect=e,this._projMatDirty=!0)}}),Object.defineProperty(_e.prototype,"projection",{get:function(){return this._projection},set:function(e){this._projection!==e&&(this._projection=e,this._projMatDirty=!0)}}),Object.defineProperty(_e.prototype,"nearClip",{get:function(){return this._nearClip},set:function(e){this._nearClip!==e&&(this._nearClip=e,this._projMatDirty=!0)}}),Object.defineProperty(_e.prototype,"farClip",{get:function(){return this._farClip},set:function(e){this._farClip!==e&&(this._farClip=e,this._projMatDirty=!0)}}),Object.defineProperty(_e.prototype,"fov",{get:function(){return this._fov},set:function(e){this._fov!==e&&(this._fov=e,this._projMatDirty=!0)}}),Object.defineProperty(_e.prototype,"horizontalFov",{get:function(){return this._horizontalFov},set:function(e){this._horizontalFov!==e&&(this._horizontalFov=e,this._projMatDirty=!0)}}),Object.defineProperty(_e.prototype,"orthoHeight",{get:function(){return this._orthoHeight},set:function(e){this._orthoHeight!==e&&(this._orthoHeight=e,this._projMatDirty=!0)}}),Object.defineProperty(_e.prototype,"clearColor",{get:function(){return this._clearOptions.color},set:function(e){this._clearOptions.color[0]=e[0],this._clearOptions.color[1]=e[1],this._clearOptions.color[2]=e[2],this._clearOptions.color[3]=e[3]}}),Object.defineProperty(_e.prototype,"clearDepth",{get:function(){return this._clearOptions.depth},set:function(e){this._clearOptions.depth=e}}),Object.defineProperty(_e.prototype,"clearStencil",{get:function(){return this._clearOptions.stencil},set:function(e){this._clearOptions.stencil=e}}),Object.defineProperty(_e.prototype,"clearFlags",{get:function(){return this._clearOptions.flags},set:function(e){this._clearOptions.flags=e}});var za=new x,Va=new v,Ga=new S,ja=new S,Wa=new v,Ha=new v,Xa=new x,qa=new S;ge.prototype=Object.create(r.prototype),ge.prototype.constructor=ge,Object.defineProperty(ge.prototype,"right",{get:function(){return this._right||(this._right=new v),this.getWorldTransform().getX(this._right).normalize()}}),Object.defineProperty(ge.prototype,"up",{get:function(){return this._up||(this._up=new v),this.getWorldTransform().getY(this._up).normalize()}}),Object.defineProperty(ge.prototype,"forward",{get:function(){return this._forward||(this._forward=new v),this.getWorldTransform().getZ(this._forward).normalize().scale(-1)}}),Object.defineProperty(ge.prototype,"enabled",{get:function(){return this._enabled&&this._enabledInHierarchy},set:function(e){this._enabled!==e&&(this._enabled=e,this._parent&&!this._parent.enabled||this._notifyHierarchyStateChanged(this,e))}}),Object.defineProperty(ge.prototype,"parent",{get:function(){return this._parent}}),Object.defineProperty(ge.prototype,"path",{get:function(){var e=this._parent;if(e){for(var t=this.name;e&&e._parent;)t=e.name+"/"+t,e=e._parent;return t}return""}}),Object.defineProperty(ge.prototype,"root",{get:function(){var e=this._parent;if(!e)return this;for(;e._parent;)e=e._parent;return e}}),Object.defineProperty(ge.prototype,"children",{get:function(){return this._children}}),Object.defineProperty(ge.prototype,"graphDepth",{get:function(){return this._graphDepth}}),Object.assign(ge.prototype,{_notifyHierarchyStateChanged:function(e,t){e._onHierarchyStateChanged(t);for(var i=0,s=(e=e._children).length;i<s;i++)e[i]._enabled&&this._notifyHierarchyStateChanged(e[i],t)},_onHierarchyStateChanged:function(e){(this._enabledInHierarchy=e)&&!this._frozen&&this._unfreezeParentToRoot()},_cloneInternal:function(e){e.name=this.name;for(var t=this.tags._list,i=0;i<t.length;i++)e.tags.add(t[i]);e._labels=Object.assign({},this._labels),e.localPosition.copy(this.localPosition),e.localRotation.copy(this.localRotation),e.localScale.copy(this.localScale),e.localEulerAngles.copy(this.localEulerAngles),e.position.copy(this.position),e.rotation.copy(this.rotation),e.eulerAngles.copy(this.eulerAngles),e.localTransform.copy(this.localTransform),e._dirtyLocal=this._dirtyLocal,e.worldTransform.copy(this.worldTransform),e._dirtyWorld=this._dirtyWorld,e._dirtyNormal=this._dirtyNormal,e._aabbVer=this._aabbVer+1,e._enabled=this._enabled,e.scaleCompensation=this.scaleCompensation,e._enabledInHierarchy=!1},clone:function(){var e=new ge;return this._cloneInternal(e),e},find:function(e,t){var i,s=[],n=this._children.length;if(e instanceof Function)for((t=e(this))&&s.push(this),i=0;i<n;i++){var r=this._children[i].find(e);r.length&&(s=s.concat(r))}else for(this[e]&&((i=this[e]instanceof Function?this[e]():this[e])===t&&s.push(this)),i=0;i<n;++i)(r=this._children[i].find(e,t)).length&&(s=s.concat(r));return s},findOne:function(e,t){var i,s,n=this._children.length;if(e instanceof Function){if(s=e(this))return this;for(i=0;i<n;i++)if(s=this._children[i].findOne(e))return s}else{if(this[e]&&(i=this[e]instanceof Function?this[e]():this[e])===t)return this;for(i=0;i<n;i++)if(null!==(s=this._children[i].findOne(e,t)))return s}return null},findByTag:function(){var e=this.tags._processArguments(arguments);return this._findByTag(e)},_findByTag:function(e){var t,i=[],s=this._children.length;for(t=0;t<s;t++){this._children[t].tags._has(e)&&i.push(this._children[t]);var n=this._children[t]._findByTag(e);n.length&&(i=i.concat(n))}return i},findByName:function(e){if(this.name===e)return this;for(var t=0;t<this._children.length;t++){var i=this._children[t].findByName(e);if(null!==i)return i}return null},findByPath:function(e){for(var t=this,i=null,s=0,n=(e=e.split("/")).length;s<n&&t;s++){var r=e[s];i=null;for(var a=0,o=(t=t._children).length;a<o;a++)if(t[a].name==r){i=t[a];break}t=i}return i},forEach:function(e,t){e.call(t,this);for(var i=this._children,s=0;s<i.length;s++)i[s].forEach(e,t)},isDescendantOf:function(e){for(var t=this._parent;t;){if(t===e)return!0;t=t._parent}return!1},isAncestorOf:function(e){return e.isDescendantOf(this)},getEulerAngles:function(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles},getLocalEulerAngles:function(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles},getLocalPosition:function(){return this.localPosition},getLocalRotation:function(){return this.localRotation},getLocalScale:function(){return this.localScale},getLocalTransform:function(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform},getPosition:function(){return this.getWorldTransform().getTranslation(this.position),this.position},getRotation:function(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation},getScale:function(){return this._scale||(this._scale=new v),this.getWorldTransform().getScale(this._scale)},getWorldTransform:function(){return this._dirtyLocal||this._dirtyWorld?(this._parent&&this._parent.getWorldTransform(),this._sync(),this.worldTransform):this.worldTransform},reparent:function(e,t){var i=this._parent;i&&i.removeChild(this),e&&(0<=t?e.insertChild(this,t):e.addChild(this))},setLocalEulerAngles:function(e,t,i){e instanceof v?this.localRotation.setFromEulerAngles(e.x,e.y,e.z):this.localRotation.setFromEulerAngles(e,t,i),this._dirtyLocal||this._dirtifyLocal()},setLocalPosition:function(e,t,i){e instanceof v?this.localPosition.copy(e):this.localPosition.set(e,t,i),this._dirtyLocal||this._dirtifyLocal()},setLocalRotation:function(e,t,i,s){e instanceof S?this.localRotation.copy(e):this.localRotation.set(e,t,i,s),this._dirtyLocal||this._dirtifyLocal()},setLocalScale:function(e,t,i){e instanceof v?this.localScale.copy(e):this.localScale.set(e,t,i),this._dirtyLocal||this._dirtifyLocal()},_dirtifyLocal:function(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())},_unfreezeParentToRoot:function(){for(var e=this._parent;e;)e._frozen=!1,e=e._parent},_dirtifyWorld:function(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()},_dirtifyWorldInternal:function(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(var e=0;e<this._children.length;e++)this._children[e]._dirtyWorld||this._children[e]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._aabbVer++},setPosition:function(){var e=new v,t=new x;return function(i,s,n){i instanceof v?e.copy(i):e.set(i,s,n),null===this._parent?this.localPosition.copy(e):(t.copy(this._parent.getWorldTransform()).invert(),t.transformPoint(e,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()}}(),setRotation:function(){var e=new S,t=new S;return function(i,s,n,r){i instanceof S?e.copy(i):e.set(i,s,n,r),null===this._parent?this.localRotation.copy(e):(i=this._parent.getRotation(),t.copy(i).invert(),this.localRotation.copy(t).mul(e)),this._dirtyLocal||this._dirtifyLocal()}}(),setEulerAngles:function(){var e=new S;return function(t,i,s){t instanceof v?this.localRotation.setFromEulerAngles(t.x,t.y,t.z):this.localRotation.setFromEulerAngles(t,i,s),null!==this._parent&&(t=this._parent.getRotation(),e.copy(t).invert(),this.localRotation.mul2(e,this.localRotation)),this._dirtyLocal||this._dirtifyLocal()}}(),addChild:function(e){if(null!==e._parent)throw Error("GraphNode is already parented");this._children.push(e),this._onInsertChild(e)},addChildAndSaveTransform:function(e){var t=e.getPosition(),i=e.getRotation(),s=e._parent;s&&s.removeChild(e),e.setPosition(Xa.copy(this.worldTransform).invert().transformPoint(t)),e.setRotation(qa.copy(this.getRotation()).invert().mul(i)),this._children.push(e),this._onInsertChild(e)},insertChild:function(e,t){if(null!==e._parent)throw Error("GraphNode is already parented");this._children.splice(t,0,e),this._onInsertChild(e)},_onInsertChild:function(e){e._parent=this;var t=e._enabled&&this.enabled;e._enabledInHierarchy!==t&&(e._enabledInHierarchy=t,e._notifyHierarchyStateChanged(e,t)),e._updateGraphDepth(),e._dirtifyWorld(),this._frozen&&e._unfreezeParentToRoot(),e.fire&&e.fire("insert",this),this.fire&&this.fire("childinsert",e)},_updateGraphDepth:function(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(var e=0,t=this._children.length;e<t;e++)this._children[e]._updateGraphDepth()},removeChild:function(e){var t,i=this._children.length;for(t=0;t<i;++t)if(this._children[t]===e){this._children.splice(t,1),e._parent=null,e.fire&&e.fire("remove",this),this.fire&&this.fire("childremove",e);break}},_sync:function(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){var e=this._parent,t=this.localScale,i=e;if(i){for(;i&&i.scaleCompensation;)i=i._parent;if(i&&(i=i._parent)){var s=i.worldTransform.getScale();Wa.mul2(s,this.localScale),t=Wa}}ja.setFromMat4(e.worldTransform),Ga.mul2(ja,this.localRotation),i=e.worldTransform,e.scaleCompensation&&(Ha.mul2(s,e.getLocalScale()),za.setTRS(e.worldTransform.getTranslation(Va),ja,Ha),i=za),i.transformPoint(this.localPosition,Va),this.worldTransform.setTRS(Va,Ga,t)}else this.worldTransform.mul2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}},syncHierarchy:function(){if(this._enabled&&!this._frozen){this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();for(var e=this._children,t=0,i=e.length;t<i;t++)e[t].syncHierarchy()}},lookAt:function(){var e=new x,t=new v,i=new v,s=new S;return function(n,r,a,o,h,l){if(n instanceof v)t.copy(n),r instanceof v?i.copy(r):i.copy(v.UP);else{if(void 0===a)return;t.set(n,r,a),void 0!==o?i.set(o,h,l):i.copy(v.UP)}e.setLookAt(this.getPosition(),t,i),s.setFromMat4(e),this.setRotation(s)}}(),translate:function(){var e=new v;return function(t,i,s){t instanceof v?e.copy(t):e.set(t,i,s),e.add(this.getPosition()),this.setPosition(e)}}(),translateLocal:function(){var e=new v;return function(t,i,s){t instanceof v?e.copy(t):e.set(t,i,s),this.localRotation.transformVector(e,e),this.localPosition.add(e),this._dirtyLocal||this._dirtifyLocal()}}(),rotate:function(){var e=new S,t=new S;return function(i,s,n){i instanceof v?e.setFromEulerAngles(i.x,i.y,i.z):e.setFromEulerAngles(i,s,n),null===this._parent?this.localRotation.mul2(e,this.localRotation):(i=this.getRotation(),s=this._parent.getRotation(),t.copy(s).invert(),e.mul2(t,e),this.localRotation.mul2(e,i)),this._dirtyLocal||this._dirtifyLocal()}}(),rotateLocal:function(){var e=new S;return function(t,i,s){t instanceof v?e.setFromEulerAngles(t.x,t.y,t.z):e.setFromEulerAngles(t,i,s),this.localRotation.mul(e),this._dirtyLocal||this._dirtifyLocal()}}()});var Ya,Ka,Za,$a,Qa=[null,function(e,t){return e.drawOrder-t.drawOrder},function(e,t){return Ya=e._key[0],Ka=t._key[0],Ya===Ka&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:Ka-Ya},function(e,t){return t.zdist-e.zdist},function(e,t){return e.zdist-t.zdist}],Ja=0;xe.prototype.clearVisibleLists=function(e){this.visibleOpaque[e]&&(this.visibleOpaque[e].length=0,this.visibleOpaque[e].list.length=0),this.visibleTransparent[e]&&(this.visibleTransparent[e].length=0,this.visibleTransparent[e].list.length=0)},Object.defineProperty(Se.prototype,"enabled",{get:function(){return this._enabled},set:function(e){e!==this._enabled&&((this._enabled=e)?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}}),Object.defineProperty(Se.prototype,"clearColor",{get:function(){return this._clearColor},set:function(e){this._clearColor.copy(e)}}),Se.prototype._updateClearFlags=function(){var e=0;this._clearColorBuffer&&(e|=1),this._clearDepthBuffer&&(e|=2),this._clearStencilBuffer&&(e|=4),this._clearOptions.flags=e},Object.defineProperty(Se.prototype,"clearColorBuffer",{get:function(){return this._clearColorBuffer},set:function(e){this._clearColorBuffer=e,this._updateClearFlags()}}),Object.defineProperty(Se.prototype,"clearDepthBuffer",{get:function(){return this._clearDepthBuffer},set:function(e){this._clearDepthBuffer=e,this._updateClearFlags()}}),Object.defineProperty(Se.prototype,"clearStencilBuffer",{get:function(){return this._clearStencilBuffer},set:function(e){this._clearStencilBuffer=e,this._updateClearFlags()}}),Se.prototype.incrementCounter=function(){0===this._refCounter&&(this._enabled=!0,this.onEnable)&&this.onEnable(),this._refCounter++},Se.prototype.decrementCounter=function(){if(1===this._refCounter)this._enabled=!1,this.onDisable&&this.onDisable();else if(0===this._refCounter)return;this._refCounter--},Se.prototype.addMeshInstances=function(e,t){for(var i,s,n,r=this._shaderVersion,a=this.shadowCasters,o=0;o<e.length;o++)0>(s=3===(n=(i=e[o]).material).blendType?this.opaqueMeshInstances:this.transparentMeshInstances).indexOf(i)&&s.push(i),!t&&i.castShadow&&0>a.indexOf(i)&&a.push(i),!this.passThrough&&0<=r&&n._shaderVersion!==r&&(n.updateShader!==Fn.prototype.updateShader&&(n.clearVariants(),n.shader=null),n._shaderVersion=r);this.passThrough||(this._dirty=!0)},Se.prototype.removeMeshInstances=function(e,t){var i,s,n=this.opaqueMeshInstances,r=this.transparentMeshInstances,a=this.shadowCasters;for(i=0;i<e.length;i++){var o=e[i],h=-1,l=0,c=n.length;for(s=0;s<c;s++){var d=n[s];if(d===o){h=s,l=1;break}if(d._staticSource===o)0>h&&(h=s),l++;else if(0<=h)break}for(0<=h&&n.splice(h,l),h=-1,l=0,c=r.length,s=0;s<c;s++){if((d=r[s])===o){h=s,l=1;break}if(d._staticSource===o)0>h&&(h=s),l++;else if(0<=h)break}0<=h&&r.splice(h,l),t||0<=(s=a.indexOf(o))&&a.splice(s,1)}this._dirty=!0},Se.prototype.clearMeshInstances=function(e){(0!==this.opaqueMeshInstances.length||0!==this.transparentMeshInstances.length||!e&&0!==this.shadowCasters.length)&&(this.opaqueMeshInstances.length=0,this.transparentMeshInstances.length=0,e||(this.shadowCasters.length=0),this.passThrough||(this._dirty=!0))},Se.prototype.addLight=function(e){0<=this._lightComponents.indexOf(e)||(this._lightComponents.push(e),this._lights.push(e.light),this._dirtyLights=!0,this._generateLightHash())},Se.prototype.removeLight=function(e){var t=this._lightComponents.indexOf(e);0>t||(this._lightComponents.splice(t,1),t=this._lights.indexOf(e.light),this._lights.splice(t,1),this._dirtyLights=!0,this._generateLightHash())},Se.prototype.clearLights=function(){this._lightComponents.length=0,this._lights.length=0,this._dirtyLights=!0},Se.prototype.addShadowCasters=function(e){for(var t,i=this.shadowCasters,s=0;s<e.length;s++)(t=e[s]).castShadow&&0>i.indexOf(t)&&i.push(t);this._dirtyLights=!0},Se.prototype.removeShadowCasters=function(e){for(var t,i=this.shadowCasters,s=0;s<e.length;s++)0<=(t=i.indexOf(e[s]))&&i.splice(t,1);this._dirtyLights=!0},Se.prototype._generateLightHash=function(){if(0<this._lights.length){this._lights.sort(ve);for(var e="",t="",i=0;i<this._lights.length;i++)this._lights[i].isStatic?t+=this._lights[i].key:e+=this._lights[i].key;this._lightHash=0===e.length?0:O(e),this._staticLightHash=0===t.length?0:O(t)}else this._staticLightHash=this._lightHash=0},Se.prototype._generateCameraHash=function(){if(1<this.cameras.length){this.cameras.sort(ye);for(var e="",t=0;t<this.cameras.length;t++)e+=this.cameras[t].entity.getGuid();this._cameraHash=O(e)}else this._cameraHash=0;this._dirtyCameras=!0},Se.prototype.addCamera=function(e){0<=this.cameras.indexOf(e)||(this.cameras.push(e),this._generateCameraHash())},Se.prototype.removeCamera=function(e){0>(e=this.cameras.indexOf(e))||(this.cameras.splice(e,1),this._generateCameraHash(),this.instances.clearVisibleLists(e))},Se.prototype.clearCameras=function(){this._cameraHash=this.cameras.length=0,this._dirtyCameras=!0},Se.prototype._sortCameras=function(){this._generateCameraHash()},Se.prototype._calculateSortDistances=function(e,t,i,s){var n;for(n=0;n<t;n++){var r=e[n];if(!(r.command||2>=r.layer))if(r.calculateSortDistance)r.zdist=r.calculateSortDistance(r,i,s);else{var a=r.aabb.center,o=a.x-i.x,h=a.y-i.y;a=a.z-i.z,r.zdist=o*s.x+h*s.y+a*s.z}}},Se.prototype._sortVisible=function(e,t,i){var s=this.instances,n=e?this.transparentSortMode:this.opaqueSortMode;0!==n&&(e=e?s.visibleTransparent[i]:s.visibleOpaque[i],5===n?(Za=t.getPosition(),$a=t.forward,this.customCalculateSortValues&&this.customCalculateSortValues(e.list,e.length,Za,$a),e.list.length!==e.length&&(e.list.length=e.length),this.customSortCallback&&e.list.sort(this.customSortCallback)):(3!==n&&4!==n||(Za=t.getPosition(),$a=t.forward,this._calculateSortDistances(e.list,e.length,Za,$a)),e.list.length!==e.length&&(e.list.length=e.length),e.list.sort(Qa[n])))};for(var eo,to,io,so,no,ro,ao,oo,ho,lo,co=(new x).mul2((new x).setTranslate(.5,.5,.5),(new x).setScale(.5,.5,.5)),uo={r:1,g:2,b:3,a:4},po=[(new S).setFromEulerAngles(0,90,180),(new S).setFromEulerAngles(0,-90,180),(new S).setFromEulerAngles(90,0,0),(new S).setFromEulerAngles(-90,0,0),(new S).setFromEulerAngles(0,180,180),(new S).setFromEulerAngles(0,0,180)],fo=[{},{},{},{},{}],mo=new Float32Array(2),_o={x:1,y:1,z:0,w:0},go=new x,yo=new x,vo=new x,bo=new x,xo=new x,So=new y,To=new x,wo=new x,Mo=new x,Po=new x,Ao=new x,Eo=new v,Co=new v,Io=new x,Oo=new x,Ro=new x,Do=new x,Lo=new v,Fo=new v,Bo=new v,No=new v,ko={center:null,radius:0},Uo=new w,zo=[0,0],Vo={},Go=null,jo=[],Wo=0;8>Wo;Wo++)jo.push(new v);var Ho=[new v,new v,new v,new v,new v,new v,new v,new v];Object.assign(Ae.prototype,{sortCompare:function(e,t){if(e.layer===t.layer){if(e.drawOrder&&t.drawOrder)return e.drawOrder-t.drawOrder;if(e.zdist&&t.zdist)return t.zdist-e.zdist;if(e.zdist2&&t.zdist2)return e.zdist2-t.zdist2}return t._key[0]-e._key[0]},sortCompareMesh:function(e,t){if(e.layer===t.layer){if(e.drawOrder&&t.drawOrder)return e.drawOrder-t.drawOrder;if(e.zdist&&t.zdist)return t.zdist-e.zdist}return ho=e._key[0],lo=t._key[0],ho===lo&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:lo-ho},depthSortCompare:function(e,t){return ho=e._key[1],lo=t._key[1],ho===lo&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:lo-ho},lightCompare:function(e,t){return e.key-t.key},_isVisible:function(e,t){return!!t.visible&&(t.isVisibleFunc?t.isVisibleFunc(e):(so=t.aabb.center,t._aabb._radiusVer!==t._aabbVer&&(t._aabb._radius=t._aabb.halfExtents.length(),t._aabb._radiusVer=t._aabbVer),ko.radius=t._aabb._radius,ko.center=so,e.frustum.containsSphere(ko)))},getShadowCamera:function(e,t){var i=t._shadowCamera;if(null===i){var s=2,n=4===(i=t._shadowType)||0===i&&e.webgl2;1===t._type&&(n=!1),n||(s|=1),n=new _e,1<=i&&3>=i?(n.clearColor[0]=0,n.clearColor[1]=0,n.clearColor[2]=0,n.clearColor[3]=0):(n.clearColor[0]=1,n.clearColor[1]=1,n.clearColor[2]=1,n.clearColor[3]=1),n.clearDepth=1,n.clearFlags=s,n.clearStencil=null,n._node=new ge,i=t._shadowCamera=n,Pe(e,t)}else(s=i.renderTarget).width===t._shadowResolution&&s.height===t._shadowResolution||Pe(e,t);return i},updateCameraFrustum:function(e){if(e.vrDisplay&&e.vrDisplay.presenting){eo=e.vrDisplay.combinedProj;var t=e._node.parent;t?xo.copy(t.getWorldTransform()).mul(e.vrDisplay.combinedViewInv).invert():xo.copy(e.vrDisplay.combinedView),bo.copy(xo).invert(),this.viewInvId.setValue(bo.data),e.frustum.update(eo,xo)}else if(e.xr&&e.xr.views.length)return t=e.xr.views[0],void e.frustum.update(t.projMat,t.viewOffMat);if(eo=e.getProjectionMatrix(),e.overrideCalculateProjection&&e.calculateProjection(eo,0),e.overrideCalculateTransform)e.calculateTransform(bo,0);else{t=e._node.getPosition();var i=e._node.getRotation();bo.setTRS(t,i,v.ONE),this.viewInvId.setValue(bo.data)}xo.copy(bo).invert(),e.frustum.update(eo,xo)},setCamera:function(e,t,i,s){var n,r=e.vrDisplay;if(r&&r.presenting){if(to=r.leftProj,io=r.rightProj,eo=r.combinedProj,e.overrideCalculateProjection&&(e.calculateProjection(to,1),e.calculateProjection(io,2),e.calculateProjection(eo,0)),e.overrideCalculateTransform)e.calculateTransform(wo,1),e.calculateTransform(Mo,2),e.calculateTransform(bo,0),Po.copy(wo).invert(),Ao.copy(Mo).invert(),xo.copy(bo).invert();else if(n=e._node.parent){var a=n.getWorldTransform();wo.mul2(a,r.leftViewInv),Mo.mul2(a,r.rightViewInv),Po.copy(wo).invert(),Ao.copy(Mo).invert(),xo.copy(n.getWorldTransform()).mul(r.combinedViewInv).invert()}else wo.copy(r.leftViewInv),Mo.copy(r.rightViewInv),Po.copy(r.leftView),Ao.copy(r.rightView),xo.copy(r.combinedView);Ee(Io,Po),Ee(Oo,Ao),Ro.mul2(to,Po),Do.mul2(io,Ao),Eo.x=wo.data[12],Eo.y=wo.data[13],Eo.z=wo.data[14],Co.x=Mo.data[12],Co.y=Mo.data[13],Co.z=Mo.data[14],e.frustum.update(eo,xo)}else if(e.xr&&e.xr.session){(n=e._node.parent)&&(a=n.getWorldTransform()),r=e.xr.views;for(var o=0;o<r.length;o++){var h=r[o];n?(h.viewInvOffMat.mul2(a,h.viewInvMat),h.viewOffMat.copy(h.viewInvOffMat).invert()):(h.viewInvOffMat.copy(h.viewInvMat),h.viewOffMat.copy(h.viewMat)),Ee(h.viewMat3,h.viewOffMat),h.projViewOffMat.mul2(h.projMat,h.viewOffMat),h.position[0]=h.viewInvOffMat.data[12],h.position[1]=h.viewInvOffMat.data[13],h.position[2]=h.viewInvOffMat.data[14],e.frustum.update(h.projMat,h.viewOffMat)}}else eo=e.getProjectionMatrix(),e.overrideCalculateProjection&&e.calculateProjection(eo,0),this.projId.setValue(eo.data),this.projSkyboxId.setValue(e.getProjectionMatrixSkybox().data),e.overrideCalculateTransform?e.calculateTransform(bo,0):(n=e._node.getPosition(),a=e._node.getRotation(),bo.setTRS(n,a,v.ONE)),this.viewInvId.setValue(bo.data),xo.copy(bo).invert(),this.viewId.setValue(xo.data),Ee(So,xo),this.viewId3.setValue(So.data),To.mul2(eo,xo),this.viewProjId.setValue(To.data),n=e._node.getPosition(),this.viewPos[0]=n.x,this.viewPos[1]=n.y,this.viewPos[2]=n.z,this.viewPosId.setValue(this.viewPos),e.frustum.update(eo,xo);this.nearClipId.setValue(e._nearClip),this.farClipId.setValue(e._farClip),this.cameraParamsId.setValue(e._shaderParams),(n=this.device).setRenderTarget(t),n.updateBegin(),r=e.getRect(),a=t?t.width:n.width,t=t?t.height:n.height,o=Math.floor(r.x*a),h=Math.floor(r.y*t);var l=Math.floor(r.width*a);r=Math.floor(r.height*t),n.setViewport(o,h,l,r),n.setScissor(o,h,l,r),i&&n.clear(e._clearOptions),r=e._scissorRect,o=Math.floor(r.x*a),h=Math.floor(r.y*t),l=Math.floor(r.width*a),r=Math.floor(r.height*t),n.setScissor(o,h,l,r),s&&n.setScissor(1,1,a-2,t-2)},dispatchGlobalLights:function(e){var t;if(this.mainLight=-1,this.ambientColor[0]=e.ambientLight.r,this.ambientColor[1]=e.ambientLight.g,this.ambientColor[2]=e.ambientLight.b,e.gammaCorrection)for(t=0;3>t;t++)this.ambientColor[t]=Math.pow(this.ambientColor[t],2.2);this.ambientId.setValue(this.ambientColor),this.exposureId.setValue(e.exposure),e.skyboxModel&&this.skyboxIntensityId.setValue(e.skyboxIntensity)},_resolveLight:function(e,t){var i="light"+t;this.lightColorId[t]=e.resolve(i+"_color"),this.lightDir[t]=new Float32Array(3),this.lightDirId[t]=e.resolve(i+"_direction"),this.lightShadowMapId[t]=e.resolve(i+"_shadowMap"),this.lightShadowMatrixId[t]=e.resolve(i+"_shadowMatrix"),this.lightShadowParamsId[t]=e.resolve(i+"_shadowParams"),this.lightShadowMatrixVsId[t]=e.resolve(i+"_shadowMatrixVS"),this.lightShadowParamsVsId[t]=e.resolve(i+"_shadowParamsVS"),this.lightDirVs[t]=new Float32Array(3),this.lightDirVsId[t]=e.resolve(i+"_directionVS"),this.lightRadiusId[t]=e.resolve(i+"_radius"),this.lightPos[t]=new Float32Array(3),this.lightPosId[t]=e.resolve(i+"_position"),this.lightInAngleId[t]=e.resolve(i+"_innerConeAngle"),this.lightOutAngleId[t]=e.resolve(i+"_outerConeAngle"),this.lightPosVsId[t]=e.resolve(i+"_positionVS"),this.lightCookieId[t]=e.resolve(i+"_cookie"),this.lightCookieIntId[t]=e.resolve(i+"_cookieIntensity"),this.lightCookieMatrixId[t]=e.resolve(i+"_cookieMatrix"),this.lightCookieOffsetId[t]=e.resolve(i+"_cookieOffset")},dispatchDirectLights:function(e,t,i){var s,n=e.length,r=0;this.mainLight=-1;var a=this.device.scope;for(s=0;s<n;s++)if(e[s].mask&i){var o=e[s],h=o._node.getWorldTransform();if(this.lightColorId[r]||this._resolveLight(a,r),this.lightColorId[r].setValue(t.gammaCorrection?o._linearFinalColor:o._finalColor),h.getY(o._direction).scale(-1),o._direction.normalize(),this.lightDir[r][0]=o._direction.x,this.lightDir[r][1]=o._direction.y,this.lightDir[r][2]=o._direction.z,this.lightDirId[r].setValue(this.lightDir[r]),o.castShadows){var l=o._isPcf&&this.device.webgl2?o._shadowCamera.renderTarget.depthBuffer:o._shadowCamera.renderTarget.colorBuffer;o._isVsm?h=-2e-4:(h=o.shadowBias/o._shadowCamera._farClip*100,!this.device.webgl2&&this.device.extStandardDerivatives&&(h*=-100));var c=o._isVsm?o.vsmBias/(o._shadowCamera._farClip/7):o._normalOffsetBias;this.lightShadowMapId[r].setValue(l),this.lightShadowMatrixId[r].setValue(o._shadowMatrix.data),3!==(l=o._rendererParams).length&&(l.length=3),l[0]=o._shadowResolution,l[1]=c,l[2]=h,this.lightShadowParamsId[r].setValue(l),0>this.mainLight&&(this.lightShadowMatrixVsId[r].setValue(o._shadowMatrix.data),this.lightShadowParamsVsId[r].setValue(l),o._direction.normalize(),this.lightDirVs[r][0]=o._direction.x,this.lightDirVs[r][1]=o._direction.y,this.lightDirVs[r][2]=o._direction.z,this.lightDirVsId[r].setValue(this.lightDirVs[r]),this.mainLight=s)}r++}return r},dispatchPointLight:function(e,t,i,s){var n=i._node.getWorldTransform();this.lightColorId[s]||this._resolveLight(t,s),this.lightRadiusId[s].setValue(i.attenuationEnd),this.lightColorId[s].setValue(e.gammaCorrection?i._linearFinalColor:i._finalColor),n.getTranslation(i._position),this.lightPos[s][0]=i._position.x,this.lightPos[s][1]=i._position.y,this.lightPos[s][2]=i._position.z,this.lightPosId[s].setValue(this.lightPos[s]),i.castShadows&&(this.lightShadowMapId[s].setValue(i._shadowCamera.renderTarget.colorBuffer),4!==(e=i._rendererParams).length&&(e.length=4),e[0]=i._shadowResolution,e[1]=i._normalOffsetBias,e[2]=i.shadowBias,e[3]=1/i.attenuationEnd,this.lightShadowParamsId[s].setValue(e)),i._cookie&&(this.lightCookieId[s].setValue(i._cookie),this.lightShadowMatrixId[s].setValue(n.data),this.lightCookieIntId[s].setValue(i.cookieIntensity))},dispatchSpotLight:function(e,t,i,s){var n=i._node.getWorldTransform();this.lightColorId[s]||this._resolveLight(t,s),this.lightInAngleId[s].setValue(i._innerConeAngleCos),this.lightOutAngleId[s].setValue(i._outerConeAngleCos),this.lightRadiusId[s].setValue(i.attenuationEnd),this.lightColorId[s].setValue(e.gammaCorrection?i._linearFinalColor:i._finalColor),n.getTranslation(i._position),this.lightPos[s][0]=i._position.x,this.lightPos[s][1]=i._position.y,this.lightPos[s][2]=i._position.z,this.lightPosId[s].setValue(this.lightPos[s]),n.getY(i._direction).scale(-1),i._direction.normalize(),this.lightDir[s][0]=i._direction.x,this.lightDir[s][1]=i._direction.y,this.lightDir[s][2]=i._direction.z,this.lightDirId[s].setValue(this.lightDir[s]),i.castShadows&&(i._isVsm?e=-2e-4:(e=20*i.shadowBias,!this.device.webgl2&&this.device.extStandardDerivatives&&(e*=-100)),t=i._isVsm?i.vsmBias/(i.attenuationEnd/7):i._normalOffsetBias,this.lightShadowMapId[s].setValue(i._isPcf&&this.device.webgl2?i._shadowCamera.renderTarget.depthBuffer:i._shadowCamera.renderTarget.colorBuffer),this.lightShadowMatrixId[s].setValue(i._shadowMatrix.data),4!==(n=i._rendererParams).length&&(n.length=4),n[0]=i._shadowResolution,n[1]=t,n[2]=e,n[3]=1/i.attenuationEnd,this.lightShadowParamsId[s].setValue(n)),i._cookie&&(this.lightCookieId[s].setValue(i._cookie),i.castShadows||((t=(e=this.getShadowCamera(this.device,i))._node).setPosition(i._node.getPosition()),t.setRotation(i._node.getRotation()),t.rotateLocal(-90,0,0),e.projection=0,e.aspectRatio=1,e.fov=2*i._outerConeAngle,go.setTRS(t.getPosition(),t.getRotation(),v.ONE).invert(),yo.mul2(e.getProjectionMatrix(),go),i._shadowMatrix.mul2(co,yo)),this.lightShadowMatrixId[s].setValue(i._shadowMatrix.data),this.lightCookieIntId[s].setValue(i.cookieIntensity),i._cookieTransform&&(i._cookieTransformUniform[0]=i._cookieTransform.x,i._cookieTransformUniform[1]=i._cookieTransform.y,i._cookieTransformUniform[2]=i._cookieTransform.z,i._cookieTransformUniform[3]=i._cookieTransform.w,this.lightCookieMatrixId[s].setValue(i._cookieTransformUniform),i._cookieOffsetUniform[0]=i._cookieOffset.x,i._cookieOffsetUniform[1]=i._cookieOffset.y,this.lightCookieOffsetId[s].setValue(i._cookieOffsetUniform)))},dispatchLocalLights:function(e,t,i,s,n){var r=e[1];e=e[2];var a=r.length,o=e.length,h=s,l=this.device.scope;for(s=0;s<a;s++){var c=r[s];c.mask&i&&!c.isStatic&&(this.dispatchPointLight(t,l,c,h),h++)}if(r=0,n)for(c=n[r];c&&1===c._type;)this.dispatchPointLight(t,l,c,h),h++,c=n[++r];for(s=0;s<o;s++)(c=e[s]).mask&i&&!c.isStatic&&(this.dispatchSpotLight(t,l,c,h),h++);if(n)for(c=n[r];c&&2===c._type;)this.dispatchSpotLight(t,l,c,h),h++,c=n[++r]},cull:function(e,t,i){var s,n=0,r=t.length,a=e.cullingMask||4294967295;if(!e.frustumCulling){for(s=0;s<r;s++){var o=t[s];(o.visible||o.command)&&(o.mask&&0==(o.mask&a)||(i[n]=o,n++,o.visibleThisFrame=!0))}return n}for(s=0;s<r;s++)if((o=t[s]).command)i[n]=o,n++,o.visibleThisFrame=!0;else if(o.visible){var h=!0;o.mask&&0==(o.mask&a)||(o.cull&&(h=this._isVisible(e,o)),h&&(i[n]=o,n++,o.visibleThisFrame=!0))}return n},cullLights:function(e,t){var i;for(i=0;i<t.length;i++){var s=t[i],n=s._type;s.castShadows&&s.enabled&&0!==s.shadowUpdateMode&&0!==n&&(s.getBoundingSphere(ko),e.frustum.containsSphere(ko)&&(s.visibleThisFrame=!0))}},updateCpuSkinMatrices:function(e){var t,i,s=e.length;if(0!==s)for(t=0;t<s;t++)(i=e[t].skinInstance)&&(i.updateMatrices(e[t].node),i._dirty=!0)},updateGpuSkinMatrices:function(e){var t,i,s=e.length;for(t=0;t<s;t++)e[t].visibleThisFrame&&(i=e[t].skinInstance)&&i._dirty&&(i.updateMatrixPalette(),i._dirty=!1)},updateMorphing:function(e){var t,i,s=e.length;for(t=0;t<s;t++)(i=e[t].morphInstance)&&i._dirty&&e[t].visibleThisFrame&&i.update()},setBaseConstants:function(e,t){e.setCullMode(t.cull),t.opacityMap&&(this.opacityMapId.setValue(t.opacityMap),this.alphaTestId.setValue(t.alphaTest))},setSkinning:function(e,t,i){t.skinInstance&&(this._skinDrawCalls++,e.supportsBoneTextures?(no=t.skinInstance.boneTexture,this.boneTextureId.setValue(no),zo[0]=no.width,zo[1]=no.height,this.boneTextureSizeId.setValue(zo)):this.poseMatrixId.setValue(t.skinInstance.matrixPalette))},drawInstance:function(e,t,i,s,n){if(ro=t.instancingData){if(0<ro.count&&(this._instancedDrawCalls++,this._removedByInstancing+=ro.count,e.setVertexBuffer(ro.vertexBuffer,1,ro.offset),e.draw(i.primitive[s],ro.count),ro.vertexBuffer===Go))return t.instancingData=null,ro.count-1}else ao=t.node.worldTransform,this.modelMatrixId.setValue(ao.data),n&&(oo=t.node.normalMatrix,t.node._dirtyNormal&&(ao.invertTo3x3(oo),oo.transpose(),t.node._dirtyNormal=!1),this.normalMatrixId.setValue(oo.data)),e.draw(i.primitive[s]);return 0},drawInstance2:function(e,t,i,s){if(ro=t.instancingData){if(0<ro.count&&(this._instancedDrawCalls++,this._removedByInstancing+=ro.count,e.setVertexBuffer(ro.vertexBuffer,1,ro.offset),e.draw(i.primitive[s],ro.count),ro.vertexBuffer===Go))return t.instancingData=null,ro.count-1}else e.draw(i.primitive[s]);return 0},renderShadows:function(e,t){var i,s,n=this.device;for(i=0;i<e.length;i++){var r=e[i],a=r._type;if(r.castShadows&&r.enabled&&(r._shadowCamera||this.getShadowCamera(n,r),0!==r.shadowUpdateMode&&r.visibleThisFrame)){var o=this.getShadowCamera(n,r),h=o._node,l=0,c=1;if(0===a){if(0>r._visibleLength[t])continue;l=r._visibleCameraSettings[t],h.setPosition(l.x,l.y,l.z),o.orthoHeight=l.orthoHeight,o.farClip=l.farClip,l=t}else if(2===a){var d=h.getPosition();this.viewPos[0]=d.x,this.viewPos[1]=d.y,this.viewPos[2]=d.z,this.viewPosId.setValue(this.viewPos),this.shadowMapLightRadiusId.setValue(r.attenuationEnd)}else 1===a&&(d=h.getPosition(),this.viewPos[0]=d.x,this.viewPos[1]=d.y,this.viewPos[2]=d.z,this.viewPosId.setValue(this.viewPos),this.shadowMapLightRadiusId.setValue(r.attenuationEnd),c=6);for(1!==a&&(go.setTRS(h.getPosition(),h.getRotation(),v.ONE).invert(),yo.mul2(o.getProjectionMatrix(),go),r._shadowMatrix.mul2(co,yo)),n.webgl2?1===a?n.setDepthBias(!1):(n.setDepthBias(!0),n.setDepthBiasValues(-1e3*r.shadowBias,-1e3*r.shadowBias)):n.extStandardDerivatives&&(1===a?(this.polygonOffset[0]=0,this.polygonOffset[1]=0):(this.polygonOffset[0]=-1e3*r.shadowBias,this.polygonOffset[1]=-1e3*r.shadowBias),this.polygonOffsetId.setValue(this.polygonOffset)),1===r.shadowUpdateMode&&(r.shadowUpdateMode=0),this._shadowMapUpdates+=c,n.setBlending(!1),n.setDepthWrite(!0),n.setDepthTest(!0),r._isPcf&&n.webgl2&&1!==a?n.setColorWrite(!1,!1,!1,!1):n.setColorWrite(!0,!0,!0,!0),l?c=l+1:l=0;l<c;){1===a&&(h.setRotation(po[l]),o.renderTarget=r._shadowCubeMap[l]),this.setCamera(o,o.renderTarget,!0,1!==a),d=r._visibleList[l];var u=r._visibleLength[l],p=r._shadowType,f=p+5*a;for(p=0;p<u;p++){var m=d[p],_=m.mesh,g=m.material;if(this.setBaseConstants(n,g),this.setSkinning(n,m,g),g.dirty&&(g.updateUniforms(),g.dirty=!1),g.chunks){var y=g.parameters;for(s in y)8&(g=y[s]).passFlags&&(g.scopeId||(g.scopeId=n.scope.resolve(s)),g.scopeId.setValue(g.data));for(s in this.setCullMode(!0,!1,m),y=m.parameters)8&(g=y[s]).passFlags&&(g.scopeId||(g.scopeId=n.scope.resolve(s)),g.scopeId.setValue(g.data))}if(!(g=m._shader[3+f])){this.updateShader(m,m._shaderDefs,null,3+f),g=m._shader[3+f],y=m._key;var b=m.material,x=m.skinInstance?10:0,S=0;b.opacityMap&&(b=b.opacityMapChannel)&&(S=uo[b]),y[1]=x+S}n.setShader(g),g=m.renderStyle,this.setVertexBuffers(n,_),this.setMorphing(n,m.morphInstance),n.setIndexBuffer(_.indexBuffer[g]),p+=this.drawInstance(n,m,_,g),this._shadowDrawCalls++}l++,0===a&&(r._visibleLength[t]=-1)}if(r._isVsm&&1<(a=r._vsmBlurSize)){if(o=o.renderTarget,h=Me(n,r._shadowResolution,r._shadowType,1),c=1===r._shadowType,l=r.vsmBlurMode,!(d=(c?this.blurPackedVsmShader:this.blurVsmShader)[l][a])){for(d=this.blurVsmWeights,25<(g=p=a)&&(g=25),y=(g-1)/6,f=.5*(g-1),m=Array(g),_=u=0;_<g;++_)x=_-f,m[_]=Math.exp(-x*x/(2*y*y)),u+=m[_];for(_=0;_<g;++_)m[_]/=u;d[p]=m,d=Ma.fullscreenQuadVS,p="#define SAMPLES "+a+"\n",p=c?p+this.blurPackedVsmShaderCode[l]:p+this.blurVsmShaderCode[l],d=Ma.createShaderFromCode(this.device,d,p,"blurVsm"+l+a+c),c?this.blurPackedVsmShader[l][a]=d:this.blurVsmShader[l][a]=d}_o.z=r._shadowResolution-2,_o.w=_o.z,this.sourceId.setValue(o.colorBuffer),mo[0]=1/r._shadowResolution,mo[1]=0,this.pixelOffsetId.setValue(mo),1===l&&this.weightId.setValue(this.blurVsmWeights[a]),q(n,h,d,null,_o),this.sourceId.setValue(h.colorBuffer),mo[1]=mo[0],mo[0]=0,this.pixelOffsetId.setValue(mo),q(n,o,d,null,_o)}}}n.webgl2?n.setDepthBias(!1):n.extStandardDerivatives&&(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset))},updateShader:function(e,t,i,s,n){e.material._scene=this.scene,e.material.updateShader(this.device,this.scene,t,i,s,n),e._shader[s]=e.material.shader},setCullMode:function(e,t,i){var s=i.material,n=0;e&&(e=1,0<s.cull&&3>s.cull&&(i.flipFaces&&(e*=-1),t&&(e*=-1),(t=i.node.worldTransform).getX(Lo),t.getY(Fo),t.getZ(Bo),Lo.cross(Lo,Fo),0>Lo.dot(Bo)&&(e*=-1)),n=0>e?2===s.cull?1:2:s.cull),this.device.setCullMode(n)},setVertexBuffers:function(e,t){e.setVertexBuffer(t.vertexBuffer,0)},setMorphing:function(e,t){if(t)if(t.morph.useTextureMorph)e.setVertexBuffer(t.morph.vertexBufferIds,1),this.morphPositionTex.setValue(t.texturePositions),this.morphNormalTex.setValue(t.textureNormals),this.morphTexParams.setValue(t._textureParams);else{this.tempSemanticArray.length=0;for(var i,s=0;s<t._activeVertexBuffers.length;s++){var n="ATTR"+s;(i=t._activeVertexBuffers[s])?(i.format.elements[0].name=n,i.format.elements[0].scopeId=e.scope.resolve(n),e.setVertexBuffer(i,s+1)):(e.setVertexBuffer(null,s+1),this.tempSemanticArray.push(n))}this.tempSemanticArray.length&&e.disableVertexBufferElements(this.tempSemanticArray),this.morphWeightsA.setValue(t._shaderMorphWeightsA),this.morphWeightsB.setValue(t._shaderMorphWeightsB)}},renderForward:function(e,t,i,s,n,r,a,o){var h=this.device,l=this.scene,c=e.vrDisplay,d=1<<n;o=o?o._lightHash:0;var u,p,f=null,m=.5*h.width;for(u=0;u<i;u++){var _=t[u];if(!r||!_.mask||r&_.mask)if(_.command)_.command();else{var g=_.mesh,y=_.material,v=_._shaderDefs,b=_.mask;if(this.setSkinning(h,_,y),y&&y===f&&v!==x&&(f=null),(_.isStatic||S)&&(f=null),y!==f){if(this._materialSwitches++,y.dirty&&(y.updateUniforms(),y.dirty=!1),!_._shader[n]||_._shaderDefs!==v||_._lightHash!==o){if(_.isStatic)this.updateShader(_,v,_._staticLightList,n,s);else{var x=n+"_"+v+"_"+o;_._shader[n]=y.variants[x],_._shader[n]||(this.updateShader(_,v,null,n,s),y.variants[x]=_._shader[n])}_._shaderDefs=v,_._lightHash=o}for(p in h.setShader(_._shader[n]),x=y.parameters){var S=x[p];S.passFlags&d&&(S.scopeId||(S.scopeId=h.scope.resolve(p)),S.scopeId.setValue(S.data))}if(!f||b!==T){var T=this.dispatchDirectLights(s[0],l,b);this.dispatchLocalLights(s,l,b,T,_._staticLightList)}this.alphaTestId.setValue(y.alphaTest),h.setBlending(y.blend),y.blend&&(y.separateAlphaBlend?(h.setBlendFunctionSeparate(y.blendSrc,y.blendDst,y.blendSrcAlpha,y.blendDstAlpha),h.setBlendEquationSeparate(y.blendEquation,y.blendAlphaEquation)):(h.setBlendFunction(y.blendSrc,y.blendDst),h.setBlendEquation(y.blendEquation))),h.setColorWrite(y.redWrite,y.greenWrite,y.blueWrite,y.alphaWrite),h.setDepthWrite(y.depthWrite),h.setDepthTest(y.depthTest),h.setAlphaToCoverage(y.alphaToCoverage),y.depthBias||y.slopeDepthBias?(h.setDepthBias(!0),h.setDepthBiasValues(y.depthBias,y.slopeDepthBias)):h.setDepthBias(!1)}for(p in this.setCullMode(e._cullFaces,e._flipFaces,_),T=_.stencilFront||y.stencilFront,x=_.stencilBack||y.stencilBack,T||x?(h.setStencilTest(!0),T===x?(h.setStencilFunc(T.func,T.ref,T.readMask),h.setStencilOperation(T.fail,T.zfail,T.zpass,T.writeMask)):(T?(h.setStencilFuncFront(T.func,T.ref,T.readMask),h.setStencilOperationFront(T.fail,T.zfail,T.zpass,T.writeMask)):(h.setStencilFuncFront(7,0,255),h.setStencilOperationFront(0,0,0,255)),x?(h.setStencilFuncBack(x.func,x.ref,x.readMask),h.setStencilOperationBack(x.fail,x.zfail,x.zpass,x.writeMask)):(h.setStencilFuncBack(7,0,255),h.setStencilOperationBack(0,0,0,255)))):h.setStencilTest(!1),x=_.parameters)(S=x[p]).passFlags&d&&(S.scopeId||(S.scopeId=h.scope.resolve(p)),S.scopeId.setValue(S.data));if(this.setVertexBuffers(h,g),this.setMorphing(h,_.morphInstance),T=_.renderStyle,h.setIndexBuffer(g.indexBuffer[T]),a&&a(_,u),c&&c.presenting)h.setViewport(0,0,m,h.height),this.projId.setValue(to.data),this.projSkyboxId.setValue(to.data),this.viewInvId.setValue(wo.data),this.viewId.setValue(Po.data),this.viewId3.setValue(Io.data),this.viewProjId.setValue(Ro.data),this.viewPos[0]=Eo.x,this.viewPos[1]=Eo.y,this.viewPos[2]=Eo.z,this.viewPosId.setValue(this.viewPos),u+=this.drawInstance(h,_,g,T,!0),this._forwardDrawCalls++,h.setViewport(m,0,m,h.height),this.projId.setValue(io.data),this.projSkyboxId.setValue(io.data),this.viewInvId.setValue(Mo.data),this.viewId.setValue(Ao.data),this.viewId3.setValue(Oo.data),this.viewProjId.setValue(Do.data),this.viewPos[0]=Co.x,this.viewPos[1]=Co.y,this.viewPos[2]=Co.z,this.viewPosId.setValue(this.viewPos),u+=this.drawInstance2(h,_,g,T),this._forwardDrawCalls++;else if(e.xr&&e.xr.session&&e.xr.views.length)for(f=e.xr.views,S=0;S<f.length;S++){var w=f[S];h.setViewport(w.viewport.x,w.viewport.y,w.viewport.z,w.viewport.w),this.projId.setValue(w.projMat.data),this.projSkyboxId.setValue(w.projMat.data),this.viewId.setValue(w.viewOffMat.data),this.viewInvId.setValue(w.viewInvOffMat.data),this.viewId3.setValue(w.viewMat3.data),this.viewProjId.setValue(w.projViewOffMat.data),this.viewPosId.setValue(w.position),u=0===S?u+this.drawInstance(h,_,g,T,!0):u+this.drawInstance2(h,_,g,T,!0),this._forwardDrawCalls++}else u+=this.drawInstance(h,_,g,T,!0),this._forwardDrawCalls++;if(u<i-1&&t[u+1].material===y)for(p in x)(S=y.parameters[p])&&(S.scopeId||(S.scopeId=h.scope.resolve(p)),S.scopeId.setValue(S.data));f=y,x=v,T=b,S=_.isStatic}}h.updateEnd()},setupInstancing:function(e){e.enableAutoInstancing&&(Go||(Go=new I(e,R.defaultInstancingFormat,e.autoInstancingMaxObjects,1)))},revertStaticMeshes:function(e){var t,i=e.length,s=[];for(t=0;t<i;t++){var n=e[t];if(n._staticSource){if(n._staticSource!==r){s.push(n._staticSource);var r=n._staticSource}}else s.push(n)}for(e.length=s.length,t=0;t<s.length;t++)e[t]=s[t]},prepareStaticMeshes:function(e,t){var i,s,n,r,a,o,h,l,c=this.device,d=e.length,u=[],p=new v,f=new v,m=new w,_=new x,g=[],y=[],b=[],S=[];for(i=0;i<d;i++){var T=e[i];if(T.isStatic){var M=T.aabb;for(S.length=0,l=1;2>=l;l++)for(s=0;s<t.length;s++){var P=t[s];P._type===l&&P.enabled&&P.mask&T.mask&&P.isStatic&&(y[s]||(y[s]=new w,P._node.getWorldTransform(),P.getBoundingSphere(ko),y[s].center.copy(ko.center),y[s].halfExtents.x=ko.radius,y[s].halfExtents.y=ko.radius,y[s].halfExtents.z=ko.radius),y[s].intersects(M)&&S.push(s))}if(0===S.length)u.push(T);else{l=(M=T.mesh).vertexBuffer;var A=2===(P=M.indexBuffer[T.renderStyle]).bytesPerIndex?new Uint16Array(P.lock()):new Uint32Array(P.lock()),E=M.primitive[T.renderStyle].count/3,C=M.primitive[T.renderStyle].base,I=l.format.elements,O=l.format.size/4;for(M=new Float32Array(l.storage),n=0;n<I.length;n++)"POSITION"===I[n].name&&(a=I[n].offset/4);for(g.length=E,n=0;n<E;n++)g[n]=0;for(I=!1,b.length=6*E,n=0;n<E;n++){var R=h=o=Number.MAX_VALUE,D=-Number.MAX_VALUE,L=-Number.MAX_VALUE,F=-Number.MAX_VALUE;for(r=0;3>r;r++){var B=M[s=(s=A[3*n+r+C])*O+a],N=M[s+1];B<o&&(o=B),N<h&&(h=N),(s=M[s+2])<R&&(R=s),B>D&&(D=B),N>L&&(L=N),s>F&&(F=s)}b[s=6*n]=o,b[s+1]=h,b[s+2]=R,b[s+3]=D,b[s+4]=L,b[s+5]=F}for(B=0;B<S.length;B++)for(s=S[B],_.copy(T.node.worldTransform).invert(),m.setFromTransformedAabb(y[s],_),N=m.getMin(),o=m.getMax(),r=1<<B,n=0;n<E;n++)b[s=6*n]<=o.x&&b[s+3]>=N.x&&b[s+1]<=o.y&&b[s+4]>=N.y&&b[s+2]<=o.z&&b[s+5]>=N.z&&(g[n]|=r,I=!0);if(I){for(I={},n=0;n<E;n++){s=3*n+C;var k=g[n];I[k]||(I[k]=[]),(r=I[k]).push(A[s]),r.push(A[s+1]),r.push(A[s+2])}for(k in I){for(r=I[k],(2===(A=new Z(c,P.format,r.length,P.usage)).bytesPerIndex?new Uint16Array(A.lock()):new Uint32Array(A.lock())).set(r),A.unlock(),R=h=o=Number.MAX_VALUE,D=-Number.MAX_VALUE,L=-Number.MAX_VALUE,F=-Number.MAX_VALUE,n=0;n<r.length;n++)(B=M[(s=r[n])*O+a])<o&&(o=B),(N=M[s*O+a+1])<h&&(h=N),(s=M[s*O+a+2])<R&&(R=s),B>D&&(D=B),N>L&&(L=N),s>F&&(F=s);for(p.set(o,h,R),f.set(D,L,F),(n=new w).setMinMax(p,f),(E=new J(c)).vertexBuffer=l,E.indexBuffer[0]=A,E.primitive[0].type=4,E.primitive[0].base=0,E.primitive[0].count=r.length,E.primitive[0].indexed=!0,E.aabb=n,(A=new ee(T.node,E,T.material)).isStatic=T.isStatic,A.visible=T.visible,A.layer=T.layer,A.castShadow=T.castShadow,A._receiveShadow=T._receiveShadow,A.cull=T.cull,A.pick=T.pick,A.mask=T.mask,A.parameters=T.parameters,A._shaderDefs=T._shaderDefs,A._staticSource=T,A._staticLightList=T._staticLightList?T._staticLightList:[],n=0;n<S.length;n++)k&(r=1<<n)&&(E=t[S[n]],0>A._staticLightList.indexOf(E)&&A._staticLightList.push(E));A._staticLightList.sort(this.lightCompare),u.push(A)}}else u.push(T)}}else u.push(T)}for(e.length=u.length,i=0;i<u.length;i++)e[i]=u[i]},updateShaders:function(e){var t,i=[];for(t=0;t<e.length;t++){var s=e[t];void 0!==s.material&&-1===i.indexOf(s.material)&&i.push(s.material)}for(t=0;t<i.length;t++)(e=i[t]).updateShader!==Fn.prototype.updateShader&&(e.clearVariants(),e.shader=null)},updateLitShaders:function(e){for(var t=0;t<e.length;t++){var i=e[t];void 0!==i.material&&((i=i.material).updateShader===Fn.prototype.updateShader||!1===i.useLighting||i.emitter&&!i.emitter.lighting||(i.clearVariants(),i.shader=null))}},beginFrame:function(e){var t=this.scene,i=e._meshInstances;e=e._lights,t.updateShaders?(this.updateShaders(i),t.updateShaders=!1,t.updateLitShaders=!1,t._shaderVersion++):t.updateLitShaders&&(this.updateLitShaders(i),t.updateLitShaders=!1,t._shaderVersion++),this.updateCpuSkinMatrices(i);var s=i.length;for(t=0;t<s;t++)i[t].visibleThisFrame=!1;for(s=e.length,t=0;t<s;t++)e[t].visibleThisFrame=0===e[t]._type},beginLayers:function(e){var t,i=this.scene,s=e.layerList.length,n=this.scene._shaderVersion;for(t=0;t<s;t++)e.layerList[t]._postRenderCounter=0;for(t=0;t<s;t++){var r=e.layerList[t];r._shaderVersion=n,r._preRenderCalledForCameras=0,r._postRenderCalledForCameras=0;var a=e.subLayerList[t];for(r._postRenderCounter=a?2|r._postRenderCounter:1|r._postRenderCounter,r._postRenderCounterMax=r._postRenderCounter,a=0;a<r.cameras.length;a++)r.instances.visibleOpaque[a]||(r.instances.visibleOpaque[a]=new be),r.instances.visibleTransparent[a]||(r.instances.visibleTransparent[a]=new be),r.instances.visibleOpaque[a].done=!1,r.instances.visibleTransparent[a].done=!1;r.cameras.length<r.instances.visibleOpaque.length&&r.instances.visibleOpaque.splice(r.cameras.length,1),r.cameras.length<r.instances.visibleTransparent.length&&r.instances.visibleTransparent.splice(r.cameras.length,1),r._needsStaticPrepare&&r._staticLightHash&&(r._staticPrepareDone&&(this.revertStaticMeshes(r.opaqueMeshInstances),this.revertStaticMeshes(r.transparentMeshInstances)),this.prepareStaticMeshes(r.opaqueMeshInstances,r._lights),this.prepareStaticMeshes(r.transparentMeshInstances,r._lights),e._dirty=!0,i.updateShaders=!0,r._needsStaticPrepare=!1,r._staticPrepareDone=!0)}},cullLocalShadowmap:function(e,t){var i,s,n,r,a=e._type;if(0!==a){e.visibleThisFrame=!0;var o=this.getShadowCamera(this.device,e);if(o.projection=0,o.nearClip=e.attenuationEnd/1e3,o.farClip=e.attenuationEnd,o.aspectRatio=1,2===a){o.fov=2*e._outerConeAngle;var h=1}else o.fov=90,h=6;var l=o._node,c=e._node;for(l.setPosition(c.getPosition()),2===a&&(l.setRotation(c.getRotation()),l.rotateLocal(-90,0,0)),i=0;i<h;i++){for(1===a&&(l.setRotation(po[i]),o.renderTarget=e._shadowCubeMap[i]),this.updateCameraFrustum(o),(n=e._visibleList[i])||(n=e._visibleList[i]=[]),c=r=e._visibleLength[i]=0,s=t.length;c<s;c++){var d=t[c],u=!0;d.cull&&(u=this._isVisible(o,d)),u&&(n[r]=d,r++,d.visibleThisFrame=!0)}e._visibleLength[i]=r,n.length!==r&&(n.length=r),n.sort(this.depthSortCompare)}}},cullDirectionalShadowmap:function(e,t,i,s){var n=this.device;e.visibleThisFrame=!0;var r=(n=this.getShadowCamera(n,e))._node,a=e._node;r.setPosition(a.getPosition()),r.setRotation(a.getRotation()),r.rotateLocal(-90,0,0);var o=e.shadowDistance||i._farClip,h=i._nearClip,l=i._fov*Math.PI/180,c=i._aspect,d=i._projection,u=0===d?Math.tan(l/2)*h:i._orthoHeight,p=u*c;for(jo[0].x=p,jo[0].y=-u,jo[0].z=-h,jo[1].x=p,jo[1].y=u,jo[1].z=-h,jo[2].x=-p,jo[2].y=u,jo[2].z=-h,jo[3].x=-p,jo[3].y=-u,jo[3].z=-h,0===d&&(p=(u=Math.tan(l/2)*o)*c),jo[4].x=p,jo[4].y=-u,jo[4].z=-o,jo[5].x=p,jo[5].y=u,jo[5].z=-o,jo[6].x=-p,jo[6].y=u,jo[6].z=-o,jo[7].x=-p,jo[7].y=-u,jo[7].z=-o,c=No.sub2(jo[0],jo[6]).length(),c=Math.max(c,No.sub2(jo[4],jo[6]).length()),go.copy(r.getWorldTransform()).invert(),vo.copy(go).mul(i._node.getWorldTransform()),l=0;8>l;l++)vo.transformPoint(jo[l],jo[l]);for(o=h=i=1e6,p=u=d=-1e6,l=0;8>l;l++){var f=jo[l];f.x<o&&(o=f.x),f.x>p&&(p=f.x),f.y<h&&(h=f.y),f.y>u&&(u=f.y),f.z<i&&(i=f.z),f.z>d&&(d=f.z)}for(l=c/e._shadowResolution,o=.5*((o=Math.floor((o-.5*(c-(p-o)))/l)*l)+c+o),h=.5*((h=Math.floor((h-.5*(c-(u-h)))/l)*l)+c+h),r.translateLocal(o,h,1e5),n.projection=1,n.nearClip=0,n.farClip=2e5,n.aspectRatio=1,n.orthoHeight=.5*c,this.updateCameraFrustum(n),u=!0,(d=e._visibleList[s])||(d=e._visibleList[s]=[]),l=c=e._visibleLength[s]=0,p=t.length;l<p;l++){var m=t[l];f=!0,m.cull&&(f=this._isVisible(n,m)),f&&(d[c]=m,c++,m.visibleThisFrame=!0,f=m.aabb,u?(Uo.copy(f),u=!1):Uo.add(f))}for(e._visibleLength[s]=c,d.length!==c&&(d.length=c),d.sort(this.depthSortCompare),t=Uo.getMin(),l=Uo.getMax(),Ho[0].x=Ho[1].x=Ho[2].x=Ho[3].x=t.x,Ho[1].y=Ho[3].y=Ho[7].y=Ho[5].y=t.y,Ho[2].z=Ho[3].z=Ho[6].z=Ho[7].z=t.z,Ho[4].x=Ho[5].x=Ho[6].x=Ho[7].x=l.x,Ho[0].y=Ho[2].y=Ho[4].y=Ho[6].y=l.y,Ho[0].z=Ho[1].z=Ho[4].z=Ho[5].z=l.z,l=9999999999,t=-9999999999,d=0;8>d;++d)go.transformPoint(Ho[d],Ho[d]),(c=Ho[d].z)<l&&(l=c),c>t&&(t=c);d=t,l>i&&(i=l),r.setPosition(a.getPosition()),r.translateLocal(o,h,d+.01),n.farClip=d-i,(a=e._visibleCameraSettings[s])||(a=e._visibleCameraSettings[s]={}),e=r.getPosition(),a.x=e.x,a.y=e.y,a.z=e.z,a.orthoHeight=n.orthoHeight,a.farClip=n.farClip},gpuUpdate:function(e){this.updateGpuSkinMatrices(e),this.updateMorphing(e)},clearView:function(e,t,i){e=e.camera;var s=this.device;s.setRenderTarget(t),s.updateBegin(),s.setColorWrite(!0,!0,!0,!0),s.setDepthWrite(!0);var n=e.getRect(),r=t?t.width:s.width,a=t?t.height:s.height;t=Math.floor(n.x*r);var o=Math.floor(n.y*a);r=Math.floor(n.width*r),n=Math.floor(n.height*a),s.setViewport(t,o,r,n),s.setScissor(t,o,r,n),s.clear(i||e._clearOptions)},setSceneConstants:function(){var e,t=this.device,i=this.scene;if(this.dispatchGlobalLights(i),"none"!==i.fog){if(this.fogColor[0]=i.fogColor.r,this.fogColor[1]=i.fogColor.g,this.fogColor[2]=i.fogColor.b,i.gammaCorrection)for(e=0;3>e;e++)this.fogColor[e]=Math.pow(this.fogColor[e],2.2);this.fogColorId.setValue(this.fogColor),"linear"===i.fog?(this.fogStartId.setValue(i.fogStart),this.fogEndId.setValue(i.fogEnd)):this.fogDensityId.setValue(i.fogDensity)}this._screenSize[0]=t.width,this._screenSize[1]=t.height,this._screenSize[2]=1/t.width,this._screenSize[3]=1/t.height,this.screenSizeId.setValue(this._screenSize)},renderComposition:function(e){var t,i,s,n,r,a=this.device,o=e._renderedRt,h=e._renderedByCam,l=e._renderedLayer;this.scene.updateSkybox&&(this.scene._updateSkybox(a),this.scene.updateSkybox=!1),this.beginLayers(e),2&e._update()&&(this.scene.updateLitShaders=!0),this.beginFrame(e),this.setSceneConstants();var c=0;for(i=0;i<e.layerList.length;i++){var d=e.layerList[i];if(d.enabled&&e.subLayerEnabled[i]){var u=e.subLayerList[i],p=d.instances,f=d.cameras;for(s=0;s<f.length;s++)if(t=f[s]){t.frameBegin(d.renderTarget);var m=u?d.transparentMeshInstances:d.opaqueMeshInstances,_=r=!1;for(n=0;n<c;n++)if(h[n]===t&&(r=!0,l[n]===d)){_=!0;break}r||(this.updateCameraFrustum(t.camera),this._camerasRendered++),_||this.cullLights(t.camera,d._lights),r&&_||(h[c]=t,l[c]=d,c++),(n=u?p.visibleTransparent[s]:p.visibleOpaque[s]).done||(d.onPreCull&&d.onPreCull(s),n.length=this.cull(t.camera,m,n.list),n.done=!0,d.onPostCull&&d.onPostCull(s)),t.frameEnd()}}}for(i=0;i<e._lights.length;i++)(t=e._lights[i]).visibleThisFrame&&0!==t._type&&t.castShadows&&t.enabled&&0!==t.shadowUpdateMode&&(d=e._lightShadowCasters[i],this.cullLocalShadowmap(t,d));for(u=-1,i=0;i<e._lights.length;i++)if(0===(t=e._lights[i])._type&&(u++,t.castShadows&&t.enabled&&0!==t.shadowUpdateMode))for(d=e._lightShadowCasters[i],f=e._globalLightCameras[u],s=0;s<f.length;s++)this.cullDirectionalShadowmap(t,d,f[s].camera,e._globalLightCameraIds[u][s]);for(this.gpuUpdate(e._meshInstances),this.renderShadows(e._sortedLights[2]),this.renderShadows(e._sortedLights[1]),i=c=0;i<e._renderList.length;i++)if((d=e.layerList[e._renderList[i]]).enabled&&e.subLayerEnabled[e._renderList[i]]){if(p=d.instances,u=e.subLayerList[e._renderList[i]],f=e._renderListCamera[i],(t=d.cameras[f])&&t.frameBegin(d.renderTarget),!u&&d.onPreRenderOpaque?d.onPreRenderOpaque(f):u&&d.onPreRenderTransparent&&d.onPreRenderTransparent(f),d._preRenderCalledForCameras&1<<f||(d.onPreRender&&d.onPreRender(f),d._preRenderCalledForCameras|=1<<f,d.overrideClear&&this.clearView(t,d.renderTarget,d._clearOptions)),t){for(s=d.renderTarget,l=!1,n=0;n<c;n++)if(o[n]===s&&h[n]===t){l=!0;break}l||(d.overrideClear||this.clearView(t,d.renderTarget),o[c]=s,h[c]=t,c++),this.renderShadows(d._sortedLights[0],f),d._sortVisible(u,t.node,f),n=u?p.visibleTransparent[f]:p.visibleOpaque[f],this.scene._activeCamera=t.camera,this.setCamera(t.camera,d.renderTarget),this.renderForward(t.camera,n.list,n.length,d._sortedLights,d.shaderPass,d.cullingMask,d.onDrawCall,d),a.setColorWrite(!0,!0,!0,!0),a.setStencilTest(!1),a.setAlphaToCoverage(!1),a.setDepthBias(!1),t.frameEnd()}!u&&d.onPostRenderOpaque?d.onPostRenderOpaque(f):u&&d.onPostRenderTransparent&&d.onPostRenderTransparent(f),!d.onPostRender||d._postRenderCalledForCameras&1<<f||(d._postRenderCounter&=~(u?2:1),0===d._postRenderCounter&&(d.onPostRender(f),d._postRenderCalledForCameras|=1<<f,d._postRenderCounter=d._postRenderCounterMax))}}}),Ce.prototype=Object.create(Fn.prototype),Ce.prototype.constructor=Ce,Object.assign(Ce.prototype,{clone:function(){var e=new Ce;return Fn.prototype._cloneInternal.call(this,e),e.color.copy(this.color),e.colorMap=this.colorMap,e.vertexColors=this.vertexColors,e},updateUniforms:function(){this.clearParameters(),this.colorUniform[0]=this.color.r,this.colorUniform[1]=this.color.g,this.colorUniform[2]=this.color.b,this.colorUniform[3]=this.color.a,this.setParameter("uColor",this.colorUniform),this.colorMap&&this.setParameter("texture_diffuseMap",this.colorMap)},updateShader:function(e,t,i,s,n,r){t={skin:!!this.meshInstances[0].skinInstance,vertexColors:this.vertexColors,diffuseMap:this.colorMap,pass:n},this.shader=e.getProgramLibrary().getProgram("basic",t)}});var Xo=new ge;Ie.prototype.addLayer=function(e){0>this.layers.indexOf(e)&&this.layers.push(e)},Ie.prototype.getLayerIdx=function(e){return this.layerToBatch[e.id]},Ie.prototype.addLayerIdx=function(e,t){this.layerToBatch[t.id]=e},Object.assign(Oe.prototype,{init:function(e,t,i,s){for(this.mesh||(this.mesh=new J(e),this.mesh.primitive[0].type=1,this.mesh.primitive[0].base=0,this.mesh.primitive[0].indexed=!1,this.material=new Ce,this.material.vertexColors=!0,this.material.blend=!0,this.material.blendType=2,this.material.update()),this.layer=i;this.linesUsed+s>this.numLinesAllocated;)this.vb&&(this.vb.destroy(),this.vb=null),this.numLinesAllocated*=2;this.vertexFormat=t,this.vb||(this.vb=new I(e,t,2*this.numLinesAllocated,1),this.mesh.vertexBuffer=this.vb,this.vbRam=new DataView(this.vb.lock()),this.meshInstance||(Xo.worldTransform=x.IDENTITY,Xo._dirtyWorld=Xo._dirtyNormal=!1,this.meshInstance=new ee(Xo,this.mesh,this.material),this.meshInstance.cull=!1))},addLines:function(e,t){for(var i,s=!!t.length,n=2*this.linesUsed*this.vertexFormat.size,r=0;r<e.length;r++)this.vbRam.setFloat32(n,e[r].x,!0),n+=4,this.vbRam.setFloat32(n,e[r].y,!0),n+=4,this.vbRam.setFloat32(n,e[r].z,!0),n+=4,i=s?t[r]:t,this.vbRam.setUint8(n,255*i.r),n+=1,this.vbRam.setUint8(n,255*i.g),n+=1,this.vbRam.setUint8(n,255*i.b),n+=1,this.vbRam.setUint8(n,255*i.a),n+=1;this.linesUsed+=e.length/2},finalize:function(e){0<this.linesUsed&&(this.vb.setData(this.vbRam.buffer),this.mesh.primitive[0].count=2*this.linesUsed,e[0]=this.meshInstance,this.layer.addMeshInstances(e,!0),this.linesUsed=0)}}),Re.prototype=Object.create(r.prototype),Re.prototype.constructor=Re,Re.prototype._sortLights=function(e){var t=e._lights;e._sortedLights[0].length=0,e._sortedLights[1].length=0;for(var i=e._sortedLights[2].length=0;i<t.length;i++){var s=t[i];s.enabled&&e._sortedLights[s._type].push(s)}},Re.prototype._update=function(){var e,t,i=this.layerList.length,s=0;if(!this._dirty||!this._dirtyLights||!this._dirtyCameras)for(e=0;e<i;e++){var n=this.layerList[e];n._dirty&&(this._dirty=!0),n._dirtyLights&&(this._dirtyLights=!0),n._dirtyCameras&&(this._dirtyCameras=!0)}if(this._dirty){for(s|=1,e=this._meshInstances.length=0;e<i;e++)if(!(n=this.layerList[e]).passThrough){var r=n.opaqueMeshInstances;for(t=0;t<r.length;t++){var a=r[t];0>this._meshInstances.indexOf(a)&&(this._meshInstances.push(a),a.material&&a.material._dirtyBlend&&(this._dirtyBlend=!0,a.material._dirtyBlend=!1))}for(r=n.transparentMeshInstances,t=0;t<r.length;t++)a=r[t],0>this._meshInstances.indexOf(a)&&(this._meshInstances.push(a),a.material&&a.material._dirtyBlend&&(this._dirtyBlend=!0,a.material._dirtyBlend=!1))}for(e=0;e<i;e++)this.layerList[e]._dirty=!1,this.layerList[e]._version++;this._dirty=!1}if(this._dirtyBlend){for(s|=8,e=0;e<i;e++)if(!(n=this.layerList[e]).passThrough){r=n.opaqueMeshInstances,a=n.transparentMeshInstances;var o=[],h=[];for(t=0;t<r.length;t++)r[t].material&&3!==r[t].material.blendType?h.push(r[t]):o.push(r[t]);for(t=0;t<a.length;t++)a[t].material&&3!==a[t].material.blendType?h.push(a[t]):o.push(a[t]);for(n.opaqueMeshInstances.length=o.length,t=0;t<o.length;t++)n.opaqueMeshInstances[t]=o[t];for(n.transparentMeshInstances.length=h.length,t=0;t<h.length;t++)n.transparentMeshInstances[t]=h[t]}this._dirtyBlend=!1}if(this._dirtyLights){for(s|=2,this._lights.length=0,e=this._lightShadowCasters.length=0;e<i;e++)for(r=(n=this.layerList[e])._lights,t=0;t<r.length;t++)o=r[t],0>(a=this._lights.indexOf(o))&&(this._lights.push(o),a=this._lights.length-1),(o=this._lightShadowCasters[a])||(this._lightShadowCasters[a]=[]);for(this._sortLights(this),this._dirtyLights=!1,e=0;e<i;e++)n=this.layerList[e],this._sortLights(n),n._dirtyLights=!1}if(s)for(e=0;e<i;e++)for(r=(n=this.layerList[e])._lights,t=0;t<r.length;t++){for(o=r[t],a=this._lights.indexOf(o),o=this._lightShadowCasters[a],h=n.shadowCasters,a=0;a<o.length;)0>this._meshInstances.indexOf(o[a])?(o[a]=o[o.length-1],--o.length):a++;for(a=0;a<h.length;a++)0>o.indexOf(h[a])&&o.push(h[a])}if(2&s||this._dirtyCameras)for(this._globalLightCameras.length=0,r=this._sortedLights[0],t=0;t<r.length;t++)for(o=r[t],this._globalLightCameras[t]=[],e=0;e<i;e++)if(!(0>(n=this.layerList[e])._sortedLights[0].indexOf(o)))for(a=0;a<n.cameras.length;a++)0<=this._globalLightCameras[t].indexOf(n.cameras[a])||this._globalLightCameras[t].push(n.cameras[a]);if(this._dirtyCameras){for(s|=4,e=this.cameras.length=0;e<i;e++)for(n=this.layerList[e],t=0;t<n.cameras.length;t++)r=n.cameras[t],0>(a=this.cameras.indexOf(r))&&this.cameras.push(r);for(this._renderList.length=0,e=a=this._renderListCamera.length=0;e<i;e++)if(a)a--;else if(0!==(n=this.layerList[e]).cameras.length||n.isPostEffect)if(0===(o=n._cameraHash))this._renderList.push(e),this._renderListCamera.push(0);else{for(r=1,t=e+1;t<i;t++){if(o!==(h=this.layerList[t]._cameraHash)){r=t-e-1;break}t===i-1&&(r=t-e)}if(1===r)for(o=0;o<n.cameras.length;o++)this._renderList.push(e),this._renderListCamera.push(o);else{for(o=0;o<n.cameras.length;o++)for(t=0;t<=r;t++)this._renderList.push(e+t),this._renderListCamera.push(o);a=r}}for(this._dirtyCameras=!1,e=0;e<i;e++)this.layerList[e]._dirtyCameras=!1}if(2&s||4&s)for(t=this._globalLightCameraIds.length=0;t<this._globalLightCameras.length;t++){for(r=[],e=0;e<this._globalLightCameras[t].length;e++)0>(a=this.cameras.indexOf(this._globalLightCameras[t][e]))||r.push(a);this._globalLightCameraIds.push(r)}return s},Re.prototype._isLayerAdded=function(e){return 0<=this.layerList.indexOf(e)},Re.prototype._isSublayerAdded=function(e,t){for(var i=0;i<this.layerList.length;i++)if(this.layerList[i]===e&&this.subLayerList[i]===t)return!0;return!1},Re.prototype.push=function(e){this._isLayerAdded(e)||(this.layerList.push(e),this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",e))},Re.prototype.insert=function(e,t){if(!this._isLayerAdded(e)){this.layerList.splice(t,0,e,e),this.subLayerList.splice(t,0,!1,!0);var i=this.layerList.length;this._updateOpaqueOrder(t,i-1),this._updateTransparentOrder(t,i-1),this.subLayerEnabled.splice(t,0,!0,!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",e)}},Re.prototype.remove=function(e){var t=this.layerList.indexOf(e);for(delete this._opaqueOrder[t],delete this._transparentOrder[t];0<=t;)this.layerList.splice(t,1),this.subLayerList.splice(t,1),this.subLayerEnabled.splice(t,1),t=this.layerList.indexOf(e),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("remove",e);e=this.layerList.length,this._updateOpaqueOrder(0,e-1),this._updateTransparentOrder(0,e-1)},Re.prototype.pushOpaque=function(e){this._isSublayerAdded(e,!1)||(this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",e))},Re.prototype.insertOpaque=function(e,t){this._isSublayerAdded(e,!1)||(this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!1),this._updateOpaqueOrder(t,this.subLayerList.length-1),this.subLayerEnabled.splice(t,0,!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",e))},Re.prototype.removeOpaque=function(e){for(var t=0,i=this.layerList.length;t<i;t++)if(this.layerList[t]===e&&!this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),i--,this._updateOpaqueOrder(t,i-1),this.subLayerEnabled.splice(t,1),this._dirtyCameras=this._dirtyLights=this._dirty=!0,0>this.layerList.indexOf(e)&&this.fire("remove",e);break}},Re.prototype.pushTransparent=function(e){this._isSublayerAdded(e,!0)||(this.layerList.push(e),this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",e))},Re.prototype.insertTransparent=function(e,t){this._isSublayerAdded(e,!0)||(this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!0),this._updateTransparentOrder(t,this.subLayerList.length-1),this.subLayerEnabled.splice(t,0,!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",e))},Re.prototype.removeTransparent=function(e){for(var t=0,i=this.layerList.length;t<i;t++)if(this.layerList[t]===e&&this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),i--,this._updateTransparentOrder(t,i-1),this.subLayerEnabled.splice(t,1),this._dirtyCameras=this._dirtyLights=this._dirty=!0,0>this.layerList.indexOf(e)&&this.fire("remove",e);break}},Re.prototype._getSublayerIndex=function(e,t){var i=this.layerList.indexOf(e);return 0>i||this.subLayerList[i]!==t&&(0>(i=this.layerList.indexOf(e,i+1))||this.subLayerList[i]!==t)?-1:i},Re.prototype.getOpaqueIndex=function(e){return this._getSublayerIndex(e,!1)},Re.prototype.getTransparentIndex=function(e){return this._getSublayerIndex(e,!0)},Re.prototype.getLayerById=function(e){for(var t=0;t<this.layerList.length;t++)if(this.layerList[t].id===e)return this.layerList[t];return null},Re.prototype.getLayerByName=function(e){for(var t=0;t<this.layerList.length;t++)if(this.layerList[t].name===e)return this.layerList[t];return null},Re.prototype._updateOpaqueOrder=function(e,t){for(;e<=t;e++)!1===this.subLayerList[e]&&(this._opaqueOrder[this.layerList[e].id]=e)},Re.prototype._updateTransparentOrder=function(e,t){for(;e<=t;e++)!0===this.subLayerList[e]&&(this._transparentOrder[this.layerList[e].id]=e)},Re.prototype._sortLayersDescending=function(e,t,i){var s,n=-1,r=-1,a=0;for(s=e.length;a<s;a++){var o=e[a];i.hasOwnProperty(o)&&(n=Math.max(n,i[o]))}for(a=0,s=t.length;a<s;a++)o=t[a],i.hasOwnProperty(o)&&(r=Math.max(r,i[o]));return-1===n&&-1!==r?1:-1===r&&-1!==n?-1:r-n},Re.prototype.sortTransparentLayers=function(e,t){return this._sortLayersDescending(e,t,this._transparentOrder)},Re.prototype.sortOpaqueLayers=function(e,t){return this._sortLayersDescending(e,t,this._opaqueOrder)};var qo,Yo=[],Ko=[],Zo=new v,$o=new w,Qo=new w,Jo={},eh=["texture_lightMap","texture_dirLightMap"],th=[];Object.assign(Le.prototype,{destroy:function(){this.assets=this.renderer=this.scene=this.root=this.device=null},calculateLightmapSize:function(e){var t=this.scene.lightmapSizeMultiplier||16,i=1,s=1,n=1,r=1;if(e.model.asset){var a=this.assets.get(e.model.asset).data;a.area&&(i=a.area.x,s=a.area.y,n=a.area.z,r=a.area.uv)}else e.model._area&&((a=e.model)._area&&(i=a._area.x,s=a._area.y,n=a._area.z,r=a._area.uv));for(i*=a=e.model.lightmapSizeMultiplier||1,s*=a,n*=a,Zo.copy(e.localScale),e=e._parent;e;)Zo.mul(e.localScale),e=e._parent;return Zo.x=Math.abs(Zo.x),Zo.y=Math.abs(Zo.y),Zo.z=Math.abs(Zo.z),i=i*Zo.y*Zo.z+s*Zo.x*Zo.z+n*Zo.x*Zo.y,i=Math.sqrt(i/r),Math.min(Hr.nextPowerOfTwo(i*t),this.scene.lightmapMaxResolution||2048)},bake:function(e,t){var i,s,n,r=this.device,a=this.scene,o=1;void 0===t&&(t=1),1===t&&(o=2),t=[];var l=[];if(e){var c;for(i=Ko.length-1;0<=i;i--)for(s=0;s<e.length;s++)if(Ko[i]===e[s]){for(c=0;c<Yo[i].length;c++)Yo[i][c].destroy();Yo.splice(i,1),Ko.splice(i,1)}for(c=[],i=0;i<e.length;i++)De(e[i],c,l);e=c,De(this.root,null,null,t)}else{for(i=0;i<Yo.length;i++)for(s=0;s<Yo[i].length;s++)Yo[i][s].destroy();Yo=[],Ko=[],e=[],De(this.root,e,l,t)}if(0===e.length)r.fire("lightmapper:end",{timestamp:Xr(),target:this});else{c=!1,a._needsStaticPrepare&&(a._needsStaticPrepare=!1,c=!0);var d=[[],[]],u={};for((s=new K(this.device,{width:4,height:4,format:7,type:"rgbm"})).name="lightmap",i=0;i<e.length;i++){var p=this.calculateLightmapSize(e[i]);for(n=0;n<o;n++){var f=new K(r,{width:p,height:p,format:7,mipmaps:!1,type:0===n?"rgbm":"default",minFilter:0,magFilter:0});f.name="lightmap",d[n].push(f)}if(!u[p]){var m=new K(r,{width:p,height:p,format:7,mipmaps:!1,type:"rgbm",minFilter:0,magFilter:0});m.name="lightmap",m=new Bu(r,m,{depth:!1}),u[p]=m}}var _=a.layers;_._update(),p=[],m=[];var g=[],y=[],v=_._lights;for(i=0;i<v.length;i++)v[i].enabled&&(0!=(4&(f=v[i].mask))&&(m.push(f),g.push(v[i].shadowUpdateMode),v[i].mask=4294967295,v[i].shadowUpdateMode=0===v[i]._type?2:1,p.push(v[i]),v[i].isStatic=!1)),y.push(v[i].enabled),v[i].enabled=!1;var b=Ma,x="#define UV1LAYOUT\n"+b.transformVS,S=b.bakeLmEndPS;f=b.createShaderFromCode(r,b.fullscreenQuadVS,b.dilatePS,"lmDilate");var T=r.scope.resolve("source"),M=r.scope.resolve("pixelOffset"),P=r.scope.resolve("bakeDir"),A=new Float32Array(2);for(_=_._meshInstances,i=0;i<_.length;i++)_[i].node&&_[i].node.getWorldTransform();_=a.fog;var E=a.ambientLight.r,C=a.ambientLight.g,I=a.ambientLight.b;a.fog="none",a.ambientLight.set(0,0,0),qo||((qo=new _e)._node=new ge,qo.clearColor[0]=0,qo.clearColor[1]=0,qo.clearColor[2]=0,qo.clearColor[3]=0,qo.clearDepth=1,qo.clearFlags=1,qo.clearStencil=null,qo.frustumCulling=!1);var O,R=[];for(R.length=Ko.length,O=0;O<t.length;O++){var D=t[O].model.model.meshInstances,L=[];for(i=0;i<D.length;i++)L.push(D[i]._shaderDefs),D[i]._shaderDefs&=-193;for(i=0;i<Ko.length;i++)if(Ko[i]===t[O]){R[i]=L;break}}L=[];var F=[];for(O=0;O<t.length;O++)if(L[O]=t[O].model.castShadows,t[O].model.castShadows=t[O].model.castShadowsLightmap,t[O].model.castShadowsLightmap){var B=t[O].model.meshInstances;for(i=0;i<B.length;i++)B[i].visibleThisFrame=!0,F.push(B[i])}this.renderer.updateCpuSkinMatrices(F),this.renderer.gpuUpdate(F);var N=[],k=[];B=[[],[]];var U=[];for(U.length=e.length,n=0;n<o;n++)th[n]||((i=new Nn).chunks.transformVS=x,0===n?(i.chunks.endPS=S,i.ambient=new h(0,0,0),i.ambientTint=!0,i.lightMap=s):(i.chunks.basePS=b.basePS+"\nuniform sampler2D texture_dirLightMap;\nuniform float bakeDir;\n",i.chunks.endPS=b.bakeDirLmEndPS),i.chunks.outputAlphaPS="\n",i.chunks.outputAlphaOpaquePS="\n",i.chunks.outputAlphaPremulPS="\n",i.cull=0,i.forceUv1=!0,i.update(),i.updateShader(r,a),i.name="lmMaterial"+n,th[n]=i);for(O=0;O<e.length;O++){if(D=l[O],U[O]=0,0<D.length)for($o.copy(D[0].aabb),i=0;i<D.length;i++)D[i].node.getWorldTransform(),$o.add(D[i].aabb);for((i=new w).copy($o),k.push(i),i=0;i<D.length;i++){var z=D[i];z._shaderDefs&=-193,z.mask=4,z.deleteParameter("texture_lightMap"),z.deleteParameter("texture_dirLightMap"),z.setParameter("texture_lightMap",z.material.lightMap?z.material.lightMap:s),z.setParameter("texture_dirLightMap",s)}for(n=0;n<o;n++){var V=d[n][O],G=new Bu(r,V,{depth:!1});B[n].push(G)}}for(s=0;s<p.length;s++)p[s].enabled=!1;for(b=[[],[],[]],x=!1,i=0;i<p.length;i++){if(p[i].enabled=!0,S=!1,p[i]._cacheShadowMap=!0,0!==p[i]._type&&(p[i]._node.getWorldTransform(),p[i].getBoundingSphere(Jo),Qo.center=Jo.center,Qo.halfExtents.x=Jo.radius,Qo.halfExtents.y=Jo.radius,Qo.halfExtents.z=Jo.radius),2===p[i]._type){O=p[i];var j=this.renderer.getShadowCamera(r,O);j._node.setPosition(O._node.getPosition()),j._node.setRotation(O._node.getRotation()),j._node.rotateLocal(-90,0,0),j.projection=0,j.nearClip=O.attenuationEnd/1e3,j.farClip=O.attenuationEnd,j.aspectRatio=1,j.fov=2*O._outerConeAngle,this.renderer.updateCameraFrustum(j)}for(0<l.length&&this.renderer.updateShaders(l[0]),O=0;O<e.length;O++){if(D=l[O],$o=k[O],0===p[i]._type)Zo.copy($o.center),Zo.y+=$o.halfExtents.y,qo._node.setPosition(Zo),qo._node.setEulerAngles(-90,0,0),s=Math.max($o.halfExtents.x,$o.halfExtents.z),qo.projection=1,qo.nearClip=0,qo.farClip=2*$o.halfExtents.y,qo.aspectRatio=1,qo.orthoHeight=s;else if(!Qo.intersects($o))continue;if(2===p[i]._type){for(n=!1,s=0;s<D.length;s++)if(this.renderer._isVisible(j,D[s])){n=!0;break}if(!n)continue}for(0===p[i]._type?(b[0][0]=p[i],b[1].length=0,b[2].length=0,!S&&p[i].castShadows&&(this.renderer.cullDirectionalShadowmap(p[i],F,qo,0),this.renderer.renderShadows(b[0],0),S=!0)):(b[0].length=0,1===p[i]._type?(b[1][0]=p[i],b[2].length=0,!S&&p[i].castShadows&&(this.renderer.cullLocalShadowmap(p[i],F),this.renderer.renderShadows(b[1]),S=!0)):(b[1].length=0,b[2][0]=p[i],!S&&p[i].castShadows&&(this.renderer.cullLocalShadowmap(p[i],F),this.renderer.renderShadows(b[2]),S=!0))),s=0;s<D.length;s++)N[s]=D[s].material;for(n=0;n<o;n++){V=d[n][O],G=B[n][O];var W=(z=u[V.width]).colorBuffer;for(0===n?x=a.updateShaders:x&&(a.updateShaders=!0),s=0;s<D.length;s++)D[s].material=th[n];for(1<o&&this.renderer.updateShaders(D),this.renderer.setCamera(qo,z,!0),1===n&&P.setValue(p[i].bakeDir?1:0),this.renderer._forwardTime=0,this.renderer._shadowMapTime=0,this.renderer.renderForward(qo,D,D.length,b,1),d[n][O]=W,B[n][O]=z,u[V.width]=G,s=0;s<D.length;s++)(z=D[s]).setParameter(eh[n],W),z._shaderDefs|=64}for(U[O]++,s=0;s<D.length;s++)D[s].material=N[s]}p[i].enabled=!1,p[i]._cacheShadowMap=!1,p[i]._isCachedShadowMap&&p[i]._destroyShadowMap()}for(O=0;O<e.length;O++){for(D=l[O],j=[],n=0;n<o;n++){for(V=d[n][O],G=B[n][O],W=(z=u[V.width]).colorBuffer,A[0]=1/V.width,A[1]=1/V.height,M.setValue(A),i=0;4>i;i++)T.setValue(V),q(r,z,f),T.setValue(W),q(r,G,f);for(i=0;i<D.length;i++)(z=D[i]).mask=2,D[i].setParameter(eh[n],V),1===n&&(D[i]._shaderDefs|=128);j[n]=V,n===o-1&&G.destroy()}Yo.push(j),Ko.push(e[O])}for(var H in u)u.hasOwnProperty(H)&&(u[H].colorBuffer.destroy(),u[H].destroy());for(i=0;i<Yo.length;i++)for(s=0;s<Yo[i].length;s++)(f=Yo[i][s]).minFilter=1,f.magFilter=1;for(O=0;O<t.length;O++)t[O].model.castShadows=L[O];for(i=0;i<R.length;i++)if(R[i])for(D=Ko[i].model.model.meshInstances,s=0;s<D.length;s++)D[s]._shaderDefs|=192&R[i][s];for(i=0;i<p.length;i++)p[i].mask=m[i],p[i].shadowUpdateMode=g[i];for(i=0;i<v.length;i++)v[i].enabled=y[i];a.fog=_,a.ambientLight.set(E,C,I),c&&(a._needsStaticPrepare=!0)}}});var ih,sh=1,nh=new x,rh=new x,ah=new v,oh=new v,hh=new v,lh=new v,ch=new v,dh=new v,uh=new v,ph=new v,fh=new v,mh=new v,_h=new v,gh=new v,yh=new v;ke.prototype.calcSpawnPosition=function(e,t,i,s,n){var r=this._emitter,a=Math.random(),o=Math.random(),h=Math.random(),l=Math.random();r.useCpu&&(e[4*n+8*r.numParticlesPot]=a,e[4*n+1+8*r.numParticlesPot]=o,e[4*n+2+8*r.numParticlesPot]=h),oh.x=a-.5,oh.y=o-.5,oh.z=h-.5,0===r.emitterShape?(o=(l=Math.max(Math.abs(oh.x),Math.max(Math.abs(oh.y),Math.abs(oh.z))))+(.5-l)*i[1],h=l+(.5-l)*i[2],oh.x=(l+(.5-l)*i[0])*(l==Math.abs(oh.x)?Math.sign(oh.x):2*oh.x),oh.y=o*(l==Math.abs(oh.y)?Math.sign(oh.y):2*oh.y),oh.z=h*(l==Math.abs(oh.z)?Math.sign(oh.z):2*oh.z),r.localSpace?ah.copy(t.transformPoint(oh)):ah.copy(s).add(t.transformPoint(oh))):(oh.normalize(),t=l*(1-(t=0===r.emitterRadius?0:r.emitterRadiusInner/r.emitterRadius))+t,r.localSpace?ah.copy(oh.scale(t*r.emitterRadius)):ah.copy(s).add(oh.scale(t*r.emitterRadius))),s=-Hr.lerp(r.rate,r.rate2,a)*n,r.pack8?(l=(ah.x-r.worldBounds.center.x)/r.worldBoundsSize.x+.5,i=(ah.y-r.worldBounds.center.y)/r.worldBoundsSize.y+.5,t=(ah.z-r.worldBounds.center.z)/r.worldBoundsSize.z+.5,a=(a=Hr.lerp(r.startAngle*Hr.DEG_TO_RAD,r.startAngle2*Hr.DEG_TO_RAD,a))%(2*Math.PI)/(2*Math.PI),l=Ne(l),e[4*n]=l[0],e[4*n+1]=l[1],i=Ne(i),e[4*n+2]=i[0],e[4*n+3]=i[1],t=Ne(t),e[4*n+4*r.numParticlesPot]=t[0],e[4*n+1+4*r.numParticlesPot]=t[1],a=Ne(a),e[4*n+2+4*r.numParticlesPot]=a[0],e[4*n+3+4*r.numParticlesPot]=a[1],e[4*n+3+8*r.numParticlesPot]=1,a=Fe(i=(s+(a=Math.max(r.lifetime,(r.numParticles-1)*Math.max(r.rate,r.rate2))))/(a+(r.lifetime+1))),a=[a-=(s=Fe(255*i))/255,s-=(t=Fe(65025*i))/255,t-(i=Fe(160581375*i))/255,i-i/255],e[4*n+12*r.numParticlesPot]=a[0],e[4*n+1+12*r.numParticlesPot]=a[1],e[4*n+2+12*r.numParticlesPot]=a[2],e[4*n+3+12*r.numParticlesPot]=a[3]):(e[4*n]=ah.x,e[4*n+1]=ah.y,e[4*n+2]=ah.z,e[4*n+3]=Hr.lerp(r.startAngle*Hr.DEG_TO_RAD,r.startAngle2*Hr.DEG_TO_RAD,a),e[4*n+3+4*r.numParticlesPot]=s)},ke.prototype.update=function(e,t,i,s,n,r,a,o){var h=this._emitter;if(h.meshInstance.node){var l=h.meshInstance.node.worldTransform;for(r=0;12>r;r++)nh.data[r]=l.data[r];rh.copy(nh),rh.invert(),ih=h.meshInstance.node.localScale,sh=Math.max(Math.max(ih.x,ih.y),ih.z)}r=null===h.meshInstance.node||h.localSpace?v.ZERO:h.meshInstance.node.getPosition();var c=h.camera?h.camera._node.getPosition():v.ZERO,d=h.useMesh?17:15,u=h.precision-1;for(l=0;l<h.numParticles;l++){var p=Math.floor(h.vbCPU[l*h.numParticleVerts*(h.useMesh?6:4)+3]),f=i[4*p+8*h.numParticlesPot];hh.x=f,hh.y=i[4*p+1+8*h.numParticlesPot],hh.z=i[4*p+2+8*h.numParticlesPot];var m=h.rate+(h.rate2-h.rate)*f,_=h.lifetime,g=i[4*p+3+4*h.numParticlesPot]+a,y=Math.max(Math.min(g/_,1),0),b=0,x=0;(0>=g-a||g>=_)&&this.calcSpawnPosition(i,s,n,r,p);var S=0<g&&g<_;if(S){x=y*u;var T=Math.floor(x),w=Math.ceil(x);x%=1;var M=h.qRotSpeed[T],P=h.qRotSpeed[w],A=M+(P-M)*x,E=(M=h.qRotSpeed2[T])+((P=h.qRotSpeed2[w])-M)*x;b=(M=h.qScale[T])+((P=h.qScale[w])-M)*x;var C=(M=h.qScale2[T])+((P=h.qScale2[w])-M)*x,I=(M=h.qAlpha[T])+((P=h.qAlpha[w])-M)*x,O=(M=h.qAlpha2[T])+((P=h.qAlpha2[w])-M)*x,R=(M=h.qRadialSpeed[T])+((P=h.qRadialSpeed[w])-M)*x;M=h.qRadialSpeed2[T],R+=100*f%1*((M+=((P=h.qRadialSpeed2[w])-M)*x)-R),lh.x=i[4*p],lh.y=i[4*p+1],lh.z=i[4*p+2],h.localSpace?fh.copy(lh):fh.copy(lh).sub(r),fh.normalize().scale(R),T*=3,w*=3,M=h.qLocalVelocity[T],P=h.qLocalVelocity[w],dh.x=M+(P-M)*x,M=h.qLocalVelocity[T+1],P=h.qLocalVelocity[w+1],dh.y=M+(P-M)*x,M=h.qLocalVelocity[T+2],P=h.qLocalVelocity[w+2],dh.z=M+(P-M)*x,M=h.qLocalVelocity2[T],P=h.qLocalVelocity2[w],ph.x=M+(P-M)*x,M=h.qLocalVelocity2[T+1],P=h.qLocalVelocity2[w+1],ph.y=M+(P-M)*x,M=h.qLocalVelocity2[T+2],P=h.qLocalVelocity2[w+2],ph.z=M+(P-M)*x,M=h.qVelocity[T],P=h.qVelocity[w],ch.x=M+(P-M)*x,M=h.qVelocity[T+1],P=h.qVelocity[w+1],ch.y=M+(P-M)*x,M=h.qVelocity[T+2],P=h.qVelocity[w+2],ch.z=M+(P-M)*x,M=h.qVelocity2[T],P=h.qVelocity2[w],uh.x=M+(P-M)*x,M=h.qVelocity2[T+1],P=h.qVelocity2[w+1],uh.y=M+(P-M)*x,M=h.qVelocity2[T+2],P=h.qVelocity2[w+2],uh.z=M+(P-M)*x,dh.x+=(ph.x-dh.x)*hh.x,dh.y+=(ph.y-dh.y)*hh.y,dh.z+=(ph.z-dh.z)*hh.z,0<h.initialVelocity&&(1===h.emitterShape?(oh.copy(hh).scale(2).sub(v.ONE).normalize(),dh.add(oh.scale(h.initialVelocity))):dh.add(v.FORWARD.scale(h.initialVelocity))),ch.x+=(uh.x-ch.x)*hh.x,ch.y+=(uh.y-ch.y)*hh.y,ch.z+=(uh.z-ch.z)*hh.z,A+=(E-A)*hh.y,b=(b+1e4*f%1*(C-b))*sh,x=1e3*f%1*(O-I),h.meshInstance.node&&(h.localSpace?(dh.x/=ih.x,dh.y/=ih.y,dh.z/=ih.z):nh.transformPoint(dh,dh)),h.localSpace?(rh.transformPoint(ch,ch),dh.add(ch).add(fh)):(dh.add(ch.mul(ih)),dh.add(fh.mul(ih))),gh.copy(dh),mh.copy(lh).add(dh.scale(a)),_h.copy(mh),i[4*p]=_h.x,i[4*p+1]=_h.y,i[4*p+2]=_h.z,i[4*p+3]+=A*a,h.wrap&&h.wrapBounds&&(h.localSpace||_h.sub(r),_h.x=Be(_h.x,h.wrapBounds.x)-.5*h.wrapBounds.x,_h.y=Be(_h.y,h.wrapBounds.y)-.5*h.wrapBounds.y,_h.z=Be(_h.z,h.wrapBounds.z)-.5*h.wrapBounds.z,h.localSpace||_h.add(r)),0<h.sort&&(1===h.sort?(yh.copy(_h).sub(c),h.particleDistance[p]=-(yh.x*yh.x+yh.y*yh.y+yh.z*yh.z)):2===h.sort?h.particleDistance[p]=g:3===h.sort&&(h.particleDistance[p]=-g))}for(o?0>g&&(i[4*p+3+8*h.numParticlesPot]=-1):(g>=_&&(g-=Math.max(_,(h.numParticles-1)*m),i[4*p+3+8*h.numParticlesPot]=h.loop?1:-1),0>g&&h.loop&&(i[4*p+3+8*h.numParticlesPot]=1)),0>i[4*p+3+8*h.numParticlesPot]&&(S=!1),i[4*p+3+4*h.numParticlesPot]=g,A=0;A<h.numParticleVerts;A++)f=(l*h.numParticleVerts+A)*(h.useMesh?6:4),m=h.vbCPU[f],_=h.vbCPU[f+1],g=h.vbCPU[f+2],S||(m=_=g=0),e[T=l*h.numParticleVerts*d+A*d]=_h.x,e[T+1]=_h.y,e[T+2]=_h.z,e[T+3]=y,e[T+4]=h.alignToMotion?0:i[4*p+3],e[T+5]=b,e[T+6]=x,e[T+7]=gh.x,e[T+8]=m,e[T+9]=_,e[T+10]=g,e[T+11]=gh.y,e[T+12]=p,e[T+13]=gh.z,e[T+14]=h.vbCPU[f+3],h.useMesh&&(e[T+15]=h.vbCPU[f+4],e[T+16]=h.vbCPU[f+5])}if(0<h.sort&&h.camera){for(e=h.useMesh?6:4,i=h.particleDistance,l=0;l<h.numParticles;l++)t[l][0]=l,t[l][1]=i[Math.floor(h.vbCPU[l*h.numParticleVerts*e+3])];for(h.vbOld.set(h.vbCPU),t.sort(function(e,t){return e[1]-t[1]}),l=0;l<h.numParticles;l++)for(i=t[l][0]*h.numParticleVerts*e,s=l*h.numParticleVerts*e,r=0;r<h.numParticleVerts*e;r++)h.vbCPU[s+r]=h.vbOld[i+r]}};var vh=new y,bh=new y,xh=new y;ze.prototype._setInputBounds=function(){this.inBoundsSizeUniform[0]=this._emitter.prevWorldBoundsSize.x,this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y,this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z,this.constantInBoundsSize.setValue(this.inBoundsSizeUniform),this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x,this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y,this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z,this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform)},ze.prototype.randomize=function(){this.frameRandomUniform[0]=Math.random(),this.frameRandomUniform[1]=Math.random(),this.frameRandomUniform[2]=Math.random()},ze.prototype.update=function(e,t,i,s,n){var r=this._emitter;e.setBlending(!1),e.setColorWrite(!0,!0,!0,!0),e.setCullMode(0),e.setDepthTest(!1),e.setDepthWrite(!1),this.randomize(),this.constantGraphSampleSize.setValue(1/r.precision),this.constantGraphNumSamples.setValue(r.precision),this.constantNumParticles.setValue(r.numParticles),this.constantNumParticlesPot.setValue(r.numParticlesPot),this.constantInternalTex0.setValue(r.internalTex0),this.constantInternalTex1.setValue(r.internalTex1),this.constantInternalTex2.setValue(r.internalTex2),this.constantInternalTex3.setValue(r.internalTex3);var a=r.meshInstance.node,o=null===a?v.ONE:a.localScale;if(r.pack8){this.worldBoundsMulUniform[0]=r.worldBoundsMul.x,this.worldBoundsMulUniform[1]=r.worldBoundsMul.y,this.worldBoundsMulUniform[2]=r.worldBoundsMul.z,this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform),this.worldBoundsAddUniform[0]=r.worldBoundsAdd.x,this.worldBoundsAddUniform[1]=r.worldBoundsAdd.y,this.worldBoundsAddUniform[2]=r.worldBoundsAdd.z,this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform),this._setInputBounds();var h=r.maxVel*Math.max(Math.max(o.x,o.y),o.z);h=Math.max(h,1),this.constantMaxVel.setValue(h)}h=null===a||r.localSpace?v.ZERO:a.getPosition(),a=null===a?x.IDENTITY:a.getWorldTransform(),0===r.emitterShape?(Ue(t,vh),this.constantSpawnBounds.setValue(vh.data),this.constantSpawnPosInnerRatio.setValue(i)):(this.constantSpawnBoundsSphere.setValue(r.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(0===r.emitterRadius?0:r.emitterRadiusInner/r.emitterRadius)),this.constantInitialVelocity.setValue(r.initialVelocity),Ue(a,bh),a.invertTo3x3(xh),this.emitterPosUniform[0]=h.x,this.emitterPosUniform[1]=h.y,this.emitterPosUniform[2]=h.z,this.constantEmitterPos.setValue(this.emitterPosUniform),this.constantFrameRandom.setValue(this.frameRandomUniform),this.constantDelta.setValue(s),this.constantRate.setValue(r.rate),this.constantRateDiv.setValue(r.rate2-r.rate),this.constantStartAngle.setValue(r.startAngle*Hr.DEG_TO_RAD),this.constantStartAngle2.setValue(r.startAngle2*Hr.DEG_TO_RAD),this.constantSeed.setValue(r.seed),this.constantLifetime.setValue(r.lifetime),this.emitterScaleUniform[0]=o.x,this.emitterScaleUniform[1]=o.y,this.emitterScaleUniform[2]=o.z,this.constantEmitterScale.setValue(this.emitterScaleUniform),this.constantEmitterMatrix.setValue(bh.data),this.constantEmitterMatrixInv.setValue(xh.data),this.constantLocalVelocityDivMult.setValue(r.localVelocityUMax),this.constantVelocityDivMult.setValue(r.velocityUMax),this.constantRotSpeedDivMult.setValue(r.rotSpeedUMax[0]),t=r.swapTex?r.particleTexOUT:r.particleTexIN,t=r.beenReset?r.particleTexStart:t,i=r.swapTex?r.particleTexIN:r.particleTexOUT,this.constantParticleTexIN.setValue(t),q(e,r.swapTex?r.rtParticleTexIN:r.rtParticleTexOUT,n?r.shaderParticleUpdateOnStop:r.loop?r.shaderParticleUpdateRespawn:r.shaderParticleUpdateNoRespawn),r.material.setParameter("particleTexOUT",t),r.material.setParameter("particleTexIN",i),r.beenReset=!1,r.swapTex=!r.swapTex,e.setDepthTest(!0),e.setDepthWrite(!0),r.prevWorldBoundsSize.copy(r.worldBoundsSize),r.prevWorldBoundsCenter.copy(r.worldBounds.center),r.pack8&&this._setInputBounds()};var Sh,Th,wh=[[-1,-1],[1,-1],[1,1],[-1,1]],Mh=function(e,t,i,s,n,r,a){n||(n=14);var o=0;if(a&&7===n&&(o=1),(e=new K(e,{width:t,height:i,format:n,cubemap:!1,mipmaps:!1,minFilter:o,magFilter:o,addressU:1,addressV:1})).name="PSTexture",t=e.lock(),7===n){for(n=new Uint8Array(s.length),i=0;i<s.length;i++)n[i]=s[i]*r*255;s=n}return t.set(s),e.unlock(),e},Ph=new _([0,0,1,0]),Ah=new _([0,1,1,1]),Eh=new g([0,0,1,0],[0,0,1,0],[0,0,1,0]),Ch=new g([0,1,1,1],[0,1,1,1],[0,1,1,1]),Ih=2,Oh=new Float32Array(3),Rh=new x,Dh=new v,Lh=new v,Fh=new v,Bh=function(e,t){if(this.graphicsDevice=e,this.precision=32,this._addTimeTime=0,!Bh.DEFAULT_PARAM_TEXTURE){var i,s,n=new Float32Array(1024);for(s=0;16>s;s++)for(i=0;16>i;i++){var r=i+1-8.5,a=s+1-8.5;a=Math.max(Math.min(1-Math.max(Math.min(Math.sqrt(r*r+a*a)/16,1),0)-.5,1),0),n[4*(r=16*s+i)]=1,n[4*r+1]=1,n[4*r+2]=1,n[4*r+3]=a}Bh.DEFAULT_PARAM_TEXTURE=Mh(e,16,16,n,7,1,!0),Bh.DEFAULT_PARAM_TEXTURE.minFilter=1,Bh.DEFAULT_PARAM_TEXTURE.magFilter=1}Sh=this,Th=t,Ve("numParticles",1),this.numParticles>e.maxTextureSize&&(console.warn("WARNING: can't create more than "+e.maxTextureSize+" particles on this device."),this.numParticles=e.maxTextureSize),Ve("rate",1),Ve("rate2",this.rate),Ve("lifetime",50),Ve("emitterExtents",new v(0,0,0)),Ve("emitterExtentsInner",new v(0,0,0)),Ve("emitterRadius",0),Ve("emitterRadiusInner",0),Ve("emitterShape",0),Ve("initialVelocity",1),Ve("wrap",!1),Ve("localSpace",!1),Ve("wrapBounds",null),Ve("colorMap",Bh.DEFAULT_PARAM_TEXTURE),Ve("normalMap",null),Ve("loop",!0),Ve("preWarm",!1),Ve("sort",0),Ve("mode",0),Ve("scene",null),Ve("lighting",!1),Ve("halfLambert",!1),Ve("intensity",1),Ve("stretch",0),Ve("alignToMotion",!1),Ve("depthSoftening",0),Ve("mesh",null),Ve("particleNormal",new v(0,1,0)),Ve("orientation",0),Ve("depthWrite",!1),Ve("noFog",!1),Ve("blendType",2),Ve("node",null),Ve("startAngle",0),Ve("startAngle2",this.startAngle),Ve("animTilesX",1),Ve("animTilesY",1),Ve("animStartFrame",0),Ve("animNumFrames",1),Ve("animNumAnimations",1),Ve("animIndex",0),Ve("randomizeAnimIndex",!1),Ve("animSpeed",1),Ve("animLoop",!0),this._gpuUpdater=new ze(this,e),this._cpuUpdater=new ke(this),this.constantLightCube=e.scope.resolve("lightCube[0]"),this.emitterPosUniform=new Float32Array(3),this.wrapBoundsUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),Ve("colorGraph",Ch),Ve("colorGraph2",this.colorGraph),Ve("scaleGraph",Ah),Ve("scaleGraph2",this.scaleGraph),Ve("alphaGraph",Ah),Ve("alphaGraph2",this.alphaGraph),Ve("localVelocityGraph",Eh),Ve("localVelocityGraph2",this.localVelocityGraph),Ve("velocityGraph",Eh),Ve("velocityGraph2",this.velocityGraph),Ve("rotationSpeedGraph",Ph),Ve("rotationSpeedGraph2",this.rotationSpeedGraph),Ve("radialSpeedGraph",Ph),Ve("radialSpeedGraph2",this.radialSpeedGraph),this.lightCube=new Float32Array(18),this.lightCubeDir=Array(6),this.lightCubeDir[0]=new v(-1,0,0),this.lightCubeDir[1]=new v(1,0,0),this.lightCubeDir[2]=new v(0,-1,0),this.lightCubeDir[3]=new v(0,1,0),this.lightCubeDir[4]=new v(0,0,-1),this.lightCubeDir[5]=new v(0,0,1),this.animTilesParams=new Float32Array(2),this.animParams=new Float32Array(4),this.animIndexParams=new Float32Array(2),this.camera=this.particleDistance=this.vbOld=this.vbToSort=this.colorParam=this.internalTex2=this.internalTex1=this.internalTex0=null,this.swapTex=!1,this.useMesh=!0,this.useCpu=!1,this.pack8=!0,this.localBounds=new w,this.worldBoundsNoTrail=new w,this.worldBoundsTrail=[new w,new w],this.worldBounds=new w,this.worldBoundsSize=new v,this.prevWorldBoundsSize=new v,this.prevWorldBoundsCenter=new v,this.prevEmitterExtents=this.emitterExtents,this.prevEmitterRadius=this.emitterRadius,this.worldBoundsMul=new v,this.worldBoundsAdd=new v,this.timeToSwitchBounds=0,this.shaderParticleUpdateOnStop=this.shaderParticleUpdateNoRespawn=this.shaderParticleUpdateRespawn=null,this.numParticleIndices=this.numParticleVerts=0,this.meshInstance=this.material=null,this.seed=Math.random(),this.fixedTimeStep=1/60,this.maxSubSteps=10,this.simTimeTotal=this.simTime=0,this.beenReset=!1,this._layer=null,this.rebuild()};if(Object.assign(Bh.prototype,{onChangeCamera:function(){this.regenShader(),this.resetMaterial()},calculateBoundsMad:function(){this.worldBoundsMul.x=1/this.worldBoundsSize.x,this.worldBoundsMul.y=1/this.worldBoundsSize.y,this.worldBoundsMul.z=1/this.worldBoundsSize.z,this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).scale(-1),this.worldBoundsAdd.x+=.5,this.worldBoundsAdd.y+=.5,this.worldBoundsAdd.z+=.5},calculateWorldBounds:function(){if(this.node){this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.useCpu||(0===this.emitterShape?!this.emitterExtents.equals(this.prevEmitterExtents):this.emitterRadius!==this.prevEmitterRadius)&&this.calculateLocalBounds();var e=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,e),this.worldBoundsTrail[0].add(this.worldBoundsNoTrail),this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);var t=this.simTimeTotal;t>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=t+this.lifetime),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2),this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,e),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,e)):(this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance.mesh.aabb.copy(this.worldBounds)),this.meshInstance._aabbVer=1-this.meshInstance._aabbVer,this.pack8&&this.calculateBoundsMad()}},resetWorldBounds:function(){this.node&&(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?x.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.timeToSwitchBounds=this.simTimeTotal=0)},calculateLocalBounds:function(){var e,t,i=Number.MAX_VALUE,s=Number.MAX_VALUE,n=Number.MAX_VALUE,r=-Number.MAX_VALUE,a=-Number.MAX_VALUE,o=-Number.MAX_VALUE,h=0,l=0,c=this.lifetime/this.precision,d=[this.qVelocity,this.qVelocity2],u=[this.qLocalVelocity,this.qLocalVelocity2],p=[0,0],f=[0,0],m=[0,0],_=[0,0],g=[0,0];for(e=0;e<this.precision+1;e++){var y=Math.min(e,this.precision-1);for(t=0;2>t;t++){var v=u[t][3*y]*c+p[t],b=u[t][3*y+1]*c+f[t],x=u[t][3*y+2]*c+m[t];i=Math.min(v,i),s=Math.min(b,s),n=Math.min(x,n),r=Math.max(v,r),a=Math.max(b,a),o=Math.max(x,o),p[t]=v,f[t]=b,m[t]=x}for(t=0;2>t;t++)g[t]+=c*Math.sqrt(d[t][3*y]*d[t][3*y]+d[t][3*y+1]*d[t][3*y+1]+d[t][3*y+2]*d[t][3*y+2]);_[0]+=this.qRadialSpeed[y]*c,_[1]+=this.qRadialSpeed2[y]*c,h=Math.max(h,Math.max(Math.abs(_[0]),Math.abs(_[1]))),l=Math.max(l,this.qScale[y])}0===this.emitterShape?(v=.5*this.emitterExtents.x,b=.5*this.emitterExtents.y,x=.5*this.emitterExtents.z):x=b=v=this.emitterRadius,c=Math.max(g[0],g[1]),Lh.x=i-l-v-h-c,Lh.y=s-l-b-h-c,Lh.z=n-l-x-h-c,Fh.x=r+l+v+h+c,Fh.y=a+l+b+h+c,Fh.z=o+l+x+h+c,this.localBounds.setMinMax(Lh,Fh)},rebuild:function(){var e,t=this.graphicsDevice;for(null===this.colorMap&&(this.colorMap=Bh.DEFAULT_PARAM_TEXTURE),this.spawnBounds=0===this.emitterShape?this.emitterExtents:this.emitterRadius,this.useCpu=this.useCpu||0<this.sort||1>=t.maxVertexTextures||64>t.fragmentUniformsCount||t.forceCpuParticles||!t.extTextureFloat,this._destroyResources(),this.pack8=(this.pack8||!t.textureFloatRenderable)&&!this.useCpu,Ih=this.useCpu||this.pack8?4:2,this.useMesh=!1,this.mesh&&(65535<this.numParticles*this.mesh.vertexBuffer.numVertices?console.warn("WARNING: particle system can't render mesh particles because numParticles * numVertices is more than 65k. Reverting to quad particles."):this.useMesh=!0),this.numParticlesPot=Hr.nextPowerOfTwo(this.numParticles),this.rebuildGraphs(),this.calculateLocalBounds(),this.resetWorldBounds(),this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?x.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.pack8&&this.calculateBoundsMad()),this.vbToSort=Array(this.numParticles),e=0;e<this.numParticles;e++)this.vbToSort[e]=[0,0];this.particleDistance=new Float32Array(this.numParticles),this._gpuUpdater.randomize(),this.particleTex=new Float32Array(this.numParticlesPot*Ih*4);var i=null===this.node||this.localSpace?v.ZERO:this.node.getPosition();for(0===this.emitterShape&&(null===this.node||this.localSpace?Rh.setTRS(v.ZERO,S.IDENTITY,this.spawnBounds):Rh.setTRS(v.ZERO,this.node.getRotation(),Dh.copy(this.spawnBounds).mul(this.node.localScale)),Oh[0]=0!=this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,Oh[1]=0!=this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,Oh[2]=0!=this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0),e=0;e<this.numParticles;e++)this._cpuUpdater.calcSpawnPosition(this.particleTex,Rh,Oh,i,e),this.useCpu&&(this.particleTex[4*e+3+8*this.numParticlesPot]=1);for(this.particleTexStart=new Float32Array(this.numParticlesPot*Ih*4),e=0;e<this.particleTexStart.length;e++)this.particleTexStart[e]=this.particleTex[e];this.useCpu||(this.pack8?(this.particleTexIN=Mh(t,this.numParticlesPot,Ih,this.particleTex,7,1,!1),this.particleTexOUT=Mh(t,this.numParticlesPot,Ih,this.particleTex,7,1,!1),this.particleTexStart=Mh(t,this.numParticlesPot,Ih,this.particleTexStart,7,1,!1)):(this.particleTexIN=Mh(t,this.numParticlesPot,Ih,this.particleTex),this.particleTexOUT=Mh(t,this.numParticlesPot,Ih,this.particleTex),this.particleTexStart=Mh(t,this.numParticlesPot,Ih,this.particleTexStart)),this.rtParticleTexIN=new Bu(t,this.particleTexIN,{depth:!1}),this.rtParticleTexOUT=new Bu(t,this.particleTexOUT,{depth:!1}),this.swapTex=!1),e=Ma;var s=(i=(this.localSpace?"#define LOCAL_SPACE\n":"")+e.particleUpdaterInitPS+(this.pack8?e.particleInputRgba8PS+e.particleOutputRgba8PS:e.particleInputFloatPS+e.particleOutputFloatPS)+(0===this.emitterShape?e.particleUpdaterAABBPS:e.particleUpdaterSpherePS)+e.particleUpdaterStartPS)+e.particleUpdaterNoRespawnPS+e.particleUpdaterEndPS,n=i+e.particleUpdaterOnStopPS+e.particleUpdaterEndPS,r=this.emitterShape+""+this.pack8+this.localSpace;this.shaderParticleUpdateRespawn=e.createShaderFromCode(t,e.fullscreenQuadVS,i+e.particleUpdaterRespawnPS+e.particleUpdaterEndPS,"fsQuad0"+r),this.shaderParticleUpdateNoRespawn=e.createShaderFromCode(t,e.fullscreenQuadVS,s,"fsQuad1"+r),this.shaderParticleUpdateOnStop=e.createShaderFromCode(t,e.fullscreenQuadVS,n,"fsQuad2"+r),this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4,this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6,this._allocate(this.numParticles),(t=new J(t)).vertexBuffer=this.vertexBuffer,t.indexBuffer[0]=this.indexBuffer,t.primitive[0].type=4,t.primitive[0].base=0,t.primitive[0].count=this.numParticles*this.numParticleIndices,t.primitive[0].indexed=!0,this.material=new Fn,this.material.name=this.node.name,this.material.cull=0,this.material.alphaWrite=!1,this.material.blend=!0,this.material.blendType=this.blendType,this.material.depthWrite=this.depthWrite,this.material.emitter=this,this.regenShader(),this.resetMaterial(),e=!this.meshInstance||this.meshInstance.visible,this.meshInstance=new ee(this.node,t,this.material),this.meshInstance.pick=!1,this.meshInstance.updateKey(),this.meshInstance.cull=!0,this.meshInstance._noDepthDrawGl1=!0,this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance._updateAabb=!1,this.meshInstance.visible=e,this._initializeTextures(),this.resetTime(),this.addTime(0,!1),this.preWarm&&this.prewarm(this.lifetime)},_isAnimated:function(){return 1<=this.animNumFrames&&(1<this.animTilesX||1<this.animTilesY)&&(this.colorMap&&this.colorMap!==Bh.DEFAULT_PARAM_TEXTURE||this.normalMap)},rebuildGraphs:function(){var e,t=this.precision,i=this.graphicsDevice;for(this.qLocalVelocity=this.localVelocityGraph.quantize(t),this.qVelocity=this.velocityGraph.quantize(t),this.qColor=this.colorGraph.quantizeClamped(t,0,1),this.qRotSpeed=this.rotationSpeedGraph.quantize(t),this.qScale=this.scaleGraph.quantize(t),this.qAlpha=this.alphaGraph.quantize(t),this.qRadialSpeed=this.radialSpeedGraph.quantize(t),this.qLocalVelocity2=this.localVelocityGraph2.quantize(t),this.qVelocity2=this.velocityGraph2.quantize(t),this.qColor2=this.colorGraph2.quantizeClamped(t,0,1),this.qRotSpeed2=this.rotationSpeedGraph2.quantize(t),this.qScale2=this.scaleGraph2.quantize(t),this.qAlpha2=this.alphaGraph2.quantize(t),this.qRadialSpeed2=this.radialSpeedGraph2.quantize(t),e=0;e<t;e++)this.qRotSpeed[e]*=Hr.DEG_TO_RAD,this.qRotSpeed2[e]*=Hr.DEG_TO_RAD;if(this.localVelocityUMax=new Float32Array(3),this.velocityUMax=new Float32Array(3),this.colorUMax=new Float32Array(3),this.rotSpeedUMax=[0],this.scaleUMax=[0],this.alphaUMax=[0],this.radialSpeedUMax=[0],this.qLocalVelocityDiv=We(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax),this.qVelocityDiv=We(this.qVelocity,this.qVelocity2,this.velocityUMax),this.qColorDiv=We(this.qColor,this.qColor2,this.colorUMax),this.qRotSpeedDiv=We(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax),this.qScaleDiv=We(this.qScale,this.qScale2,this.scaleUMax),this.qAlphaDiv=We(this.qAlpha,this.qAlpha2,this.alphaUMax),this.qRadialSpeedDiv=We(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax),this.pack8){var s=[0,0,0];je(this.qVelocity,s);var n=[0,0,0];je(this.qVelocity2,n),e=[0,0,0],je(this.qLocalVelocity,e);var r=[0,0,0];je(this.qLocalVelocity2,r);var a=[0];je(this.qRadialSpeed,a);var o=[0];je(this.qRadialSpeed2,o);var h=Math.max(s[0],n[0]);h=Math.max(h,s[1]),h=Math.max(h,n[1]),h=Math.max(h,s[2]),h=Math.max(h,n[2]),s=Math.max(e[0],r[0]),s=Math.max(s,e[1]),s=Math.max(s,r[1]),s=Math.max(s,e[2]),s=Math.max(s,r[2]),this.maxVel=h+s+Math.max(a[0],o[0])}if(!this.useCpu){for(this.internalTex0=Mh(i,t,1,Ge(this.qLocalVelocity,this.qLocalVelocityDiv)),this.internalTex1=Mh(i,t,1,Ge(this.qVelocity,this.qVelocityDiv)),e=this.qRotSpeed,r=this.qScale,a=this.qScaleDiv,o=this.qRotSpeedDiv,h=this.qAlphaDiv,s=Array(4*e.length),n=0;n<e.length;n++)s[4*n]=e[n],s[4*n+1]=r[n],s[4*n+2]=0,s[4*n+3]=(255*a[n]<<16|255*o[n]<<8|255*h[n])/16777216;for(this.internalTex2=Mh(i,t,1,s),e=this.qRadialSpeed,r=this.qRadialSpeedDiv,a=Array(4*e.length),o=0;o<e.length;o++)a[4*o]=e[o],a[4*o+1]=r[o],a[4*o+2]=0,a[4*o+3]=0;this.internalTex3=Mh(i,t,1,a)}for(e=this.qColor,r=this.qAlpha,a=Array(4*r.length),o=0;o<r.length;o++)a[4*o]=e[3*o],a[4*o+1]=e[3*o+1],a[4*o+2]=e[3*o+2],a[4*o+3]=r[o];this.colorParam=Mh(i,t,1,a,7,1,!0)},_initializeTextures:function(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap))},regenShader:function(){var e=this.graphicsDevice.getProgramLibrary(),t=null!==this.normalMap;this.normalOption=0,this.lighting&&(this.normalOption=t?2:1),this.material.updateShader=function(){this.emitter.scene&&this.emitter.camera!=this.emitter.scene._activeCamera&&(this.emitter.camera=this.emitter.scene._activeCamera,this.emitter.onChangeCamera()),this.shader=e.getProgram("particle",{useCpu:this.emitter.useCpu,normal:this.emitter.normalOption,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:this.emitter.scene?this.emitter.scene.gammaCorrection:0,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene&&!this.emitter.noFog?this.emitter.scene.fog:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,blend:this.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:0!=this.emitter.orientation})},this.material.updateShader()},resetMaterial:function(){var e=this.material;e.setParameter("stretch",this.stretch),this._isAnimated()&&(e.setParameter("animTexTilesParams",this.animTilesParams),e.setParameter("animTexParams",this.animParams),e.setParameter("animTexIndexParams",this.animIndexParams)),e.setParameter("colorMult",this.intensity),this.useCpu||(e.setParameter("internalTex0",this.internalTex0),e.setParameter("internalTex1",this.internalTex1),e.setParameter("internalTex2",this.internalTex2),e.setParameter("internalTex3",this.internalTex3)),e.setParameter("colorParam",this.colorParam),e.setParameter("numParticles",this.numParticles),e.setParameter("numParticlesPot",this.numParticlesPot),e.setParameter("lifetime",this.lifetime),e.setParameter("rate",this.rate),e.setParameter("rateDiv",this.rate2-this.rate),e.setParameter("seed",this.seed),e.setParameter("scaleDivMult",this.scaleUMax[0]),e.setParameter("alphaDivMult",this.alphaUMax[0]),e.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]),e.setParameter("graphNumSamples",this.precision),e.setParameter("graphSampleSize",1/this.precision),e.setParameter("emitterScale",new Float32Array([1,1,1])),this.pack8&&(this._gpuUpdater._setInputBounds(),e.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),e.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),e.setParameter("maxVel",this.maxVel)),this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=this.wrapBounds.x,this.wrapBoundsUniform[1]=this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,e.setParameter("wrapBounds",this.wrapBoundsUniform)),this.colorMap&&e.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&e.setParameter("normalMap",this.normalMap),0<this.depthSoftening&&e.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100)),0<this.stretch&&(e.cull=0),this._compParticleFaceParams()},_compParticleFaceParams:function(){if(0==this.orientation)var e=new Float32Array([1,0,0]),t=new Float32Array([0,0,1]);else{e=1==this.orientation?this.particleNormal.normalize():(null===this.node?x.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize();var i=new v(1,0,0);1==Math.abs(i.dot(e))&&i.set(0,0,1),t=(new v).cross(e,i).normalize(),i.cross(t,e).normalize(),e=new Float32Array([i.x,i.y,i.z]),t=new Float32Array([t.x,t.y,t.z])}this.material.setParameter("faceTangent",e),this.material.setParameter("faceBinorm",t)},_allocate:function(e){var t=e*this.numParticleVerts,i=e*this.numParticleIndices;if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==t){if(this.useCpu)var s=[{semantic:"ATTR0",components:4,type:6},{semantic:"ATTR1",components:4,type:6},{semantic:"ATTR2",components:4,type:6},{semantic:"ATTR3",components:1,type:6},{semantic:"ATTR4",components:this.useMesh?4:2,type:6}];else s=[{semantic:"ATTR0",components:4,type:6}],this.useMesh&&s.push({semantic:"ATTR1",components:2,type:6});if(s=new R(this.graphicsDevice,s),this.vertexBuffer=new I(this.graphicsDevice,s,t,1),this.indexBuffer=new Z(this.graphicsDevice,1,i),s=new Float32Array(this.vertexBuffer.lock()),this.useMesh){var n=new Float32Array(this.mesh.vertexBuffer.lock()),r=n.length/this.mesh.vertexBuffer.numVertices;for(i=0;i<this.mesh.vertexBuffer.format.elements.length;i++)if("TEXCOORD0"===this.mesh.vertexBuffer.format.elements[i].name){var a=this.mesh.vertexBuffer.format.elements[i].offset/4;break}}for(i=0;i<t;i++){var o=Math.floor(i/this.numParticleVerts);if(this.useMesh){var h=i%this.numParticleVerts;s[6*i]=n[h*r],s[6*i+1]=n[h*r+1],s[6*i+2]=n[h*r+2],s[6*i+3]=o,s[6*i+4]=n[h*r+a+0],s[6*i+5]=n[h*r+a+1]}else h=i%4,s[4*i]=wh[h][0],s[4*i+1]=wh[h][1],s[4*i+2]=0,s[4*i+3]=o}for(this.useCpu&&(this.vbCPU=new Float32Array(s),this.vbOld=new Float32Array(this.vbCPU.length)),this.vertexBuffer.unlock(),this.useMesh&&this.mesh.vertexBuffer.unlock(),t=0,r=new Uint16Array(this.indexBuffer.lock()),this.useMesh&&(n=new Uint16Array(this.mesh.indexBuffer[0].lock())),i=0;i<e;i++)if(this.useMesh)for(a=0;a<this.numParticleIndices;a++)r[i*this.numParticleIndices+a]=n[a]+i*this.numParticleVerts;else a=4*i,r[t++]=a,r[t++]=a+1,r[t++]=a+2,r[t++]=a,r[t++]=a+2,r[t++]=a+3;this.indexBuffer.unlock(),this.useMesh&&this.mesh.indexBuffer[0].unlock()}},reset:function(){if(this.beenReset=!0,this.seed=Math.random(),this.material.setParameter("seed",this.seed),this.useCpu)for(var e=0;e<this.particleTexStart.length;e++)this.particleTex[e]=this.particleTexStart[e];else this._initializeTextures();this.resetWorldBounds(),this.resetTime(),e=this.loop,this.loop=!0,this.addTime(0,!1),this.loop=e,this.preWarm&&this.prewarm(this.lifetime)},prewarm:function(e){var t=Math.min(Math.floor(e/this.lifetime*this.precision),this.precision);e/=t;for(var i=0;i<t;i++)this.addTime(e,!1)},resetTime:function(){var e=Math.max(this.rate,this.rate2)*this.numParticles+this.lifetime;this.endTime=Date.now()+1e3*e},finishFrame:function(){this.useCpu&&this.vertexBuffer.unlock()},addTime:function(e,t){var i=this.graphicsDevice;if(this.simTimeTotal+=e,this.calculateWorldBounds(),this._isAnimated()){var s=this.animTilesParams;s[0]=1/this.animTilesX,s[1]=1/this.animTilesY,(s=this.animParams)[0]=this.animStartFrame,s[1]=this.animNumFrames*this.animSpeed,s[2]=this.animNumFrames-1,s[3]=this.animNumAnimations-1,(s=this.animIndexParams)[0]=this.animIndex,s[1]=this.randomizeAnimIndex}if(this.scene&&this.camera!=this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera()),0===this.emitterShape&&(Oh[0]=0!=this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,Oh[1]=0!=this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,Oh[2]=0!=this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0,null===this.meshInstance.node?Rh.setTRS(v.ZERO,S.IDENTITY,this.emitterExtents):Rh.setTRS(v.ZERO,this.meshInstance.node.getRotation(),Dh.copy(this.emitterExtents).mul(this.meshInstance.node.localScale))),s=null===this.meshInstance.node?v.ONE:this.meshInstance.node.localScale,this.emitterScaleUniform[0]=s.x,this.emitterScaleUniform[1]=s.y,this.emitterScaleUniform[2]=s.z,this.material.setParameter("emitterScale",this.emitterScaleUniform),this.localSpace&&this.meshInstance.node){var n=this.meshInstance.node.getPosition();this.emitterPosUniform[0]=n.x,this.emitterPosUniform[1]=n.y,this.emitterPosUniform[2]=n.z,this.material.setParameter("emitterPos",this.emitterPosUniform)}this._compParticleFaceParams(),this.useCpu?(i=new Float32Array(this.vertexBuffer.lock()),this._cpuUpdater.update(i,this.vbToSort,this.particleTex,Rh,Oh,n,e,t)):this._gpuUpdater.update(i,Rh,Oh,e,t),!this.loop&&Date.now()>this.endTime&&(this.onFinished&&this.onFinished(),this.meshInstance.visible=!1)},_destroyResources:function(){this.particleTexIN&&(this.particleTexIN.destroy(),this.particleTexIN=null),this.particleTexOUT&&(this.particleTexOUT.destroy(),this.particleTexOUT=null),this.particleTexStart&&this.particleTexStart.destroy&&(this.particleTexStart.destroy(),this.particleTexStart=null),this.rtParticleTexIN&&(this.rtParticleTexIN.destroy(),this.rtParticleTexIN=null),this.rtParticleTexOUT&&(this.rtParticleTexOUT.destroy(),this.rtParticleTexOUT=null),this.internalTex0&&(this.internalTex0.destroy(),this.internalTex0=null),this.internalTex1&&(this.internalTex1.destroy(),this.internalTex1=null),this.internalTex2&&(this.internalTex2.destroy(),this.internalTex2=null),this.internalTex3&&(this.internalTex3.destroy(),this.internalTex3=null),this.colorParam&&(this.colorParam.destroy(),this.colorParam=null),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=void 0),this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=void 0),this.material&&(this.material.destroy(),this.material=null)},destroy:function(){this.camera=null,this._destroyResources()}}),it.prototype=Object.create(r.prototype),it.prototype.constructor=it,it.prototype.destroy=function(){this.root=null,this.defaultMaterial.destroy(),this.defaultMaterial=null,this.off()},Object.defineProperty(it.prototype,"fog",{get:function(){return this._fog},set:function(e){e!==this._fog&&(this._fog=e,this.updateShaders=!0)}}),Object.defineProperty(it.prototype,"gammaCorrection",{get:function(){return this._gammaCorrection},set:function(e){e!==this._gammaCorrection&&(this._gammaCorrection=e,this.updateShaders=!0)}}),Object.defineProperty(it.prototype,"toneMapping",{get:function(){return this._toneMapping},set:function(e){e!==this._toneMapping&&(this._toneMapping=e,this.updateShaders=!0)}}),Object.defineProperty(it.prototype,"skybox",{get:function(){return this._skyboxCubeMap},set:function(e){this._skyboxCubeMap=e,this._resetSkyboxModel(),this.updateShaders=!0}}),Object.defineProperty(it.prototype,"skyboxIntensity",{get:function(){return this._skyboxIntensity},set:function(e){this._skyboxIntensity=e,this._resetSkyboxModel(),this.updateShaders=!0}}),Object.defineProperty(it.prototype,"skyboxMip",{get:function(){return this._skyboxMip},set:function(e){this._skyboxMip=e,this._resetSkyboxModel(),this.updateShaders=!0}}),Object.defineProperty(it.prototype,"skyboxPrefiltered128",{get:function(){return this._skyboxPrefiltered[0]},set:function(e){this._skyboxPrefiltered[0]!==e&&(this._skyboxPrefiltered[0]=e,this.updateShaders=!0)}}),Object.defineProperty(it.prototype,"skyboxPrefiltered64",{get:function(){return this._skyboxPrefiltered[1]},set:function(e){this._skyboxPrefiltered[1]!==e&&(this._skyboxPrefiltered[1]=e,this.updateShaders=!0)}}),Object.defineProperty(it.prototype,"skyboxPrefiltered32",{get:function(){return this._skyboxPrefiltered[2]},set:function(e){this._skyboxPrefiltered[2]!==e&&(this._skyboxPrefiltered[2]=e,this.updateShaders=!0)}}),Object.defineProperty(it.prototype,"skyboxPrefiltered16",{get:function(){return this._skyboxPrefiltered[3]},set:function(e){this._skyboxPrefiltered[3]!==e&&(this._skyboxPrefiltered[3]=e,this.updateShaders=!0)}}),Object.defineProperty(it.prototype,"skyboxPrefiltered8",{get:function(){return this._skyboxPrefiltered[4]},set:function(e){this._skyboxPrefiltered[4]!==e&&(this._skyboxPrefiltered[4]=e,this.updateShaders=!0)}}),Object.defineProperty(it.prototype,"skyboxPrefiltered4",{get:function(){return this._skyboxPrefiltered[5]},set:function(e){this._skyboxPrefiltered[5]!==e&&(this._skyboxPrefiltered[5]=e,this.updateShaders=!0)}}),Object.defineProperty(it.prototype,"drawCalls",{get:function(){var e=this.layers._meshInstances;return e.length||(this.layers._update(),e=this.layers._meshInstances),e},set:function(e){}}),Object.defineProperty(it.prototype,"layers",{get:function(){return this._layers},set:function(e){var t=this._layers;this._layers=e,this.fire("set:layers",t,e)}}),it.prototype.applySettings=function(e){this._gravity.set(e.physics.gravity[0],e.physics.gravity[1],e.physics.gravity[2]),this.ambientLight.set(e.render.global_ambient[0],e.render.global_ambient[1],e.render.global_ambient[2]),this._fog=e.render.fog,this.fogColor.set(e.render.fog_color[0],e.render.fog_color[1],e.render.fog_color[2]),this.fogStart=e.render.fog_start,this.fogEnd=e.render.fog_end,this.fogDensity=e.render.fog_density,this._gammaCorrection=e.render.gamma_correction,this._toneMapping=e.render.tonemapping,this.lightmapSizeMultiplier=e.render.lightmapSizeMultiplier,this.lightmapMaxResolution=e.render.lightmapMaxResolution,this.lightmapMode=e.render.lightmapMode,this.exposure=e.render.exposure,this._skyboxIntensity=void 0===e.render.skyboxIntensity?1:e.render.skyboxIntensity,this._skyboxMip=void 0===e.render.skyboxMip?0:e.render.skyboxMip,this._resetSkyboxModel(),this.updateShaders=!0},it.prototype._updateSkybox=function(e){if(this._skyboxCubeMap&&!this.skyboxModel){var t,i=new Fn,s=this;if(i.updateShader=function(t,i,n,r,a){this.shader=e.getProgramLibrary().getProgram("skybox",{rgbm:"rgbm"===s._skyboxCubeMap.type,hdr:"rgbm"===s._skyboxCubeMap.type||14===s._skyboxCubeMap.format,useIntensity:1!==s.skyboxIntensity,mip:s._skyboxCubeMap.fixCubemapSeams?s.skyboxMip:0,fixSeams:s._skyboxCubeMap.fixCubemapSeams,gamma:1===a?s.gammaCorrection?3:0:s.gammaCorrection,toneMapping:1===a?0:s.toneMapping})},i.updateShader(),this._skyboxCubeMap.fixCubemapSeams&&s._skyboxMip){var n=this["skyboxPrefiltered"+[null,"64","16","8","4"][s._skyboxMip]];n&&(t=n)}else t=this._skyboxCubeMap;if(i.setParameter("texture_cubeMap",t),i.cull=2,i.depthWrite=!1,n=this.layers.getLayerById(2)){var r=new ge,a=tt(e);(i=new ee(r,a,i)).cull=!1,i._noDepthDrawGl1=!0,(a=new oe).graph=r,a.meshInstances=[i],this.skyboxModel=a,n.addMeshInstances(a.meshInstances),this.skyLayer=n,this._firstUpdateSkybox&&(n.enabled=!0,this._firstUpdateSkybox=!1),this.fire("set:skybox",t)}}},it.prototype._resetSkyboxModel=function(){this.skyboxModel&&(this.skyLayer.removeMeshInstances(this.skyboxModel.meshInstances),this.skyboxModel.destroy()),this.skyboxModel=null,this.updateSkybox=!0},it.prototype.setSkybox=function(e){var t;e||(e=[null,null,null,null,null,null,null]);var i=!1;if(this._skyboxCubeMap!==e[0]&&(i=!0),!i)for(t=0;6>t&&!i;t++)this._skyboxPrefiltered[t]!==e[t+1]&&(i=!0);if(i){for(t=0;6>t;t++)this._skyboxPrefiltered[t]=e[t+1];this.skybox=e[0]}},it.prototype.destroy=function(){this.skybox=null},it.prototype.addModel=function(e){if(!this.containsModel(e)){var t=this.layers.getLayerById(0);t&&(t.addMeshInstances(e.meshInstances),this._models.push(e))}},it.prototype.addShadowCaster=function(e){var t=this.layers.getLayerById(0);t&&t.addShadowCasters(e.meshInstances)},it.prototype.removeModel=function(e){var t=this._models.indexOf(e);if(-1!==t){var i=this.layers.getLayerById(0);i&&(i.removeMeshInstances(e.meshInstances),this._models.splice(t,1))}},it.prototype.removeShadowCasters=function(e){var t=this.layers.getLayerById(0);t&&t.removeShadowCasters(e.meshInstances)},it.prototype.containsModel=function(e){return 0<=this._models.indexOf(e)},it.prototype.getModels=function(e){return this._models},nt()){var Nh=function(e,t,i){i=i||{},this.volume=void 0===i.volume?1:i.volume,this.loop=void 0!==i.loop&&i.loop,this.pitch=void 0===i.pitch?1:i.pitch,this.sound=t,this.suspended=this.paused=!1,this.startOffset=this.startTime=0,this.manager=e,this.source=null,this.gain=e.context.createGain()};Object.assign(Nh.prototype,{play:function(){if(this.source)throw Error("Call stop() before calling play()");this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended)&&this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)},unpause:function(){this.source||!this.paused?console.warn("Call pause() before unpausing."):(this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1))},stop:function(){this.source&&(this.source.stop(0),this.source=null),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setLoop:function(e){this.loop=e,this.source&&(this.source.loop=e)},setVolume:function(e){this.volume=e=Hr.clamp(e,0,1),this.gain&&(this.gain.gain.value=e*this.manager.volume)},setPitch:function(e){this.pitch=e,this.source&&(this.source.playbackRate.value=e)},isPlaying:function(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE},getDuration:function(){return this.source?this.source.buffer.duration:0},_createSource:function(){var e=this.manager.context;this.sound.buffer&&(this.source=e.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(e.destination),this.loop||(this.source.onended=this.pause.bind(this)))}})}else st()?(Nh=function(e,t,i){this.volume=i.volume||1,this.loop=i.loop||!1,this.sound=t,this.pitch=void 0!==i.pitch?i.pitch:1,this.suspended=this.paused=!1,this.manager=e,t.audio&&(this.source=t.audio.cloneNode(!1),this.source.pause())},Object.assign(Nh.prototype,{play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play()),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=!1,this.source.play())},stop:function(){this.source&&this.source.pause(),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setVolume:function(e){this.volume=e=Hr.clamp(e,0,1),this.source&&(this.source.volume=e*this.manager.volume)},setLoop:function(e){this.loop=e,this.source&&(this.source.loop=e)},setPitch:function(e){this.pitch=e,this.source&&(this.source.playbackRate=e)},getDuration:function(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function(){return!this.source.paused}})):Nh=function(){};Object.assign(Nh.prototype,{getVolume:function(){return this.volume},getLoop:function(){return this.loop},getPitch:function(){return this.pitch},onManagerVolumeChange:function(){this.setVolume(this.getVolume())},onManagerSuspend:function(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())},onManagerResume:function(){this.suspended&&(this.suspended=!1,this.unpause())}});var kh="inverse";if(nt()){var Uh=function(e,t,i){Nh.call(this,e,t,i),this.position=new v,this.velocity=new v,this.panner=e.context.createPanner()};Uh.prototype=Object.create(Nh.prototype),Uh.prototype.constructor=Uh,Object.assign(Uh.prototype,{getPosition:function(){return this.position},setPosition:function(e){this.position.copy(e),this.panner.setPosition(e.x,e.y,e.z)},getVelocity:function(){return this.velocity},setVelocity:function(e){this.velocity.copy(e),this.panner.setVelocity(e.x,e.y,e.z)},getMaxDistance:function(){return this.panner.maxDistance},setMaxDistance:function(e){this.panner.maxDistance=e},getMinDistance:function(){return this.panner.refDistance},setMinDistance:function(e){this.panner.refDistance=e},getRollOffFactor:function(){return this.panner.rolloffFactor},setRollOffFactor:function(e){this.panner.rolloffFactor=e},getDistanceModel:function(){return this.pannel.distanceModel},setDistanceModel:function(e){this.panner.distanceModel=e},_createSource:function(){var e=this.manager.context;this.source=e.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.panner),this.panner.connect(this.gain),this.gain.connect(e.destination),this.loop||(this.source.onended=this.pause.bind(this))}})}else if(st()){var zh=new v;(Uh=function(e,t){Nh.call(this,e,t),this.position=new v,this.velocity=new v,this.maxDistance=1e4,this.rollOffFactor=this.minDistance=1,this.distanceModel=kh}).prototype=Object.create(Nh.prototype),Uh.prototype.constructor=Uh,Object.assign(Uh.prototype,{getPosition:function(){return this.position},setPosition:function(e){if(this.position.copy(e),this.source){var t=this.manager.listener.getPosition();e=this.minDistance;var i=this.maxDistance,s=this.rollOffFactor,n=this.distanceModel;if((t=(zh=zh.sub2(t,this.position)).length())<e)e=1;else if(t>i)e=0;else{var r=0;"linear"===n?r=1-s*(t-e)/(i-e):n===kh?r=e/(e+s*(t-e)):"exponential"===n&&(r=Math.pow(t/e,-s)),e=Hr.clamp(r,0,1)}i=this.getVolume(),this.source.volume=i*e}},getVelocity:function(){return this.velocity},setVelocity:function(e){this.velocity.copy(e)},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(e){this.maxDistance=e},getMinDistance:function(){return this.minDistance},setMinDistance:function(e){this.minDistance=e},getRollOffFactor:function(){return this.rollOffFactor},setRollOffFactor:function(e){this.rollOffFactor=e},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(e){this.distanceModel=e}})}else Uh=function(){};Object.assign(rt.prototype,{getPosition:function(){return this.position},setPosition:function(e){this.position.copy(e),this.listener&&this.listener.setPosition(e.x,e.y,e.z)},getVelocity:function(){return this.velocity},setVelocity:function(e){this.velocity.copy(e),this.listener&&this.listener.setPosition(e.x,e.y,e.z)},setOrientation:function(e){this.orientation.copy(e),this.listener&&this.listener.setOrientation(-e.data[8],-e.data[9],-e.data[10],e.data[4],e.data[5],e.data[6])},getOrientation:function(){return this.orientation}}),at.prototype=Object.create(r.prototype),at.prototype.constructor=at,Object.assign(at.prototype,{suspend:function(){this.suspended=!0,this.fire("suspend")},resume:function(){this.suspended=!1,this.fire("resume")},destroy:function(){window.removeEventListener("mousedown",this.resumeContext),window.removeEventListener("touchend",this.resumeContext),this.fire("destroy"),this.context&&this.context.close&&(this.context.close(),this.context=null)},playSound:function(e,t){t=t||{};var i=null;return Nh&&(i=new Nh(this,e,t)).play(),i},playSound3d:function(e,t,i){i=i||{};var s=null;return Uh&&((s=new Uh(this,e,i)).setPosition(t),i.volume&&s.setVolume(i.volume),i.loop&&s.setLoop(i.loop),i.maxDistance&&s.setMaxDistance(i.maxDistance),i.minDistance&&s.setMinDistance(i.minDistance),i.rollOffFactor&&s.setRollOffFactor(i.rollOffFactor),i.distanceModel&&s.setDistanceModel(i.distanceModel),s.play()),s}}),Object.defineProperty(at.prototype,"volume",{get:function(){return this._volume},set:function(e){this._volume=e=Hr.clamp(e,0,1),this.fire("volumechange",e)}}),lt.prototype.getDuration=function(){return this.duration},lt.prototype.getName=function(){return this.name},lt.prototype.getNode=function(e){return this._nodeDict[e]},Object.defineProperty(lt.prototype,"nodes",{get:function(){return this._nodes}}),lt.prototype.getNodes=function(){return this._nodes},lt.prototype.setDuration=function(e){this.duration=e},lt.prototype.setName=function(e){this.name=e},lt.prototype.addNode=function(e){this._nodes.push(e),this._nodeDict[e._name]=e},Object.defineProperties(ct.prototype,{morphPositions:{get:function(){return!!this._vertexBufferPositions||!!this.texturePositions}},morphNormals:{get:function(){return!!this._vertexBufferNormals||!!this.textureNormals}}}),Object.assign(ct.prototype,{_postInit:function(){this.options=null},_initVertexBuffers:function(e){var t=this.options;this._vertexBufferPositions=this._createVertexBuffer(e,t.deltaPositions,t.deltaPositionsType),this._vertexBufferNormals=this._createVertexBuffer(e,t.deltaNormals,t.deltaNormalsType),this._vertexBufferPositions&&(this.deltaPositions=this._vertexBufferPositions.lock())},_createVertexBuffer:function(e,t,i){return t?new I(e,new R(e,[{semantic:"ATTR0",components:3,type:i||6}]),t.length/3,0,t):null},_setTexture:function(e,t){this[e]=t},destroy:function(){this._vertexBufferPositions&&(this._vertexBufferPositions.destroy(),this._vertexBufferPositions=null),this._vertexBufferNormals&&(this._vertexBufferNormals.destroy(),this._vertexBufferNormals=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)}}),Object.assign(dt.prototype,{encode:function(e){return bt.joinPath([bt.joinPath(e[0]),e[1],bt.joinPath(e[2])],"/")},decode:function(e){return e=bt.splitPath(e,"/"),[bt.splitPath(e[0]),e[1],bt.splitPath(e[2])]}}),ut.prototype=Object.create(ge.prototype),ut.prototype.constructor=ut,ut.prototype.addComponent=function(e,t){var i=this._app.systems[e];return!i||this.c[e]?null:i.addComponent(this,t)},ut.prototype.removeComponent=function(e){var t=this._app.systems[e];t&&this.c[e]&&t.removeComponent(this)},ut.prototype.findComponent=function(e){var t=this.findOne(function(t){return t.c&&t.c[e]});return t&&t.c[e]},ut.prototype.findComponents=function(e){return this.find(function(t){return t.c&&t.c[e]}).map(function(t){return t.c[e]})},ut.prototype.getGuid=function(){return this._guid||this.setGuid(Ur.create()),this._guid},ut.prototype.setGuid=function(e){var t=this._app._entityIndex;this._guid&&delete t[this._guid],this._guid=e,t[this._guid]=this},ut.prototype._notifyHierarchyStateChanged=function(e,t){var i=!1;e===this&&0===this._app._enableList.length&&(i=!0),e._beingEnabled=!0,e._onHierarchyStateChanged(t),e._onHierarchyStatePostChanged&&this._app._enableList.push(e);var s,n=e._children,r=0;for(s=n.length;r<s;r++)n[r]._enabled&&this._notifyHierarchyStateChanged(n[r],t);if(e._beingEnabled=!1,i){for(r=0;r<this._app._enableList.length;r++)this._app._enableList[r]._onHierarchyStatePostChanged();this._app._enableList.length=0}},ut.prototype._onHierarchyStateChanged=function(e){ge.prototype._onHierarchyStateChanged.call(this,e);var t,i=this.c;for(t in i)if(i.hasOwnProperty(t)){var s=i[t];s.enabled&&(e?s.onEnable():s.onDisable())}},ut.prototype._onHierarchyStatePostChanged=function(){var e,t=this.c;for(e in t)t.hasOwnProperty(e)&&t[e].onPostStateChange()},ut.prototype.findByGuid=function(e){return this._guid===e?this:(e=this._app._entityIndex[e])&&(e===this||e.isDescendantOf(this))?e:null},ut.prototype.destroy=function(){for(e in this._destroying=!0,this.c)this.c[e].enabled=!1;for(e in this.c)this.c[e].system.removeComponent(this);this._parent&&this._parent.removeChild(this);for(var e=this._children,t=e.shift();t;)t instanceof ut&&t.destroy(),t._parent=null,t=e.shift();this.fire("destroy",this),this.off(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1},ut.prototype.clone=function(){var e={},t=this._cloneRecursively(e);return e[this.getGuid()]=t,function e(t,i,s,n){var r;if(i instanceof ut){var a,o=i.c;for(a in o){var h=o[a],l=h.system.getPropertiesOfType("entity"),c=0;for(r=l.length;c<r;c++){var d=l[c].name,u=h[d];t.findByGuid(u)&&((u=n[u].getGuid())?s.c[a][d]=u:console.warn("Could not find corresponding entity id when resolving duplicated entity references"))}}for(o.script&&!s._app.useLegacyScriptAttributeCloning&&s.script.resolveDuplicatedEntityReferenceProperties(o.script,n),i=i.children.filter(function(e){return e instanceof ut}),s=s.children.filter(function(e){return e instanceof ut}),c=0,r=i.length;c<r;c++)e(t,i[c],s[c],n)}}(this,this,t,e),t},ut.prototype._cloneRecursively=function(e){var t=new ut(this._app);for(var i in ge.prototype._cloneInternal.call(this,t),this.c)this.c[i].system.cloneComponent(this,t);for(i=0;i<this._children.length;i++){var s=this._children[i];if(s instanceof ut){var n=s._cloneRecursively(e);t.addChild(n),e[s.getGuid()]=n}}return t},Object.defineProperties(pt.prototype,{components:{get:function(){return this._components}},data:{get:function(){return this._data}}}),Object.assign(ft.prototype,{update:function(e,t){if(e<this._left||e>=this._right){var i=t.length;i?e<t[0]?(this._left=-1/0,this._right=t[0],this._p0=this._p1=this._recip=this._len=0):e>=t[i-1]?(this._left=t[i-1],this._right=1/0,this._recip=this._len=0,this._p0=this._p1=i-1):(i=this._findKey(e,t),this._left=t[i],this._right=t[i+1],this._len=this._right-this._left,t=1/this._len,this._recip=isFinite(t)?t:0,this._p0=i,this._p1=i+1):(this._left=-1/0,this._right=1/0,this._p0=this._p1=this._recip=this._len=0)}this._t=0===this._recip?0:(e-this._left)*this._recip,this._hermite.valid=!1},_findKey:function(e,t){for(var i=0;e>=t[i+1];)i++;return i},eval:function(e,t,i){var s=i._data;i=i._components;var n,r=this._p0*i;if(0===t)for(n=0;n<i;++n)e[n]=s[r+n];else{var a=this._t,o=this._p1*i;switch(t){case 1:for(n=0;n<i;++n)e[n]=Hr.lerp(s[r+n],s[o+n],a);break;case 2:(t=this._hermite).valid||(n=a*a,r=a+a,o=1-a,o*=o,t.valid=!0,t.p0=(1+r)*o,t.m0=a*o,t.p1=n*(3-r),t.m1=n*(a-1)),a=(3*this._p0+1)*i,r=(3*this._p0+2)*i,o=(3*this._p1+1)*i;var h=3*this._p1*i;for(n=0;n<i;++n)e[n]=t.p0*s[a+n]+t.m0*s[r+n]*this._len+t.p1*s[o+n]+t.m1*s[h+n]*this._len}}}}),Object.defineProperties(mt.prototype,{paths:{get:function(){return this._paths}},input:{get:function(){return this._input}},output:{get:function(){return this._output}},interpolation:{get:function(){return this._interpolation}}}),Object.defineProperties(_t.prototype,{name:{get:function(){return this._name}},duration:{get:function(){return this._duration}},inputs:{get:function(){return this._inputs}},outputs:{get:function(){return this._outputs}},curves:{get:function(){return this._curves}}}),Object.assign(_t.prototype,{eval:function(e,t){t._time=e;var i,s=this._inputs,n=this._outputs,r=this._curves,a=t._cache;for(t=t._results,i=0;i<s.length;++i)a[i].update(e,s[i]._data);for(i=0;i<r.length;++i)a[(e=r[i])._input].eval(t[i],e._interpolation,n[e._output])}}),Object.defineProperties(yt.prototype,{name:{get:function(){return this._name},set:function(e){this._name=e}},track:{get:function(){return this._track}},snapshot:{get:function(){return this._snapshot}},time:{get:function(){return this._time},set:function(e){this._time=e}},speed:{get:function(){return this._speed},set:function(e){this._speed=e}},loop:{get:function(){return this._loop},set:function(e){this._loop=e}},blendWeight:{get:function(){return this._blendWeight},set:function(e){this._blendWeight=e}},blendOrder:{get:function(){return this._blendOrder},set:function(e){this._blendOrder=e}}}),Object.assign(yt.prototype,{_update:function(e){if(this._playing){var t=this._time,i=this._track.duration,s=this._speed,n=this._loop;t+=s*e,0<=s?t>i&&(n?t=t%i||0:(t=this._track.duration,this.pause())):0>t&&(n?t=i+(t%i||0):(t=0,this.pause())),this._time=t}this._time!=this._snapshot._time&&this._track.eval(this._time,this._snapshot)},play:function(){this._playing=!0,this._time=0},stop:function(){this._playing=!1,this._time=0},pause:function(){this._playing=!1},resume:function(){this._playing=!0},reset:function(){this._time=0}}),Object.defineProperties(vt.prototype,{func:{get:function(){return this._func}},type:{get:function(){return this._type}},components:{get:function(){return this._components}}}),bt.joinPath=function(e,t){return t=t||".",e.map(function(e){return e.replace(/\\/g,"\\\\").replace(new RegExp("\\"+t,"g"),"\\"+t)}).join(t)},bt.splitPath=function(e,t){t=t||".";for(var i=[],s="",n=0;n<e.length;){var r=e[n++];"\\"===r&&n<e.length?s="\\"===(r=e[n++])||r===t?s+r:s+"\\"+r:r===t?(i.push(s),s=""):s+=r}return 0<s.length&&i.push(s),i},Object.assign(bt.prototype,{resolve:function(e){return null},unresolve:function(e){},update:function(e){}}),Object.assign(xt.prototype,{resolve:function(e){var t=this.propertyLocator.decode(e);return(e=this.nodes[t[0][0]])&&(t=this.handlers[t[2][0]])&&(t=t(e.node))?(0===e.count&&this.activeNodes.push(e.node),e.count++,t):null},unresolve:function(e){if("graph"===(e=this.propertyLocator.decode(e))[1]){var t=this.nodes[e[0][0]];if(t.count--,0===t.count){t=(e=this.activeNodes).indexOf(t.node);var i=e.length;t<i-1&&(e[t]=e[i-1]),e.pop()}}},update:function(e){e=this.activeNodes;for(var t=0;t<e.length;++t)e[t]._dirtifyLocal()},_getParts:function(e){return 2===(e=bt.splitPath(e)).length&&this.nodes.hasOwnProperty(e[0])&&this.handlers.hasOwnProperty(e[1])?e:null}}),Object.defineProperties(St.prototype,{clips:{get:function(){return this._clips}}}),St._dot=function(e,t){for(var i=e.length,s=0,n=0;n<i;++n)s+=e[n]*t[n];return s},St._normalize=function(e){var t=St._dot(e,e);if(0<t){t=1/Math.sqrt(t);for(var i=e.length,s=0;s<i;++s)e[s]*=t}},St._set=function(e,t,i){var s=e.length;if("quaternion"===i){var n=St._dot(t,t);for(0<n&&(n=1/Math.sqrt(n)),i=0;i<s;++i)e[i]=t[i]*n}else for(i=0;i<s;++i)e[i]=t[i]},St._blendVec=function(e,t,i){for(var s=1-i,n=e.length,r=0;r<n;++r)e[r]=e[r]*s+t[r]*i},St._blendQuat=function(e,t,i){var s=e.length,n=1-i;0>St._dot(e,t)&&(i=-i);for(var r=0;r<s;++r)e[r]=e[r]*n+t[r]*i;St._normalize(e)},St._blend=function(e,t,i,s){"quaternion"===s?St._blendQuat(e,t,i):St._blendVec(e,t,i)},St._stableSort=function(e,t){for(var i=e.length,s=0;s<i-1;++s)for(var n=s+1;n<i;++n)if(t(e[n],e[s])){var r=e[s];e[s]=e[n],e[n]=r}},Object.assign(St.prototype,{addClip:function(e){for(var t=this._targets,i=e.track.curves,s=e.snapshot,n=[],r=[],a=0;a<i.length;++a)for(var o=i[a].paths,h=0;h<o.length;++h){var l=o[h],c=t[l];if(!c){var d=this._binder.resolve(l);if(d){for(c={target:d,value:[],curves:0,blendCounter:0},d=0;d<c.target.components;++d)c.value.push(0);t[l]=c}}c&&(c.curves++,n.push(s._results[a]),r.push(c))}this._clips.push(e),this._inputs.push(n),this._outputs.push(r)},removeClip:function(e){for(var t=this._targets,i=this._clips,s=i[e].track.curves,n=0;n<s.length;++n)for(var r=s[n].paths,a=0;a<r.length;++a){var o=r[a],h=t[o];h&&(h.curves--,0===h.curves&&(this._binder.unresolve(o),delete t[o]))}i.splice(e,1),this._inputs.splice(e,1),this._outputs.splice(e,1)},removeClips:function(){for(;0<this._clips.length;)this.removeClip(0)},findClip:function(e){for(var t=this._clips,i=0;i<t.length;++i){var s=t[i];if(s.name===e)return s}return null},update:function(e){var t,i=this._clips,s=i.map(function(e,t){return t});for(St._stableSort(s,function(e,t){return i[e].blendOrder<i[t].blendOrder}),t=0;t<i.length;++t){var n=s[t],r=i[n],a=this._inputs[n];n=this._outputs[n];var o=r.blendWeight;if(0<o&&r._update(e),1<=o)for(r=0;r<a.length;++r){var h=a[r],l=n[r],c=l.value;St._set(c,h,l.target.type),l.blendCounter++}else if(0<o)for(r=0;r<a.length;++r)h=a[r],c=(l=n[r]).value,0===l.blendCounter?St._set(c,h,l.target.type):St._blend(c,h,o,l.target.type),l.blendCounter++}for(var d in s=this._targets)s.hasOwnProperty(d)&&((t=s[d]).target.func(t.value),t.blendCounter=0);this._binder.update(e)}}),Tt.prototype._validate=function(e){if(!e.header)throw Error('pc.I18n#addData: Missing "header" field');if(!e.header.version)throw Error('pc.I18n#addData: Missing "header.version" field');if(1!==e.header.version)throw Error('pc.I18n#addData: Invalid "header.version" field');if(!e.data)throw Error('pc.I18n#addData: Missing "data" field');if(!Array.isArray(e.data))throw Error('pc.I18n#addData: "data" field must be an array');for(var t=0,i=e.data.length;t<i;t++){var s=e.data[t];if(!s.info)throw Error('pc.I18n#addData: missing "data['+t+'].info" field');if(!s.info.locale)throw Error('pc.I18n#addData: missing "data['+t+'].info.locale" field');if("string"!=typeof s.info.locale)throw Error('pc.I18n#addData: "data['+t+'].info.locale" must be a string');if(!s.messages)throw Error('pc.I18n#addData: missing "data['+t+'].messages" field')}},Tt.prototype.parse=function(e){return e.data};var Vh={},Gh=function(e,t){for(var i=0,s=e.length;i<s;i++)Vh[e[i]]=t},jh=function(e){var t=e.indexOf("-");return-1!==t?e.substring(0,t):e},Wh="en-US",Hh={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"};Gh("ja ko th vi zh id".split(" "),function(e){return 0}),Gh(["fa","hi"],function(e){return 0<=e&&1>=e?0:1}),Gh(["fr","pt"],function(e){return 0<=e&&2>e?0:1}),Gh(["da"],function(e){return 1===e||!Number.isInteger(e)&&0<=e&&1>=e?0:1}),Gh("de en it el es tr fi sv nb no ur".split(" "),function(e){return 1===e?0:1}),Gh(["ru","uk"],function(e){if(Number.isInteger(e)){var t=e%10;if(e%=100,1===t&&11!==e)return 0;if(2<=t&&4>=t&&(12>e||14<e))return 1;if(0===t||5<=t&&9>=t||11<=e&&14>=e)return 2}return 3}),Gh(["pl"],function(e){if(Number.isInteger(e)){if(1===e)return 0;var t=e%10;if(e%=100,2<=t&&4>=t&&(12>e||14<e))return 1;if(0<=t&&1>=t||5<=t&&9>=t||12<=e&&14>=e)return 2}return 3}),Gh(["ar"],function(e){if(0===e)return 0;if(1===e)return 1;if(2===e)return 2;if(Number.isInteger(e)){if(3<=(e%=100)&&10>=e)return 3;if(11<=e&&99>=e)return 4}return 5});var Xh=Vh[jh(Wh)];wt.prototype=Object.create(r.prototype),wt.prototype.constructor=wt,wt.findAvailableLocale=function(e,t){if(t[e])return e;var i=Hh[e];return i&&t[i]?i:(e=jh(e),t[i=Hh[e]]?i:t[e]?e:Wh)},wt.prototype.getText=function(e,t){var i=e;if(!t){t=this._locale;var s=this._lang}var n=this._translations[t];return n||(s||(s=jh(t)),t=this._findFallbackLocale(t,s),n=this._translations[t]),n&&n.hasOwnProperty(e)&&(i=n[e],Array.isArray(i)&&(i=i[0]),null==i)&&(i=e),i},wt.prototype.getPluralText=function(e,t,i){var s=e;if(i)var n=jh(i),r=Vh[n]||Xh;else i=this._locale,n=this._lang,r=this._pluralFn;var a=this._translations[i];return a||(i=this._findFallbackLocale(i,n),n=jh(i),r=Vh[n]||Xh,a=this._translations[i]),a&&a[e]&&r&&(t=r(t),null==(s=a[e][t]))&&(s=e),s},wt.prototype.addData=function(e){try{var t=this._parser.parse(e)}catch(e){return void console.error(e)}e=0;for(var i=t.length;e<i;e++){var s=t[e],n=s.info.locale;if(s=s.messages,!this._translations[n]){this._translations[n]={};var r=jh(n);this._availableLangs[r]||(this._availableLangs[r]=n)}Object.assign(this._translations[n],s),this.fire("data:add",n,s)}},wt.prototype.removeData=function(e){var t;try{var i=this._parser.parse(e)}catch(e){return void console.error(e)}e=0;for(var s=i.length;e<s;e++){var n=i[e],r=n.info.locale,a=this._translations[r];if(a){for(t in n=n.messages)delete a[t];var o=!1;for(t in a){o=!0;break}o||(delete this._translations[r],delete this._availableLangs[jh(r)]),this.fire("data:remove",r,n)}}},wt.prototype.destroy=function(){this._parser=this._assets=this._availableLangs=this._translations=null,this.off()},Object.defineProperty(wt.prototype,"locale",{get:function(){return this._locale},set:function(e){if(this._locale!==e){var t=jh(e);if("in"===t){var i=t="id",s=e.indexOf("-");if(e=-1!==s?i+e.substring(s):i,this._locale===e)return}i=this._locale,this._locale=e,this._lang=t,this._pluralFn=Vh[this._lang]||Xh,this.fire("set:locale",e,i)}}}),Object.defineProperty(wt.prototype,"assets",{get:function(){return this._assets},set:function(e){var t,i={},s=0;for(t=e.length;s<t;s++){var n=e[s]instanceof Pt?e[s].id:e[s];i[n]=!0}for(s=this._assets.length;s--;)i[n=this._assets[s]]||(this._app.assets.off("add:"+n,this._onAssetAdd,this),(e=this._app.assets.get(n))&&this._onAssetRemove(e),this._assets.splice(s,1));for(n in i)n=parseInt(n,10),-1===this._assets.indexOf(n)&&(this._assets.push(n),(e=this._app.assets.get(n))?this._onAssetAdd(e):this._app.assets.once("add:"+n,this._onAssetAdd,this))}}),wt.prototype._findFallbackLocale=function(e,t){return(e=Hh[e])&&this._translations[e]||(e=Hh[t])&&this._translations[e]?e:(e=this._availableLangs[t])&&this._translations[e]?e:Wh},wt.prototype._onAssetAdd=function(e){e.on("load",this._onAssetLoad,this),e.on("change",this._onAssetChange,this),e.on("remove",this._onAssetRemove,this),e.on("unload",this._onAssetUnload,this),e.resource&&this._onAssetLoad(e)},wt.prototype._onAssetLoad=function(e){this.addData(e.resource)},wt.prototype._onAssetChange=function(e){e.resource&&this.addData(e.resource)},wt.prototype._onAssetRemove=function(e){e.off("load",this._onAssetLoad,this),e.off("change",this._onAssetChange,this),e.off("remove",this._onAssetRemove,this),e.off("unload",this._onAssetUnload,this),e.resource&&this.removeData(e.resource),this._app.assets.once("add:"+e.id,this._onAssetAdd,this)},wt.prototype._onAssetUnload=function(e){e.resource&&this.removeData(e.resource)};var qh=/^\s*(?:(?:[a-z]+[a-z0-9\-\+\.]*:)?\/\/|data:|blob:)/i,Yh=[],Kh=function(e){var t="_"+e;Yh.push(t),Object.defineProperty(Mt.prototype,e,{get:function(){return this[t]||null},set:function(e){(!!this[t]!=!!e||this[t]&&e&&this[t].hash!==e.hash)&&(this[t]=e?{url:e.url,filename:e.filename,size:e.size,hash:e.hash,opt:e.opt||0}:null,this.asset.file&&(this.asset.fire("change",this.asset,"file",this.asset._file,this.asset._file),this.asset.reload()))}})};Kh("dxt"),Kh("pvr"),Kh("etc1"),Kh("etc2"),Kh("basis"),Mt.prototype.clear=function(){for(var e=0;e<Yh.length;e++)this[Yh[e]]=null};var Zh=-1,$h={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},Qh=["pvr","dxt","etc2","etc1","basis"];Pt.prototype=Object.create(r.prototype),Pt.prototype.constructor=Pt,Object.assign(Pt.prototype,{getFileUrl:function(){var e=this.getPreferredFile();if(!e||!e.url)return null;var t=e.url;if(this.registry&&this.registry.prefix&&!qh.test(t)&&(t=this.registry.prefix+t),"script"!==this.type&&e.hash){var i=-1!==t.indexOf("?")?"&":"?";t+=i+"t="+e.hash}return t},getPreferredFile:function(){if(!this.file)return null;if("texture"===this.type||"textureatlas"===this.type||"bundle"===this.type)for(var e=this.registry._loader._app,t=e.graphicsDevice,i=0,s=Qh.length;i<s;i++){var n=Qh[i];if(t[$h[n]]){if(this.file.variants[n])return this.file.variants[n];if(e.enableBundles){var r=e.bundles.listBundlesForAsset(this);if(r)for(var a=0,o=r.length;a<o;a++)if(r[a].file&&r[a].file.variants&&r[a].file.variants[n])return this.file}}}return this.file},getAbsoluteUrl:function(e){var t=zr.getDirectory(this.file.url);return zr.join(t,e)},getLocalizedAssetId:function(e){return e=wt.findAvailableLocale(e,this._i18n),this._i18n[e]||null},addLocalizedAssetId:function(e,t){this._i18n[e]=t,this.fire("add:localized",e,t)},removeLocalizedAssetId:function(e){var t=this._i18n[e];t&&(delete this._i18n[e],this.fire("remove:localized",e,t))},ready:function(e,t){t=t||this,this.resource?e.call(t,this):this.once("load",function(i){e.call(t,i)})},reload:function(){this.loaded&&("cubemap"===this.type?this.registry._loader.patch(this,this.registry):(this.loaded=!1,this.registry.load(this)))},unload:function(){if(this.loaded||0!==this._resources.length){this.fire("unload",this),this.registry.fire("unload:"+this.id,this);for(var e=0;e<this._resources.length;++e){var t=this._resources[e];t&&t.destroy&&t.destroy()}this.resources=[],this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type)}}}),Object.defineProperty(Pt.prototype,"id",{get:function(){return this._id},set:function(e){this._id=e}}),Object.defineProperty(Pt.prototype,"file",{get:function(){return this._file},set:function(e){var t;if(!!e!=!!this._file||e&&this._file&&e.hash!==this._file)if(e){if(this._file||(this._file={}),this._file.url=e.url,this._file.filename=e.filename,this._file.hash=e.hash,this._file.size=e.size,this._file.variants=this.variants,e.hasOwnProperty("variants")&&(this.variants.clear(),e.variants))for(t in e.variants)e.variants[t]&&(this.variants[t]=e.variants[t]);this.fire("change",this,"file",this._file,this._file),this.reload()}else this._file=null,this.variants.clear();else if(e&&this._file&&e.hasOwnProperty("variants")&&(this.variants.clear(),e.variants))for(t in e.variants)e.variants[t]&&(this.variants[t]=e.variants[t])}}),Object.defineProperty(Pt.prototype,"data",{get:function(){return this._data},set:function(e){var t=this._data;this._data=e,e!==t&&(this.fire("change",this,"data",e,t),this.loaded&&this.registry._loader.patch(this,this.registry))}}),Object.defineProperty(Pt.prototype,"resource",{get:function(){return this._resources[0]},set:function(e){var t=this._resources[0];this._resources[0]=e,this.fire("change",this,"resource",e,t)}}),Object.defineProperty(Pt.prototype,"resources",{get:function(){return this._resources},set:function(e){var t=this._resources;this._resources=e,this.fire("change",this,"resources",e,t)}}),Object.defineProperty(Pt.prototype,"preload",{get:function(){return this._preload},set:function(e){e=!!e,this._preload!==e&&(this._preload=e)&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this)}});var Jh=function(e){return e.substring(e.indexOf(":")+1,e.indexOf(";"))},el=function(e){switch(e){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 3}},tl=function(e){switch(e){case 5120:return 0;case 5121:return 1;case 5122:return 2;case 5123:return 3;case 5124:return 4;case 5125:return 5;case 5126:return 6;default:return 0}},il=function(e){switch(e){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:return 0}},sl=function(e){switch(e.componentType){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}},nl=function(e,t,i){if(e.hasOwnProperty("sparse"))var s=e.sparse.values.bufferView,n=e.sparse.count;else s=e.bufferView,n=e.count;return i=i[(t=t[s]).buffer],s=e.hasOwnProperty("byteOffset")?e.byteOffset:0,t=t.hasOwnProperty("byteOffset")?t.byteOffset:0,t=i.byteOffset+s+t,n*=el(e.type),(e=sl(e))?new e(i.buffer,t,n):null},rl=function(e,t,i){i=i[(t=t[e.sparse.indices.bufferView]).buffer],t=t.hasOwnProperty("byteOffset")?t.byteOffset:0,t=i.byteOffset+t;var s=e.sparse.count;switch(e.sparse.indices.componentType){case 5120:return new Int8Array(i.buffer,t,s);case 5121:return new Uint8Array(i.buffer,t,s);case 5122:return new Int16Array(i.buffer,t,s);case 5123:return new Uint16Array(i.buffer,t,s);case 5124:return new Int32Array(i.buffer,t,s);case 5125:return new Uint32Array(i.buffer,t,s);case 5126:return new Float32Array(i.buffer,t,s);default:return null}},al=function(e,t,i,s,n){if(!n){n=new Uint16Array(s);for(var r=0;r<s;r++)n[r]=r}i=He(i,n),(n=new Float32Array(i.length)).set(i),t.push({semantic:"NORMAL",components:3,type:6}),e.NORMAL={buffer:n.buffer,size:12,offset:0,stride:12,count:s}},ol=function(e,t,i,s,n){var r="POSITION NORMAL TANGENT COLOR BLENDINDICES BLENDWEIGHT TEXCOORD0 TEXCOORD1".split(" ");i.sort(function(e,t){return(e=r.indexOf(e.semantic))<(t=r.indexOf(t.semantic))?-1:t<e?1:0}),e=new I(e,new R(e,i),t,0);var a,o=!0;for(i=0;i<e.format.elements.length;++i){var h=e.format.elements[i],l=n[h.name],c=l.offset-s.offset;if(l.buffer!==s.buffer||l.stride!==h.stride||l.size!==h.size||c!==h.offset){o=!1;break}}if(i=e.lock(),c=new Uint32Array(i),o)s=new Uint32Array(s.buffer,s.offset,t*e.format.size/4),c.set(s);else for(i=0;i<e.format.elements.length;++i){o=(h=e.format.elements[i]).stride/4,l=n[h.name],s=new Uint32Array(l.buffer,l.offset,l.count*l.stride/4);var d=l.stride/4,u=0,p=h.offset/4;for(h=0;h<t;++h){for(a=0;a<l.size/4;++a)c[p+a]=s[u+a];u+=d,p+=o}}return e.unlock(),e},hl=new x,ll=new v,cl=function(e,t,i,s,n,r){var a=[],o={POSITION:{semantic:"POSITION"},NORMAL:{semantic:"NORMAL"},TANGENT:{semantic:"TANGENT"},COLOR_0:{semantic:"COLOR"},JOINTS_0:{semantic:"BLENDINDICES"},WEIGHTS_0:{semantic:"BLENDWEIGHT"},TEXCOORD_0:{semantic:"TEXCOORD0"},TEXCOORD_1:{semantic:"TEXCOORD1"}};return t.primitives.forEach(function(h){var l=null,c=new J(e),d=!0;if(h.hasOwnProperty("extensions")){var u=h.extensions;if(u.hasOwnProperty("KHR_draco_mesh_compression")){var p=window.DracoDecoderModule;if(p&&(u=u.KHR_draco_mesh_compression).hasOwnProperty("attributes")){d=s[u.bufferView];var f=n[d.buffer];f=new Uint8Array(f.buffer,f.byteOffset+d.byteOffset,d.byteLength),(d=new p.DecoderBuffer).Init(f,f.length);var m=(f=new p.Decoder).GetEncodedGeometryType(d);switch(m){case p.POINT_CLOUD:var _=0,g=new p.PointCloud,y=f.DecodeBufferToPointCloud(d,g);break;case p.TRIANGULAR_MESH:_=4,g=new p.Mesh,y=f.DecodeBufferToMesh(d,g)}if(!y||!y.ok()||0==g.ptr)return void r("Failed to decode draco compressed asset: "+(y?y.error_msg():"Mesh asset - invalid draco compressed geometry type: "+m));if(y=g.num_faces(),m==p.TRIANGULAR_MESH){var b=(m=3*y)*((l=65535<g.num_points())?4:2);y=p._malloc(b),l?(f.GetTrianglesUInt32Array(g,b,y),l=new Uint32Array(p.HEAPU32.buffer,y,m).slice()):(f.GetTrianglesUInt16Array(g,b,y),l=new Uint16Array(p.HEAPU16.buffer,y,m).slice()),p._free(y)}m=function(e,t,i,s,n,r,a){var o,h=t.num_points(),l=[],c={};for(var d in i=i.attributes)if(i.hasOwnProperty(d)&&r.hasOwnProperty(d)){var u=r[d].semantic,p=s.GetAttributeByUniqueId(t,i[d]),f=h*p.num_components();switch(p.data_type()){case n.DT_UINT8:var m=o=1,_=n._malloc(f*m);s.GetAttributeDataArrayForAllPoints(t,p,n.DT_UINT8,f*m,_),f=new Uint8Array(n.HEAPU8.buffer,_,f).slice();break;case n.DT_UINT16:o=3,m=2,_=n._malloc(f*m),s.GetAttributeDataArrayForAllPoints(t,p,n.DT_UINT16,f*m,_),f=new Uint16Array(n.HEAPU16.buffer,_,f).slice();break;default:o=6,m=4,_=n._malloc(f*m),s.GetAttributeDataArrayForAllPoints(t,p,n.DT_FLOAT32,f*m,_),f=new Float32Array(n.HEAPF32.buffer,_,f).slice()}n._free(_),_=f,f=p.num_components(),p=p.normalized(),l.push({semantic:u,components:f,type:o,normalize:p}),p=f*m,c[u]={values:_,buffer:_.buffer,size:p,offset:0,stride:p,count:h}}return s=(t=c.POSITION).count,c.hasOwnProperty("NORMAL")||al(c,l,t.values,s,a),ol(e,s,l,t,c)}(e,g,u,f,p,o,l),p.destroy(g),p.destroy(f),p.destroy(d),d=!1}}}m||(l=h.hasOwnProperty("indices")?nl(i[h.indices],s,n):null,m=function(e,t,i,s,n,r,a){var o=[],h={};for(f in t)if(t.hasOwnProperty(f)){var l=s[t[f]],c=n[l.bufferView];if(a.hasOwnProperty(f)){var d=a[f].semantic;o.push({semantic:d,components:el(l.type),type:tl(l.componentType),normalize:l.normalized});var u=el(l.type)*il(l.componentType),p=r[c.buffer];h[d]={buffer:p.buffer,size:u,offset:(l.hasOwnProperty("byteOffset")?l.byteOffset:0)+(c.hasOwnProperty("byteOffset")?c.byteOffset:0)+p.byteOffset,stride:c.hasOwnProperty("byteStride")?c.byteStride:u,count:l.count}}}var f=(a=h.POSITION).count;return h.hasOwnProperty("NORMAL")||(t=nl(s[t.POSITION],n,r),al(h,o,t,f,i)),ol(e,f,o,a,h)}(e,h.attributes,l,i,s,n,o),_=function(e){if(!e.hasOwnProperty("mode"))return 4;switch(e.mode){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:return 4;case 5:return 5;case 6:return 6;default:return 4}}(h)),c.vertexBuffer=m,c.primitive[0].type=_,c.primitive[0].base=0,c.primitive[0].indexed=null!==l,null!==l?(_=new Z(e,l instanceof Uint8Array?0:l instanceof Uint16Array?1:2,l.length,0,l),c.indexBuffer[0]=_,c.primitive[0].count=l.length):c.primitive[0].count=m.numVertices,c.materialIndex=h.material;var x=i[h.attributes.POSITION];_=x.min,_=new w(new v(((p=x.max)[0]+_[0])/2,(p[1]+_[1])/2,(p[2]+_[2])/2),new v((p[0]-_[0])/2,(p[1]-_[1])/2,(p[2]-_[2])/2)),c.aabb=_;var S=function(e,t,i,s){for(i=new i(3*s),s=0;s<t.length;s++){var n=3*t[s];i[n]=e[3*s],i[n+1]=e[3*s+1],i[n+2]=e[3*s+2]}return i};if(d&&h.hasOwnProperty("targets")){var T,M=[];if(h.targets.forEach(function(r,a){var o={};r.hasOwnProperty("POSITION")&&(x=i[r.POSITION],T=sl(x),o.deltaPositions=nl(x,s,n),o.deltaPositionsType=da[T.name],x.sparse&&(o.deltaPositions=S(o.deltaPositions,rl(x,s,n),T,c.vertexBuffer.numVertices)),x.hasOwnProperty("min")&&x.hasOwnProperty("max")&&(o.aabb=new w,o.aabb.setMinMax(new v(x.min),new v(x.max)))),r.hasOwnProperty("NORMAL")&&(x=i[r.NORMAL],T=sl(x),o.deltaNormals=nl(x,s,n),o.deltaNormalsType=da[T.name],x.sparse&&(o.deltaNormals=S(o.deltaNormals,rl(x,s,n),T,c.vertexBuffer.numVertices))),t.hasOwnProperty("extras")&&t.extras.hasOwnProperty("targetNames")?o.name=t.extras.targetNames[a]:o.name=M.length.toString(10),M.push(new ct(e,o))}),c.morph=new se(M),t.hasOwnProperty("weights"))for(h=0;h<t.weights.length;++h)M[h].defaultWeight=t.weights[h]}a.push(c)}),a},dl=function(e,t){var i=function(e,t,i){var s,n=e.texCoord;if(n)for(s=0;s<i.length;++s)t[i[s]+"MapUv"]=n;if((s=e.extensions)&&(e=s.KHR_texture_transform)){if(n=e.scale)for(s=0;s<i.length;++s)t[i[s]+"MapTiling"]=new T(n[0],n[1]);if(e=e.offset)for(s=0;s<i.length;++s)t[i[s]+"MapOffset"]=new T(e[0],e[1])}},s=new Nn;if(s.occludeSpecular=!0,s.diffuseTint=!0,s.diffuseVertexColor=!0,s.specularTint=!0,s.specularVertexColor=!0,e.hasOwnProperty("name")&&(s.name=e.name),e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_materials_pbrSpecularGlossiness")){var n=e.extensions.KHR_materials_pbrSpecularGlossiness;if(n.hasOwnProperty("diffuseFactor")){var r=n.diffuseFactor;s.diffuse.set(Math.pow(r[0],1/2.2),Math.pow(r[1],1/2.2),Math.pow(r[2],1/2.2)),s.opacity=null!=r[3]?r[3]:1}else s.diffuse.set(1,1,1),s.opacity=1;if(n.hasOwnProperty("diffuseTexture")){var a=n.diffuseTexture;r=t[a.index],s.diffuseMap=r,s.diffuseMapChannel="rgb",s.opacityMap=r,s.opacityMapChannel="a",i(a,s,["diffuse","opacity"])}s.useMetalness=!1,n.hasOwnProperty("specularFactor")?(r=n.specularFactor,s.specular.set(Math.pow(r[0],1/2.2),Math.pow(r[1],1/2.2),Math.pow(r[2],1/2.2))):s.specular.set(1,1,1),n.hasOwnProperty("glossinessFactor")?s.shininess=100*n.glossinessFactor:s.shininess=100,n.hasOwnProperty("specularGlossinessTexture")&&(r=n.specularGlossinessTexture,s.specularMap=s.glossMap=t[r.index],s.specularMapChannel="rgb",s.glossMapChannel="a",i(r,s,["gloss","metalness"])),s.chunks.specularPS="#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularMap;\n#endif\n\nvoid getSpecularity() {\n\tdSpecularity = vec3(1.0);\n\n\t#ifdef MAPCOLOR\n\t\tdSpecularity *= material_specular;\n\t#endif\n\n\t#ifdef MAPTEXTURE\n\t\tvec3 srgb = texture2D(texture_specularMap, $UV).$CH;\n\t\tdSpecularity *= vec3(pow(srgb.r, 2.2), pow(srgb.g, 2.2), pow(srgb.b, 2.2));\n\t#endif\n\n\t#ifdef MAPVERTEX\n\t\tdSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}"}else e.hasOwnProperty("pbrMetallicRoughness")&&((n=e.pbrMetallicRoughness).hasOwnProperty("baseColorFactor")?(r=n.baseColorFactor,s.diffuse.set(Math.pow(r[0],1/2.2),Math.pow(r[1],1/2.2),Math.pow(r[2],1/2.2)),s.opacity=r[3]):(s.diffuse.set(1,1,1),s.opacity=1),n.hasOwnProperty("baseColorTexture")&&(r=t[(a=n.baseColorTexture).index],s.diffuseMap=r,s.diffuseMapChannel="rgb",s.opacityMap=r,s.opacityMapChannel="a",i(a,s,["diffuse","opacity"])),s.useMetalness=!0,n.hasOwnProperty("metallicFactor")?s.metalness=n.metallicFactor:s.metalness=1,n.hasOwnProperty("roughnessFactor")?s.shininess=100*n.roughnessFactor:s.shininess=100,n.hasOwnProperty("metallicRoughnessTexture")&&(r=n.metallicRoughnessTexture,s.metalnessMap=s.glossMap=t[r.index],s.metalnessMapChannel="b",s.glossMapChannel="g",i(r,s,["gloss","metalness"])),s.chunks.glossPS="#ifdef MAPFLOAT\nuniform float material_shininess;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_glossMap;\n#endif\n\nvoid getGlossiness() {\n\tdGlossiness = 1.0;\n\n#ifdef MAPFLOAT\n\tdGlossiness *= material_shininess;\n#endif\n\n#ifdef MAPTEXTURE\n\tdGlossiness *= texture2D(texture_glossMap, $UV).$CH;\n#endif\n\n#ifdef MAPVERTEX\n\tdGlossiness *= saturate(vVertexColor.$VC);\n#endif\n\n\tdGlossiness = 1.0 - dGlossiness;\n\n\tdGlossiness += 0.0000001;\n}");if(e.hasOwnProperty("normalTexture")&&(r=e.normalTexture,s.normalMap=t[r.index],i(r,s,["normal"]),r.hasOwnProperty("scale")&&(s.bumpiness=r.scale)),e.hasOwnProperty("occlusionTexture")&&(r=e.occlusionTexture,s.aoMap=t[r.index],s.aoMapChannel="r",i(r,s,["ao"])),e.hasOwnProperty("emissiveFactor")?(r=e.emissiveFactor,s.emissive.set(Math.pow(r[0],1/2.2),Math.pow(r[1],1/2.2),Math.pow(r[2],1/2.2)),s.emissiveTint=!0):(s.emissive.set(0,0,0),s.emissiveTint=!1),e.hasOwnProperty("emissiveTexture")&&(r=e.emissiveTexture,s.emissiveMap=t[r.index],i(r,s,["emissive"])),e.hasOwnProperty("alphaMode"))switch(e.alphaMode){case"MASK":s.blendType=3,e.hasOwnProperty("alphaCutoff")?s.alphaTest=e.alphaCutoff:s.alphaTest=.5;break;case"BLEND":s.blendType=2;break;default:case"OPAQUE":s.blendType=3}else s.blendType=3;return e.hasOwnProperty("doubleSided")?(s.twoSidedLighting=e.doubleSided,s.cull=e.doubleSided?0:1):(s.twoSidedLighting=!1,s.cull=1),e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_materials_unlit")&&(s.useLighting=!1,s.emissive.copy(s.diffuse),s.emissiveTint=s.diffuseTint,s.emissiveMap=s.diffuseMap,s.emissiveMapUv=s.diffuseMapUv,s.emissiveMapTiling.copy(s.diffuseMapTiling),s.emissiveMapOffset.copy(s.diffuseMapOffset),s.emissiveMapChannel=s.diffuseMapChannel,s.emissiveVertexColor=s.diffuseVertexColor,s.emissiveVertexColorChannel=s.diffuseVertexColorChannel,s.diffuse.set(0,0,0),s.diffuseTint=!1,s.diffuseMap=null,s.diffuseVertexColor=!1),s.update(),s},ul=function(e,t){var i=new ge;return e.hasOwnProperty("name")?i.name=e.name:i.name="node_"+t,e.hasOwnProperty("matrix")&&(hl.data.set(e.matrix),hl.getTranslation(ll),i.setLocalPosition(ll),hl.getEulerAngles(ll),i.setLocalEulerAngles(ll),hl.getScale(ll),i.setLocalScale(ll)),e.hasOwnProperty("rotation")&&(t=e.rotation,i.setLocalRotation(t[0],t[1],t[2],t[3])),e.hasOwnProperty("translation")&&(t=e.translation,i.setLocalPosition(t[0],t[1],t[2])),e.hasOwnProperty("scale")&&(e=e.scale,i.setLocalScale(e[0],e[1],e[2])),i},pl=function(e,t,i,s){if(!e.hasOwnProperty("animations")||0===e.animations.length)return[];var n=s&&s.animation&&s.animation.preprocess,r=s&&s.animation&&s.animation.postprocess;return e.animations.map(function(s,a){return n&&n(s),a=function(e,t,i,s,n,r){var a,o=function(e){var t=nl(e,s,r);return new pt(el(e.type),new t.constructor(t))},h={STEP:0,LINEAR:1,CUBICSPLINE:2},l={},c=[],d={},u=[],p=[];for(a=0;a<e.samplers.length;++a){var f=e.samplers[a];l.hasOwnProperty(f.input)||(l[f.input]=c.length,c.push(o(i[f.input]))),d.hasOwnProperty(f.output)||(d[f.output]=u.length,u.push(o(i[f.output])));var m=f.hasOwnProperty("interpolation")&&h.hasOwnProperty(f.interpolation)?h[f.interpolation]:1;p.push(new mt([],l[f.input],d[f.output],m))}for(i=[],o=new dt,h={translation:"localPosition",rotation:"localRotation",scale:"localScale",weights:"weights"},a=0;a<e.channels.length;++a)l=(d=e.channels[a]).target,(d=p[d.sampler])._paths.push(o.encode([[n[l.node].name],"graph",[h[l.path]]])),l.path.startsWith("rotation")&&2!==d.interpolation?i.push(d.output):l.path.startsWith("weights")&&(u[d.output]._components=u[d.output].data.length/c[d.input].data.length);for(i.sort(),o=null,a=0;a<i.length;++a)if(n=i[a],0===a||n!==o){if(4===(o=u[n]).components)for(h=(o=o.data).length-4,l=0;l<h;l+=4)0>o[l+0]*o[l+4]+o[l+1]*o[l+5]+o[l+2]*o[l+6]+o[l+3]*o[l+7]&&(o[l+4]*=-1,o[l+5]*=-1,o[l+6]*=-1,o[l+7]*=-1);o=n}return a=c.reduce(function(e,t){return t=t._data,Math.max(e,0===t.length?0:t[t.length-1])},0),new _t(e.hasOwnProperty("name")?e.name:"animation_"+t,a,c,u,p)}(s,a,e.accessors,e.bufferViews,t,i),r&&r(s,a),a})},fl=function(e,t,i,s,n,r){var a=n&&n.global&&n.global.preprocess,o=n&&n.global&&n.global.postprocess;a&&a(t),a=function(e,t){if(!e.hasOwnProperty("nodes")||0===e.nodes.length)return[];var i=t&&t.node&&t.node.preprocess,s=t&&t.node&&t.node.process||ul,n=t&&t.node&&t.node.postprocess;t=e.nodes.map(function(e,t){return i&&i(e),t=s(e,t),n&&n(e,t),t});for(var r=0;r<e.nodes.length;++r){var a=e.nodes[r];if(a.hasOwnProperty("children"))for(var o=0;o<a.children.length;++o){var h=t[r],l=t[a.children[o]];l.parent||h.addChild(l)}}return t}(t,n);var h=pl(t,a,i,n);n=function(e,t,i){if(!e.hasOwnProperty("materials")||0===e.materials.length)return[];var s=i&&i.material&&i.material.preprocess,n=i&&i.material&&i.material.process||dl,r=i&&i.material&&i.material.postprocess;return e.materials.map(function(e){s&&s(e);var i=n(e,t);return r&&r(e,i),i})}(t,t.textures?t.textures.map(function(e){return s[e.source].resource}):[],n);var l=function(e,t,i,s){return t.hasOwnProperty("meshes")&&0!==t.meshes.length&&t.hasOwnProperty("accessors")&&0!==t.accessors.length&&t.hasOwnProperty("bufferViews")&&0!==t.bufferViews.length?t.meshes.map(function(n){return cl(e,n,t.accessors,t.bufferViews,i,s)}):[]}(e,t,i,r);e=function(e,t,i,s){return t.hasOwnProperty("skins")&&0!==t.skins.length?t.skins.map(function(n){var r,a=t.accessors,o=t.bufferViews,h=n.joints,l=h.length,c=[];if(n.hasOwnProperty("inverseBindMatrices")){o=nl(a[n.inverseBindMatrices],o,s);var d=[];for(a=0;a<l;a++){for(r=0;16>r;r++)d[r]=o[16*a+r];(r=new x).set(d),c.push(r)}}else for(a=0;a<l;a++)r=new x,c.push(r);for(o=[],a=0;a<l;a++)o[a]=i[h[a]].name;for(n=n.skeleton,(c=new re(e,c,o)).skeleton=i[n],c.bones=[],a=0;a<h.length;a++)c.bones[a]=i[h[a]];return c}):[]}(e,t,a,i),e={gltf:t,nodes:a,animations:h,textures:s,materials:n,meshes:l,skins:e},o&&o(t,e),r(null,e)},ml=function(e,t){var i=function(e){switch(e){case 9728:return 0;case 9729:return 1;case 9984:return 2;case 9985:return 4;case 9986:return 3;case 9987:return 5;default:return 1}},s=function(e){switch(e){case 33071:return 1;case 33648:return 2;case 10497:default:return 0}};e&&(t=t||{magFilter:9729,minFilter:9987,wrapS:10497,wrapT:10497},e.minFilter=i(t.minFilter),e.magFilter=i(t.magFilter),e.addressU=s(t.wrapS),e.addressV=s(t.wrapT))},_l=function(e,t){(e=JSON.parse(function(e){return"undefined"!=typeof TextDecoder?(new TextDecoder).decode(e):(e=e.reduce(function(e,t){return e+String.fromCharCode(t)},""),decodeURIComponent(escape(e)))}(e))).asset&&e.asset.version&&2>Number.parseFloat(e.asset.version)?t("Invalid gltf version. Expected version 2.0 or above but found version '"+e.asset.version+"'."):t(null,e)},gl=function(e,t,i){if(e&&e.toLowerCase().endsWith(".glb")){var s=(e=new DataView(t)).getUint32(0,!0),n=e.getUint32(4,!0),r=e.getUint32(8,!0);if(1179937895!==s)i("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+s.toString(16));else if(2!==n)i("Invalid version number found in glb header. Expected 2, found "+n);else if(0>=r||r>t.byteLength)i("Invalid length found in glb header. Found "+r);else{for(s=[],n=12;n<r;){var a=e.getUint32(n,!0);if(n+a+8>t.byteLength)throw Error("Invalid chunk length found in glb. Found "+a);var o=e.getUint32(n+4,!0),h=new Uint8Array(t,n+8,a);s.push({length:a,type:o,data:h}),n+=a+8}1!==s.length&&2!==s.length?i("Invalid number of chunks found in glb file."):1313821514!==s[0].type?i("Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x"+s[0].type.toString(16)):1<s.length&&5130562!==s[1].type?i("Invalid chunk type found in glb file. Expected 0x004E4942, found 0x"+s[1].type.toString(16)):i(null,{gltfChunk:s[0].data,binaryChunk:2===s.length?s[1].data:null})}}else i(null,{gltfChunk:t,binaryChunk:null})};At.parseAsync=function(e,t,i,s,n,r,a){gl(e,i,function(e,i){e?a(e):_l(i.gltfChunk,function(e,o){e?a(e):function(e,t,i,s,n){var r=[];if(null===e.buffers||0===e.buffers.length)n(null,r);else{var a=s&&s.buffer&&s.buffer.preprocess,o=s&&s.buffer&&s.buffer.processAsync,h=s&&s.buffer&&s.buffer.postprocess,l=e.buffers.length,c=function(t,i){r[t]=i,h&&h(e.buffers[t],i),0==--l&&n(null,r)};for(s=0;s<e.buffers.length;++s){var d=e.buffers[s];if(a&&a(d),o)o(d,function(e,t,i){t?n(t):c(e,new Uint8Array(i))}.bind(null,s));else if(d.hasOwnProperty("uri"))if(/^data:.*,.*$/i.test(d.uri)){d=atob(d.uri.split(",")[1]);var u=new ArrayBuffer(d.length);u=new Uint8Array(u);for(var p=0;p<d.length;p++)u[p]=d.charCodeAt(p);c(s,u)}else qr.get(zr.join(i,d.uri),{cache:!0,responseType:"arraybuffer",retry:!1},function(e,t,i){t?n(t):c(e,new Uint8Array(i))}.bind(null,s));else c(s,t)}}}(o,i.binaryChunk,t,r,function(e,i){e?a(e):function(e,t,i,s,n,r){var a=[];if(e.hasOwnProperty("images")&&0!==e.images.length&&e.hasOwnProperty("textures")&&0!==e.textures.length){var o=n&&n.texture&&n.texture.preprocess,h=n&&n.texture&&n.texture.processAsync,l=n&&n.texture&&n.texture.postprocess,c=e.images.length,d=function(t,i){if(a[t]=i,l&&l(e.images[t],i),0==--c){for(t=0;t<e.textures.length;++t)i=e.textures[t],ml(a[i.source].resource,(e.samplers||[])[i.sampler]);r(null,a)}};n=function(e,t,i,n){t={url:t},i&&(i={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/vnd-ms.dds":"dds"}[i])&&(t.filename="glb-texture-"+e+"."+i),(n=new Pt("texture_"+e,"texture",t,{flipY:!1},{crossOrigin:n})).on("load",d.bind(null,e)),s.add(n),s.load(n)};for(var u=0;u<e.images.length;++u){var p=e.images[u];if(o&&o(p),h)h(p,function(e,t,i){t?r(t):d(e,i)}.bind(null,u));else if(p.hasOwnProperty("uri"))/^data:.*,.*$/i.test(p.uri)?n(u,p.uri,Jh(p.uri)):n(u,zr.join(i,p.uri),"anonymous");else{if(!p.hasOwnProperty("bufferView")||!p.hasOwnProperty("mimeType")){r("Invalid image found in gltf (neither uri or bufferView found). index="+u);break}var f=e.bufferViews[p.bufferView],m=f.hasOwnProperty("byteOffset")?f.byteOffset:0,_=t[f.buffer];f=new Uint8Array(_.buffer,_.byteOffset+m,f.byteLength),f=new Blob([f],{type:p.mimeType}),n(u,URL.createObjectURL(f),p.mimeType)}}}else r(null,a)}(o,i,t,n,r,function(e,t){e?a(e):fl(s,o,i,t,r,a)})})})})},At.parse=function(e,t,i,s){var n=null;return gl(e,t,function(e,t){e?console.error(e):_l(t.gltfChunk,function(e,r){e?console.error(e):fl(i,r,[t.binaryChunk],[],s||{},function(e,t){e?console.error(e):n=t})})}),n},At.createModel=function(e,t){var i,s=new oe,n=[];for(i=0;i<e.nodes.length;i++){var r=e.nodes[i];null===r.parent&&n.push(r);var a=e.gltf.nodes[i];if(a.hasOwnProperty("mesh"))for(var o=e.meshes[a.mesh],h=0;h<o.length;h++){var l=s,c=o[h],d=e.skins,u=a,p=new ee(r,c,void 0===c.materialIndex?t:e.materials[c.materialIndex]);if(c.morph){var f=new ne(c.morph);if(c.weights)for(var m=0;m<c.weights.length;m++)f.setWeight(m,c.weights[m]);p.morphInstance=f,l.morphInstances.push(f)}u.hasOwnProperty("skin")&&(d=d[u.skin],c.skin=d,(c=new ae(d)).bones=d.bones,p.skinInstance=c,l.skinInstances.push(c)),l.meshInstances.push(p)}}if(1===n.length)s.graph=n[0];else for(s.graph=new ge("SceneGroup"),i=0;i<n.length;++i)s.graph.addChild(n[i]);return s},Object.assign(Et.prototype,{load:function(e,t){"string"==typeof e&&(e={load:e,original:e});var i={retry:this.retryRequests};e.load.startsWith("blob:")&&(".glb"===zr.getExtension(e.original).toLowerCase()?i.responseType=f.ResponseType.ARRAY_BUFFER:i.responseType=f.ResponseType.JSON),qr.get(e.load,i,function(i,s){i?t("Error loading animation resource: "+e.original+" ["+i+"]"):t(null,s)})},open:function(e,t){return".glb"===zr.getExtension(e).toLowerCase()?(e=At.parse("filename.glb",t,null))?e.animations:null:this["_parseAnimationV"+t.animation.version](t)},_parseAnimationV3:function(e){e=e.animation;var t=new lt;t.setName(e.name),t.duration=e.duration;for(var i=0;i<e.nodes.length;i++){var s=new ht,n=e.nodes[i];s._name=n.name;for(var r=0;r<n.keys.length;r++){var a=n.keys[r],o=a.time,h=a.pos,l=a.rot;a=a.scale,o=new ot(o,h=new v(h[0],h[1],h[2]),l=(new S).setFromEulerAngles(l[0],l[1],l[2]),a=new v(a[0],a[1],a[2])),s._keys.push(o)}t.addNode(s)}return t},_parseAnimationV4:function(e){e=e.animation;var t=new lt;t.setName(e.name),t.duration=e.duration;for(var i=0;i<e.nodes.length;i++){var s=new ht,n=e.nodes[i];s._name=n.name;for(var r=n.defaults.p,a=n.defaults.r,o=n.defaults.s,h=0;h<n.keys.length;h++){var l=n.keys[h],c=l.t,d=r||l.p,u=a||l.r;l=o||l.s,c=new ot(c,d=new v(d[0],d[1],d[2]),u=(new S).setFromEulerAngles(u[0],u[1],u[2]),l=new v(l[0],l[1],l[2])),s._keys.push(c)}t.addNode(s)}return t}}),Object.assign(Ct.prototype,{load:function(e,t){"string"==typeof e&&(e={load:e,original:e});var i={retry:this.retryRequests};e.load.startsWith("blob:")&&(i.responseType=f.ResponseType.JSON),qr.get(e.load,i,function(i,s){i?t("Error loading animation clip resource: "+e.original+" ["+i+"]"):t(null,s)})},open:function(e,t){return new _t(t.name,t.duration,t.inputs.map(function(e){return new pt(1,e)}),t.outputs.map(function(e){return new pt(e.components,e.data)}),t=t.curves.map(function(e){return new mt([e.path],e.inputIndex,e.outputIndex,e.interpolation)}))}}),Object.defineProperties(It.prototype,{parameters:{get:function(){return Object.assign({},this._parameters)}},layers:{get:function(){return this._layers}}}),Object.assign(Ot.prototype,{load:function(e,t){"string"==typeof e&&(e={load:e,original:e});var i={retry:this.retryRequests};e.load.startsWith("blob:")&&(i.responseType=f.ResponseType.JSON),qr.get(e.load,i,function(i,s){i?t("Error loading animation state graph resource: "+e.original+" ["+i+"]"):t(null,s)})},open:function(e,t){return new It(t)}}),Object.defineProperty(Rt.prototype,"duration",{get:function(){var e=0;return this.buffer?e=this.buffer.duration:this.audio&&(e=this.audio.duration),e||0}});var yl=function(){if("undefined"==typeof window)return!1;var e=window.navigator.userAgent,t=e.indexOf("MSIE ");return 0<t?parseInt(e.substring(t+5,e.indexOf(".",t)),10):0<e.indexOf("Trident/")&&(t=e.indexOf("rv:"),parseInt(e.substring(t+3,e.indexOf(".",t)),10))}();Object.assign(Dt.prototype,{_isSupported:function(e){return!!{".ogg":"audio/ogg",".mp3":"audio/mpeg",".wav":"audio/x-wav",".mp4a":"audio/mp4",".m4a":"audio/mp4",".mp4":"audio/mp4",".aac":"audio/aac"}[zr.getExtension(e)]},load:function(e,t){"string"==typeof e&&(e={load:e,original:e});var i=function(i){var s="Error loading audio url: "+e.original;i&&(s+=": "+(i.message||i)),console.warn(s),t(s)};this._createSound?this._isSupported(e.original)?this._createSound(e.load,function(e){t(null,new Rt(e))},i):i("Audio format for "+e.original+" not supported"):i(null)},open:function(e,t){return t}}),nt()?Dt.prototype._createSound=function(e,t,i){var s=this.manager;if(s.context){var n={retry:this.retryRequests};e.startsWith("blob:")&&(n.responseType=f.ResponseType.ARRAY_BUFFER),qr.get(e,n,function(e,n){e?i(e):s.context.decodeAudioData(n,t,i)})}else i("Audio manager has no audio context")}:st()&&(Dt.prototype._createSound=function(e,t,i){var s=null;try{s=new Audio}catch(e){return void i("No support for Audio element")}yl&&document.body.appendChild(s);var n=function(){s.removeEventListener("canplaythrough",n),yl&&document.body.removeChild(s),t(s)};s.onerror=function(){s.onerror=null,yl&&document.body.removeChild(s),i()},s.addEventListener("canplaythrough",n),s.src=e}),Object.assign(Lt.prototype,{load:function(e,t){"string"==typeof e&&(e={load:e,original:e}),qr.get(e.load,{responseType:f.ResponseType.ARRAY_BUFFER,retry:this.retryRequests},function(i,s){i?t("Error loading binary resource: "+e.original+" ["+i+"]"):t(null,s)})},open:function(e,t){return t},patch:function(e,t){}}),Ft.prototype.hasBlobUrl=function(e){return!!this._blobUrls[e]},Ft.prototype.getBlobUrl=function(e){return this._blobUrls[e]},Ft.prototype.destroy=function(){for(var e in this._blobUrls)URL.revokeObjectURL(this._blobUrls[e]);this._blobUrls=null};var vl,bl=null;Nt.prototype._onMessage=function(e){var t=e.data.id;if(this._pendingRequests[t]){var i=this._pendingRequests[t];if(delete this._pendingRequests[t],e.data.error)i(e.data.error);else{t=e.data.arrayBuffer;for(var s=0,n=e.data.files.length;s<n;s++){var r=e.data.files[s],a=new Blob([t.slice(r.start,r.start+r.size)]);r.url=URL.createObjectURL(a)}i(null,e.data.files)}}},Nt.prototype.untar=function(e,t){var i=this._requestId++;this._pendingRequests[i]=t,this._worker.postMessage({id:i,prefix:this._filenamePrefix,arrayBuffer:e},[e])},Nt.prototype.hasPendingRequests=function(){for(var e in this._pendingRequests)return!0;return!1},Nt.prototype.destroy=function(){this._worker&&(this._worker.terminate(),this._pendingRequests=this._worker=null)},Bt(),Object.assign(kt.prototype,{load:function(e,t){"string"==typeof e&&(e={load:e,original:e});var i=this;qr.get(e.load,{responseType:f.ResponseType.ARRAY_BUFFER,retry:this.retryRequests},function(s,n){if(s)t("Error loading bundle resource "+e.original+": "+s);else try{i._untar(n,t)}catch(i){t("Error loading bundle resource "+e.original+": "+i)}})},_untar:function(e,t){var i=this;Vr.workers?(i._worker||(i._worker=new Nt(i._assets.prefix)),i._worker.untar(e,function(e,s){t(e,s),i._worker.hasPendingRequests()||(i._worker.destroy(),i._worker=null)})):(e=new vl(e).untar(i._assets.prefix),t(null,e))},open:function(e,t){return new Ft(t)},patch:function(e,t){}}),Object.assign(Ut.prototype,{destroy:function(){var e=this.registry,t=function(t){e.remove(t),t.unload()},i=function(e){e.forEach(function(e){t(e)})};this.animations&&(i(this.animations),this.animations=null),this.textures&&(i(this.textures),this.textures=null),this.materials&&(i(this.materials),this.materials=null),this.model&&(t(this.model),this.model=null),this.assets=this.data=null}}),Object.assign(zt.prototype,{_getUrlWithoutParams:function(e){return 0<=e.indexOf("?")?e.split("?")[0]:e},load:function(e,t,i){"string"==typeof e&&(e={load:e,original:e});var s=this;qr.get(e.load,{responseType:f.ResponseType.ARRAY_BUFFER,retry:!1},function(n,r){t&&(n?t("Error loading model: "+e.original+" ["+n+"]"):At.parseAsync(s._getUrlWithoutParams(e.original),zr.extractPath(e.load),r,s._device,i.registry,i.options,function(e,i){e?t(e):t(null,new Ut(i))}))})},open:function(e,t,i){return t},patch:function(e,t){var i,s=function(i,s,n){return(i=new Pt(e.name+"/"+i+"/"+n,i,{url:""})).resource=s,i.loaded=!0,t.add(i),i},n=e.resource,r=n.data,a=0===r.meshes.length?null:s("model",At.createModel(r,this._defaultMaterial),0),o=[];for(i=0;i<r.materials.length;++i)o.push(s("material",r.materials[i],i));var h=[];for(i=0;i<r.animations.length;++i)h.push(s("animation",r.animations[i],i));n.data=null,n.model=a,n.materials=o,n.textures=r.textures,n.animations=h,n.registry=t}}),Object.assign(Vt.prototype,{load:function(e,t){"string"==typeof e&&(e={load:e,original:e}),qr.get(e.load,{retry:this.retryRequests},function(i,s){i?t("Error loading css resource: "+e.original+" ["+i+"]"):t(null,s)})},open:function(e,t){return t},patch:function(e,t){}}),Object.assign(Gt.prototype,{load:function(e,t){},open:function(e,t){},patch:function(e,t){var i=this,s=!1;if(e.resources[0]||(e.resources[0]=new K(this._device,{format:7,cubemap:!0,mipmaps:!0,fixCubemapSeams:!!e._dds}),e.resources[0].name="cubemap",s=!0),e.file){if(e.file&&!e._dds){var n=e.getFileUrl();t._loader.load(n+"?t="+e.file.hash,"texture",function(s,n){s?(t.fire("error",s,e),t.fire("error:"+e.id,s,e),e.fire("error",s,e)):(t._loader.patch({resource:n,type:"texture",data:e.data},t),e._dds=n,i.patch(e,t))})}}else delete e._dds;if(e.file&&e._dds||!e.resources[1]){if(e._dds&&!e.resources[1]){for(e.resources=[e.resources[0]],e._dds.fixCubemapSeams=!0,e._dds.addressU=1,e._dds.addressV=1,s=0,this._device.useTexCubeLod&&(e.resources.push(e._dds),s=1);6>s;s++)(n=new K(this._device,{cubemap:!0,fixCubemapSeams:!0,mipmaps:!0,format:e._dds.format,type:e._dds.type,width:Math.pow(2,7-s),height:Math.pow(2,7-s)})).name="cubemap-mip",n._levels[0]=e._dds._levels[s],n.upload(),e.resources.push(n);s=!0}}else e.resources=[e.resources[0]],s=!0;if((n=e.resource).name!==e.name&&(n.name=e.name),e.data.hasOwnProperty("rgbm")){var r=e.data.rgbm?"rgbm":"default";n.type!==r&&(n.type=r)}n.fixCubemapSeams=!!e._dds,e.data.hasOwnProperty("minFilter")&&n.minFilter!==e.data.minFilter&&(n.minFilter=e.data.minFilter),e.data.hasOwnProperty("magFilter")&&n.magFilter!==e.data.magFilter&&(n.magFilter=e.data.magFilter),e.data.hasOwnProperty("anisotropy")&&n.anisotropy!==e.data.anisotropy&&(n.anisotropy=e.data.anisotropy),1!==n.addressU&&(n.addressU=1),1!==n.addressV&&(n.addressV=1),this._patchTextureFaces(e,t),s&&(t.fire("load",e),t.fire("load:"+e.id,e),e.fire("load",e))},_patchTexture:function(){this.registry._loader._handlers.cubemap._patchTextureFaces(this,this.registry)},_patchTextureFaces:function(e,t){if(e.loadFaces||!e.file){var i=e.resource,s=[],n=0,r=!1,a=this;e._levelsEvents||(e._levelsEvents=[null,null,null,null,null,null]),e.data.textures.forEach(function(o,h){var l,c=function(o){n++,s[h]=o&&o.resource.getSource()||null;var l=e._levelsEvents[h];l!==o&&(l&&l.off("load",a._patchTexture,e),o&&o.on("load",a._patchTexture,e),e._levelsEvents[h]=o||null),s[h]!==i._levels[0][h]&&(r=!0),6===n&&r&&(i.setSource(s),t.fire("load",e),t.fire("load:"+e.id,e),e.fire("load",e))},d=function(e){e.ready(c),t.load(e)};null===o?c(null):parseInt(o,10)===o?(l=t.get(o))?(l.ready(c),t.load(l)):o?(t.once("load:"+o,c),t.once("add:"+o,d)):c(null):(l=new Pt(e.name+"_face_"+h,"texture",{url:o}),t.add(l),t.load(l),t.once("load:"+l.id,c),t.once("add:"+l.id,d))})}}}),Object.assign(jt.prototype,{load:function(e,t){t(null,null)},open:function(e,t){return t}}),Object.defineProperty(Wt.prototype,"data",{get:function(){return this._data},set:function(e){if((this._data=e)&&(void 0!==this._data.intensity&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),(!this._data.version||2>this._data.version)&&(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars)))for(var t in this._data.chars)this._data.chars[t].map=0}}),Object.assign(Xt.prototype,{load:function(e,t,i){"string"==typeof e&&(e={load:e,original:e});var s=this;".json"===zr.getExtension(e.original)?qr.get(e.load,{retry:this.retryRequests},function(i,n){var r=Ht(n);i?t("Error loading font resource: "+e.original+" ["+i+"]"):s._loadTextures(e.load.replace(".json",".png"),r,function(e,i){if(e)return t(e);t(null,{data:r,textures:i})})}):(i&&i.data&&(i.data=Ht(i.data)),this._loadTextures(e.load,i&&i.data,t))},_loadTextures:function(e,t,i){var s=t.info.maps.length,n=0,r=null,a=Array(s),o=this._loader;t=function(t){var h=function(e,o){if(!r){if(e)return r=e,i(e);o.upload(),a[t]=o,++n===s&&i(null,a)}};0===t?o.load(e,"texture",h):o.load(e.replace(".png",t+".png"),"texture",h)};for(var h=0;h<s;h++)t(h)},open:function(e,t,i){return t.textures?new Wt(t.textures,t.data):new Wt(t,null)},patch:function(e,t){!(t=e.resource).data&&e.data?t.data=e.data:!e.data&&t.data&&(e.data=t.data),e.data&&(e.data=Ht(e.data))}}),qt.prototype=Object.create(r.prototype),qt.prototype.constructor=qt,qt.prototype.destroy=function(){var e=this;this._registry.off("load",this._onLoad),this._registry.off("error",this._onError),this._waitingAssets.forEach(function(t){e._registry.off("add:"+t,this._onAddAsset)}),this.off("progress"),this.off("load")},qt.prototype.load=function(e,t){var i=this._assets.length;for(this._count=0,this._failed=[],this._callback=e,this._scope=t,this._registry.on("load",this._onLoad,this),this._registry.on("error",this._onError,this),e=0;e<i;e++)(t=this._assets[e]).loading||t.loaded||(this._registry.load(t),this._total++)},qt.prototype.ready=function(e,t){t=t||this,this._loaded?e.call(t,this._assets):this.once("load",function(i){e.call(t,i)})},qt.prototype._loadingComplete=function(){this._loaded=!0,this._registry.off("load",this._onLoad,this),this._registry.off("error",this._onError,this),this._failed&&this._failed.length?(this._callback&&this._callback.call(this._scope,"Failed to load some assets",this._failed),this.fire("error",this._failed)):(this._callback&&this._callback.call(this._scope),this.fire("load",this._assets))},qt.prototype._onLoad=function(e){var t=this;0<=this._assets.indexOf(e)&&(this._count++,this.fire("progress",e)),this._count===this._total&&setTimeout(function(){t._loadingComplete(t._failed)},0)},qt.prototype._onError=function(e,t){var i=this;0<=this._assets.indexOf(t)&&(this._count++,this._failed.push(t)),this._count===this._total&&setTimeout(function(){i._loadingComplete(i._failed)},0)},qt.prototype._onAddAsset=function(e){var t=this._waitingAssets.indexOf(e);0<=t&&this._waitingAssets.splice(t,1),this._assets.push(e);var i=this._assets.length;for(t=0;t<i;t++)(e=this._assets[t]).loading||e.loaded||this._registry.load(e)},qt.prototype._waitForAsset=function(e){this._waitingAssets.push(e),this._registry.once("add:"+e,this._onAddAsset,this)};var xl={waitForTemplatesInScene:function(e,t,i){if(e.collapsedInstances){var s=xl._getAllCollapsedEntities(e);xl.waitForTemplateAssets(s,t,i,e)}else i(null,e)},waitForTemplateAssets:function(e,t,i,s){new qt(e=xl._extractTemplateIds(e),t).load(function(e){i(e,s)})},_getAllCollapsedEntities:function(e){var t={};return e.collapsedInstances.forEach(function(e){Object.assign(t,e.instanceEntities)}),t},_extractTemplateIds:function(e){var t,i=[];for(t in e){var s=e[t].template_id;s&&i.push(s)}return i},expandTemplateEntities:function(e,t){var i,s={};for(i in t){var n=t[i];s[i]=n.collapsed_entity?xl.expandEntity(e,n):n}return s},expandEntity:function(e,t){}};Object.assign(Yt.prototype,{parse:function(e){var t,i,s={},n=null;for(t in e.collapsedInstances&&this._addCollapsedToEntities(this._app,e),e.entities)s[t]=this._createEntity(e.entities[t]),null===e.entities[t].parent&&(n=s[t]);for(t in e.entities){var r=e.entities[t].children.length;for(i=0;i<r;i++){var a=e.entities[t].children[i];s[a]&&s[t].addChild(s[a])}}return this._openComponentData(n,e.entities),n},_createEntity:function(e){var t=new ut,i=e.position,s=e.rotation,n=e.scale;if(t.name=e.name,t.setGuid(e.resource_id),t.setLocalPosition(i[0],i[1],i[2]),t.setLocalEulerAngles(s[0],s[1],s[2]),t.setLocalScale(n[0],n[1],n[2]),t._enabled=void 0===e.enabled||e.enabled,this._isTemplate||(t._enabledInHierarchy=t._enabled),t.template=e.template,e.tags)for(i=0;i<e.tags.length;i++)t.tags.add(e.tags[i]);return e.labels&&e.labels.forEach(function(e){t.addLabel(e)}),t},_openComponentData:function(e,t){var i,s=this._app.systems.list,n=s.length,r=t[e.getGuid()];for(i=0;i<n;i++){var a=s[i],o=r.components[a.id];o&&a.addComponent(e,o)}for(n=r.children.length,s=e._children,i=0;i<n;i++)s[i]=this._openComponentData(s[i],t);return e},_addCollapsedToEntities:function(e,t){t.collapsedInstances.forEach(function(i){i=xl.expandTemplateEntities(e,i.instanceEntities),Object.assign(t.entities,i)})}}),Object.assign(Kt.prototype,{load:function(e,t){"string"==typeof e&&(e={load:e,original:e});var i=this._app.assets;qr.get(e.load,{retry:this.retryRequests},function(s,n){s?(n="Error while loading scene "+e.original,s.message?(n+=": "+s.message,s.stack&&(n+="\n"+s.stack)):n+=": "+s,t(n)):xl.waitForTemplatesInScene(n,i,t)})},open:function(e,t){return this._app.systems.script.preloading=!0,e=new Yt(this._app,!1).parse(t),this._app.systems.script.preloading=!1,e}}),Object.assign(Zt.prototype,{load:function(e,t){"string"==typeof e&&(e={load:e,original:e}),qr.get(e.load,{retry:this.retryRequests},function(i,s){i?t("Error loading html resource: "+e.original+" ["+i+"]"):t(null,s)})},open:function(e,t){return t},patch:function(e,t){}}),Object.assign($t.prototype,{load:function(e,t){"string"==typeof e&&(e={load:e,original:e});var i={retry:this.retryRequests};e.load.startsWith("blob:")&&(i.responseType=f.ResponseType.JSON),qr.get(e.load,i,function(i,s){i?t("Error loading JSON resource: "+e.original+" ["+i+"]"):t(null,s)})},open:function(e,t){return t},patch:function(e,t){}});var Sl,Tl={name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",ambientTint:"boolean",aoVertexColor:"boolean",aoVertexColorChannel:"string",aoMap:"texture",aoMapChannel:"string",aoMapUv:"number",aoMapTiling:"vec2",aoMapOffset:"vec2",diffuse:"rgb",diffuseTint:"boolean",diffuseVertexColor:"boolean",diffuseVertexColorChannel:"string",diffuseMap:"texture",diffuseMapChannel:"string",diffuseMapUv:"number",diffuseMapTiling:"vec2",diffuseMapOffset:"vec2",diffuseDetailMap:"texture",diffuseDetailMapChannel:"string",diffuseDetailMapUv:"number",diffuseDetailMapTiling:"vec2",diffuseDetailMapOffset:"vec2",diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean",specularVertexColor:"boolean",specularVertexColorChannel:"string",specularMap:"texture",specularMapChannel:"string",specularMapUv:"number",specularMapTiling:"vec2",specularMapOffset:"vec2",specularAntialias:"boolean",occludeSpecular:"enum:occludeSpecular",useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",clearCoat:"number",clearCoatGlossiness:"number",metalnessTint:"boolean",metalnessVertexColor:"boolean",metalnessVertexColorChannel:"string",metalnessMap:"texture",metalnessMapChannel:"string",metalnessMapUv:"number",metalnessMapTiling:"vec2",metalnessMapOffset:"vec2",conserveEnergy:"boolean",shininess:"number",glossVertexColor:"boolean",glossVertexColorChannel:"string",glossMap:"texture",glossMapChannel:"string",glossMapUv:"number",glossMapTiling:"vec2",glossMapOffset:"vec2",fresnelModel:"number",emissive:"rgb",emissiveTint:"boolean",emissiveVertexColor:"boolean",emissiveVertexColorChannel:"string",emissiveMap:"texture",emissiveMapChannel:"string",emissiveMapUv:"number",emissiveMapTiling:"vec2",emissiveMapOffset:"vec2",emissiveIntensity:"number",normalMap:"texture",normalMapTiling:"vec2",normalMapOffset:"vec2",normalMapUv:"number",bumpiness:"number",normalDetailMap:"texture",normalDetailMapTiling:"vec2",normalDetailMapOffset:"vec2",normalDetailMapUv:"number",normalDetailMapBumpiness:"number",heightMap:"texture",heightMapChannel:"string",heightMapUv:"number",heightMapTiling:"vec2",heightMapOffset:"vec2",heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",opacity:"number",opacityVertexColor:"boolean",opacityVertexColorChannel:"string",opacityMap:"texture",opacityMapChannel:"string",opacityMapUv:"number",opacityMapTiling:"vec2",opacityMapOffset:"vec2",reflectivity:"number",refraction:"number",refractionIndex:"number",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",lightVertexColor:"boolean",lightVertexColorChannel:"string",lightMap:"texture",lightMapChannel:"string",lightMapUv:"number",lightMapTiling:"vec2",lightMapOffset:"vec2",depthTest:"boolean",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",shadingModel:"enum:shadingModel",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useGammaTonemap:"boolean",prefilteredCubeMap128:"texture",prefilteredCubeMap64:"texture",prefilteredCubeMap32:"texture",prefilteredCubeMap16:"texture",prefilteredCubeMap8:"texture",prefilteredCubeMap4:"texture"},wl=[];for(Sl in Tl){var Ml=Tl[Sl];"texture"===Ml&&wl.push(Sl)}var Pl=[];for(Sl in Tl)"cubemap"===(Ml=Tl[Sl])&&Pl.push(Sl);Qt.prototype._bind=function(){this.id&&(this._onAssetLoad&&this._registry.on("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:"+this.id,this._onRemove,this)),this.url&&(this._onAssetLoad&&this._registry.on("load:url:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:url:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:url:"+this.url,this._onRemove,this))},Qt.prototype._unbind=function(){this.id&&(this._onAssetLoad&&this._registry.off("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.id,this._onRemove,this)),this.url&&(this._onAssetLoad&&this._registry.off("load:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.url,this._onRemove,this))},Qt.prototype._onLoad=function(e){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,e)},Qt.prototype._onAdd=function(e){this._onAssetAdd.call(this._scope,this.propertyName,this.parent,e)},Qt.prototype._onRemove=function(e){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,e)},Object.defineProperty(Qt.prototype,"id",{get:function(){return this._id},set:function(e){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=e,this.asset=this._registry.get(this._id),this._bind()}}),Object.defineProperty(Qt.prototype,"url",{get:function(){return this._url},set:function(e){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=e,this.asset=this._registry.getByUrl(this._url),this._bind()}}),Jt.prototype.setInvalid=function(e,t){this.valid=!1,this.removeInvalid&&delete t[e]},Jt.prototype.validate=function(e){var t,i,s="path"===e.mappingFormat;for(i in e)if(t=Tl[i])if(t.startsWith("enum"))t=t.split(":")[1],this.enumValidators[t]&&(this.enumValidators[t](e[i])||this.setInvalid(i,e));else if("number"===t)"number"!=typeof e[i]&&this.setInvalid(i,e);else if("boolean"===t)"boolean"!=typeof e[i]&&this.setInvalid(i,e);else if("string"===t)"string"!=typeof e[i]&&this.setInvalid(i,e);else if("vec2"===t)e[i]instanceof Array&&2===e[i].length||this.setInvalid(i,e);else if("rgb"===t)e[i]instanceof Array&&3===e[i].length||this.setInvalid(i,e);else if("texture"===t)s?"string"==typeof e[i]||e[null===i]||e[i]instanceof K||this.setInvalid(i,e):"number"!=typeof e[i]&&null!==e[i]&&(e[i]instanceof K||this.setInvalid(i,e));else if("boundingbox"===t)e[i].center&&e[i].center instanceof Array&&3===e[i].center.length||this.setInvalid(i,e),e[i].halfExtents&&e[i].halfExtents instanceof Array&&3===e[i].halfExtents.length||this.setInvalid(i,e);else if("cubemap"===t)"number"!=typeof e[i]&&null!==e[i]&&void 0!==e[i]&&(e[i]instanceof K&&e[i].cubemap||this.setInvalid(i,e));else if("chunks"===t){var n=Object.keys(e[i]);for(t=0;t<n.length;t++)"string"!=typeof e[i][n[t]]&&this.setInvalid(n[t],e[i])}else console.error("Unknown material type: "+t);else this.valid=!1;return e.validated=!0,this.valid},Jt.prototype._createEnumValidator=function(e){return function(t){return 0<=e.indexOf(t)}},ei.prototype.parse=function(e){e=this.migrate(e),e=this._validate(e);var t=new Nn;return this.initialize(t,e),t},ei.prototype.initialize=function(e,t){for(var i in t.validated||(this._validator||(this._validator=new Jt),this._validator.validate(t)),t.chunks&&e.chunks.copy(t.chunks),t){var s=Tl[i],n=t[i];"vec2"===s?e[i]=new T(n[0],n[1]):"rgb"===s?e[i]=new h(n[0],n[1],n[2]):"texture"===s?n instanceof K?e[i]=n:e[i]instanceof K&&"number"==typeof n&&0<n||(e[i]=null):"cubemap"===s?n instanceof K?e[i]=n:e[i]instanceof K&&"number"==typeof n&&0<n||(e[i]=null):"boundingbox"===s?(s=new v(n.center[0],n.center[1],n.center[2]),n=new v(n.halfExtents[0],n.halfExtents[1],n.halfExtents[2]),e[i]=new w(s,n)):e[i]=t[i]}e.update()},ei.prototype.migrate=function(e){void 0===e.shadingModel&&(e.shadingModel="blinn"===e.shader?1:0),e.shader&&delete e.shader,e.mapping_format&&(e.mappingFormat=e.mapping_format,delete e.mapping_format);var t,i=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor","emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor","glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["diffuseMapTint","diffuseTint"],["specularMapTint","specularTint"],["emissiveMapTint","emissiveTint"],["metalnessMapTint","metalnessTint"]];for(t=0;t<i.length;t++){var s=i[t][0],n=i[t][1];void 0!==e[s]&&void 0===e[n]&&(e[n]=e[s],delete e[s])}for(i=["fresnelFactor","shadowSampleType"],t=0;t<i.length;t++)s=i[t],e.hasOwnProperty(s)&&delete e[s];return e},ei.prototype._validate=function(e){return this._validator||(this._validator=new Jt),this._validator.validate(e),e};var Al={aoMap:"white",diffuseMap:"gray",specularMap:"gray",metalnessMap:"black",glossMap:"gray",emissiveMap:"gray",normalMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white"};Object.assign(ti.prototype,{load:function(e,t){"string"==typeof e&&(e={load:e,original:e}),qr.get(e.load,{retry:this.retryRequests},function(i,s){i?t&&t("Error loading material: "+e.original+" ["+i+"]"):t&&(s._engine=!0,t(null,s))})},open:function(e,t){return e=this._parser.parse(t),t._engine&&(e._data=t,delete t._engine),e},_createPlaceholders:function(){this._placeholderTextures={};var e,t={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255]};for(e in t)if(t.hasOwnProperty(e)){this._placeholderTextures[e]=new K(this._device,{width:2,height:2,format:7}),this._placeholderTextures[e].name="placeholder";for(var i=this._placeholderTextures[e].lock(),s=0;4>s;s++)for(var n=0;4>n;n++)i[4*s+n]=t[e][n];this._placeholderTextures[e].unlock()}},patch:function(e,t){e.resource._data&&(e._data=e.resource._data,delete e.resource._data),e.data.name=e.name,e.resource.name=e.name,this._bindAndAssignAssets(e,t),e.off("unload",this._onAssetUnload,this),e.on("unload",this._onAssetUnload,this)},_onAssetUnload:function(e){delete e.data.parameters,delete e.data.chunks,delete e.data.name},_assignTexture:function(e,t,i){t.data[e]=i,t.resource[e]=i},_assignPlaceholderTexture:function(e,t){this._placeholderTextures||this._createPlaceholders(),t.resource[e]=this._placeholderTextures[Al[e]]},_onTextureLoad:function(e,t,i){this._assignTexture(e,t,i.resource),t.resource.update()},_onTextureAdd:function(e,t,i){this._assets.load(i)},_onTextureRemove:function(e,t,i){var s=t.resource;s[e]===i.resource&&(this._assignTexture(e,t,null),s.update())},_assignCubemap:function(e,t,i){t.data[e]=i[0],7===i.length&&(t.data.prefilteredCubeMap128=i[1],t.data.prefilteredCubeMap64=i[2],t.data.prefilteredCubeMap32=i[3],t.data.prefilteredCubeMap16=i[4],t.data.prefilteredCubeMap8=i[5],t.data.prefilteredCubeMap4=i[6])},_onCubemapLoad:function(e,t,i){this._assignCubemap(e,t,i.resources),this._parser.initialize(t.resource,t.data)},_onCubemapAdd:function(e,t,i){0===t.data.shadingModel&&(t.loadFaces=!0),this._assets.load(i)},_onCubemapRemove:function(e,t,i){var s=t.resource;s[e]===i.resource&&(this._assignCubemap(e,t,[null,null,null,null,null,null,null]),s.update())},_bindAndAssignAssets:function(e,t){var i,s=this._parser.migrate(e.data),n=e.resource,r="path"===s.mappingFormat;for(i=0;i<wl.length;i++){var a=wl[i],o=n._assetReferences[a];!s[a]||s[a]instanceof K?o&&(r?o.url=null:o.id=null):(o||(o=new Qt(a,e,t,{load:this._onTextureLoad,add:this._onTextureAdd,remove:this._onTextureRemove},this),n._assetReferences[a]=o),r?o.url=e.getAbsoluteUrl(s[a]):o.id=s[a],o.asset&&(o.asset.resource?this._assignTexture(a,e,o.asset.resource):this._assignPlaceholderTexture(a,e),t.load(o.asset)))}for(i=0;i<Pl.length;i++)a=Pl[i],o=n._assetReferences[a],!s[a]||s[a]instanceof K||(o||(o=new Qt(a,e,t,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemove},this),n._assetReferences[a]=o),r?o.url=s[a]:o.id=s[a],o.asset&&(o.asset.resource&&this._assignCubemap(a,e,o.asset.resources),t.load(o.asset)));this._parser.initialize(n,s)}}),Object.assign(ii.prototype,{parse:function(e){return(e=At.parse("filename.glb",e,this._device))?At.createModel(e,this._defaultMaterial):null}}),Object.assign(ni.prototype,{addVertex:function(e,t,i){if(void 0!==this.indexMap[t])i=this.indexMap[t],this.indices.push(i);else{for(var s=0;4>s;s++)0!==i.blendWeight.data[4*t+s]&&(e.boneIndices[s]=this.getBoneRemap(i.blendIndices.data[4*e.index+s]));i=this.vertices.length,this.indices.push(i),this.vertices.push(e),this.indexMap[t]=i}},addPrimitive:function(e,t,i,s){var n,r,a=[],o=0,h=e.length;for(n=0;n<h;n++)for(var l=e[n].index,c=0;4>c;c++)if(0<i.blendWeight.data[4*l+c]){var d=i.blendIndices.data[4*l+c],u=!0;for(r=0;r<o;r++)if(a[r]==d){u=!1;break}u&&(a[o]=d,o+=-1===(r=this.getBoneRemap(d))?1:0)}if(this.boneIndices.length+o>s)return!1;for(n=0;n<o;n++)this.boneIndices.push(a[n]);for(n=0;n<h;n++)this.addVertex(e[n],t[n],i);return!0},getBoneRemap:function(e){for(var t=0;t<this.boneIndices.length;t++)if(this.boneIndices[t]===e)return t;return-1}});var El={points:0,lines:1,lineloop:2,linestrip:3,triangles:4,trianglestrip:5,trianglefan:6},Cl={int8:0,uint8:1,int16:2,uint16:3,int32:4,uint32:5,float32:6};Object.assign(ai.prototype,{parse:function(e){var t=e.model;if(!t||1>=t.version)return null;t=this._parseNodes(e);var i=this._parseSkins(e,t),s=this._parseVertexBuffers(e),n=this._parseIndexBuffers(e,s),r=this._parseMorphs(e,t,s);return s=this._parseMeshes(e,i.skins,r.morphs,s,n.buffer,n.data),e=this._parseMeshInstances(e,t,s,i.skins,i.instances,r.morphs,r.instances),(s=new oe).graph=t[0],s.meshInstances=e,s.skinInstances=i.instances,s.morphInstances=r.instances,s.getGraph().syncHierarchy(),s},_parseNodes:function(e){e=e.model;var t,i=[];for(t=0;t<e.nodes.length;t++){var s=e.nodes[t],n=new ge(s.name);n.setLocalPosition(s.position[0],s.position[1],s.position[2]),n.setLocalEulerAngles(s.rotation[0],s.rotation[1],s.rotation[2]),n.setLocalScale(s.scale[0],s.scale[1],s.scale[2]),n.scaleCompensation=!!s.scaleCompensation,i.push(n)}for(t=1;t<e.parents.length;t++)i[e.parents[t]].addChild(i[t]);return i},_parseSkins:function(e,t){e=e.model;var i,s=[],n=[];if(!this._device.supportsBoneTextures&&0<e.skins.length){var r=this._device.getBoneLimit();ri(e,null,r)}for(r=0;r<e.skins.length;r++){var a=e.skins[r],o=[];for(i=0;i<a.inverseBindMatrices.length;i++){var h=a.inverseBindMatrices[i];o[i]=(new x).set(h)}for(a=new re(this._device,o,a.boneNames),s.push(a),o=new ae(a),h=[],i=0;i<a.boneNames.length;i++){var l=t[0].findByName(a.boneNames[i]);h.push(l)}o.bones=h,n.push(o)}return{skins:s,instances:n}},_getMorphVertexCount:function(e,t,i){for(var s=0;s<e.meshes.length;s++){var n=e.meshes[s];if(n.morph===t)return i[n.vertices].numVertices}},_parseMorphs:function(e,t,i){t=[];var s,n,r=[];if((e=e.model).morphs){var a=function(e,t,i){i=new Float32Array(3*i);for(var s=0;s<t.length;s++){var n=3*t[s];i[n]=e[3*s],i[n+1]=e[3*s+1],i[n+2]=e[3*s+2]}return i};for(s=0;s<e.morphs.length;s++){var o=e.morphs[s].targets,h=[],l=this._getMorphVertexCount(e,s,i);for(n=0;n<o.length;n++){var c=o[n].aabb,d=c.min;d=new w(new v(.5*((c=c.max)[0]+d[0]),.5*(c[1]+d[1]),.5*(c[2]+d[2])),new v(.5*(c[0]-d[0]),.5*(c[1]-d[1]),.5*(c[2]-d[2]))),c=o[n].indices;var u=o[n].deltaPositions,p=o[n].deltaNormals;c&&(u=a(u,c,l),p=a(p,c,l)),d=new ct({deltaPositions:u,deltaNormals:p,name:o[n].name,aabb:d}),h.push(d)}n=new se(h,this._device),t.push(n),n=new ne(n),r.push(n)}}return{morphs:t,instances:r}},_parseVertexBuffers:function(e){e=e.model;var t,i,s,n=[],r={position:"POSITION",normal:"NORMAL",tangent:"TANGENT",blendWeight:"BLENDWEIGHT",blendIndices:"BLENDINDICES",color:"COLOR",texCoord0:"TEXCOORD0",texCoord1:"TEXCOORD1",texCoord2:"TEXCOORD2",texCoord3:"TEXCOORD3",texCoord4:"TEXCOORD4",texCoord5:"TEXCOORD5",texCoord6:"TEXCOORD6",texCoord7:"TEXCOORD7"};for(i=0;i<e.vertices.length;i++){var a=e.vertices[i],o=[];for(t in a){var h=a[t];o.push({semantic:r[t],components:h.components,type:Cl[h.type],normalize:"COLOR"===r[t]})}h=new R(this._device,o),o=a.position.data.length/a.position.components;var l=new I(this._device,h,o),c=new X(l);for(s=0;s<o;s++){for(t in a)switch(h=a[t],h.components){case 1:c.element[r[t]].set(h.data[s]);break;case 2:c.element[r[t]].set(h.data[2*s],h.data[2*s+1]);break;case 3:c.element[r[t]].set(h.data[3*s],h.data[3*s+1],h.data[3*s+2]);break;case 4:c.element[r[t]].set(h.data[4*s],h.data[4*s+1],h.data[4*s+2],h.data[4*s+3])}c.next()}c.end(),n.push(l)}return n},_parseIndexBuffers:function(e,t){var i,s=e.model,n=e=null,r=0;for(i=0;i<s.meshes.length;i++){var a=s.meshes[i];void 0!==a.indices&&(r+=a.indices.length)}for(i=s=0;i<t.length;i++)s=Math.max(s,t[i].numVertices);return 0<r&&(65535<s&&this._device.extUintElement?(e=new Z(this._device,2,r),n=new Uint32Array(e.lock())):(e=new Z(this._device,1,r),n=new Uint16Array(e.lock()))),{buffer:e,data:n}},_parseMeshes:function(e,t,i,s,n,r){e=e.model;var a,o=[],h=0;for(a=0;a<e.meshes.length;a++){var l=e.meshes[a],c=l.aabb,d=c.min;d=new w(new v(.5*((c=c.max)[0]+d[0]),.5*(c[1]+d[1]),.5*(c[2]+d[2])),new v(.5*(c[0]-d[0]),.5*(c[1]-d[1]),.5*(c[2]-d[2]))),c=void 0!==l.indices;var u=new J(this._device);u.vertexBuffer=s[l.vertices],u.indexBuffer[0]=c?n:null,u.primitive[0].type=El[l.type],u.primitive[0].base=c?l.base+h:l.base,u.primitive[0].count=l.count,u.primitive[0].indexed=c,u.skin=void 0!==l.skin?t[l.skin]:null,u.morph=void 0!==l.morph?i[l.morph]:null,u.aabb=d,c&&(r.set(l.indices,h),h+=l.indices.length),o.push(u)}return null!==n&&n.unlock(),o},_parseMeshInstances:function(e,t,i,s,n,r,a){e=e.model;var o,h=[];for(o=0;o<e.meshInstances.length;o++){var l=e.meshInstances[o],c=i[l.mesh];if(l=new ee(t[l.node],c,this._defaultMaterial),c.skin){var d=s.indexOf(c.skin);l.skinInstance=n[d]}c.morph&&(c=r.indexOf(c.morph),l.morphInstance=a[c]),h.push(l)}return h}}),Object.assign(oi.prototype,{load:function(e,t){"string"==typeof e&&(e={load:e,original:e});var i={retry:this.retryRequests};e.load.startsWith("blob:")&&(".glb"===zr.getExtension(e.original).toLowerCase()?i.responseType=f.ResponseType.ARRAY_BUFFER:i.responseType=f.ResponseType.JSON),qr.get(e.load,i,function(i,s){t&&(i?t("Error loading model: "+e.original+" ["+i+"]"):t(null,s))})},open:function(e,t){for(var i=0;i<this._parsers.length;i++){var s=this._parsers[i];if(s.decider(e,t))return s.parser.parse(t)}return null},patch:function(e,t){if(e.resource){var i=e.data,s=this;e.resource.meshInstances.forEach(function(n,r){if(i.mapping){var a=function(e){e.resource?n.material=e.resource:(e.once("load",a),t.load(e)),e.once("remove",function(e){n.material===e.resource&&(n.material=s._defaultMaterial)})};if(i.mapping[r]){var o=i.mapping[r].material,h=i.mapping[r].path;void 0!==o?o?(r=t.get(o))?a(r):t.once("add:"+o,a):n.material=s._defaultMaterial:h&&(o=e.getAbsoluteUrl(i.mapping[r].path),(r=t.getByUrl(o))?a(r):t.once("add:url:"+o,a))}else n.material=s._defaultMaterial}})}},addParser:function(e,t){this._parsers.push({parser:e,decider:t})}}),Object.assign(hi.prototype,{addHandler:function(e,t){this._handlers[e]=t,t._loader=this},removeHandler:function(e){delete this._handlers[e]},getHandler:function(e){return this._handlers[e]},load:function(e,t,i,s){var n=this._handlers[t];if(n){var r=e+t;if(void 0!==this._cache[r])i(null,this._cache[r]);else if(this._requests[r])this._requests[r].push(i);else{this._requests[r]=[i];var a=this,o=function(e,t){e?a._onFailure(r,e):n.load(t,function(e,i,o){if(a._requests[r])if(e)a._onFailure(r,e);else try{a._onSuccess(r,n.open(t.original,i,s),o)}catch(e){a._onFailure(r,e)}},s)},h=e.split("?")[0];this._app.enableBundles&&this._app.bundles.hasUrl(h)?this._app.bundles.canLoadUrl(h)?this._app.bundles.loadUrl(h,function(e,t){o(e,{load:t,original:h})}):o("Bundle for "+e+" not loaded yet"):o(null,{load:e,original:s&&s.getPreferredFile().filename||e})}}else i("No handler for asset type: "+t)},_onSuccess:function(e,t,i){this._cache[e]=t;for(var s=0;s<this._requests[e].length;s++)this._requests[e][s](null,t,i);delete this._requests[e]},_onFailure:function(e,t){if(console.error(t),this._requests[e]){for(var i=0;i<this._requests[e].length;i++)this._requests[e][i](t);delete this._requests[e]}},open:function(e,t){var i=this._handlers[e];return i?i.open(null,t):(console.warn("No resource handler found for: "+e),t)},patch:function(e,t){var i=this._handlers[e.type];i?i.patch&&i.patch(e,t):console.warn("No resource handler found for: "+e.type)},clearCache:function(e,t){delete this._cache[e+t]},getFromCache:function(e,t){if(this._cache[e+t])return this._cache[e+t]},enableRetry:function(){for(var e in this._handlers)this._handlers[e].retryRequests=!0},disableRetry:function(){for(var e in this._handlers)this._handlers[e].retryRequests=!1},destroy:function(){this._handlers={},this._requests={},this._cache={}}}),Object.assign(li.prototype,{load:function(e,t){"string"==typeof e&&(e={load:e,original:e});var i=this._app.assets;qr.get(e.load,{retry:this.retryRequests},function(s,n){s?(n="Error while loading scene "+e.original,s.message?(n+=": "+s.message,s.stack&&(n+="\n"+s.stack)):n+=": "+s,t(n)):xl.waitForTemplatesInScene(n,i,t)})},open:function(e,t){this._app.systems.script.preloading=!0,e=new Yt(this._app,!1).parse(t);var i=this._app.scene;return i.root=e,this._app.applySceneSettings(t.settings),this._app.systems.script.preloading=!1,i},patch:function(e,t){}}),Object.assign(ci.prototype,{load:function(e,t){"string"==typeof e&&(e={load:e,original:e}),qr.get(e.load,{retry:this.retryRequests},function(i,s){i?(s="Error while loading scene settings "+e.original,i.message?(s+=": "+i.message,i.stack&&(s+="\n"+i.stack)):s+=": "+i,t(s)):t(null,s)})},open:function(e,t){return t.settings}});var Il=!1,Ol=!1,Rl={app:null,create:function(e,t){if(Il){var i=t(Rl.app);i._pcScriptName=e,di._push(i),this.fire("created",e,t)}},attribute:function(e,t,i,s){},createLoadingScreen:function(e){Ol||(Ol=!0,e(Ln.getApplication()))}};Object.defineProperty(Rl,"legacy",{get:function(){return Il},set:function(e){Il=e}}),kr.attach(Rl),di._types=[],di._push=function(e){Rl.legacy&&0<di._types.length?console.assert("Script Ordering Error. Contact support@playcanvas.com"):di._types.push(e)},Object.assign(di.prototype,{load:function(e,t){"string"==typeof e&&(e={load:e,original:e});var i=this;Rl.app=this._app,this._loadScript(e.load,function(e,s,n){if(e)t(e);else if(Rl.legacy)e=null,di._types.length&&(e=di._types.pop()),e?this._scripts[s]=e:e=null,t(null,e,n);else{e={};for(var r=0;r<di._types.length;r++)e[di._types[r].name]=di._types[r];di._types.length=0,t(null,e,n),delete i._loader._cache[s+"script"]}}.bind(this))},open:function(e,t){return t},patch:function(e,t){},_loadScript:function(e,t){var i=document.head,s=document.createElement("script");this._cache[e]=s,s.async=!1,s.addEventListener("error",function(e){t("Script: "+e.target.src+" failed to load")},!1);var n=!1;s.onload=s.onreadystatechange=function(){n||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(n=!0,t(null,e,s))},s.src=e,i.appendChild(s)}}),Object.assign(ui.prototype,{load:function(e,t){"string"==typeof e&&(e={load:e,original:e}),qr.get(e.load,{retry:this.retryRequests},function(i,s){i?t("Error loading shader resource: "+e.original+" ["+i+"]"):t(null,s)})},open:function(e,t){return t},patch:function(e,t){}});var Dl=[0,0,1,0,0,1,0,0,1,0,0,1],Ll=[0,1,3,2,3,1];pi.prototype=Object.create(r.prototype),pi.prototype.constructor=pi,pi.prototype._createMeshes=function(){var e,t=0;for(e=this._meshes.length;t<e;t++){var i=this._meshes[t];if(i){i.vertexBuffer.destroy();for(var s=0,n=i.indexBuffer.length;s<n;s++)i.indexBuffer[s].destroy()}}for(e=this._frameKeys.length,this._meshes=Array(e),i=1===this.renderMode||2===this._renderMode?this._create9SliceMesh:this._createSimpleMesh,t=0;t<e;t++)s=this._atlas.frames[this._frameKeys[t]],this._meshes[t]=s?i.call(this,s):null;this.fire("set:meshes")},pi.prototype._createSimpleMesh=function(e){var t=e.rect,i=this._atlas.texture.width,s=this._atlas.texture.height,n=t.z/this._pixelsPerUnit,r=t.w/this._pixelsPerUnit,a=e.pivot.x;e=e.pivot.y;var o=t.x/i,h=t.y/s;return i=(t.x+t.z)/i,t=(t.y+t.w)/s,qe(this._device,[-a*n,-e*r,0,(1-a)*n,-e*r,0,(1-a)*n,(1-e)*r,0,-a*n,(1-e)*r,0],{uvs:[o,h,i,h,i,t,o,t],normals:Dl,indices:Ll})},pi.prototype._create9SliceMesh=function(){var e,t,i=T.ONE,s=[],n=[],r=[],a=[],o=0;for(e=0;3>=e;e++){var h=0===e||3===e?0:1;for(t=0;3>=t;t++){var l=-i.x+2*i.x*(1>=e?0:3)/3,c=-(-i.y+2*i.y*(1>=t?0:3)/3),d=0===t||3===t?0:1;s.push(-l,0,c),n.push(0,1,0),r.push(h,d),3>e&&3>t&&(a.push(o+3+1,o+1,o),a.push(o+3+1,o+3+2,o+1)),o++}}return qe(this._device,s,{normals:n,uvs:r,indices:a})},pi.prototype._onSetFrames=function(e){this._updatingProperties?this._meshesDirty=!0:this._createMeshes()},pi.prototype._onFrameChanged=function(e,t){0>(e=this._frameKeys.indexOf(e))||(t?0===this.renderMode&&(this._meshes[e]=this._createSimpleMesh(t)):this._meshes[e]=null,this.fire("set:meshes"))},pi.prototype._onFrameRemoved=function(e){0>(e=this._frameKeys.indexOf(e))||(this._meshes[e]=null,this.fire("set:meshes"))},pi.prototype.startUpdate=function(){this._updatingProperties=!0,this._meshesDirty=!1},pi.prototype.endUpdate=function(){this._updatingProperties=!1,this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes(),this._meshesDirty=!1},pi.prototype.destroy=function(){var e,t=0;for(e=this._meshes.length;t<e;t++){var i=this._meshes[t];if(i){i.vertexBuffer.destroy();for(var s=0,n=i.indexBuffer.length;s<n;s++)i.indexBuffer[s].destroy()}}this._meshes.length=0},Object.defineProperty(pi.prototype,"frameKeys",{get:function(){return this._frameKeys},set:function(e){this._frameKeys=e,this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:frameKeys",e)}}),Object.defineProperty(pi.prototype,"atlas",{get:function(){return this._atlas},set:function(e){e!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",this._onFrameRemoved,this)),(this._atlas=e)&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:atlas",e))}}),Object.defineProperty(pi.prototype,"pixelsPerUnit",{get:function(){return this._pixelsPerUnit},set:function(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this.fire("set:pixelsPerUnit",e),this._atlas&&this._frameKeys&&0===this.renderMode&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()))}}),Object.defineProperty(pi.prototype,"renderMode",{get:function(){return this._renderMode},set:function(e){if(this._renderMode!==e){var t=this._renderMode;this._renderMode=e,this.fire("set:renderMode",e),(0===t||0===e)&&this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes())}}}),Object.defineProperty(pi.prototype,"meshes",{get:function(){return this._meshes}}),Object.assign(fi.prototype,{load:function(e,t){"string"==typeof e&&(e={load:e,original:e}),".json"===zr.getExtension(e.original)&&qr.get(e.load,{retry:this.retryRequests},function(e,i){e?t(e):t(null,i)})},open:function(e,t){var i=new pi(this._device);return e&&(i.__data=t),i},patch:function(e,t){var i=e.resource;i.__data&&(e.data.pixelsPerUnit=i.__data.pixelsPerUnit,e.data.renderMode=i.__data.renderMode,e.data.frameKeys=i.__data.frameKeys,i.__data.textureAtlasAsset&&((t=t.getByUrl(i.__data.textureAtlasAsset))?e.data.textureAtlasAsset=t.id:console.warn("Could not find textureatlas with url: "+i.__data.textureAtlasAsset))),i.startUpdate(),i.renderMode=e.data.renderMode,i.pixelsPerUnit=e.data.pixelsPerUnit,i.frameKeys=e.data.frameKeys,this._updateAtlas(e),i.endUpdate(),e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this)},_updateAtlas:function(e){var t=e.resource;if(e.data.textureAtlasAsset){this._assets.off("load:"+e.data.textureAtlasAsset,mi,e),this._assets.on("load:"+e.data.textureAtlasAsset,mi,e);var i=this._assets.get(e.data.textureAtlasAsset);i&&i.resource?t.atlas=i.resource:i?this._assets.load(i):(this._assets.off("add:"+e.data.textureAtlasAsset,_i,e),this._assets.on("add:"+e.data.textureAtlasAsset,_i,e))}else t.atlas=null},_onAssetChange:function(e,t,i,s){"data"===t&&i&&i.textureAtlasAsset&&s&&i.textureAtlasAsset!==s.textureAtlasAsset&&(this._assets.off("load:"+s.textureAtlasAsset,mi,e),this._assets.off("add:"+s.textureAtlasAsset,_i,e))}}),gi.prototype.instantiate=function(){return this._templateRoot||this._parseTemplate(),this._templateRoot.clone()},gi.prototype.getExpandedData=function(){return this._expandedData.entities||(this._expandedData.entities=xl.expandTemplateEntities(this._app,this._data.entities)),this._expandedData},gi.prototype._parseTemplate=function(){this._templateRoot=new Yt(this._app,!0).parse(this.getExpandedData())},Object.assign(yi.prototype,{load:function(e,t){"string"==typeof e&&(e={load:e,original:e});var i=this._app.assets;qr.get(e.load,function(s,n){s?t("Error requesting template: "+e.original):xl.waitForTemplateAssets(n.entities,i,t,n)})},open:function(e,t){return new gi(this._app,t)}}),Object.assign(vi.prototype,{load:function(e,t){"string"==typeof e&&(e={load:e,original:e}),qr.get(e.load,{retry:this.retryRequests},function(i,s){i?t("Error loading text resource: "+e.original+" ["+i+"]"):t(null,s)})},open:function(e,t){return t},patch:function(e,t){}}),bi.prototype=Object.create(r.prototype),bi.prototype.constructor=bi,bi.prototype.setFrame=function(e,t){var i=this._frames[e];i?(i.rect.copy(t.rect),i.pivot.copy(t.pivot),i.border.copy(t.border)):(i={rect:t.rect.clone(),pivot:t.pivot.clone(),border:t.border.clone()},this._frames[e]=i),this.fire("set:frame",e.toString(),i)},bi.prototype.removeFrame=function(e){var t=this._frames[e];t&&(delete this._frames[e],this.fire("remove:frame",e.toString(),t))},bi.prototype.destroy=function(){this._texture&&this._texture.destroy()},Object.defineProperty(bi.prototype,"texture",{get:function(){return this._texture},set:function(e){this._texture=e,this.fire("set:texture",e)}}),Object.defineProperty(bi.prototype,"frames",{get:function(){return this._frames},set:function(e){this._frames=e,this.fire("set:frames",e)}});var Fl={repeat:0,clamp:1,mirror:2},Bl={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},Nl=/^data\.frames\.(\d+)$/;Object.assign(xi.prototype,{load:function(e,t){"string"==typeof e&&(e={load:e,original:e});var i=this,s=this._loader.getHandler("texture");if(".json"!==zr.getExtension(e.original))return s.load(e,t);qr.get(e.load,{retry:this.retryRequests},function(s,n){s?t(s):(s=e.original.replace(".json",".png"),i._loader.load(s,"texture",function(e,i){e?t(e):t(null,{data:n,texture:i})}))})},open:function(e,t){var i=new bi;if(t.texture&&t.data)i.texture=t.texture,i.__data=t.data;else{if(!(e=this._loader.getHandler("texture").open(e,t)))return null;i.texture=e}return i},patch:function(e,t){if(e.resource.__data&&(void 0!==e.resource.__data.minfilter&&(e.data.minfilter=e.resource.__data.minfilter),void 0!==e.resource.__data.magfilter&&(e.data.magfilter=e.resource.__data.magfilter),void 0!==e.resource.__data.addressu&&(e.data.addressu=e.resource.__data.addressu),void 0!==e.resource.__data.addressv&&(e.data.addressv=e.resource.__data.addressv),void 0!==e.resource.__data.mipmaps&&(e.data.mipmaps=e.resource.__data.mipmaps),void 0!==e.resource.__data.anisotropy&&(e.data.anisotropy=e.resource.__data.anisotropy),void 0!==e.resource.__data.rgbm&&(e.data.rgbm=!!e.resource.__data.rgbm),e.data.frames=e.resource.__data.frames,delete e.resource.__data),(t=e.resource.texture)&&(t.name=e.name,e.data.hasOwnProperty("minfilter")&&t.minFilter!==Bl[e.data.minfilter]&&(t.minFilter=Bl[e.data.minfilter]),e.data.hasOwnProperty("magfilter")&&t.magFilter!==Bl[e.data.magfilter]&&(t.magFilter=Bl[e.data.magfilter]),e.data.hasOwnProperty("addressu")&&t.addressU!==Fl[e.data.addressu]&&(t.addressU=Fl[e.data.addressu]),e.data.hasOwnProperty("addressv")&&t.addressV!==Fl[e.data.addressv]&&(t.addressV=Fl[e.data.addressv]),e.data.hasOwnProperty("mipmaps")&&t.mipmaps!==e.data.mipmaps&&(t.mipmaps=e.data.mipmaps),e.data.hasOwnProperty("anisotropy")&&t.anisotropy!==e.data.anisotropy&&(t.anisotropy=e.data.anisotropy),e.data.hasOwnProperty("rgbm"))){var i=e.data.rgbm?"rgbm":"default";t.type!==i&&(t.type=i)}for(var s in e.resource.texture=t,t={},e.data.frames)i=e.data.frames[s],t[s]={rect:new b(i.rect),pivot:new T(i.pivot),border:new b(i.border)};e.resource.frames=t,e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this)},_onAssetChange:function(e,t,i){if("data"===t||"data.frames"===t){var s={};for(n in i.frames)t=i.frames[n],s[n]={rect:new b(t.rect),pivot:new T(t.pivot),border:new b(t.border)};e.resource.frames=s}else if(t=t.match(Nl)){var n=t[1];i?(e.resource.frames[n]?((t=e.resource.frames[n]).rect.set(i.rect[0],i.rect[1],i.rect[2],i.rect[3]),t.pivot.set(i.pivot[0],i.pivot[1]),t.border.set(i.border[0],i.border[1],i.border[2],i.border[3])):e.resource.frames[n]={rect:new b(i.rect),pivot:new T(i.pivot),border:new b(i.border)},e.resource.fire("set:frame",n,e.resource.frames[n])):e.resource.frames[n]&&(delete e.resource.frames[n],e.resource.fire("remove:frame",n))}}}),Object.assign(Si.prototype,{load:function(e,t,i){pc.http.get(e.load,{cache:!0,responseType:"arraybuffer",retry:this.retryRequests},function(s,n){s?t(s,n):((s="pvr"===pc.basisTargetFormat()&&i&&i.file&&i.file.variants&&i.file.variants.basis&&0!=(8&i.file.variants.basis.opt))&&(i.file.variants.basis.opt&=-9),pc.basisTranscode(e.load,n,t,{unswizzleGGGR:s}))})},open:function(e,t,i){return(e=new K(i,{name:e,addressU:t.cubemap?1:0,addressV:t.cubemap?1:0,width:t.width,height:t.height,format:t.format,cubemap:t.cubemap,levels:t.levels})).upload(),e}}),Object.assign(Ti.prototype,{load:function(e,t,i){if(i&&i.options&&i.options.hasOwnProperty("crossOrigin"))var s=i.options.crossOrigin;else qh.test(e.load)&&(s=this.crossOrigin);this._loadImage(e.load,e.original,s,t)},open:function(e,t,i){var s=zr.getExtension(e).toLowerCase();return(e=new K(i,{name:e,width:t.width,height:t.height,format:".jpg"===s||".jpeg"===s?6:7})).setSource(t),e},_loadImage:function(e,t,i,s){var n=new Image;i&&(n.crossOrigin=i);var r,a=0,o=this.retryRequests;n.onload=function(){s(null,n)},n.onerror=function(){if(!r)if(o&&5>=++a){var i=100*Math.pow(2,a);console.log("Error loading Texture from: '"+t+"' - Retrying in "+i+"ms...");var h=0<=e.indexOf("?")?"&":"?";r=setTimeout(function(){n.src=e+h+"retry="+Date.now(),r=null},i)}else s("Error loading Texture from: '"+t+"'")},n.src=e}});var kl=[1481919403,3140563232,169478669],Ul={33776:8,33778:9,33779:10,36196:21,37492:22,37496:23,35840:26,35841:24,35842:27,35843:25};Object.assign(wi.prototype,{load:function(e,t,i){qr.get(e.load,{cache:!0,responseType:"arraybuffer",retry:this.retryRequests},t)},open:function(e,t,i){return(t=this.parse(t))?((e=new K(i,{name:e,addressU:t.cubemap?1:0,addressV:t.cubemap?1:0,width:t.width,height:t.height,format:t.format,cubemap:t.cubemap,levels:t.levels})).upload(),e):null},parse:function(e){var t=new Uint32Array(e,0,16);if(kl[0]!==t[0]||kl[1]!==t[1]||kl[2]!==t[2])return null;var i=t[6],s=t[7],n=t[9],r=t[10],a=t[12],o=t[13],h=t[14];if(1<t[11]||1<a||0!==i||!Ul[s])return null;t=64+t[15],i=[],a=!1;for(var l=0;l<(h||1);l++){var c=new Uint32Array(e.slice(t,t+4))[0];t+=4,c/=o||1,1<o&&(a=!0,i.push([]));for(var d=0;d<o;d++){var u=new Uint8Array(e,t,c);1<o?i[l].push(u):i.push(u),t+=c}t+=3-(t+3)%4}return{format:Ul[s],width:n,height:r,levels:i,cubemap:a}}}),Object.assign(Mi.prototype,{load:function(e,t,i){qr.get(e.load,{cache:!0,responseType:"arraybuffer",retry:this.retryRequests},t)},open:function(e,t,i){var s=new Uint32Array(t,0,32),n=s[4],r=s[3],a=Math.max(s[7],1),o=s[21],h=s[22],l=65024===s[28],c=!1,d=!1,u=!1,p=!1,f=!1,m=null;if(4===s[20]?827611204===o?(m=8,c=!0):894720068===o?(m=10,c=!0):116===o?(m=14,d=!0):826496069===o?(m=21,u=c=!0):825438800===o||825504336===o?(m=825438800===o?24:25,p=c=!0):825439312!==o&&825504848!==o||(m=825439312===o?26:27,f=c=!0):32===h&&(m=7),!m)return(e=new K(i,{width:4,height:4,format:6})).name="dds-legacy-empty",e;for(e=new K(i,{name:e,addressU:l?1:0,addressV:l?1:0,width:n,height:r,format:m,cubemap:l}),i=128,s=l?6:1,o=827611204===o?8:16,h=0;h<s;h++){m=n;for(var _=r,g=0;g<a;g++){if(c)if(u)var y=Math.floor((m+3)/4)*Math.floor((_+3)/4)*8;else if(p)y=Math.max(m,16)*Math.max(_,8)/4;else if(f)y=Math.max(m,8)*Math.max(_,8)/2;else{y=Math.floor((m+4-1)/4);var v=Math.floor((_+4-1)/4);y*=v,y*=o}else y=m*_*4;v=d?new Float32Array(t,i,y):new Uint8Array(t,i,y),l?(e._levels[g]||(e._levels[g]=[]),e._levels[g][h]=v):e._levels[g]=v,i+=d?4*y:y,m=Math.max(.5*m,1),_=Math.max(.5*_,1)}}return e.upload(),e}});var zl={repeat:0,clamp:1,mirror:2},Vl={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},Gl={default:"default",rgbm:"rgbm",rgbe:"rgbe",swizzleGGGR:"swizzleGGGR"};Object.assign(Pi.prototype,{load:function(e,t,i){throw Error("not implemented")},open:function(e,t,i){throw Error("not implemented")}});Object.defineProperties(Ai.prototype,{crossOrigin:{get:function(){return this.imgParser.crossOrigin},set:function(e){this.imgParser.crossOrigin=e}},retryRequests:{get:function(){return this.imgParser.retryRequests},set:function(e){for(var t in this.imgParser.retryRequests=e,this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].retryRequests=e)}}}),Object.assign(Ai.prototype,{_getUrlWithoutParams:function(e){return 0<=e.indexOf("?")?e.split("?")[0]:e},_getParser:function(e){return e=zr.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".",""),this.parsers[e]||this.imgParser},load:function(e,t,i){"string"==typeof e&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,i)},open:function(e,t,i){if(e)return null===(e=this._getParser(e).open(e,t,this._device))?e=new K(this._device,{width:4,height:4,format:6}):function(e){var t=Math.log2(Math.max(e._width,e._height))+1,i=function(e){return e instanceof HTMLCanvasElement||e instanceof HTMLImageElement||e instanceof HTMLVideoElement};if(!(7!==e._format&&14!==e._format||e._volume||e._compressed||1===e._levels.length||e._levels.length===t||i(e._cubemap?e._levels[0][0]:e._levels[0]))){i=function(e,t,i){for(var s=Math.max(1,e>>1),n=Math.max(1,t>>1),r=new i.constructor(s*n*4),a=Math.floor(e/s),o=a*(t=Math.floor(t/n)),h=0;h<n;++h)for(var l=0;l<s;++l)for(var c=0;4>c;++c){for(var d=0,u=0;u<t;++u)for(var p=0;p<a;++p)d+=i[4*(l*a+p+(h*t+u)*e)+c];r[4*(l+h*s)+c]=d/o}return r};for(var s=e._levels.length;s<t;++s){var n=Math.max(1,e._width>>s-1),r=Math.max(1,e._height>>s-1);if(e._cubemap){for(var a=[],o=0;6>o;++o)a.push(i(n,r,e._levels[s-1][o]));e._levels.push(a)}else e._levels.push(i(n,r,e._levels[s-1]))}e._levelsUpdated=e._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]}}(e),e},patch:function(e,t){if(t=e.resource){e.name&&0<e.name.length&&(t.name=e.name);var i=e.data;i.hasOwnProperty("minfilter")&&(t.minFilter=Vl[i.minfilter]),i.hasOwnProperty("magfilter")&&(t.magFilter=Vl[i.magfilter]),t.cubemap||(i.hasOwnProperty("addressu")&&(t.addressU=zl[i.addressu]),i.hasOwnProperty("addressv")&&(t.addressV=zl[i.addressv])),i.hasOwnProperty("mipmaps")&&(t.mipmaps=i.mipmaps),i.hasOwnProperty("anisotropy")&&(t.anisotropy=i.anisotropy),i.hasOwnProperty("flipY")&&(t.flipY=!!i.flipY),i.hasOwnProperty("type")?t.type=Gl[i.type]:i.hasOwnProperty("rgbm")&&i.rgbm?t.type="rgbm":e.file&&e.getPreferredFile&&(e=e.getPreferredFile())&&e.opt&&0!=(8&e.opt)&&(t.type="swizzleGGGR")}}}),Ei.prototype=Object.create(r.prototype),Ei.prototype.constructor=Ei,Object.assign(Ei.prototype,{list:function(e){return e=e||{},this._assets.filter(function(t){var i=!0;return void 0!==e.preload&&(i=t.preload===e.preload),i})},add:function(e){var t=this._assets.push(e)-1;if(this._cache[e.id]=t,this._names[e.name]||(this._names[e.name]=[]),this._names[e.name].push(t),e.file){var i=e.file.url;this._urls[i]=t}e.registry=this,this._tags.addItem(e),e.tags.on("add",this._onTagAdd,this),e.tags.on("remove",this._onTagRemove,this),this.fire("add",e),this.fire("add:"+e.id,e),i&&this.fire("add:url:"+i,e),e.preload&&this.load(e)},remove:function(e){var t=this._cache[e.id],i=e.file?e.file.url:null;if(void 0!==t){this._assets.splice(t,1),delete this._cache[e.id],this._names={},this._urls=[],t=0;for(var s=this._assets.length;t<s;t++){var n=this._assets[t];this._cache[n.id]=t,this._names[n.name]||(this._names[n.name]=[]),this._names[n.name].push(t),n.file&&(this._urls[n.file.url]=t)}return this._tags.removeItem(e),e.tags.off("add",this._onTagAdd,this),e.tags.off("remove",this._onTagRemove,this),e.fire("remove",e),this.fire("remove",e),this.fire("remove:"+e.id,e),i&&this.fire("remove:url:"+i,e),!0}return!1},get:function(e){return this._assets[this._cache[e]]},getByUrl:function(e){return this._assets[this._urls[e]]},load:function(e){if(!e.loading){var t=this;if(e.loaded)"cubemap"===e.type&&t._loader.patch(e,this);else{var i=e.getPreferredFile(),s=!!i,n=function(s){s instanceof Array?e.resources=s:e.resource=s,t._loader.patch(e,t),t.fire("load",e),t.fire("load:"+e.id,e),i&&i.url&&t.fire("load:url:"+i.url,e),e.fire("load",e)},r=function(){var i=t._loader.open(e.type,e.data);e.loaded=!0,n(i)};if(i&&"cubemap"===e.type){s=!1;var a=e.getFileUrl();this._loader.load(a,"texture",function(i,s){i?(t.fire("error",i,e),t.fire("error:"+e.id,i,e),e.fire("error",i,e)):(t._loader.patch({resource:s,type:"texture",data:e.data},t),e._dds=s,r())})}i?s&&(this.fire("load:start",e),this.fire("load:"+e.id+":start",e),function(){var i=e.getFileUrl();e.loading=!0,t._loader.load(i,e.type,function(i,s,r){e.loaded=!0,e.loading=!1,i?(t.fire("error",i,e),t.fire("error:"+e.id,i,e),e.fire("error",i,e)):(Rl.legacy||"script"!==e.type||((i=t._loader.getHandler("script"))._cache[e.id]&&i._cache[e.id].parentNode===document.head&&document.head.removeChild(i._cache[e.id]),i._cache[e.id]=r),n(s))},e)}()):r()}}},loadFromUrl:function(e,t,i){this.loadFromUrlAndFilename(e,null,t,i)},loadFromUrlAndFilename:function(e,t,i,s){var n=this,r=zr.getBasename(t||e);t={filename:t||r,url:e},(e=n.getByUrl(e))||(e=new Pt(r,i,t),n.add(e)),r=function(e){e.once("load",function(e){s(null,e)}),e.once("error",function(e){s(e)}),n.load(e)},e.resource?s(null,e):"model"===i?n._loadModel(e,r):r(e)},_loadModel:function(e,t){var i=this,s=e.getFileUrl(),n=zr.getExtension(s);if(".json"===n||".glb"===n){var r=zr.getDirectory(s);s=zr.getBasename(s),n=zr.join(r,s.replace(n,".mapping.json")),this._loader.load(n,"json",function(s,n){s?(e.data={mapping:[]},t(e)):i._loadMaterials(e,n,function(i,s){e.data=n,t(e)})})}else t(e)},_loadMaterials:function(e,t,i){for(var s=this,n=[],r=0,a=function(e,t){s._loadTextures(t,function(e,s){n.push(t),n.length===r&&i(null,n)})},o=0;o<t.mapping.length;o++){var h=t.mapping[o].path;h&&(r++,s.loadFromUrl(e.getAbsoluteUrl(h),"material",a))}0===r&&i(null,n)},_loadTextures:function(e,t){var i=[],s=0,n=e.data;if("path"!==n.mappingFormat)t(null,i);else{for(var r=function(e,n){e&&console.error(e),i.push(n),i.length===s&&t(null,i)},a=0;a<wl.length;a++){var o=n[wl[a]];o&&"string"==typeof o&&(s++,this.loadFromUrl(e.getAbsoluteUrl(o),"texture",r))}0===s&&t(null,i)}},findAll:function(e,t){var i=this;return(e=this._names[e])?(e=e.map(function(e){return i._assets[e]}),t?e.filter(function(e){return e.type===t}):e):[]},_onTagAdd:function(e,t){this._tags.add(e,t)},_onTagRemove:function(e,t){this._tags.remove(e,t)},findByTag:function(){return this._tags.find(arguments)},filter:function(e){for(var t=[],i=0,s=this._assets.length;i<s;i++)e(this._assets[i])&&t.push(this._assets[i]);return t},find:function(e,t){return(e=this.findAll(e,t))?e[0]:null}}),Object.assign(Ci.prototype,{_onAssetAdded:function(e){if("bundle"===e.type){this._bundleAssets[e.id]=e,this._registerBundleEventListeners(e.id);for(var t=0,i=e.data.assets.length;t<i;t++)this._indexAssetInBundle(e.data.assets[t],e)}else this._assetsInBundles[e.id]&&this._indexAssetFileUrls(e)},_registerBundleEventListeners:function(e){this._assets.on("load:"+e,this._onBundleLoaded,this),this._assets.on("error:"+e,this._onBundleError,this)},_unregisterBundleEventListeners:function(e){this._assets.off("load:"+e,this._onBundleLoaded,this),this._assets.off("error:"+e,this._onBundleError,this)},_indexAssetInBundle:function(e,t){if(this._assetsInBundles[e]){var i=this._assetsInBundles[e];-1===i.indexOf(t)&&i.push(t)}else this._assetsInBundles[e]=[t];(e=this._assets.get(e))&&this._indexAssetFileUrls(e)},_indexAssetFileUrls:function(e){var t=this._getAssetFileUrls(e);if(t)for(var i=0,s=t.length;i<s;i++)this._urlsInBundles[t[i]]=this._assetsInBundles[e.id]},_getAssetFileUrls:function(e){var t=e.getFileUrl();if(!t)return null;var i=[t=this._normalizeUrl(t)];if("font"===e.type){e=e.data.info.maps.length;for(var s=1;s<e;s++)i.push(t.replace(".png",s+".png"))}return i},_normalizeUrl:function(e){return e&&e.split("?")[0]},_onAssetRemoved:function(e){if("bundle"===e.type){var t;for(t in delete this._bundleAssets[e.id],this._unregisterBundleEventListeners(e.id),this._assetsInBundles){var i=this._assetsInBundles[t],s=i.indexOf(e);if(-1!==s&&(i.splice(s,1),!i.length))for(var n in delete this._assetsInBundles[t],this._urlsInBundles)this._urlsInBundles[n]===i&&delete this._urlsInBundles[n]}this._onBundleError("Bundle "+e.id+" was removed",e)}else if(this._assetsInBundles[e.id])for(delete this._assetsInBundles[e.id],s=0,t=(e=this._getAssetFileUrls(e)).length;s<t;s++)delete this._urlsInBundles[e[s]]},_onBundleLoaded:function(e){e.resource?requestAnimationFrame(function(){if(this._fileRequests)for(var t in this._fileRequests){var i=this._urlsInBundles[t];if(i&&-1!==i.indexOf(e)){i=decodeURIComponent(t);var s=null;e.resource.hasBlobUrl(i)||(s="Bundle "+e.id+" does not contain URL "+t);for(var n=this._fileRequests[t],r=0,a=n.length;r<a;r++)s?n[r](s):n[r](null,e.resource.getBlobUrl(i));delete this._fileRequests[t]}}}.bind(this)):this._onBundleError("Bundle "+e.id+" failed to load",e)},_onBundleError:function(e,t){for(var i in this._fileRequests)if(!this._findLoadedOrLoadingBundleForUrl(i)){for(var s=0,n=(t=this._fileRequests[i]).length;s<n;s++)t[s](e);delete this._fileRequests[i]}},_findLoadedOrLoadingBundleForUrl:function(e){if(!(e=this._urlsInBundles[e]))return null;var t,i=e.length;for(t=0;t<i;t++)if(e[t].loaded&&e[t].resource)return e[t];for(t=0;t<i;t++)if(e[t].loading)return e[t];return null},listBundlesForAsset:function(e){return this._assetsInBundles[e.id]||null},list:function(){var e,t=[];for(e in this._bundleAssets)t.push(this._bundleAssets[e]);return t},hasUrl:function(e){return!!this._urlsInBundles[e]},canLoadUrl:function(e){return!!this._findLoadedOrLoadingBundleForUrl(e)},loadUrl:function(e,t){var i=this._findLoadedOrLoadingBundleForUrl(e);if(i)if(i.loaded){var s=decodeURIComponent(e);i.resource.hasBlobUrl(s)?t(null,i.resource.getBlobUrl(s)):t("Bundle "+i.id+" does not contain URL "+e)}else this._fileRequests.hasOwnProperty(e)?this._fileRequests[e].push(t):this._fileRequests[e]=[t];else t("URL "+e+" not found in any bundles")},destroy:function(){for(var e in this._assets.off("add",this._onAssetAdded,this),this._assets.off("remove",this._onAssetRemoved,this),this._bundleAssets)this._unregisterBundleEventListeners(e);this._fileRequests=this._urlsInBundles=this._assetsInBundles=this._bundleAssets=this._assets=null}}),Ii.prototype=Object.create(r.prototype),Ii.prototype.constructor=Ii,Ii.prototype.destroy=function(){this.app=null,this.off()},Ii.prototype.add=function(e){var t=this,i=e.__name;return this._scripts.hasOwnProperty(i)?(setTimeout(function(){if(e.prototype.swap){var s=t._list.indexOf(t._scripts[i]);t._list[s]=e,t._scripts[i]=e,t.fire("swap",i,e),t.fire("swap:"+i,e)}else console.warn("script registry already has '"+i+"' script, define 'swap' method for new script type to enable code hot swapping")}),!1):(this._scripts[i]=e,this._list.push(e),this.fire("add",i,e),this.fire("add:"+i,e),setTimeout(function(){if(t._scripts.hasOwnProperty(i)&&t.app&&t.app.systems&&t.app.systems.script){var e=t.app.systems.script._components,s=[],n=[];for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){var r=e.items[e.loopIndex];if(r._scriptsIndex[i]&&r._scriptsIndex[i].awaiting){if(r._scriptsData&&r._scriptsData[i])var a=r._scriptsData[i].attributes;(r=r.create(i,{preloading:!0,ind:r._scriptsIndex[i].ind,attributes:a}))&&s.push(r)}}for(e=0;e<s.length;e++)s[e].__initializeAttributes();for(e=0;e<s.length;e++)s[e].enabled&&(s[e]._initialized=!0,n.push(s[e]),s[e].initialize&&s[e].initialize());for(e=0;e<n.length;e++)n[e].enabled&&!n[e]._postInitialized&&(n[e]._postInitialized=!0,n[e].postInitialize&&n[e].postInitialize())}}),!0)},Ii.prototype.remove=function(e){var t=e;if("string"!=typeof e?e=t.__name:t=this.get(e),this.get(e)!==t)return!1;delete this._scripts[e];var i=this._list.indexOf(t);return this._list.splice(i,1),this.fire("remove",e,t),this.fire("remove:"+e,t),!0},Ii.prototype.get=function(e){return this._scripts[e]||null},Ii.prototype.has=function(e){return"string"==typeof e?this._scripts.hasOwnProperty(e):!!e&&this._scripts[e.__name]===e},Ii.prototype.list=function(){return this._list};var jl="KEEP_ASPECT",Wl="FIXED";Oi.prototype=Object.create(r.prototype),Oi.prototype.constructor=Oi,Object.assign(Oi.prototype,{destroy:function(){window.removeEventListener("vrdisplaypresentchange",self._presentChange),this._camera&&(this._camera.vrDisplay=null),this._camera=null},poll:function(){if(this.display){this.display.getFrameData(this._frameData),this.leftProj.data=this._frameData.leftProjectionMatrix,this.rightProj.data=this._frameData.rightProjectionMatrix;var e=this.display.stageParameters;e?(this.sitToStandInv.set(e.sittingToStandingTransform).invert(),this.combinedView.set(this._frameData.leftViewMatrix),this.leftView.mul2(this.combinedView,this.sitToStandInv),this.combinedView.set(this._frameData.rightViewMatrix),this.rightView.mul2(this.combinedView,this.sitToStandInv)):(this.leftView.set(this._frameData.leftViewMatrix),this.rightView.set(this._frameData.rightViewMatrix));var t=this.leftProj.data[3]+this.leftProj.data[0],i=this.leftProj.data[11]+this.leftProj.data[8],s=1/Math.sqrt(t*t+i*i);e=-Math.atan2(i*s,t*s),t=this.rightProj.data[3]+this.rightProj.data[0],i=this.rightProj.data[11]+this.rightProj.data[8],s=1/Math.sqrt(t*t+i*i),e=Math.max(e,-Math.atan2(i*s,t*s)),this.combinedFov=e*=2,this.combinedAspect=t=this.rightProj.data[5]/this.rightProj.data[0],(i=this.combinedView).copy(this.leftView),i.invert(),this.leftViewInv.copy(i),(s=this.combinedPos).x=this.leftPos.x=i.data[12],s.y=this.leftPos.y=i.data[13],s.z=this.leftPos.z=i.data[14],i.copy(this.rightView),i.invert(),this.rightViewInv.copy(i);var n=s.x-i.data[12],r=s.y-i.data[13],a=s.z-i.data[14];n=Math.sqrt(n*n+r*r+a*a),this.rightPos.x=i.data[12],this.rightPos.y=i.data[13],this.rightPos.z=i.data[14],s.x+=i.data[12],s.y+=i.data[13],s.z+=i.data[14],s.x*=.5,s.y*=.5,s.z*=.5,n=.5*n*Math.sin(Math.PI-(.5*Math.PI+.5*e)),r=i.data[9],a=i.data[10],i.data[12]=s.x+i.data[8]*n,i.data[13]=s.y+r*n,i.data[14]=s.z+a*n,this.combinedViewInv.copy(i),i.invert(),this.combinedProj.setPerspective(e*Hr.RAD_TO_DEG,t,this.display.depthNear+n,this.display.depthFar+n,!0)}},requestPresent:function(e){this.display?this.presenting?e&&e(Error("VrDisplay already presenting")):this.display.requestPresent([{source:this._device.canvas}]).then(function(){e&&e()},function(t){e&&e(t)}):e&&e(Error("No VrDisplay to requestPresent"))},exitPresent:function(e){this.display||e&&e(Error("No VrDisplay to exitPresent")),this.presenting?this.display.exitPresent().then(function(){e&&e()},function(){e&&e(Error("exitPresent failed"))}):e&&e(Error("VrDisplay not presenting"))},requestAnimationFrame:function(e){this.display&&this.display.requestAnimationFrame(e)},submitFrame:function(){this.display&&this.display.submitFrame()},reset:function(){this.display&&this.display.resetPose()},setClipPlanes:function(e,t){this.display&&(this.display.depthNear=e,this.display.depthFar=t)},getFrameData:function(){if(this.display)return this._frameData}}),Object.defineProperty(Oi.prototype,"capabilities",{get:function(){return this.display?this.display.capabilities:{}}}),Ri.prototype=Object.create(r.prototype),Ri.prototype.constructor=Ri,Ri.isSupported="undefined"!=typeof navigator&&!!navigator.getVRDisplays,Object.assign(Ri.prototype,{_attach:function(){window.addEventListener("vrdisplayconnect",this._onDisplayConnect),window.addEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)},_detach:function(){window.removeEventListener("vrdisplayconnect",this._onDisplayConnect),window.removeEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)},destroy:function(){this._detach()},poll:function(){var e=this.displays.length;if(e)for(var t=0;t<e;t++)this.displays[t]._camera&&this.displays[t].poll()},_getDisplays:function(e){navigator.getVRDisplays?navigator.getVRDisplays().then(function(t){e&&e(null,t)}):e&&e(Error("WebVR not supported"))},_addDisplay:function(e){this._index[e.displayId]||(e=new Oi(this._app,e),this._index[e.id]=e,this.displays.push(e),this.display||(this.display=e),this.fire("displayconnect",e))},_onDisplayConnect:function(e){e.detail&&e.detail.display?this._addDisplay(e.detail.display):this._addDisplay(e.display)},_onDisplayDisconnect:function(e){if(e=this._index[e.detail&&e.detail.display?e.detail.display.displayId:e.display.displayId]){e.destroy(),delete this._index[e.id];var t=this.displays.indexOf(e);this.displays.splice(t,1),this.display===e&&(this.display=this.displays.length?this.displays[0]:null),this.fire("displaydisconnect",e)}}});var Hl="inline",Xl="immersive-vr",ql="immersive-ar",Yl=[],Kl=[];Di.prototype=Object.create(r.prototype),Di.prototype.constructor=Di,Di.prototype.remove=function(){if(this._xrHitTestSource){var e=this.manager.hitTest.sources,t=e.indexOf(this);-1!==t&&e.splice(t,1),this.onStop()}},Di.prototype.onStop=function(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this)},Di.prototype.update=function(e){if(this._transient){e=e.getHitTestResultsForTransientInput(this._xrHitTestSource);for(var t=0;t<e.length;t++){var i,s=e[t];s.inputSource&&(i=this.manager.input._getByInputSource(s.inputSource)),this.updateHitResults(s.results,i)}}else this.updateHitResults(e.getHitTestResults(this._xrHitTestSource))},Di.prototype.updateHitResults=function(e,t){for(var i=0;i<e.length;i++){var s=e[i].getPose(this.manager._referenceSpace),n=Yl.pop();n||(n=new v),n.copy(s.transform.position);var r=Kl.pop();r||(r=new S),r.copy(s.transform.orientation),this.fire("result",n,r,t),this.manager.hitTest.fire("result",this,n,r,t),Yl.push(n),Kl.push(r)}},Li.prototype=Object.create(r.prototype),Li.prototype.constructor=Li,Li.prototype._onSessionStart=function(){this.manager.type===ql&&(this._session=this.manager.session)},Li.prototype._onSessionEnd=function(){if(this._session){this._session=null;for(var e=0;e<this.sources.length;e++)this.sources[e].onStop();this.sources=[]}},Li.prototype.isAvailable=function(e,t){var i;return this._supported||(i=Error("XR HitTest is not supported")),this._session||(i=Error("XR Session is not started (1)")),this.manager.type!==ql&&(i=Error("XR HitTest is available only for AR")),!i||(e&&e(i),t&&t.fire("error",i),!1)},Li.prototype.start=function(e){var t=this;if(e=e||{},this.isAvailable(e.callback,this)){e.profile||e.spaceType||(e.spaceType="viewer");var i,s=e.offsetRay;s&&(i=new XRRay(new DOMPoint(s.origin.x,s.origin.y,s.origin.z),new DOMPoint(s.direction.x,s.direction.y,s.direction.z)));var n=e.callback;e.spaceType?this._session.requestReferenceSpace(e.spaceType).then(function(s){t._session?t._session.requestHitTestSource({space:s,entityTypes:e.entityTypes||void 0,offsetRay:i}).then(function(e){t._onHitTestSource(e,!1,n)}).catch(function(e){n&&n(e),t.fire("error",e)}):(s=Error("XR Session is not started (2)"),n&&n(s),t.fire("error",s))}).catch(function(e){n&&n(e),t.fire("error",e)}):this._session.requestHitTestSourceForTransientInput({profile:e.profile,entityTypes:e.entityTypes||void 0,offsetRay:i}).then(function(e){t._onHitTestSource(e,!0,n)}).catch(function(e){n&&n(e),t.fire("error",e)})}},Li.prototype._onHitTestSource=function(e,t,i){this._session?(e=new Di(this.manager,e,t),this.sources.push(e),i&&i(null,e),this.fire("add",e)):(e.cancel(),e=Error("XR Session is not started (3)"),i&&i(e),this.fire("error",e))},Li.prototype.update=function(e){for(var t=0;t<this.sources.length;t++)this.sources[t].update(e)},Object.defineProperty(Li.prototype,"supported",{get:function(){return this._supported}});var Zl=new S,$l=0;Fi.prototype=Object.create(r.prototype),Fi.prototype.constructor=Fi,Fi.prototype.update=function(e){var t=e.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);t&&(this._xrInputSource.gripSpace&&(e=e.getPose(this._xrInputSource.gripSpace,this._manager._referenceSpace))&&(this._grip||(this._grip=!0,this._localTransform=new x,this._worldTransform=new x,this._localPosition=new v,this._localRotation=new S),this._dirtyLocal=!0,this._localPosition.copy(e.transform.position),this._localRotation.copy(e.transform.orientation)),this._dirtyRay=!0,this._rayLocal.origin.copy(t.transform.position),this._rayLocal.direction.set(0,0,-1),Zl.copy(t.transform.orientation),Zl.transformVector(this._rayLocal.direction,this._rayLocal.direction))},Fi.prototype._updateTransforms=function(){if(this._dirtyLocal){var e=!0;this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,v.ONE)}var t=this._manager.camera.parent;t?(e=e||t._dirtyLocal||t._dirtyWorld)&&(e=this._manager.camera.parent.getWorldTransform(),this._worldTransform.mul2(e,this._localTransform)):this._worldTransform.copy(this._localTransform)},Fi.prototype._updateRayTransforms=function(){var e=this._dirtyRay;this._dirtyRay=!1;var t=this._manager.camera.parent;t?(e=e||t._dirtyLocal||t._dirtyWorld)&&((e=this._manager.camera.parent.getWorldTransform()).getTranslation(this._position),this._rotation.setFromMat4(e),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)):e&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))},Fi.prototype.getPosition=function(){return this._position?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null},Fi.prototype.getLocalPosition=function(){return this._localPosition},Fi.prototype.getRotation=function(){return this._rotation?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null},Fi.prototype.getLocalRotation=function(){return this._localRotation},Fi.prototype.getOrigin=function(){return this._updateRayTransforms(),this._ray.origin},Fi.prototype.getDirection=function(){return this._updateRayTransforms(),this._ray.direction},Fi.prototype.hitTestStart=function(e){var t=this;(e=e||{}).profile=this._xrInputSource.profiles[0];var i=e.callback;e.callback=function(e,s){s&&t.onHitTestSourceAdd(s),i&&i(e,s)},this._manager.hitTest.start(e)},Fi.prototype.onHitTestSourceAdd=function(e){this._hitTestSources.push(e),this.fire("hittest:add",e),e.on("result",function(t,i,s){s===this&&this.fire("hittest:result",e,t,i)},this),e.once("remove",function(){this.onHitTestSourceRemove(e),this.fire("hittest:remove",e)},this)},Fi.prototype.onHitTestSourceRemove=function(e){-1!==(e=this._hitTestSources.indexOf(e))&&this._hitTestSources.splice(e,1)},Object.defineProperty(Fi.prototype,"id",{get:function(){return this._id}}),Object.defineProperty(Fi.prototype,"inputSource",{get:function(){return this._xrInputSource}}),Object.defineProperty(Fi.prototype,"targetRayMode",{get:function(){return this._xrInputSource.targetRayMode}}),Object.defineProperty(Fi.prototype,"handedness",{get:function(){return this._xrInputSource.handedness}}),Object.defineProperty(Fi.prototype,"profiles",{get:function(){return this._xrInputSource.profiles}}),Object.defineProperty(Fi.prototype,"grip",{get:function(){return this._grip}}),Object.defineProperty(Fi.prototype,"gamepad",{get:function(){return this._xrInputSource.gamepad||null}}),Object.defineProperty(Fi.prototype,"selecting",{get:function(){return this._selecting}}),Object.defineProperty(Fi.prototype,"elementInput",{get:function(){return this._elementInput},set:function(e){this._elementInput!==e&&(this._elementInput=e,this._elementInput||(this._elementEntity=null))}}),Object.defineProperty(Fi.prototype,"elementEntity",{get:function(){return this._elementEntity}}),Object.defineProperty(Fi.prototype,"hitTestSources",{get:function(){return this._hitTestSources}}),Bi.prototype=Object.create(r.prototype),Bi.prototype.constructor=Bi,Bi.prototype._onSessionStart=function(){this._session=this.manager.session,this._session.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt);var e=this;this._session.addEventListener("select",function(t){var i=e._getByInputSource(t.inputSource);i.update(t.frame),i.fire("select",t),e.fire("select",i,t)}),this._session.addEventListener("selectstart",function(t){var i=e._getByInputSource(t.inputSource);i.update(t.frame),i._selecting=!0,i.fire("selectstart",t),e.fire("selectstart",i,t)}),this._session.addEventListener("selectend",function(t){var i=e._getByInputSource(t.inputSource);i.update(t.frame),i._selecting=!1,i.fire("selectend",t),e.fire("selectend",i,t)});for(var t=this._session.inputSources,i=0;i<t.length;i++)this._addInputSource(t[i])},Bi.prototype._onSessionEnd=function(){for(var e=this._inputSources.length;e--;){var t=this._inputSources[e];this._inputSources.splice(e,1),t.fire("remove"),this.fire("remove",t)}this._session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt),this._session=null},Bi.prototype._onInputSourcesChange=function(e){var t;for(t=0;t<e.removed.length;t++)this._removeInputSource(e.removed[t]);for(t=0;t<e.added.length;t++)this._addInputSource(e.added[t])},Bi.prototype._getByInputSource=function(e){for(var t=0;t<this._inputSources.length;t++)if(this._inputSources[t].inputSource===e)return this._inputSources[t];return null},Bi.prototype._addInputSource=function(e){this._getByInputSource(e)||(e=new Fi(this.manager,e),this._inputSources.push(e),this.fire("add",e))},Bi.prototype._removeInputSource=function(e){for(var t=0;t<this._inputSources.length;t++)if(this._inputSources[t].inputSource===e){for(e=this._inputSources[t],this._inputSources.splice(t,1),t=e.hitTestSources.length;t--;)e.hitTestSources[t].remove();e.fire("remove"),this.fire("remove",e);break}},Bi.prototype.update=function(e){for(var t=0;t<this._inputSources.length;t++)this._inputSources[t].update(e)},Object.defineProperty(Bi.prototype,"inputSources",{get:function(){return this._inputSources}});var Ql=new v,Jl=new v,ec=new x,tc=new x;Ni.prototype=Object.create(r.prototype),Ni.prototype.constructor=Ni,Ni.prototype._onSessionStart=function(){this._manager.session.requestLightProbe&&(this._supported=!0)},Ni.prototype._onSessionEnd=function(){this._lightProbeRequested=this._available=this._supported=!1,this._lightProbe=null},Ni.prototype.start=function(){var e;if(this._manager.session||(e=Error("XR session is not running")),e||this._manager.type===ql||(e=Error("XR session type is not AR")),e||this._supported||(e=Error("light-estimation is not supported")),(!e&&this._lightProbe||this._lightProbeRequested)&&(e=Error("light estimation is already requested")),e)this.fire("error",e);else{var t=this;this._lightProbeRequested=!0,this._manager.session.requestLightProbe().then(function(e){var i=t._lightProbeRequested;t._lightProbeRequested=!1,t._manager.active?i&&(t._lightProbe=e):t.fire("error",Error("XR session is not active"))}).catch(function(e){t._lightProbeRequested=!1,t.fire("error",e)})}},Ni.prototype.end=function(){this._lightProbeRequested=!1,this._lightProbe=null,this._available=!1},Ni.prototype.update=function(e){if(this._lightProbe&&(e=e.getLightEstimate(this._lightProbe))){this._available||(this._available=!0,this.fire("available"));var t=e.primaryLightIntensity;this._intensity=Math.max(1,Math.max(t.x,Math.max(t.y,t.z))),Ql.copy(t).scale(1/this._intensity),this._color.set(Ql.x,Ql.y,Ql.z),Ql.set(0,0,0),Jl.copy(e.primaryLightDirection),ec.setLookAt(Jl,Ql,v.UP),tc.setFromAxisAngle(v.RIGHT,90),ec.mul(tc),this._rotation.setFromMat4(ec),this._sphericalHarmonics.set(e.sphericalHarmonicsCoefficients)}},Object.defineProperty(Ni.prototype,"supported",{get:function(){return this._supported}}),Object.defineProperty(Ni.prototype,"available",{get:function(){return!!this._available}}),Object.defineProperty(Ni.prototype,"intensity",{get:function(){return this._available?this._intensity:null}}),Object.defineProperty(Ni.prototype,"color",{get:function(){return this._available?this._color:null}}),Object.defineProperty(Ni.prototype,"rotation",{get:function(){return this._available?this._rotation:null}}),Object.defineProperty(Ni.prototype,"sphericalHarmonics",{get:function(){return this._available?this._sphericalHarmonics:null}}),ki.prototype=Object.create(r.prototype),ki.prototype.constructor=ki,ki.prototype.start=function(e,t,i,s){if(this._available[t])if(this._session)s&&s(Error("XR session is already started"));else{var n=this;this._camera=e,this._camera.camera.xr=this,this._type=t,this._spaceType=i,this._setClipPlanes(e.nearClip,e.farClip),e=[],t===ql&&e.push("light-estimation"),navigator.xr.requestSession(t,{requiredFeatures:[i],optionalFeatures:e}).then(function(e){n._onSessionStart(e,i,s)}).catch(function(e){n._camera.camera.xr=null,n._camera=null,n._type=null,n._spaceType=null,s&&s(e),n.fire("error",e)})}else s&&s(Error("XR is not available"))},ki.prototype.end=function(e){this._session?(e&&this.once("end",e),this._session.end()):e&&e(Error("XR Session is not initialized"))},ki.prototype.isAvailable=function(e){return this._available[e]},ki.prototype._deviceAvailabilityCheck=function(){for(var e in this._available)this._sessionSupportCheck(e)},ki.prototype._sessionSupportCheck=function(e){var t=this;navigator.xr.isSessionSupported(e).then(function(i){t._available[e]!==i&&(t._available[e]=i,t.fire("available",e,i),t.fire("available:"+e,i))}).catch(function(e){t.fire("error",e)})},ki.prototype._onSessionStart=function(e,t,i){var s=this,n=!1;this._session=e;var r=function(){s.fire("visibility:change",e.visibilityState)},a=function(){s._setClipPlanes(s._camera.nearClip,s._camera.farClip)},o=function(){s._session=null,s._referenceSpace=null,s.views=[],s._width=0,s._height=0,s._type=null,s._spaceType=null,s._camera&&(s._camera.off("set_nearClip",a),s._camera.off("set_farClip",a),s._camera.camera.xr=null,s._camera=null),e.removeEventListener("end",o),e.removeEventListener("visibilitychange",r),n||s.fire("end"),s.app.tick()};e.addEventListener("end",o),e.addEventListener("visibilitychange",r),this._camera.on("set_nearClip",a),this._camera.on("set_farClip",a),this._baseLayer=new XRWebGLLayer(e,this.app.graphicsDevice.gl),e.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}),e.requestReferenceSpace(t).then(function(e){s._referenceSpace=e,s.app.tick(),i&&i(null),s.fire("start")}).catch(function(t){n=!0,e.end(),i&&i(t),s.fire("error",t)})},ki.prototype._setClipPlanes=function(e,t){this._depthNear===e&&this._depthFar===t||(this._depthNear=e,this._depthFar=t,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}))},ki.prototype.update=function(e){if(this._session){var t,i=e.session.renderState.baseLayer.framebufferWidth,s=e.session.renderState.baseLayer.framebufferHeight;this._width===i&&this._height===s||(this._width=i,this._height=s,this.app.graphicsDevice.setResolution(i,s));var n=(i=e.getViewerPose(this._referenceSpace))?i.views.length:0;if(n>this.views.length)for(s=0;s<=n-this.views.length;s++)(t=this.viewsPool.pop())||(t={viewport:new b,projMat:new x,viewMat:new x,viewOffMat:new x,viewInvMat:new x,viewInvOffMat:new x,projViewOffMat:new x,viewMat3:new y,position:new Float32Array(3),rotation:new S}),this.views.push(t);else if(n<=this.views.length)for(s=0;s<this.views.length-n;s++)this.viewsPool.push(this.views.pop());if(i){s=i.transform.position,t=i.transform.orientation,this._localPosition.set(s.x,s.y,s.z),this._localRotation.set(t.x,t.y,t.z,t.w);var r=e.session.renderState.baseLayer;for(s=0;s<i.views.length;s++){n=i.views[s],t=this.views[s];var a=r.getViewport(n);t.viewport.x=a.x,t.viewport.y=a.y,t.viewport.z=a.width,t.viewport.w=a.height,t.projMat.set(n.projectionMatrix),t.viewMat.set(n.transform.inverse.matrix),t.viewInvMat.set(n.transform.matrix)}}this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(e),this._type===ql&&(this.hitTest.supported&&this.hitTest.update(e),this.lightEstimation.supported&&this.lightEstimation.update(e)),this.fire("update")}},Object.defineProperty(ki.prototype,"supported",{get:function(){return this._supported}}),Object.defineProperty(ki.prototype,"active",{get:function(){return!!this._session}}),Object.defineProperty(ki.prototype,"type",{get:function(){return this._type}}),Object.defineProperty(ki.prototype,"spaceType",{get:function(){return this._spaceType}}),Object.defineProperty(ki.prototype,"session",{get:function(){return this._session}}),Object.defineProperty(ki.prototype,"visibilityState",{get:function(){return this._session?this._session.visibilityState:null}}),Object.defineProperty(ki.prototype,"camera",{get:function(){return this._camera?this._camera.entity:null}}),Ui.prototype=Object.create(r.prototype),Ui.prototype.constructor=Ui,Ui._buildAccessors=function(e,t){t.forEach(function(t){var i="object"==typeof t?t.name:t;Object.defineProperty(e,i,{get:function(){return this.data[i]},set:function(e){var t=this.data,s=t[i];t[i]=e,this.fire("set",i,s,e)},configurable:!0})}),e._accessorsBuilt=!0},Object.assign(Ui.prototype,{buildAccessors:function(e){Ui._buildAccessors(this,e)},onSetEnabled:function(e,t,i){t!==i&&this.entity.enabled&&(i?this.onEnable():this.onDisable())},onEnable:function(){},onDisable:function(){},onPostStateChange:function(){}}),Object.defineProperty(Ui.prototype,"data",{get:function(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}}),zi.prototype=Object.create(r.prototype),zi.prototype.constructor=zi,Object.assign(zi,{_helper:function(e,t){for(var i=0,s=e.length;i<s;i++)e[i].f.call(e[i].s,t)},initialize:function(e){this._helper(this._init,e)},postInitialize:function(e){this._helper(this._postInit,e),this.fire("postinitialize",e)},update:function(e,t){this._helper(t?this._toolsUpdate:this._update,e)},animationUpdate:function(e,t){this._helper(this._animationUpdate,e)},fixedUpdate:function(e,t){this._helper(this._fixedUpdate,e)},postUpdate:function(e,t){this._helper(this._postUpdate,e)},_init:[],_postInit:[],_toolsUpdate:[],_update:[],_animationUpdate:[],_fixedUpdate:[],_postUpdate:[],bind:function(e,t,i){switch(e){case"initialize":this._init.push({f:t,s:i});break;case"postInitialize":this._postInit.push({f:t,s:i});break;case"update":this._update.push({f:t,s:i});break;case"animationUpdate":this._animationUpdate.push({f:t,s:i});break;case"postUpdate":this._postUpdate.push({f:t,s:i});break;case"fixedUpdate":this._fixedUpdate.push({f:t,s:i});break;case"toolsUpdate":this._toolsUpdate.push({f:t,s:i});break;default:console.error("Component System does not support event",e)}},_erase:function(e,t,i){for(var s=0;s<e.length;s++)e[s].f===t&&e[s].s===i&&e.splice(s--,1)},unbind:function(e,t,i){switch(e){case"initialize":this._erase(this._init,t,i);break;case"postInitialize":this._erase(this._postInit,t,i);break;case"update":this._erase(this._update,t,i);break;case"animationUpdate":this._erase(this._animationUpdate,t,i);break;case"postUpdate":this._erase(this._postUpdate,t,i);break;case"fixedUpdate":this._erase(this._fixedUpdate,t,i);break;case"toolsUpdate":this._erase(this._toolsUpdate,t,i);break;default:console.error("Component System does not support event",e)}}}),Object.assign(zi.prototype,{addComponent:function(e,t){var i=new this.ComponentType(this,e),s=new this.DataType;return t=t||{},this.store[e.getGuid()]={entity:e,data:s},e[this.id]=i,e.c[this.id]=i,this.initializeComponentData(i,t,[]),this.fire("add",e,i),i},removeComponent:function(e){var t=this.store[e.getGuid()];this.fire("beforeremove",e,e.c[this.id]),delete this.store[e.getGuid()],delete e[this.id],delete e.c[this.id],this.fire("remove",e,t.data)},cloneComponent:function(e,t){return e=this.store[e.getGuid()],this.addComponent(t,e.data)},initializeComponentData:function(e,t,i){t=t||{};for(var s,n,r,a=0,o=i.length;a<o;a++)"object"==typeof(s=i[a])?(n=s.name,s=s.type):(n=s,s=void 0),void 0!==(r=t[n])?(void 0!==s&&(r=Vi(r,s)),e[n]=r):e[n]=e.data[n];e.enabled&&e.entity.enabled&&e.onEnable()},getPropertiesOfType:function(e){var t=[];return(this.schema||[]).forEach(function(i){i&&"object"==typeof i&&i.type===e&&t.push(i)}),t},destroy:function(){this.off()}}),kr.attach(zi),zi.destroy=function(){zi.off("initialize"),zi.off("postInitialize"),zi.off("toolsUpdate"),zi.off("update"),zi.off("animationUpdate"),zi.off("fixedUpdate"),zi.off("postUpdate")},Object.assign(Gi.prototype,{getTarget:function(){return this._targetNode},setTarget:function(e){this._targetNode=e}}),ji.prototype.addTime=function(e){if(null!==this._animation){var t=this._animation._nodes,i=this._animation.duration;if(this._time!==i||this.looping){if(this._time+=e,this._time>i)for(this._time=this.looping?0:i,i=0;i<t.length;i++){var s=t[i],n=s._name;this._currKeyIndices[n]=0}else if(0>this._time)for(this._time=this.looping?i:0,i=0;i<t.length;i++)n=(s=t[i])._name,this._currKeyIndices[n]=s._keys.length-2;for(e=0<=e?1:-1,i=0;i<t.length;i++){n=(s=t[i])._name,s=s._keys;var r=this._interpolatedKeyDict[n];if(void 0!==r){var a=!1;if(1!==s.length)for(var o=this._currKeyIndices[n];o<s.length-1&&0<=o;o+=e){var h=s[o],l=s[o+1];if(h.time<=this._time&&l.time>=this._time){a=(this._time-h.time)/(l.time-h.time),r._pos.lerp(h.position,l.position,a),r._quat.slerp(h.rotation,l.rotation,a),r._scale.lerp(h.scale,l.scale,a),r._written=!0,this._currKeyIndices[n]=o,a=!0;break}}(1===s.length||!a&&0===this._time&&this.looping)&&(r._pos.copy(s[0].position),r._quat.copy(s[0].rotation),r._scale.copy(s[0].scale),r._written=!0)}}}}},ji.prototype.blend=function(e,t,i){for(var s=this._interpolatedKeys.length,n=0;n<s;n++){var r=e._interpolatedKeys[n],a=t._interpolatedKeys[n],o=this._interpolatedKeys[n];r._written&&a._written?(o._quat.slerp(r._quat,t._interpolatedKeys[n]._quat,i),o._pos.lerp(r._pos,t._interpolatedKeys[n]._pos,i),o._scale.lerp(r._scale,a._scale,i),o._written=!0):r._written?(o._quat.copy(r._quat),o._pos.copy(r._pos),o._scale.copy(r._scale),o._written=!0):a._written&&(o._quat.copy(a._quat),o._pos.copy(a._pos),o._scale.copy(a._scale),o._written=!0)}},Object.defineProperty(ji.prototype,"animation",{get:function(){return this._animation},set:function(e){this._animation=e,this.currentTime=0}}),ji.prototype.getAnimation=function(){return this._animation},Object.defineProperty(ji.prototype,"currentTime",{get:function(){return this._time},set:function(e){this._time=e,e=this._interpolatedKeys.length;for(var t=0;t<e;t++)this._currKeyIndices[this._interpolatedKeys[t]._name]=0;this.addTime(0),this.updateGraph()}}),ji.prototype.getCurrentTime=function(){return this._time},ji.prototype.setCurrentTime=function(e){this.currentTime=e},Object.defineProperty(ji.prototype,"numNodes",{get:function(){return this._interpolatedKeys.length}}),ji.prototype.getNumNodes=function(){return this._interpolatedKeys.length},ji.prototype.setAnimation=function(e){this.animation=e},ji.prototype.setGraph=function(e){var t;if(this.graph=e)for(t=0;t<this._interpolatedKeys.length;t++){var i=e.findByName(this._interpolatedKeys[t]._name);this._interpolatedKeys[t].setTarget(i)}else for(t=0;t<this._interpolatedKeys.length;t++)this._interpolatedKeys[t].setTarget(null)},ji.prototype.updateGraph=function(){if(this.graph)for(var e=0;e<this._interpolatedKeys.length;e++){var t=this._interpolatedKeys[e];if(t._written){var i=t.getTarget();i.localPosition.copy(t._pos),i.localRotation.copy(t._quat),i.localScale.copy(t._scale),i._dirtyLocal||i._dirtifyLocal(),t._written=!1}}},ji.prototype.setLooping=function(e){this.looping=e},ji.prototype.getLooping=function(){return this.looping},Wi.prototype=Object.create(Ui.prototype),Wi.prototype.constructor=Wi,Object.assign(Wi.prototype,{play:function(e,t){if(this.enabled&&this.entity.enabled){var i=this.data;if(i.animations[e]){if(t=t||0,i.prevAnim=i.currAnim,i.currAnim=e,i.model){i.skeleton||i.animEvaluator||this._createAnimationController(),e=i.animations[i.prevAnim];var s=i.animations[i.currAnim];if(i.blending=0<t&&i.prevAnim,i.blending&&(i.blend=0,i.blendSpeed=1/t),i.skeleton&&(i.blending?(i.fromSkel.animation=e,i.fromSkel.addTime(i.skeleton._time),i.toSkel.animation=s):i.skeleton.animation=s),i.animEvaluator){if(t=i.animEvaluator,i.blending)for(;1<t.clips.length;)t.removeClip(0);else i.animEvaluator.removeClips();(t=new yt(i.animations[i.currAnim],0,1,!0,i.loop)).name=i.currAnim,t.blendWeight=i.blending?0:1,t.reset(),i.animEvaluator.addClip(t)}}i.playing=!0}}},getAnimation:function(e){return this.data.animations[e]},setModel:function(e){var t=this.data;e!==t.model&&(this._resetAnimationController(),t.model=e,t.animations&&t.currAnim&&t.animations[t.currAnim]&&this.play(t.currAnim))},_resetAnimationController:function(){var e=this.data;e.skeleton=null,e.fromSkel=null,e.toSkel=null,e.animEvaluator=null},_createAnimationController:function(){var e,t=this.data,i=t.model,s=t.animations,n=!1,r=!1;for(e in s)s.hasOwnProperty(e)&&(s[e].constructor===_t?r=!0:n=!0);i=i.getGraph(),n?(t.fromSkel=new ji(i),t.toSkel=new ji(i),t.skeleton=new ji(i),t.skeleton.looping=t.loop,t.skeleton.setGraph(i)):r&&(t.animEvaluator=new St(new xt(i)))},loadAnimationAssets:function(e){if(e&&e.length){var t,i=this,s=this.system.app.assets,n=e.length,r=function(e){if(1<e.resources.length)for(var t=0;t<e.resources.length;t++)i.animations[e.resources[t].name]=e.resources[t],i.animationsIndex[e.id]=e.resources[t].name;else i.animations[e.name]=e.resource,i.animationsIndex[e.id]=e.name;i.animations=i.animations},a=function(e){e.off("change",i.onAssetChanged,i),e.on("change",i.onAssetChanged,i),e.off("remove",i.onAssetRemoved,i),e.on("remove",i.onAssetRemoved,i),e.resource?r(e):(e.once("load",r,i),i.enabled&&i.entity.enabled&&s.load(e))};for(t=0;t<n;t++){var o=s.get(e[t]);o?a(o):s.on("add:"+e[t],a)}}},onAssetChanged:function(e,t,i,s){if("resource"===t||"resources"===t)if(i){if(1<i.length){if(s&&1<s.length)for(t=0;t<s.length;t++)delete this.animations[s[t].name];else delete this.animations[e.name];for(s=!1,t=0;t<i.length;t++)this.animations[i[t].name]=i[t],!s&&this.data.currAnim===i[t].name&&this.data.playing&&this.data.enabled&&this.entity.enabled&&(s=!0,this.play(i[t].name,0))}else{if(s&&1<s.length)for(t=0;t<s.length;t++)delete this.animations[s[t].name];this.animations[e.name]=i[0]||i,s=!1,this.data.currAnim===e.name&&this.data.playing&&this.data.enabled&&this.entity.enabled&&(s=!0,this.play(e.name,0))}s||(this._stopCurrentAnimation(),this.onSetAnimations()),this.animationsIndex[e.id]=e.name}else{if(1<s.length)for(t=0;t<s.length;t++)delete this.animations[s[t].name];else delete this.animations[e.name];delete this.animationsIndex[e.id]}},onAssetRemoved:function(e){if(e.off("remove",this.onAssetRemoved,this),this.animations){if(1<e.resources.length)for(var t=0;t<e.resources.length;t++)delete this.animations[e.resources[t].name],this.data.currAnim===e.resources[t].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.data.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id]}},_stopCurrentAnimation:function(){var e=this.data;e.currAnim=null,e.playing=!1,e.skeleton&&(e.skeleton.currentTime=0,e.skeleton.animation=null),e.animEvaluator&&e.animEvaluator.removeClips()},onSetAnimations:function(e,t,i){if(e=this.data,(t=this.entity.model)&&(t=t.model)&&t!==e.model&&this.setModel(t),!e.currAnim&&e.activate&&e.enabled&&this.entity.enabled)for(var s in e.animations){this.play(s,0);break}},onSetAssets:function(e,t,i){if(t&&t.length)for(e=0;e<t.length;e++)if(t[e]){var s=this.system.app.assets.get(t[e]);if(s){s.off("change",this.onAssetChanged,this),s.off("remove",this.onAssetRemoved,this);var n=this.animationsIndex[s.id];this.data.currAnim===n&&this._stopCurrentAnimation(),delete this.animations[n],delete this.animationsIndex[s.id]}}t=i.map(function(e){return e instanceof Pt?e.id:e}),this.loadAnimationAssets(t)},onSetLoop:function(e,t,i){if((e=this.data).skeleton&&(e.skeleton.looping=e.loop),e.animEvaluator)for(t=0;t<e.animEvaluator.clips.length;++t)e.animEvaluator.clips[t].loop=e.loop},onSetCurrentTime:function(e,t,i){if((e=this.data).skeleton&&((t=e.skeleton).currentTime=i,t.addTime(0),t.updateGraph()),e.animEvaluator)for(e=e.animEvaluator,t=0;t<e.clips.length;++t)e.clips[t].time=i},onEnable:function(){Ui.prototype.onEnable.call(this);var e=this.data,t=e.assets,i=this.system.app.assets;if(t)for(var s=0,n=t.length;s<n;s++){var r=t[s];r instanceof Pt||(r=i.get(r)),r&&!r.resource&&i.load(r)}if(e.activate&&!e.currAnim)for(var a in e.animations){this.play(a,0);break}},onBeforeRemove:function(){for(var e=0;e<this.assets.length;e++){var t=this.system.app.assets.get(this.assets[e]);t&&(t.off("change",this.onAssetChanged,this),t.off("remove",this.onAssetRemoved,this))}delete(e=this.data).animation,delete e.skeleton,delete e.fromSkel,delete e.toSkel,delete e.animEvaluator}}),Object.defineProperties(Wi.prototype,{currentTime:{get:function(){return this.data.skeleton._time},set:function(e){var t=this.data;if(t.skeleton){var i=t.skeleton;i.currentTime=e,i.addTime(0),i.updateGraph()}if(t.animEvaluator)for(t=t.animEvaluator,i=0;i<t.clips.length;++i)t.clips[i].time=e}},duration:{get:function(){return this.data.animations[this.data.currAnim].duration}}});var ic="enabled assets speed loop activate animations skeleton model prevAnim currAnim fromSkel toSkel blending blendTimeRemaining playing".split(" ");Xi.prototype=Object.create(zi.prototype),Xi.prototype.constructor=Xi,Ui._buildAccessors(Wi.prototype,ic),Object.assign(Xi.prototype,{initializeComponentData:function(e,t,i){i=["activate","enabled","loop","speed","assets"],zi.prototype.initializeComponentData.call(this,e,t,i)},cloneComponent:function(e,t){var i;this.addComponent(t,{}),t.animation.assets=e.animation.assets.slice(),t.animation.data.speed=e.animation.speed,t.animation.data.loop=e.animation.loop,t.animation.data.activate=e.animation.activate,t.animation.data.enabled=e.animation.enabled;var s={},n=e.animation.animations;for(i in n)n.hasOwnProperty(i)&&(s[i]=n[i]);for(i in t.animation.animations=s,s={},e=e.animation.animationsIndex)e.hasOwnProperty(i)&&(s[i]=e[i]);t.animation.animationsIndex=s},onBeforeRemove:function(e,t){t.onBeforeRemove()},onUpdate:function(e){var t,i=this.store;for(t in i)if(i.hasOwnProperty(t)){var s=i[t],n=s.data;if(n.enabled&&s.entity.enabled){if(n.blending&&(n.blend+=e*n.blendSpeed,1<=n.blend&&(n.blend=1)),n.playing&&(null!==(s=n.skeleton)&&null!==n.model&&(n.blending?s.blend(n.fromSkel,n.toSkel,n.blend):(s.addTime(e*n.speed),0<n.speed&&s._time===s._animation.duration&&!n.loop?n.playing=!1:0>n.speed&&0===s._time&&!n.loop&&(n.playing=!1)),n.blending&&1===n.blend&&(s.animation=n.toSkel._animation),s.updateGraph())),s=n.animEvaluator){for(var r=0;r<s.clips.length;++r){var a=s.clips[r];a.speed=n.speed,n.playing?a.resume():a.pause()}n.blending&&(s.clips[1].blendWeight=n.blend),s.update(e)}n.blending&&1===n.blend&&(n.blending=!1)}}}}),qi.prototype=Object.create(xt.prototype),qi.prototype.constructor=qi,Object.assign(qi.prototype,{resolve:function(e){var t=this.propertyLocator.decode(e);e=t[0];var i=t[1];t=t[2];var s=this._getEntityFromHierarchy(e);if(!s)return null;switch(i){case"entity":e=s;break;case"graph":e=this.nodes[e[0]].node;break;default:if(!(e=s.findComponent(i)))return null}return this._createAnimTargetForProperty(e,t)},update:function(e){if(e=this.activeNodes)for(var t=0;t<e.length;++t)e[t]._dirtifyLocal()},_getEntityFromHierarchy:function(e){if(!this.animComponent.entity.name===e[0])return null;var t=this.animComponent.entity;return 1===e.length?t:t._parent.findByPath(e.join("/"))},_floatSetter:function(e,t){return function(i){this._setProperty(e,t,i[0])}.bind(this)},_booleanSetter:function(e,t){return function(i){this._setProperty(e,t,!!i[0])}.bind(this)},_colorSetter:function(e,t){var i=["r","g","b","a"];return function(s){for(var n=0;n<s.length;n++)this._setProperty(e,t.concat(i[n]),s[n])}.bind(this)},_vecSetter:function(e,t){var i=["x","y","z","w"];return function(s){for(var n=0;n<s.length;n++)this._setProperty(e,t.concat(i[n]),s[n])}.bind(this)},_getProperty:function(e,t){return 1===t.length?e[t[0]]:e[t[0]][t[1]]},_setProperty:function(e,t,i){if(1===t.length)e[t[0]]=i;else{var s=e[t[0]];s[t[1]]=i,e[t[0]]=s}},_getEntityProperty:function(e){for(var t,i="localScale localPosition localRotation localEulerAngles position rotation eulerAngles".split(" "),s=0;s<i.length;s++)-1!==e.indexOf(i[s])&&(t=i[s]);return t},_createAnimTargetForProperty:function(e,t){if(this.handlers&&"weights"===t[0])return this.handlers.weights(e);var i=this._getProperty(e,t);if(void 0===i)return null;if("number"==typeof i)var s=this._floatSetter(e,t),n="vector",r=1;else if("boolean"==typeof i)s=this._booleanSetter(e,t),n="vector",r=1;else if("object"==typeof i)switch(i.constructor){case T:s=this._vecSetter(e,t),n="vector",r=2;break;case v:s=this._vecSetter(e,t),n="vector",r=3;break;case b:s=this._vecSetter(e,t),n="vector",r=4;break;case h:s=this._colorSetter(e,t),n="vector",r=4;break;case S:s=this._vecSetter(e,t),n="quaternion",r=4;break;default:return null}var a=this._getEntityProperty(t);return a?new vt(function(t){s(t),t="set"+a.substring(0,1).toUpperCase()+a.substring(1),e[t](this._getProperty(e,[a]))}.bind(this),n,r):-1!==t.indexOf("material")?new vt(function(t){s(t),e.material.update()},n,r):new vt(s,n,r)}}),Object.assign(Yi.prototype,{play:function(e){this._controller.play(e)},pause:function(){this._controller.pause()},reset:function(){this._controller.reset()},update:function(e){this._controller.update(e)},assignAnimation:function(e,t){this._controller.assignAnimation(e,t),this._component.activate&&this._component.playable&&(this._component.playing=!0)},removeNodeAnimations:function(e){this._controller.removeNodeAnimations(e)}}),Object.defineProperties(Yi.prototype,{name:{get:function(){return this._name}},playing:{get:function(){return this._controller.playing},set:function(e){this._controller.playing=e}},playable:{get:function(){return this._controller.playable}},activeState:{get:function(){return this._controller.activeStateName}},previousState:{get:function(){return this._controller.previousStateName}},activeStateProgress:{get:function(){return this._controller.activeStateProgress}},transitioning:{get:function(){return this._controller.transitioning}},transitionProgress:{get:function(){return this.transitioning?this._controller.transitionProgress:null}},states:{get:function(){return this._controller.states}}}),Object.defineProperties(Ki.prototype,{name:{get:function(){return this._name}},animations:{get:function(){return this._animations}},speed:{get:function(){return this._speed}},playable:{get:function(){return 0<this.animations.length||"START"===this.name||"END"===this.name}},looping:{get:function(){if(0<this.animations.length){var e=this._controller.animEvaluator.findClip(this.name+"."+this.animations[0].animTrack.name);if(e)return e.loop}return!1}},totalWeight:{get:function(){var e,t=0;for(e=0;e<this.animations.length;e++)t+=this.animations[e].weight;return t}},timelineDuration:{get:function(){var e,t=0;for(e=0;e<this.animations.length;e++){var i=this.animations[e];i.animTrack.duration>t&&(t=i.animTrack.duration>t)}return t}}}),Object.defineProperties(Zi.prototype,{from:{get:function(){return this._from}},to:{get:function(){return this._to}},time:{get:function(){return this._time}},priority:{get:function(){return this._priority}},conditions:{get:function(){return this._conditions}},exitTime:{get:function(){return this._exitTime}},transitionOffset:{get:function(){return this._transitionOffset}},interruptionSource:{get:function(){return this._interruptionSource}},hasExitTime:{get:function(){return!!this.exitTime}},hasConditionsMet:{get:function(){var e,t=!0;for(e=0;e<this.conditions.length;e++){var i=this.conditions[e],s=this._controller.findParameter(i.parameterName);switch(i.predicate){case"GREATER_THAN":t=t&&s.value>i.value;break;case"LESS_THAN":t=t&&s.value<i.value;break;case"GREATER_THAN_EQUAL_TO":t=t&&s.value>=i.value;break;case"LESS_THAN_EQUAL_TO":t=t&&s.value<=i.value;break;case"EQUAL_TO":t=t&&s.value===i.value;break;case"NOT_EQUAL_TO":t=t&&s.value!==i.value}if(!t)break}return t}}}),Object.defineProperties($i.prototype,{animEvaluator:{get:function(){return this._animEvaluator}},activeState:{get:function(){return this._findState(this._activeStateName)},set:function(e){this._activeStateName=e}},activeStateName:{get:function(){return this._activeStateName}},previousState:{get:function(){return this._findState(this._previousStateName)},set:function(e){this._previousStateName=e}},previousStateName:{get:function(){return this._previousStateName}},playable:{get:function(){var e,t=!0;for(e=0;e<this._stateNames.length;e++)this._states[this._stateNames[e]].playable||(t=!1);return t}},activeStateProgress:{get:function(){return this._getActiveStateProgressForTime(this._timeInState)}},transitioning:{get:function(){return this._isTransitioning}},transitionProgress:{get:function(){return this._currTransitionTime/this._totalTransitionTime}},states:{get:function(){return this._stateNames}}}),Object.assign($i.prototype,{_findState:function(e){return this._states[e]},_getActiveStateProgressForTime:function(e){if("START"===this.activeStateName||"END"===this.activeStateName)return 1;var t=this._animEvaluator.findClip(this.activeState.animations[0].name);return t?e/t.track.duration:null},_findTransitionsFromState:function(e){var t=this._findTransitionsFromStateCache[e];return t||((t=this._transitions.filter(function(t){return t.from===e})).sort(function(e,t){return e.priority<t.priority}),this._findTransitionsFromStateCache[e]=t),t},_findTransitionsBetweenStates:function(e,t){var i=this._findTransitionsBetweenStatesCache[e+"->"+t];return i||((i=this._transitions.filter(function(i){return i.from===e&&i.to===t})).sort(function(e,t){return e.priority<t.priority}),this._findTransitionsBetweenStatesCache[e+"->"+t]=i),i},_findTransition:function(e,t){var i=[];if(e&&t)i.concat(this._findTransitionsBetweenStates(this._activeStateName));else if(this._isTransitioning)switch(this._transitionInterruptionSource){case"PREV_STATE":i=i.concat(this._findTransitionsFromState(this._previousStateName));break;case"NEXT_STATE":i=i.concat(this._findTransitionsFromState(this._activeStateName));break;case"PREV_STATE_NEXT_STATE":i=(i=i.concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState(this._activeStateName));break;case"NEXT_STATE_PREV_STATE":i=(i=i.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState(this._previousStateName))}else i=i.concat(this._findTransitionsFromState(this._activeStateName));return 0<(i=i.filter(function(e){if(e.to===this.activeStateName)return!1;if(e.hasExitTime){var t=this._getActiveStateProgressForTime(this._timeInStateBefore),i=this._getActiveStateProgressForTime(this._timeInState);if(1>e.exitTime&&this.activeState.looping&&(t-=Math.floor(t),i-=Math.floor(i)),!(e.exitTime>t&&e.exitTime<=i))return null}return e.hasConditionsMet}.bind(this))).length?i[0]:null},_updateStateFromTransition:function(e){var t,i;for(this.previousState=e.from,this.activeState=e.to,t=0;t<e.conditions.length;t++){var s=this.findParameter(e.conditions[t].parameterName);"TRIGGER"===s.type&&(s.value=!1)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});var n=this._currTransitionTime/this._totalTransitionTime;for(t=0;t<this._transitionPreviousStates.length;t++){this._transitionPreviousStates[t].weight=t!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[t].weight*(1-n):n;var r=this._findState(this._transitionPreviousStates[t].name);for(i=0;i<r.animations.length;i++){var a=r.animations[i];(s=this._animEvaluator.findClip(a.name+".previous."+t))||((s=this._animEvaluator.findClip(a.name)).name=a.name+".previous."+t),s.pause()}}}for(0<e.time&&(this._isTransitioning=!0,this._totalTransitionTime=e.time,this._currTransitionTime=0,this._transitionInterruptionSource=e.interruptionSource),i=e.transitionOffset&&0<e.transitionOffset&&1>e.transitionOffset,r=this.activeState,t=0;t<r.animations.length;t++)(s=this._animEvaluator.findClip(r.animations[t].name))||((s=new yt(r.animations[t].animTrack,0,r.speed,!0,!0)).name=r.animations[t].name,this._animEvaluator.addClip(s)),s.blendWeight=0<e.time?0:1/r.totalWeight,s.reset(),i&&(s.time=r.timelineDuration*e.transitionOffset),s.play();s=t=0,i&&(s=t=e=r.timelineDuration*e.transitionOffset),this._timeInState=t,this._timeInStateBefore=s},_transitionToState:function(e){if(e!==this._activeStateName&&this._findState(e)){var t=this._findTransition(this._activeStateName,e);t||(this._animEvaluator.removeClips(),t=new Zi(this,null,e,0,0)),this._updateStateFromTransition(t)}},assignAnimation:function(e,t){var i=this._findState(e);i&&(e={name:e+"."+t.name,animTrack:t,weight:1},0<i.animations.length&&(i.animations=[],this.reset()),i.animations.push(e),!this._playing&&this._activate&&this.playable&&this.play())},removeNodeAnimations:function(e){(e=this._findState(e))&&(e.animations=[])},play:function(e){e&&this._transitionToState(e),this._playing=!0},pause:function(){this._playing=!1},reset:function(){this._previousStateName=null,this._activeStateName="START",this._playing=!1,this._totalTransitionTime=this._currTransitionTime=1,this._isTransitioning=!1,this._timeInStateBefore=this._timeInState=0,this._animEvaluator.removeClips()},update:function(e){if(this._playing){var t,i;if(this._timeInStateBefore=this._timeInState,this._timeInState+=e,(t=this._findTransition(this._activeStateName))&&this._updateStateFromTransition(t),this._isTransitioning){if(this._currTransitionTime<this._totalTransitionTime){var s=this._currTransitionTime/this._totalTransitionTime;for(t=0;t<this._transitionPreviousStates.length;t++){var n=this._findState(this._transitionPreviousStates[t].name),r=this._transitionPreviousStates[t].weight;for(i=0;i<n.animations.length;i++){var a=n.animations[i];this._animEvaluator.findClip(a.name+".previous."+t).blendWeight=(1-s)*a.weight/n.totalWeight*r}}for(n=this.activeState,t=0;t<n.animations.length;t++)a=n.animations[t],this._animEvaluator.findClip(a.name).blendWeight=s*a.weight/n.totalWeight}else{for(this._isTransitioning=!1,i=this.activeState.animations.length,n=this._animEvaluator.clips.length,t=0;t<n-i;t++)this._animEvaluator.removeClip(0);for(this._transitionPreviousStates=[],n=this.activeState,t=0;t<n.animations.length;t++)a=n.animations[t],this._animEvaluator.findClip(a.name).blendWeight=a.weight/n.totalWeight}this._currTransitionTime+=e}this._animEvaluator.update(e)}},findParameter:function(e){return this._parameters[e]}}),Qi.prototype=Object.create(Ui.prototype),Qi.prototype.constructor=Qi,Object.assign(Qi.prototype,{loadStateGraph:function(e){function t(e,t,s,r){var a=new qi(this,i);t=new $i(a=new St(a),t,s,n.parameters,n.activate),n.layers.push(new Yi(e,t,this)),n.layerIndices[e]=r}this.data.stateGraph=e;var i,s=this.entity.model;s&&(s=s.model)&&(i=s.getGraph());var n=this.data;for(n.parameters=e.parameters,s=0;s<e.layers.length;s++){var r=e.layers[s];t.bind(this)(r.name,r.states,r.transitions,s)}},removeStateGraph:function(){this.data.stateGraph=null,this.data.layers=[],this.data.layerIndices={},this.data.parameters={},this.data.playing=!1},reset:function(){this.data.parameters=Object.assign({},this.data.stateGraph.parameters);for(var e=0;e<this.data.layers.length;e++){var t=this.data.layers[e].playing;this.data.layers[e].reset(),this.data.layers[e].playing=t}},findAnimationLayer:function(e){return this.data.layers[this.data.layerIndices[e]]||null},assignAnimation:function(e,t,i){this.data.stateGraph&&(i=this.findAnimationLayer(i||"DEFAULT_LAYER"))&&i.assignAnimation(e,t)},removeNodeAnimations:function(e,t){(t=this.findAnimationLayer(t||"DEFAULT_LAYER"))&&t.removeNodeAnimations(e)},getParameterValue:function(e,t){if((e=this.data.parameters[e])&&e.type===t)return e.value},setParameterValue:function(e,t,i){(e=this.data.parameters[e])&&e.type===t&&(e.value=i)},getFloat:function(e){return this.getParameterValue(e,"FLOAT")},setFloat:function(e,t){this.setParameterValue(e,"FLOAT",t)},getInteger:function(e){return this.getParameterValue(e,"INTEGER")},setInteger:function(e,t){"number"==typeof t&&0==t%1&&this.setParameterValue(e,"INTEGER",t)},getBoolean:function(e){return this.getParameterValue(e,"BOOLEAN")},setBoolean:function(e,t){this.setParameterValue(e,"BOOLEAN",!!t)},getTrigger:function(e){return this.getParameterValue(e,"TRIGGER")},setTrigger:function(e){this.setParameterValue(e,"TRIGGER",!0)},resetTrigger:function(e){this.setParameterValue(e,"TRIGGER",!1)}}),Object.defineProperties(Qi.prototype,{stateGraphAsset:{get:function(){return this.data.stateGraphAsset},set:function(e){if(e instanceof Pt){var t=e.id,i=this.system.app.assets.get(t);i||(this.system.app.assets.add(e),i=this.system.app.assets.get(t))}else t=e,i=this.system.app.assets.get(t);i&&this.data.stateGraphAsset!==t&&(i.resource?(this.data.stateGraph=i.resource,this.loadStateGraph(this.data.stateGraph)):(i.on("load",function(e){this.data.stateGraph=e.resource,this.loadStateGraph(this.data.stateGraph)}.bind(this)),this.system.app.assets.load(i)),this.data.stateGraphAsset=t)}},playable:{get:function(){for(var e=0;e<this.data.layers.length;e++)if(!this.data.layers[e].playable)return!1;return!0}},baseLayer:{get:function(){return 0<this.data.layers.length?this.data.layers[0]:null}}});var sc=["enabled","speed","activate","playing"];es.prototype=Object.create(zi.prototype),es.prototype.constructor=es,Ui._buildAccessors(Qi.prototype,sc),Object.assign(es.prototype,{initializeComponentData:function(e,t,i){i=["activate","enabled","speed","playing"],zi.prototype.initializeComponentData.call(this,e,t,i)},onAnimationUpdate:function(e){var t,i=this.store;for(t in i)if(i.hasOwnProperty(t)){var s=i[t],n=s.data;if(n.enabled&&s.entity.enabled&&n.playing)for(s=0;s<n.layers.length;s++)n.layers[s].update(e*n.speed)}}}),ts.prototype=Object.create(Ui.prototype),ts.prototype.constructor=ts,Object.assign(ts.prototype,{setCurrentListener:function(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;var e=this.system.current.getPosition();this.system.manager.listener.setPosition(e)}},onEnable:function(){this.setCurrentListener()},onDisable:function(){this.system.current===this.entity&&(this.system.current=null)}});var nc=["enabled"];ss.prototype=Object.create(zi.prototype),ss.prototype.constructor=ss,Ui._buildAccessors(ts.prototype,nc),Object.assign(ss.prototype,{initializeComponentData:function(e,t,i){i=["enabled"],zi.prototype.initializeComponentData.call(this,e,t,i)},onUpdate:function(e){this.current&&(e=this.current.getPosition(),this.manager.listener.setPosition(e),e=this.current.getWorldTransform(),this.manager.listener.setOrientation(e))}}),ns.prototype=Object.create(Ui.prototype),ns.prototype.constructor=ns,Object.assign(ns.prototype,{play:function(e){if(this.enabled&&this.entity.enabled){this.channel&&this.stop();var t=this.data;if(t.sources[e]){if(t["3d"]){var i=this.entity.getPosition();i=this.system.manager.playSound3d(t.sources[e],i,t)}else i=this.system.manager.playSound(t.sources[e],t);t.currentSource=e,t.channel=i}}},pause:function(){this.channel&&this.channel.pause()},unpause:function(){this.channel&&this.channel.paused&&this.channel.unpause()},stop:function(){this.channel&&(this.channel.stop(),this.channel=null)},onSetAssets:function(e,t,i){e=[];var s,n=i.length;if(t&&t.length)for(s=0;s<t.length;s++)if(t[s]){var r=this.system.app.assets.get(t[s]);r&&(r.off("change",this.onAssetChanged,this),r.off("remove",this.onAssetRemoved,this),this.currentSource===r.name&&this.stop())}if(n)for(s=0;s<n;s++)0>t.indexOf(i[s])&&(i[s]instanceof Pt?e.push(i[s].id):e.push(i[s]));!this.system._inTools&&e.length&&this.loadAudioSourceAssets(e)},onAssetChanged:function(e,t,i,s){"resource"===t&&this.data.sources&&(this.data.sources[e.name]=i,this.data.currentSource===e.name&&this.channel&&(this.channel.paused?(this.play(e.name),this.pause()):this.play(e.name)))},onAssetRemoved:function(e){e.off("remove",this.onAssetRemoved,this),this.data.sources[e.name]&&(delete this.data.sources[e.name],this.data.currentSource===e.name&&(this.stop(),this.data.currentSource=null))},onSetLoop:function(e,t,i){t!=i&&this.channel&&this.channel.setLoop(i)},onSetVolume:function(e,t,i){t!=i&&this.channel&&this.channel.setVolume(i)},onSetPitch:function(e,t,i){t!=i&&this.channel&&this.channel.setPitch(i)},onSetMaxDistance:function(e,t,i){t!=i&&this.channel instanceof Uh&&this.channel.setMaxDistance(i)},onSetMinDistance:function(e,t,i){t!=i&&this.channel instanceof Uh&&this.channel.setMinDistance(i)},onSetRollOffFactor:function(e,t,i){t!=i&&this.channel instanceof Uh&&this.channel.setRollOffFactor(i)},onSetDistanceModel:function(e,t,i){t!==i&&this.channel instanceof Uh&&this.channel.setDistanceModel(i)},onSet3d:function(e,t,i){t!==i&&this.system.initialized&&this.currentSource&&(t=e=!1,this.channel&&(e=this.channel.paused,t=this.channel.suspended),this.play(this.currentSource),this.channel&&(this.channel.paused=e,this.channel.suspended=t))},onEnable:function(){var e=this.data.assets;if(e)for(var t=this.system.app.assets,i=0,s=e.length;i<s;i++){var n=e[i];n instanceof Pt||(n=t.get(n)),n&&!n.resource&&t.load(n)}this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):this.unpause())},onDisable:function(){this.pause()},loadAudioSourceAssets:function(e){var t=this,i=e.map(function(e){return this.system.app.assets.get(e)},this),s={},n=null,r=i.length,a=function(e){r--},o=function(){this.data.sources=s,this.data.currentSource=n,this.enabled&&this.activate&&n&&this.onEnable()}.bind(this);i.forEach(function(i,h){i?(n=n||i.name,i.off("change",this.onAssetChanged,this),i.on("change",this.onAssetChanged,this),i.off("remove",this.onAssetRemoved,this),i.on("remove",this.onAssetRemoved,this),i.off("error",a,this),i.on("error",a,this),i.ready(function(e){s[e.name]=e.resource,0===--r&&o()}),!i.resource&&t.enabled&&t.entity.enabled&&this.system.app.assets.load(i)):(0===--r&&o(),this.system.app.assets.on("add:"+e[h],function(e){e.ready(function(e){t.data.sources[e.name]=e.resource}),e.resource||t.system.app.assets.load(e)}))},this)}});var rc="enabled assets volume pitch loop activate 3d minDistance maxDistance rollOffFactor distanceModel sources currentSource channel".split(" ");as.prototype=Object.create(zi.prototype),as.prototype.constructor=as,Ui._buildAccessors(ns.prototype,rc),Object.assign(as.prototype,{initializeComponentData:function(e,t,i){i="activate volume pitch loop 3d minDistance maxDistance rollOffFactor distanceModel enabled assets".split(" "),zi.prototype.initializeComponentData.call(this,e,t,i),e.paused=!(e.enabled&&e.activate)},onInitialize:function(e){e.audiosource&&e.enabled&&e.audiosource.enabled&&e.audiosource.activate&&e.audiosource.play(e.audiosource.currentSource);var t,i=(e=e._children).length;for(t=0;t<i;t++)e[t]instanceof ut&&this.onInitialize(e[t]);this.initialized=!0},onUpdate:function(e){for(var t in e=this.store)if(e.hasOwnProperty(t)){var i=e[t],s=i.entity;(i=i.data).enabled&&s.enabled&&i.channel instanceof Uh&&(s=s.getPosition(),i.channel.setPosition(s))}},onRemove:function(e,t){t.channel&&(t.channel.stop(),t.channel=null)},setVolume:function(e){this.manager.setVolume(e)}}),Object.assign(os.prototype,{_configureEventListeners:function(e,t){e=this._parseEventListenerConfig(e,"external",this._parentComponent),t=this._parseEventListenerConfig(t,"internal",this),this._eventListenerConfigs=e.concat(t),this._listenerStatusFlags={},this._gainListeners={},this._loseListeners={}},_parseEventListenerConfig:function(e,t,i){return Object.keys(e).map(function(s,n){var r=s.split("#"),a=r[0],o=r[1],h=e[s];if(2!==r.length||"string"!=typeof a||0===a.length||"string"!=typeof o||0===o.length)throw Error("Invalid event listener description: `"+s+"`");if("function"!=typeof h)throw Error("Invalid or missing callback for event listener `"+s+"`");return{id:t+"_"+n+"_"+s,sourceName:a,eventName:o,callback:h,scope:i}},this)},_toggleLifecycleListeners:function(e){this._parentComponent[e]("set_"+this._entityPropertyName,this._onSetEntity,this),this._parentComponent.system[e]("beforeremove",this._onParentComponentRemove,this),zi[e]("postinitialize",this._onPostInitialize,this),this._app[e]("tools:sceneloaded",this._onSceneLoaded,this);for(var t=[],i=0;i<this._eventListenerConfigs.length;++i){var s=this._eventListenerConfigs[i],n=this._app.systems[s.sourceName];n&&(-1===t.indexOf(n)&&t.push(n),n&&"gain"===s.eventName&&(this._gainListeners[s.sourceName]=s),n&&"lose"===s.eventName&&(this._loseListeners[s.sourceName]=s))}for(i=0;i<t.length;++i)t[i][e]("add",this._onComponentAdd,this),t[i][e]("beforeremove",this._onComponentRemove,this)},_onSetEntity:function(e,t,i){i instanceof ut?this._updateEntityReference():null!=i&&"string"!=typeof i?console.warn("Entity field `"+this._entityPropertyName+"` was set to unexpected type '"+typeof i+"'"):t!==i&&this._updateEntityReference()},_onPostInitialize:function(){this._updateEntityReference()},onParentComponentEnable:function(){this._entity||this._updateEntityReference()},_onSceneLoaded:function(){this._updateEntityReference()},_updateEntityReference:function(){var e=this._parentComponent.data[this._entityPropertyName];if(e instanceof ut){var t=e;e=t.getGuid(),this._parentComponent.data[this._entityPropertyName]=e}else t=this._parentComponent.system.app.root,t=this._parentComponent.entity.isDescendantOf(t)&&e?t.findByGuid(e):null;this._entity!==t&&(this._entity&&this._onBeforeEntityChange(),(this._entity=t)&&this._onAfterEntityChange())},_onBeforeEntityChange:function(){this._toggleEntityListeners("off"),this._callAllGainOrLoseListeners(this._loseListeners)},_onAfterEntityChange:function(){this._toggleEntityListeners("on"),this._callAllGainOrLoseListeners(this._gainListeners)},_onComponentAdd:function(e,t){t=t.system.id,e===this._entity&&(this._callGainOrLoseListener(t,this._gainListeners),this._toggleComponentListeners("on",t))},_onComponentRemove:function(e,t){t=t.system.id,e===this._entity&&(this._callGainOrLoseListener(t,this._loseListeners),this._toggleComponentListeners("off",t,!0))},_callAllGainOrLoseListeners:function(e){for(var t in this._entity.c)this._callGainOrLoseListener(t,e)},_callGainOrLoseListener:function(e,t){this._entity.c.hasOwnProperty(e)&&t[e]&&(e=t[e]).callback.call(e.scope)},_toggleEntityListeners:function(e,t){if(this._entity)for(var i=0;i<this._eventListenerConfigs.length;++i)this._safeToggleListener(e,this._eventListenerConfigs[i],t)},_toggleComponentListeners:function(e,t,i){for(var s=0;s<this._eventListenerConfigs.length;++s){var n=this._eventListenerConfigs[s];n.sourceName===t&&this._safeToggleListener(e,n,i)}},_safeToggleListener:function(e,t,i){var s="on"===e;s&&this._listenerStatusFlags[t.id]||(i=this._getEventSource(t.sourceName,i))&&(i[e](t.eventName,t.callback,t.scope),this._listenerStatusFlags[t.id]=s)},_getEventSource:function(e,t){if("entity"===e)return this._entity;var i=this._entity[e];return i||(t||console.warn("Entity has no component with name "+e),null)},_onEntityDestroy:function(e){this._entity===e&&(this._toggleEntityListeners("off",!0),this._entity=null)},_onParentComponentRemove:function(e,t){t===this._parentComponent&&(this._toggleLifecycleListeners("off"),this._toggleEntityListeners("off",!0))},hasComponent:function(e){return!(!this._entity||!this._entity.c)&&!!this._entity.c[e]}}),Object.defineProperty(os.prototype,"entity",{get:function(){return this._entity}});var ac=0,oc={DEFAULT:"DEFAULT",HOVER:"HOVER",PRESSED:"PRESSED",INACTIVE:"INACTIVE"},hc={};hc[oc.DEFAULT]="_defaultTint",hc[oc.HOVER]="hoverTint",hc[oc.PRESSED]="pressedTint",hc[oc.INACTIVE]="inactiveTint";var lc={};lc[oc.DEFAULT]="_defaultSpriteAsset",lc[oc.HOVER]="hoverSpriteAsset",lc[oc.PRESSED]="pressedSpriteAsset",lc[oc.INACTIVE]="inactiveSpriteAsset";var cc={};cc[oc.DEFAULT]="_defaultSpriteFrame",cc[oc.HOVER]="hoverSpriteFrame",cc[oc.PRESSED]="pressedSpriteFrame",cc[oc.INACTIVE]="inactiveSpriteFrame",hs.prototype=Object.create(Ui.prototype),hs.prototype.constructor=hs,Object.assign(hs.prototype,{_toggleLifecycleListeners:function(e,t){this[e]("set_active",this._onSetActive,this),this[e]("set_transitionMode",this._onSetTransitionMode,this),this[e]("set_hoverTint",this._onSetTransitionValue,this),this[e]("set_pressedTint",this._onSetTransitionValue,this),this[e]("set_inactiveTint",this._onSetTransitionValue,this),this[e]("set_hoverSpriteAsset",this._onSetTransitionValue,this),this[e]("set_hoverSpriteFrame",this._onSetTransitionValue,this),this[e]("set_pressedSpriteAsset",this._onSetTransitionValue,this),this[e]("set_pressedSpriteFrame",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteAsset",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteFrame",this._onSetTransitionValue,this),t.app.systems.element[e]("add",this._onElementComponentAdd,this),t.app.systems.element[e]("beforeremove",this._onElementComponentRemove,this)},_onSetActive:function(e,t,i){t!==i&&this._updateVisualState()},_onSetTransitionMode:function(e,t,i){t!==i&&(this._cancelTween(),this._resetToDefaultVisualState(t),this._forceReapplyVisualState())},_onSetTransitionValue:function(e,t,i){t!==i&&this._forceReapplyVisualState()},_onElementComponentRemove:function(e){this.entity===e&&this._toggleHitElementListeners("off")},_onElementComponentAdd:function(e){this.entity===e&&this._toggleHitElementListeners("on")},_onImageElementLose:function(){this._cancelTween(),this._resetToDefaultVisualState(this.transitionMode)},_onImageElementGain:function(){this._storeDefaultVisualState(),this._forceReapplyVisualState()},_toggleHitElementListeners:function(e){if(this.entity.element){var t="on"===e;t&&this._hasHitElementListeners||(this.entity.element[e]("mouseenter",this._onMouseEnter,this),this.entity.element[e]("mouseleave",this._onMouseLeave,this),this.entity.element[e]("mousedown",this._onMouseDown,this),this.entity.element[e]("mouseup",this._onMouseUp,this),this.entity.element[e]("touchstart",this._onTouchStart,this),this.entity.element[e]("touchend",this._onTouchEnd,this),this.entity.element[e]("touchleave",this._onTouchLeave,this),this.entity.element[e]("touchcancel",this._onTouchCancel,this),this.entity.element[e]("selectstart",this._onSelectStart,this),this.entity.element[e]("selectend",this._onSelectEnd,this),this.entity.element[e]("selectenter",this._onSelectEnter,this),this.entity.element[e]("selectleave",this._onSelectLeave,this),this.entity.element[e]("click",this._onClick,this),this._hasHitElementListeners=t)}},_storeDefaultVisualState:function(){this._imageReference.hasComponent("element")&&(this._storeDefaultColor(this._imageReference.entity.element.color),this._storeDefaultOpacity(this._imageReference.entity.element.opacity),this._storeDefaultSpriteAsset(this._imageReference.entity.element.spriteAsset),this._storeDefaultSpriteFrame(this._imageReference.entity.element.spriteFrame))},_storeDefaultColor:function(e){this._defaultTint.r=e.r,this._defaultTint.g=e.g,this._defaultTint.b=e.b},_storeDefaultOpacity:function(e){this._defaultTint.a=e},_storeDefaultSpriteAsset:function(e){this._defaultSpriteAsset=e},_storeDefaultSpriteFrame:function(e){this._defaultSpriteFrame=e},_onSetColor:function(e){this._isApplyingTint||(this._storeDefaultColor(e),this._forceReapplyVisualState())},_onSetOpacity:function(e){this._isApplyingTint||(this._storeDefaultOpacity(e),this._forceReapplyVisualState())},_onSetSpriteAsset:function(e){this._isApplyingSprite||(this._storeDefaultSpriteAsset(e),this._forceReapplyVisualState())},_onSetSpriteFrame:function(e){this._isApplyingSprite||(this._storeDefaultSpriteFrame(e),this._forceReapplyVisualState())},_onMouseEnter:function(e){this._isHovering=!0,this._updateVisualState(),this._fireIfActive("mouseenter",e)},_onMouseLeave:function(e){this._isPressed=this._isHovering=!1,this._updateVisualState(),this._fireIfActive("mouseleave",e)},_onMouseDown:function(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("mousedown",e)},_onMouseUp:function(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseup",e)},_onTouchStart:function(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("touchstart",e)},_onTouchEnd:function(e){e.event.preventDefault(),this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchend",e)},_onTouchLeave:function(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchleave",e)},_onTouchCancel:function(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchcancel",e)},_onSelectStart:function(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("selectstart",e)},_onSelectEnd:function(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("selectend",e)},_onSelectEnter:function(e){this._hoveringCounter++,1===this._hoveringCounter&&(this._isHovering=!0,this._updateVisualState()),this._fireIfActive("selectenter",e)},_onSelectLeave:function(e){this._hoveringCounter--,0===this._hoveringCounter&&(this._isPressed=this._isHovering=!1,this._updateVisualState()),this._fireIfActive("selectleave",e)},_onClick:function(e){this._fireIfActive("click",e)},_fireIfActive:function(e,t){this.data.active&&this.fire(e,t)},_updateVisualState:function(e){var t=this._visualState,i=this._determineVisualState();if((t!==i||e)&&this.enabled)switch(this._visualState=i,t===oc.HOVER&&this._fireIfActive("hoverend"),t===oc.PRESSED&&this._fireIfActive("pressedend"),i===oc.HOVER&&this._fireIfActive("hoverstart"),i===oc.PRESSED&&this._fireIfActive("pressedstart"),this.transitionMode){case ac:this._applyTint(this[hc[this._visualState]]);break;case 1:this._applySprite(this[lc[this._visualState]],this[cc[this._visualState]])}},_forceReapplyVisualState:function(){this._updateVisualState(!0)},_resetToDefaultVisualState:function(e){if(this._imageReference.hasComponent("element"))switch(e){case ac:this._cancelTween(),this._applyTintImmediately(this._defaultTint);break;case 1:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame)}},_determineVisualState:function(){return this.active?this._isPressed?oc.PRESSED:this._isHovering?oc.HOVER:oc.DEFAULT:oc.INACTIVE},_applySprite:function(e,t){t=t||0,this._imageReference.hasComponent("element")&&(this._isApplyingSprite=!0,this._imageReference.entity.element.spriteAsset=e,this._imageReference.entity.element.spriteFrame=t,this._isApplyingSprite=!1)},_applyTint:function(e){this._cancelTween(),0===this.fadeDuration?this._applyTintImmediately(e):this._applyTintWithTween(e)},_applyTintImmediately:function(e){this._imageReference.hasComponent("element")&&e&&(this._isApplyingTint=!0,this._imageReference.entity.element.color=new h(e.r,e.g,e.b),this._imageReference.entity.element.opacity=e.a,this._isApplyingTint=!1)},_applyTintWithTween:function(e){if(this._imageReference.hasComponent("element")&&e){var t=this._imageReference.entity.element.color,i=this._imageReference.entity.element.opacity;this._tweenInfo={startTime:Xr(),from:new h(t.r,t.g,t.b,i),to:e.clone(),lerpColor:new h}}},_updateTintTween:function(){var e=Xr()-this._tweenInfo.startTime;if(e=0===this.fadeDuration?1:e/this.fadeDuration,e=Hr.clamp(e,0,1),1e-5<Math.abs(e-1)){var t=this._tweenInfo.lerpColor;t.lerp(this._tweenInfo.from,this._tweenInfo.to,e),this._applyTintImmediately(new h(t.r,t.g,t.b,t.a))}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween()},_cancelTween:function(){delete this._tweenInfo},onUpdate:function(){this._tweenInfo&&this._updateTintTween()},onEnable:function(){this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._imageReference.onParentComponentEnable(),this._toggleHitElementListeners("on"),this._forceReapplyVisualState()},onDisable:function(){this._toggleHitElementListeners("off"),this._resetToDefaultVisualState(this.transitionMode)},onRemove:function(){this._toggleLifecycleListeners("off",this.system),this.onDisable()}});var dc=["enabled","active",{name:"imageEntity",type:"entity"},{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"];cs.prototype=Object.create(zi.prototype),cs.prototype.constructor=cs,Ui._buildAccessors(hs.prototype,dc),Object.assign(cs.prototype,{initializeComponentData:function(e,t,i){zi.prototype.initializeComponentData.call(this,e,t,dc)},onUpdate:function(e){for(var t in e=this.store){var i=e[t].entity,s=i.button;s.enabled&&i.enabled&&s.onUpdate()}},_onRemoveComponent:function(e,t){t.onRemove()}});var uc,fc=function(e,t){Ui.call(this,e,t),this.on("set_aspectRatioMode",this.onSetAspectRatioMode,this),this.on("set_aspectRatio",this.onSetAspectRatio,this),this.on("set_camera",this.onSetCamera,this),this.on("set_clearColor",this.onSetClearColor,this),this.on("set_fov",this.onSetFov,this),this.on("set_orthoHeight",this.onSetOrthoHeight,this),this.on("set_nearClip",this.onSetNearClip,this),this.on("set_farClip",this.onSetFarClip,this),this.on("set_projection",this.onSetProjection,this),this.on("set_priority",this.onSetPriority,this),this.on("set_clearColorBuffer",this.updateClearFlags,this),this.on("set_clearDepthBuffer",this.updateClearFlags,this),this.on("set_clearStencilBuffer",this.updateClearFlags,this),this.on("set_renderTarget",this.onSetRenderTarget,this),this.on("set_rect",this.onSetRect,this),this.on("set_scissorRect",this.onSetScissorRect,this),this.on("set_horizontalFov",this.onSetHorizontalFov,this),this.on("set_frustumCulling",this.onSetFrustumCulling,this),this.on("set_calculateTransform",this.onSetCalculateTransform,this),this.on("set_calculateProjection",this.onSetCalculateProjection,this),this.on("set_cullFaces",this.onSetCullFaces,this),this.on("set_flipFaces",this.onSetFlipFaces,this),this.on("set_layers",this.onSetLayers,this)};(fc.prototype=Object.create(Ui.prototype)).constructor=fc,Object.defineProperty(fc.prototype,"projectionMatrix",{get:function(){return this.data.camera.getProjectionMatrix()}}),Object.defineProperty(fc.prototype,"viewMatrix",{get:function(){return this.data.camera.getViewMatrix()}}),Object.defineProperty(fc.prototype,"frustum",{get:function(){return this.data.camera.frustum}}),Object.defineProperty(fc.prototype,"vrDisplay",{get:function(){return this.data.camera.vrDisplay},set:function(e){(this.data.camera.vrDisplay=e)&&(e._camera=this.data.camera)}}),Object.defineProperty(fc.prototype,"node",{get:function(){return this.data.camera._node}}),Object.assign(fc.prototype,{screenToWorld:function(e,t,i,s){var n=this.system.app.graphicsDevice;return this.data.camera.screenToWorld(e,t,i,n.clientRect.width,n.clientRect.height,s)},onPrerender:function(){this.data.camera._viewMatDirty=!0,this.data.camera._viewProjMatDirty=!0},worldToScreen:function(e,t){var i=this.system.app.graphicsDevice;return this.data.camera.worldToScreen(e,i.clientRect.width,i.clientRect.height,t)},onSetAspectRatioMode:function(e,t,i){this.data.camera.aspectRatioMode=i},onSetAspectRatio:function(e,t,i){this.data.camera.aspectRatio=i},onSetCamera:function(e,t,i){t&&(t._node=null),i._node=this.entity},onSetClearColor:function(e,t,i){(e=this.data.camera.clearColor)[0]=i.r,e[1]=i.g,e[2]=i.b,e[3]=i.a},onSetFov:function(e,t,i){this.data.camera.fov=i},onSetOrthoHeight:function(e,t,i){this.data.camera.orthoHeight=i},onSetNearClip:function(e,t,i){this.data.camera.nearClip=i},onSetFarClip:function(e,t,i){this.data.camera.farClip=i},onSetHorizontalFov:function(e,t,i){this.data.camera.horizontalFov=i},onSetFrustumCulling:function(e,t,i){this.data.camera.frustumCulling=i},onSetCalculateTransform:function(e,t,i){this._calculateTransform=i,this.camera.overrideCalculateTransform=!!i},onSetCalculateProjection:function(e,t,i){this._calculateProjection=i,this.camera._projMatDirty=!0,this.camera.overrideCalculateProjection=!!i},onSetCullFaces:function(e,t,i){this.camera._cullFaces=i},onSetFlipFaces:function(e,t,i){this.camera._flipFaces=i},onSetProjection:function(e,t,i){this.data.camera.projection=i},onSetPriority:function(e,t,i){for(t=0;t<this.layers.length;t++)(e=this.system.app.scene.layers.getLayerById(this.layers[t]))&&e._sortCameras()},onSetLayers:function(e,t,i){var s;for(e=0;e<t.length;e++)(s=this.system.app.scene.layers.getLayerById(t[e]))&&s.removeCamera(this);if(this.enabled&&this.entity.enabled)for(e=0;e<i.length;e++)(s=this.system.app.scene.layers.getLayerById(i[e]))&&s.addCamera(this)},addCameraToLayers:function(){for(var e,t=0;t<this.layers.length;t++)(e=this.system.app.scene.layers.getLayerById(this.layers[t]))&&e.addCamera(this)},removeCameraFromLayers:function(){for(var e,t=0;t<this.layers.length;t++)(e=this.system.app.scene.layers.getLayerById(this.layers[t]))&&e.removeCamera(this)},onLayersChanged:function(e,t){this.addCameraToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(e){0>this.layers.indexOf(e.id)||e.addCamera(this)},onLayerRemoved:function(e){0>this.layers.indexOf(e.id)||e.removeCamera(this)},updateClearFlags:function(){var e=0;this.clearColorBuffer&&(e|=1),this.clearDepthBuffer&&(e|=2),this.clearStencilBuffer&&(e|=4),this.data.camera.clearFlags=e},onSetRenderTarget:function(e,t,i){this.data.camera.renderTarget=i},onSetRect:function(e,t,i){this.data.camera.setRect(i.x,i.y,i.z,i.w)},onSetScissorRect:function(e,t,i){this.data.camera.setScissorRect(i.x,i.y,i.z,i.w)},onEnable:function(){this.system.addCamera(this),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable()},onDisable:function(){this.postEffects.disable(),this.removeCameraFromLayers(),this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.system.removeCamera(this)},onRemove:function(){this.onDisable(),this.off()},calculateAspectRatio:function(e){e=e||this.system.app.graphicsDevice;var t=this.rect;return e.width*t.z/(e.height*t.w)},frameBegin:function(e){0===this.aspectRatioMode&&(this.aspectRatio=this.calculateAspectRatio(e)),this.data.isRendering=!0},frameEnd:function(){this.data.isRendering=!1},enterVr:function(e,t){if(e instanceof Function&&!t&&(t=e,e=null),this.system.app.vr)if(e||(e=this.system.app.vr.display),e){var i=this;e.capabilities.canPresent?e.requestPresent(function(s){s||(i.vrDisplay=e,i.vrDisplay.once("beforepresentchange",function(e){e.presenting||(i.vrDisplay=null)})),t(s)}):(i.vrDisplay=e,t())}else t("No pc.VrDisplay to present");else t("VrManager not created. Enable VR in project settings.")},exitVr:function(e){if(this.vrDisplay)if(this.vrDisplay.capabilities.canPresent){var t=this.vrDisplay;this.vrDisplay=null,t.exitPresent(e)}else this.vrDisplay=null,e();else e("Not presenting VR")},startXr:function(e,t,i){this.system.app.xr.start(this,e,t,i)},endXr:function(e){this.camera.xr?this.camera.xr.end(e):e&&e(Error("Camera is not in XR"))}}),Object.assign(us.prototype,{_createOffscreenTarget:function(e,t){var i=this.camera.rect,s=Math.floor(i.z*this.app.graphicsDevice.width*this.renderTargetScale);i=Math.floor(i.w*this.app.graphicsDevice.height*this.renderTargetScale);var n=this.app.graphicsDevice,r=t?n.getHdrFormat():7;t=this.app.graphicsDevice.supportsStencil;var a=e?n.samples:1;return(s=new K(n,{format:r,width:s,height:i})).name="posteffect #"+this.effects.length,s.minFilter=0,s.magFilter=0,s.addressU=1,s.addressV=1,new Bu(this.app.graphicsDevice,s,{depth:e,stencil:t,samples:a})},_resizeOffscreenTarget:function(e){var t=this.camera.rect,i=Math.floor(t.z*this.app.graphicsDevice.width*this.renderTargetScale);t=Math.floor(t.w*this.app.graphicsDevice.height*this.renderTargetScale);var s=this.app.graphicsDevice,n=e.colorBuffer.format;e._colorBuffer.destroy(),(i=new K(s,{format:n,width:i,height:t})).name="posteffect",i.minFilter=0,i.magFilter=0,i.addressU=1,i.addressV=1,e._colorBuffer=i,e.destroy()},_destroyOffscreenTarget:function(e){e._colorBuffer&&e._colorBuffer.destroy(),e._depthBuffer&&e._depthBuffer.destroy(),e.destroy()},setRenderTargetScale:function(e){this.renderTargetScale=e,this.resizeRenderTargets()},addEffect:function(e){var t=this.effects,i={effect:e,inputTarget:this._createOffscreenTarget(0===this.effects.length,e.hdr),outputTarget:null};if(!this.layer){this.layer=new Se({opaqueSortMode:0,transparentSortMode:0,passThrough:!0,name:"PostEffectQueue",renderTarget:this.camera.renderTarget,clear:!1,onPostRender:function(){for(var e=0;e<this._commandList.length;e++)this._commandList[e]()}});var s,n=this.app.scene.layers.layerList,r=0,a=n.length-1;for(s=a;0<=s;s--)if(4===n[s].id){a=s-1,this._origOverrideClear=n[s].overrideClear,this._origClearColorBuffer=n[s].clearColorBuffer,this._origDepthColorBuffer=n[s].clearDepthBuffer,this._origStencilColorBuffer=n[s].clearStencilBuffer,n[s].overrideClear=!0,n[s].clearColorBuffer=!1,n[s].clearDepthBuffer=this.camera.clearDepthBuffer,n[s].clearStencilBuffer=this.camera.clearStencilBuffer;break}for(this._sourceLayers=[],s=0;s<this.camera.layers.length;s++){n=this.camera.layers[s];var o=this.app.scene.layers.getLayerById(n),h=this.app.scene.layers.layerList.indexOf(o);h<=a&&(1!=n&&(o.renderTarget=i.inputTarget,this._sourceLayers.push(o)),h>r&&(r=h))}this.app.scene.layers.insertOpaque(this.layer,r+1),this._sourceTarget=i.inputTarget,this.layer._commandList=[],this.layer.isPostEffect=!0}t.push(i),1<(r=t.length)&&(t[r-2].outputTarget=i.inputTarget),this._newPostEffect=e,e.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0},removeEffect:function(e){var t,i=-1,s=0;for(t=this.effects.length;s<t;s++)if(this.effects[s].effect===e){i=s;break}if(0<=i){if(0<i)this.effects[i-1].outputTarget=i+1<this.effects.length?this.effects[i+1].inputTarget:null;else if(1<this.effects.length)for(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),s=0;s<this._sourceLayers.length;s++)this._sourceLayers[s].renderTarget=this.effects[1].inputTarget;this._destroyOffscreenTarget(this.effects[i].inputTarget),this.effects.splice(i,1)}this.enabled&&e.needsDepthBuffer&&this._releaseDepthMap(),0===this.effects.length&&this.disable()},_requestDepthMaps:function(){for(var e=0,t=this.effects.length;e<t;e++){var i=this.effects[e].effect;this._newPostEffect!==i&&i.needsDepthBuffer&&this._requestDepthMap()}},_releaseDepthMaps:function(){for(var e=0,t=this.effects.length;e<t;e++)this.effects[e].effect.needsDepthBuffer&&this._releaseDepthMap()},_requestDepthMap:function(){uc||(uc=this.app.scene.layers.getLayerById(1)),uc&&uc.incrementCounter()},_releaseDepthMap:function(){uc&&uc.decrementCounter()},destroy:function(){for(var e=0,t=this.effects.length;e<t;e++)this.effects[e].inputTarget.destroy();this.effects.length=0,this.disable()},enable:function(){if(!this.enabled&&this.effects.length){this.enabled=!0;var e=this;this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.command=function(){if(e.enabled){var t=null,i=e.effects.length;if(i){e.layer.renderTarget=e.effects[0].inputTarget;for(var s=0;s<i;s++){var n=e.effects[s];s===i-1&&(t=e.camera.rect),n.effect.render(n.inputTarget,n.outputTarget,t)}}}},this.layer._commandList.push(this.command)}},disable:function(){if(this.enabled){this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget);var e=this.layer._commandList.indexOf(this.command);0<=e&&this.layer._commandList.splice(e,1);var t=this.app.scene.layers.layerList,i=t.length-1;for(e=0;e<=t.length;e++)if(4===t[e].id){i=e-1,t[e].overrideClear=this._origOverrideClear,t[e].clearColorBuffer=this._origClearColorBuffer,t[e].clearDepthBuffer=this._origDepthColorBuffer,t[e].clearStencilBuffer=this._origStencilColorBuffer;break}for(e=i;0<=e;e--)0<=t[e].cameras.indexOf(this.camera)&&(t[e].renderTarget=void 0);this.app.scene.layers.removeOpaque(this.layer),this.layer=null}},_onCanvasResized:function(e,t){e=this.camera.rect,t=this.app.graphicsDevice,this.camera.camera.aspectRatio=t.width*e.z/(t.height*e.w),this.resizeTimeout||(100<Xr()-this.resizeLast?this.resizeRenderTargets():this.resizeTimeout=setTimeout(this._resizeTimeoutCallback,100))},resizeRenderTargets:function(){this.resizeTimeout&&(clearTimeout(this.resizeTimeout),this.resizeTimeout=null),this.resizeLast=Xr();var e=this.camera.rect,t=Math.floor(e.z*this.app.graphicsDevice.width*this.renderTargetScale);e=Math.floor(e.w*this.app.graphicsDevice.height*this.renderTargetScale);for(var i=this.effects,s=0,n=i.length;s<n;s++){var r=i[s];r.inputTarget.width===t&&r.inputTarget.height===e||this._resizeOffscreenTarget(r.inputTarget)}},onCameraRectChanged:function(e,t,i){this.enabled&&this.resizeRenderTargets()}});var mc="enabled clearColorBuffer clearColor clearDepthBuffer clearStencilBuffer frustumCulling projection fov orthoHeight nearClip farClip priority rect scissorRect camera aspectRatio aspectRatioMode horizontalFov model renderTarget calculateTransform calculateProjection cullFaces flipFaces layers".split(" "),_c=function(e){zi.call(this,e),this.id="camera",this.description="Renders the scene from the location of the Entity.",this.ComponentType=fc,this.DataType=ds,this.schema=mc,this.cameras=[],this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this),this.app.on("prerender",this.onPrerender,this),zi.bind("update",this.onUpdate,this)};_c.prototype=Object.create(zi.prototype),_c.prototype.constructor=_c,Ui._buildAccessors(fc.prototype,mc),Object.assign(_c.prototype,{initializeComponentData:function(e,t,s){for(var n={},r=0,a=(s="postEffects enabled model camera aspectRatio aspectRatioMode horizontalFov renderTarget clearColor fov orthoHeight nearClip farClip projection priority clearColorBuffer clearDepthBuffer clearStencilBuffer frustumCulling rect scissorRect calculateTransform calculateProjection cullFaces flipFaces layers".split(" ")).length;r<a;r++){var o=s[r];n[o]=t[o]}n.layers&&"array"===i(n.layers)&&(n.layers=n.layers.slice(0)),n.clearColor&&"array"===i(n.clearColor)&&(t=n.clearColor,n.clearColor=new h(t[0],t[1],t[2],t[3])),n.rect&&"array"===i(n.rect)&&(t=n.rect,n.rect=new b(t[0],t[1],t[2],t[3])),n.scissorRect&&"array"===i(n.scissorRect)&&(t=n.scissorRect,n.scissorRect=new b(t[0],t[1],t[2],t[3])),n.activate&&(console.warn("WARNING: activate: Property is deprecated. Set enabled property instead."),n.enabled=n.activate),n.camera=new _e,n._node=e.entity,n.camera._component=e,n.camera.calculateTransform=function(t,i){return e._calculateTransform?e._calculateTransform(t,i):null},n.camera.calculateProjection=function(t,i){return e._calculateProjection?e._calculateProjection(t,i):null},n.postEffects=new us(this.app,e),zi.prototype.initializeComponentData.call(this,e,n,s)},onBeforeRemove:function(e,t){this.removeCamera(t),t.onRemove()},onRemove:function(e,t){t.camera=null},onUpdate:function(e){if(e=this.store,this.app.vr)for(var t in e){var i=e[t],s=i.data,n=s.camera,r=n.vrDisplay;s.enabled&&i.entity.enabled&&r&&(r.setClipPlanes(n._nearClip,n._farClip),n._node&&(n._node.localTransform.copy(r.combinedViewInv),n._node._dirtyLocal=!1,n._node._dirtifyWorld()))}},onPrerender:function(){for(var e=0,t=this.cameras.length;e<t;e++)this.cameras[e].onPrerender()},addCamera:function(e){this.cameras.push(e),this.sortCamerasByPriority()},removeCamera:function(e){0<=(e=this.cameras.indexOf(e))&&(this.cameras.splice(e,1),this.sortCamerasByPriority())},sortCamerasByPriority:function(){this.cameras.sort(function(e,t){return e.priority-t.priority})}});var gc=function(e,t){Ui.call(this,e,t),this._compoundParent=null,this.entity.on("insert",this._onInsert,this),this.on("set_type",this.onSetType,this),this.on("set_halfExtents",this.onSetHalfExtents,this),this.on("set_radius",this.onSetRadius,this),this.on("set_height",this.onSetHeight,this),this.on("set_axis",this.onSetAxis,this),this.on("set_asset",this.onSetAsset,this),this.on("set_model",this.onSetModel,this)};(gc.prototype=Object.create(Ui.prototype)).constructor=gc,Object.assign(gc.prototype,{onSetType:function(e,t,i){t!==i&&this.system.changeType(this,t,i)},onSetHalfExtents:function(e,t,i){e=this.data.type,this.data.initialized&&"box"===e&&this.system.recreatePhysicalShapes(this)},onSetRadius:function(e,t,i){e=this.data.type,!this.data.initialized||"sphere"!==e&&"capsule"!==e&&"cylinder"!==e&&"cone"!==e||this.system.recreatePhysicalShapes(this)},onSetHeight:function(e,t,i){e=this.data.type,!this.data.initialized||"capsule"!==e&&"cylinder"!==e&&"cone"!==e||this.system.recreatePhysicalShapes(this)},onSetAxis:function(e,t,i){e=this.data.type,!this.data.initialized||"capsule"!==e&&"cylinder"!==e&&"cone"!==e||this.system.recreatePhysicalShapes(this)},onSetAsset:function(e,t,i){e=this.system.app.assets,t&&(t=e.get(t))&&t.off("remove",this.onAssetRemoved,this),i&&(i instanceof Pt&&(this.data.asset=i.id),t=e.get(this.data.asset))&&(t.off("remove",this.onAssetRemoved,this),t.on("remove",this.onAssetRemoved,this)),this.data.initialized&&"mesh"===this.data.type&&(i||(this.data.model=null),this.system.recreatePhysicalShapes(this))},onSetModel:function(e,t,i){this.data.initialized&&"mesh"===this.data.type&&this.system.implementations.mesh.doRecreatePhysicalShape(this)},onAssetRemoved:function(e){e.off("remove",this.onAssetRemoved,this),this.data.asset===e.id&&(this.asset=null)},_getCompoundChildShapeIndex:function(e){for(var t=this.data.shape,i=t.getNumChildShapes(),s=0;s<i;s++)if(t.getChildShape(s).ptr===e.ptr)return s;return null},_onInsert:function(e){if("undefined"!=typeof Ammo)if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody)for(e=this.entity.parent;e;){if(e.collision&&"compound"===e.collision.type){0===e.collision.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(e.collision):this.system.recreatePhysicalShapes(this);break}e=e.parent}},_updateCompound:function(){var e=this.entity;if(e._dirtyWorld){for(var t=e._dirtyLocal,i=e;i&&!t&&(!i.collision||i.collision!==this._compoundParent);)i._dirtyLocal&&(t=!0),i=i.parent;t&&(e.forEach(this.system.implementations.compound._updateEachDescendantTransform,e),(e=this._compoundParent.entity.rigidbody)&&e.activate())}},onEnable:function(){if("mesh"===this.data.type&&this.data.asset&&this.data.initialized){var e=this.system.app.assets.get(this.data.asset);if(e&&(!e.resource||!this.data.shape))return void this.system.recreatePhysicalShapes(this)}this.entity.rigidbody?this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation():this._compoundParent&&this!==this._compoundParent?0===this._compoundParent.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(this._compoundParent):(e=this.system._getNodeTransform(this.entity,this._compoundParent.entity),this._compoundParent.shape.addChildShape(e,this.data.shape),Ammo.destroy(e),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.enable()},onDisable:function(){this.entity.rigidbody?this.entity.rigidbody.disableSimulation():this._compoundParent&&this!==this._compoundParent?this._compoundParent.entity._destroying||(this.system._removeCompoundChild(this._compoundParent,this.data.shape),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.disable()},onBeforeRemove:function(){this.entity.off("insert",this._onInsert,this)}});var yc,vc,bc,xc="static",Sc=2,Tc=65533;Object.assign(fs.prototype,{initialize:function(e){var t=this.entity;if((e=e.shape)&&"undefined"!=typeof Ammo){t.trigger&&t.trigger.destroy();var i=t.getPosition(),s=t.getRotation();yc.setValue(i.x,i.y,i.z),vc.setValue(s.x,s.y,s.z,s.w),bc.setOrigin(yc),bc.setRotation(vc),(e=this.app.systems.rigidbody.createBody(1,e,bc)).setRestitution(0),e.setFriction(0),e.setDamping(0,0),yc.setValue(0,0,0),e.setLinearFactor(yc),e.setAngularFactor(yc),e.setCollisionFlags(4|e.getCollisionFlags()),e.entity=t,this.body=e,this.component.enabled&&t.enabled&&this.enable()}},destroy:function(){var e=this.body;e&&(this.disable(),this.app.systems.rigidbody.destroyBody(e))},_getEntityTransform:function(e){var t=this.entity.getPosition(),i=this.entity.getRotation();yc.setValue(t.x,t.y,t.z),vc.setValue(i.x,i.y,i.z,i.w),e.setOrigin(yc),e.setRotation(vc)},updateTransform:function(){this._getEntityTransform(bc);var e=this.body;e.setWorldTransform(bc),e.activate()},enable:function(){var e=this.body;if(e){var t=this.app.systems;t.rigidbody.addBody(e,16,16^Tc),t.rigidbody._triggers.push(this),e.forceActivationState(1),this.updateTransform()}},disable:function(){var e=this.body;if(e){var t=this.app.systems,i=t.rigidbody._triggers.indexOf(this);-1<i&&t.rigidbody._triggers.splice(i,1),t.rigidbody.removeBody(e),e.forceActivationState(5)}}});var wc=new x,Mc=new v,Pc=new S,Ac="enabled type halfExtents radius axis height asset shape model".split(" "),Ec=function(e){this.system=e};Object.assign(Ec.prototype,{beforeInitialize:function(e,t){t.shape=null,t.model=new oe,t.model.graph=new ge},afterInitialize:function(e,t){this.recreatePhysicalShapes(e),e.data.initialized=!0},reset:function(e,t){this.beforeInitialize(e,t),this.afterInitialize(e,t)},recreatePhysicalShapes:function(e){var t=e.entity,i=e.data;if("undefined"!=typeof Ammo){t.trigger&&(t.trigger.destroy(),delete t.trigger),i.shape&&(e._compoundParent&&(this.system._removeCompoundChild(e._compoundParent,i.shape),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate()),Ammo.destroy(i.shape),i.shape=null),i.shape=this.createPhysicalShape(e.entity,i);var s=!e._compoundParent;if("compound"!==i.type||e._compoundParent&&e!==e._compoundParent){if("compound"!==i.type&&(e._compoundParent&&e===e._compoundParent&&t.forEach(this.system.implementations.compound._updateEachDescendant,e),!e.rigidbody)){e._compoundParent=null;for(var n=t.parent;n;){if(n.collision&&"compound"===n.collision.type){e._compoundParent=n.collision;break}n=n.parent}}}else e._compoundParent=e,t.forEach(this._addEachDescendant,e);e._compoundParent&&e!==e._compoundParent&&(s&&0===e._compoundParent.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(e._compoundParent):(this.system.updateCompoundChildTransform(t),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate())),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):e._compoundParent||(t.trigger?t.trigger.initialize(i):t.trigger=new fs(this.system.app,e,i))}},createPhysicalShape:function(e,t){},updateTransform:function(e,t,i,s){e.entity.trigger&&e.entity.trigger.updateTransform()},beforeRemove:function(e,t){t.data.shape&&(t._compoundParent&&!t._compoundParent.entity._destroying&&(this.system._removeCompoundChild(t._compoundParent,t.data.shape),t._compoundParent.entity.rigidbody&&t._compoundParent.entity.rigidbody.activate()),t._compoundParent=null,Ammo.destroy(t.data.shape),t.data.shape=null)},remove:function(e,t){var i=this.system.app;e.rigidbody&&e.rigidbody.body&&(i.systems.rigidbody.removeBody(e.rigidbody.body),e.rigidbody.disableSimulation()),e.trigger&&(e.trigger.destroy(),delete e.trigger),i.scene.containsModel(t.model)&&(i.root.removeChild(t.model.graph),i.scene.removeModel(t.model))},clone:function(e,t){return e=this.system.store[e.getGuid()],this.system.addComponent(t,{enabled:e.data.enabled,type:e.data.type,halfExtents:[e.data.halfExtents.x,e.data.halfExtents.y,e.data.halfExtents.z],radius:e.data.radius,axis:e.data.axis,height:e.data.height,asset:e.data.asset,model:e.data.model})}});var Cc=function(e){this.system=e};(Cc.prototype=Object.create(Ec.prototype)).constructor=Cc,Object.assign(Cc.prototype,{createPhysicalShape:function(e,t){if("undefined"!=typeof Ammo)return e=t.halfExtents,e=new Ammo.btVector3(e?e.x:.5,e?e.y:.5,e?e.z:.5),t=new Ammo.btBoxShape(e),Ammo.destroy(e),t}});var Ic=function(e){this.system=e};(Ic.prototype=Object.create(Ec.prototype)).constructor=Ic,Object.assign(Ic.prototype,{createPhysicalShape:function(e,t){if("undefined"!=typeof Ammo)return new Ammo.btSphereShape(t.radius)}});var Oc=function(e){this.system=e};(Oc.prototype=Object.create(Ec.prototype)).constructor=Oc,Object.assign(Oc.prototype,{createPhysicalShape:function(e,t){e=null;var i=void 0!==t.axis?t.axis:1,s=t.radius||.5;if(t=Math.max((t.height||2)-2*s,0),"undefined"!=typeof Ammo)switch(i){case 0:e=new Ammo.btCapsuleShapeX(s,t);break;case 1:e=new Ammo.btCapsuleShape(s,t);break;case 2:e=new Ammo.btCapsuleShapeZ(s,t)}return e}});var Rc=function(e){this.system=e};(Rc.prototype=Object.create(Ec.prototype)).constructor=Rc,Object.assign(Rc.prototype,{createPhysicalShape:function(e,t){var i=e=null,s=void 0!==t.axis?t.axis:1,n=void 0!==t.radius?t.radius:.5;if(t=void 0!==t.height?t.height:1,"undefined"!=typeof Ammo)switch(s){case 0:e=new Ammo.btVector3(.5*t,n,n),i=new Ammo.btCylinderShapeX(e);break;case 1:e=new Ammo.btVector3(n,.5*t,n),i=new Ammo.btCylinderShape(e);break;case 2:e=new Ammo.btVector3(n,n,.5*t),i=new Ammo.btCylinderShapeZ(e)}return e&&Ammo.destroy(e),i}});var Dc=function(e){this.system=e};(Dc.prototype=Object.create(Ec.prototype)).constructor=Dc,Object.assign(Dc.prototype,{createPhysicalShape:function(e,t){e=null;var i=void 0!==t.axis?t.axis:1,s=void 0!==t.radius?t.radius:.5;if(t=void 0!==t.height?t.height:1,"undefined"!=typeof Ammo)switch(i){case 0:e=new Ammo.btConeShapeX(s,t);break;case 1:e=new Ammo.btConeShape(s,t);break;case 2:e=new Ammo.btConeShapeZ(s,t)}return e}});var Lc=function(e){this.system=e};(Lc.prototype=Object.create(Ec.prototype)).constructor=Lc,Object.assign(Lc.prototype,{beforeInitialize:function(e,t){},createPhysicalShape:function(e,t){if("undefined"!=typeof Ammo&&t.model){var i,s,n=t.model;for(t=new Ammo.btCompoundShape,i=0;i<n.meshInstances.length;i++){var r=n.meshInstances[i],a=r.mesh;if(this.system._triMeshCache[a.id])var o=this.system._triMeshCache[a.id];else{o=a.indexBuffer[0];var h,l=a.vertexBuffer,c=l.getFormat(),d=c.size/4;for(s=0;s<c.elements.length;s++){var u=c.elements[s];"POSITION"===u.name&&(h=new Float32Array(l.lock(),u.offset))}l=new Uint16Array(o.lock()),c=a.primitive[0].count/3,u=new Ammo.btVector3;var p=new Ammo.btVector3,f=new Ammo.btVector3,m=a.primitive[0].base;for(o=new Ammo.btTriangleMesh,this.system._triMeshCache[a.id]=o,s=0;s<c;s++){a=l[m+3*s]*d;var _=l[m+3*s+1]*d,g=l[m+3*s+2]*d;u.setValue(h[a],h[a+1],h[a+2]),p.setValue(h[_],h[_+1],h[_+2]),f.setValue(h[g],h[g+1],h[g+2]),o.addTriangle(u,p,f,!0)}Ammo.destroy(u),Ammo.destroy(p),Ammo.destroy(f)}s=new Ammo.btBvhTriangleMeshShape(o,!0),d=this.system._getNodeScaling(r.node),s.setLocalScaling(d),Ammo.destroy(d),r=this.system._getNodeTransform(r.node),t.addChildShape(r,s),Ammo.destroy(r)}return e=e.getWorldTransform().getScale(),e=new Ammo.btVector3(e.x,e.y,e.z),t.setLocalScaling(e),Ammo.destroy(e),t}},recreatePhysicalShapes:function(e){null!==e.data.asset&&e.enabled&&e.entity.enabled?this.loadModelAsset(e):this.doRecreatePhysicalShape(e)},loadModelAsset:function(e){var t=this,i=e.data.asset,s=e.data,n=this.system.app.assets,r=n.get(i);r?(r.ready(function(i){s.model=i.resource,t.doRecreatePhysicalShape(e)}),n.load(r)):n.once("add:"+i,function(i){i.ready(function(i){s.model=i.resource,t.doRecreatePhysicalShape(e)}),n.load(i)})},doRecreatePhysicalShape:function(e){var t=e.entity,i=e.data;i.model?(this.destroyShape(i),i.shape=this.createPhysicalShape(t,i),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):t.trigger?t.trigger.initialize(i):t.trigger=new fs(this.system.app,e,i)):(this.beforeRemove(t,e),this.remove(t,i))},updateTransform:function(e,t,i,s){if(e.shape){var n=e.entity.getWorldTransform().getScale(),r=e.shape.getLocalScaling();n.x===r.x()&&n.y===r.y()&&n.z===r.z()||this.doRecreatePhysicalShape(e)}Ec.prototype.updateTransform.call(this,e,t,i,s)},destroyShape:function(e){if(e.shape){for(var t=e.shape.getNumChildShapes(),i=0;i<t;i++){var s=e.shape.getChildShape(i);Ammo.destroy(s)}Ammo.destroy(e.shape),e.shape=null}},remove:function(e,t){this.destroyShape(t),Ec.prototype.remove.call(this,e,t)}});var Fc=function(e){this.system=e};(Fc.prototype=Object.create(Ec.prototype)).constructor=Fc,Object.assign(Fc.prototype,{createPhysicalShape:function(e,t){if("undefined"!=typeof Ammo)return new Ammo.btCompoundShape},_addEachDescendant:function(e){e.collision&&!e.rigidbody&&(e.collision._compoundParent=this,e!==this.entity&&e.collision.system.recreatePhysicalShapes(e.collision))},_updateEachDescendant:function(e){e.collision&&e.collision._compoundParent===this&&(e.collision._compoundParent=null,e===this.entity||e.rigidbody||e.collision.system.recreatePhysicalShapes(e.collision))},_updateEachDescendantTransform:function(e){e.collision&&e.collision._compoundParent===this.collision._compoundParent&&this.collision.system.updateCompoundChildTransform(e)}});var Bc=function(e){zi.call(this,e),this.id="collision",this.description="Specifies a collision volume.",this.ComponentType=gc,this.DataType=ps,this.schema=Ac,this.implementations={},this._triMeshCache={},this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this)};Bc.prototype=Object.create(zi.prototype),Bc.prototype.constructor=Bc,Ui._buildAccessors(gc.prototype,Ac),Object.assign(Bc.prototype,{initializeComponentData:function(e,t,s){for(var n={},r=0,a=(s="type halfExtents radius axis height shape model asset enabled".split(" ")).length;r<a;r++){var o=s[r];n[o]=t[o]}t.hasOwnProperty("asset")?-1!==(t=s.indexOf("model"))&&s.splice(t,1):t.hasOwnProperty("model")&&(-1!==(t=s.indexOf("asset"))&&s.splice(t,1)),n.type||(n.type=e.data.type),e.data.type=n.type,n.halfExtents&&"array"===i(n.halfExtents)&&(n.halfExtents=new v(n.halfExtents[0],n.halfExtents[1],n.halfExtents[2])),(t=this._createImplementation(n.type)).beforeInitialize(e,n),zi.prototype.initializeComponentData.call(this.system,e,n,s),t.afterInitialize(e,n)},_createImplementation:function(e){if(void 0===this.implementations[e]){switch(e){case"box":var t=new Cc(this);break;case"sphere":t=new Ic(this);break;case"capsule":t=new Oc(this);break;case"cylinder":t=new Rc(this);break;case"cone":t=new Dc(this);break;case"mesh":t=new Lc(this);break;case"compound":t=new Fc(this)}this.implementations[e]=t}return this.implementations[e]},_getImplementation:function(e){return this.implementations[e.collision.data.type]},cloneComponent:function(e,t){return this._getImplementation(e).clone(e,t)},onBeforeRemove:function(e,t){this.implementations[t.data.type].beforeRemove(e,t),t.onBeforeRemove()},onRemove:function(e,t){this.implementations[t.type].remove(e,t)},updateCompoundChildTransform:function(e){if(this._removeCompoundChild(e.collision._compoundParent,e.collision.data.shape),e.enabled&&e.collision.enabled){var t=this._getNodeTransform(e,e.collision._compoundParent.entity);e.collision._compoundParent.shape.addChildShape(t,e.collision.data.shape),Ammo.destroy(t)}},_removeCompoundChild:function(e,t){e.shape.removeChildShape?e.shape.removeChildShape(t):null!==(t=e._getCompoundChildShapeIndex(t))&&e.shape.removeChildShapeByIndex(t)},onTransformChanged:function(e,t,i,s){this.implementations[e.data.type].updateTransform(e,t,i,s)},changeType:function(e,t,i){this.implementations[t].beforeRemove(e.entity,e),this.implementations[t].remove(e.entity,e.data),this._createImplementation(i).reset(e,e.data)},recreatePhysicalShapes:function(e){this.implementations[e.data.type].recreatePhysicalShapes(e)},_calculateNodeRelativeTransform:function(e,t){e===t?(e=e.getWorldTransform().getScale(),wc.setScale(e.x,e.y,e.z)):(this._calculateNodeRelativeTransform(e.parent,t),wc.mul(e.getLocalTransform()))},_getNodeScaling:function(e){return e=e.getWorldTransform().getScale(),new Ammo.btVector3(e.x,e.y,e.z)},_getNodeTransform:function(e,t){t?(this._calculateNodeRelativeTransform(e,t),t=Mc,e=Pc,wc.getTranslation(t),e.setFromMat4(wc)):(t=e.getPosition(),e=e.getRotation());var i=new Ammo.btTransform;i.setIdentity();var s=i.getOrigin();return s.setValue(t.x,t.y,t.z),(t=new Ammo.btQuaternion).setValue(e.x,e.y,e.z,e.w),i.setRotation(t),Ammo.destroy(t),Ammo.destroy(s),i},destroy:function(){for(var e in this._triMeshCache)Ammo.destroy(this._triMeshCache[e]);this._triMeshCache=null,zi.prototype.destroy.call(this)}}),Object.assign(ms.prototype,{add:function(e){var t=e.id;if(this[t])throw Error("ComponentSystem name '"+t+"' already registered or not allowed");this[t]=e,this.list.push(e)},remove:function(e){if(!this[e=e.id])throw Error("No ComponentSystem named '"+e+"' registered");delete this[e],-1!==(e=this.list.indexOf(this[e]))&&this.list.splice(e,1)}});var Nc="group";_s.prototype.clone=function(){return new _s({func:this.func,ref:this.ref,readMask:this.readMask,writeMask:this.writeMask,fail:this.fail,zfail:this.zfail,zpass:this.zpass})},gs.prototype.destroy=function(){this.setMaterial(null),this._element.removeModelFromLayers(this.model),this.model.destroy(),this._element=this._entity=this.meshInstance=this.mesh=this.node=this.model=null},gs.prototype.setMesh=function(e){this.meshInstance&&(this.mesh=e,this.meshInstance.mesh=e,this.meshInstance.visible=!!e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.mesh=e),this.forceUpdateAabb())},gs.prototype.setMask=function(e){if(this.meshInstance){if(e)for(var t in this.unmaskMeshInstance=new ee(this.node,this.mesh,this.meshInstance.material),this.unmaskMeshInstance.name="Unmask: "+this._entity.name,this.unmaskMeshInstance.castShadow=!1,this.unmaskMeshInstance.receiveShadow=!1,this.unmaskMeshInstance.pick=!1,this.model.meshInstances.push(this.unmaskMeshInstance),this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(t,this.meshInstance.parameters[t].data);else 0<=(e=this.model.meshInstances.indexOf(this.unmaskMeshInstance))&&this.model.meshInstances.splice(e,1),this.unmaskMeshInstance=null;this._entity.enabled&&this._element.enabled&&(this._element.removeModelFromLayers(this.model),this._element.addModelToLayers(this.model))}},gs.prototype.setMaterial=function(e){this.meshInstance&&(this.meshInstance.material=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.material=e))},gs.prototype.setParameter=function(e,t){this.meshInstance&&(this.meshInstance.setParameter(e,t),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(e,t))},gs.prototype.deleteParameter=function(e){this.meshInstance&&(this.meshInstance.deleteParameter(e),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(e))},gs.prototype.setUnmaskDrawOrder=function(){if(this.meshInstance){var e=function(t){var i,s=(t=t.children).length;if(s){for(var n=0;n<s;n++)t[n].element&&(i=t[n]);return i?(t=e(i))?t:i:null}return null};if(this.unmaskMeshInstance){var t=e(this._entity);this.unmaskMeshInstance.drawOrder=t&&t.element?t.element.drawOrder+t.element.getMaskOffset():this.meshInstance.drawOrder+this._element.getMaskOffset()}}},gs.prototype.setDrawOrder=function(e){this.meshInstance&&(this.meshInstance.drawOrder=e)},gs.prototype.setCull=function(e){if(this.meshInstance){var t=this._element,i=null;e&&t._isScreenCulled()&&(i=function(e){return t.isVisibleForCamera(e)}),this.meshInstance.cull=e,this.meshInstance.isVisibleFunc=i,this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=e,this.unmaskMeshInstance.isVisibleFunc=i)}},gs.prototype.setScreenSpace=function(e){this.meshInstance&&(this.meshInstance.screenSpace=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.screenSpace=e))},gs.prototype.setLayer=function(e){this.meshInstance&&(this.meshInstance.layer=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=e))},gs.prototype.forceUpdateAabb=function(e){this.meshInstance&&(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&(this.unmaskMeshInstance._aabbVer=-1))},gs.prototype.setAabbFunc=function(e){this.meshInstance&&(this.meshInstance._updateAabbFunc=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=e))},Object.assign(ys.prototype,{destroy:function(){this.materialAsset=this.spriteAsset=this.textureAsset=null,this._renderable.setMesh(this._defaultMesh),this._renderable.destroy(),this._defaultMesh=null,this._element.off("resize",this._onParentResizeOrPivotChange,this),this._element.off("set:pivot",this._onParentResizeOrPivotChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("screen:set:resolution",this._onResolutionChange,this)},_onResolutionChange:function(e){},_onParentResizeOrPivotChange:function(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh)},_onScreenSpaceChange:function(e){this._updateMaterial(e)},_onScreenChange:function(e,t){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(!1)},_onDrawOrderChange:function(e){this._renderable.setDrawOrder(e),this.mask&&this._element.screen&&this._element.screen.screen.once("syncdraworder",function(){this._renderable.setUnmaskDrawOrder()},this)},_hasUserMaterial:function(){return!!this._materialAsset||!!this._material&&-1===this._system.defaultImageMaterials.indexOf(this._material)},_use9Slicing:function(){return this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)},_updateMaterial:function(e){var t=!!this._mask,i=!(!this.sprite||1!==this.sprite.renderMode),s=!(!this.sprite||2!==this.sprite.renderMode);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(e,t,i,s)),this._renderable&&(this._renderable.setCull(!0),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(e),this._renderable.setLayer(e?0:15))},_createMesh:function(){var e=this._element,t=e.calculatedWidth;e=e.calculatedHeight;var i=this._rect,s=new ArrayBuffer(128),n=new Float32Array(s);return n[5]=1,n[6]=i.x,n[7]=i.y,n[8]=t,n[13]=1,n[14]=i.x+i.z,n[15]=i.y,n[16]=t,n[17]=e,n[21]=1,n[22]=i.x+i.z,n[23]=i.y+i.w,n[25]=e,n[29]=1,n[30]=i.x,n[31]=i.y+i.w,s=new I(i=this._system.app.graphicsDevice,n=new R(i,[{semantic:"POSITION",components:3,type:6},{semantic:"NORMAL",components:3,type:6},{semantic:"TEXCOORD0",components:2,type:6}]),4,0,s),(i=new J(i)).vertexBuffer=s,i.primitive[0].type=6,i.primitive[0].base=0,i.primitive[0].count=4,i.primitive[0].indexed=!1,i.aabb.setMinMax(v.ZERO,new v(t,e,0)),this._updateMesh(i),i},_updateMesh:function(e){var t=this._element,i=t.calculatedWidth,s=t.calculatedHeight,n=t._isScreenSpace();if(this._updateMaterial(n),this._renderable&&this._renderable.forceUpdateAabb(),!this.sprite||1!==this.sprite.renderMode&&2!==this.sprite.renderMode){var r=e.vertexBuffer,a=new Float32Array(r.lock());n=t.pivot.x,t=t.pivot.y,a[0]=-n*i,a[1]=-t*s,a[8]=i-n*i,a[9]=-t*s,a[16]=i-n*i,a[17]=s-t*s,a[24]=-n*i,a[25]=s-t*s;var o=1,h=1,l=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){var c=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];c&&(l=c.rect,o=this._sprite.atlas.texture.width,h=this._sprite.atlas.texture.height)}a[6]=l.x/o,a[7]=l.y/h,a[14]=(l.x+l.z)/o,a[15]=l.y/h,a[22]=(l.x+l.z)/o,a[23]=(l.y+l.w)/h,a[30]=l.x/o,a[31]=(l.y+l.w)/h,r.unlock(),r=new v(-n*i,-t*s,0),i=new v(i-n*i,s-t*s,0),e.aabb.setMinMax(r,i),this._renderable&&(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null))}else n=2/(e=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]]).rect.z,r=2/e.rect.w,this._innerOffset.set(e.border.x*n,e.border.y*r,e.border.z*n,e.border.w*r),n=this.sprite.atlas.texture,this._atlasRect.set(e.rect.x/n.width,e.rect.y/n.height,e.rect.z/n.width,e.rect.w/n.height),r=null!==this._pixelsPerUnit?this._pixelsPerUnit:this.sprite.pixelsPerUnit,n=e.rect.z/r,e=e.rect.w/r,this._outerScale.set(Math.max(i,this._innerOffset.x*n),Math.max(s,this._innerOffset.y*e)),r=e,this._outerScale.x/=n,this._outerScale.y/=e,n*=Hr.clamp(i/(this._innerOffset.x*n),1e-4,1),r*=Hr.clamp(s/(this._innerOffset.y*e),1e-4,1),this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(n,r,1),this._renderable.node.setLocalPosition((.5-t.pivot.x)*i,(.5-t.pivot.y)*s,0));this._meshDirty=!1},_updateSprite:function(){var e=!1,t=null;this._sprite&&this._sprite.atlas&&(t=this._sprite.meshes[this.spriteFrame],e=1===this._sprite.renderMode||2===this._sprite.renderMode),(this.mesh=e?t:this._defaultMesh)&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this.mesh))},_updateAabb:function(e){return e.center.set(0,0,0),e.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),e.setFromTransformedAabb(e,this._renderable.node.getWorldTransform()),e},_toggleMask:function(){this._element._dirtifyMask();var e=this._element._isScreenSpace();this._updateMaterial(e),this._renderable.setMask(!!this._mask)},_onMaterialLoad:function(e){this.material=e.resource},_onMaterialAdded:function(e){this._system.app.assets.off("add:"+e.id,this._onMaterialAdded,this),this._materialAsset===e.id&&this._bindMaterialAsset(e)},_bindMaterialAsset:function(e){this._entity.enabled&&(e.on("load",this._onMaterialLoad,this),e.on("change",this._onMaterialChange,this),e.on("remove",this._onMaterialRemove,this),e.resource?this._onMaterialLoad(e):this._system.app.assets.load(e))},_unbindMaterialAsset:function(e){e.off("load",this._onMaterialLoad,this),e.off("change",this._onMaterialChange,this),e.off("remove",this._onMaterialRemove,this)},_onMaterialChange:function(){},_onMaterialRemove:function(){},_onTextureAdded:function(e){this._system.app.assets.off("add:"+e.id,this._onTextureAdded,this),this._textureAsset===e.id&&this._bindTextureAsset(e)},_bindTextureAsset:function(e){this._entity.enabled&&(e.on("load",this._onTextureLoad,this),e.on("change",this._onTextureChange,this),e.on("remove",this._onTextureRemove,this),e.resource?this._onTextureLoad(e):this._system.app.assets.load(e))},_unbindTextureAsset:function(e){e.off("load",this._onTextureLoad,this),e.off("change",this._onTextureChange,this),e.off("remove",this._onTextureRemove,this)},_onTextureLoad:function(e){this.texture=e.resource},_onTextureChange:function(e){},_onTextureRemove:function(e){},_onSpriteAssetAdded:function(e){this._system.app.assets.off("add:"+e.id,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e)},_bindSpriteAsset:function(e){this._entity.enabled&&(e.on("load",this._onSpriteAssetLoad,this),e.on("change",this._onSpriteAssetChange,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._system.app.assets.load(e))},_unbindSpriteAsset:function(e){e.off("load",this._onSpriteAssetLoad,this),e.off("change",this._onSpriteAssetChange,this),e.off("remove",this._onSpriteAssetRemove,this),e.data.textureAtlasAsset&&this._system.app.assets.off("load:"+e.data.textureAtlasAsset,this._onTextureAtlasLoad,this)},_onSpriteAssetLoad:function(e){if(e&&e.resource){if(e.resource.atlas)this.sprite=e.resource;else if(e=e.data.textureAtlasAsset){var t=this._system.app.assets;t.off("load:"+e,this._onTextureAtlasLoad,this),t.once("load:"+e,this._onTextureAtlasLoad,this)}}else this.sprite=null},_onSpriteAssetChange:function(e){this._onSpriteAssetLoad(e)},_onSpriteAssetRemove:function(e){},_bindSprite:function(e){e.on("set:meshes",this._onSpriteMeshesChange,this),e.on("set:pixelsPerUnit",this._onSpritePpuChange,this),e.on("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.on("set:texture",this._onAtlasTextureChange,this)},_unbindSprite:function(e){e.off("set:meshes",this._onSpriteMeshesChange,this),e.off("set:pixelsPerUnit",this._onSpritePpuChange,this),e.off("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.off("set:texture",this._onAtlasTextureChange,this)},_onSpriteMeshesChange:function(){this._sprite&&(this._spriteFrame=Hr.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()},_onSpritePpuChange:function(){0!==this.sprite.renderMode&&null===this._pixelsPerUnit&&this._updateSprite()},_onAtlasTextureChange:function(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))},_onTextureAtlasLoad:function(e){(e=this._spriteAsset)instanceof Pt?this._onSpriteAssetLoad(e):this._onSpriteAssetLoad(this._system.app.assets.get(e))},onEnable:function(){var e;this._materialAsset&&(e=this._system.app.assets.get(this._materialAsset))&&e.resource!==this._material&&this._bindMaterialAsset(e),this._textureAsset&&(e=this._system.app.assets.get(this._textureAsset))&&e.resource!==this._texture&&this._bindTextureAsset(e),this._spriteAsset&&(e=this._system.app.assets.get(this._spriteAsset))&&e.resource!==this._sprite&&this._bindSpriteAsset(e),this._element.addModelToLayers(this._renderable.model)},onDisable:function(){this._element.removeModelFromLayers(this._renderable.model)},_setStencil:function(e){this._renderable.meshInstance.stencilFront=e,this._renderable.meshInstance.stencilBack=e,e=0,this._element.maskedBy&&(e=this._element.maskedBy.element._image._maskRef),this._renderable.unmaskMeshInstance&&(e=new _s({ref:e+1,func:2,zpass:5}),this._renderable.unmaskMeshInstance.stencilFront=e,this._renderable.unmaskMeshInstance.stencilBack=e)}}),Object.defineProperty(ys.prototype,"color",{get:function(){return this._color},set:function(e){var t=e.r,i=e.g;e=e.b,this._color.r===t&&this._color.g===i&&this._color.b===e||(this._color.r=t,this._color.g=i,this._color.b=e,this._colorUniform[0]=t,this._colorUniform[1]=i,this._colorUniform[2]=e,this._renderable.setParameter("material_emissive",this._colorUniform),this._element&&this._element.fire("set:color",this._color))}}),Object.defineProperty(ys.prototype,"opacity",{get:function(){return this._color.a},set:function(e){e!==this._color.a&&(this._color.a=e,this._renderable.setParameter("material_opacity",e),this._element&&this._element.fire("set:opacity",e))}}),Object.defineProperty(ys.prototype,"rect",{get:function(){return this._rect},set:function(e){if(e instanceof b){var t=e.x,i=e.y,s=e.z;e=e.w}else t=e[0],i=e[1],s=e[2],e=e[3];t===this._rect.x&&i===this._rect.y&&s===this._rect.z&&e===this._rect.w||(this._rect.set(t,i,s,e),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this._renderable.mesh)))}}),Object.defineProperty(ys.prototype,"material",{get:function(){return this._material},set:function(e){this._material!==e&&(e||(e=this._element._isScreenSpace(),e=this.mask?e?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:e?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial),this._material=e)&&(this._renderable.setMaterial(e),this._hasUserMaterial()?(this._renderable.deleteParameter("material_opacity"),this._renderable.deleteParameter("material_emissive")):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)))}}),Object.defineProperty(ys.prototype,"materialAsset",{get:function(){return this._materialAsset},set:function(e){var t=this._system.app.assets,i=e;e instanceof Pt&&(i=e.id),this._materialAsset!==i&&(this._materialAsset&&(t.off("add:"+this._materialAsset,this._onMaterialAdded,this),e=t.get(this._materialAsset))&&(e.off("load",this._onMaterialLoad,this),e.off("change",this._onMaterialChange,this),e.off("remove",this._onMaterialRemove,this)),(this._materialAsset=i)?(i=t.get(this._materialAsset))?this._bindMaterialAsset(i):(this.material=null,t.on("add:"+this._materialAsset,this._onMaterialAdded,this)):this.material=null)}}),Object.defineProperty(ys.prototype,"texture",{get:function(){return this._texture},set:function(e){if(this._texture!==e){if(this._textureAsset){var t=this._system.app.assets.get(this._textureAsset);t&&t.resource!==e&&(this.textureAsset=null)}(this._texture=e)?(this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))}}}),Object.defineProperty(ys.prototype,"textureAsset",{get:function(){return this._textureAsset},set:function(e){var t=this._system.app.assets,i=e;e instanceof Pt&&(i=e.id),this._textureAsset!==i&&(this._textureAsset&&(t.off("add:"+this._textureAsset,this._onTextureAdded,this),e=t.get(this._textureAsset))&&(e.off("load",this._onTextureLoad,this),e.off("change",this._onTextureChange,this),e.off("remove",this._onTextureRemove,this)),(this._textureAsset=i)?(i=t.get(this._textureAsset))?this._bindTextureAsset(i):(this.texture=null,t.on("add:"+this._textureAsset,this._onTextureAdded,this)):this.texture=null)}}),Object.defineProperty(ys.prototype,"spriteAsset",{get:function(){return this._spriteAsset},set:function(e){var t=this._system.app.assets,i=e;e instanceof Pt&&(i=e.id),this._spriteAsset!==i&&(this._spriteAsset&&(t.off("add:"+this._spriteAsset,this._onSpriteAssetAdded,this),(e=t.get(this._spriteAsset))&&this._unbindSpriteAsset(e)),(this._spriteAsset=i)?(e=t.get(this._spriteAsset))?this._bindSpriteAsset(e):(this.sprite=null,t.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this)):this.sprite=null,this._element&&this._element.fire("set:spriteAsset",i))}}),Object.defineProperty(ys.prototype,"sprite",{get:function(){return this._sprite},set:function(e){if(this._sprite!==e){if(this._sprite&&this._unbindSprite(this._sprite),this._spriteAsset){var t=this._system.app.assets.get(this._spriteAsset);t&&t.resource!==e&&(this.spriteAsset=null)}(this._sprite=e)&&(this._bindSprite(this._sprite),this._textureAsset&&(this.textureAsset=null)),this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap")),this._sprite&&(this._spriteFrame=Hr.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}}}),Object.defineProperty(ys.prototype,"spriteFrame",{get:function(){return this._spriteFrame},set:function(e){var t=this._spriteFrame;this._spriteFrame=this._sprite?Hr.clamp(e,0,this._sprite.frameKeys.length-1):e,this._spriteFrame!==t&&(this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",e))}}),Object.defineProperty(ys.prototype,"mesh",{get:function(){return this._renderable.mesh},set:function(e){this._renderable.setMesh(e),this._defaultMesh===e?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc)}}),Object.defineProperty(ys.prototype,"mask",{get:function(){return this._mask},set:function(e){this._mask!==e&&(this._mask=e,this._toggleMask())}}),Object.defineProperty(ys.prototype,"pixelsPerUnit",{get:function(){return this._pixelsPerUnit},set:function(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,!this._sprite||1!==this._sprite.renderMode&&2!==this._sprite.renderMode||this._updateSprite())}}),Object.defineProperty(ys.prototype,"aabb",{get:function(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}}),vs.prototype=Object.create(r.prototype),vs.prototype.constructor=vs,vs.prototype._bindDefaultAsset=function(){var e=this._app.assets.get(this._defaultAsset);e?this._onDefaultAssetAdd(e):this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this)},vs.prototype._unbindDefaultAsset=function(){if(this._defaultAsset){this._app.assets.off("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);var e=this._app.assets.get(this._defaultAsset);e&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleRemove,this),e.off("remove",this._onDefaultAssetRemove,this))}},vs.prototype._onDefaultAssetAdd=function(e){this._defaultAsset===e.id&&(e.on("add:localized",this._onLocaleAdd,this),e.on("remove:localized",this._onLocaleRemove,this),e.once("remove",this._onDefaultAssetRemove,this))},vs.prototype._onDefaultAssetRemove=function(e){this._defaultAsset===e.id&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleAdd,this),this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this))},vs.prototype._bindLocalizedAsset=function(){if(this._autoLoad){var e=this._app.assets.get(this._localizedAsset);e&&(e.on("load",this._onLocalizedAssetLoad,this),e.on("change",this._onLocalizedAssetChange,this),e.on("remove",this._onLocalizedAssetRemove,this),e.resource?this._onLocalizedAssetLoad(e):this._app.assets.load(e))}},vs.prototype._unbindLocalizedAsset=function(){var e=this._app.assets.get(this._localizedAsset);e&&(e.off("load",this._onLocalizedAssetLoad,this),e.off("change",this._onLocalizedAssetChange,this),e.off("remove",this._onLocalizedAssetRemove,this))},vs.prototype._onLocalizedAssetAdd=function(e){this._localizedAsset===e.id&&this._bindLocalizedAsset()},vs.prototype._onLocalizedAssetLoad=function(e){this.fire("load",e)},vs.prototype._onLocalizedAssetChange=function(e,t,i,s){this.fire("change",e,t,i,s)},vs.prototype._onLocalizedAssetRemove=function(e){this._localizedAsset===e.id&&(this.localizedAsset=this._defaultAsset),this.fire("remove",e)},vs.prototype._onLocaleAdd=function(e,t){this._app.i18n.locale===e&&this._onSetLocale(e)},vs.prototype._onLocaleRemove=function(e,t){this._app.i18n.locale===e&&this._onSetLocale(e)},vs.prototype._onSetLocale=function(e){if(this._defaultAsset){var t=this._app.assets.get(this._defaultAsset);this.localizedAsset=!t||this._disableLocalization?this._defaultAsset:(e=t.getLocalizedAssetId(e))?e:this._defaultAsset}else this.localizedAsset=null},vs.prototype.destroy=function(){this.defaultAsset=null,this._app.i18n.off("set:locale",this._onSetLocale,this),this.off()},Object.defineProperty(vs.prototype,"defaultAsset",{get:function(){return this._defaultAsset},set:function(e){e=e instanceof Pt?e.id:e,this._defaultAsset!==e&&(this._defaultAsset&&this._unbindDefaultAsset(),(this._defaultAsset=e)&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale))}}),Object.defineProperty(vs.prototype,"localizedAsset",{get:function(){return this._localizedAsset},set:function(e){e=e instanceof Pt?e.id:e,this._localizedAsset!==e&&(this._localizedAsset&&(this._app.assets.off("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this),this._unbindLocalizedAsset(),this._localizedAsset=null),this._localizedAsset=e)&&(this._app.assets.get(this._localizedAsset)?this._bindLocalizedAsset():this._app.assets.once("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this))}}),Object.defineProperty(vs.prototype,"autoLoad",{get:function(){return this._autoLoad},set:function(e){this._autoLoad!==e&&(this._autoLoad=e)&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset())}}),Object.defineProperty(vs.prototype,"disableLocalization",{get:function(){return this._disableLocalization},set:function(e){this._disableLocalization!==e&&(this._disableLocalization=e,this._onSetLocale(this._app.i18n.locale))}}),Object.assign(bs.prototype,{EOF_TOKEN:0,ERROR_TOKEN:1,TEXT_TOKEN:2,OPEN_BRACKET_TOKEN:3,CLOSE_BRACKET_TOKEN:4,EQUALS_TOKEN:5,STRING_TOKEN:6,IDENTIFIER_TOKEN:7,WHITESPACE_TOKEN:8,WHITESPACE_CHARS:" \t\n\r\v\f",IDENTIFIER_REGEX:/[A-Z|a-z|0-9|_|-|/]/,read:function(){for(var e=this._read();e===this.WHITESPACE_TOKEN;)e=this._read();return e!==this.EOF_TOKEN&&e!==this.ERROR_TOKEN&&(this._last=this._index),e},buf:function(){return this._buf},last:function(){return this._last},error:function(){return this._error},debugPrint:function(){for(var e="EOF ERROR TEXT OPEN_BRACKET CLOSE_BRACKET EQUALS STRING IDENTIFIER WHITESPACE".split(" "),t=this.read(),i="";i+=(0<i.length?"\n":"")+e[t]+" '"+this.buf().join("")+"'",t!==this.EOF_TOKEN&&t!==this.ERROR_TOKEN;)t=this.read();return i},_read:function(){return this._buf=[],this._eof()?this.EOF_TOKEN:"text"===this._mode?this._text():this._tag()},_text:function(){for(;;)switch(this._cur){case null:return 0<this._buf.length?this.TEXT_TOKEN:this.EOF_TOKEN;case"[":return this._mode="tag",0<this._buf.length?this.TEXT_TOKEN:this._tag();case"\\":switch(this._next(),this._cur){case"[":this._store();break;default:this._output("\\")}break;default:this._store()}},_tag:function(){for(;;)switch(this._cur){case null:return this._error="unexpected end of input reading tag",this.ERROR_TOKEN;case"[":return this._store(),this.OPEN_BRACKET_TOKEN;case"]":return this._store(),this._mode="text",this.CLOSE_BRACKET_TOKEN;case"=":return this._store(),this.EQUALS_TOKEN;case" ":case"\t":case"\n":case"\r":case"\v":case"\f":return this._whitespace();case'"':return this._string();default:return this._isIdentifierSymbol(this._cur)?this._identifier():(this._error="unrecognized character",this.ERROR_TOKEN)}},_whitespace:function(){for(this._store();-1!==this.WHITESPACE_CHARS.indexOf(this._cur);)this._store();return this.WHITESPACE_TOKEN},_string:function(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",this.ERROR_TOKEN;case'"':return this._next(),this.STRING_TOKEN;default:this._store()}},_identifier:function(){for(this._store();null!==this._cur&&this._isIdentifierSymbol(this._cur);)this._store();return this.IDENTIFIER_TOKEN},_isIdentifierSymbol:function(e){return 1===e.length&&null!==e.match(this.IDENTIFIER_REGEX)},_eof:function(){return null===this._cur},_next:function(){return this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null),this._cur},_store:function(){return this._buf.push(this._cur),this._next()},_output:function(e){this._buf.push(e)}});var kc=function(e){this._scanner=new bs(e),this._error=null};Object.assign(kc.prototype,{parse:function(e,t){for(;;)switch(this._scanner.read()){case this._scanner.EOF_TOKEN:return!0;case this._scanner.ERROR_TOKEN:return!1;case this._scanner.TEXT_TOKEN:Array.prototype.push.apply(e,this._scanner.buf());break;case this._scanner.OPEN_BRACKET_TOKEN:if(!this._parseTag(e,t))return!1;break;default:return!1}},error:function(){return"Error evaluating markup at #"+this._scanner.last().toString()+" ("+(this._scanner.error()||this._error)+")"},_parseTag:function(e,t){var i=this._scanner.read();if(i!==this._scanner.IDENTIFIER_TOKEN)return this._error="expected identifier",!1;if("/"===(i=this._scanner.buf().join(""))[0]){for(var s=t.length-1;0<=s;--s)if(i==="/"+t[s].name&&null===t[s].end)return t[s].end=e.length,(i=this._scanner.read())===this._scanner.CLOSE_BRACKET_TOKEN||(this._error="expected close bracket",!1);return this._error="failed to find matching tag",!1}if(e={name:i,value:null,attributes:{},start:e.length,end:null},(i=this._scanner.read())===this._scanner.EQUALS_TOKEN){if((i=this._scanner.read())!==this._scanner.STRING_TOKEN)return this._error="expected string",!1;e.value=this._scanner.buf().join(""),i=this._scanner.read()}for(;;){switch(i){case this._scanner.CLOSE_BRACKET_TOKEN:return t.push(e),!0;case this._scanner.IDENTIFIER_TOKEN:if(s=this._scanner.buf().join(""),(i=this._scanner.read())!==this._scanner.EQUALS_TOKEN)return this._error="expected equals",!1;if((i=this._scanner.read())!==this._scanner.STRING_TOKEN)return this._error="expected string",!1;i=this._scanner.buf().join(""),e.attributes[s]=i;break;default:return this._error="expected close bracket or identifier",!1}i=this._scanner.read()}}}),ws.evaluate=function(e){return Ts(e)};var Uc=/^[\r\n]$/,zc=/^[ \t]$/,Vc=/^[ \t\-]$/;Object.assign(Ps.prototype,{destroy:function(){this._setMaterial(null),this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null),this._fontAsset.destroy(),this.font=null,this._element.off("resize",this._onParentResize,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("set:pivot",this._onPivotChange,this),this._system.app.i18n.off("set:locale",this._onLocaleSet,this),this._system.app.i18n.off("data:add",this._onLocalizationData,this),this._system.app.i18n.off("data:remove",this._onLocalizationData,this)},_onParentResize:function(e,t){this._noResize||this._font&&this._updateText()},_onScreenChange:function(e){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(!1)},_onScreenSpaceChange:function(e){this._updateMaterial(e)},_onDrawOrderChange:function(e){if(this._drawOrder=e,this._model){var t,i=0;for(t=this._model.meshInstances.length;i<t;i++)this._model.meshInstances[i].drawOrder=e}},_onPivotChange:function(e){this._font&&this._updateText()},_onLocaleSet:function(e){this._i18nKey&&(this.fontAsset&&((e=this._system.app.assets.get(this.fontAsset))&&e.resource&&e.resource===this._font||(this.font=null)),this._resetLocalizedText())},_onLocalizationData:function(e,t){this._i18nKey&&t[this._i18nKey]&&this._resetLocalizedText()},_resetLocalizedText:function(){this._setText(this._system.app.i18n.getText(this._i18nKey))},_setText:function(e){if(this.unicodeConverter){var t=this._system.getUnicodeConverter();t?e=t(e):console.warn("Element created with unicodeConverter option but no unicodeConverter function registered")}this._text!==e&&(this._font&&this._updateText(e),this._text=e)},_updateText:function(e){var t;if(void 0===e&&(e=this._text),this._symbols=Wr.getSymbols(e),0===this._symbols.length&&(this._symbols=[" "]),this._enableMarkup){e=ws.evaluate(this._symbols),this._symbols=e.symbols;var i=e.tags}if(this._rtlReorder?(e=this._system.app.systems.element.getRtlReorder())?(e=e(this._symbols),this._rtl=e.rtl,this._symbols=e.mapping.map(function(e){return this._symbols[e]},this),i&&(i=e.mapping.map(function(e){return i[e]}))):console.warn("Element created with rtlReorder option but no rtlReorder function registered"):this._rtl=!1,i){var s={};for(this._colorPalette=[Math.round(255*this._color.r),Math.round(255*this._color.g),Math.round(255*this._color.b)],this._symbolColors=[],e=s[this._color.toString(!1).toLowerCase()]=0,t=this._symbols.length;e<t;++e){var n=i[e],r=0;n&&n.color&&n.color.value&&(7===(n=n.color.value).length&&"#"===n[0]&&(n=n.substring(1).toLowerCase(),s.hasOwnProperty(n)?r=s[n]:/^([0-9a-f]{2}){3}$/.test(n)&&(r=this._colorPalette.length/3,s[n]=r,this._colorPalette.push(parseInt(n.substring(0,2),16)),this._colorPalette.push(parseInt(n.substring(2,4),16)),this._colorPalette.push(parseInt(n.substring(4,6),16))))),this._symbolColors.push(r)}}else this._colorPalette=[],this._symbolColors=null;s=this._calculateCharsPerTexture(),r=!1;var a=this._element;n=a._isScreenSpace();var o=a._isScreenCulled(),h=function(e){return a.isVisibleForCamera(e)};for(e=0,t=this._meshInfo.length;e<t;e++){var l=s[e]||0,c=this._meshInfo[e];if(c.count!==l)if(r||(a.removeModelFromLayers(this._model),r=!0),c.count=l,c.positions.length=c.normals.length=12*l,c.indices.length=6*l,c.uvs.length=8*l,c.colors.length=16*l,c.meshInstance&&(this._removeMeshInstance(c.meshInstance),c.meshInstance.material=null),0===l)c.meshInstance=null;else{for(var d=0;d<l;d++)c.indices[6*d]=4*d,c.indices[6*d+1]=4*d+1,c.indices[6*d+2]=4*d+3,c.indices[6*d+3]=4*d+2,c.indices[6*d+4]=4*d+3,c.indices[6*d+5]=4*d+1,c.normals[12*d]=0,c.normals[12*d+1]=0,c.normals[12*d+2]=-1,c.normals[12*d+3]=0,c.normals[12*d+4]=0,c.normals[12*d+5]=-1,c.normals[12*d+6]=0,c.normals[12*d+7]=0,c.normals[12*d+8]=-1,c.normals[12*d+9]=0,c.normals[12*d+10]=0,c.normals[12*d+11]=-1;l=qe(this._system.app.graphicsDevice,c.positions,{uvs:c.uvs,normals:c.normals,colors:c.colors,indices:c.indices}),(l=new ee(this._node,l,this._material)).name="Text Element: "+this._entity.name,l.castShadow=!1,l.receiveShadow=!1,l.cull=!n,l.screenSpace=n,l.drawOrder=this._drawOrder,o&&(l.cull=!0,l.isVisibleFunc=h),this._setTextureParams(l,this._font.textures[e]),this._symbolColors?(this._colorUniform[0]=1,this._colorUniform[1]=1,this._colorUniform[2]=1):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b),l.setParameter("material_emissive",this._colorUniform),l.setParameter("material_opacity",this._color.a),l.setParameter("font_sdfIntensity",this._font.intensity),l.setParameter("font_pxrange",this._getPxRange(this._font)),l.setParameter("font_textureWidth",this._font.data.info.maps[e].width),this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a,l.setParameter("outline_color",this._outlineColorUniform),l.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness),this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a,l.setParameter("shadow_color",this._shadowColorUniform),d=this._font.data.info.maps[e].width/this._font.data.info.maps[e].height,this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=d*this._shadowOffsetScale*this._shadowOffset.y,l.setParameter("shadow_offset",this._shadowOffsetUniform),c.meshInstance=l,this._model.meshInstances.push(l)}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy),r&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model),this._updateMeshes(),this._rangeStart=0,this._rangeEnd=this._symbols.length,this._updateRenderRange()},_removeMeshInstance:function(e){var t,i=e.mesh;if(i&&(i.vertexBuffer&&i.vertexBuffer.destroy(),i.indexBuffer)){var s=0;for(t=i.indexBuffer.length;s<t;s++)i.indexBuffer[s].destroy()}-1!==(e=this._model.meshInstances.indexOf(e))&&this._model.meshInstances.splice(e,1)},_setMaterial:function(e){var t;if(this._material=e,this._model){var i=0;for(t=this._model.meshInstances.length;i<t;i++)this._model.meshInstances[i].material=e}},_updateMaterial:function(e){var t=this._element,i=t._isScreenCulled(),s=function(e){return t.isVisibleForCamera(e)};if(this._material=this._system.getTextElementMaterial(e,this._font&&"msdf"===this._font.type),this._model)for(var n=0,r=this._model.meshInstances.length;n<r;n++){var a=this._model.meshInstances[n];a.cull=!e,a.material=this._material,a.screenSpace=e,i?(a.cull=!0,a.isVisibleFunc=s):a.isVisibleFunc=null}},_updateMeshes:function(){function e(e,t,s){if(i._lineWidths.push(Math.abs(s)),e=e.slice(f>t?t+1:f,f>t?f+1:t),g)for(s=e.length;s--&&0<g;)Uc.test(e[s])&&(e.splice(s,1),g--);i._lineContents.push(e.join("")),o=0,h-=i._scaledLineHeight,d++,u=g=_=m=0,f=t}var t=this._font.data,i=this,s=Math.min(this._minFontSize,this._maxFontSize),n=this._maxFontSize,r=this._shouldAutoFit();r&&(this._fontSize=this._maxFontSize);var a=this._symbols.length,o=0,h=0,l=0,c=0,d=1,u=0,p=0,f=0,m=0,_=0,g=0,y=1e-4<=Math.abs(this._element.anchor.x-this._element.anchor.z),v=this._element.calculatedWidth;(this.autoWidth&&!y||!this._wrapLines)&&(v=Number.POSITIVE_INFINITY);var b=0;y=0;for(var x,S,T,w=1,M=!0;M;){for(M=!1,this._scaledLineHeight=r?this._lineHeight*this._fontSize/(this._maxFontSize||1e-4):this._lineHeight,this.height=this.width=0,this._lineWidths=[],this._lineContents=[],c=l=h=o=0,d=1,g=_=m=f=p=u=0,w=this._fontSize/32,b=this._fontMinY*w,y=this._fontMaxY*w,T=0;T<this._meshInfo.length;T++)this._meshInfo[T].quad=0,this._meshInfo[T].lines={};var P=255,A=255,E=255;for(T=0;T<a;T++){x=this._symbols[T];var C=0,I=0,O=0,R=1;if(!(S=t.chars[x]))if(t.chars[" "])S=t.chars[" "];else for(var D in t.chars){S=t.chars[D];break}if(S){var L=0;0<_&&(O=this._font.data.kerning)&&(O=O[Wr.getCodePoint(this._symbols[T-1])||0])&&(L=O[Wr.getCodePoint(this._symbols[T])||0]||0),O=S.scale||1;var F=(S.width+S.height)/2;R=w*F/O,O=(S.xadvance+L)*w,C=(S.xoffset-L)*w,I=S.yoffset*w}else console.error("Couldn't substitute missing character: '"+x+"'");if(F=Uc.test(x))g++,(0>this._maxLines||d<this._maxLines)&&(e(this._symbols,T,c),p=T+1,f=T+1);else{var B=zc.test(x);L=this._meshInfo[S&&S.map||0];var N=o+this._spacing*O;if(N>v&&0<_&&!B&&(0>this._maxLines||d<this._maxLines)){if(0!==m){if(S=Math.max(T-p,0),1>=this._meshInfo.length)L.lines[d-1]-=S,L.quad-=S;else for(L=T,x=p;x<L;x++)O=t.chars[this._symbols[x]],--(O=this._meshInfo[O&&O.map||0]).lines[d-1],--O.quad;T-=S+1,e(this._symbols,p,u);continue}p=T,e(this._symbols,T,c)}S=L.quad,L.lines[d-1]=S;var k=o-C,U=k+R,z=(I=h-I)+R;if(this._rtl&&(k-=R=R-C-this._spacing*O-C,U-=R),L.positions[12*S]=k,L.positions[12*S+1]=I,L.positions[12*S+2]=l,L.positions[12*S+3]=U,L.positions[12*S+4]=I,L.positions[12*S+5]=l,L.positions[12*S+6]=U,L.positions[12*S+7]=z,L.positions[12*S+8]=l,L.positions[12*S+9]=k,L.positions[12*S+10]=z,L.positions[12*S+11]=l,this.width=Math.max(this.width,N),this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(R=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1e-4)),(R=Hr.clamp(R,s,n))!==this._element.fontSize)){this._fontSize=R,M=!0;break}if(this.height=Math.max(this.height,y-(h+b)),this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(R=Hr.clamp(this._fontSize-1,s,n))!==this._element.fontSize){this._fontSize=R,M=!0;break}o+=this._spacing*O,B||F||(c=o),Vc.test(x)&&(m++,u=c,p=T+1),_++,x=this._getUv(x),L.uvs[8*S]=x[0],L.uvs[8*S+1]=x[1],L.uvs[8*S+2]=x[2],L.uvs[8*S+3]=x[1],L.uvs[8*S+4]=x[2],L.uvs[8*S+5]=x[3],L.uvs[8*S+6]=x[0],L.uvs[8*S+7]=x[3],this._symbolColors&&(E=3*this._symbolColors[T],P=this._colorPalette[E],A=this._colorPalette[E+1],E=this._colorPalette[E+2]),L.colors[16*S]=P,L.colors[16*S+1]=A,L.colors[16*S+2]=E,L.colors[16*S+3]=255,L.colors[16*S+4]=P,L.colors[16*S+5]=A,L.colors[16*S+6]=E,L.colors[16*S+7]=255,L.colors[16*S+8]=P,L.colors[16*S+9]=A,L.colors[16*S+10]=E,L.colors[16*S+11]=255,L.colors[16*S+12]=P,L.colors[16*S+13]=A,L.colors[16*S+14]=E,L.colors[16*S+15]=255,L.quad++}}M||f<a&&e(this._symbols,a,o)}for(this._noResize=!0,this.autoWidth=this._autoWidth,this.autoHeight=this._autoHeight,this._noResize=!1,t=this._element.pivot.x,s=this._element.pivot.y,n=this._alignment.x,r=this._alignment.y,T=0;T<this._meshInfo.length;T++)if(0!==this._meshInfo[T].count){for(var V in D=0,this._meshInfo[T].lines){for(a=this._meshInfo[T].lines[V],v=this._lineWidths[parseInt(V,10)],v=-t*this._element.calculatedWidth+n*(this._element.calculatedWidth-v)*(this._rtl?-1:1),l=(1-s)*this._element.calculatedHeight-y-(1-r)*(this._element.calculatedHeight-this.height),S=D;S<=a;S++)this._meshInfo[T].positions[12*S]+=v,this._meshInfo[T].positions[12*S+3]+=v,this._meshInfo[T].positions[12*S+6]+=v,this._meshInfo[T].positions[12*S+9]+=v,this._meshInfo[T].positions[12*S+1]+=l,this._meshInfo[T].positions[12*S+4]+=l,this._meshInfo[T].positions[12*S+7]+=l,this._meshInfo[T].positions[12*S+10]+=l;if(this._rtl)for(S=D;S<=a;S++){for(D=12*S,l=0;4>l;++l)this._meshInfo[T].positions[D+3*l]=this._element.calculatedWidth-this._meshInfo[T].positions[D+3*l]+2*v;l=this._meshInfo[T].positions[D+3],c=this._meshInfo[T].positions[D+6],this._meshInfo[T].positions[D+3]=this._meshInfo[T].positions[D+0],this._meshInfo[T].positions[D+6]=this._meshInfo[T].positions[D+9],this._meshInfo[T].positions[D+0]=l,this._meshInfo[T].positions[D+9]=c}D=a+1}for(a=4*this._meshInfo[T].count,v=4*this._meshInfo[T].quad,S=new X(this._meshInfo[T].meshInstance.mesh.vertexBuffer),D=0;D<a;D++)D>=v?(S.element.POSITION.set(0,0,0),S.element.TEXCOORD0.set(0,0),S.element.COLOR.set(0,0,0,0)):(S.element.POSITION.set(this._meshInfo[T].positions[3*D],this._meshInfo[T].positions[3*D+1],this._meshInfo[T].positions[3*D+2]),S.element.TEXCOORD0.set(this._meshInfo[T].uvs[2*D],this._meshInfo[T].uvs[2*D+1]),S.element.COLOR.set(this._meshInfo[T].colors[4*D],this._meshInfo[T].colors[4*D+1],this._meshInfo[T].colors[4*D+2],this._meshInfo[T].colors[4*D+3])),S.next();S.end(),this._meshInfo[T].meshInstance.mesh.aabb.compute(this._meshInfo[T].positions),this._meshInfo[T].meshInstance._aabbVer=-1}this._aabbDirty=!0},_onFontRender:function(){this.font=this._font},_onFontLoad:function(e){this.font!==e.resource&&(this.font=e.resource)},_onFontChange:function(e,t,i,s){if("data"===t)for(this._font.data=i,e=this._font.data.info.maps.length,t=0;t<e;t++)this._meshInfo[t]&&(i=this._meshInfo[t].meshInstance)&&(i.setParameter("font_sdfIntensity",this._font.intensity),i.setParameter("font_pxrange",this._getPxRange(this._font)),i.setParameter("font_textureWidth",this._font.data.info.maps[t].width))},_onFontRemove:function(e){},_setTextureParams:function(e,t){this._font&&("msdf"===this._font.type?(e.deleteParameter("texture_emissiveMap"),e.deleteParameter("texture_opacityMap"),e.setParameter("texture_msdfMap",t)):"bitmap"===this._font.type&&(e.deleteParameter("texture_msdfMap"),e.setParameter("texture_emissiveMap",t),e.setParameter("texture_opacityMap",t)))},_getPxRange:function(e){e=Object.keys(this._font.data.chars);for(var t=0;t<e.length;t++){var i=this._font.data.chars[e[t]];if(i.range)return(i.scale||1)*i.range}return 2},_getUv:function(e){var t=this._font.data;if(!t.chars[e])return t.chars[" "]?this._getUv(" "):[0,0,0,0];var i=t.chars[e].map,s=t.info.maps[i].width;i=t.info.maps[i].height;var n=t.chars[e].x,r=t.chars[e].y,a=1-t.chars[e].height/i;return[n/s,a-r/i,(n+t.chars[e].width)/s,a-(r-t.chars[e].height)/i]},onEnable:function(){this._fontAsset.autoLoad=!0,this._model&&this._element.addModelToLayers(this._model)},onDisable:function(){this._fontAsset.autoLoad=!1,this._model&&this._element.removeModelFromLayers(this._model)},_setStencil:function(e){if(this._model)for(var t=this._model.meshInstances,i=0;i<t.length;i++)t[i].stencilFront=e,t[i].stencilBack=e},_shouldAutoFitWidth:function(){return this._autoFitWidth&&!this._autoWidth},_shouldAutoFitHeight:function(){return this._autoFitHeight&&!this._autoHeight},_shouldAutoFit:function(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight},_calculateCharsPerTexture:function(e){var t,i={};for(void 0===e&&(e=this._symbols.length),t=0;t<e;t++){var s=this._symbols[t];(s=this._font.data.chars[s])||(s=this._font.data.chars[" "])||(s=this._font.data.chars[Object.keys(this._font.data.chars)[0]]),i[s=s.map]?i[s]++:i[s]=1}return i},_updateRenderRange:function(){var e,t=0===this._rangeStart?0:this._calculateCharsPerTexture(this._rangeStart),i=0===this._rangeEnd?0:this._calculateCharsPerTexture(this._rangeEnd),s=0;for(e=this._meshInfo.length;s<e;s++){var n=t[s]||0,r=i[s]||0,a=this._meshInfo[s].meshInstance;a&&(a=a.mesh)&&(a.primitive[0].base=6*n,a.primitive[0].count=6*(r-n))}}}),Object.defineProperty(Ps.prototype,"text",{get:function(){return this._text},set:function(e){this._i18nKey=null,this._setText(e&&e.toString()||"")}}),Object.defineProperty(Ps.prototype,"key",{get:function(){return this._i18nKey},set:function(e){e=null!==e?e.toString():null,this._i18nKey!==e&&((this._i18nKey=e)?(this._fontAsset.disableLocalization=!1,this._resetLocalizedText()):this._fontAsset.disableLocalization=!0)}}),Object.defineProperty(Ps.prototype,"color",{get:function(){return this._color},set:function(e){var t=e.r,i=e.g;if(e=e.b,this._color.r!==t||this._color.g!==i||this._color.b!==e)if(this._color.r=t,this._color.g=i,this._color.b=e,this._symbolColors)this._font&&this._updateText();else for(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,t=0,i=this._model.meshInstances.length;t<i;t++)this._model.meshInstances[t].setParameter("material_emissive",this._colorUniform)}}),Object.defineProperty(Ps.prototype,"opacity",{get:function(){return this._color.a},set:function(e){if(this._color.a!==e&&(this._color.a=e,this._model))for(var t=0,i=this._model.meshInstances.length;t<i;t++)this._model.meshInstances[t].setParameter("material_opacity",e)}}),Object.defineProperty(Ps.prototype,"lineHeight",{get:function(){return this._lineHeight},set:function(e){var t=this._lineHeight;this._scaledLineHeight=this._lineHeight=e,t!==e&&this._font&&this._updateText()}}),Object.defineProperty(Ps.prototype,"wrapLines",{get:function(){return this._wrapLines},set:function(e){var t=this._wrapLines;this._wrapLines=e,t!==e&&this._font&&this._updateText()}}),Object.defineProperty(Ps.prototype,"lines",{get:function(){return this._lineContents}}),Object.defineProperty(Ps.prototype,"spacing",{get:function(){return this._spacing},set:function(e){var t=this._spacing;this._spacing=e,t!==e&&this._font&&this._updateText()}}),Object.defineProperty(Ps.prototype,"fontSize",{get:function(){return this._fontSize},set:function(e){var t=this._fontSize;this._originalFontSize=this._fontSize=e,t!==e&&this._font&&this._updateText()}}),Object.defineProperty(Ps.prototype,"fontAsset",{get:function(){return this._fontAsset.localizedAsset},set:function(e){this._fontAsset.defaultAsset=e}}),Object.defineProperty(Ps.prototype,"font",{get:function(){return this._font},set:function(e){if(this._font){var t=this._font.type;this._font.off&&this._font.off("render",this._onFontRender,this)}if(this._font=e,this._fontMaxY=this._fontMinY=0,e){var i,s=this._font.data;for(i in s.chars){var n=s.chars[i];n.bounds&&(this._fontMinY=Math.min(this._fontMinY,n.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,n.bounds[3]))}for(this._font.on&&this._font.on("render",this._onFontRender,this),this._fontAsset.localizedAsset&&this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null),e.type!==t&&(e=this._element._isScreenSpace(),this._updateMaterial(e)),e=0,t=this._font.textures.length;e<t;e++)this._meshInfo[e]?(s=this._meshInfo[e].meshInstance)&&(s.setParameter("font_sdfIntensity",this._font.intensity),s.setParameter("font_pxrange",this._getPxRange(this._font)),s.setParameter("font_textureWidth",this._font.data.info.maps[e].width),this._setTextureParams(s,this._font.textures[e])):this._meshInfo[e]=new Ms;for(t=!1,e=this._font.textures.length;e<this._meshInfo.length;e++)this._meshInfo[e].meshInstance&&(t||(this._element.removeModelFromLayers(this._model),t=!0),this._removeMeshInstance(this._meshInfo[e].meshInstance));this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length),this._updateText()}}}),Object.defineProperty(Ps.prototype,"alignment",{get:function(){return this._alignment},set:function(e){e instanceof T?this._alignment.set(e.x,e.y):this._alignment.set(e[0],e[1]),this._font&&this._updateText()}}),Object.defineProperty(Ps.prototype,"autoWidth",{get:function(){return this._autoWidth},set:function(e){var t=this._autoWidth;(this._autoWidth=e)&&1e-4>Math.abs(this._element.anchor.x-this._element.anchor.z)&&(this._element.width=this.width),t!==e&&((e=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize)!==this._fontSize&&(this._fontSize=e,this._font&&this._updateText()))}}),Object.defineProperty(Ps.prototype,"autoHeight",{get:function(){return this._autoHeight},set:function(e){var t=this._autoHeight;(this._autoHeight=e)&&1e-4>Math.abs(this._element.anchor.y-this._element.anchor.w)&&(this._element.height=this.height),t!==e&&((e=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize)!==this._fontSize&&(this._fontSize=e,this._font&&this._updateText()))}}),Object.defineProperty(Ps.prototype,"rtlReorder",{get:function(){return this._rtlReorder},set:function(e){this._rtlReorder!==e&&(this._rtlReorder=e,this._font&&this._updateText())}}),Object.defineProperty(Ps.prototype,"unicodeConverter",{get:function(){return this._unicodeConverter},set:function(e){this._unicodeConverter!==e&&(this._unicodeConverter=e,this._setText(this._text))}}),Object.defineProperty(Ps.prototype,"aabb",{get:function(){if(this._aabbDirty){for(var e=!1,t=0;t<this._meshInfo.length;t++)this._meshInfo[t].meshInstance&&(e?this._aabb.add(this._meshInfo[t].meshInstance.aabb):(this._aabb.copy(this._meshInfo[t].meshInstance.aabb),e=!0));this._aabbDirty=!1}return this._aabb}}),Object.defineProperty(Ps.prototype,"outlineColor",{get:function(){return this._outlineColor},set:function(e){var t=e instanceof h?e.r:e[0],i=e instanceof h?e.g:e[1],s=e instanceof h?e.b:e[2];if(e=e instanceof h?e.a:e[3],(this._outlineColor.r!==t||this._outlineColor.g!==i||this._outlineColor.b!==s||this._outlineColor.a!==e)&&(this._outlineColor.r=t,this._outlineColor.g=i,this._outlineColor.b=s,this._outlineColor.a=e,this._model))for(this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a,t=0,i=this._model.meshInstances.length;t<i;t++)this._model.meshInstances[t].setParameter("outline_color",this._outlineColorUniform)}}),Object.defineProperty(Ps.prototype,"outlineThickness",{get:function(){return this._outlineThickness},set:function(e){var t=this._outlineThickness;if(this._outlineThickness=e,t!==e&&this._font&&this._model)for(e=0,t=this._model.meshInstances.length;e<t;e++)this._model.meshInstances[e].setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness)}}),Object.defineProperty(Ps.prototype,"shadowColor",{get:function(){return this._shadowColor},set:function(e){var t=e instanceof h?e.r:e[0],i=e instanceof h?e.g:e[1],s=e instanceof h?e.b:e[2];if(e=e instanceof h?e.a:e[3],(this._shadowColor.r!==t||this._shadowColor.g!==i||this._shadowColor.b!==s||this._shadowColor.a!==e)&&(this._shadowColor.r=t,this._shadowColor.g=i,this._shadowColor.b=s,this._shadowColor.a=e,this._model))for(this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a,t=0,i=this._model.meshInstances.length;t<i;t++)this._model.meshInstances[t].setParameter("shadow_color",this._shadowColorUniform)}}),Object.defineProperty(Ps.prototype,"shadowOffset",{get:function(){return this._shadowOffset},set:function(e){var t=e instanceof T?e.x:e[0];if(e=e instanceof T?e.y:e[1],(this._shadowOffset.x!==t||this._shadowOffset.y!==e)&&(this._shadowOffset.set(t,e),this._font&&this._model))for(t=0,e=this._model.meshInstances.length;t<e;t++){var i=this._font.data.info.maps[t].width/this._font.data.info.maps[t].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=i*this._shadowOffsetScale*this._shadowOffset.y,this._model.meshInstances[t].setParameter("shadow_offset",this._shadowOffsetUniform)}}}),Object.defineProperty(Ps.prototype,"minFontSize",{get:function(){return this._minFontSize},set:function(e){this._minFontSize!==e&&(this._minFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText())}}),Object.defineProperty(Ps.prototype,"maxFontSize",{get:function(){return this._maxFontSize},set:function(e){this._maxFontSize!==e&&(this._maxFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText())}}),Object.defineProperty(Ps.prototype,"autoFitWidth",{get:function(){return this._autoFitWidth},set:function(e){this._autoFitWidth!==e&&(this._autoFitWidth=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}}),Object.defineProperty(Ps.prototype,"autoFitHeight",{get:function(){return this._autoFitHeight},set:function(e){this._autoFitHeight!==e&&(this._autoFitHeight=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}}),Object.defineProperty(Ps.prototype,"maxLines",{get:function(){return this._maxLines},set:function(e){this._maxLines===e||null===e&&-1===this._maxLines||(this._maxLines=null===e?-1:e,this.font&&this._wrapLines&&this._updateText())}}),Object.defineProperty(Ps.prototype,"enableMarkup",{get:function(){return this._enableMarkup},set:function(e){e=!!e,this._enableMarkup!==e&&(this._enableMarkup=e,this.font&&this._updateText())}}),Object.defineProperty(Ps.prototype,"symbols",{get:function(){return this._symbols}}),Object.defineProperty(Ps.prototype,"symbolColors",{get:function(){return null===this._symbolColors?null:this._symbolColors.map(function(e){return this._colorPalette.slice(3*e,3*e+3)},this)}}),Object.defineProperty(Ps.prototype,"rtl",{get:function(){return this._rtl}}),Object.defineProperty(Ps.prototype,"rangeStart",{get:function(){return this._rangeStart},set:function(e){(e=Math.max(0,Math.min(e,this._symbols.length)))!==this._rangeStart&&(this._rangeStart=e,this._updateRenderRange())}}),Object.defineProperty(Ps.prototype,"rangeEnd",{get:function(){return this._rangeEnd},set:function(e){(e=Math.max(this._rangeStart,Math.min(e,this._symbols.length)))!==this._rangeEnd&&(this._rangeEnd=e,this._updateRenderRange())}});var Gc=new v,jc=new v,Wc=new x,Hc=new x,Xc=new x,qc=new x;As.prototype=Object.create(Ui.prototype),As.prototype.constructor=As,Object.assign(As.prototype,{_patch:function(){this.entity._sync=this._sync,this.entity.setPosition=this._setPosition,this.entity.setLocalPosition=this._setLocalPosition},_unpatch:function(){this.entity._sync=ut.prototype._sync,this.entity.setPosition=ut.prototype.setPosition,this.entity.setLocalPosition=ut.prototype.setLocalPosition},_setPosition:function(){var e=new v,t=new x;return function(i,s,n){if(!this.element.screen)return ut.prototype.setPosition.call(this,i,s,n);i instanceof v?e.copy(i):e.set(i,s,n),this.getWorldTransform(),t.copy(this.element._screenToWorld).invert(),t.transformPoint(e,this.localPosition),this._dirtyLocal||this._dirtifyLocal()}}(),_setLocalPosition:function(e,t,i){e instanceof v?this.localPosition.copy(e):this.localPosition.set(e,t,i),e=this.element,t=this.localPosition,i=e._pivot,e._margin.x=t.x-e._calculatedWidth*i.x,e._margin.z=e._localAnchor.z-e._localAnchor.x-e._calculatedWidth-e._margin.x,e._margin.y=t.y-e._calculatedHeight*i.y,e._margin.w=e._localAnchor.w-e._localAnchor.y-e._calculatedHeight-e._margin.y,this._dirtyLocal||this._dirtifyLocal()},_sync:function(){var e=this.element,t=e.screen;if(t){if(e._anchorDirty){var i=0,s=1;if(this._parent&&this._parent.element){var n=this._parent.element.calculatedWidth,r=this._parent.element.calculatedHeight;i=this._parent.element.pivot.x,s=this._parent.element.pivot.y}else n=(r=t.screen.resolution).x/t.screen.scale,r=r.y/t.screen.scale;e._anchorTransform.setTranslate(n*(e.anchor.x-i),-r*(s-e.anchor.y),0),e._anchorDirty=!1,e._calculateLocalAnchors()}e._sizeDirty&&e._calculateSize(!1,!1)}if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),n=this.localPosition,i=e._pivot,e._margin.x=n.x-e._calculatedWidth*i.x,e._margin.z=e._localAnchor.z-e._localAnchor.x-e._calculatedWidth-e._margin.x,e._margin.y=n.y-e._calculatedHeight*i.y,e._margin.w=e._localAnchor.w-e._localAnchor.y-e._calculatedHeight-e._margin.y,this._dirtyLocal=!1),!t)return this._dirtyWorld&&(e._cornersDirty=!0,e._canvasCornersDirty=!0,e._worldCornersDirty=!0),ut.prototype._sync.call(this);this._dirtyWorld&&(null===this._parent?this.worldTransform.copy(this.localTransform):(this._parent.element?e._screenToWorld.mul2(this._parent.element._modelTransform,e._anchorTransform):e._screenToWorld.copy(e._anchorTransform),e._modelTransform.mul2(e._screenToWorld,this.localTransform),t?(e._screenToWorld.mul2(t.screen._screenMatrix,e._screenToWorld),t.screen.screenSpace||e._screenToWorld.mul2(t.worldTransform,e._screenToWorld),this.worldTransform.mul2(e._screenToWorld,this.localTransform),(n=e._parentWorldTransform).setIdentity(),(i=this._parent)&&i.element&&i!==t&&(Wc.setTRS(v.ZERO,i.getLocalRotation(),i.getLocalScale()),n.mul2(i.element._parentWorldTransform,Wc)),Gc.set(0,0,this.localPosition.z),jc.set(e._absLeft+e._pivot.x*e.calculatedWidth,e._absBottom+e._pivot.y*e.calculatedHeight,0),Wc.setTranslate(-jc.x,-jc.y,-jc.z),Hc.setTRS(Gc,this.getLocalRotation(),this.getLocalScale()),Xc.setTranslate(jc.x,jc.y,jc.z),e._screenTransform.mul2(e._parentWorldTransform,Xc).mul(Hc).mul(Wc),e._cornersDirty=!0,e._canvasCornersDirty=!0,e._worldCornersDirty=!0):this.worldTransform.copy(e._modelTransform)),this._dirtyWorld=!1)},_onInsert:function(e){e=this._parseUpToScreen(),this.entity._dirtifyWorld(),this._updateScreen(e.screen),this._dirtifyMask()},_dirtifyMask:function(){for(var e=this.entity;e;){var t=e.parent;if((null===t||t.screen)&&e.element){this.system._prerender&&this.system._prerender.length||(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));var i=this.system._prerender.indexOf(this.entity);0<=i&&this.system._prerender.splice(i,1),0>this.system._prerender.indexOf(e)&&this.system._prerender.push(e)}e=t}},_onPrerender:function(){for(var e=0;e<this.system._prerender.length;e++){var t=this.system._prerender[e];t.element&&t.element.syncMask(1)}this.system._prerender.length=0},_bindScreen:function(e){e.on("set:resolution",this._onScreenResize,this),e.on("set:referenceresolution",this._onScreenResize,this),e.on("set:scaleblend",this._onScreenResize,this),e.on("set:screenspace",this._onScreenSpaceChange,this),e.on("remove",this._onScreenRemove,this)},_unbindScreen:function(e){e.off("set:resolution",this._onScreenResize,this),e.off("set:referenceresolution",this._onScreenResize,this),e.off("set:scaleblend",this._onScreenResize,this),e.off("set:screenspace",this._onScreenSpaceChange,this),e.off("remove",this._onScreenRemove,this)},_updateScreen:function(e){this.screen&&this.screen!==e&&this._unbindScreen(this.screen.screen);var t=this.screen;(this.screen=e)&&this._bindScreen(this.screen.screen),this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("set:screen",this.screen,t),this._anchorDirty=!0;for(var i=0,s=(t=this.entity.children).length;i<s;i++)t[i].element&&t[i].element._updateScreen(e);this.screen&&this.screen.screen.syncDrawOrder()},syncMask:function(e){var t=this._parseUpToScreen();this._updateMask(t.mask,e)},_setMaskedBy:function(e){var t=this._image||this._text;if(e){var i=new _s({ref:e.element._image._maskRef,func:2});t&&t._setStencil&&t._setStencil(i),this._maskedBy=e}else t&&t._setStencil&&t._setStencil(null),this._maskedBy=null},_updateMask:function(e,t){var i;e?(this._setMaskedBy(e),this.mask&&(e=new _s({ref:e.element._image._maskRef,func:2,zpass:3}),this._image._setStencil(e),this._image._maskRef=t,t++,e=this.entity)):(this._setMaskedBy(null),this.mask&&(e=new _s({ref:t,func:7,zpass:2}),this._image._setStencil(e),this._image._maskRef=t,t++,e=this.entity));var s=this.entity.children,n=0;for(i=s.length;n<i;n++)s[n].element&&s[n].element._updateMask(e,t)},_parseUpToScreen:function(){for(var e={screen:null,mask:null},t=this.entity._parent;t&&!t.screen;)t.element&&t.element.mask&&!e.mask&&(e.mask=t),t=t.parent;return t&&t.screen&&(e.screen=t),e},_onScreenResize:function(e){this._worldCornersDirty=this._cornersDirty=this._anchorDirty=!0,this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("screen:set:resolution",e)},_onScreenSpaceChange:function(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace)},_onScreenRemove:function(){this.screen&&!this.screen._destroying&&this._updateScreen(null)},_calculateLocalAnchors:function(){var e=1e3,t=1e3,i=this.entity._parent;i&&i.element?(e=i.element.calculatedWidth,t=i.element.calculatedHeight):this.screen&&(t=this.screen.screen.resolution,i=this.screen.screen.scale,e=t.x/i,t=t.y/i),this._localAnchor.set(this._anchor.x*e,this._anchor.y*t,this._anchor.z*e,this._anchor.w*t)},getOffsetPosition:function(e,t){var i=this.entity.getLocalPosition().clone();return i.x+=e,i.y+=t,this._screenToWorld.transformPoint(i,i),i},onLayersChanged:function(e,t){this.addModelToLayers(this._image?this._image._model:this._text._model),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(e){0>this.layers.indexOf(e.id)||(this._image?e.addMeshInstances(this._image._model.meshInstances):this._text&&e.addMeshInstances(this._text._model.meshInstances))},onLayerRemoved:function(e){0>this.layers.indexOf(e.id)||(this._image?e.removeMeshInstances(this._image._model.meshInstances):this._text&&e.removeMeshInstances(this._text._model.meshInstances))},onEnable:function(){this._image&&this._image.onEnable(),this._text&&this._text.onEnable(),this._group&&this._group.onEnable(),this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),0<=this._batchGroupId&&this.system.app.batcher.insert(le.ELEMENT,this.batchGroupId,this.entity),this.fire("enableelement")},onDisable:function(){this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this._image&&this._image.onDisable(),this._text&&this._text.onDisable(),this._group&&this._group.onDisable(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),0<=this._batchGroupId&&this.system.app.batcher.remove(le.ELEMENT,this.batchGroupId,this.entity),this.fire("disableelement")},onRemove:function(){this.entity.off("insert",this._onInsert,this),this._unpatch(),this._image&&this._image.destroy(),this._text&&this._text.destroy(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder()),this.off()},_calculateSize:function(e,t){if(this.entity._parent||this.screen){this._calculateLocalAnchors();var i=this._absRight-this._absLeft,s=this._absTop-this._absBottom;e?this._setWidth(i):this._setCalculatedWidth(i,!1),t?this._setHeight(s):this._setCalculatedHeight(s,!1),(e=this.entity.getLocalPosition()).x=this._margin.x+this._calculatedWidth*this._pivot.x,e.y=this._margin.y+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(e),this._sizeDirty=!1}},_setWidth:function(e){this._width=e,this._setCalculatedWidth(e,!1),this.fire("set:width",this._width)},_setHeight:function(e){this._height=e,this._setCalculatedHeight(e,!1),this.fire("set:height",this._height)},_setCalculatedWidth:function(e,t){1e-4>=Math.abs(e-this._calculatedWidth)||(this._calculatedWidth=e,this.entity._dirtifyLocal(),t&&(e=this.entity.getLocalPosition(),this._margin.x=e.x-this._calculatedWidth*this._pivot.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x),this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight))},_setCalculatedHeight:function(e,t){1e-4>=Math.abs(e-this._calculatedHeight)||(this._calculatedHeight=e,this.entity._dirtifyLocal(),t&&(e=this.entity.getLocalPosition(),this._margin.y=e.y-this._calculatedHeight*this._pivot.y,this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y),this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight))},_flagChildrenAsDirty:function(){var e,t=this.entity._children,i=0;for(e=t.length;i<e;i++)t[i].element&&(t[i].element._anchorDirty=!0,t[i].element._sizeDirty=!0)},addModelToLayers:function(e){var t;this._addedModels.push(e);for(var i=0;i<this.layers.length;i++)(t=this.system.app.scene.layers.getLayerById(this.layers[i]))&&t.addMeshInstances(e.meshInstances)},removeModelFromLayers:function(e){var t=this._addedModels.indexOf(e);0<=t&&this._addedModels.splice(t,1);for(var i=0;i<this.layers.length;i++)(t=this.system.app.scene.layers.getLayerById(this.layers[i]))&&t.removeMeshInstances(e.meshInstances)},getMaskOffset:function(){var e=this.system.app.frame;return this._offsetReadAt!==e&&(this._maskOffset=.5,this._offsetReadAt=e),e=this._maskOffset,this._maskOffset-=.001,e},isVisibleForCamera:function(e){if(this.maskedBy){e=this.maskedBy.element.screenCorners;var t=Math.min(Math.min(e[0].x,e[1].x),Math.min(e[2].x,e[3].x)),i=Math.max(Math.max(e[0].x,e[1].x),Math.max(e[2].x,e[3].x)),s=Math.min(Math.min(e[0].y,e[1].y),Math.min(e[2].y,e[3].y));e=Math.max(Math.max(e[0].y,e[1].y),Math.max(e[2].y,e[3].y))}else{t=this.system.app.graphicsDevice.width;var n=this.system.app.graphicsDevice.height;i=e._rect.width*t,s=e._rect.height*n,i=(t*=e._rect.x)+i,s=(e=(1-e._rect.y)*n)-s}n=this.screenCorners;var r=Math.min(Math.min(n[0].x,n[1].x),Math.min(n[2].x,n[3].x)),a=Math.min(Math.min(n[0].y,n[1].y),Math.min(n[2].y,n[3].y)),o=Math.max(Math.max(n[0].y,n[1].y),Math.max(n[2].y,n[3].y));return!(Math.max(Math.max(n[0].x,n[1].x),Math.max(n[2].x,n[3].x))<t||r>i||a>e||o<s)},_isScreenSpace:function(){return!(!this.screen||!this.screen.screen)&&this.screen.screen.screenSpace},_isScreenCulled:function(){return!(!this.screen||!this.screen.screen)&&this.screen.screen.cull}}),Object.defineProperty(As.prototype,"type",{get:function(){return this._type},set:function(e){e!==this._type&&(this._type=e,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),"image"===e?this._image=new ys(this):"text"===e&&(this._text=new Ps(this)))}}),Object.defineProperty(As.prototype,"layers",{get:function(){return this._layers},set:function(e){var t,i,s;if(this._addedModels.length)for(t=0;t<this._layers.length;t++)if(s=this.system.app.scene.layers.getLayerById(this._layers[t]))for(i=0;i<this._addedModels.length;i++)s.removeMeshInstances(this._addedModels[i].meshInstances);if(this._layers=e,this.enabled&&this.entity.enabled&&this._addedModels.length)for(t=0;t<this._layers.length;t++)if(s=this.system.app.scene.layers.getLayerById(this._layers[t]))for(i=0;i<this._addedModels.length;i++)s.addMeshInstances(this._addedModels[i].meshInstances)}}),Object.defineProperty(As.prototype,"drawOrder",{get:function(){return this._drawOrder},set:function(e){var t=0;this.screen&&(t=this.screen.screen.priority),16777215<e&&(e=16777215),this._drawOrder=(t<<24)+e,this.fire("set:draworder",this._drawOrder)}}),Object.defineProperty(As.prototype,"_absLeft",{get:function(){return this._localAnchor.x+this._margin.x}}),Object.defineProperty(As.prototype,"_absRight",{get:function(){return this._localAnchor.z-this._margin.z}}),Object.defineProperty(As.prototype,"_absTop",{get:function(){return this._localAnchor.w-this._margin.w}}),Object.defineProperty(As.prototype,"_absBottom",{get:function(){return this._localAnchor.y+this._margin.y}}),Object.defineProperty(As.prototype,"margin",{get:function(){return this._margin},set:function(e){this._margin.copy(e),this._calculateSize(!0,!0),this.fire("set:margin",this._margin)}}),Object.defineProperty(As.prototype,"left",{get:function(){return this._margin.x},set:function(e){this._margin.x=e;var t=this.entity.getLocalPosition();this._setWidth(this._absRight-(this._localAnchor.x+e)),t.x=e+this._calculatedWidth*this._pivot.x,this.entity.setLocalPosition(t)}}),Object.defineProperty(As.prototype,"right",{get:function(){return this._margin.z},set:function(e){this._margin.z=e;var t=this.entity.getLocalPosition();this._setWidth(this._localAnchor.z-e-this._absLeft),t.x=this._localAnchor.z-this._localAnchor.x-e-this._calculatedWidth*(1-this._pivot.x),this.entity.setLocalPosition(t)}}),Object.defineProperty(As.prototype,"top",{get:function(){return this._margin.w},set:function(e){this._margin.w=e;var t=this.entity.getLocalPosition();this._setHeight(this._localAnchor.w-e-this._absBottom),t.y=this._localAnchor.w-this._localAnchor.y-e-this._calculatedHeight*(1-this._pivot.y),this.entity.setLocalPosition(t)}}),Object.defineProperty(As.prototype,"bottom",{get:function(){return this._margin.y},set:function(e){this._margin.y=e;var t=this.entity.getLocalPosition();this._setHeight(this._absTop-(this._localAnchor.y+e)),t.y=e+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(t)}}),Object.defineProperty(As.prototype,"width",{get:function(){return this._width},set:function(e){this._width=e,this._hasSplitAnchorsX||this._setCalculatedWidth(e,!0),this.fire("set:width",this._width)}}),Object.defineProperty(As.prototype,"height",{get:function(){return this._height},set:function(e){this._height=e,this._hasSplitAnchorsY||this._setCalculatedHeight(e,!0),this.fire("set:height",this._height)}}),Object.defineProperty(As.prototype,"calculatedWidth",{get:function(){return this._calculatedWidth},set:function(e){this._setCalculatedWidth(e,!0)}}),Object.defineProperty(As.prototype,"calculatedHeight",{get:function(){return this._calculatedHeight},set:function(e){this._setCalculatedHeight(e,!0)}}),Object.defineProperty(As.prototype,"pivot",{get:function(){return this._pivot},set:function(e){var t=this._pivot.x,i=this._pivot.y;e instanceof T?this._pivot.set(e.x,e.y):this._pivot.set(e[0],e[1]),e=this._margin.x+this._margin.z,t=this._pivot.x-t,this._margin.x+=e*t,this._margin.z-=e*t,t=this._margin.y+this._margin.w,i=this._pivot.y-i,this._margin.y+=t*i,this._margin.w-=t*i,this._worldCornersDirty=this._cornersDirty=this._anchorDirty=!0,this._calculateSize(!1,!1),this._flagChildrenAsDirty(),this.fire("set:pivot",this._pivot)}}),Object.defineProperty(As.prototype,"anchor",{get:function(){return this._anchor},set:function(e){e instanceof b?this._anchor.set(e.x,e.y,e.z,e.w):this._anchor.set(e[0],e[1],e[2],e[3]),this.entity._parent||this.screen?this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY):this._calculateLocalAnchors(),this._anchorDirty=!0,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:anchor",this._anchor)}}),Object.defineProperty(As.prototype,"_hasSplitAnchorsX",{get:function(){return.001<Math.abs(this._anchor.x-this._anchor.z)}}),Object.defineProperty(As.prototype,"_hasSplitAnchorsY",{get:function(){return.001<Math.abs(this._anchor.y-this._anchor.w)}}),Object.defineProperty(As.prototype,"aabb",{get:function(){return this._image?this._image.aabb:this._text?this._text.aabb:null}}),Object.defineProperty(As.prototype,"screenCorners",{get:function(){if(!this._cornersDirty||!this.screen)return this._screenCorners;var e=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0),this._screenCorners[1].set(this._absRight,this._absBottom,0),this._screenCorners[2].set(this._absRight,this._absTop,0),this._screenCorners[3].set(this._absLeft,this._absTop,0);for(var t=this.screen.screen.screenSpace,i=0;4>i;i++)this._screenTransform.transformPoint(this._screenCorners[i],this._screenCorners[i]),t&&this._screenCorners[i].scale(this.screen.screen.scale),e&&this._screenCorners[i].add(e);return this._cornersDirty=!1,this._worldCornersDirty=this._canvasCornersDirty=!0,this._screenCorners}}),Object.defineProperty(As.prototype,"canvasCorners",{get:function(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;for(var e=this.system.app.graphicsDevice,t=this.screenCorners,i=e.canvas.clientWidth/e.width,s=e.canvas.clientHeight/e.height,n=0;4>n;n++)this._canvasCorners[n].set(t[n].x*i,(e.height-t[n].y)*s);return this._canvasCornersDirty=!1,this._canvasCorners}}),Object.defineProperty(As.prototype,"worldCorners",{get:function(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){var e=this.screenCorners;if(!this.screen.screen.screenSpace){Wc.copy(this.screen.screen._screenMatrix),Wc.data[13]=-Wc.data[13],Wc.mul2(this.screen.getWorldTransform(),Wc);for(var t=0;4>t;t++)Wc.transformPoint(e[t],this._worldCorners[t])}}else e=this.entity.getLocalPosition(),Wc.setTranslate(-e.x,-e.y,-e.z),Hc.setTRS(v.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),Xc.setTranslate(e.x,e.y,e.z),qc.copy(this.entity.parent.getWorldTransform()),qc.mul(Xc).mul(Hc).mul(Wc),Gc.set(e.x-this.pivot.x*this.calculatedWidth,e.y-this.pivot.y*this.calculatedHeight,e.z),qc.transformPoint(Gc,this._worldCorners[0]),Gc.set(e.x+(1-this.pivot.x)*this.calculatedWidth,e.y-this.pivot.y*this.calculatedHeight,e.z),qc.transformPoint(Gc,this._worldCorners[1]),Gc.set(e.x+(1-this.pivot.x)*this.calculatedWidth,e.y+(1-this.pivot.y)*this.calculatedHeight,e.z),qc.transformPoint(Gc,this._worldCorners[2]),Gc.set(e.x-this.pivot.x*this.calculatedWidth,e.y+(1-this.pivot.y)*this.calculatedHeight,e.z),qc.transformPoint(Gc,this._worldCorners[3]);return this._worldCornersDirty=!1,this._worldCorners}}),Object.defineProperty(As.prototype,"textWidth",{get:function(){return this._text?this._text.width:0}}),Object.defineProperty(As.prototype,"textHeight",{get:function(){return this._text?this._text.height:0}}),Object.defineProperty(As.prototype,"useInput",{get:function(){return this._useInput},set:function(e){this._useInput!==e&&(this._useInput=e,this.system.app.elementInput&&(e?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this)),this.fire("set:useInput",e))}}),Object.defineProperty(As.prototype,"batchGroupId",{get:function(){return this._batchGroupId},set:function(e){this._batchGroupId!==e&&(this.entity.enabled&&0<=this._batchGroupId&&this.system.app.batcher.remove(le.ELEMENT,this.batchGroupId,this.entity),this.entity.enabled&&0<=e&&this.system.app.batcher.insert(le.ELEMENT,e,this.entity),0>e&&0<=this._batchGroupId&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):this._text&&this._text._model&&this.addModelToLayers(this._text._model)),this._batchGroupId=e)}}),Object.defineProperty(As.prototype,"maskedBy",{get:function(){return this._maskedBy}});var Yc=function(e){Object.defineProperty(As.prototype,e,{get:function(){return this._text?this._text[e]:this._image?this._image[e]:null},set:function(t){this._text?this._text[e]=t:this._image&&(this._image[e]=t)}})};Yc("fontSize"),Yc("minFontSize"),Yc("maxFontSize"),Yc("maxLines"),Yc("autoFitWidth"),Yc("autoFitHeight"),Yc("color"),Yc("font"),Yc("fontAsset"),Yc("spacing"),Yc("lineHeight"),Yc("wrapLines"),Yc("lines"),Yc("alignment"),Yc("autoWidth"),Yc("autoHeight"),Yc("rtlReorder"),Yc("unicodeConverter"),Yc("text"),Yc("key"),Yc("texture"),Yc("textureAsset"),Yc("material"),Yc("materialAsset"),Yc("sprite"),Yc("spriteAsset"),Yc("spriteFrame"),Yc("pixelsPerUnit"),Yc("opacity"),Yc("rect"),Yc("mask"),Yc("outlineColor"),Yc("outlineThickness"),Yc("shadowColor"),Yc("shadowOffset"),Yc("enableMarkup"),Yc("rangeStart"),Yc("rangeEnd");var Kc=["enabled"];Cs.prototype=Object.create(zi.prototype),Cs.prototype.constructor=Cs,Ui._buildAccessors(As.prototype,Kc),Object.assign(Cs.prototype,{destroy:function(){this._defaultTexture.destroy()},initializeComponentData:function(e,t,s){e._beingInitialized=!0,void 0!==t.anchor&&(t.anchor instanceof b?e.anchor.copy(t.anchor):e.anchor.set(t.anchor[0],t.anchor[1],t.anchor[2],t.anchor[3])),void 0!==t.pivot&&(t.pivot instanceof T?e.pivot.copy(t.pivot):e.pivot.set(t.pivot[0],t.pivot[1]));var n=.001<Math.abs(e.anchor.x-e.anchor.z),r=.001<Math.abs(e.anchor.y-e.anchor.w),a=!1;void 0!==t.margin&&(t.margin instanceof b?e.margin.copy(t.margin):e._margin.set(t.margin[0],t.margin[1],t.margin[2],t.margin[3]),a=!0),void 0!==t.left&&(e._margin.x=t.left,a=!0),void 0!==t.bottom&&(e._margin.y=t.bottom,a=!0),void 0!==t.right&&(e._margin.z=t.right,a=!0),void 0!==t.top&&(e._margin.w=t.top,a=!0),a&&(e.margin=e._margin),a=!1,void 0===t.width||n?n&&(a=!0):e.width=t.width,void 0===t.height||r?r&&(a=!0):e.height=t.height,a&&(e.anchor=e.anchor),void 0!==t.enabled&&(e.enabled=t.enabled),void 0!==t.useInput&&(e.useInput=t.useInput),e.batchGroupId=void 0===t.batchGroupId||null===t.batchGroupId?-1:t.batchGroupId,t.layers&&"array"===i(t.layers)&&(e.layers=t.layers.slice(0)),e.type=t.type,"image"===e.type?(void 0!==t.rect&&(e.rect=t.rect),void 0!==t.color&&((n=t.color)instanceof h||(n=new h(t.color[0],t.color[1],t.color[2])),e.color=n),void 0!==t.opacity&&(e.opacity=t.opacity),void 0!==t.textureAsset&&(e.textureAsset=t.textureAsset),t.texture&&(e.texture=t.texture),void 0!==t.spriteAsset&&(e.spriteAsset=t.spriteAsset),t.sprite&&(e.sprite=t.sprite),void 0!==t.spriteFrame&&(e.spriteFrame=t.spriteFrame),void 0!==t.pixelsPerUnit&&null!==t.pixelsPerUnit&&(e.pixelsPerUnit=t.pixelsPerUnit),void 0!==t.materialAsset&&(e.materialAsset=t.materialAsset),t.material&&(e.material=t.material),void 0!==t.mask&&(e.mask=t.mask)):"text"===e.type&&(void 0!==t.autoWidth&&(e.autoWidth=t.autoWidth),void 0!==t.autoHeight&&(e.autoHeight=t.autoHeight),void 0!==t.rtlReorder&&(e.rtlReorder=t.rtlReorder),void 0!==t.unicodeConverter&&(e.unicodeConverter=t.unicodeConverter),null!==t.text&&void 0!==t.text?e.text=t.text:null!==t.key&&void 0!==t.key&&(e.key=t.key),void 0!==t.color&&((n=t.color)instanceof h||(n=new h(n[0],n[1],n[2])),e.color=n),void 0!==t.opacity&&(e.opacity=t.opacity),void 0!==t.spacing&&(e.spacing=t.spacing),void 0!==t.fontSize&&(e.fontSize=t.fontSize,t.lineHeight||(e.lineHeight=t.fontSize)),void 0!==t.lineHeight&&(e.lineHeight=t.lineHeight),void 0!==t.maxLines&&(e.maxLines=t.maxLines),void 0!==t.wrapLines&&(e.wrapLines=t.wrapLines),void 0!==t.minFontSize&&(e.minFontSize=t.minFontSize),void 0!==t.maxFontSize&&(e.maxFontSize=t.maxFontSize),t.autoFitWidth&&(e.autoFitWidth=t.autoFitWidth),t.autoFitHeight&&(e.autoFitHeight=t.autoFitHeight),void 0!==t.fontAsset&&(e.fontAsset=t.fontAsset),void 0!==t.font&&(e.font=t.font),void 0!==t.alignment&&(e.alignment=t.alignment),void 0!==t.outlineColor&&(e.outlineColor=t.outlineColor),void 0!==t.outlineThickness&&(e.outlineThickness=t.outlineThickness),void 0!==t.shadowColor&&(e.shadowColor=t.shadowColor),void 0!==t.shadowOffset&&(e.shadowOffset=t.shadowOffset),void 0!==t.enableMarkup&&(e.enableMarkup=t.enableMarkup)),(n=e._parseUpToScreen()).screen&&e._updateScreen(n.screen),zi.prototype.initializeComponentData.call(this,e,t,s),e._beingInitialized=!1,"image"===e.type&&e._image._meshDirty&&e._image._updateMesh(e._image.mesh)},onRemoveComponent:function(e,t){t.onRemove()},cloneComponent:function(e,t){var i={enabled:(e=e.element).enabled,width:e.width,height:e.height,anchor:e.anchor.clone(),pivot:e.pivot.clone(),margin:e.margin.clone(),alignment:e.alignment&&e.alignment.clone()||e.alignment,autoWidth:e.autoWidth,autoHeight:e.autoHeight,type:e.type,rect:e.rect&&e.rect.clone()||e.rect,rtlReorder:e.rtlReorder,unicodeConverter:e.unicodeConverter,materialAsset:e.materialAsset,material:e.material,color:e.color&&e.color.clone()||e.color,opacity:e.opacity,textureAsset:e.textureAsset,texture:e.texture,spriteAsset:e.spriteAsset,sprite:e.sprite,spriteFrame:e.spriteFrame,pixelsPerUnit:e.pixelsPerUnit,spacing:e.spacing,lineHeight:e.lineHeight,wrapLines:e.wrapLines,layers:e.layers,fontSize:e.fontSize,minFontSize:e.minFontSize,maxFontSize:e.maxFontSize,autoFitWidth:e.autoFitWidth,autoFitHeight:e.autoFitHeight,maxLines:e.maxLines,fontAsset:e.fontAsset,font:e.font,useInput:e.useInput,batchGroupId:e.batchGroupId,mask:e.mask,outlineColor:e.outlineColor&&e.outlineColor.clone()||e.outlineColor,outlineThickness:e.outlineThickness,shadowColor:e.shadowColor&&e.shadowColor.clone()||e.shadowColor,shadowOffset:e.shadowOffset&&e.shadowOffset.clone()||e.shadowOffset,enableMarkup:e.enableMarkup};return void 0!==e.key&&null!==e.key?i.key=e.key:i.text=e.text,this.addComponent(t,i)},getTextElementMaterial:function(e,t){return e?t?(this.defaultScreenSpaceTextMaterial||(this.defaultScreenSpaceTextMaterial=new Nn,this.defaultScreenSpaceTextMaterial.name="defaultScreenSpaceTextMaterial",this.defaultScreenSpaceTextMaterial.msdfMap=this._defaultTexture,this.defaultScreenSpaceTextMaterial.useLighting=!1,this.defaultScreenSpaceTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceTextMaterial.useFog=!1,this.defaultScreenSpaceTextMaterial.useSkybox=!1,this.defaultScreenSpaceTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceTextMaterial.emissive.set(1,1,1),this.defaultScreenSpaceTextMaterial.opacity=.5,this.defaultScreenSpaceTextMaterial.blendType=4,this.defaultScreenSpaceTextMaterial.depthWrite=!1,this.defaultScreenSpaceTextMaterial.depthTest=!1,this.defaultScreenSpaceTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceTextMaterial.update()),this.defaultScreenSpaceTextMaterial):(this.defaultScreenSpaceBitmapTextMaterial||(this.defaultScreenSpaceBitmapTextMaterial=new Nn,this.defaultScreenSpaceBitmapTextMaterial.name="defaultScreenSpaceBitmapTextMaterial",this.defaultScreenSpaceBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultScreenSpaceBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.emissiveTint=!0,this.defaultScreenSpaceBitmapTextMaterial.opacity=.5,this.defaultScreenSpaceBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.opacityMapChannel="a",this.defaultScreenSpaceBitmapTextMaterial.useLighting=!1,this.defaultScreenSpaceBitmapTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceBitmapTextMaterial.useFog=!1,this.defaultScreenSpaceBitmapTextMaterial.useSkybox=!1,this.defaultScreenSpaceBitmapTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceBitmapTextMaterial.blendType=4,this.defaultScreenSpaceBitmapTextMaterial.depthWrite=!1,this.defaultScreenSpaceBitmapTextMaterial.depthTest=!1,this.defaultScreenSpaceBitmapTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceBitmapTextMaterial.update()),this.defaultScreenSpaceBitmapTextMaterial):t?(this.defaultTextMaterial||(this.defaultTextMaterial=new Nn,this.defaultTextMaterial.name="defaultTextMaterial",this.defaultTextMaterial.msdfMap=this._defaultTexture,this.defaultTextMaterial.useLighting=!1,this.defaultTextMaterial.useGammaTonemap=!1,this.defaultTextMaterial.useFog=!1,this.defaultTextMaterial.useSkybox=!1,this.defaultTextMaterial.diffuse.set(0,0,0),this.defaultTextMaterial.emissive.set(1,1,1),this.defaultTextMaterial.opacity=.5,this.defaultTextMaterial.blendType=4,this.defaultTextMaterial.depthWrite=!1,this.defaultTextMaterial.emissiveVertexColor=!0,this.defaultTextMaterial.update()),this.defaultTextMaterial):(this.defaultBitmapTextMaterial||(this.defaultBitmapTextMaterial=new Nn,this.defaultBitmapTextMaterial.name="defaultBitmapTextMaterial",this.defaultBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultBitmapTextMaterial.emissiveTint=!0,this.defaultBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacity=.5,this.defaultBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacityMapChannel="a",this.defaultBitmapTextMaterial.useLighting=!1,this.defaultBitmapTextMaterial.useGammaTonemap=!1,this.defaultBitmapTextMaterial.useFog=!1,this.defaultBitmapTextMaterial.useSkybox=!1,this.defaultBitmapTextMaterial.diffuse.set(0,0,0),this.defaultBitmapTextMaterial.blendType=4,this.defaultBitmapTextMaterial.depthWrite=!1,this.defaultBitmapTextMaterial.emissiveVertexColor=!0,this.defaultBitmapTextMaterial.update()),this.defaultBitmapTextMaterial)},_createBaseImageMaterial:function(){var e=new Nn;return e.diffuse.set(0,0,0),e.emissive.set(.5,.5,.5),e.emissiveMap=this._defaultTexture,e.emissiveTint=!0,e.opacityMap=this._defaultTexture,e.opacityMapChannel="a",e.opacityTint=!0,e.opacity=0,e.useLighting=!1,e.useGammaTonemap=!1,e.useFog=!1,e.useSkybox=!1,e.blendType=4,e.depthWrite=!1,e},getImageElementMaterial:function(e,t,i,s){return e?t?i?(this.defaultScreenSpaceImageMask9SlicedMaterial||(this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial",this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)),this.defaultScreenSpaceImageMask9SlicedMaterial):s?(this.defaultScreenSpaceImageMask9TiledMaterial||(this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone(),this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial",this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)),this.defaultScreenSpaceImageMask9TiledMaterial):(this.defaultScreenSpaceImageMaskMaterial||(this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaskMaterial.name="defaultScreenSpaceImageMaskMaterial",this.defaultScreenSpaceImageMaskMaterial.depthTest=!1,this.defaultScreenSpaceImageMaskMaterial.alphaTest=1,this.defaultScreenSpaceImageMaskMaterial.redWrite=!1,this.defaultScreenSpaceImageMaskMaterial.greenWrite=!1,this.defaultScreenSpaceImageMaskMaterial.blueWrite=!1,this.defaultScreenSpaceImageMaskMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial)),this.defaultScreenSpaceImageMaskMaterial):i?(this.defaultScreenSpaceImage9SlicedMaterial||(this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9SlicedMaterial.name="defaultScreenSpaceImage9SlicedMaterial",this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImage9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)),this.defaultScreenSpaceImage9SlicedMaterial):s?(this.defaultScreenSpaceImage9TiledMaterial||(this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9TiledMaterial.name="defaultScreenSpaceImage9TiledMaterial",this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImage9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)),this.defaultScreenSpaceImage9TiledMaterial):(this.defaultScreenSpaceImageMaterial||(this.defaultScreenSpaceImageMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial",this.defaultScreenSpaceImageMaterial.depthTest=!1,this.defaultScreenSpaceImageMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial)),this.defaultScreenSpaceImageMaterial):t?i?(this.defaultImage9SlicedMaskMaterial||(this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaskMaterial.name="defaultImage9SlicedMaskMaterial",this.defaultImage9SlicedMaskMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaskMaterial.alphaTest=1,this.defaultImage9SlicedMaskMaterial.redWrite=!1,this.defaultImage9SlicedMaskMaterial.greenWrite=!1,this.defaultImage9SlicedMaskMaterial.blueWrite=!1,this.defaultImage9SlicedMaskMaterial.alphaWrite=!1,this.defaultImage9SlicedMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)),this.defaultImage9SlicedMaskMaterial):s?(this.defaultImage9TiledMaskMaterial||(this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaskMaterial.name="defaultImage9TiledMaskMaterial",this.defaultImage9TiledMaskMaterial.nineSlicedMode=2,this.defaultImage9TiledMaskMaterial.alphaTest=1,this.defaultImage9TiledMaskMaterial.redWrite=!1,this.defaultImage9TiledMaskMaterial.greenWrite=!1,this.defaultImage9TiledMaskMaterial.blueWrite=!1,this.defaultImage9TiledMaskMaterial.alphaWrite=!1,this.defaultImage9TiledMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)),this.defaultImage9TiledMaskMaterial):(this.defaultImageMaskMaterial||(this.defaultImageMaskMaterial=this._createBaseImageMaterial(),this.defaultImageMaskMaterial.name="defaultImageMaskMaterial",this.defaultImageMaskMaterial.alphaTest=1,this.defaultImageMaskMaterial.redWrite=!1,this.defaultImageMaskMaterial.greenWrite=!1,this.defaultImageMaskMaterial.blueWrite=!1,this.defaultImageMaskMaterial.alphaWrite=!1,this.defaultImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaskMaterial)),this.defaultImageMaskMaterial):i?(this.defaultImage9SlicedMaterial||(this.defaultImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial",this.defaultImage9SlicedMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)),this.defaultImage9SlicedMaterial):s?(this.defaultImage9TiledMaterial||(this.defaultImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial",this.defaultImage9TiledMaterial.nineSlicedMode=2,this.defaultImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)),this.defaultImage9TiledMaterial):(this.defaultImageMaterial||(this.defaultImageMaterial=this._createBaseImageMaterial(),this.defaultImageMaterial.name="defaultImageMaterial",this.defaultImageMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaterial)),this.defaultImageMaterial)},registerUnicodeConverter:function(e){this._unicodeConverter=e},registerRtlReorder:function(e){this._rtlReorder=e},getUnicodeConverter:function(){return this._unicodeConverter},getRtlReorder:function(){return this._rtlReorder}}),Is.prototype=Object.create(Ui.prototype),Is.prototype.constructor=Is,Os("minWidth"),Os("minHeight"),Os("maxWidth"),Os("maxHeight"),Os("fitWidthProportion"),Os("fitHeightProportion"),Os("excludeFromLayout");var Zc=["enabled"],$c=function(e){zi.call(this,e),this.id="layoutchild",this.ComponentType=Is,this.DataType=Rs,this.schema=Zc};$c.prototype=Object.create(zi.prototype),$c.prototype.constructor=$c,Ui._buildAccessors(Is.prototype,Zc),Object.assign($c.prototype,{initializeComponentData:function(e,t,i){void 0!==t.enabled&&(e.enabled=t.enabled),void 0!==t.minWidth&&(e.minWidth=t.minWidth),void 0!==t.minHeight&&(e.minHeight=t.minHeight),void 0!==t.maxWidth&&(e.maxWidth=t.maxWidth),void 0!==t.maxHeight&&(e.maxHeight=t.maxHeight),void 0!==t.fitWidthProportion&&(e.fitWidthProportion=t.fitWidthProportion),void 0!==t.fitHeightProportion&&(e.fitHeightProportion=t.fitHeightProportion),void 0!==t.excludeFromLayout&&(e.excludeFromLayout=t.excludeFromLayout),zi.prototype.initializeComponentData.call(this,e,t,i)},cloneComponent:function(e,t){return e=e.layoutchild,this.addComponent(t,{enabled:e.enabled,minWidth:e.minWidth,minHeight:e.minHeight,maxWidth:e.maxWidth,maxHeight:e.maxHeight,fitWidthProportion:e.fitWidthProportion,fitHeightProportion:e.fitHeightProportion,excludeFromLayout:e.excludeFromLayout})}});var Qc=0,Jc={0:{axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"},1:{axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"}},ed={0:1,1:0},td={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},id={NONE:"NONE",APPLY_STRETCHING:"APPLY_STRETCHING",APPLY_SHRINKING:"APPLY_SHRINKING"},sd=new T,nd={};nd[0]=Ls(0),nd[1]=Ls(1),Object.assign(Ds.prototype,{calculateLayout:function(e,t){var i=nd[t.orientation];if(i)return i(e,t);throw Error("Unrecognized orientation value: "+t.orientation)}}),Fs.prototype=Object.create(Ui.prototype),Fs.prototype.constructor=Fs,Object.assign(Fs.prototype,{_isSelfOrChild:function(e){return e===this.entity||-1!==this.entity.children.indexOf(e)},_listenForReflowEvents:function(e,t){e.element&&(e.element[t]("enableelement",this._scheduleReflow,this),e.element[t]("disableelement",this._scheduleReflow,this),e.element[t]("resize",this._scheduleReflow,this),e.element[t]("set:pivot",this._scheduleReflow,this)),e.layoutchild&&(e.layoutchild[t]("set_enabled",this._scheduleReflow,this),e.layoutchild[t]("resize",this._scheduleReflow,this))},_onElementOrLayoutComponentAdd:function(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"on"),this._scheduleReflow())},_onElementOrLayoutComponentRemove:function(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"off"),this._scheduleReflow())},_onChildInsert:function(e){this._listenForReflowEvents(e,"on"),this._scheduleReflow()},_onChildRemove:function(e){this._listenForReflowEvents(e,"off"),this._scheduleReflow()},_scheduleReflow:function(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this)},reflow:function(){var e=this.entity.element,t=this.entity.children.filter(Ns).map(Bs);e&&0!==t.length&&(e={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new T(Math.max(e.calculatedWidth,0),Math.max(e.calculatedHeight,0))},this._isPerformingReflow=!0,t=this._layoutCalculator.calculateLayout(t,e),this._isPerformingReflow=!1,this.fire("reflow",t))},onEnable:function(){this._scheduleReflow()},onRemove:function(){this.entity.off("childinsert",this._onChildInsert,this),this.entity.off("childremove",this._onChildRemove,this),this._listenForReflowEvents(this.entity,"off"),this.entity.children.forEach(function(e){this._listenForReflowEvents(e,"off")}.bind(this)),this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this),this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,this)}}),ks("orientation"),ks("reverseX"),ks("reverseY"),ks("alignment"),ks("padding"),ks("spacing"),ks("widthFitting"),ks("heightFitting"),ks("wrap");var rd=["enabled"];zs.prototype=Object.create(zi.prototype),zs.prototype.constructor=zs,Ui._buildAccessors(Fs.prototype,rd),Object.assign(zs.prototype,{initializeComponentData:function(e,t,i){void 0!==t.enabled&&(e.enabled=t.enabled),void 0!==t.orientation&&(e.orientation=t.orientation),void 0!==t.reverseX&&(e.reverseX=t.reverseX),void 0!==t.reverseY&&(e.reverseY=t.reverseY),void 0!==t.alignment&&(t.alignment instanceof T?e.alignment.copy(t.alignment):e.alignment.set(t.alignment[0],t.alignment[1]),e.alignment=e.alignment),void 0!==t.padding&&(t.padding instanceof b?e.padding.copy(t.padding):e.padding.set(t.padding[0],t.padding[1],t.padding[2],t.padding[3]),e.padding=e.padding),void 0!==t.spacing&&(t.spacing instanceof T?e.spacing.copy(t.spacing):e.spacing.set(t.spacing[0],t.spacing[1]),e.spacing=e.spacing),void 0!==t.widthFitting&&(e.widthFitting=t.widthFitting),void 0!==t.heightFitting&&(e.heightFitting=t.heightFitting),void 0!==t.wrap&&(e.wrap=t.wrap),zi.prototype.initializeComponentData.call(this,e,t,i)},cloneComponent:function(e,t){return e=e.layoutgroup,this.addComponent(t,{enabled:e.enabled,orientation:e.orientation,reverseX:e.reverseX,reverseY:e.reverseY,alignment:e.alignment,padding:e.padding,spacing:e.spacing,widthFitting:e.widthFitting,heightFitting:e.heightFitting,wrap:e.wrap})},scheduleReflow:function(e){-1===this._reflowQueue.indexOf(e)&&this._reflowQueue.push(e)},_onPostUpdate:function(){this._processReflowQueue()},_processReflowQueue:function(){if(0!==this._reflowQueue.length)for(var e=0;0<this._reflowQueue.length;){var t=this._reflowQueue.slice();this._reflowQueue.length=0,t.sort(function(e,t){return e.entity.graphDepth-t.entity.graphDepth});for(var i=0;i<t.length;++i)t[i].reflow();if(100<=++e){console.warn("Max reflow iterations limit reached, bailing.");break}}},_onRemoveComponent:function(e,t){t.onRemove()}});var ad=new v,od=new v,hd=new v,ld={r:0,g:1,b:2,a:3},cd=function(){this._type=0,this._color=new h(.8,.8,.8),this._intensity=1,this.enabled=this._castShadows=!1,this.mask=1,this.isStatic=!1,this.key=0,this.bakeDir=!0,this.attenuationEnd=this.attenuationStart=10,this._shadowType=this._falloffMode=0,this._vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieOffsetSet=this._cookieTransformSet=!1,this._innerConeAngle=40,this._outerConeAngle=45,this._finalColor=new Float32Array([.8,.8,.8]);var e=Math.pow(this._finalColor[0],2.2);this._linearFinalColor=new Float32Array([e,e,e]),this._position=new v(0,0,0),this._direction=new v(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._outerConeAngleCos=Math.cos(this._outerConeAngle*Math.PI/180),this._shadowCamera=null,this._shadowMatrix=new x,this.shadowDistance=40,this._shadowResolution=1024,this.shadowBias=-5e-4,this._normalOffsetBias=0,this.shadowUpdateMode=2,this._node=this._scene=null,this._rendererParams=[],this._isVsm=!1,this._isPcf=!0,this._isCachedShadowMap=this._cacheShadowMap=!1,this._visibleLength=[0],this._visibleList=[[]],this._visibleCameraSettings=[]};Object.assign(cd.prototype,{destroy:function(){this._destroyShadowMap()},clone:function(){var e=new cd;return e.type=this._type,e.setColor(this._color),e.intensity=this._intensity,e.castShadows=this.castShadows,e.enabled=this.enabled,e.attenuationStart=this.attenuationStart,e.attenuationEnd=this.attenuationEnd,e.falloffMode=this._falloffMode,e.shadowType=this._shadowType,e.vsmBlurSize=this._vsmBlurSize,e.vsmBlurMode=this.vsmBlurMode,e.vsmBias=this.vsmBias,e.shadowUpdateMode=this.shadowUpdateMode,e.mask=this.mask,e.innerConeAngle=this._innerConeAngle,e.outerConeAngle=this._outerConeAngle,e.shadowBias=this.shadowBias,e.normalOffsetBias=this._normalOffsetBias,e.shadowResolution=this._shadowResolution,e.shadowDistance=this.shadowDistance,e},getColor:function(){return this._color},getBoundingSphere:function(e){if(2===this._type){var t=this.attenuationEnd,i=this._outerConeAngle,s=Math.cos(i*Hr.DEG_TO_RAD),n=this._node;ad.copy(n.up),ad.scale(.5*-t*s),ad.add(n.getPosition()),e.center=ad,od.copy(n.up),od.scale(-t),hd.copy(n.right),hd.scale(Math.sin(i*Hr.DEG_TO_RAD)*t),od.add(hd),e.radius=.5*od.length()}else 1===this._type&&(e.center=this._node.getPosition(),e.radius=this.attenuationEnd)},getBoundingBox:function(e){if(2===this._type){var t=this.attenuationEnd,i=this._node,s=Math.abs(Math.sin(this._outerConeAngle*Hr.DEG_TO_RAD)*t);e.center.set(0,.5*-t,0),e.halfExtents.set(s,.5*t,s),e.setFromTransformedAabb(e,i.getWorldTransform())}else 1===this._type&&(e.center.copy(this._node.getPosition()),e.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))},_updateFinalColor:function(){var e=this._color,t=e.r,i=e.g;e=e.b;var s=this._intensity,n=this._finalColor,r=this._linearFinalColor;n[0]=t*s,n[1]=i*s,n[2]=e*s,1<=s?(r[0]=Math.pow(t,2.2)*s,r[1]=Math.pow(i,2.2)*s,r[2]=Math.pow(e,2.2)*s):(r[0]=Math.pow(n[0],2.2),r[1]=Math.pow(n[1],2.2),r[2]=Math.pow(n[2],2.2))},setColor:function(){if(1===arguments.length)var e=arguments[0].r,t=arguments[0].g,i=arguments[0].b;else 3===arguments.length&&(e=arguments[0],t=arguments[1],i=arguments[2]);this._color.set(e,t,i),this._updateFinalColor()},_destroyShadowMap:function(){if(this._shadowCamera){if(!this._isCachedShadowMap){var e,t=this._shadowCamera.renderTarget;if(t)if(t.length)for(e=0;e<t.length;e++)t[e].colorBuffer&&t[e].colorBuffer.destroy(),t[e].destroy();else t.colorBuffer&&t.colorBuffer.destroy(),t.depthBuffer&&t.depthBuffer.destroy(),t.destroy()}this._shadowCubeMap=this._shadowCamera=this._shadowCamera.renderTarget=null,0===this.shadowUpdateMode&&(this.shadowUpdateMode=1)}},updateShadow:function(){2!==this.shadowUpdateMode&&(this.shadowUpdateMode=1)},updateKey:function(){var e=this._type<<29|(this._castShadows?1:0)<<28|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|ld[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12;3===this._cookieChannel.length&&(e|=ld[this._cookieChannel.charAt(1)]<<16,e|=ld[this._cookieChannel.charAt(2)]<<14),e!==this.key&&null!==this._scene&&(this._scene.layers._dirtyLights=!0),this.key=e}}),Object.defineProperty(cd.prototype,"type",{get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._destroyShadowMap(),this.updateKey(),e=this._shadowType,this._shadowType=null,this.shadowType=e)}}),Object.defineProperty(cd.prototype,"shadowType",{get:function(){return this._shadowType},set:function(e){if(this._shadowType!==e){var t=Ln.getApplication().graphicsDevice;1===this._type&&(e=0),4!==e||t.webgl2||(e=0),3!==e||t.textureFloatRenderable||(e=2),2!==e||t.textureHalfFloatRenderable||(e=1),this._isVsm=1<=e&&3>=e,this._isPcf=4===e||0===e,this._shadowType=e,this._destroyShadowMap(),this.updateKey()}}}),Object.defineProperty(cd.prototype,"castShadows",{get:function(){return this._castShadows&&4!==this.mask&&0!==this.mask},set:function(e){this._castShadows!==e&&(this._castShadows=e,this.updateKey())}}),Object.defineProperty(cd.prototype,"shadowResolution",{get:function(){return this._shadowResolution},set:function(e){if(this._shadowResolution!==e){var t=Ln.getApplication().graphicsDevice;this._shadowResolution=e=1===this._type?Math.min(e,t.maxCubeMapSize):Math.min(e,t.maxTextureSize)}}}),Object.defineProperty(cd.prototype,"vsmBlurSize",{get:function(){return this._vsmBlurSize},set:function(e){this._vsmBlurSize!==e&&(0==e%2&&e++,this._vsmBlurSize=e)}}),Object.defineProperty(cd.prototype,"normalOffsetBias",{get:function(){return this._normalOffsetBias},set:function(e){this._normalOffsetBias!==e&&((!this._normalOffsetBias&&e||this._normalOffsetBias&&!e)&&this.updateKey(),this._normalOffsetBias=e)}}),Object.defineProperty(cd.prototype,"falloffMode",{get:function(){return this._falloffMode},set:function(e){this._falloffMode!==e&&(this._falloffMode=e,this.updateKey())}}),Object.defineProperty(cd.prototype,"innerConeAngle",{get:function(){return this._innerConeAngle},set:function(e){this._innerConeAngle!==e&&(this._innerConeAngle=e,this._innerConeAngleCos=Math.cos(e*Math.PI/180))}}),Object.defineProperty(cd.prototype,"outerConeAngle",{get:function(){return this._outerConeAngle},set:function(e){this._outerConeAngle!==e&&(this._outerConeAngle=e,this._outerConeAngleCos=Math.cos(e*Math.PI/180))}}),Object.defineProperty(cd.prototype,"intensity",{get:function(){return this._intensity},set:function(e){this._intensity!==e&&(this._intensity=e,this._updateFinalColor())}}),Object.defineProperty(cd.prototype,"cookie",{get:function(){return this._cookie},set:function(e){this._cookie!==e&&(this._cookie=e,this.updateKey())}}),Object.defineProperty(cd.prototype,"cookieFalloff",{get:function(){return this._cookieFalloff},set:function(e){this._cookieFalloff!==e&&(this._cookieFalloff=e,this.updateKey())}}),Object.defineProperty(cd.prototype,"cookieChannel",{get:function(){return this._cookieChannel},set:function(e){if(this._cookieChannel!==e){if(3>e.length)for(var t=e.charAt(e.length-1),i=3-e.length,s=0;s<i;s++)e+=t;this._cookieChannel=e,this.updateKey()}}}),Object.defineProperty(cd.prototype,"cookieTransform",{get:function(){return this._cookieTransform},set:function(e){this._cookieTransform!==e&&(this._cookieTransform=e,this._cookieTransformSet=!!e,e&&!this._cookieOffset&&(this.cookieOffset=new T,this._cookieOffsetSet=!1),this.updateKey())}}),Object.defineProperty(cd.prototype,"cookieOffset",{get:function(){return this._cookieOffset},set:function(e){this._cookieOffset!==e&&((this._cookieTransformSet||e)&&!e&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=e,this._cookieOffsetSet=!!e,e&&!this._cookieTransform&&(this.cookieTransform=new b(1,1,0,0),this._cookieTransformSet=!1),this.updateKey())}}),Vs.prototype=Object.create(Ui.prototype),Vs.prototype.constructor=Vs;var dd=[],ud=[],pd=function(e,t,i,s){var n=Vs.prototype;dd.push(e),ud.push(t),Object.defineProperty(n,e,{get:function(){return this.data[e]},set:function(t){var n=this.data,r=n[e];(s||r!==t)&&(n[e]=t,i&&i.call(this,t,r))},configurable:!0})};pd("enabled",!0,function(e,t){this.onSetEnabled(null,t,e)}),pd("light",null),pd("type","directional",function(e,t){this.system.changeType(this,t,e),this.refreshProperties()}),pd("color",new h(1,1,1),function(e,t){this.light.setColor(e)},!0),pd("intensity",1,function(e,t){this.light.intensity=e}),pd("castShadows",!1,function(e,t){this.light.castShadows=e}),pd("shadowDistance",40,function(e,t){this.light.shadowDistance=e}),pd("shadowResolution",1024,function(e,t){this.light.shadowResolution=e}),pd("shadowBias",.05,function(e,t){this.light.shadowBias=-.01*e}),pd("normalOffsetBias",0,function(e,t){this.light.normalOffsetBias=e}),pd("range",10,function(e,t){this.light.attenuationEnd=e}),pd("innerConeAngle",40,function(e,t){this.light.innerConeAngle=e}),pd("outerConeAngle",45,function(e,t){this.light.outerConeAngle=e}),pd("falloffMode",0,function(e,t){this.light.falloffMode=e}),pd("shadowType",0,function(e,t){this.light.shadowType=e}),pd("vsmBlurSize",11,function(e,t){this.light.vsmBlurSize=e}),pd("vsmBlurMode",1,function(e,t){this.light.vsmBlurMode=e}),pd("vsmBias",.0025,function(e,t){this.light.vsmBias=e}),pd("cookieAsset",null,function(e,t){this._cookieAssetId&&(e instanceof Pt&&e.id===this._cookieAssetId||e===this._cookieAssetId)||(this.onCookieAssetRemove(),this._cookieAssetId=null,e instanceof Pt?(this._cookieAssetId=this.data.cookieAsset=e.id,this.onCookieAssetAdd(e)):"number"==typeof e&&(this._cookieAssetId=e,(e=this.system.app.assets.get(e))?this.onCookieAssetAdd(e):(this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this))))}),pd("cookie",null,function(e,t){this.light.cookie=e}),pd("cookieIntensity",1,function(e,t){this.light.cookieIntensity=e}),pd("cookieFalloff",!0,function(e,t){this.light.cookieFalloff=e}),pd("cookieChannel","rgb",function(e,t){this.light.cookieChannel=e}),pd("cookieAngle",0,function(e,t){if(0!==e||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new b);var i=t=1;this.cookieScale&&(t=this.cookieScale.x,i=this.cookieScale.y);var s=Math.cos(e*Hr.DEG_TO_RAD);e=Math.sin(e*Hr.DEG_TO_RAD),this._cookieMatrix.set(s/t,-e/t,e/i,s/i),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}),pd("cookieScale",null,function(e,t){if(null!==e||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new b),t=e.x,e=e.y;var i=Math.cos(this.cookieAngle*Hr.DEG_TO_RAD),s=Math.sin(this.cookieAngle*Hr.DEG_TO_RAD);this._cookieMatrix.set(i/t,-s/t,s/e,i/e),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null},!0),pd("cookieOffset",null,function(e,t){this.light.cookieOffset=e},!0),pd("shadowUpdateMode",2,function(e,t){this.light.shadowUpdateMode=e}),pd("mask",1,function(e,t){this.light.mask=e}),pd("affectDynamic",!0,function(e,t){this.light.mask=e?1|this.light.mask:-2&this.light.mask}),pd("affectLightmapped",!1,function(e,t){e?(this.light.mask|=2,this.bake&&(this.light.mask&=-5)):(this.light.mask&=-3,this.bake&&(this.light.mask|=4))}),pd("bake",!1,function(e,t){e?(this.light.mask|=4,this.affectLightmapped&&(this.light.mask&=-3)):(this.light.mask&=-5,this.affectLightmapped&&(this.light.mask|=2))}),pd("bakeDir",!0,function(e,t){this.light.bakeDir=e}),pd("isStatic",!1,function(e,t){this.light.isStatic=e}),pd("layers",[0],function(e,t){var i,s;for(i=0;i<t.length;i++)(s=this.system.app.scene.layers.getLayerById(t[i]))&&s.removeLight(this);for(i=0;i<e.length;i++)(s=this.system.app.scene.layers.getLayerById(e[i]))&&this.enabled&&this.entity.enabled&&s.addLight(this)}),Object.assign(Vs.prototype,{addLightToLayers:function(){for(var e,t=0;t<this.layers.length;t++)(e=this.system.app.scene.layers.getLayerById(this.layers[t]))&&e.addLight(this)},removeLightFromLayers:function(){for(var e,t=0;t<this.layers.length;t++)(e=this.system.app.scene.layers.getLayerById(this.layers[t]))&&e.removeLight(this)},onLayersChanged:function(e,t){this.enabled&&this.entity.enabled&&this.addLightToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(e){0>this.layers.indexOf(e.id)||this.enabled&&this.entity.enabled&&e.addLight(this)},onLayerRemoved:function(e){0>this.layers.indexOf(e.id)||e.removeLight(this)},refreshProperties:function(){for(var e,t=0;t<dd.length;t++)this[e=dd[t]]=this[e];this.enabled&&this.entity.enabled&&this.onEnable()},updateShadow:function(){this.light.updateShadow()},onCookieAssetSet:function(){var e=!1;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(e=this._cookieAsset.loadFaces=!0),this._cookieAsset.resource&&!e||this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()},onCookieAssetAdd:function(e){this._cookieAssetId===e.id&&(this._cookieAsset=e,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))},onCookieAssetLoad:function(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)},onCookieAssetRemove:function(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)},onEnable:function(){this.light.enabled=!0,this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()},onDisable:function(){this.light.enabled=!1,this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.removeLightFromLayers()},onRemove:function(){this.light.destroy(),this.cookieAsset=null}});var fd=dd,md=ud,_d={directional:0,point:1,spot:2};js.prototype=Object.create(zi.prototype),js.prototype.constructor=js,Object.assign(js.prototype,{initializeComponentData:function(e,t){for(var s=fd,n={},r=0,a=s.length;r<a;r++){var o=s[r];n[o]=t[o]}n.type||(n.type=e.data.type),e.data.type=n.type,n.layers&&"array"===i(n.layers)&&(n.layers=n.layers.slice(0)),n.color&&"array"===i(n.color)&&(n.color=new h(n.color[0],n.color[1],n.color[2])),n.cookieOffset&&n.cookieOffset instanceof Array&&(n.cookieOffset=new T(n.cookieOffset[0],n.cookieOffset[1])),n.cookieScale&&n.cookieScale instanceof Array&&(n.cookieScale=new T(n.cookieScale[0],n.cookieScale[1])),n.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),n.enabled=n.enable),(t=new cd).type=_d[n.type],t._node=e.entity,t._scene=this.app.scene,e.data.light=t,zi.prototype.initializeComponentData.call(this,e,n,s)},_onRemoveComponent:function(e,t){t.onRemove()},cloneComponent:function(e,t){e=e.light;for(var i,s=[],n=fd,r=0;r<n.length;r++)"light"!==(i=n[r])&&(s[i]=e[i]&&e[i].clone?e[i].clone():e[i]);this.addComponent(t,s)},changeType:function(e,t,i){t!==i&&(e.light.type=_d[i])}}),Ws.prototype=Object.create(Ui.prototype),Ws.prototype.constructor=Ws,Object.assign(Ws.prototype,{setVisible:function(e){console.warn("WARNING: setVisible: Function is deprecated. Set enabled property instead."),this.enabled=e},addModelToLayers:function(){for(var e,t=this.system.app.scene.layers,i=0;i<this._layers.length;i++)(e=t.getLayerById(this._layers[i]))&&e.addMeshInstances(this.meshInstances)},removeModelFromLayers:function(){for(var e,t=this.system.app.scene.layers,i=0;i<this._layers.length;i++)(e=t.getLayerById(this._layers[i]))&&e.removeMeshInstances(this.meshInstances)},onRemoveChild:function(){this._model&&this.removeModelFromLayers()},onInsertChild:function(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers()},onRemove:function(){"asset"===this.type?this.asset=null:this.model=null,this.materialAsset=null,this._unsetMaterialEvents(),this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)},onLayersChanged:function(e,t){this.addModelToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(e){0>this.layers.indexOf(e.id)||e.addMeshInstances(this.meshInstances)},onLayerRemoved:function(e){0>this.layers.indexOf(e.id)||e.removeMeshInstances(this.meshInstances)},_setMaterialEvent:function(e,t,i,s){t=t+":"+i,this.system.app.assets.on(t,s,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[e]||(this._materialEvents[e]={}),this._materialEvents[e][t]={id:i,handler:s}},_unsetMaterialEvents:function(){var e=this.system.app.assets,t=this._materialEvents;if(t){for(var i=0,s=t.length;i<s;i++)if(t[i]){var n,r=t[i];for(n in r)e.off(n,r[n].handler,this)}this._materialEvents=null}},_getAssetByIdOrPath:function(e){var t=null;return isNaN(parseInt(e,10))?this.asset&&(e=this._getMaterialAssetUrl(e))&&(t=this.system.app.assets.getByUrl(e)):t=this.system.app.assets.get(e),t},_getMaterialAssetUrl:function(e){if(!this.asset)return null;var t=this.system.app.assets.get(this.asset);return t?t.getAbsoluteUrl(e):null},_loadAndSetMeshInstanceMaterial:function(e,t,i){var s=this.system.app.assets;e&&(e.resource?(t.material=e.resource,this._setMaterialEvent(i,"remove",e.id,function(){t.material=this.system.defaultMaterial})):(this._setMaterialEvent(i,"load",e.id,function(s){t.material=s.resource,this._setMaterialEvent(i,"remove",e.id,function(){t.material=this.system.defaultMaterial})}),this.enabled&&this.entity.enabled&&s.load(e)))},onEnable:function(){var e,t=this.system.app,i=t.scene;if(i.on("set:layers",this.onLayersChanged,this),i.layers&&(i.layers.on("add",this.onLayerAdded,this),i.layers.on("remove",this.onLayerRemoved,this)),i="asset"===this._type,this._model?this.addModelToLayers():i&&this._asset&&(e=t.assets.get(this._asset))&&e.resource!==this._model&&this._bindModelAsset(e),this._materialAsset&&(e=t.assets.get(this._materialAsset))&&e.resource!==this._material&&this._bindMaterialAsset(e),i&&this._mapping)for(var s in this._mapping)this._mapping[s]&&(e=this._getAssetByIdOrPath(this._mapping[s]))&&!e.resource&&t.assets.load(e);0<=this._batchGroupId&&t.batcher.insert(le.MODEL,this.batchGroupId,this.entity)},onDisable:function(){var e=this.system.app,t=e.scene;t.off("set:layers",this.onLayersChanged,this),t.layers&&(t.layers.off("add",this.onLayerAdded,this),t.layers.off("remove",this.onLayerRemoved,this)),0<=this._batchGroupId&&e.batcher.remove(le.MODEL,this.batchGroupId,this.entity),this._model&&this.removeModelFromLayers()},hide:function(){if(this._model){var e,t=this._model.meshInstances,i=0;for(e=t.length;i<e;i++)t[i].visible=!1}},show:function(){if(this._model){var e,t=this._model.meshInstances,i=0;for(e=t.length;i<e;i++)t[i].visible=!0}},_bindMaterialAsset:function(e){e.on("load",this._onMaterialAssetLoad,this),e.on("unload",this._onMaterialAssetUnload,this),e.on("remove",this._onMaterialAssetRemove,this),e.on("change",this._onMaterialAssetChange,this),e.resource?this._onMaterialAssetLoad(e):this.enabled&&this.entity.enabled&&this.system.app.assets.load(e)},_unbindMaterialAsset:function(e){e.off("load",this._onMaterialAssetLoad,this),e.off("unload",this._onMaterialAssetUnload,this),e.off("remove",this._onMaterialAssetRemove,this),e.off("change",this._onMaterialAssetChange,this)},_onMaterialAssetAdd:function(e){this.system.app.assets.off("add:"+e.id,this._onMaterialAssetAdd,this),this._materialAsset===e.id&&this._bindMaterialAsset(e)},_onMaterialAssetLoad:function(e){this._setMaterial(e.resource)},_onMaterialAssetUnload:function(e){this._setMaterial(this.system.defaultMaterial)},_onMaterialAssetRemove:function(e){this._onMaterialAssetUnload(e)},_onMaterialAssetChange:function(e){},_bindModelAsset:function(e){this._unbindModelAsset(e),e.on("load",this._onModelAssetLoad,this),e.on("unload",this._onModelAssetUnload,this),e.on("change",this._onModelAssetChange,this),e.on("remove",this._onModelAssetRemove,this),e.resource?this._onModelAssetLoad(e):this.enabled&&this.entity.enabled&&this.system.app.assets.load(e)},_unbindModelAsset:function(e){e.off("load",this._onModelAssetLoad,this),e.off("unload",this._onModelAssetUnload,this),e.off("change",this._onModelAssetChange,this),e.off("remove",this._onModelAssetRemove,this)},_onModelAssetAdded:function(e){this.system.app.assets.off("add:"+e.id,this._onModelAssetAdd,this),e.id===this._asset&&this._bindModelAsset(e)},_onModelAssetLoad:function(e){this.model=e.resource.clone(),this._clonedModel=!0},_onModelAssetUnload:function(e){this.model=null},_onModelAssetChange:function(e,t,i,s){"data"===t&&(this.mapping=this._mapping)},_onModelAssetRemove:function(e){this.model=null},_setMaterial:function(e){if(this._material!==e){this._material=e;var t=this._model;if(t&&"asset"!==this._type)for(var i=0,s=(t=t.meshInstances).length;i<s;i++)t[i].material=e}}}),Object.defineProperty(Ws.prototype,"meshInstances",{get:function(){return this._model?this._model.meshInstances:null},set:function(e){this._model&&(this._model.meshInstances=e)}}),Object.defineProperty(Ws.prototype,"type",{get:function(){return this._type},set:function(e){if(this._type!==e)if(this._area=null,this._type=e,"asset"===e)null!==this._asset?this._bindModelAsset(this._asset):this.model=null;else{var t=this.system,i=t.app.graphicsDevice;switch(e){case"box":t.box||(t.box=tt(i,{halfExtents:new v(.5,.5,.5)})),e=t.box,this._area={x:2,y:2,z:2,uv:2/3};break;case"capsule":t.capsule||(t.capsule=$e(i,{radius:.5,height:2})),e=t.capsule,this._area={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case"cone":t.cone||(t.cone=Qe(i,{baseRadius:.5,peakRadius:0,height:1})),e=t.cone,this._area={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":t.cylinder||(t.cylinder=Ze(i,{radius:.5,height:1})),e=t.cylinder,this._area={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":t.plane||(t.plane=et(i,{halfExtents:new T(.5,.5),widthSegments:1,lengthSegments:1})),e=t.plane,this._area={x:0,y:1,z:0,uv:1};break;case"sphere":t.sphere||(t.sphere=Je(i,{radius:.5})),e=t.sphere,this._area={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;default:throw Error("Invalid model type: "+e)}i=new ge;var s=new oe;s.graph=i,s.meshInstances=[new ee(i,e,this._material)],t._inTools&&s.generateWireframe(),this.model=s,this._asset=null}}}),Object.defineProperty(Ws.prototype,"asset",{get:function(){return this._asset},set:function(e){var t=this.system.app.assets,i=e;e instanceof Pt&&(i=e.id),this._asset!==i&&(this._asset&&(t.off("add:"+this._asset,this._onModelAssetAdded,this),(e=t.get(this._asset))&&this._unbindModelAsset(e)),(this._asset=i)?(i=t.get(this._asset))?this._bindModelAsset(i):(this.model=null,t.on("add:"+this._asset,this._onModelAssetAdded,this)):this.model=null)}}),Object.defineProperty(Ws.prototype,"model",{get:function(){return this._model},set:function(e){if(!(this._model===e||e&&e._immutable)&&(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this.entity.removeChild(this._model.getGraph()),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=e)){this._model._immutable=!0;var t=this._model.meshInstances;for(e=0;e<t.length;e++)t[e].castShadow=this._castShadows,t[e].receiveShadow=this._receiveShadows,t[e].isStatic=this._isStatic;this.lightmapped=this._lightmapped,this.entity.addChild(this._model.graph),this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._model._entity=this.entity,this.entity.animation&&this.entity.animation.setModel(this._model),"asset"===this.type?this.mapping=this._mapping:this._unsetMaterialEvents()}}}),Object.defineProperty(Ws.prototype,"lightmapped",{get:function(){return this._lightmapped},set:function(e){if(e!==this._lightmapped&&(this._lightmapped=e,this._model)){var t=this._model.meshInstances;if(e)for(e=0;e<t.length;e++){var i=t[e],s=i.mask;i.mask=-6&(2|s)}else for(e=0;e<t.length;e++)(i=t[e]).deleteParameter("texture_lightMap"),i.deleteParameter("texture_dirLightMap"),i._shaderDefs&=-65,s=i.mask,i.mask=-7&(1|s)}}}),Object.defineProperty(Ws.prototype,"castShadows",{get:function(){return this._castShadows},set:function(e){if(this._castShadows!==e){var t,i,s=this._model;if(s){var n=this.layers,r=this.system.app.scene;if(this._castShadows&&!e)for(i=0;i<n.length;i++)(t=this.system.app.scene.layers.getLayerById(this.layers[i]))&&t.removeShadowCasters(s.meshInstances);for(t=s.meshInstances,i=0;i<t.length;i++)t[i].castShadow=e;if(!this._castShadows&&e)for(i=0;i<n.length;i++)(t=r.layers.getLayerById(n[i]))&&t.addShadowCasters(s.meshInstances)}this._castShadows=e}}}),Object.defineProperty(Ws.prototype,"receiveShadows",{get:function(){return this._receiveShadows},set:function(e){if(this._receiveShadows!==e&&(this._receiveShadows=e,this._model))for(var t=this._model.meshInstances,i=0,s=t.length;i<s;i++)t[i].receiveShadow=e}}),Object.defineProperty(Ws.prototype,"castShadowsLightmap",{get:function(){return this._castShadowsLightmap},set:function(e){this._castShadowsLightmap=e}}),Object.defineProperty(Ws.prototype,"lightmapSizeMultiplier",{get:function(){return this._lightmapSizeMultiplier},set:function(e){this._lightmapSizeMultiplier=e}}),Object.defineProperty(Ws.prototype,"isStatic",{get:function(){return this._isStatic},set:function(e){var t;if(this._isStatic!==e&&(this._isStatic=e,this._model)){var i=this._model.meshInstances;for(t=0;t<i.length;t++){i[t].isStatic=e}}}}),Object.defineProperty(Ws.prototype,"layers",{get:function(){return this._layers},set:function(e){var t,i,s=this.system.app.scene.layers;if(this.meshInstances)for(t=0;t<this._layers.length;t++)(i=s.getLayerById(this._layers[t]))&&i.removeMeshInstances(this.meshInstances);for(t=this._layers.length=0;t<e.length;t++)this._layers[t]=e[t];if(this.enabled&&this.entity.enabled&&this.meshInstances)for(t=0;t<this._layers.length;t++)(i=s.getLayerById(this._layers[t]))&&i.addMeshInstances(this.meshInstances)}}),Object.defineProperty(Ws.prototype,"batchGroupId",{get:function(){return this._batchGroupId},set:function(e){if(this._batchGroupId!==e){var t=this.system.app.batcher;this.entity.enabled&&0<=this._batchGroupId&&t.remove(le.MODEL,this.batchGroupId,this.entity),this.entity.enabled&&0<=e&&t.insert(le.MODEL,e,this.entity),0>e&&0<=this._batchGroupId&&this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._batchGroupId=e}}}),Object.defineProperty(Ws.prototype,"materialAsset",{get:function(){return this._materialAsset},set:function(e){var t=e;if(e instanceof Pt&&(t=e.id),e=this.system.app.assets,t!==this._materialAsset){if(this._materialAsset){e.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);var i=e.get(this._materialAsset);i&&this._unbindMaterialAsset(i)}(this._materialAsset=t)?(t=e.get(this._materialAsset))?this._bindMaterialAsset(t):(this._setMaterial(this.system.defaultMaterial),e.on("add:"+this._materialAsset,this._onMaterialAssetAdd,this)):this._setMaterial(this.system.defaultMaterial)}}}),Object.defineProperty(Ws.prototype,"material",{get:function(){return this._material},set:function(e){this._material!==e&&(this.materialAsset=null,this._setMaterial(e))}}),Object.defineProperty(Ws.prototype,"mapping",{get:function(){return this._mapping},set:function(e){if("asset"===this._type&&(this._unsetMaterialEvents(),e||(e={}),this._mapping=e,this._model)){var t=this._model.meshInstances,i=this.asset?this.system.app.assets.get(this.asset):null;i=i?i.data.mapping:null;for(var s=null,n=0,r=t.length;n<r;n++)if(void 0!==e[n])e[n]?(s=this.system.app.assets.get(e[n]),this._loadAndSetMeshInstanceMaterial(s,t[n],n)):t[n].material=this.system.defaultMaterial;else if(i)if(i[n]&&(i[n].material||i[n].path)){if(void 0!==i[n].material)s=this.system.app.assets.get(i[n].material);else if(void 0!==i[n].path){var a=this._getMaterialAssetUrl(i[n].path);a&&(s=this.system.app.assets.getByUrl(a))}this._loadAndSetMeshInstanceMaterial(s,t[n],n)}else t[n].material=this.system.defaultMaterial}}});var gd=["enabled"];Xs.prototype=Object.create(zi.prototype),Xs.prototype.constructor=Xs,Ui._buildAccessors(Ws.prototype,gd),Object.assign(Xs.prototype,{initializeComponentData:function(e,t,i){i="material materialAsset asset castShadows receiveShadows castShadowsLightmap lightmapped lightmapSizeMultiplier type mapping layers isStatic batchGroupId".split(" "),null!==t.batchGroupId&&void 0!==t.batchGroupId||(t.batchGroupId=-1),t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(var s=0;s<i.length;s++)t.hasOwnProperty(i[s])&&(e[i[s]]=t[i[s]]);zi.prototype.initializeComponentData.call(this,e,t,["enabled"])},cloneComponent:function(e,t){var i={type:e.model.type,asset:e.model.asset,castShadows:e.model.castShadows,receiveShadows:e.model.receiveShadows,castShadowsLightmap:e.model.castShadowsLightmap,lightmapped:e.model.lightmapped,lightmapSizeMultiplier:e.model.lightmapSizeMultiplier,isStatic:e.model.isStatic,enabled:e.model.enabled,layers:e.model.layers,batchGroupId:e.model.batchGroupId,mapping:s({},e.model.mapping)},n=e.model.materialAsset;n instanceof Pt||null==n||(n=this.app.assets.get(n));var r=e.model.material;if(r&&r!==this.defaultMaterial&&n&&r!==n.resource||(i.materialAsset=n),t=this.addComponent(t,i),e.model.model&&"asset"===e.model.type&&!e.model.asset&&(t.model=e.model.model.clone(),t._clonedModel=!0),i.materialAsset||(t.material=r),e.model.model)for(e=e.model.model.meshInstances,i=t.model.meshInstances,r=0;r<e.length;r++)i[r].mask=e[r].mask,i[r].material=e[r].material,i[r].layer=e[r].layer,i[r].receiveShadow=e[r].receiveShadow},onRemove:function(e,t){t.onRemove()}});var yd,vd="emitterExtents emitterRadius emitterExtentsInner emitterRadiusInner loop initialVelocity animSpeed normalMap particleNormal".split(" "),bd="numParticles lifetime rate rate2 startAngle startAngle2 lighting halfLambert intensity wrap wrapBounds depthWrite noFog sort stretch alignToMotion preWarm emitterShape animTilesX animTilesY animStartFrame animNumFrames animNumAnimations animIndex randomizeAnimIndex animLoop colorMap localSpace orientation".split(" "),xd="scaleGraph scaleGraph2 colorGraph colorGraph2 alphaGraph alphaGraph2 velocityGraph velocityGraph2 localVelocityGraph localVelocityGraph2 rotationSpeedGraph rotationSpeedGraph2 radialSpeedGraph radialSpeedGraph2".split(" "),Sd=["colorMapAsset","normalMapAsset","meshAsset"],Td=function(e,t){Ui.call(this,e,t),this.on("set_colorMapAsset",this.onSetColorMapAsset,this),this.on("set_normalMapAsset",this.onSetNormalMapAsset,this),this.on("set_meshAsset",this.onSetMeshAsset,this),this.on("set_mesh",this.onSetMesh,this),this.on("set_loop",this.onSetLoop,this),this.on("set_blendType",this.onSetBlendType,this),this.on("set_depthSoftening",this.onSetDepthSoftening,this),this.on("set_layers",this.onSetLayers,this),vd.forEach(function(e){this.on("set_"+e,this.onSetSimpleProperty,this)}.bind(this)),bd.forEach(function(e){this.on("set_"+e,this.onSetComplexProperty,this)}.bind(this)),xd.forEach(function(e){this.on("set_"+e,this.onSetGraphProperty,this)}.bind(this)),this._requestedDepth=!1};Td.prototype=Object.create(Ui.prototype),Td.prototype.constructor=Td,Object.assign(Td.prototype,{addModelToLayers:function(){if(this.data.model)for(var e,t=0;t<this.layers.length;t++)(e=this.system.app.scene.layers.getLayerById(this.layers[t]))&&(e.addMeshInstances(this.data.model.meshInstances),this.emitter._layer=e)},removeModelFromLayers:function(e){if(this.data.model)for(var t=0;t<this.layers.length;t++)(e=this.system.app.scene.layers.getLayerById(this.layers[t]))&&e.removeMeshInstances(this.data.model.meshInstances)},onSetLayers:function(e,t,i){if(this.data.model){var s;for(e=0;e<t.length;e++)(s=this.system.app.scene.layers.getLayerById(t[e]))&&s.removeMeshInstances(this.data.model.meshInstances);if(this.enabled&&this.entity.enabled)for(e=0;e<i.length;e++)(s=this.system.app.scene.layers.getLayerById(i[e]))&&s.addMeshInstances(this.data.model.meshInstances)}},onLayersChanged:function(e,t){this.addModelToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(e){this.data.model&&(0>this.layers.indexOf(e.id)||e.addMeshInstances(this.data.model.meshInstances))},onLayerRemoved:function(e){this.data.model&&(0>this.layers.indexOf(e.id)||e.removeMeshInstances(this.data.model.meshInstances))},_bindColorMapAsset:function(e){e.on("load",this._onColorMapAssetLoad,this),e.on("unload",this._onColorMapAssetUnload,this),e.on("remove",this._onColorMapAssetRemove,this),e.on("change",this._onColorMapAssetChange,this),e.resource?this._onColorMapAssetLoad(e):this.enabled&&this.entity.enabled&&this.system.app.assets.load(e)},_unbindColorMapAsset:function(e){e.off("load",this._onColorMapAssetLoad,this),e.off("unload",this._onColorMapAssetUnload,this),e.off("remove",this._onColorMapAssetRemove,this),e.off("change",this._onColorMapAssetChange,this)},_onColorMapAssetLoad:function(e){this.colorMap=e.resource},_onColorMapAssetUnload:function(e){this.colorMap=null},_onColorMapAssetRemove:function(e){this._onColorMapAssetUnload(e)},_onColorMapAssetChange:function(e){},onSetColorMapAsset:function(e,t,i){var s=this;e=this.system.app.assets,t&&(t=e.get(t))&&this._unbindColorMapAsset(t),i?(i instanceof Pt&&(i=this.data.colorMapAsset=i.id),(t=e.get(i))?s._bindColorMapAsset(t):e.once("add:"+i,function(e){s._bindColorMapAsset(e)})):this.colorMap=null},_bindNormalMapAsset:function(e){e.on("load",this._onNormalMapAssetLoad,this),e.on("unload",this._onNormalMapAssetUnload,this),e.on("remove",this._onNormalMapAssetRemove,this),e.on("change",this._onNormalMapAssetChange,this),e.resource?this._onNormalMapAssetLoad(e):this.enabled&&this.entity.enabled&&this.system.app.assets.load(e)},_unbindNormalMapAsset:function(e){e.off("load",this._onNormalMapAssetLoad,this),e.off("unload",this._onNormalMapAssetUnload,this),e.off("remove",this._onNormalMapAssetRemove,this),e.off("change",this._onNormalMapAssetChange,this)},_onNormalMapAssetLoad:function(e){this.normalMap=e.resource},_onNormalMapAssetUnload:function(e){this.normalMap=null},_onNormalMapAssetRemove:function(e){this._onNormalMapAssetUnload(e)},_onNormalMapAssetChange:function(e){},onSetNormalMapAsset:function(e,t,i){var s=this;e=this.system.app.assets,t&&(t=e.get(t))&&this._unbindNormalMapAsset(t),i?(i instanceof Pt&&(i=this.data.normalMapAsset=i.id),(t=e.get(i))?s._bindNormalMapAsset(t):e.once("add:"+i,function(e){s._bindNormalMapAsset(e)})):this.normalMap=null},_bindMeshAsset:function(e){e.on("load",this._onMeshAssetLoad,this),e.on("unload",this._onMeshAssetUnload,this),e.on("remove",this._onMeshAssetRemove,this),e.on("change",this._onMeshAssetChange,this),e.resource?this._onMeshAssetLoad(e):this.enabled&&this.entity.enabled&&this.system.app.assets.load(e)},_unbindMeshAsset:function(e){e.off("load",this._onMeshAssetLoad,this),e.off("unload",this._onMeshAssetUnload,this),e.off("remove",this._onMeshAssetRemove,this),e.off("change",this._onMeshAssetChange,this)},_onMeshAssetLoad:function(e){this._onMeshChanged(e.resource)},_onMeshAssetUnload:function(e){this.mesh=null},_onMeshAssetRemove:function(e){this._onMeshAssetUnload(e)},_onMeshAssetChange:function(e){},onSetMeshAsset:function(e,t,i){e=this.system.app.assets,t&&(t=e.get(t))&&this._unbindMeshAsset(t),i?(i instanceof Pt&&(i=this.data.meshAsset=i.id),(t=e.get(i))&&(this._bindMeshAsset(t),t.resource?this._onMeshChanged(t.resource):e.load(t))):this._onMeshChanged(null)},onSetMesh:function(e,t,i){!i||i instanceof Pt||"number"==typeof i?this.meshAsset=i:this._onMeshChanged(i)},_onMeshChanged:function(e){!e||e instanceof J||(e=e.meshInstances[0]?e.meshInstances[0].mesh:null),this.data.mesh=e,this.emitter&&(this.emitter.mesh=e,this.emitter.resetMaterial(),this.rebuild())},onSetLoop:function(e,t,i){this.emitter&&(this.emitter[e]=i,this.emitter.resetTime())},onSetBlendType:function(e,t,i){this.emitter&&(this.emitter[e]=i,this.emitter.material.blendType=i,this.emitter.resetMaterial(),this.rebuild())},_requestDepth:function(){this._requestedDepth||(yd||(yd=this.system.app.scene.layers.getLayerById(1)),yd&&(yd.incrementCounter(),this._requestedDepth=!0))},_releaseDepth:function(){this._requestedDepth&&yd&&(yd.decrementCounter(),this._requestedDepth=!1)},onSetDepthSoftening:function(e,t,i){t!==i&&(i?this.enabled&&this.entity.enabled&&this._requestDepth():this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[e]=i),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()))},onSetSimpleProperty:function(e,t,i){this.emitter&&(this.emitter[e]=i,this.emitter.resetMaterial())},onSetComplexProperty:function(e,t,i){this.emitter&&(this.emitter[e]=i,this.emitter.resetMaterial(),this.rebuild(),this.reset())},onSetGraphProperty:function(e,t,i){this.emitter&&(this.emitter[e]=i,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())},onEnable:function(){for(var e=this.data,t=0,i=Sd.length;t<i;t++){var s=e[Sd[t]];if(s){if(!(s instanceof Pt)){if(!(0<=parseInt(s,10)))continue;s=this.system.app.assets.get(s)}s&&!s.resource&&this.system.app.assets.load(s)}}this.emitter||((t=e.mesh)instanceof J||(t=null),this.emitter=new Bh(this.system.app.graphicsDevice,{numParticles:e.numParticles,emitterExtents:e.emitterExtents,emitterExtentsInner:e.emitterExtentsInner,emitterRadius:e.emitterRadius,emitterRadiusInner:e.emitterRadiusInner,emitterShape:e.emitterShape,initialVelocity:e.initialVelocity,wrap:e.wrap,localSpace:e.localSpace,wrapBounds:e.wrapBounds,lifetime:e.lifetime,rate:e.rate,rate2:e.rate2,orientation:e.orientation,particleNormal:e.particleNormal,animTilesX:e.animTilesX,animTilesY:e.animTilesY,animStartFrame:e.animStartFrame,animNumFrames:e.animNumFrames,animNumAnimations:e.animNumAnimations,animIndex:e.animIndex,randomizeAnimIndex:e.randomizeAnimIndex,animSpeed:e.animSpeed,animLoop:e.animLoop,startAngle:e.startAngle,startAngle2:e.startAngle2,scaleGraph:e.scaleGraph,scaleGraph2:e.scaleGraph2,colorGraph:e.colorGraph,colorGraph2:e.colorGraph2,alphaGraph:e.alphaGraph,alphaGraph2:e.alphaGraph2,localVelocityGraph:e.localVelocityGraph,localVelocityGraph2:e.localVelocityGraph2,velocityGraph:e.velocityGraph,velocityGraph2:e.velocityGraph2,rotationSpeedGraph:e.rotationSpeedGraph,rotationSpeedGraph2:e.rotationSpeedGraph2,radialSpeedGraph:e.radialSpeedGraph,radialSpeedGraph2:e.radialSpeedGraph2,colorMap:e.colorMap,normalMap:e.normalMap,loop:e.loop,preWarm:e.preWarm,sort:e.sort,stretch:e.stretch,alignToMotion:e.alignToMotion,lighting:e.lighting,halfLambert:e.halfLambert,intensity:e.intensity,depthSoftening:e.depthSoftening,scene:this.system.app.scene,mesh:t,depthWrite:e.depthWrite,noFog:e.noFog,node:this.entity,blendType:e.blendType}),this.emitter.meshInstance.node=this.entity,this.psys=new oe,this.psys.graph=this.entity,this.psys.emitter=this.emitter,this.psys.meshInstances=[this.emitter.meshInstance],e.model=this.psys,this.emitter.psys=this.psys,e.autoPlay||(this.pause(),this.emitter.meshInstance.visible=!1)),e.model&&this.emitter.colorMap&&this.addModelToLayers(),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&e.depthSoftening&&this._requestDepth()},onDisable:function(){this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.data.model&&(this.removeModelFromLayers(),this.data.depthSoftening&&this._releaseDepth()),this.emitter&&(this.emitter.camera=null)},onBeforeRemove:function(){this.enabled&&(this.enabled=!1);var e=this.data;e.model&&(this.entity.removeChild(e.model.getGraph()),e.model.destroy(),e.model=null),this.emitter&&(this.emitter.destroy(),this.emitter=null);for(var t=0;t<Sd.length;t++){var i=Sd[t];e[i]&&(this[i]=null)}this.off()},reset:function(){this.emitter&&this.emitter.reset()},stop:function(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))},pause:function(){this.data.paused=!0},unpause:function(){this.data.paused=!1},play:function(){this.data.paused=!1,this.emitter&&(this.emitter.meshInstance.visible=!0,this.emitter.loop=this.data.loop,this.emitter.resetTime())},isPlaying:function(){return!this.data.paused&&(!(!this.emitter||!this.emitter.loop)||Date.now()<=this.emitter.endTime)},rebuild:function(){var e=this.enabled;this.enabled=!1,this.emitter&&(this.emitter.rebuild(),this.emitter.meshInstance.node=this.entity,this.data.model.meshInstances=[this.emitter.meshInstance]),this.enabled=e}});var wd,Md,Pd,Ad,Ed,Cd="enabled autoPlay numParticles lifetime rate rate2 startAngle startAngle2 loop preWarm lighting halfLambert intensity depthWrite noFog depthSoftening sort blendType stretch alignToMotion emitterShape emitterExtents emitterExtentsInner emitterRadius emitterRadiusInner initialVelocity wrap wrapBounds localSpace colorMapAsset normalMapAsset mesh meshAsset orientation particleNormal localVelocityGraph localVelocityGraph2 velocityGraph velocityGraph2 rotationSpeedGraph rotationSpeedGraph2 radialSpeedGraph radialSpeedGraph2 scaleGraph scaleGraph2 colorGraph colorGraph2 alphaGraph alphaGraph2 colorMap normalMap animTilesX animTilesY animStartFrame animNumFrames animNumAnimations animIndex randomizeAnimIndex animSpeed animLoop layers".split(" ");Ys.prototype=Object.create(zi.prototype),Ys.prototype.constructor=Ys,Ui._buildAccessors(Td.prototype,Cd),Object.assign(Ys.prototype,{initializeComponentData:function(e,t,s){var n={};s=[];var r=this.propertyTypes;for(var a in(t.mesh instanceof Pt||"number"==typeof t.mesh)&&(t.meshAsset=t.mesh,delete t.mesh),t){if(t.hasOwnProperty(a)&&(s.push(a),n[a]=t[a]),"vec3"===r[a])"array"===i(n[a])&&(n[a]=new v(n[a][0],n[a][1],n[a][2]));else if("curve"===r[a]){if(!(n[a]instanceof _)){var o=n[a].type;n[a]=new _(n[a].keys),n[a].type=o}}else"curveset"!==r[a]||n[a]instanceof g||(o=n[a].type,n[a]=new g(n[a].keys),n[a].type=o);n.layers&&"array"===i(n.layers)&&(n.layers=n.layers.slice(0))}zi.prototype.initializeComponentData.call(this,e,n,s)},cloneComponent:function(e,t){e=e.particlesystem.data;for(var i=this.schema,s={},n=0,r=i.length;n<r;n++){var a=i[n],o=e[a];o instanceof v||o instanceof _||o instanceof g?(o=o.clone(),s[a]=o):"layers"===a?s.layers=e.layers.slice(0):null!=o&&(s[a]=o)}return this.addComponent(t,s)},onUpdate:function(e){var t,i,s=this.store,n=this.app.stats.particles;for(i in s)if(s.hasOwnProperty(i)){var r=s[i],a=r.entity,o=r.data;if(o.enabled&&a.enabled){var h=o.model.emitter;if(h.meshInstance.visible){if(h.lighting){var l=o.layers;for(a=0;a<l.length;a++)if(r=this.app.scene.layers.getLayerById(l[a])){r._lightCube||(r._lightCube=new Float32Array(18));var c=r._lightCube;for(a=0;6>a;a++)c[3*a]=this.app.scene.ambientLight.r,c[3*a+1]=this.app.scene.ambientLight.g,c[3*a+2]=this.app.scene.ambientLight.b;var d=r._sortedLights[0];for(t=0;t<d.length;t++)for(r=0;6>r;r++){var u=Math.max(h.lightCubeDir[r].dot(d[t]._direction),0)*d[t]._intensity;c[3*r]+=d[t]._color.r*u,c[3*r+1]+=d[t]._color.g*u,c[3*r+2]+=d[t]._color.b*u}}h.constantLightCube.setValue(c)}if(!o.paused){if(h.simTime+=e,h.simTime>h.fixedTimeStep){var p=Math.floor(h.simTime/h.fixedTimeStep);h.simTime-=p*h.fixedTimeStep}if(p){for(p=Math.min(p,h.maxSubSteps),a=0;a<p;a++)h.addTime(h.fixedTimeStep,!1);n._updatesPerFrame+=p,n._frameTime+=h._addTimeTime,h._addTimeTime=0}h.finishFrame()}}}}},onBeforeRemove:function(e,t){t.onBeforeRemove()}}),Object.assign(Ks.prototype,{_resize:function(e){if(e>this._pool.length)for(var t=this._pool.length;t<e;t++)this._pool[t]=new this._constructor},allocate:function(){return this._count>=this._pool.length&&this._resize(2*this._pool.length),this._pool[this._count++]},freeAll:function(){this._count=0}}),Zs.prototype=Object.create(Ui.prototype),Zs.prototype.constructor=Zs,Object.defineProperty(Zs.prototype,"linearVelocity",{get:function(){var e=this.body;return e&&"dynamic"===this.type&&(e=e.getLinearVelocity(),this._linearVelocity.set(e.x(),e.y(),e.z())),this._linearVelocity},set:function(e){var t=this.body;t&&"dynamic"===this.type&&(t.activate(),Md.setValue(e.x,e.y,e.z),t.setLinearVelocity(Md),this._linearVelocity.copy(e))}}),Object.defineProperty(Zs.prototype,"angularVelocity",{get:function(){var e=this.body;return e&&"dynamic"===this.type&&(e=e.getAngularVelocity(),this._angularVelocity.set(e.x(),e.y(),e.z())),this._angularVelocity},set:function(e){var t=this.body;t&&"dynamic"===this.type&&(t.activate(),Md.setValue(e.x,e.y,e.z),t.setAngularVelocity(Md),this._angularVelocity.copy(e))}}),Object.assign(Zs.prototype,{createBody:function(){var e=this.entity;if(e.collision){var t=e.collision.shape;e.trigger&&(e.trigger.destroy(),delete e.trigger)}if(t){this.body&&this.system.onRemove(this.entity,this);var i="dynamic"===this.type?this.mass:0;this._getEntityTransform(wd),(t=this.system.createBody(i,t,wd)).setRestitution(this.restitution),t.setFriction(this.friction),t.setDamping(this.linearDamping,this.angularDamping),"dynamic"===this.type?(i=this.linearFactor,Md.setValue(i.x,i.y,i.z),t.setLinearFactor(Md),i=this.angularFactor,Md.setValue(i.x,i.y,i.z),t.setAngularFactor(Md)):"kinematic"===this.type&&(t.setCollisionFlags(2|t.getCollisionFlags()),t.setActivationState(4)),t.entity=e,e.rigidbody.body=t,this.enabled&&this.entity.enabled&&this.enableSimulation()}},isActive:function(){var e=this.body;return!!e&&e.isActive()},activate:function(){var e=this.body;e&&e.activate()},enableSimulation:function(){if(this.entity.collision&&this.entity.collision.enabled&&!this.data.simulationEnabled){var e=this.body;if(e){switch(this.system.addBody(e,this.group,this.mask),this.type){case"dynamic":this.system._dynamic.push(this),e.forceActivationState(1),this.syncEntityToBody();break;case"kinematic":this.system._kinematic.push(this),e.forceActivationState(4);break;case xc:e.forceActivationState(1),this.syncEntityToBody()}"compound"===this.entity.collision.type&&this.system._compounds.push(this.entity.collision),e.activate(),this.data.simulationEnabled=!0}}},disableSimulation:function(){var e=this.body;if(e&&this.data.simulationEnabled){var t=this.system._compounds.indexOf(this.entity.collision);-1<t&&this.system._compounds.splice(t,1),-1<(t=this.system._dynamic.indexOf(this))&&this.system._dynamic.splice(t,1),-1<(t=this.system._kinematic.indexOf(this))&&this.system._kinematic.splice(t,1),this.system.removeBody(e),e.forceActivationState(5),this.data.simulationEnabled=!1}},applyForce:function(){switch(arguments.length){case 1:var e=arguments[0].x,t=arguments[0].y,i=arguments[0].z;break;case 2:e=arguments[0].x,t=arguments[0].y,i=arguments[0].z;var s=arguments[1].x,n=arguments[1].y,r=arguments[1].z;break;case 3:e=arguments[0],t=arguments[1],i=arguments[2];break;case 6:e=arguments[0],t=arguments[1],i=arguments[2],s=arguments[3],n=arguments[4],r=arguments[5]}var a=this.body;a&&(a.activate(),Md.setValue(e,t,i),void 0!==s?(Pd.setValue(s,n,r),a.applyForce(Md,Pd)):a.applyForce(Md,Ed))},applyTorque:function(){switch(arguments.length){case 1:var e=arguments[0].x,t=arguments[0].y,i=arguments[0].z;break;case 3:e=arguments[0],t=arguments[1],i=arguments[2];break;default:return}var s=this.body;s&&(s.activate(),Md.setValue(e,t,i),s.applyTorque(Md))},applyImpulse:function(){switch(arguments.length){case 1:var e=arguments[0].x,t=arguments[0].y,i=arguments[0].z;break;case 2:e=arguments[0].x,t=arguments[0].y,i=arguments[0].z;var s=arguments[1].x,n=arguments[1].y,r=arguments[1].z;break;case 3:e=arguments[0],t=arguments[1],i=arguments[2];break;case 6:e=arguments[0],t=arguments[1],i=arguments[2],s=arguments[3],n=arguments[4],r=arguments[5];break;default:return}var a=this.body;a&&(a.activate(),Md.setValue(e,t,i),void 0!==s?(Pd.setValue(s,n,r),a.applyImpulse(Md,Pd)):a.applyImpulse(Md,Ed))},applyTorqueImpulse:function(){switch(arguments.length){case 1:var e=arguments[0].x,t=arguments[0].y,i=arguments[0].z;break;case 3:e=arguments[0],t=arguments[1],i=arguments[2];break;default:return}var s=this.body;s&&(s.activate(),Md.setValue(e,t,i),s.applyTorqueImpulse(Md))},isStatic:function(){return this.type===xc},isStaticOrKinematic:function(){return this.type===xc||"kinematic"===this.type},isKinematic:function(){return"kinematic"===this.type},_getEntityTransform:function(e){var t=this.entity.getPosition(),i=this.entity.getRotation();Md.setValue(t.x,t.y,t.z),Ad.setValue(i.x,i.y,i.z,i.w),e.setOrigin(Md),e.setRotation(Ad)},syncEntityToBody:function(){var e=this.data.body;if(e){if(this._getEntityTransform(wd),e.setWorldTransform(wd),"kinematic"===this.type){var t=e.getMotionState();t&&t.setWorldTransform(wd)}e.activate()}},_updateDynamic:function(){var e=this.data.body;if(e.isActive()&&(e=e.getMotionState())){e.getWorldTransform(wd),e=wd.getOrigin();var t=wd.getRotation();this.entity.setPosition(e.x(),e.y(),e.z()),this.entity.setRotation(t.x(),t.y(),t.z(),t.w())}},_updateKinematic:function(){var e=this.data.body.getMotionState();e&&(this._getEntityTransform(wd),e.setWorldTransform(wd))},teleport:function(){3>arguments.length?(arguments[0]&&this.entity.setPosition(arguments[0]),arguments[1]&&(arguments[1]instanceof S?this.entity.setRotation(arguments[1]):this.entity.setEulerAngles(arguments[1]))):(6===arguments.length&&this.entity.setEulerAngles(arguments[3],arguments[4],arguments[5]),this.entity.setPosition(arguments[0],arguments[1],arguments[2])),this.syncEntityToBody()},onEnable:function(){this.body||this.createBody(),this.enableSimulation()},onDisable:function(){this.disableSimulation()},onSetMass:function(e,t,i){(e=this.data.body)&&"dynamic"===this.type&&((t=this.enabled&&this.entity.enabled)&&this.disableSimulation(),e.getCollisionShape().calculateLocalInertia(i,Md),e.setMassProps(i,Md),e.updateInertiaTensor(),t&&this.enableSimulation())},onSetLinearDamping:function(e,t,i){(e=this.data.body)&&e.setDamping(i,this.data.angularDamping)},onSetAngularDamping:function(e,t,i){(e=this.data.body)&&e.setDamping(this.data.linearDamping,i)},onSetLinearFactor:function(e,t,i){(e=this.data.body)&&"dynamic"===this.type&&(Md.setValue(i.x,i.y,i.z),e.setLinearFactor(Md))},onSetAngularFactor:function(e,t,i){(e=this.data.body)&&"dynamic"===this.type&&(Md.setValue(i.x,i.y,i.z),e.setAngularFactor(Md))},onSetFriction:function(e,t,i){(e=this.data.body)&&e.setFriction(i)},onSetRestitution:function(e,t,i){(e=this.data.body)&&e.setRestitution(i)},onSetType:function(e,t,i){i!==t&&(this.disableSimulation(),"dynamic"===i?(this.data.group=1,this.data.mask=65535):"kinematic"===i?(this.data.group=4,this.data.mask=65535):(this.data.group=Sc,this.data.mask=Tc),this.createBody())},onSetGroupOrMask:function(e,t,i){i!==t&&this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation())},onSetBody:function(e,t,i){this.body&&this.data.simulationEnabled&&this.body.activate()}});var Id,Od,Rd={},Dd={},Ld="enabled type mass linearDamping angularDamping linearFactor angularFactor friction restitution group mask body".split(" ");sn.prototype=Object.create(zi.prototype),sn.prototype.constructor=sn,Ui._buildAccessors(Zs.prototype,Ld),Object.assign(sn.prototype,{onLibraryLoaded:function(){if("undefined"!=typeof Ammo){if(this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.dynamicsWorld.setInternalTickCallback){var e=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(e)}Id=new Ammo.btVector3,Od=new Ammo.btVector3,this.contactPointPool=new Ks(en,1),this.contactResultPool=new Ks(tn,1),this.singleContactResultPool=new Ks(Js,1),zi.bind("update",this.onUpdate,this)}else zi.unbind("update",this.onUpdate,this)},initializeComponentData:function(e,t,s){for(var n={},r=0,a=(s="enabled mass linearDamping angularDamping linearFactor angularFactor friction restitution type group mask".split(" ")).length;r<a;r++){var o=s[r];n[o]=t[o]}t.bodyType&&(n.type=t.bodyType),n.linearFactor&&"array"===i(n.linearFactor)&&(n.linearFactor=new v(n.linearFactor[0],n.linearFactor[1],n.linearFactor[2])),n.angularFactor&&"array"===i(n.angularFactor)&&(n.angularFactor=new v(n.angularFactor[0],n.angularFactor[1],n.angularFactor[2])),zi.prototype.initializeComponentData.call(this,e,n,s)},cloneComponent:function(e,t){this.addComponent(t,{enabled:e.rigidbody.enabled,mass:e.rigidbody.mass,linearDamping:e.rigidbody.linearDamping,angularDamping:e.rigidbody.angularDamping,linearFactor:[e.rigidbody.linearFactor.x,e.rigidbody.linearFactor.y,e.rigidbody.linearFactor.z],angularFactor:[e.rigidbody.angularFactor.x,e.rigidbody.angularFactor.y,e.rigidbody.angularFactor.z],friction:e.rigidbody.friction,restitution:e.rigidbody.restitution,type:e.rigidbody.type,group:e.rigidbody.group,mask:e.rigidbody.mask})},onBeforeRemove:function(e,t){t.enabled&&(t.enabled=!1)},onRemove:function(e,t){(e=t.body)&&(this.removeBody(e),this.destroyBody(e),t.body=null)},addBody:function(e,t,i){void 0!==t&&void 0!==i?this.dynamicsWorld.addRigidBody(e,t,i):this.dynamicsWorld.addRigidBody(e)},removeBody:function(e){this.dynamicsWorld.removeRigidBody(e)},createBody:function(e,t,i){var s=new Ammo.btVector3(0,0,0);return 0!==e&&t.calculateLocalInertia(e,s),i=new Ammo.btDefaultMotionState(i),e=new Ammo.btRigidBodyConstructionInfo(e,i,t,s),t=new Ammo.btRigidBody(e),Ammo.destroy(e),Ammo.destroy(s),t},destroyBody:function(e){var t=e.getMotionState();t&&Ammo.destroy(t),Ammo.destroy(e)},raycastFirst:function(e,t){var i=null;Id.setValue(e.x,e.y,e.z),Od.setValue(t.x,t.y,t.z);var s=new Ammo.ClosestRayResultCallback(Id,Od);if(this.dynamicsWorld.rayTest(Id,Od,s),s.hasHit()){var n=s.get_m_collisionObject();if(n=Ammo.castObject(n,Ammo.btRigidBody)){i=s.get_m_hitPointWorld();var r=s.get_m_hitNormalWorld();i=new Qs(n.entity,new v(i.x(),i.y(),i.z()),new v(r.x(),r.y(),r.z())),2<arguments.length&&(0,arguments[2])(i)}}return Ammo.destroy(s),i},raycastAll:function(e,t){var i=[];if(Id.setValue(e.x,e.y,e.z),Od.setValue(t.x,t.y,t.z),e=new Ammo.AllHitsRayResultCallback(Id,Od),this.dynamicsWorld.rayTest(Id,Od,e),e.hasHit()){t=e.get_m_collisionObjects();for(var s=e.get_m_hitPointWorld(),n=e.get_m_hitNormalWorld(),r=t.size(),a=0;a<r;a++){var o=Ammo.castObject(t.at(a),Ammo.btRigidBody);if(o){var h=s.at(a),l=n.at(a);o=new Qs(o.entity,new v(h.x(),h.y(),h.z()),new v(l.x(),l.y(),l.z())),i.push(o)}}}return Ammo.destroy(e),i},_storeCollision:function(e,t){var i=!1,s=e.getGuid();return Rd[s]=Rd[s]||{others:[],entity:e},0>Rd[s].others.indexOf(t)&&(Rd[s].others.push(t),i=!0),Dd[s]=Dd[s]||{others:[],entity:e},Dd[s].others.push(t),i},_createContactPointFromAmmo:function(e){var t=e.get_m_localPointA(),i=e.get_m_localPointB(),s=e.getPositionWorldOnA(),n=e.getPositionWorldOnB();e=e.get_m_normalWorldOnB();var r=this.contactPointPool.allocate();return r.localPoint.set(t.x(),t.y(),t.z()),r.localPointOther.set(i.x(),i.y(),i.z()),r.point.set(s.x(),s.y(),s.z()),r.pointOther.set(n.x(),n.y(),n.z()),r.normal.set(e.x(),e.y(),e.z()),r},_createReverseContactPointFromAmmo:function(e){var t=e.get_m_localPointA(),i=e.get_m_localPointB(),s=e.getPositionWorldOnA(),n=e.getPositionWorldOnB();e=e.get_m_normalWorldOnB();var r=this.contactPointPool.allocate();return r.localPointOther.set(t.x(),t.y(),t.z()),r.localPoint.set(i.x(),i.y(),i.z()),r.pointOther.set(s.x(),s.y(),s.z()),r.point.set(n.x(),n.y(),n.z()),r.normal.set(e.x(),e.y(),e.z()),r},_createSingleContactResult:function(e,t,i){var s=this.singleContactResultPool.allocate();return s.a=e,s.b=t,s.localPointA=i.localPoint,s.localPointB=i.localPointOther,s.pointA=i.point,s.pointB=i.pointOther,s.normal=i.normal,s},_createContactResult:function(e,t){var i=this.contactResultPool.allocate();return i.other=e,i.contacts=t,i},_cleanOldCollisions:function(){for(var e in Rd)if(Rd.hasOwnProperty(e)){for(var t=Dd[e],i=Rd[e],s=i.entity,n=s.collision,r=s.rigidbody,a=(i=i.others).length;a--;){var o=i[a];(!t||0>t.others.indexOf(o))&&(i.splice(a,1),s.trigger?(n&&n.fire("triggerleave",o),o.rigidbody&&o.rigidbody.fire("triggerleave",s)):o.trigger||(r&&r.fire("collisionend",o),n&&n.fire("collisionend",o)))}0===i.length&&delete Rd[e]}},_hasContactEvent:function(e){var t=e.collision;return!(!t||!(t.hasEvent("collisionstart")||t.hasEvent("collisionend")||t.hasEvent("contact")))||(e=e.rigidbody)&&(e.hasEvent("collisionstart")||e.hasEvent("collisionend")||e.hasEvent("contact"))},_checkForCollisions:function(e,t){t=(e=Ammo.wrapPointer(e,Ammo.btDynamicsWorld).getDispatcher()).getNumManifolds(),Dd={};for(var i=0;i<t;i++){var s=e.getManifoldByIndexInternal(i),n=s.getBody0(),r=s.getBody1(),a=Ammo.castObject(n,Ammo.btRigidBody),o=Ammo.castObject(r,Ammo.btRigidBody);if(r=a.entity,n=o.entity,r&&n){var h=a.getCollisionFlags(),l=o.getCollisionFlags(),c=s.getNumContacts(),d=[],u=[];if(0<c)if(4&h||4&l){if(o=r.collision&&(r.collision.hasEvent("triggerenter")||r.collision.hasEvent("triggerleave")),a=n.collision&&(n.collision.hasEvent("triggerenter")||n.collision.hasEvent("triggerleave")),s=r.rigidbody&&(r.rigidbody.hasEvent("triggerenter")||r.rigidbody.hasEvent("triggerleave")),u=n.rigidbody&&(n.rigidbody.hasEvent("triggerenter")||n.rigidbody.hasEvent("triggerleave")),o){var p=this._storeCollision(r,n);!p||4&l||r.collision.fire("triggerenter",n)}a&&(!(p=this._storeCollision(n,r))||4&h||n.collision.fire("triggerenter",r)),s&&(p||(p=this._storeCollision(n,r)),p&&r.rigidbody.fire("triggerenter",n)),u&&(p||(p=this._storeCollision(r,n)),p&&n.rigidbody.fire("triggerenter",r))}else if(o=this._hasContactEvent(r),a=this._hasContactEvent(n),(h=this.hasEvent("contact"))||o||a){for(l=0;l<c;l++){var f=s.getContactPoint(l),m=this._createContactPointFromAmmo(f);(o||a)&&(f=this._createReverseContactPointFromAmmo(f),d.push(m),u.push(f)),h&&(m=this._createSingleContactResult(r,n,m),this.fire("contact",m))}o&&(s=this._createContactResult(n,d),p=this._storeCollision(r,n),r.collision&&(r.collision.fire("contact",s),p&&r.collision.fire("collisionstart",s)),r.rigidbody&&(r.rigidbody.fire("contact",s),p&&r.rigidbody.fire("collisionstart",s))),a&&(s=this._createContactResult(r,u),p=this._storeCollision(n,r),n.collision&&(n.collision.fire("contact",s),p&&n.collision.fire("collisionstart",s)),n.rigidbody&&(n.rigidbody.fire("contact",s),p&&n.rigidbody.fire("collisionstart",s)))}}}this._cleanOldCollisions(),this.contactPointPool.freeAll(),this.contactResultPool.freeAll(),this.singleContactResultPool.freeAll()},onUpdate:function(e){var t,i=this.dynamicsWorld.getGravity();i.x()===this.gravity.x&&i.y()===this.gravity.y&&i.z()===this.gravity.z||(i.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(i));var s=this._triggers;for(i=0,t=s.length;i<t;i++)s[i].updateTransform();for(i=0,t=(s=this._compounds).length;i<t;i++)s[i]._updateCompound();for(i=0,t=(s=this._kinematic).length;i<t;i++)s[i]._updateKinematic();for(this.dynamicsWorld.stepSimulation(e,this.maxSubSteps,this.fixedTimeStep),i=0,t=(s=this._dynamic).length;i<t;i++)s[i]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),e)},destroy:function(){"undefined"!=typeof Ammo&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),this.collisionConfiguration=this.dispatcher=this.overlappingPairCache=this.solver=this.dynamicsWorld=null)}});var Fd="none";nn.prototype=Object.create(Ui.prototype),nn.prototype.constructor=nn;var Bd=new x;Object.assign(nn.prototype,{syncDrawOrder:function(){this.system.queueDrawOrderSync(this.entity.getGuid(),this._processDrawOrderSync,this)},_recurseDrawOrderSync:function(e,t){if(!(e instanceof ut))return t;if(e.element){var i=e.element.drawOrder;e.element.drawOrder=t++,0<=e.element._batchGroupId&&i!=e.element.drawOrder&&this.system.app.batcher.markGroupDirty(e.element._batchGroupId)}for(e=e.children,i=0;i<e.length;i++)t=this._recurseDrawOrderSync(e[i],t);return t},_processDrawOrderSync:function(){this._recurseDrawOrderSync(this.entity,1),this.fire("syncdraworder")},_calcProjectionMatrix:function(){var e=this._resolution.x/this.scale,t=this._resolution.y/this.scale;this._screenMatrix.setOrtho(0,e,-t,0,1,-1),this._screenSpace||(Bd.setScale(.5*e,.5*t,1),this._screenMatrix.mul2(Bd,this._screenMatrix))},_updateScale:function(){this.scale=this._calcScale(this._resolution,this.referenceResolution)},_calcScale:function(e,t){return Math.pow(2,Math.log2(e.x/t.x)*(1-this._scaleBlend)+Math.log2(e.y/t.y)*this._scaleBlend)},_onResize:function(e,t){this._screenSpace&&(this._resolution.set(e,t),this.resolution=this._resolution)},onRemove:function(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.fire("remove"),this.off()}}),Object.defineProperty(nn.prototype,"resolution",{set:function(e){this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:resolution",this._resolution)},get:function(){return this._resolution}}),Object.defineProperty(nn.prototype,"referenceResolution",{set:function(e){this._referenceResolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:referenceresolution",this._resolution)},get:function(){return this._scaleMode===Fd?this._resolution:this._referenceResolution}}),Object.defineProperty(nn.prototype,"screenSpace",{set:function(e){(this._screenSpace=e)&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height),this.resolution=this._resolution,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:screenspace",this._screenSpace)},get:function(){return this._screenSpace}}),Object.defineProperty(nn.prototype,"scaleMode",{set:function(e){e!==Fd&&"blend"!==e&&(e=Fd),this._screenSpace||e===Fd||(e=Fd),this._scaleMode=e,this.resolution=this._resolution,this.fire("set:scalemode",this._scaleMode)},get:function(){return this._scaleMode}}),Object.defineProperty(nn.prototype,"scaleBlend",{set:function(e){this._scaleBlend=e,this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:scaleblend",this._scaleBlend)},get:function(){return this._scaleBlend}}),Object.defineProperty(nn.prototype,"priority",{get:function(){return this._priority},set:function(e){255<e&&(e=255),this._priority=e}});var Nd=["enabled"];an.prototype=Object.create(zi.prototype),an.prototype.constructor=an,Ui._buildAccessors(nn.prototype,Nd),Object.assign(an.prototype,{initializeComponentData:function(e,t,i){void 0!==t.priority&&(e.priority=t.priority),void 0!==t.screenSpace&&(e.screenSpace=t.screenSpace),e.cull=e.screenSpace,void 0!==t.scaleMode&&(e.scaleMode=t.scaleMode),void 0!==t.scaleBlend&&(e.scaleBlend=t.scaleBlend),void 0!==t.resolution&&(t.resolution instanceof T?e._resolution.copy(t.resolution):e._resolution.set(t.resolution[0],t.resolution[1]),e.resolution=e._resolution),void 0!==t.referenceResolution&&(t.referenceResolution instanceof T?e._referenceResolution.copy(t.referenceResolution):e._referenceResolution.set(t.referenceResolution[0],t.referenceResolution[1]),e.referenceResolution=e._referenceResolution),e.syncDrawOrder(),zi.prototype.initializeComponentData.call(this,e,t,i)},destroy:function(){this.off(),this.app.graphicsDevice.off("resizecanvas",this._onResize,this)},_onUpdate:function(e){var t,i=this.store;for(t in i)i[t].entity.screen.update&&i[t].entity.screen.update(e)},_onResize:function(e,t){this.windowResolution.x=e,this.windowResolution.y=t},cloneComponent:function(e,t){return e=e.screen,this.addComponent(t,{enabled:e.enabled,screenSpace:e.screenSpace,scaleMode:e.scaleMode,resolution:e.resolution.clone(),referenceResolution:e.referenceResolution.clone()})},onRemoveComponent:function(e,t){t.onRemove()},processDrawOrderSyncQueue:function(){for(var e=this._drawOrderSyncQueue.list(),t=0;t<e.length;t++){var i=e[t];i.callback.call(i.scope)}this._drawOrderSyncQueue.clear()},queueDrawOrderSync:function(e,t,i){this._drawOrderSyncQueue.list().length||this.app.once("prerender",this.processDrawOrderSyncQueue,this),this._drawOrderSyncQueue.has(e)||this._drawOrderSyncQueue.push(e,{callback:t,scope:i})}});var kd=["x","y","z","w"],Ud=function(e,t,i,s){switch(t.type){case"boolean":return!!i;case"number":if("number"==typeof i)break;return"string"==typeof i?(i=parseInt(i,10),isNaN(i)?null:i):"boolean"==typeof i?0+i:null;case"json":if("object"==typeof i)break;try{return JSON.parse(i)}catch(e){return null}case"asset":if(i instanceof Pt)break;return"number"==typeof i?e.assets.get(i)||null:"string"==typeof i&&e.assets.get(parseInt(i,10))||null;case"entity":if(i instanceof ge)break;return"string"==typeof i?e.getEntityFromIndex(i):null;case"rgb":case"rgba":if(i instanceof h)return s instanceof h?(s.copy(i),s):i.clone();if(i instanceof Array&&3<=i.length&&4>=i.length){for(e=0;e<i.length;e++)if("number"!=typeof i[e])return null;return s||(s=new h),s.r=i[0],s.g=i[1],s.b=i[2],s.a=3===i.length?1:i[3],s}return"string"==typeof i&&/#([0-9abcdef]{2}){3,4}/i.test(i)?(s||(s=new h),s.fromString(i),s):null;case"vec2":case"vec3":case"vec4":if(t=parseInt(t.type.slice(3),10),i instanceof pc["Vec"+t])return s instanceof pc["Vec"+t]?(s.copy(i),s):i.clone();if(i instanceof Array&&i.length===t){for(e=0;e<i.length;e++)if("number"!=typeof i[e])return null;for(s||(s=new pc["Vec"+t]),e=0;e<t;e++)s[kd[e]]=i[e];return s}return null;case"curve":if(i)return i instanceof _||i instanceof g?s=i.clone():(s=new(i.keys[0]instanceof Array?g:_)(i.keys)).type=i.type,s}return i};on.prototype.add=function(e,t){this.index[e]||ln.reservedAttributes[e]||(this.index[e]=t,Object.defineProperty(this.scriptType.prototype,e,{get:function(){return this.__attributes[e]},set:function(i){var s=this.__attributes[e];if(t.array){if(this.__attributes[e]=[],i){var n,r=0;for(n=i.length;r<n;r++)this.__attributes[e].push(Ud(this.app,t,i[r],s?s[r]:null))}}else this.__attributes[e]=Ud(this.app,t,i,s);this.fire("attr",e,this.__attributes[e],s),this.fire("attr:"+e,this.__attributes[e],s)}}))},on.prototype.remove=function(e){return!!this.index[e]&&(delete this.index[e],delete this.scriptType.prototype[e],!0)},on.prototype.has=function(e){return!!this.index[e]},on.prototype.get=function(e){return this.index[e]||null};var zd=/^\s*function(?:\s|\s*\/\*.*\*\/\s*)+([^\(\s\/]*)\s*/;hn.prototype=Object.create(r.prototype),hn.prototype.constructor=hn,hn.__name=null,hn.__getScriptName=function(e){if("function"==typeof e)return"name"in Function.prototype?e.name:e===Function||e===Function.prototype.constructor?"Function":(e=(""+e).match(zd))?e[1]:void 0},Object.defineProperty(hn,"scriptName",{get:function(){return this.__name}}),Object.defineProperty(hn,"attributes",{get:function(){return this.hasOwnProperty("__attributes")||(this.__attributes=new on(this)),this.__attributes}}),hn.prototype.__initializeAttributes=function(e){if(e||this.__attributesRaw){for(var t in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(t)?this[t]=this.__attributesRaw[t]:this.__attributes.hasOwnProperty(t)||(this.__scriptType.attributes.index[t].hasOwnProperty("default")?this[t]=this.__scriptType.attributes.index[t].default:this[t]=null);this.__attributesRaw=null}},hn.extend=function(e){for(var t in e)e.hasOwnProperty(t)&&(this.prototype[t]=e[t])},Object.defineProperty(hn.prototype,"enabled",{get:function(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled},set:function(e){this._enabled=!!e,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.__initializeAttributes(!0),this.initialize&&this.entity.script._scriptMethod(this,un.scriptMethods.initialize)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,un.scriptMethods.postInitialize)))}}),ln.reservedScripts="system entity create destroy swap move scripts _scripts _scriptsIndex _scriptsData enabled _oldState onEnable onDisable onPostStateChange _onSetEnabled _checkState _onBeforeRemove _onInitializeAttributes _onInitialize _onPostInitialize _onUpdate _onPostUpdate _callbacks has get on off fire once hasEvent".split(" ");var Vd,Gd={};for(Vd=0;Vd<ln.reservedScripts.length;Vd++)Gd[ln.reservedScripts[Vd]]=1;ln.reservedScripts=Gd,ln.reservedAttributes="app entity enabled _enabled _enabledOld _destroyed __attributes __attributesRaw __scriptType __executionOrder _callbacks has get on off fire once hasEvent".split(" ");var jd={};for(Vd=0;Vd<ln.reservedAttributes.length;Vd++)jd[ln.reservedAttributes[Vd]]=1;ln.reservedAttributes=jd,dn.prototype._binarySearch=function(e){var t,i,s=0,n=this.items.length-1;for(e=e[this._sortBy];s<=n;)t=Math.floor((s+n)/2),(i=this.items[t][this._sortBy])<=e?s=t+1:i>e&&(n=t-1);return s},dn.prototype._doSort=function(e,t){var i=this._sortBy;return e[i]-t[i]},dn.prototype.insert=function(e){var t=this._binarySearch(e);this.items.splice(t,0,e),this.length++,this.loopIndex>=t&&this.loopIndex++},dn.prototype.append=function(e){this.items.push(e),this.length++},dn.prototype.remove=function(e){0>(e=this.items.indexOf(e))||(this.items.splice(e,1),this.length--,this.loopIndex>=e&&this.loopIndex--)},dn.prototype.sort=function(){var e=0<=this.loopIndex?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),null!==e&&(this.loopIndex=this.items.indexOf(e))},un.prototype=Object.create(Ui.prototype),un.prototype.constructor=un,un.scriptMethods={initialize:"initialize",postInitialize:"postInitialize",update:"update",postUpdate:"postUpdate",swap:"swap"},Object.assign(un.prototype,{onEnable:function(){this._beingEnabled=!0,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=!1},onDisable:function(){this._checkState()},onPostStateChange:function(){for(var e,t=this._beginLooping(),i=0,s=this.scripts.length;i<s;i++)(e=this.scripts[i])._initialized&&!e._postInitialized&&e.enabled&&(e._postInitialized=!0,e.postInitialize&&this._scriptMethod(e,un.scriptMethods.postInitialize));this._endLooping(t)},_beginLooping:function(){var e=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=!0,e},_endLooping:function(e){(this._isLoopingThroughScripts=e)||this._removeDestroyedScripts()},_onSetEnabled:function(e,t,i){this._beingEnabled=!0,this._checkState(),this._beingEnabled=!1},_checkState:function(){var e=this.enabled&&this.entity.enabled;if(e!==this._oldState){this._oldState=e,this.fire(e?"enable":"disable"),this.fire("state",e),e?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this),e=this._beginLooping();for(var t,i=0,s=this.scripts.length;i<s;i++)(t=this.scripts[i]).enabled=t._enabled;this._endLooping(e)}},_onBeforeRemove:function(){this.fire("remove");for(var e=this._beginLooping(),t=0;t<this.scripts.length;t++){var i=this.scripts[t];i&&this.destroy(i.__scriptType.__name)}this._endLooping(e)},_removeDestroyedScripts:function(){var e=this._destroyedScripts.length;if(e){var t;for(t=0;t<e;t++)this._removeScriptInstance(this._destroyedScripts[t]);this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length)}},_onInitializeAttributes:function(){for(var e=0,t=this.scripts.length;e<t;e++)this.scripts[e].__initializeAttributes()},_scriptMethod:function(e,t,i){e[t](i)},_onInitialize:function(){for(var e,t=this._scripts,i=this._beginLooping(),s=0,n=t.length;s<n;s++)!(e=t[s])._initialized&&e.enabled&&(e._initialized=!0,e.initialize&&this._scriptMethod(e,un.scriptMethods.initialize));this._endLooping(i)},_onPostInitialize:function(){this.onPostStateChange()},_onUpdate:function(e){var t=this._updateList;if(t.length){var i=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){var s=t.items[t.loopIndex];s.enabled&&this._scriptMethod(s,un.scriptMethods.update,e)}this._endLooping(i)}},_onPostUpdate:function(e){var t=this._postUpdateList;if(t.length){var i=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){var s=t.items[t.loopIndex];s.enabled&&this._scriptMethod(s,un.scriptMethods.postUpdate,e)}this._endLooping(i)}},_insertScriptInstance:function(e,t,i){-1===t?(this._scripts.push(e),e.__executionOrder=i,e.update&&this._updateList.append(e),e.postUpdate&&this._postUpdateList.append(e)):(this._scripts.splice(t,0,e),e.__executionOrder=t,this._resetExecutionOrder(t+1,i+1),e.update&&this._updateList.insert(e),e.postUpdate&&this._postUpdateList.insert(e))},_removeScriptInstance:function(e){var t=this._scripts.indexOf(e);return-1===t?t:(this._scripts.splice(t,1),e.update&&this._updateList.remove(e),e.postUpdate&&this._postUpdateList.remove(e),t)},_resetExecutionOrder:function(e,t){for(;e<t;e++)this._scripts[e].__executionOrder=e},has:function(e){if("string"==typeof e)return!!this._scriptsIndex[e];if(!e)return!1;var t=this._scriptsIndex[e.__name];return(t&&t.instance)instanceof e},get:function(e){if("string"==typeof e)return(e=this._scriptsIndex[e])?e.instance:null;if(!e)return null;var t=this._scriptsIndex[e.__name];return(t=t&&t.instance)instanceof e?t:null},create:function(e,t){var i=this;t=t||{};var s=e,n=e;if("string"==typeof s?s=this.system.app.scripts.get(s):s&&(n=s.__name),s){if(!this._scriptsIndex[n]||!this._scriptsIndex[n].instance){e=new s({app:this.system.app,entity:this.entity,enabled:!t.hasOwnProperty("enabled")||t.enabled,attributes:t.attributes}),s=this._scripts.length;var r=-1;return"number"==typeof t.ind&&-1!==t.ind&&s>t.ind&&(r=t.ind),this._insertScriptInstance(e,r,s),this._scriptsIndex[n]={instance:e,onSwap:function(){i.swap(n)}},this[n]=e,t.preloading||e.__initializeAttributes(),this.fire("create",n,e),this.fire("create:"+n,e),this.system.app.scripts.on("swap:"+n,this._scriptsIndex[n].onSwap),t.preloading||(e.enabled&&!e._initialized&&(e._initialized=!0,e.initialize&&this._scriptMethod(e,un.scriptMethods.initialize)),e.enabled&&!e._postInitialized&&(e._postInitialized=!0,e.postInitialize&&this._scriptMethod(e,un.scriptMethods.postInitialize))),e}console.warn("script '"+n+"' is already added to entity '"+this.entity.name+"'")}else this._scriptsIndex[n]={awaiting:!0,ind:this._scripts.length},console.warn("script '"+n+"' is not found, awaiting it to be added to registry");return null},destroy:function(e){var t=e;if("string"==typeof e?this.system.app.scripts.get(e):e&&(t=e.__name),e=this._scriptsIndex[t],delete this._scriptsIndex[t],!e)return!1;var i=e.instance;if(i&&!i._destroyed)if(i.enabled=!1,i._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(i);else{var s=this._removeScriptInstance(i);0<=s&&this._resetExecutionOrder(s,this._scripts.length)}return this.system.app.scripts.off("swap:"+t,e.onSwap),delete this[t],this.fire("destroy",t,i||null),this.fire("destroy:"+t,i||null),i&&i.fire("destroy"),!0},swap:function(e){var t=e;"string"==typeof e?e=this.system.app.scripts.get(e):e&&(t=e.__name);var i=this._scriptsIndex[t];if(!i||!i.instance)return!1;i=i.instance;var s=this._scripts.indexOf(i);return!!(e=new e({app:this.system.app,entity:this.entity,enabled:i.enabled,attributes:i.__attributes})).swap&&(e.__initializeAttributes(),this._scripts[s]=e,this._scriptsIndex[t].instance=e,this[t]=e,e.__executionOrder=s,i.update&&this._updateList.remove(i),i.postUpdate&&this._postUpdateList.remove(i),e.update&&this._updateList.insert(e),e.postUpdate&&this._postUpdateList.insert(e),this._scriptMethod(e,un.scriptMethods.swap,i),this.fire("swap",t,e),this.fire("swap:"+t,e),!0)},resolveDuplicatedEntityReferenceProperties:function(e,t){var i,s=this.entity.script;for(i in e._scriptsIndex){var n=this.system.app.scripts.get(i);if(n){var r=e._scriptsIndex[i];if(r&&r.instance){var a=s[i].__attributesRaw,o=s[i].__attributes;if(a||o)for(var h in r=r.instance.__attributes)if(r[h]){var l=n.attributes.get(h);if(l&&"entity"===l.type)if(l.array){var c=r[h];if(l=c.length){c=c.slice();for(var d=0;d<l;d++){var u=c[d]instanceof ut?c[d].getGuid():c[d];t[u]&&(c[d]=a?t[u].getGuid():t[u])}a?a[h]=c:o[h]=c}}else{if((l=r[h])instanceof ut)l=l.getGuid();else if("string"!=typeof l)continue;t[l]&&(a?a[h]=t[l].getGuid():o[h]=t[l])}}}}}},move:function(e,t){var i=this._scripts.length;if(t>=i||0>t)return!1;var s=e,n=e;return"string"!=typeof n?n=e.__name:s=null,!(!(e=this._scriptsIndex[n])||!e.instance)&&(e=e.instance,(!s||e instanceof s)&&(-1!==(s=this._scripts.indexOf(e))&&s!==t&&(this._scripts.splice(t,0,this._scripts.splice(s,1)[0]),this._resetExecutionOrder(0,i),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",n,e,t,s),this.fire("move:"+n,e,t,s),!0)))}}),Object.defineProperty(un.prototype,"enabled",{get:function(){return this._enabled},set:function(e){var t=this._enabled;this._enabled=e,this.fire("set","enabled",t,e)}}),Object.defineProperty(un.prototype,"scripts",{get:function(){return this._scripts},set:function(e){for(var t in this._scriptsData=e,e)if(e.hasOwnProperty(t)){var i=this._scriptsIndex[t];if(i){if("boolean"==typeof e[t].enabled&&(i.enabled=!!e[t].enabled),"object"==typeof e[t].attributes)for(var s in e[t].attributes)if(!ln.reservedAttributes[s]){if(!i.__attributes.hasOwnProperty(s)){var n=this.system.app.scripts.get(t);n&&n.attributes.add(s,{})}i[s]=e[t].attributes[s]}}else console.log(this.order)}}});var Wd=0;fn.prototype=Object.create(zi.prototype),fn.prototype.constructor=fn,Object.assign(fn.prototype,{initializeComponentData:function(e,t){if(e._executionOrder=Wd++,this._components.append(e),Wd>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder(),e.enabled=!t.hasOwnProperty("enabled")||!!t.enabled,e.enabled&&e.entity.enabled&&this._enabledComponents.append(e),t.hasOwnProperty("order")&&t.hasOwnProperty("scripts")){e._scriptsData=t.scripts;for(var i=0;i<t.order.length;i++)e.create(t.order[i],{enabled:t.scripts[t.order[i]].enabled,attributes:t.scripts[t.order[i]].attributes,preloading:this.preloading})}},cloneComponent:function(e,t){var i,s,n=[],r={};for(i=0;i<e.script._scripts.length;i++){var a=e.script._scripts[i],o=a.__scriptType.__name;n.push(o);var h={};for(s in a.__attributes)h[s]=a.__attributes[s];r[o]={enabled:a._enabled,attributes:h}}for(s in e.script._scriptsIndex)s.awaiting&&n.splice(s.ind,0,s);return this.addComponent(t,{enabled:e.script.enabled,order:n,scripts:r})},_resetExecutionOrder:function(){for(var e=Wd=0,t=this._components.length;e<t;e++)this._components.items[e]._executionOrder=Wd++},_callComponentMethod:function(e,t,i){for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++)e.items[e.loopIndex][t](i)},_onInitialize:function(){this.preloading=!1,this._callComponentMethod(this._components,"_onInitializeAttributes"),this._callComponentMethod(this._enabledComponents,"_onInitialize")},_onPostInitialize:function(){this._callComponentMethod(this._enabledComponents,"_onPostInitialize")},_onUpdate:function(e){this._callComponentMethod(this._enabledComponents,"_onUpdate",e)},_onPostUpdate:function(e){this._callComponentMethod(this._enabledComponents,"_onPostUpdate",e)},_addComponentToEnabled:function(e){this._enabledComponents.insert(e)},_removeComponentFromEnabled:function(e){this._enabledComponents.remove(e)},_onBeforeRemove:function(e,t){0<=this._components.items.indexOf(t)&&t._onBeforeRemove(),this._removeComponentFromEnabled(t),this._components.remove(t)}}),mn.prototype=Object.create(Ui.prototype),mn.prototype.constructor=mn,Object.assign(mn.prototype,{send:function(e,i){console.warn("DEPRECATED: ScriptLegacyComponent.send() is deprecated and will be removed soon. Please use: http://developer.playcanvas.com/user-manual/scripting/communication/");var s,n=t(arguments).slice(2),r=this.entity.script.instances;if(r&&r[e]&&(s=r[e].instance[i]))return s.apply(r[e].instance,n)},onEnable:function(){this.data.areScriptsLoaded&&!this.system.preloading&&(this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||this.system._postInitializeScriptComponent(this))},onDisable:function(){this.system._disableScriptComponent(this)},onSetScripts:function(e,t,i){this.system._inTools&&!this.runInTools||this._updateScriptAttributes(t,i)||(this.enabled&&this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),this.data.areScriptsLoaded=!1,e=i.map(function(e){return e.url}),this._loadFromCache(e)||this._loadScripts(e))},_updateScriptAttributes:function(e,t){var i=!0;if(e.length!==t.length)i=!1;else{var s,n=t.length;for(s=0;s<n;s++)if(e[s].url!==t[s].url){i=!1;break}}if(i)for(var r in this.instances)this.instances.hasOwnProperty(r)&&this.system._updateAccessors(this.entity,this.instances[r]);return i},_loadFromCache:function(e){var t,i=[],s=this.system.app._scriptPrefix||"",n=/^http(s)?:\/\//i,r=0;for(t=e.length;r<t;r++){var a=e[r];if(n.test(a)||(a=zr.join(s,a)),!(a=this.system.app.loader.getFromCache(a,"script")))return!1;i.push(a)}for(r=0,t=i.length;r<t;r++)!0!==(s=i[r])&&s&&this.entity.script&&!this.entity.script.instances[s._pcScriptName]&&(n=new s(this.entity),this.system._preRegisterInstance(this.entity,e[r],s._pcScriptName,n));return this.data&&(this.data.areScriptsLoaded=!0),this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)),!0},_loadScripts:function(e){var t=e.length,i=this.system.app._scriptPrefix||"";e.forEach(function(e){var s=null,n=null;e.toLowerCase().startsWith("http://")||e.toLowerCase().startsWith("https://")?s=n=e:(n=e,s=zr.join(i,e)),this.system.app.loader.load(s,"script",function(e,i){t--,e?console.error(e):i&&this.entity.script&&!this.entity.script.instances[i._pcScriptName]&&(e=new i(this.entity),this.system._preRegisterInstance(this.entity,n,i._pcScriptName,e)),0===t&&(this.data.areScriptsLoaded=!0,this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)))}.bind(this))}.bind(this))}});var Hd=["enabled","scripts","instances","runInTools"],Xd=function(e){zi.call(this,e),this.id="script",this.description="Allows the Entity to run JavaScript fragments to implement custom behavior.",this.ComponentType=mn,this.DataType=_n,this.schema=Hd,this.preloading=!1,this.instancesWithUpdate=[],this.instancesWithFixedUpdate=[],this.instancesWithPostUpdate=[],this.instancesWithToolsUpdate=[],this.on("beforeremove",this.onBeforeRemove,this),zi.bind("initialize",this.onInitialize,this),zi.bind("postInitialize",this.onPostInitialize,this),zi.bind("update",this.onUpdate,this),zi.bind("fixedUpdate",this.onFixedUpdate,this),zi.bind("postUpdate",this.onPostUpdate,this),zi.bind("toolsUpdate",this.onToolsUpdate,this)};Xd.prototype=Object.create(zi.prototype),Xd.prototype.constructor=Xd,Ui._buildAccessors(mn.prototype,Hd),Object.assign(Xd.prototype,{initializeComponentData:function(e,t,s){s=["runInTools","enabled","scripts"],t.scripts&&t.scripts.length&&t.scripts.forEach(function(e){if(e.attributes&&"array"===i(e.attributes)){for(var t={},s=0;s<e.attributes.length;s++)t[e.attributes[s].name]=e.attributes[s];e.attributes=t}}),zi.prototype.initializeComponentData.call(this,e,t,s)},cloneComponent:function(e,t){var i=this.store[e.getGuid()];e={runInTools:i.data.runInTools,scripts:[],enabled:i.data.enabled};for(var n=0,r=(i=i.data.scripts).length;n<r;n++){var a=i[n].attributes;a&&delete i[n].attributes,e.scripts.push(s({},i[n])),a&&(e.scripts[n].attributes=this._cloneAttributes(a),i[n].attributes=a)}return this.addComponent(t,e)},onBeforeRemove:function(e,t){t.enabled&&this._disableScriptComponent(t),this._destroyScriptComponent(t)},onInitialize:function(e){if(this._registerInstances(e),e.enabled){e.script&&e.script.enabled&&this._initializeScriptComponent(e.script);var t,i=(e=e._children).length;for(t=0;t<i;t++)e[t]instanceof ut&&this.onInitialize(e[t])}},onPostInitialize:function(e){if(e.enabled){e.script&&e.script.enabled&&this._postInitializeScriptComponent(e.script);var t,i=(e=e._children).length;for(t=0;t<i;t++)e[t]instanceof ut&&this.onPostInitialize(e[t])}},_callInstancesMethod:function(e,t){for(var i in e=e.data.instances)if(e.hasOwnProperty(i)){var s=e[i].instance;s[t]&&s[t]()}},_initializeScriptComponent:function(e){this._callInstancesMethod(e,"initialize"),e.data.initialized=!0,e.enabled&&e.entity.enabled&&this._enableScriptComponent(e)},_enableScriptComponent:function(e){this._callInstancesMethod(e,"onEnable")},_disableScriptComponent:function(e){this._callInstancesMethod(e,"onDisable")},_destroyScriptComponent:function(e){var t,i=e.data.instances;for(t in i)if(i.hasOwnProperty(t)){var s=i[t].instance;if(s.destroy&&s.destroy(),s.update){var n=this.instancesWithUpdate.indexOf(s);0<=n&&this.instancesWithUpdate.splice(n,1)}s.fixedUpdate&&(0<=(n=this.instancesWithFixedUpdate.indexOf(s))&&this.instancesWithFixedUpdate.splice(n,1)),s.postUpdate&&(0<=(n=this.instancesWithPostUpdate.indexOf(s))&&this.instancesWithPostUpdate.splice(n,1)),s.toolsUpdate&&(0<=(n=this.instancesWithToolsUpdate.indexOf(s))&&this.instancesWithToolsUpdate.splice(n,1)),e.instances[t].instance===e[t]&&delete e[t],delete e.instances[t]}},_postInitializeScriptComponent:function(e){this._callInstancesMethod(e,"postInitialize"),e.data.postInitialized=!0},_updateInstances:function(e,t,i){for(var s,n=0,r=t.length;n<r;n++)(s=t[n])&&s.entity&&s.entity.enabled&&s.entity.script.enabled&&s[e](i)},onUpdate:function(e){this._updateInstances("update",this.instancesWithUpdate,e)},onFixedUpdate:function(e){this._updateInstances("fixedUpdate",this.instancesWithFixedUpdate,e)},onPostUpdate:function(e){this._updateInstances("postUpdate",this.instancesWithPostUpdate,e)},onToolsUpdate:function(e){this._updateInstances("toolsUpdate",this.instancesWithToolsUpdate,e)},broadcast:function(e,i){console.warn("DEPRECATED: ScriptLegacyComponentSystem.broadcast() is deprecated and will be removed soon. Please use: http://developer.playcanvas.com/user-manual/scripting/communication/");var s,n,r=t(arguments).slice(2),a=this.store;for(s in a)if(a.hasOwnProperty(s)){var o=a[s].data;o.instances[e]&&(n=o.instances[e].instance[i])&&n.apply(o.instances[e].instance,r)}},_preRegisterInstance:function(e,t,i,s){if(e.script){if(e.script.data._instances=e.script.data._instances||{},e.script.data._instances[i])throw Error("Script name collision '"+i+"'. Scripts from '"+t+"' and '"+e.script.data._instances[i].url+"' {"+e.getGuid()+"}");e.script.data._instances[i]={url:t,name:i,instance:s}}},_registerInstances:function(e){var t;if(e.script&&e.script.data._instances){for(t in e.script.instances=e.script.data._instances,e.script.instances){var i=e.script.instances[t],s=i.instance;if(kr.attach(s),s.update&&this.instancesWithUpdate.push(s),s.fixedUpdate&&this.instancesWithFixedUpdate.push(s),s.postUpdate&&this.instancesWithPostUpdate.push(s),s.toolsUpdate&&this.instancesWithToolsUpdate.push(s),e.script.scripts&&this._createAccessors(e,i),e.script[t])throw Error("Script with name '"+t+"' is already attached to Script Component");e.script[t]=s}delete e.script.data._instances}for(s=(e=e._children).length,i=0;i<s;i++)e[i]instanceof ut&&this._registerInstances(e[i])},_cloneAttributes:function(e){var t,i={};for(t in e)if(e.hasOwnProperty(t))if("entity"!==e[t].type)i[t]=s({},e[t]);else{var n=e[t].value;delete e[t].value,i[t]=s({},e[t]),i[t].value=n,e[t].value=n}return i},_createAccessors:function(e,t){var i,s=e.script.scripts.length,n=t.url;for(i=0;i<s;i++){var r=e.script.scripts[i];if(r.url===n){if(i=r.attributes,r.name&&i){for(var a in i)i.hasOwnProperty(a)&&this._createAccessor(i[a],t);e.script.data.attributes[r.name]=this._cloneAttributes(i)}break}}},_createAccessor:function(e,t){var i=this;e={name:e.name,value:e.value,type:e.type},i._convertAttributeValue(e),Object.defineProperty(t.instance,e.name,{get:function(){return e.value},set:function(s){var n=e.value;e.value=s,i._convertAttributeValue(e),t.instance.fire("set",e.name,n,e.value)},configurable:!0})},_updateAccessors:function(e,t){var i,s,n=e.script.scripts.length,r=t.url;for(i=0;i<n;i++){var a=e.script,o=a.scripts[i];if(o.url===r){if(e=o.name,o=o.attributes,e){if(o)for(s in o)o.hasOwnProperty(s)&&this._createAccessor(o[s],t);if(i=a.data.attributes[e])for(s in i)n=i[s],s in o?o[s].value!==n.value&&t.instance.onAttributeChanged&&t.instance.onAttributeChanged(n.name,n.value,o[s].value):delete t.instance[n.name];o?a.data.attributes[e]=this._cloneAttributes(o):delete a.data.attributes[e]}break}}},_convertAttributeValue:function(e){"rgb"===e.type||"rgba"===e.type?"array"===i(e.value)&&(e.value=3===e.value.length?new h(e.value[0],e.value[1],e.value[2]):new h(e.value[0],e.value[1],e.value[2],e.value[3])):"vec2"===e.type?"array"===i(e.value)&&(e.value=new T(e.value[0],e.value[1])):"vec3"===e.type||"vector"===e.type?"array"===i(e.value)&&(e.value=new v(e.value[0],e.value[1],e.value[2])):"vec4"===e.type?"array"===i(e.value)&&(e.value=new b(e.value[0],e.value[1],e.value[2],e.value[3])):"entity"===e.type?null!==e.value&&"string"==typeof e.value&&(e.value=this.app.root.findByGuid(e.value)):"curve"!==e.type&&"colorcurve"!==e.type||(e.value=new(e.value.keys[0]instanceof Array?g:_)(e.value.keys),e.value.type=e.value.type)}});var qd=new T,Yd=new v,Kd=new v,Zd=new v,$d=new v,Qd=new v,Jd=new S,eu={x:"y",y:"x"};gn.prototype=Object.create(r.prototype),gn.prototype.constructor=gn,Object.assign(gn.prototype,{_toggleLifecycleListeners:function(e){this._element[e]("mousedown",this._onMouseDownOrTouchStart,this),this._element[e]("touchstart",this._onMouseDownOrTouchStart,this)},_toggleDragListeners:function(e){var t="on"===e,i=t?"addEventListener":"removeEventListener";this._hasDragListeners&&t||(this._handleMouseUpOrTouchEnd||(this._handleMouseUpOrTouchEnd=this._onMouseUpOrTouchEnd.bind(this)),this._app.mouse&&(this._app.mouse[e]("mousemove",this._onMove,this),window[i]("mouseup",this._handleMouseUpOrTouchEnd,!1)),Vr.touch&&(this._app.touch[e]("touchmove",this._onMove,this),window[i]("touchend",this._handleMouseUpOrTouchEnd,!1),window[i]("touchcancel",this._handleMouseUpOrTouchEnd,!1)),this._hasDragListeners=t)},_onMouseDownOrTouchStart:function(e){this._element&&!this._isDragging&&this.enabled&&(this._dragCamera=e.camera,this._calculateDragScale(),e=this._screenToLocal(e))&&(this._toggleDragListeners("on"),this._isDragging=!0,this._dragStartMousePosition.copy(e),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"))},_onMouseUpOrTouchEnd:function(){this._isDragging&&(this._isDragging=!1,this._toggleDragListeners("off"),this.fire("drag:end"))},_screenToLocal:function(e){return this._determineInputPosition(e),this._chooseRayOriginAndDirection(),$d.copy(this._element.entity.getPosition()),Qd.copy(this._element.entity.forward).scale(-1),e=Qd.dot(Zd),0<Math.abs(e)?(e=$d.sub(Kd).dot(Qd)/e,e=Kd.add(Zd.scale(e)),Jd.copy(this._element.entity.getRotation()).invert().transformVector(e,e),e.mul(this._dragScale),e):null},_determineInputPosition:function(e){var t=this._app.graphicsDevice.maxPixelRatio;void 0!==e.x&&void 0!==e.y?(qd.x=e.x*t,qd.y=e.y*t):e.changedTouches?(qd.x=e.changedTouches[0].x*t,qd.y=e.changedTouches[0].y*t):console.warn("Could not determine position from input event")},_chooseRayOriginAndDirection:function(){this._element.screen&&this._element.screen.screen.screenSpace?(Kd.set(qd.x,-qd.y,0),Zd.set(0,0,-1)):(Yd.copy(this._dragCamera.screenToWorld(qd.x,qd.y,1)),Kd.copy(this._dragCamera.entity.getPosition()),Zd.copy(Yd).sub(Kd).normalize())},_calculateDragScale:function(){var e=this._element.entity.parent,t=this._element.screen&&this._element.screen.screen,i=t&&t.screenSpace;t=i?t.scale:1;var s=this._dragScale;for(s.set(t,t,t);e&&(s.mul(e.getLocalScale()),e=e.parent,!i||!e.screen););s.x=1/s.x,s.y=1/s.y,s.z=1/s.z},_onMove:function(e){if(this._element&&this._isDragging&&this.enabled&&this._element.enabled&&this._element.entity.enabled&&(e=this._screenToLocal(e),this._dragStartMousePosition&&e)){if(this._deltaMousePosition.copy(e).sub(this._dragStartMousePosition),this._deltaHandlePosition.copy(this._dragStartHandlePosition).add(this._deltaMousePosition),this._axis){e=this._element.entity.getLocalPosition();var t=eu[this._axis];this._deltaHandlePosition[t]=e[t]}this._element.entity.setLocalPosition(this._deltaHandlePosition),this.fire("drag:move",this._deltaHandlePosition)}},destroy:function(){this._toggleLifecycleListeners("off"),this._toggleDragListeners("off")}}),Object.defineProperty(gn.prototype,"enabled",{get:function(){return this._enabled},set:function(e){this._enabled=e}}),Object.defineProperty(gn.prototype,"isDragging",{get:function(){return this._isDragging}});var tu=new T;yn.prototype=Object.create(Ui.prototype),yn.prototype.constructor=yn,Object.assign(yn.prototype,{_toggleLifecycleListeners:function(e,t){this[e]("set_horizontal",this._onSetHorizontalScrollingEnabled,this),this[e]("set_vertical",this._onSetVerticalScrollingEnabled,this),t.app.systems.element[e]("add",this._onElementComponentAdd,this),t.app.systems.element[e]("beforeremove",this._onElementComponentRemove,this)},_toggleElementListeners:function(e){!this.entity.element||"on"===e&&this._hasElementListeners||(this.entity.element[e]("resize",this._onSetContentOrViewportSize,this),this._hasElementListeners="on"===e)},_onElementComponentAdd:function(e){this.entity===e&&this._toggleElementListeners("on")},_onElementComponentRemove:function(e){this.entity===e&&this._toggleElementListeners("off")},_onViewportElementGain:function(){this._syncAll()},_onContentElementGain:function(){this._destroyDragHelper(),this._contentDragHelper=new gn(this._contentReference.entity.element),this._contentDragHelper.on("drag:start",this._onContentDragStart,this),this._contentDragHelper.on("drag:end",this._onContentDragEnd,this),this._contentDragHelper.on("drag:move",this._onContentDragMove,this),this._prevContentSizes[0]=null,this._prevContentSizes[1]=null,this._syncAll()},_onContentElementLose:function(){this._destroyDragHelper()},_onContentDragStart:function(){this._contentReference.entity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentReference.entity.getLocalPosition())},_onContentDragEnd:function(){this._prevContentDragPosition=null,this._enableContentInput()},_onContentDragMove:function(e){if(this._contentReference.entity&&this.enabled&&this.entity.enabled&&(this._wasDragged=!0,this._setScrollFromContentPosition(e),this._setVelocityFromContentPositionDelta(e),!this._disabledContentInput)){var t=e.y-this._dragStartPosition.y;(Math.abs(e.x-this._dragStartPosition.x)>this.dragThreshold||Math.abs(t)>this.dragThreshold)&&this._disableContentInput()}},_onSetContentOrViewportSize:function(){this._syncAll()},_onSetHorizontalScrollbarValue:function(e){!this._scrollbarUpdateFlags[0]&&this.enabled&&this.entity.enabled&&this._onSetScroll(e,null)},_onSetVerticalScrollbarValue:function(e){!this._scrollbarUpdateFlags[1]&&this.enabled&&this.entity.enabled&&this._onSetScroll(null,e)},_onSetHorizontalScrollingEnabled:function(){this._syncScrollbarEnabledState(0)},_onSetVerticalScrollingEnabled:function(){this._syncScrollbarEnabledState(1)},_onHorizontalScrollbarGain:function(){this._syncScrollbarEnabledState(0),this._syncScrollbarPosition(0)},_onVerticalScrollbarGain:function(){this._syncScrollbarEnabledState(1),this._syncScrollbarPosition(1)},_onSetScroll:function(e,t,i){!1!==i&&this._velocity.set(0,0,0),e=0|this._updateAxis(e,"x",0),(e|=this._updateAxis(t,"y",1))&&this.fire("set:scroll",this._scroll)},_updateAxis:function(e,t,i){var s=null!==e&&1e-5<Math.abs(e-this._scroll[t]);return(s||this._isDragging()||0===e)&&(this._scroll[t]=this._determineNewScrollValue(e,t,i),this._syncContentPosition(i),this._syncScrollbarPosition(i)),s},_determineNewScrollValue:function(e,t,i){if(!this._getScrollingEnabled(i))return this._scroll[t];switch(this.scrollMode){case 0:return Hr.clamp(e,0,this._getMaxScrollValue(i));case 1:return this._setVelocityFromOvershoot(e,t,i),e;case 2:return e;default:return console.warn("Unhandled scroll mode:"+this.scrollMode),e}},_syncAll:function(){this._syncContentPosition(0),this._syncContentPosition(1),this._syncScrollbarPosition(0),this._syncScrollbarPosition(1),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1)},_syncContentPosition:function(e){var t=this._getAxis(e),i=this._getSign(e),s=this._contentReference.entity;if(s){var n=this._prevContentSizes[e],r=this._getContentSize(e);if(null!==n&&1e-4<Math.abs(n-r)){n=this._getMaxOffset(e,n);var a=this._getMaxOffset(e,r);this._scroll[t]=0===a?1:Hr.clamp(this._scroll[t]*n/a,0,1)}n=this._scroll[t]*this._getMaxOffset(e),(a=s.getLocalPosition())[t]=n*i,s.setLocalPosition(a),this._prevContentSizes[e]=r}},_syncScrollbarPosition:function(e){var t=this._getAxis(e),i=this._scrollbarReferences[e].entity;i&&i.scrollbar&&(this._scrollbarUpdateFlags[e]=!0,i.scrollbar.value=this._scroll[t],i.scrollbar.handleSize=this._getScrollbarHandleSize(t,e),this._scrollbarUpdateFlags[e]=!1)},_syncScrollbarEnabledState:function(e){var t=this._scrollbarReferences[e].entity;if(t){var i=this._getScrollingEnabled(e),s=this._getScrollbarVisibility(e);switch(s){case 0:t.enabled=i;break;case 1:t.enabled=i&&this._contentIsLargerThanViewport(e);break;default:console.warn("Unhandled scrollbar visibility:"+s),t.enabled=i}}},_contentIsLargerThanViewport:function(e){return this._getContentSize(e)>this._getViewportSize(e)},_contentPositionToScrollValue:function(e){var t=this._getMaxOffset(0),i=this._getMaxOffset(1);return tu.x=0===t?0:e.x/t,tu.y=0===i?0:e.y/-i,tu},_getMaxOffset:function(e,t){t=void 0===t?this._getContentSize(e):t;var i=this._getViewportSize(e);return t<i?-this._getViewportSize(e):i-t},_getMaxScrollValue:function(e){return this._contentIsLargerThanViewport(e)?1:0},_getScrollbarHandleSize:function(e,t){var i=this._getViewportSize(t),s=this._getContentSize(t);return.001>Math.abs(s)?1:(i=Math.min(i/s,1),0===(e=this._toOvershoot(this._scroll[e],t))?i:i/(1+Math.abs(e)))},_getViewportSize:function(e){return this._getSize(e,this._viewportReference)},_getContentSize:function(e){return this._getSize(e,this._contentReference)},_getSize:function(e,t){return t.entity&&t.entity.element?t.entity.element[this._getCalculatedDimension(e)]:0},_getScrollingEnabled:function(e){return 0===e?this.horizontal:1===e?this.vertical:void console.warn("Unrecognized orientation: "+e)},_getScrollbarVisibility:function(e){return 0===e?this.horizontalScrollbarVisibility:1===e?this.verticalScrollbarVisibility:void console.warn("Unrecognized orientation: "+e)},_getSign:function(e){return 0===e?1:-1},_getAxis:function(e){return 0===e?"x":"y"},_getCalculatedDimension:function(e){return 0===e?"calculatedWidth":"calculatedHeight"},_destroyDragHelper:function(){this._contentDragHelper&&this._contentDragHelper.destroy()},onUpdate:function(){this._contentReference.entity&&(this._updateVelocity(),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1))},_updateVelocity:function(){if(!this._isDragging()&&(1===this.scrollMode&&(this._hasOvershoot("x",0)&&this._setVelocityFromOvershoot(this.scroll.x,"x",0),this._hasOvershoot("y",1)&&this._setVelocityFromOvershoot(this.scroll.y,"y",1)),this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction,1e-4<Math.abs(this._velocity.x)||1e-4<Math.abs(this._velocity.y))){var e=this._contentReference.entity.getLocalPosition();e.x+=this._velocity.x,e.y+=this._velocity.y,this._contentReference.entity.setLocalPosition(e),this._setScrollFromContentPosition(e)}},_hasOvershoot:function(e,t){return.001<Math.abs(this._toOvershoot(this.scroll[e],t))},_toOvershoot:function(e,t){return t=this._getMaxScrollValue(t),0>e?e:e>t?e-t:0},_setVelocityFromOvershoot:function(e,t,i){e=this._toOvershoot(e,i)*this._getMaxOffset(i)*this._getSign(i),0<Math.abs(e)&&(this._velocity[t]=-e/(50*this.bounceAmount+1))},_setVelocityFromContentPositionDelta:function(e){this._prevContentDragPosition?(this._velocity.sub2(e,this._prevContentDragPosition),this._prevContentDragPosition.copy(e)):(this._velocity.set(0,0,0),this._prevContentDragPosition=e.clone())},_setScrollFromContentPosition:function(e){e=this._contentPositionToScrollValue(e),this._isDragging()&&(e=this._applyScrollValueTension(e)),this._onSetScroll(e.x,e.y,!1)},_applyScrollValueTension:function(e){var t=this._getMaxScrollValue(0),i=this._toOvershoot(e.x,0);return 0<i?e.x=t+1*Math.log10(1+i):0>i&&(e.x=-1*Math.log10(1-i)),t=this._getMaxScrollValue(1),0<(i=this._toOvershoot(e.y,1))?e.y=t+1*Math.log10(1+i):0>i&&(e.y=-1*Math.log10(1-i)),e},_isDragging:function(){return this._contentDragHelper&&this._contentDragHelper.isDragging},_setScrollbarComponentsEnabled:function(e){this._scrollbarReferences[0].hasComponent("scrollbar")&&(this._scrollbarReferences[0].entity.scrollbar.enabled=e),this._scrollbarReferences[1].hasComponent("scrollbar")&&(this._scrollbarReferences[1].entity.scrollbar.enabled=e)},_setContentDraggingEnabled:function(e){this._contentDragHelper&&(this._contentDragHelper.enabled=e)},_enableContentInput:function(){for(;this._disabledContentInputEntities.length;){var e=this._disabledContentInputEntities.pop();e.element&&(e.element.useInput=!0)}this._disabledContentInput=!1},_disableContentInput:function(){var e=this,t=function(i){var s;i.element&&i.element.useInput&&(e._disabledContentInputEntities.push(i),i.element.useInput=!1);var n=0;for(s=(i=i.children).length;n<s;n++)t(i[n])},i=this._contentReference.entity;if(i){var s,n=(i=i.children).length;for(s=0;s<n;s++)t(i[s])}this._disabledContentInput=!0},onEnable:function(){this._viewportReference.onParentComponentEnable(),this._contentReference.onParentComponentEnable(),this._scrollbarReferences[0].onParentComponentEnable(),this._scrollbarReferences[1].onParentComponentEnable(),this._setScrollbarComponentsEnabled(!0),this._setContentDraggingEnabled(!0),this._syncAll()},onDisable:function(){this._setScrollbarComponentsEnabled(!1),this._setContentDraggingEnabled(!1)},onRemove:function(){this._toggleLifecycleListeners("off",this.system),this._toggleElementListeners("off"),this._destroyDragHelper()}}),Object.defineProperty(yn.prototype,"scroll",{get:function(){return this._scroll},set:function(e){this._onSetScroll(e.x,e.y)}});var iu=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",type:"number"},{name:"viewportEntity",type:"entity"},{name:"contentEntity",type:"entity"},{name:"horizontalScrollbarEntity",type:"entity"},{name:"verticalScrollbarEntity",type:"entity"}],su=function(e){zi.call(this,e),this.id="scrollview",this.ComponentType=yn,this.DataType=vn,this.schema=iu,this.on("beforeremove",this._onRemoveComponent,this),zi.bind("update",this.onUpdate,this)};su.prototype=Object.create(zi.prototype),su.prototype.constructor=su,Ui._buildAccessors(yn.prototype,iu),Object.assign(su.prototype,{initializeComponentData:function(e,t,i){void 0===t.dragThreshold&&(t.dragThreshold=10),zi.prototype.initializeComponentData.call(this,e,t,iu)},onUpdate:function(e){for(var t in e=this.store){var i=e[t].entity,s=i.scrollview;s.enabled&&i.enabled&&s.onUpdate()}},_onRemoveComponent:function(e,t){t.onRemove()}}),bn.prototype=Object.create(Ui.prototype),bn.prototype.constructor=bn,Object.assign(bn.prototype,{_toggleLifecycleListeners:function(e){this[e]("set_value",this._onSetValue,this),this[e]("set_handleSize",this._onSetHandleSize,this),this[e]("set_orientation",this._onSetOrientation,this)},_onHandleElementGain:function(){this._destroyDragHelper(),this._handleDragHelper=new gn(this._handleReference.entity.element,this._getAxis()),this._handleDragHelper.on("drag:move",this._onHandleDrag,this),this._updateHandlePositionAndSize()},_onHandleElementLose:function(){this._destroyDragHelper()},_onHandleDrag:function(e){this._handleReference.entity&&this.enabled&&this.entity.enabled&&(this.value=this._handlePositionToScrollValue(e[this._getAxis()]))},_onSetValue:function(e,t,i){1e-5<Math.abs(i-t)&&(this.data.value=Hr.clamp(i,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value))},_onSetHandleSize:function(e,t,i){1e-5<Math.abs(i-t)&&(this.data.handleSize=Hr.clamp(i,0,1),this._updateHandlePositionAndSize())},_onSetHandleAlignment:function(){this._updateHandlePositionAndSize()},_onSetOrientation:function(e,t,i){i!==t&&this._handleReference.hasComponent("element")&&(this._handleReference.entity.element[this._getOppositeDimension()]=0)},_updateHandlePositionAndSize:function(){var e=this._handleReference.entity,t=e&&e.element;e&&((e=e.getLocalPosition())[this._getAxis()]=this._getHandlePosition(),this._handleReference.entity.setLocalPosition(e)),t&&(t[this._getDimension()]=this._getHandleLength())},_handlePositionToScrollValue:function(e){return e*this._getSign()/this._getUsableTrackLength()},_scrollValueToHandlePosition:function(e){return e*this._getSign()*this._getUsableTrackLength()},_getUsableTrackLength:function(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)},_getTrackLength:function(){return this.entity.element?0===this.orientation?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:0},_getHandleLength:function(){return this._getTrackLength()*this.handleSize},_getHandlePosition:function(){return this._scrollValueToHandlePosition(this.value)},_getSign:function(){return 0===this.orientation?1:-1},_getAxis:function(){return 0===this.orientation?"x":"y"},_getDimension:function(){return 0===this.orientation?"width":"height"},_getOppositeDimension:function(){return 0===this.orientation?"height":"width"},_destroyDragHelper:function(){this._handleDragHelper&&this._handleDragHelper.destroy()},_setHandleDraggingEnabled:function(e){this._handleDragHelper&&(this._handleDragHelper.enabled=e)},onEnable:function(){this._handleReference.onParentComponentEnable(),this._setHandleDraggingEnabled(!0)},onDisable:function(){this._setHandleDraggingEnabled(!1)},onRemove:function(){this._destroyDragHelper(),this._toggleLifecycleListeners("off")}});var nu=[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"},{name:"handleEntity",type:"entity"}];if(Sn.prototype=Object.create(zi.prototype),Sn.prototype.constructor=Sn,Ui._buildAccessors(bn.prototype,nu),Object.assign(Sn.prototype,{initializeComponentData:function(e,t,i){zi.prototype.initializeComponentData.call(this,e,t,nu)},_onRemoveComponent:function(e,t){t.onRemove()}}),nt()?(e.SoundInstance=function(e,t,i){r.call(this),i=i||{},this._volume=void 0!==i.volume?Hr.clamp(Number(i.volume)||0,0,1):1,this._pitch=void 0!==i.pitch?Math.max(.01,Number(i.pitch)||0):1,this._loop=!(void 0===i.loop||!i.loop),this._sound=t,this._state=2,this._suspendInstanceEvents=this._suspendEndEvent=this._suspended=!1,this._startTime=Math.max(0,Number(i.startTime)||0),this._duration=Math.max(0,Number(i.duration)||0),this._startedAt=0,this._startOffset=null,this._currentOffset=this._currentTime=0,this._playWhenLoaded=!0,this._manager=e,this._lastNode=this._firstNode=this._connectorNode=this._inputNode=null,this._initializeNodes(),this._onPlayCallback=i.onPlay,this._onPauseCallback=i.onPause,this._onResumeCallback=i.onResume,this._onStopCallback=i.onStop,this._onEndCallback=i.onEnd,this._endedHandler=this._onEnded.bind(this),this.source=null},e.SoundInstance.prototype=Object.create(r.prototype),e.SoundInstance.prototype.constructor=e.SoundInstance,Object.assign(e.SoundInstance.prototype,{_initializeNodes:function(){this._connectorNode=this._inputNode=this.gain=this._manager.context.createGain(),this._connectorNode.connect(this._manager.context.destination)},play:function(){2!==this._state&&this.stop(),this.source||this._createSource();var e=this._startOffset%this.duration||0;return e=(this._startTime+e)%this._sound.duration||0,this._startOffset=null,this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentTime=0,this._currentOffset=e,this._state=0,this._playWhenLoaded=!1,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0},pause:function(){return!(0!==this._state||!this.source)&&(this._updateCurrentTime(),this._state=1,this._suspendEndEvent=!0,this.source.stop(0),this.source=null,this._playWhenLoaded=!1,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function(){if(1!==this._state)return!1;this.source||this._createSource();var e=this.currentTime;return null!==this._startOffset&&(e=this._startOffset%this.duration||0,e=(this._startTime+e)%this._sound.duration||0,this._startOffset=null),this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._state=0,this._startedAt=this._manager.context.currentTime,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._playWhenLoaded=!1,this._suspendInstanceEvents||this._onResume(),!0},stop:function(){return!(2===this._state||!this.source)&&(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._currentOffset=this._currentTime=this._startedAt=0,this._startOffset=null,this._playWhenLoaded=!1,this._suspendEndEvent=!0,0===this._state&&this.source.stop(0),this.source=null,this._state=2,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function(e,t){if(e){t||(t=e);var i=this._manager.context.destination;this._firstNode!==e&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(i),this._firstNode=e,this._connectorNode.connect(e)),this._lastNode!==t&&(this._lastNode&&this._lastNode.disconnect(i),this._lastNode=t,this._lastNode.connect(i))}else console.error("The firstNode must be a valid Audio Node")},clearExternalNodes:function(){var e=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null),this._lastNode&&(this._lastNode.disconnect(e),this._lastNode=null),this._connectorNode.connect(e)},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_createSource:function(){if(!this._sound)return null;var e=this._manager.context;return this._sound.buffer&&(this.source=e.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=this._startTime%this.source.buffer.duration||0,this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,(this._startTime+this._duration)%this.source.buffer.duration||0))),this.source},_updateCurrentTime:function(){this._currentTime=((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset)%this.duration||0},_onManagerDestroy:function(){this.source&&0===this._state&&(this.source.stop(0),this.source=null)}}),Object.defineProperty(e.SoundInstance.prototype,"volume",{get:function(){return this._volume},set:function(e){this._volume=e=Hr.clamp(e,0,1),this.gain&&(this.gain.gain.value=e*this._manager.volume)}}),Object.defineProperty(e.SoundInstance.prototype,"pitch",{get:function(){return this._pitch},set:function(e){this._currentOffset=this.currentTime,this._startedAt=this._manager.context.currentTime,this._pitch=Math.max(Number(e)||0,.01),this.source&&(this.source.playbackRate.value=this._pitch)}}),Object.defineProperty(e.SoundInstance.prototype,"loop",{get:function(){return this._loop},set:function(e){this._loop=!!e,this.source&&(this.source.loop=this._loop)}}),Object.defineProperty(e.SoundInstance.prototype,"sound",{get:function(){return this._sound},set:function(e){this._sound=e,2!==this._state?this.stop():this._createSource()}}),Object.defineProperty(e.SoundInstance.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:1===this._state?this._currentTime:2!==this._state&&this.source?(this._updateCurrentTime(),this._currentTime):0},set:function(e){if(!(0>e))if(0===this._state){this.stop();var t=this._suspendInstanceEvents;this._suspendInstanceEvents=!0,this._startOffset=e,this.play(),this._suspendInstanceEvents=t}else this._currentTime=this._startOffset=e}})):st()?(e.SoundInstance=function(e,t,i){r.call(this),i=i||{},this._volume=void 0!==i.volume?Hr.clamp(Number(i.volume)||0,0,1):1,this._pitch=void 0!==i.pitch?Math.max(.01,Number(i.pitch)||0):1,this._loop=!(void 0===i.loop||!i.loop),this._sound=t,this._state=2,this._suspendInstanceEvents=this._suspendEndEvent=this._suspended=!1,this._playWhenLoaded=!0,this._startTime=Math.max(0,Number(i.startTime)||0),this._duration=Math.max(0,Number(i.duration)||0),this._startOffset=null,this._isReady=!1,this._manager=e,this._loadedMetadataHandler=this._onLoadedMetadata.bind(this),this._timeUpdateHandler=this._onTimeUpdate.bind(this),this._endedHandler=this._onEnded.bind(this),this._onPlayCallback=i.onPlay,this._onPauseCallback=i.onPause,this._onResumeCallback=i.onResume,this._onStopCallback=i.onStop,this._onEndCallback=i.onEnd,this.source=null,this._createSource()},e.SoundInstance.prototype=Object.create(r.prototype),e.SoundInstance.prototype.constructor=e.SoundInstance,Object.assign(e.SoundInstance.prototype,{play:function(){return 2!==this._state&&this.stop(),!(!this.source&&!this._createSource())&&(this.volume=this._volume,this.pitch=this._pitch,this.loop=this._loop,this.source.play(),this._state=0,this._playWhenLoaded=!1,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0)},pause:function(){return!(!this.source||0!==this._state)&&(this._suspendEndEvent=!0,this.source.pause(),this._playWhenLoaded=!1,this._state=1,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function(){return!(!this.source||1!==this._state)&&(this._state=0,this._playWhenLoaded=!1,this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume()),!0)},stop:function(){return!(!this.source||2===this._state)&&(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._suspendEndEvent=!0,this.source.pause(),this._playWhenLoaded=!1,this._state=2,this._startOffset=null,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler),this._isReady=!0;var e=this._startOffset%this.duration||0;e=(this._startTime+e)%this._sound.duration||0,this._startOffset=null,this.source.currentTime=e},_createSource:function(){return this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler),this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>((this._startTime+this._duration)%this.source.duration||0)&&(this.loop?this.source.currentTime=this._startTime%this.source.duration||0:(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function(){this.source&&this.source.pause()}}),Object.defineProperty(e.SoundInstance.prototype,"volume",{get:function(){return this._volume},set:function(e){this._volume=e=Hr.clamp(e,0,1),this.source&&(this.source.volume=e*this._manager.volume)}}),Object.defineProperty(e.SoundInstance.prototype,"pitch",{get:function(){return this._pitch},set:function(e){this._pitch=Math.max(Number(e)||0,.01),this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(e.SoundInstance.prototype,"loop",{get:function(){return this._loop},set:function(e){this._loop=!!e,this.source&&(this.source.loop=this._loop)}}),Object.defineProperty(e.SoundInstance.prototype,"sound",{get:function(){return this._sound},set:function(e){this.stop(),this._sound=e}}),Object.defineProperty(e.SoundInstance.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:2!==this._state&&this.source?this.source.currentTime-this._startTime:0},set:function(e){0>e||(this._startOffset=e,this.source&&this._isReady&&(this.source.currentTime=(this._startTime+(e%this.duration||0))%this._sound.duration||0,this._startOffset=null))}})):e.SoundInstance=function(){},Object.assign(e.SoundInstance.prototype,{_onPlay:function(){this.fire("play"),this._onPlayCallback&&this._onPlayCallback(this)},_onPause:function(){this.fire("pause"),this._onPauseCallback&&this._onPauseCallback(this)},_onResume:function(){this.fire("resume"),this._onResumeCallback&&this._onResumeCallback(this)},_onStop:function(){this.fire("stop"),this._onStopCallback&&this._onStopCallback(this)},_onEnded:function(){this._suspendEndEvent?this._suspendEndEvent=!1:(this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop())},_onManagerVolumeChange:function(){this.volume=this._volume},_onManagerSuspend:function(){0!==this._state||this._suspended||(this._suspended=!0,this.pause())},_onManagerResume:function(){this._suspended&&(this._suspended=!1,this.resume())}}),Object.defineProperty(e.SoundInstance.prototype,"startTime",{get:function(){return this._startTime},set:function(e){this._startTime=Math.max(0,Number(e)||0),e=0===this._state,this.stop(),e&&this.play()}}),Object.defineProperty(e.SoundInstance.prototype,"duration",{get:function(){return this._sound?this._duration?this._duration%this._sound.duration||0:this._sound.duration:0},set:function(e){this._duration=Math.max(0,Number(e)||0),e=0===this._state,this.stop(),e&&this.play()}}),Object.defineProperty(e.SoundInstance.prototype,"isPlaying",{get:function(){return 0===this._state}}),Object.defineProperty(e.SoundInstance.prototype,"isPaused",{get:function(){return 1===this._state}}),Object.defineProperty(e.SoundInstance.prototype,"isStopped",{get:function(){return 2===this._state}}),Object.defineProperty(e.SoundInstance.prototype,"isSuspended",{get:function(){return this._suspended}}),nt())e.SoundInstance3d=function(t,i,s){e.SoundInstance.call(this,t,i,s),s=s||{},this._position=new v,s.position&&(this.position=s.position),this._velocity=new v,s.velocity&&(this.velocity=s.velocity),this.maxDistance=void 0!==s.maxDistance?Number(s.maxDistance):1e4,this.refDistance=void 0!==s.refDistance?Number(s.refDistance):1,this.rollOffFactor=void 0!==s.rollOffFactor?Number(s.rollOffFactor):1,this.distanceModel=void 0!==s.distanceModel?s.distanceModel:"linear"},e.SoundInstance3d.prototype=Object.create(e.SoundInstance.prototype),e.SoundInstance3d.prototype.constructor=e.SoundInstance3d,Object.assign(e.SoundInstance3d.prototype,{_initializeNodes:function(){this.gain=this._manager.context.createGain(),this.panner=this._manager.context.createPanner(),this.panner.connect(this.gain),this._inputNode=this.panner,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}}),Object.defineProperty(e.SoundInstance3d.prototype,"position",{get:function(){return this._position},set:function(e){this._position.copy(e),this.panner.setPosition(e.x,e.y,e.z)}}),Object.defineProperty(e.SoundInstance3d.prototype,"velocity",{get:function(){return this._velocity},set:function(e){this._velocity.copy(e),this.panner.setVelocity(e.x,e.y,e.z)}}),Object.defineProperty(e.SoundInstance3d.prototype,"maxDistance",{get:function(){return this.panner.maxDistance},set:function(e){this.panner.maxDistance=e}}),Object.defineProperty(e.SoundInstance3d.prototype,"refDistance",{get:function(){return this.panner.refDistance},set:function(e){this.panner.refDistance=e}}),Object.defineProperty(e.SoundInstance3d.prototype,"rollOffFactor",{get:function(){return this.panner.rolloffFactor},set:function(e){this.panner.rolloffFactor=e}}),Object.defineProperty(e.SoundInstance3d.prototype,"distanceModel",{get:function(){return this.panner.distanceModel},set:function(e){this.panner.distanceModel=e}});else if(st()){var ru=new v;e.SoundInstance3d=function(t,i,s){e.SoundInstance.call(this,t,i,s),s=s||{},this._position=new v,s.position&&(this.position=s.position),this._velocity=new v,s.velocity&&(this.velocity=s.velocity),this._maxDistance=void 0!==s.maxDistance?Number(s.maxDistance):1e4,this._refDistance=void 0!==s.refDistance?Number(s.refDistance):1,this._rollOffFactor=void 0!==s.rollOffFactor?Number(s.rollOffFactor):1,this._distanceModel=void 0!==s.distanceModel?s.distanceModel:"linear"},e.SoundInstance3d.prototype=Object.create(e.SoundInstance.prototype),e.SoundInstance3d.prototype.constructor=e.SoundInstance3d,Object.defineProperty(e.SoundInstance3d.prototype,"position",{get:function(){return this._position},set:function(e){if(this._position.copy(e),this.source){var t=this._manager.listener.getPosition();e=this.refDistance;var i=this.maxDistance,s=this.rollOffFactor,n=this.distanceModel;if((t=(ru=ru.sub2(t,this._position)).length())<e)e=1;else if(t>i)e=0;else{var r=0;"linear"===n?r=1-s*(t-e)/(i-e):n===kh?r=e/(e+s*(t-e)):"exponential"===n&&(r=Math.pow(t/e,-s)),e=Hr.clamp(r,0,1)}this.source.volume=this.volume*e*this._manager.volume}}}),Object.defineProperty(e.SoundInstance3d.prototype,"velocity",{get:function(){return this._velocity},set:function(e){this._velocity.copy(e)}}),Object.defineProperty(e.SoundInstance3d.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(e){this._maxDistance=e}}),Object.defineProperty(e.SoundInstance3d.prototype,"refDistance",{get:function(){return this._refDistance},set:function(e){this._refDistance=e}}),Object.defineProperty(e.SoundInstance3d.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(e){this._rollOffFactor=e}}),Object.defineProperty(e.SoundInstance3d.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(e){this._distanceModel=e}})}else e.SoundInstance3d=function(){};var au={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new v,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null};Tn.prototype=Object.create(r.prototype),Tn.prototype.constructor=Tn,Object.assign(Tn.prototype,{play:function(){if(this.overlap||this.stop(),this.isLoaded||this._hasAsset()){var e=this._createInstance();if(this.instances.push(e),this.isLoaded)e.play();else{var t=function(t){var i=e._playWhenLoaded;e.sound=t,i&&e.play()};this.off("load",t),this.once("load",t),this.load()}return e}},pause:function(){for(var e=!1,t=this.instances,i=0,s=t.length;i<s;i++)t[i].pause()&&(e=!0);return e},resume:function(){for(var e=!1,t=this.instances,i=0,s=t.length;i<s;i++)t[i].resume()&&(e=!0);return e},stop:function(){for(var e=!1,t=this.instances,i=t.length;i--;)t[i].stop(),e=!0;return t.length=0,e},load:function(){if(this._hasAsset()){var e=this._assets.get(this._asset);e?(e.off("remove",this._onAssetRemoved,this),e.on("remove",this._onAssetRemoved,this),e.resource?this.fire("load",e.resource):(e.off("load",this._onAssetLoad,this),e.once("load",this._onAssetLoad,this),this._assets.load(e))):(this._assets.off("add:"+this._asset,this._onAssetAdd,this),this._assets.once("add:"+this._asset,this._onAssetAdd,this))}},setExternalNodes:function(e,t){if(e){if(t||(t=e),this._firstNode=e,this._lastNode=t,!this._overlap)for(var i=this.instances,s=0,n=i.length;s<n;s++)i[s].setExternalNodes(e,t)}else console.error("The firstNode must have a valid AudioNode")},clearExternalNodes:function(){if(this._lastNode=this._firstNode=null,!this._overlap)for(var e=this.instances,t=0,i=e.length;t<i;t++)e[t].clearExternalNodes()},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_hasAsset:function(){return null!=this._asset},_createInstance:function(){var t=this._component,i=null;if(this._hasAsset()){var s=this._assets.get(this._asset);s&&(i=s.resource)}return au.volume=this._volume*t.volume,au.pitch=this._pitch*t.pitch,au.loop=this._loop,au.startTime=this._startTime,au.duration=this._duration,au.onPlay=this._onInstancePlayHandler,au.onPause=this._onInstancePauseHandler,au.onResume=this._onInstanceResumeHandler,au.onStop=this._onInstanceStopHandler,au.onEnd=this._onInstanceEndHandler,t.positional?(au.position.copy(t.entity.getPosition()),au.maxDistance=t.maxDistance,au.refDistance=t.refDistance,au.rollOffFactor=t.rollOffFactor,au.distanceModel=t.distanceModel,t=new e.SoundInstance3d(this._manager,i,au)):t=new e.SoundInstance(this._manager,i,au),this._firstNode&&t.setExternalNodes(this._firstNode,this._lastNode),t},_onInstancePlay:function(e){this.fire("play",e),this._component.fire("play",this,e)},_onInstancePause:function(e){this.fire("pause",e),this._component.fire("pause",this,e)},_onInstanceResume:function(e){this.fire("resume",e),this._component.fire("resume",this,e)},_onInstanceStop:function(e){var t=this.instances.indexOf(e);-1!==t&&this.instances.splice(t,1),this.fire("stop",e),this._component.fire("stop",this,e)},_onInstanceEnd:function(e){var t=this.instances.indexOf(e);-1!==t&&this.instances.splice(t,1),this.fire("end",e),this._component.fire("end",this,e)},_onAssetAdd:function(e){this.load()},_onAssetLoad:function(e){this.load()},_onAssetRemoved:function(e){e.off("remove",this._onAssetRemoved,this),this._assets.off("add:"+e.id,this._onAssetAdd,this),this.stop()},updatePosition:function(e){for(var t=this.instances,i=0,s=t.length;i<s;i++)t[i].position=e}}),Object.defineProperty(Tn.prototype,"name",{get:function(){return this._name},set:function(e){this._name=e}}),Object.defineProperty(Tn.prototype,"volume",{get:function(){return this._volume},set:function(e){if(this._volume=Hr.clamp(Number(e)||0,0,1),!this._overlap)for(var t=0,i=(e=this.instances).length;t<i;t++)e[t].volume=this._volume*this._component.volume}}),Object.defineProperty(Tn.prototype,"pitch",{get:function(){return this._pitch},set:function(e){if(this._pitch=Math.max(Number(e)||0,.01),!this._overlap)for(var t=0,i=(e=this.instances).length;t<i;t++)e[t].pitch=this.pitch*this._component.pitch}}),Object.defineProperty(Tn.prototype,"loop",{get:function(){return this._loop},set:function(e){this._loop=!!e;for(var t=0,i=(e=this.instances).length;t<i;t++)e[t].loop=this._loop}}),Object.defineProperty(Tn.prototype,"autoPlay",{get:function(){return this._autoPlay},set:function(e){this._autoPlay=!!e}}),Object.defineProperty(Tn.prototype,"overlap",{get:function(){return this._overlap},set:function(e){this._overlap=!!e}}),Object.defineProperty(Tn.prototype,"startTime",{get:function(){return this._startTime},set:function(e){if(this._startTime=Math.max(0,Number(e)||0),!this._overlap)for(var t=0,i=(e=this.instances).length;t<i;t++)e[t].startTime=this._startTime}}),Object.defineProperty(Tn.prototype,"duration",{get:function(){var e=0;return this._hasAsset()&&(e=(e=this._assets.get(this._asset)).resource?e.resource.duration:0),null!=this._duration?this._duration%(e||1):e},set:function(e){if(this._duration=Math.max(0,Number(e)||0)||null,!this._overlap)for(var t=0,i=(e=this.instances).length;t<i;t++)e[t].duration=this._duration}}),Object.defineProperty(Tn.prototype,"asset",{get:function(){return this._asset},set:function(e){var t=this._asset;t&&(this._assets.off("add:"+t,this._onAssetAdd,this),(t=this._assets.get(t))&&t.off("remove",this._onAssetRemoved,this)),this._asset=e,this._asset instanceof Pt&&(this._asset=this._asset.id),this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}}),Object.defineProperty(Tn.prototype,"isLoaded",{get:function(){if(this._hasAsset()){var e=this._assets.get(this._asset);if(e)return!!e.resource}return!1}}),Object.defineProperty(Tn.prototype,"isPlaying",{get:function(){for(var e=this.instances,t=0,i=e.length;t<i;t++)if(e[t].isPlaying)return!0;return!1}}),Object.defineProperty(Tn.prototype,"isPaused",{get:function(){var e=this.instances,t=e.length;if(0===t)return!1;for(var i=0;i<t;i++)if(!e[i].isPaused)return!1;return!0}}),Object.defineProperty(Tn.prototype,"isStopped",{get:function(){for(var e=this.instances,t=0,i=e.length;t<i;t++)if(!e[t].isStopped)return!1;return!0}}),wn.prototype=Object.create(Ui.prototype),wn.prototype.constructor=wn,Object.assign(wn.prototype,{onSetSlots:function(e,t,i){var s;if(t)for(s in t)t[s].stop();for(s in e={},i)i[s]instanceof Tn?e[i[s].name]=i[s]:i[s].name&&(e[i[s].name]=new Tn(this,i[s].name,i[s]));this.data.slots=e,this.enabled&&this.entity.enabled&&this.onEnable()},onSetVolume:function(e,t,i){for(var s in e=this.data.slots)if(!(t=e[s]).overlap)for(var n=t.instances,r=0,a=n.length;r<a;r++)n[r].volume=t.volume*i},onSetPitch:function(e,t,i){for(var s in e=this.data.slots)if(!(t=e[s]).overlap)for(var n=t.instances,r=0,a=n.length;r<a;r++)n[r].pitch=t.pitch*i},onSetRefDistance:function(e,t,i){for(var s in e=this.data.slots)if(!(t=e[s]).overlap)for(var n=0,r=(t=t.instances).length;n<r;n++)t[n].refDistance=i},onSetMaxDistance:function(e,t,i){for(var s in e=this.data.slots)if(!(t=e[s]).overlap)for(var n=0,r=(t=t.instances).length;n<r;n++)t[n].maxDistance=i},onSetRollOffFactor:function(e,t,i){for(var s in e=this.data.slots)if(!(t=e[s]).overlap)for(var n=0,r=(t=t.instances).length;n<r;n++)t[n].rollOffFactor=i},onSetDistanceModel:function(e,t,i){for(var s in e=this.data.slots)if(!(t=e[s]).overlap)for(var n=0,r=(t=t.instances).length;n<r;n++)t[n].distanceModel=i},onSetPositional:function(e,t,i){for(var s in e=this.data.slots)if(!(t=e[s]).overlap)for(var n=0,r=(i=t.instances).length;n<r;n++){var a=i[n].isPlaying||i[n].isSuspended,o=i[n].currentTime;a&&i[n].stop(),i[n]=t._createInstance(),a&&(i[n].play(),i[n].currentTime=o)}},onEnable:function(){if(!this.system._inTools){var e,t=this.data.slots,i=this.data.playingBeforeDisable;for(e in t){var s=t[e];s.autoPlay&&s.isStopped?s.play():i[e]?s.resume():s.isLoaded||s.load()}}},onDisable:function(){var e,t=this.data.slots,i={};for(e in t)!t[e].overlap&&t[e].isPlaying&&(t[e].pause(),i[e]=!0);this.data.playingBeforeDisable=i},onRemove:function(){this.off()},addSlot:function(e,t){var i=this.data.slots;return i[e]?null:(t=new Tn(this,e,t),i[e]=t,t.autoPlay&&this.enabled&&this.entity.enabled&&t.play(),t)},removeSlot:function(e){var t=this.data.slots;t[e]&&(t[e].stop(),delete t[e])},slot:function(e){return this.data.slots[e]},play:function(e){return this.enabled&&this.entity.enabled&&(e=this.slots[e])?e.play():null},pause:function(e){var t=this.data.slots;if(e)(e=t[e])&&e.pause();else for(var i in t)t[i].pause()},resume:function(e){var t=this.data.slots;if(e)(e=t[e])&&e.isPaused&&e.resume();else for(var i in t)t[i].resume()},stop:function(e){var t=this.data.slots;if(e)(e=t[e])&&e.stop();else for(var i in t)t[i].stop()}});var ou="enabled volume pitch positional refDistance maxDistance rollOffFactor distanceModel slots".split(" "),hu=function(e,t){zi.call(this,e),this.id="sound",this.description="Allows an Entity to play sounds",this.ComponentType=wn,this.DataType=Mn,this.schema=ou,this.manager=t,zi.bind("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)};hu.prototype=Object.create(zi.prototype),hu.prototype.constructor=hu,Ui._buildAccessors(wn.prototype,ou),Object.assign(hu.prototype,{initializeComponentData:function(e,t,i){i="volume pitch positional refDistance maxDistance rollOffFactor distanceModel slots enabled".split(" "),zi.prototype.initializeComponentData.call(this,e,t,i)},cloneComponent:function(e,t){var i;e=e.sound.data;var s={};for(i in e)e.hasOwnProperty(i)&&(s[i]=e[i]);for(i in s.slots={},e.slots){var n=e.slots[i];s.slots[i]=n instanceof Tn?{name:n.name,volume:n.volume,pitch:n.pitch,loop:n.loop,duration:n.duration,startTime:n.startTime,overlap:n.overlap,autoPlay:n.autoPlay,asset:n.asset}:n}return s.playingBeforeDisable={},this.addComponent(t,s)},onUpdate:function(e){for(var t in e=this.store)if(e.hasOwnProperty(t)){var i=e[t],s=i.entity;if((i=i.data).enabled&&s.enabled&&i.positional)for(var n in s=s.getPosition(),i=i.slots)i[n].updatePosition(s)}},onBeforeRemove:function(e,t){for(var i in e=t.slots)e[i].overlap||e[i].stop();t.onRemove()}}),Object.defineProperty(hu.prototype,"volume",{get:function(){return this.manager.volume},set:function(e){this.manager.volume=e}}),Object.defineProperty(hu.prototype,"context",{get:function(){return nt()?this.manager.context:(console.warn("WARNING: Audio context is not supported on this browser"),null)}}),Pn.prototype=Object.create(r.prototype),Pn.prototype.constructor=Pn,Object.assign(Pn.prototype,{_onSpriteAssetAdded:function(e){this._component.system.app.assets.off("add:"+e.id,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e)},_bindSpriteAsset:function(e){e.on("load",this._onSpriteAssetLoad,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._component.system.app.assets.load(e)},_unbindSpriteAsset:function(e){e.off("load",this._onSpriteAssetLoad,this),e.off("remove",this._onSpriteAssetRemove,this),e.resource&&e.resource.atlas&&this._component.system.app.assets.off("load:"+e.data.textureAtlasAsset,this._onTextureAtlasLoad,this)},_onSpriteAssetLoad:function(e){if(e.resource)if(e.resource.atlas)this.sprite=e.resource;else{e=e.data.textureAtlasAsset;var t=this._component.system.app.assets;t.off("load:"+e,this._onTextureAtlasLoad,this),t.once("load:"+e,this._onTextureAtlasLoad,this)}else this.sprite=null},_onTextureAtlasLoad:function(e){(e=this._spriteAsset)instanceof Pt?this._onSpriteAssetLoad(e):this._onSpriteAssetLoad(this._component.system.app.assets.get(e))},_onSpriteAssetRemove:function(e){this.sprite=null},_onSpriteMeshesChange:function(){this._component.currentClip===this&&this._component._showFrame(this.frame)},_onSpritePpuChanged:function(){this._component.currentClip===this&&0!==this.sprite.renderMode&&this._component._showFrame(this.frame)},_update:function(e){if(0!==this.fps&&this._playing&&!this._paused&&this._sprite){var t=this._time+e*this._component.speed*(0>this.fps?-1:1),i=this.duration;e=t>i||0>t,this._setTime(t),(t=this._sprite?Math.floor(this._sprite.frameKeys.length*this._time/i):0)!==this._frame&&this._setFrame(t),e&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._paused=this._playing=!1,this.fire("end"),this._component.fire("end",this)))}},_setTime:function(e){this._time=e,e=this.duration,0>this._time?this._time=this.loop?this._time%e+e:0:this._time>e&&(this._time=this.loop?this._time%e:e)},_setFrame:function(e){this._frame=this._sprite?Hr.clamp(e,0,this._sprite.frameKeys.length-1):e,this._component.currentClip===this&&this._component._showFrame(this._frame)},_destroy:function(){this._sprite&&(this.sprite=null),this._spriteAsset&&(this.spriteAsset=null)},play:function(){this._playing||(this._playing=!0,this._paused=!1,this.frame=0,this.fire("play"),this._component.fire("play",this))},pause:function(){this._playing&&!this._paused&&(this._paused=!0,this.fire("pause"),this._component.fire("pause",this))},resume:function(){this._paused&&(this._paused=!1,this.fire("resume"),this._component.fire("resume",this))},stop:function(){this._playing&&(this._paused=this._playing=!1,this.frame=this._time=0,this.fire("stop"),this._component.fire("stop",this))}}),Object.defineProperty(Pn.prototype,"spriteAsset",{get:function(){return this._spriteAsset},set:function(e){var t=this._component.system.app.assets,i=e;e instanceof Pt&&(i=e.id),this._spriteAsset!==i&&(this._spriteAsset&&(e=t.get(this._spriteAsset))&&this._unbindSpriteAsset(e),(this._spriteAsset=i)?(i=t.get(this._spriteAsset))?this._bindSpriteAsset(i):(this.sprite=null,t.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this)):this.sprite=null)}}),Object.defineProperty(Pn.prototype,"sprite",{get:function(){return this._sprite},set:function(e){var t;(this._sprite&&(this._sprite.off("set:meshes",this._onSpriteMeshesChange,this),this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this)),(this._sprite=e)&&(this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this)),this._component.currentClip===this)&&(e&&e.atlas?(e.atlas.texture&&((t=this._component._meshInstance)&&(t.setParameter("texture_emissiveMap",e.atlas.texture),t.setParameter("texture_opacityMap",e.atlas.texture)),this._component.enabled&&this._component.entity.enabled&&this._component._showModel()),this.time&&this.fps?this.time=this.time:this.frame=this.frame):((t=this._component._meshInstance)&&(t.deleteParameter("texture_emissiveMap"),t.deleteParameter("texture_opacityMap")),this._component._hideModel()))}}),Object.defineProperty(Pn.prototype,"frame",{get:function(){return this._frame},set:function(e){this._setFrame(e),this._setTime(this._frame/(this.fps||Number.MIN_VALUE))}}),Object.defineProperty(Pn.prototype,"isPlaying",{get:function(){return this._playing}}),Object.defineProperty(Pn.prototype,"isPaused",{get:function(){return this._paused}}),Object.defineProperty(Pn.prototype,"duration",{get:function(){return this._sprite?this._sprite.frameKeys.length/Math.abs(this.fps||Number.MIN_VALUE):0}}),Object.defineProperty(Pn.prototype,"time",{get:function(){return this._time},set:function(e){this._setTime(e),this.frame=this._sprite?Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps))):0}});var lu=function(e,t){Ui.call(this,e,t),this._type="simple",this._material=e.defaultMaterial,this._color=new h(1,1,1,1),this._colorUniform=new Float32Array(3),this._speed=1,this._flipY=this._flipX=!1,this._height=this._width=1,this._drawOrder=0,this._layers=[0],this._outerScale=new T(1,1),this._outerScaleUniform=new Float32Array(2),this._innerOffset=new b,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new b,this._atlasRectUniform=new Float32Array(4),this._batchGroupId=-1,this._batchGroup=null,this._node=new ge,this._model=new oe,this._model.graph=this._node,this._meshInstance=null,t.addChild(this._model.graph),this._model._entity=t,this._updateAabbFunc=this._updateAabb.bind(this),this._addedModel=!1,this._autoPlayClip=null,this._clips={},this._currentClip=this._defaultClip=new Pn(this,{name:this.entity.name,fps:0,loop:!1,spriteAsset:null})};lu.prototype=Object.create(Ui.prototype),lu.prototype.constructor=lu,Object.assign(lu.prototype,{onEnable:function(){var e=this.system.app,t=e.scene;t.on("set:layers",this._onLayersChanged,this),t.layers&&(t.layers.on("add",this._onLayerAdded,this),t.layers.on("remove",this._onLayerRemoved,this)),this._showModel(),this._autoPlayClip&&this._tryAutoPlay(),0<=this._batchGroupId&&e.batcher.insert(le.SPRITE,this._batchGroupId,this.entity)},onDisable:function(){var e=this.system.app,t=e.scene;t.off("set:layers",this._onLayersChanged,this),t.layers&&(t.layers.off("add",this._onLayerAdded,this),t.layers.off("remove",this._onLayerRemoved,this)),this.stop(),this._hideModel(),0<=this._batchGroupId&&e.batcher.remove(le.SPRITE,this._batchGroupId,this.entity)},onDestroy:function(){for(var e in this._currentClip=null,this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null),this._clips)this._clips[e]._destroy();this._clips=null,this._hideModel(),this._model=null,this._node&&(this._node.parent&&this._node.parent.removeChild(this._node),this._node=null),this._meshInstance&&(this._meshInstance.material=null,this._meshInstance=this._meshInstance.mesh=null)},_showModel:function(){if(!this._addedModel&&this._meshInstance){var e,t=[this._meshInstance],i=0;for(e=this._layers.length;i<e;i++){var s=this.system.app.scene.layers.getLayerById(this._layers[i]);s&&s.addMeshInstances(t)}this._addedModel=!0}},_hideModel:function(){if(this._addedModel&&this._meshInstance){var e,t=[this._meshInstance],i=0;for(e=this._layers.length;i<e;i++){var s=this.system.app.scene.layers.getLayerById(this._layers[i]);s&&s.removeMeshInstances(t)}this._addedModel=!1}},_showFrame:function(e){if(this.sprite){var t=this.sprite.meshes[e];if(t){var i=1===this.sprite.renderMode?this.system.default9SlicedMaterialSlicedMode:2===this.sprite.renderMode?this.system.default9SlicedMaterialTiledMode:this.system.defaultMaterial;this._meshInstance||(this._meshInstance=new ee(this._node,t,this._material),this._meshInstance.castShadow=!1,this._meshInstance.receiveShadow=!1,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter("material_emissive",this._colorUniform),this._meshInstance.setParameter("material_opacity",this._color.a),this.enabled&&this.entity.enabled&&this._showModel()),this._meshInstance.material!==i&&(this._meshInstance.material=i),this._meshInstance.mesh!==t&&(this._meshInstance.mesh=t,this._meshInstance.visible=!0,this._meshInstance._aabbVer=-1),this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter("texture_emissiveMap",this.sprite.atlas.texture),this._meshInstance.setParameter("texture_opacityMap",this.sprite.atlas.texture)):(this._meshInstance.deleteParameter("texture_emissiveMap"),this._meshInstance.deleteParameter("texture_opacityMap")),!this.sprite.atlas||1!==this.sprite.renderMode&&2!==this.sprite.renderMode?this._meshInstance._updateAabbFunc=null:(this._meshInstance._updateAabbFunc=this._updateAabbFunc,(e=this.sprite.atlas.frames[this.sprite.frameKeys[e]])?(t=2/e.rect.z,i=2/e.rect.w,this._innerOffset.set(e.border.x*t,e.border.y*i,e.border.z*t,e.border.w*i),t=this.sprite.atlas.texture,this._atlasRect.set(e.rect.x/t.width,e.rect.y/t.height,e.rect.z/t.width,e.rect.w/t.height)):this._innerOffset.set(0,0,0,0),this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter("atlasRect",this._atlasRectUniform)),this._updateTransform()}else this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=!1)}},_updateTransform:function(){var e=this.flipX?-1:1,t=this.flipY?-1:1,i=0,s=0;if(this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)){var n=1,r=1;if(this.sprite.atlas){var a=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];a&&(n=a.rect.z,r=a.rect.w,i=(.5-a.pivot.x)*this._width,s=(.5-a.pivot.y)*this._height)}n/=this.sprite.pixelsPerUnit,r/=this.sprite.pixelsPerUnit,this._outerScale.set(Math.max(this._width,this._innerOffset.x*n),Math.max(this._height,this._innerOffset.y*r)),t*=r,this._outerScale.x/=n,this._outerScale.y/=r,e=e*n*Hr.clamp(this._width/(this._innerOffset.x*n),1e-4,1),t*=Hr.clamp(this._height/(this._innerOffset.y*r),1e-4,1),this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._meshInstance.setParameter("outerScale",this._outerScaleUniform,4294967295))}this._node.setLocalScale(e,t,1),this._node.setLocalPosition(i,s,0)},_updateAabb:function(e){return e.center.set(0,0,0),e.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),e.setFromTransformedAabb(e,this._node.getWorldTransform()),e},_tryAutoPlay:function(){if(this._autoPlayClip&&"animated"===this.type){var e=this._clips[this._autoPlayClip];!e||e.isPlaying||this._currentClip&&this._currentClip.isPlaying||this.enabled&&this.entity.enabled&&this.play(e.name)}},_onLayersChanged:function(e,t){e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this),this.enabled&&this.entity.enabled&&this._showModel()},_onLayerAdded:function(e){0>this.layers.indexOf(e.id)||this._addedModel&&this.enabled&&this.entity.enabled&&this._meshInstance&&e.addMeshInstances([this._meshInstance])},_onLayerRemoved:function(e){this._meshInstance&&(0>this.layers.indexOf(e.id)||e.removeMeshInstances([this._meshInstance]))},removeModelFromLayers:function(){for(var e,t=0;t<this.layers.length;t++)(e=this.system.app.scene.layers.getLayerById(this.layers[t]))&&e.removeMeshInstances([this._meshInstance])},addClip:function(e){var t=new Pn(this,{name:e.name,fps:e.fps,loop:e.loop,spriteAsset:e.spriteAsset});return this._clips[e.name]=t,t.name&&t.name===this._autoPlayClip&&this._tryAutoPlay(),t},removeClip:function(e){delete this._clips[e]},clip:function(e){return this._clips[e]},play:function(e){e=this._clips[e];var t=this._currentClip;return t&&t!==e&&(t._playing=!1),(this._currentClip=e)&&(this._currentClip=e,this._currentClip.play()),e},pause:function(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause()},resume:function(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&this._currentClip.resume()},stop:function(){this._currentClip!==this._defaultClip&&this._currentClip.stop()}}),Object.defineProperty(lu.prototype,"type",{get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,"simple"===this._type?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):"animated"===this._type&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?this._showModel():this._hideModel()))}}),Object.defineProperty(lu.prototype,"frame",{get:function(){return this._currentClip.frame},set:function(e){this._currentClip.frame=e}}),Object.defineProperty(lu.prototype,"spriteAsset",{get:function(){return this._defaultClip._spriteAsset},set:function(e){this._defaultClip.spriteAsset=e}}),Object.defineProperty(lu.prototype,"sprite",{get:function(){return this._currentClip.sprite},set:function(e){this._currentClip.sprite=e}}),Object.defineProperty(lu.prototype,"material",{get:function(){return this._material},set:function(e){this._material=e,this._meshInstance&&(this._meshInstance.material=e)}}),Object.defineProperty(lu.prototype,"color",{get:function(){return this._color},set:function(e){this._color.r=e.r,this._color.g=e.g,this._color.b=e.b,this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter("material_emissive",this._colorUniform))}}),Object.defineProperty(lu.prototype,"opacity",{get:function(){return this._color.a},set:function(e){this._color.a=e,this._meshInstance&&this._meshInstance.setParameter("material_opacity",e)}}),Object.defineProperty(lu.prototype,"clips",{get:function(){return this._clips},set:function(e){var t,i;if(e){for(t in this._clips){var s=!1;for(i in e)if(e[i].name===t){s=!0,this._clips[t].fps=e[i].fps,this._clips[t].loop=e[i].loop,e[i].hasOwnProperty("sprite")?this._clips[t].sprite=e[i].sprite:e[i].hasOwnProperty("spriteAsset")&&(this._clips[t].spriteAsset=e[i].spriteAsset);break}s||this.removeClip(t)}for(i in e)this._clips[e[i].name]||this.addClip(e[i]);this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.sprite||this._hideModel()}else for(t in this._clips)this.removeClip(t)}}),Object.defineProperty(lu.prototype,"currentClip",{get:function(){return this._currentClip}}),Object.defineProperty(lu.prototype,"speed",{get:function(){return this._speed},set:function(e){this._speed=e}}),Object.defineProperty(lu.prototype,"flipX",{get:function(){return this._flipX},set:function(e){this._flipX!==e&&(this._flipX=e,this._updateTransform())}}),Object.defineProperty(lu.prototype,"flipY",{get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._updateTransform())}}),Object.defineProperty(lu.prototype,"width",{get:function(){return this._width},set:function(e){e!==this._width&&(this._width=e,this._outerScale.x=this._width,!this.sprite||2!==this.sprite.renderMode&&1!==this.sprite.renderMode||this._updateTransform())}}),Object.defineProperty(lu.prototype,"height",{get:function(){return this._height},set:function(e){e!==this._height&&(this._height=e,this._outerScale.y=this.height,!this.sprite||2!==this.sprite.renderMode&&1!==this.sprite.renderMode||this._updateTransform())}}),Object.defineProperty(lu.prototype,"batchGroupId",{get:function(){return this._batchGroupId},set:function(e){if(this._batchGroupId!==e){var t=this._batchGroupId;this._batchGroupId=e,this.entity.enabled&&0<=t&&this.system.app.batcher.remove(le.SPRITE,t,this.entity),this.entity.enabled&&0<=e?this.system.app.batcher.insert(le.SPRITE,e,this.entity):0<=t&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel()}}}),Object.defineProperty(lu.prototype,"autoPlayClip",{get:function(){return this._autoPlayClip},set:function(e){this._autoPlayClip=e instanceof Pn?e.name:e,this._tryAutoPlay()}}),Object.defineProperty(lu.prototype,"drawOrder",{get:function(){return this._drawOrder},set:function(e){this._drawOrder=e,this._meshInstance&&(this._meshInstance.drawOrder=e)}}),Object.defineProperty(lu.prototype,"layers",{get:function(){return this._layers},set:function(e){this._addedModel&&this._hideModel(),this._layers=e,this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel()}}),Object.defineProperty(lu.prototype,"aabb",{get:function(){return this._meshInstance?this._meshInstance.aabb:null}});var cu=["enabled"];En.prototype=Object.create(zi.prototype),En.prototype.constructor=En,Ui._buildAccessors(lu.prototype,cu),Object.defineProperties(En.prototype,{defaultMaterial:{get:function(){if(!this._defaultMaterial){var e=new K(this.app.graphicsDevice,{width:1,height:1,format:7}),t=new Uint8Array(e.lock());t[0]=t[1]=t[2]=t[3]=255,e.name="sprite",e.unlock(),(t=new Nn).diffuse.set(0,0,0),t.emissive.set(.5,.5,.5),t.emissiveMap=e,t.emissiveMapTint=!0,t.opacityMap=e,t.opacityMapChannel="a",t.opacityTint=!0,t.opacity=0,t.useLighting=!1,t.useGammaTonemap=!1,t.useFog=!1,t.useSkybox=!1,t.blendType=4,t.depthWrite=!1,t.pixelSnap=!1,t.cull=0,t.update(),this._defaultTexture=e,this._defaultMaterial=t}return this._defaultMaterial},set:function(e){this._defaultMaterial=e}},default9SlicedMaterialSlicedMode:{get:function(){if(!this._default9SlicedMaterialSlicedMode){var e=this.defaultMaterial.clone();e.nineSlicedMode=1,e.update(),this._default9SlicedMaterialSlicedMode=e}return this._default9SlicedMaterialSlicedMode},set:function(e){this._default9SlicedMaterialSlicedMode=e}},default9SlicedMaterialTiledMode:{get:function(){if(!this._default9SlicedMaterialTiledMode){var e=this.defaultMaterial.clone();e.nineSlicedMode=2,e.update(),this._default9SlicedMaterialTiledMode=e}return this._default9SlicedMaterialTiledMode},set:function(e){this._default9SlicedMaterialTiledMode=e}}}),Object.assign(En.prototype,{destroy:function(){this._defaultTexture&&(this._defaultTexture.destroy(),this._defaultTexture=null)},initializeComponentData:function(e,t,s){if(void 0!==t.enabled&&(e.enabled=t.enabled),e.type=t.type,t.layers&&"array"===i(t.layers)&&(e.layers=t.layers.slice(0)),void 0!==t.drawOrder&&(e.drawOrder=t.drawOrder),void 0!==t.color&&(t.color instanceof h?e.color.set(t.color.r,t.color.g,t.color.b,void 0!==t.opacity?t.opacity:1):e.color.set(t.color[0],t.color[1],t.color[2],void 0!==t.opacity?t.opacity:1),e.color=e.color),void 0!==t.opacity&&(e.opacity=t.opacity),void 0!==t.flipX&&(e.flipX=t.flipX),void 0!==t.flipY&&(e.flipY=t.flipY),void 0!==t.width&&(e.width=t.width),void 0!==t.height&&(e.height=t.height),void 0!==t.spriteAsset&&(e.spriteAsset=t.spriteAsset),t.sprite&&(e.sprite=t.sprite),void 0!==t.frame&&(e.frame=t.frame),t.clips)for(var n in t.clips)e.addClip(t.clips[n]);void 0!==t.speed&&(e.speed=t.speed),t.autoPlayClip&&(e.autoPlayClip=t.autoPlayClip),e.batchGroupId=void 0===t.batchGroupId||null===t.batchGroupId?-1:t.batchGroupId,zi.prototype.initializeComponentData.call(this,e,t,s)},cloneComponent:function(e,t){return e=e.sprite,this.addComponent(t,{enabled:e.enabled,type:e.type,spriteAsset:e.spriteAsset,sprite:e.sprite,frame:e.frame,color:e.color.clone(),opacity:e.opacity,flipX:e.flipX,flipY:e.flipY,speed:e.speed,clips:e.clips,autoPlayClip:e.autoPlayClip,batchGroupId:e.batchGroupId,drawOrder:e.drawOrder,layers:e.layers.slice(0)})},onUpdate:function(e){var t,i=this.store;for(t in i)if(i.hasOwnProperty(t)){var s=i[t];s.data.enabled&&s.entity.enabled&&((s=s.entity.sprite)._currentClip&&s._currentClip._update(e))}},onBeforeRemove:function(e,t){t.onDestroy()}}),Cn.prototype=Object.create(Ui.prototype),Cn.prototype.constructor=Cn,Object.assign(Cn.prototype,{onEnable:function(){this._checkState()},onDisable:function(){this._checkState()},_onSetEnabled:function(e,t,i){this._checkState()},_checkState:function(){var e=this.enabled&&this.entity.enabled;e!==this._oldState&&(this._oldState=e,this.fire("enable"),this.fire("state",this.enabled))},_onBeforeRemove:function(){this.fire("remove")}}),Object.defineProperty(Cn.prototype,"size",{set:function(e){e instanceof v?this._size.copy(e):e instanceof Array&&3<=e.length&&this.size.set(e[0],e[1],e[2])},get:function(){return this._size}});var du=["enabled"],uu=function(e){zi.call(this,e),this.id="zone",this.ComponentType=Cn,this.DataType=In,this.schema=du,this.on("beforeremove",this._onBeforeRemove,this)};uu.prototype=Object.create(zi.prototype),uu.prototype.constructor=uu,Ui._buildAccessors(Cn.prototype,du),Object.assign(uu.prototype,{initializeComponentData:function(e,t,i){e.enabled=!t.hasOwnProperty("enabled")||!!t.enabled,t.size&&(t.size instanceof v?e.size.copy(t.size):t.size instanceof Array&&3<=t.size.length&&e.size.set(t.size[0],t.size[1],t.size[2]))},cloneComponent:function(e,t){return this.addComponent(t,{size:e.zone.size})},_onBeforeRemove:function(e,t){t._onBeforeRemove()}}),Dn.prototype.destroy=function(){this._app=null},Dn.prototype.list=function(){return this._list},Dn.prototype.add=function(e,t){return!this._index.hasOwnProperty(e)&&(e=new Rn(e,t),t=this._list.push(e),this._index[e.name]=t-1,this._urlIndex[e.url]=t-1,!0)},Dn.prototype.find=function(e){return this._index.hasOwnProperty(e)?this._list[this._index[e]]:null},Dn.prototype.findByUrl=function(e){return this._urlIndex.hasOwnProperty(e)?this._list[this._urlIndex[e]]:null},Dn.prototype.remove=function(e){if(this._index.hasOwnProperty(e)){var t=this._index[e],i=this._list[t];for(delete this._urlIndex[i.url],delete this._index[e],this._list.splice(t,1),t=0;t<this._list.length;t++)i=this._list[t],this._index[i.name]=t,this._urlIndex[i.url]=t}},Dn.prototype.loadSceneHierarchy=function(e,t){var i=this,s=this._app.loader.getHandler("hierarchy");this._app.assets&&this._app.assets.prefix&&!qh.test(e)&&(e=zr.join(this._app.assets.prefix,e)),s.load(e,function(n,r){n?t&&t(n):i._app._preloadScripts(r,function(){i._app.systems.script.preloading=!0;var a=s.open(e,r);i._app.systems.script.preloading=!1,i._app.loader.clearCache(e,"hierarchy"),i._app.root.addChild(a),zi.initialize(a),zi.postInitialize(a),t&&t(n,a)})})},Dn.prototype.loadSceneSettings=function(e,t){var i=this;this._app.assets&&this._app.assets.prefix&&!qh.test(e)&&(e=zr.join(this._app.assets.prefix,e)),this._app.loader.load(e,"scenesettings",function(e,s){e?t&&t(e):(i._app.applySceneSettings(s),t&&t(null))})},Dn.prototype.loadScene=function(e,t){var i=this,s=this._app.loader.getHandler("scene");this._app.assets&&this._app.assets.prefix&&!qh.test(e)&&(e=zr.join(this._app.assets.prefix,e)),s.load(e,function(n,r){n?t&&t(n):i._app._preloadScripts(r,function(){i._app.systems.script.preloading=!0;var n=s.open(e,r);i._app.systems.script.preloading=!1,i._app.loader.clearCache(e,"scene"),i._app.loader.patch({resource:n,type:"scene"},i._app.assets),i._app.root.addChild(n.root),i._app.systems.rigidbody&&"undefined"!=typeof Ammo&&i._app.systems.rigidbody.gravity.set(n._gravity.x,n._gravity.y,n._gravity.z),t&&t(null,n)})})};var pu=!1,fu=new ge;e.app=null,Ln.prototype=Object.create(r.prototype),Ln.prototype.constructor=Ln,Ln._currentApplication=null,Ln._applications={},Ln.getApplication=function(e){return e?Ln._applications[e]:Ln._currentApplication};var mu=function(e){this.length=e,this.count=0,this.inc=function(){this.count++},this.done=function(){return this.count===this.length}};Object.defineProperty(Ln.prototype,"fillMode",{get:function(){return this._fillMode}}),Object.defineProperty(Ln.prototype,"resolutionMode",{get:function(){return this._resolutionMode}}),Object.assign(Ln.prototype,{configure:function(e,t){var i=this;qr.get(e,function(e,s){if(e)t(e);else{var n=s.scenes,r=s.assets;i._parseApplicationProperties(s.application_properties,function(e){i._parseScenes(n),i._parseAssets(r),t(e||null)})}})},preload:function(e){var t,i=this;i.fire("preload:start");var s=this.assets.list({preload:!0}),n=new mu(s.length),r=!1,a=function(){i.graphicsDevice&&!r&&n.done()&&(r=!0,i.fire("preload:end"),e())},o=s.length;if(n.length){var h=function(e){n.inc(),i.fire("preload:progress",n.count/o),n.done()&&a()},l=function(e,t){n.inc(),i.fire("preload:progress",n.count/o),n.done()&&a()};for(t=0;t<s.length;t++)s[t].loaded?(n.inc(),i.fire("preload:progress",n.count/o),n.done()&&a()):(s[t].once("load",h),s[t].once("error",l),this.assets.load(s[t]))}else a()},getSceneUrl:function(e){return(e=this.scenes.find(e))?e.url:null},loadSceneHierarchy:function(e,t){this.scenes.loadSceneHierarchy(e,t)},loadSceneSettings:function(e,t){this.scenes.loadSceneSettings(e,t)},loadScene:function(e,t){this.scenes.loadScene(e,t)},_preloadScripts:function(e,t){if(Rl.legacy){var i=this;i.systems.script.preloading=!0;var s=0,n=(e=this._getScriptReferences(e)).length,r=new mu(n),a=/^http(s)?:\/\//;if(n){var o=function(e,s){e&&console.error(e),r.inc(),r.done()&&(i.systems.script.preloading=!1,t())};for(s=0;s<n;s++){var h=e[s];!a.test(h.toLowerCase())&&i._scriptPrefix&&(h=zr.join(i._scriptPrefix,e[s])),this.loader.load(h,"script",o)}}else i.systems.script.preloading=!1,t()}else t()},_parseApplicationProperties:function(e,t){if(e.useDevicePixelRatio||(e.useDevicePixelRatio=e.use_device_pixel_ratio),e.resolutionMode||(e.resolutionMode=e.resolution_mode),e.fillMode||(e.fillMode=e.fill_mode),this._width=e.width,this._height=e.height,e.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(e.resolutionMode,this._width,this._height),this.setCanvasFillMode(e.fillMode,this._width,this._height),e.layers&&e.layerOrder){var i=new Re,s={};for(r in e.layers){var n=e.layers[r];n.id=parseInt(r,10),n.enabled=1!==n.id,s[r]=new Se(n)}var r=0;for(n=e.layerOrder.length;r<n;r++){var a=e.layerOrder[r],o=s[a.layer];o&&(a.transparent?i.pushTransparent(o):i.pushOpaque(o),i.subLayerEnabled[r]=a.enabled)}this.scene.layers=i}if(e.batchGroups)for(r=0,n=e.batchGroups.length;r<n;r++)i=e.batchGroups[r],this.batcher.addGroup(i.name,i.dynamic,i.maxAabbSize,i.id,i.layers);e.i18nAssets&&(this.i18n.assets=e.i18nAssets),this._loadLibraries(e.libraries,t)},_loadLibraries:function(e,t){var i=e.length,s=i,n=this,r=/^http(s)?:\/\//;if(i)for(var a=function(e,i){s--,e?t(e):0===s&&(n.onLibrariesLoaded(),t(null))},o=0;o<i;++o){var h=e[o];!r.test(h.toLowerCase())&&n._scriptPrefix&&(h=zr.join(n._scriptPrefix,h)),this.loader.load(h,"script",a)}else n.onLibrariesLoaded(),t(null)},_parseScenes:function(e){if(e)for(var t=0;t<e.length;t++)this.scenes.add(e[t].name,e[t].url)},_parseAssets:function(e){var t,i=[],s={},n={};if(Rl.legacy){if(this.enableBundles)for(r in e)"bundle"===e[r].type&&(n[r]=!0,i.push(e[r]));for(r in e)n[r]||i.push(e[r])}else{for(t=0;t<this.scriptsOrder.length;t++){var r=this.scriptsOrder[t];e[r]&&(s[r]=!0,i.push(e[r]))}if(this.enableBundles)for(r in e)"bundle"===e[r].type&&(n[r]=!0,i.push(e[r]));for(r in e)s[r]||n[r]||i.push(e[r])}for(t=0;t<i.length;t++){if((r=new Pt((e=i[t]).name,e.type,e.file,e.data)).id=parseInt(e.id,10),r.preload=!!e.preload&&e.preload,r.loaded="script"===e.type&&e.data&&0<e.data.loadingType,r.tags.add(e.tags),e.i18n)for(var a in e.i18n)r.addLocalizedAssetId(a,e.i18n[a]);this.assets.add(r)}},_getScriptReferences:function(e){var t,i,s=[];e.settings.priority_scripts&&(s=e.settings.priority_scripts);var n=[],r={};for(t=0;t<s.length;t++)n.push(s[t]),r[s[t]]=!0;for(i in e=e.entities)if(e[i].components.script)for(s=e[i].components.script.scripts,t=0;t<s.length;t++)r[s[t].url]||(n.push(s[t].url),r[s[t].url]=!0);return n},start:function(){this.frame=0,this.fire("start",{timestamp:Xr(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),zi.initialize(this.root),this.fire("initialize"),zi.postInitialize(this.root),this.fire("postinitialize"),this.tick()},update:function(e){this.frame++,this.graphicsDevice.updateClientRect(),this.vr&&this.vr.poll(),Rl.legacy&&zi.fixedUpdate(1/60,this._inTools),zi.update(e,this._inTools),zi.animationUpdate(e,this._inTools),zi.postUpdate(e,this._inTools),this.fire("update",e),this.controller&&this.controller.update(e),this.mouse&&this.mouse.update(e),this.keyboard&&this.keyboard.update(e),this.gamepads&&this.gamepads.update(e)},render:function(){this.fire("prerender"),this.root.syncHierarchy(),this.batcher.updateAll(),this.renderer.renderComposition(this.scene.layers),this.fire("postrender")},_fillFrameStats:function(e,t,i){var s=this.stats.frame;for(s.dt=t,s.ms=i,e>s._timeToCountFrames?(s.fps=s._fpsAccum,s._fpsAccum=0,s._timeToCountFrames=e+1e3):s._fpsAccum++,s.cameras=this.renderer._camerasRendered,s.materials=this.renderer._materialSwitches,s.shaders=this.graphicsDevice._shaderSwitchesPerFrame,s.shadowMapUpdates=this.renderer._shadowMapUpdates,s.shadowMapTime=this.renderer._shadowMapTime,s.depthMapTime=this.renderer._depthMapTime,s.forwardTime=this.renderer._forwardTime,e=this.graphicsDevice._primsPerFrame,s.triangles=e[4]/3+Math.max(e[5]-2,0)+Math.max(e[6]-2,0),s.cullTime=this.renderer._cullTime,s.sortTime=this.renderer._sortTime,s.skinTime=this.renderer._skinTime,s.morphTime=this.renderer._morphTime,s.instancingTime=this.renderer._instancingTime,t=s.otherPrimitives=0;t<e.length;t++)4>t&&(s.otherPrimitives+=e[t]),e[t]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._instancingTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,(s=this.stats.drawCalls).forward=this.renderer._forwardDrawCalls,s.culled=this.renderer._numDrawCallsCulled,s.depth=0,s.shadow=this.renderer._shadowDrawCalls,s.skinned=this.renderer._skinDrawCalls,s.immediate=0,s.instanced=0,s.removedByInstancing=0,s.total=this.graphicsDevice._drawCallsPerFrame,s.misc=s.total-(s.forward+s.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.renderer._removedByInstancing=0,this.graphicsDevice._drawCallsPerFrame=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,(s=this.stats.particles).updatesPerFrame=s._updatesPerFrame,s.frameTime=s._frameTime,s._updatesPerFrame=0,s._frameTime=0},setCanvasFillMode:function(e,t,i){this._fillMode=e,this.resizeCanvas(t,i)},setCanvasResolution:function(e,t,i){this._resolutionMode=e,"AUTO"===e&&void 0===t&&(t=this.graphicsDevice.canvas.clientWidth,i=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(t,i)},isHidden:function(){return document[this._hiddenAttr]},onVisibilityChange:function(){this.isHidden()?this._soundManager.suspend():this._soundManager.resume()},resizeCanvas:function(e,t){if(this._allowResize&&(!this.xr||!this.xr.session)){var i=window.innerWidth,s=window.innerHeight;if(this._fillMode===jl){var n=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;n>i/s?t=(e=i)/n:e=(t=s)*n}else"FILL_WINDOW"===this._fillMode&&(e=i,t=s);return this.graphicsDevice.canvas.style.width=e+"px",this.graphicsDevice.canvas.style.height=t+"px","AUTO"===this._resolutionMode&&this.setCanvasResolution("AUTO"),{width:e,height:t}}},onLibrariesLoaded:function(){this._librariesLoaded=!0,this.systems.rigidbody.onLibraryLoaded()},applySceneSettings:function(e){if(this.systems.rigidbody&&"undefined"!=typeof Ammo){var t=e.physics.gravity;this.systems.rigidbody.gravity.set(t[0],t[1],t[2])}this.scene.applySettings(e),e.render.hasOwnProperty("skybox")&&(e.render.skybox?(t=this.assets.get(e.render.skybox))?this.setSkybox(t):this.assets.once("add:"+e.render.skybox,this.setSkybox,this):this.setSkybox(null))},setSkybox:function(e){e?this._skyboxLast===e.id?0!==this.scene.skyboxMip||e.loadFaces?this._onSkyboxChange(e):this._skyboxLoad(e):(this._skyboxLast&&(this.assets.off("add:"+this._skyboxLast,this.setSkybox,this),this.assets.off("load:"+this._skyboxLast,this._onSkyboxChange,this),this.assets.off("remove:"+this._skyboxLast,this._skyboxRemove,this)),this._skyboxLast=e.id,this.assets.on("load:"+e.id,this._onSkyboxChange,this),this.assets.once("remove:"+e.id,this._skyboxRemove,this),e.resource&&this.scene.setSkybox(e.resources),this._skyboxLoad(e)):this._skyboxLast&&this._skyboxRemove({id:this._skyboxLast})},enableVr:function(){this.vr||(this.vr=new Ri(this))},disableVr:function(){this.vr&&(this.vr.destroy(),this.vr=null)},_onSkyboxChange:function(e){this.scene.setSkybox(e.resources)},_skyboxLoad:function(e){0===this.scene.skyboxMip&&(e.loadFaces=!0),this.assets.load(e),this._onSkyboxChange(e)},_skyboxRemove:function(e){this._skyboxLast&&(this.assets.off("add:"+e.id,this.setSkybox,this),this.assets.off("load:"+e.id,this._onSkyboxChange,this),this.assets.off("remove:"+e.id,this._skyboxRemove,this),this.scene.setSkybox(null),this._skyboxLast=null)},_firstBake:function(){this.lightmapper.bake(null,this.scene.lightmapMode)},_firstBatch:function(){this.scene._needsStaticPrepare&&(this.renderer.prepareStaticMeshes(this.graphicsDevice,this.scene),this.scene._needsStaticPrepare=!1),this.batcher.generate()},_processTimestamp:function(e){return e},_preRenderImmediate:function(){for(var e=0;e<this._immediateData.lineBatches.length;e++)this._immediateData.lineBatches[e]&&this._immediateData.lineBatches[e].finalize(this.meshInstanceArray)},_postRenderImmediate:function(){for(var e=0;e<this._immediateData.layers.length;e++)this._immediateData.layers[e].clearMeshInstances(!0);this._immediateData.layers.length=0},_initImmediate:function(){this._immediateData||(this._immediateData=new Ie(this.graphicsDevice),this.on("prerender",this._preRenderImmediate,this),this.on("postrender",this._postRenderImmediate,this))},_addLines:function(e,t,i){var s=i&&i.layer?i.layer:this.scene.layers.getLayerById(3),n=!i||void 0===i.depthTest||i.depthTest;i=i&&i.mask?i.mask:void 0,this._initImmediate(),this._immediateData.addLayer(s);var r=this._immediateData.getLayerIdx(s);void 0===r?((r=new Oe).init(this.graphicsDevice,this._immediateData.lineVertexFormat,s,e.length/2),r.material.depthTest=n,i&&(r.meshInstance.mask=i),r=this._immediateData.lineBatches.push(r)-1,this._immediateData.addLayerIdx(r,s)):(this._immediateData.lineBatches[r].init(this.graphicsDevice,this._immediateData.lineVertexFormat,s,e.length/2),this._immediateData.lineBatches[r].material.depthTest=n,i&&(this._immediateData.lineBatches[r].meshInstance.mask=i)),this._immediateData.lineBatches[r].addLines(e,t)},renderLine:function(e,t,i,s,n){var r=i;if(s instanceof h)if(r=s,"number"==typeof n){pu||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),pu=!0);var a=1===n?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}}else a=n;else"number"==typeof s?(pu||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),pu=!0),r=i,a=1===s?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):s&&(a=s);this._addLines([e,t],[i,r],a)},renderLines:function(e,t,i){i?"number"==typeof i&&(pu||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),pu=!0),i=1===i?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):i={layer:this.scene.layers.getLayerById(3),depthTest:!0},t.length&&e.length!==t.length?console.error("renderLines: position/color arrays have different lengths"):0!=e.length%2?console.error("renderLines: array length is not divisible by 2"):this._addLines(e,t,i)},renderWireCube:function(e,t,i){var s;this._initImmediate(),this._immediateData.cubeLocalPos||(this._immediateData.cubeLocalPos=[new v(-.5,-.5,-.5),new v(-.5,.5,-.5),new v(.5,.5,-.5),new v(.5,-.5,-.5),new v(-.5,-.5,.5),new v(-.5,.5,.5),new v(.5,.5,.5),new v(.5,-.5,.5)],this._immediateData.cubeWorldPos=[new v,new v,new v,new v,new v,new v,new v,new v]);var n=this._immediateData.cubeLocalPos,r=this._immediateData.cubeWorldPos;for(s=0;8>s;s++)e.transformPoint(n[s],r[s]);this.renderLines([r[0],r[1],r[1],r[2],r[2],r[3],r[3],r[0],r[4],r[5],r[5],r[6],r[6],r[7],r[7],r[4],r[0],r[4],r[1],r[5],r[2],r[6],r[3],r[7]],t,i)},renderMeshInstance:function(e,t){t||(t={layer:this.scene.layers.getLayerById(3)}),this._initImmediate(),this._immediateData.addLayer(t.layer),this.meshInstanceArray[0]=e,t.layer.addMeshInstances(this.meshInstanceArray,!0)},renderMesh:function(e,t,i,s){s||(s={layer:this.scene.layers.getLayerById(3)}),this._initImmediate(),fu.worldTransform=i,fu._dirtyWorld=fu._dirtyNormal=!1,(e=new ee(fu,e,t)).cull=!1,s.mask&&(e.mask=s.mask),this._immediateData.addLayer(s.layer),this.meshInstanceArray[0]=e,s.layer.addMeshInstances(this.meshInstanceArray,!0)},renderQuad:function(e,t,i){if(i||(i={layer:this.scene.layers.getLayerById(3)}),this._initImmediate(),!this._immediateData.quadMesh){var s=new R(this.graphicsDevice,[{semantic:"POSITION",components:3,type:6}]),n=new X(s=new I(this.graphicsDevice,s,4));n.element.POSITION.set(-.5,-.5,0),n.next(),n.element.POSITION.set(.5,-.5,0),n.next(),n.element.POSITION.set(-.5,.5,0),n.next(),n.element.POSITION.set(.5,.5,0),n.end(),this._immediateData.quadMesh=new J(this.graphicsDevice),this._immediateData.quadMesh.vertexBuffer=s,this._immediateData.quadMesh.primitive[0].type=5,this._immediateData.quadMesh.primitive[0].base=0,this._immediateData.quadMesh.primitive[0].count=4,this._immediateData.quadMesh.primitive[0].indexed=!1}fu.worldTransform=e,fu._dirtyWorld=fu._dirtyNormal=!1,(e=new ee(fu,this._immediateData.quadMesh,t)).cull=!1,this.meshInstanceArray[0]=e,this._immediateData.addLayer(i.layer),i.layer.addMeshInstances(this.meshInstanceArray,!0)},destroy:function(){var e,t=this.graphicsDevice.canvas.id;this.off("librariesloaded"),document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1),this.onVisibilityChange=this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.controller&&(this.controller=null);var i=this.systems.list,s=0;for(e=i.length;s<e;s++)i[s].destroy();for(zi.destroy(),e=this.assets.list(),s=0;s<e.length;s++)e[s].unload(),e[s].off();for(var n in this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null,this.loader.getHandler("script")._cache)(e=(s=this.loader.getHandler("script")._cache[n]).parentNode)&&e.removeChild(s);this.loader.getHandler("script")._cache={},this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=[],this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,this.lightmapper.destroy(),this.lightmapper=null,this.batcher.destroyManager(),this.batcher=null,this._entityIndex={},this.defaultLayerDepth.onPreRenderOpaque=null,this.defaultLayerDepth.onPostRenderOpaque=null,this.defaultLayerDepth.onDisable=null,this.defaultLayerWorld=this.defaultLayerDepth=this.defaultLayerDepth.onEnable=null,pa&&(pa.destroy(),pa=null),this.vr&&(this.vr.destroy(),this.vr=null),this.xr.end(),this.graphicsDevice.destroy(),this.tick=this.renderer=this.graphicsDevice=null,this.off(),this._soundManager&&(this._soundManager.destroy(),this._soundManager=null),Rl.app=null,Bh.DEFAULT_PARAM_TEXTURE=null,Ln._applications[t]=null,Ln._currentApplication===this&&(Ln._currentApplication=null)},getEntityFromIndex:function(e){return this._entityIndex[e]}});var _u={},gu=function(t){var i;return function(s,n){if(t.graphicsDevice){Ln._currentApplication=t,i&&(window.cancelAnimationFrame(i),i=null),e.app=t;var r=(s=t._processTimestamp(s)||Xr())-(t._time||s),a=Hr.clamp(r/1e3,0,t.maxDeltaTime);a*=t.timeScale,t._time=s,i=t.vr&&t.vr.display?t.vr.display.requestAnimationFrame(t.tick):t.xr.session?t.xr.session.requestAnimationFrame(t.tick):window.requestAnimationFrame(t.tick),t.graphicsDevice.contextLost||(t.fire("frameupdate",r),n?(t.xr.update(n),t.graphicsDevice.defaultFramebuffer=n.session.renderState.baseLayer.framebuffer):t.graphicsDevice.defaultFramebuffer=null,t.update(a),t.fire("framerender"),(t.autoRender||t.renderNextFrame)&&(t.render(),t.renderNextFrame=!1),_u.timestamp=Xr(),_u.target=t,t.fire("frameend",_u),t.fire("frameEnd",_u),t.vr&&t.vr.display&&t.vr.display.presenting&&t.vr.display.submitFrame())}}},yu=0;Object.defineProperty(Fn.prototype,"shader",{get:function(){return this._shader},set:function(e){this._shader=e}}),Object.defineProperty(Fn.prototype,"blendType",{get:function(){if(!this.blend&&1===this.blendSrc&&0===this.blendDst&&0===this.blendEquation)return 3;if(!this.blend||6!==this.blendSrc||8!==this.blendDst||0!==this.blendEquation){if(this.blend&&1===this.blendSrc&&1===this.blendDst&&0===this.blendEquation)return 1;if(this.blend&&6===this.blendSrc&&1===this.blendDst&&0===this.blendEquation)return 6;if(this.blend&&4===this.blendSrc&&2===this.blendDst&&0===this.blendEquation)return 7;if(this.blend&&5===this.blendSrc&&1===this.blendDst&&0===this.blendEquation)return 8;if(this.blend&&1===this.blendSrc&&1===this.blendDst&&3===this.blendEquation)return 9;if(this.blend&&1===this.blendSrc&&1===this.blendDst&&4===this.blendEquation)return 10;if(this.blend&&4===this.blendSrc&&0===this.blendDst&&0===this.blendEquation)return 5;if(this.blend&&1===this.blendSrc&&8===this.blendDst&&0===this.blendEquation)return 4}return 2},set:function(e){var t=this.blend;switch(e){case 3:this.blend=!1,this.blendSrc=1,this.blendEquation=this.blendDst=0;break;case 2:this.blend=!0,this.blendSrc=6,this.blendDst=8,this.blendEquation=0;break;case 4:this.blend=!0,this.blendSrc=1,this.blendDst=8,this.blendEquation=0;break;case 1:this.blend=!0,this.blendDst=this.blendSrc=1,this.blendEquation=0;break;case 6:this.blend=!0,this.blendSrc=6,this.blendDst=1,this.blendEquation=0;break;case 7:this.blend=!0,this.blendSrc=4,this.blendDst=2,this.blendEquation=0;break;case 8:this.blend=!0,this.blendSrc=5,this.blendDst=1,this.blendEquation=0;break;case 5:this.blend=!0,this.blendSrc=4,this.blendEquation=this.blendDst=0;break;case 9:this.blend=!0,this.blendDst=this.blendSrc=1,this.blendEquation=3;break;case 10:this.blend=!0,this.blendDst=this.blendSrc=1,this.blendEquation=4}t!==this.blend&&(this._scene?this._scene.layers._dirtyBlend=!0:this._dirtyBlend=!0),this._updateMeshInstanceKeys()}}),Fn.prototype._cloneInternal=function(e){e.name=this.name,e.shader=this.shader,e.alphaTest=this.alphaTest,e.alphaToCoverage=this.alphaToCoverage,e.blend=this.blend,e.blendSrc=this.blendSrc,e.blendDst=this.blendDst,e.blendEquation=this.blendEquation,e.separateAlphaBlend=this.separateAlphaBlend,e.blendSrcAlpha=this.blendSrcAlpha,e.blendDstAlpha=this.blendDstAlpha,e.blendAlphaEquation=this.blendAlphaEquation,e.cull=this.cull,e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e.depthBias=this.depthBias,e.slopeDepthBias=this.slopeDepthBias,this.stencilFront&&(e.stencilFront=this.stencilFront.clone()),this.stencilBack&&(e.stencilBack=this.stencilFront===this.stencilBack?e.stencilFront:this.stencilBack.clone()),e.redWrite=this.redWrite,e.greenWrite=this.greenWrite,e.blueWrite=this.blueWrite,e.alphaWrite=this.alphaWrite},Fn.prototype.clone=function(){var e=new Fn;return this._cloneInternal(e),e},Fn.prototype._updateMeshInstanceKeys=function(){var e,t=this.meshInstances;for(e=0;e<t.length;e++)t[e].updateKey()},Fn.prototype.updateUniforms=function(){},Fn.prototype.updateShader=function(e,t,i){},Fn.prototype.update=function(){this.dirty=!0},Fn.prototype.clearParameters=function(){this.parameters={}},Fn.prototype.getParameters=function(){return this.parameters},Fn.prototype.clearVariants=function(){this.variants={};for(var e,t=0;t<this.meshInstances.length;t++){var i=this.meshInstances[t];for(e=0;e<i._shader.length;e++)i._shader[e]=null}},Fn.prototype.getParameter=function(e){return this.parameters[e]},Fn.prototype.setParameter=function(e,t,i){if(void 0===i&&(i=-524285),void 0===t&&"object"==typeof e){if((t=e).length){for(e=0;e<t.length;e++)this.setParameter(t[e]);return}e=t.name,t=t.value}var s=this.parameters[e];s?(s.data=t,s.passFlags=i):this.parameters[e]={scopeId:null,data:t,passFlags:i}},Fn.prototype.deleteParameter=function(e){this.parameters[e]&&delete this.parameters[e]},Fn.prototype.setParameters=function(){for(var e in this.parameters){var t=this.parameters[e];t.scopeId.setValue(t.data)}},Fn.prototype.destroy=function(){this.variants={},this.shader=null;for(var e,t,i=0;i<this.meshInstances.length;i++){for(e=this.meshInstances[i],t=0;t<e._shader.length;t++)e._shader[t]=null;e._material=null,this!==(t=Ln.getApplication().scene.defaultMaterial)&&(e.material=t)}},Bn.prototype.updateMinRef=function(e,t,i,s,n,r,a,o,h){this._updateSharedOptions(e,s,n,a),this._updateMinOptions(e,s),this._updateUVOptions(e,s,n,!0)},Bn.prototype.updateRef=function(e,t,i,s,n,r,a,o,h){this._updateSharedOptions(e,s,n,a),e.useTexCubeLod=t.useTexCubeLod,this._updateEnvOptions(e,s,i,h),this._updateMaterialOptions(e,s),1===a&&(e.gamma&&(e.gamma=3),e.toneMap=0),e.hasTangents=n&&s.normalMap&&0!=(512&n),this._updateLightOptions(e,s,n,o,r),this._updateUVOptions(e,s,n,!1),e.clearCoat=s.clearCoat,e.clearCoatGlossiness=s.clearCoatGlossiness},Bn.prototype._updateSharedOptions=function(e,t,i,s){e.pass=s,e.alphaTest=0<t.alphaTest,e.forceFragmentPrecision=t.forceFragmentPrecision||"",e.chunks=t.chunks||"",e.blendType=t.blendType,e.forceUv1=t.forceUv1,e.screenSpace=i&&0!=(256&i),e.skin=i&&0!=(2&i),e.useInstancing=i&&0!=(32&i),e.useMorphPosition=i&&0!=(1024&i),e.useMorphNormal=i&&0!=(2048&i),e.useMorphTextureBased=i&&0!=(4096&i),e.nineSlicedMode=t.nineSlicedMode||0},Bn.prototype._updateUVOptions=function(e,t,i,s){var n=!1,r=!1,a=!1;for(var o in i&&(n=0!=(4&i),r=0!=(8&i),a=0!=(16&i)),e.vertexColors=!1,this._mapXForms=[],Ta)this._updateTexOptions(e,t,o,n,r,a,s);this._mapXForms=null},Bn.prototype._updateMinOptions=function(e,t){e.opacityTint=1!==t.opacity&&3!==t.blendType,e.lights=[]},Bn.prototype._updateMaterialOptions=function(e,t){var i=1===t.diffuse.r&&1===t.diffuse.g&&1===t.diffuse.b||!t.diffuseTint&&(t.diffuseMap||t.diffuseVertexColor)?0:3,s=!1,n=!!(t.useMetalness||t.specularMap||t.sphereMap||t.cubeMap||t.dpAtlas);(n=(n=(n=n||!!t.useMetalness||!(0===t.specular.r&&0===t.specular.g&&0===t.specular.b))||t.enableGGXSpecular)||0<t.clearCoat)&&(!t.specularTint&&(t.specularMap||t.specularVertexColor)||t.useMetalness||(s=1!==t.specular.r||1!==t.specular.g||1!==t.specular.b));var r=t.emissiveMap?0:3;r||(r=(r=(1!==t.emissive.r||1!==t.emissive.g||1!==t.emissive.b||1!==t.emissiveIntensity)&&t.emissiveTint)?3:1!==t.emissiveIntensity?1:0);var a=!!t.normalMap&&(10===t.normalMap.format||"swizzleGGGR"===t.normalMap.type);e.opacityTint=1!==t.opacity&&3!==t.blendType?1:0,e.blendMapsWithColors=!0,e.ambientTint=t.ambientTint,e.diffuseTint=i,e.specularTint=s?3:0,e.metalnessTint=t.useMetalness&&1>t.metalness?1:0,e.glossTint=1,e.emissiveTint=r,e.alphaToCoverage=t.alphaToCoverage,e.normalizeNormalMap=t.normalizeNormalMap,e.sphereMap=!!t.sphereMap,e.cubeMap=!!t.cubeMap,e.dpAtlas=!!t.dpAtlas,e.ambientSH=!!t.ambientSH,e.useSpecular=n,e.emissiveFormat=t.emissiveMap?"rgbm"===t.emissiveMap.type?1:14===t.emissiveMap.format?2:0:null,e.lightMapFormat=t.lightMap?"rgbm"===t.lightMap.type?1:14===t.lightMap.format?2:0:null,e.specularAntialias=t.specularAntialias&&!!t.normalMap&&!!t.normalMap.mipmaps&&!a,e.conserveEnergy=t.conserveEnergy,e.occludeSpecular=t.occludeSpecular,e.occludeSpecularFloat=1!==t.occludeSpecularIntensity,e.occludeDirect=t.occludeDirect,e.shadingModel=t.shadingModel,e.fresnelModel=t.fresnelModel,e.packedNormal=a,e.fastTbn=t.fastTbn,e.cubeMapProjection=t.cubeMapProjection,e.customFragmentShader=t.customFragmentShader,e.refraction=!!t.refraction,e.useMetalness=t.useMetalness,e.enableGGXSpecular=t.enableGGXSpecular,e.msdf=!!t.msdfMap,e.twoSidedLighting=t.twoSidedLighting,e.pixelSnap=t.pixelSnap,e.aoMapUv=t.aoUvSet,e.diffuseDetail=!!t.diffuseMap,e.normalDetail=!!t.normalMap,e.diffuseDetailMode=t.diffuseDetailMode,e.detailModes=!!e.diffuseDetail},Bn.prototype._updateEnvOptions=function(e,t,i,s){var n,r=s&&"rgbm"===s.type||t.cubeMap&&"rgbm"===t.cubeMap.type||t.dpAtlas&&"rgbm"===t.dpAtlas.type,a=s&&("rgbm"===s.type||14===s.format)||t.cubeMap&&("rgbm"===t.cubeMap.type||14===t.cubeMap.format)||t.dpAtlas&&("rgbm"===t.dpAtlas.type||14===t.dpAtlas.format),o=s&&!t.cubeMap&&!t.sphereMap&&!t.dpAtlas&&"rgbm"===s.type||t.cubeMap&&"rgbm"===t.cubeMap.type||t.sphereMap&&"rgbm"===t.sphereMap.type||t.dpAtlas&&"rgbm"===t.dpAtlas.type,h=!(!s||t.cubeMap||t.sphereMap||t.dpAtlas)&&("rgbm"===s.type||14===s.format)||t.cubeMap&&("rgbm"===t.cubeMap.type||14===t.cubeMap.format)||t.sphereMap&&("rgbm"===t.sphereMap.type||14===t.sphereMap.format)||t.dpAtlas&&("rgbm"===t.dpAtlas.type||14===t.dpAtlas.format);t.useSkybox&&i._skyboxPrefiltered&&(n=i._skyboxPrefiltered[0]),e.fog=t.useFog?i.fog:"none",e.gamma=t.useGammaTonemap?i.gammaCorrection:0,e.toneMap=t.useGammaTonemap?i.toneMapping:-1,e.rgbmAmbient=r,e.hdrAmbient=a,e.rgbmReflection=o,e.hdrReflection=h,e.useRgbm=o||r||t.emissiveMap&&"rgbm"===t.emissiveMap.type||t.lightMap&&"rgbm"===t.lightMap.type,e.fixSeams=s?s.fixCubemapSeams:!!t.cubeMap&&t.cubeMap.fixCubemapSeams,e.prefilteredCubemap=!!s,e.skyboxIntensity=s&&n&&s===n&&1!==i.skyboxIntensity},Bn.prototype._updateLightOptions=function(e,t,i,s,n){e.lightMap=!1,e.lightMapChannel="",e.lightMapUv=0,e.lightMapTransform=0,e.lightMapWithoutAmbient=!1,e.dirLightMap=!1,i&&(e.noShadow=0!=(1&i),0!=(64&i)&&(e.lightMapFormat=1,e.lightMap=!0,e.lightMapChannel="rgb",e.lightMapUv=1,e.lightMapTransform=0,e.lightMapWithoutAmbient=!t.lightMap,e.useRgbm=!0,0!=(128&i)&&(e.dirLightMap=!0))),t.useLighting?(t=[],i=i?i>>16:1,s&&(this._collectLights(0,s[0],t,i),this._collectLights(1,s[1],t,i,n),this._collectLights(2,s[2],t,i,n)),e.lights=t):e.lights=[],0===e.lights.length&&(e.noShadow=!0)},Bn.prototype._updateTexOptions=function(e,t,i,s,n,r,a){var o=i+"Map",h=i+"VertexColor",l=i+"VertexColorChannel",c=o+"Channel",d=o+"Transform",u=o+"Uv";"light"!==i&&(e[o]=!1,e[c]="",e[d]=0,e[u]=0),e[h]=!1,e[l]="";var p="opacity"===i;if(p&&3===t.blendType&&0===t.alphaTest&&!t.alphaToCoverage)return e;a&&!p||("height"!==i&&t[h]&&r&&(e[h]=t[h],e[l]=t[l],e.vertexColors=!0),t[o]&&(i=!0,0!==t[u]||s||(i=!1),1!==t[u]||n||(i=!1),i&&(e[o]=!!t[o],e[d]=this._getMapTransformID(t[d],t[u]),e[c]=t[c],e[u]=t[u])))},Bn.prototype._collectLights=function(e,t,i,s,n){var r;for(r=0;r<t.length;r++){var a=t[r];a.enabled&&a.mask&s&&(0===e||!a.isStatic)&&i.push(a)}if(n)for(r=0;r<n.length;r++)(a=n[r])._type===e&&i.push(a)},Bn.prototype._getMapTransformID=function(e,t){if(!e)return 0;var i;for(this._mapXForms[t]||(this._mapXForms[t]=[]),i=0;i<this._mapXForms[t].length&&this._mapXForms[t][i][0]==e.x&&this._mapXForms[t][i][1]==e.y&&this._mapXForms[t][i][2]==e.z&&this._mapXForms[t][i][3]==e.w;)return i+1;return i=this._mapXForms[t].length,this._mapXForms[t][i]=[],this._mapXForms[t][i][0]=e.x,this._mapXForms[t][i][1]=e.y,this._mapXForms[t][i][2]=e.z,this._mapXForms[t][i][3]=e.w,i+1},Nn.prototype=Object.create(Fn.prototype),Nn.prototype.constructor=Nn,Nn.TEXTURE_PARAMETERS=wl,Nn.CUBEMAP_PARAMETERS=Pl;var vu=[],bu=[],xu=[],Su=[],Tu={},wu=function(e,t,i,s,n,r,a){var o="_"+t+"Map",h=o+"Tiling",l=o+"Offset",c=o.substring(1)+"Transform",d=c+"Uniform",u=o+"Uv",p=o+"Channel",f="_"+t+"VertexColor",m="_"+t+"VertexColorChannel",_="_"+t+"Mode";e[o]=null,e[h]=new T(1,1),e[l]=new T(0,0),e[c]=null,e[d]=null,e[u]=i,0<s&&(i=n||(1<s?"rgb":"g"),e[p]=i,r&&(e[m]=i)),r&&(e[f]=!1),a&&(e[_]="mul"),Ta[t]=s,Object.defineProperty(Nn.prototype,o.substring(1),{get:function(){return this[o]},set:function(e){var t=this[o];!!t^!!e&&(this.dirtyShader=!0),t&&e&&(t.type!==e.type||t.fixCubemapSeams!==e.fixCubemapSeams||t.format!==e.format)&&(this.dirtyShader=!0),this[o]=e}}),e=h.substring(1),t=l.substring(1),Object.defineProperty(Nn.prototype,e,{get:function(){return this[h]},set:function(e){this.dirtyShader=!0,this[h]=e}}),Tu[e]=function(e,t,i){return e=e._updateMapTransform(i?e[c]:null,t,e[l]),{name:"texture_"+c,value:e.data}},Object.defineProperty(Nn.prototype,t,{get:function(){return this[l]},set:function(e){this.dirtyShader=!0,this[l]=e}}),Tu[t]=function(e,t,i){return e=e._updateMapTransform(i?e[c]:null,e[h],t),{name:"texture_"+c,value:e.data}},Object.defineProperty(Nn.prototype,u.substring(1),{get:function(){return this[u]},set:function(e){this[u]!==e&&(this.dirtyShader=!0),this[u]=e}}),Object.defineProperty(Nn.prototype,p.substring(1),{get:function(){return this[p]},set:function(e){this[p]!==e&&(this.dirtyShader=!0),this[p]=e}}),r&&(Object.defineProperty(Nn.prototype,f.substring(1),{get:function(){return this[f]},set:function(e){this.dirtyShader=!0,this[f]=e}}),Object.defineProperty(Nn.prototype,m.substring(1),{get:function(){return this[m]},set:function(e){this[m]!==e&&(this.dirtyShader=!0),this[m]=e}})),a&&Object.defineProperty(Nn.prototype,_.substring(1),{get:function(){return this[_]},set:function(e){this.dirtyShader=!0,this[_]=e}}),vu.push(o.substring(1)),vu.push(h.substring(1)),vu.push(l.substring(1)),vu.push(u.substring(1)),vu.push(p.substring(1)),r&&(vu.push(f.substring(1)),vu.push(m.substring(1))),a&&vu.push(_.substring(1)),xu.push(c)},Mu=[],Pu=function(e,t,i,s){var n="_"+t,r=t+"Uniform",a=t+"Intensity",o="_"+a;e[n]=i,e[r]=new Float32Array(3),Object.defineProperty(Nn.prototype,t,{get:function(){return this.dirtyShader=this.dirtyColor=!0,this[n]},set:function(e){var t=this[n];(0===t.r&&0===t.g&&0===t.b||1===t.r&&1===t.g&&1===t.b)^(0===e.r&&0===e.g&&0===e.b||1===e.r&&1===e.g&&1===e.b)&&(this.dirtyShader=!0),this.dirtyColor=!0,this[n]=e}}),vu.push(t),Su.push(r),Mu.push(t),Tu[t]=function(e,i,n){n=n?e[r]:new Float32Array(3);var a=!1;e.useGammaTonemap&&(a=(e._scene||Ln.getApplication().scene).gammaCorrection);for(var h=0;3>h;h++)n[h]=a?Math.pow(i.data[h],2.2):i.data[h],s&&(n[h]*=e[o]);return{name:"material_"+t,value:n}},s&&(e[o]=1,Object.defineProperty(Nn.prototype,a,{get:function(){return this[o]},set:function(e){var t=this[o];(0===t||1===t)^(0===e||1===e)&&(this.dirtyShader=!0),this.dirtyColor=!0,this[o]=e}}),vu.push(a),Tu[a]=function(e,i,s){i=s?e[r]:new Float32Array(3),s=!1,e.useGammaTonemap&&(s=(e._scene||Ln.getApplication().scene).gammaCorrection);for(var a=0;3>a;a++)i[a]=s?Math.pow(e[n].data[a],2.2):e[n].data[a],i[a]*=e[o];return{name:"material_"+t,value:i}})},Au=function(e,t,i,s){var n="_"+t;e[n]=i,Object.defineProperty(Nn.prototype,t,{get:function(){return this[n]},set:function(e){var t=this[n];t!==e&&(this[n]=e,0===t||1===t||0===e||1===e)&&(this.dirtyShader=!0)}}),vu.push(t),Tu[t]=void 0!==s?s:function(e,i,s){return{name:"material_"+t,value:i}}},Eu=function(e,t,i){var s="_"+t;e[s]=null,Object.defineProperty(Nn.prototype,t,{get:function(){return this[s]},set:function(e){!!this[s]^!!e&&(this.dirtyShader=!0),this[s]=e}}),vu.push(t),Tu[t]=i},Cu=function(e,t,i){Object.defineProperty(Nn.prototype,i,{get:function(){return this[t]},set:function(e){this[t]=e}})},Iu=function(e,t,i){var s="_"+t;e[s]=i,Object.defineProperty(Nn.prototype,t,{get:function(){return this[s]},set:function(e){this[s]!==e&&(this.dirtyShader=!0),this[s]=e}}),vu.push(t)},Ou=function(){};Ou.prototype.copy=function(e){for(var t in e)e.hasOwnProperty(t)&&"copy"!==t&&(this[t]=e[t])},Object.assign(Nn.prototype,{reset:function(){var e;for(e=0;e<vu.length;e++){var t=bu[e];this[vu[e]]=t&&t.clone?t.clone():t}for(e=0;e<xu.length;e++)this[xu[e]]=null;for(e=0;e<Su.length;e++)this[Su[e]]=new Float32Array(3);this._chunks=new Ou,this.cubeMapMinUniform=new Float32Array(3),this.cubeMapMaxUniform=new Float32Array(3)},clone:function(){var e=new Nn;Fn.prototype._cloneInternal.call(this,e);for(var t,i=0;i<vu.length;i++)void 0!==this[t=vu[i]]&&(this[t]&&this[t].copy?e[t]?e[t].copy(this[t]):e[t]=this[t].clone():e[t]=this[t]);return e},_updateMapTransform:function(e,t,i){return(e=e||new b).set(t.x,t.y,i.x,i.y),1===e.x&&1===e.y&&0===e.z&&0===e.w?null:e},_setParameter:function(e,t){this.parameters[e]||this._propsSet.push(e),this.setParameter(e,t)},_clearParameters:function(){for(var e=this._propsSet,t=0;t<e.length;t++)delete this.parameters[e[t]];this._propsSet=[]},_updateMap:function(e){if(this[e+="Map"]){this._setParameter("texture_"+e,this[e]);var t=e+"Transform",i=e+"TransformUniform";this[t]||(this[i]=new Float32Array(4)),this[t]=this._updateMapTransform(this[t],this[e+"Tiling"],this[e+"Offset"]),this[t]&&(this[i][0]=this[t].x,this[i][1]=this[t].y,this[i][2]=this[t].z,this[i][3]=this[t].w,this._setParameter("texture_"+t,this[i]))}},getUniform:function(e,t,i){return(e=Tu[e])?e(this,t,i):null},updateUniforms:function(){this._clearParameters(),this._setParameter("material_ambient",this.ambientUniform),this.diffuseMap&&!this.diffuseTint||this._setParameter("material_diffuse",this.diffuseUniform),this.useMetalness?((!this.metalnessMap||1>this.metalness)&&this._setParameter("material_metalness",this.metalness),this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy)):this.specularMap&&!this.specularTint||this._setParameter("material_specular",this.specularUniform),0<this.clearCoat&&(this._setParameter("material_clearCoatSpecularity",this.clearCoat),this._setParameter("material_clearCoatGlossiness",this.clearCoatGlossiness),this._setParameter("material_clearCoatReflectivity",this.clearCoat));var e=this.getUniform("shininess",this.shininess,!0);for(var t in this._setParameter(e.name,e.value),this.emissiveMap&&!this.emissiveTint||this._setParameter("material_emissive",this.emissiveUniform),this.emissiveMap&&this._setParameter("material_emissiveIntensity",this.emissiveIntensity),0<this.refraction&&(this._setParameter("material_refraction",this.refraction),this._setParameter("material_refractionIndex",this.refractionIndex)),this._setParameter("material_opacity",this.opacity),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),1===this.cubeMapProjection&&this._setParameter(this.getUniform("cubeMapProjectionBox",this.cubeMapProjectionBox,!0)),Ta)this._updateMap(t);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&(e=this.getUniform("heightMapFactor",this.heightMapFactor,!0),this._setParameter(e.name,e.value)),this.cubeMap&&this._setParameter("texture_cubeMap",this.cubeMap),this.prefilteredCubeMap128?this._setParameter("texture_prefilteredCubeMap128",this.prefilteredCubeMap128):this._scene&&this._scene._skyboxPrefiltered[0]&&this._setParameter("texture_prefilteredCubeMap128",this._scene._skyboxPrefiltered[0]),this.prefilteredCubeMap64?this._setParameter("texture_prefilteredCubeMap64",this.prefilteredCubeMap64):this._scene&&this._scene._skyboxPrefiltered[1]&&this._setParameter("texture_prefilteredCubeMap64",this._scene._skyboxPrefiltered[1]),this.prefilteredCubeMap32?this._setParameter("texture_prefilteredCubeMap32",this.prefilteredCubeMap32):this._scene&&this._scene._skyboxPrefiltered[2]&&this._setParameter("texture_prefilteredCubeMap32",this._scene._skyboxPrefiltered[2]),this.prefilteredCubeMap16?this._setParameter("texture_prefilteredCubeMap16",this.prefilteredCubeMap16):this._scene&&this._scene._skyboxPrefiltered[3]&&this._setParameter("texture_prefilteredCubeMap16",this._scene._skyboxPrefiltered[3]),this.prefilteredCubeMap8?this._setParameter("texture_prefilteredCubeMap8",this.prefilteredCubeMap8):this._scene&&this._scene._skyboxPrefiltered[4]&&this._setParameter("texture_prefilteredCubeMap8",this._scene._skyboxPrefiltered[4]),this.prefilteredCubeMap4?this._setParameter("texture_prefilteredCubeMap4",this.prefilteredCubeMap4):this._scene&&this._scene._skyboxPrefiltered[5]&&this._setParameter("texture_prefilteredCubeMap4",this._scene._skyboxPrefiltered[5]),this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this.dpAtlas&&this._setParameter("texture_sphereMap",this.dpAtlas),this._setParameter("material_reflectivity",this.reflectivity),!this.dirtyShader&&this._scene||(this.shader=null,this.clearVariants()),this._processColor()},_processColor:function(){var e;if(this.dirtyColor&&(this._scene||!this.useGammaTonemap)){var t=!1;for(this.useGammaTonemap&&(t=this._scene.gammaCorrection),e=0;e<Mu.length;e++){var i=this["_"+Mu[e]],s=this[Mu[e]+"Uniform"];t?(s[0]=Math.pow(i.r,2.2),s[1]=Math.pow(i.g,2.2),s[2]=Math.pow(i.b,2.2)):(s[0]=i.r,s[1]=i.g,s[2]=i.b)}for(e=0;3>e;e++)this.emissiveUniform[e]*=this.emissiveIntensity;this.dirtyColor=!1}},updateShader:function(e,t,i,s,n,r){!this._colorProcessed&&this._scene&&(this._colorProcessed=!0,this._processColor());var a=e.useTexCubeLod,o=!e.extTextureLod;if(this.useSkybox)var h=t._skyboxPrefiltered[0],l=t._skyboxPrefiltered[1],c=t._skyboxPrefiltered[2],d=t._skyboxPrefiltered[3],u=t._skyboxPrefiltered[4],p=t._skyboxPrefiltered[5];if(h=this.prefilteredCubeMap128||h,l=this.prefilteredCubeMap64||l,c=this.prefilteredCubeMap32||c,d=this.prefilteredCubeMap16||d,u=this.prefilteredCubeMap8||u,p=this.prefilteredCubeMap4||p,h){var f=h&&l&&c&&d&&u&&p;if(o&&f){if(!h.dpAtlas){a=[h,l,c,d,u,p],o=new b,p=new b,l=4*a[0].width,u=(u=Ma).createShaderFromCode(e,u.fullscreenQuadVS,u.dpAtlasQuadPS,"dpAtlasQuad"),c=e.scope.resolve("source"),f=e.scope.resolve("params");var m=new K(e,{type:a[0].type,format:a[0].format,width:l,height:l,mipmaps:!1});m.name="paraboloid";for(var _=new Bu(e,m,{depth:!1}),g=(l+2)/l-1,y=0;6>y;y++){var v=e,x=a[y],S=y,T=Ma;T=T.createShaderFromCode(v,T.fullscreenQuadVS,(x.fixCubemapSeams?T.fixCubemapSeamsStretchPS:T.fixCubemapSeamsNonePS)+T.genParaboloidPS,"genParaboloid");var w=v.scope.resolve("source"),M=v.scope.resolve("params"),P=new b,A=x.width,E=x.format;A=2*Math.max(A,8),(A=new K(v,{type:x.type,format:E,width:2*A,height:A,mipmaps:!1})).name="paraboloid",E=new Bu(v,A,{depth:!1}),P.x=S,P.y=1,w.setValue(x),M.setValue(P.data),q(v,E,T),v=A,c.setValue(v),x=y,(v=o).x=.5*Hr.clamp(x-2,0,1),x-=6*v.x,S=1-v.x,v.y=Math.min(.5*x,.75)*S+v.x,v.z=(1-.5*Hr.clamp(x,0,1))*S,v.w=.5*v.z,v=1/v.z,p.x=v*g,p.y=2*p.x,p.x+=1,p.y+=1,f.setValue(p.data),o.x*=l,o.y*=l,o.z*=l,o.w*=l,q(e,_,u,o)}h.dpAtlas=m,h.sh=qn(d)}this.dpAtlas=h.dpAtlas,this.ambientSH=h.sh,this._setParameter("ambientSH[0]",this.ambientSH),this._setParameter("texture_sphereMap",this.dpAtlas)}else a?6>h._levels.length?f?this._setParameter("texture_prefilteredCubeMap128",h):console.log("Can't use prefiltered cubemap: "+f+", "+a+", "+h._levels):this._setParameter("texture_prefilteredCubeMap128",h):f?(this._setParameter("texture_prefilteredCubeMap128",h),this._setParameter("texture_prefilteredCubeMap64",l),this._setParameter("texture_prefilteredCubeMap32",c),this._setParameter("texture_prefilteredCubeMap16",d),this._setParameter("texture_prefilteredCubeMap8",u),this._setParameter("texture_prefilteredCubeMap4",p)):console.log("Can't use prefiltered cubemap: "+f+", "+a+", "+h._levels)}a=wa.standard,a=(d=1<n&&18>=n)?a.optionsContextMin:a.optionsContext,d?this.shaderOptBuilder.updateMinRef(a,e,t,this,i,s,n,r,h):this.shaderOptBuilder.updateRef(a,e,t,this,i,s,n,r,h),this.onUpdateShader&&(a=this.onUpdateShader(a)),this.shader=e.getProgramLibrary().getProgram("standard",a),i||(this.clearVariants(),this.variants[0]=this.shader),this.dirtyShader=!1}}),function(e){e.dirtyShader=!0,e.dirtyColor=!0,e._scene=null,e._colorProcessed=!1,Pu(e,"ambient",new h(.7,.7,.7)),Pu(e,"diffuse",new h(1,1,1)),Pu(e,"specular",new h(0,0,0)),Pu(e,"emissive",new h(0,0,0),!0),Au(e,"shininess",25,function(e,t){return{name:"material_shininess",value:0===e.shadingModel?Math.pow(2,.11*t):.01*t}}),Au(e,"heightMapFactor",1,function(e,t){return{name:"material_heightMapFactor",value:.025*t}}),Au(e,"opacity",1),Au(e,"alphaTest",0),Au(e,"bumpiness",1),Au(e,"normalDetailMapBumpiness",1),Au(e,"reflectivity",1),Au(e,"occludeSpecularIntensity",1),Au(e,"refraction",0),Au(e,"refractionIndex",1/1.5),Au(e,"metalness",1),Au(e,"anisotropy",0),Au(e,"clearCoat",0),Au(e,"clearCoatGlossiness",1),Au(e,"aoUvSet",0,null),Eu(e,"ambientSH",function(e,t,i){return{name:"ambientSH[0]",value:t}}),Eu(e,"cubeMapProjectionBox",function(e,t,i){var s=i?e.cubeMapMinUniform:new Float32Array(3);return e=i?e.cubeMapMaxUniform:new Float32Array(3),s[0]=t.center.x-t.halfExtents.x,s[1]=t.center.y-t.halfExtents.y,s[2]=t.center.z-t.halfExtents.z,e[0]=t.center.x+t.halfExtents.x,e[1]=t.center.y+t.halfExtents.y,e[2]=t.center.z+t.halfExtents.z,[{name:"envBoxMin",value:s},{name:"envBoxMax",value:e}]}),Object.defineProperty(Nn.prototype,"chunks",{get:function(){return this.dirtyShader=!0,this._chunks},set:function(e){this.dirtyShader=!0,this._chunks=e}}),vu.push("chunks"),Iu(e,"ambientTint",!1),Iu(e,"diffuseTint",!1),Iu(e,"specularTint",!1),Iu(e,"emissiveTint",!1),Iu(e,"fastTbn",!1),Iu(e,"specularAntialias",!1),Iu(e,"useMetalness",!1),Iu(e,"enableGGXSpecular",!1),Iu(e,"occludeDirect",!1),Iu(e,"normalizeNormalMap",!0),Iu(e,"conserveEnergy",!0),Iu(e,"occludeSpecular",1),Iu(e,"shadingModel",1),Iu(e,"fresnelModel",0),Iu(e,"cubeMapProjection",0),Iu(e,"customFragmentShader",null),Iu(e,"forceFragmentPrecision",null),Iu(e,"useFog",!0),Iu(e,"useLighting",!0),Iu(e,"useGammaTonemap",!0),Iu(e,"useSkybox",!0),Iu(e,"forceUv1",!1),Iu(e,"pixelSnap",!1),Iu(e,"twoSidedLighting",!1),Iu(e,"nineSlicedMode",void 0),wu(e,"diffuse",0,3,"",!0),wu(e,"specular",0,3,"",!0),wu(e,"emissive",0,3,"",!0),wu(e,"normal",0,-1,"",!1),wu(e,"metalness",0,1,"",!0),wu(e,"gloss",0,1,"",!0),wu(e,"opacity",0,1,"a",!0),wu(e,"height",0,1,"",!1),wu(e,"ao",0,1,"",!0),wu(e,"light",1,3,"",!0),wu(e,"msdf",0,3,"",!1),wu(e,"diffuseDetail",0,3,"",!1,!0),wu(e,"normalDetail",0,-1,"",!1),Eu(e,"cubeMap"),Eu(e,"sphereMap"),Eu(e,"dpAtlas"),Eu(e,"prefilteredCubeMap128"),Eu(e,"prefilteredCubeMap64"),Eu(e,"prefilteredCubeMap32"),Eu(e,"prefilteredCubeMap16"),Eu(e,"prefilteredCubeMap8"),Eu(e,"prefilteredCubeMap4"),Cu(0,"diffuseTint","diffuseMapTint"),Cu(0,"specularTint","specularMapTint"),Cu(0,"emissiveTint","emissiveMapTint"),Cu(0,"aoVertexColor","aoMapVertexColor"),Cu(0,"diffuseVertexColor","diffuseMapVertexColor"),Cu(0,"specularVertexColor","specularMapVertexColor"),Cu(0,"emissiveVertexColor","emissiveMapVertexColor"),Cu(0,"metalnessVertexColor","metalnessMapVertexColor"),Cu(0,"glossVertexColor","glossMapVertexColor"),Cu(0,"opacityVertexColor","opacityMapVertexColor"),Cu(0,"lightVertexColor","lightMapVertexColor");for(var t=0;t<vu.length;t++)bu[t]=e[vu[t]];e._propsSet=[]}(Nn.prototype),kn.prototype.register=function(e,t){this.isRegistered(e)||(this._generators[e]=t)},kn.prototype.unregister=function(e){this.isRegistered(e)&&delete this._generators[e]},kn.prototype.isRegistered=function(e){return void 0!==this._generators[e]},kn.prototype.getProgram=function(e,t){var i=this._generators[e];if(void 0===i)return null;var s=this._device,n=i.generateKey(t),r=this._cache[n];if(!r){if(t.lights){var a=t.lights;t.lights=a.map(function(e){var t=e.clone?e.clone():e;return t.key=e.key,t})}this.storeNewProgram(e,t),t.lights&&(t.lights=a),this._precached&&console.warn("ProgramLibrary#getProgram: Cache miss for shader",e,"key",n,"after shaders precaching"),e=i.createShaderDefinition(s,t),r=this._cache[n]=new Y(s,e)}return r},kn.prototype.storeNewProgram=function(e,t){var i={};if("standard"===e){var s,n=this._getDefaultStdMatOptions(t.pass);for(s in t)(t.hasOwnProperty(s)&&n[s]!==t[s]||"pass"===s)&&(i[s]=t[s])}else i=t;this._programsCollection.push(JSON.stringify({name:e,options:i}))},kn.prototype.dumpPrograms=function(){var e="var device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\nvar shaders = [";this._programsCollection[0]&&(e+="\n\t"+this._programsCollection[0]);for(var t=1;t<this._programsCollection.length;++t)e+=",\n\t"+this._programsCollection[t];e+='\n];\ndevice.programLib.precompile(shaders);\nif (pc.version != "1.30.0" || pc.revision != "878f4ce")\n\tconsole.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");',(t=document.createElement("a")).setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),t.setAttribute("download","precompile-shaders.js"),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)},kn.prototype.clearCache=function(){var e=this._cache;for(var t in this._isClearingCache=!0,e)e.hasOwnProperty(t)&&e[t].destroy();this._cache={},this._isClearingCache=!1},kn.prototype.removeFromCache=function(e){if(!this._isClearingCache){var t,i=this._cache;for(t in i)if(i.hasOwnProperty(t)&&i[t]===e){delete i[t];break}}},kn.prototype._getDefaultStdMatOptions=function(e){return 1<e&&18>=e?this._defaultStdMatOptionMin:this._defaultStdMatOption},kn.prototype.precompile=function(e){if(e)for(var t=Array(e.length),i=0;i<e.length;i++){if("standard"===e[i].name){var s,n=e[i].options,r=this._getDefaultStdMatOptions(n.pass);for(s in r)r.hasOwnProperty(s)&&void 0===n[s]&&(n[s]=r[s]);n.useTexCubeLod=this._device.useTexCubeLod}t[i]=this.getProgram(e[i].name,e[i].options)}this._precached=!0},Object.assign(Un.prototype,{equals:function(e){return this.globalId===e.globalId&&this.revision===e.revision},notequals:function(e){return this.globalId!==e.globalId||this.revision!==e.revision},copy:function(e){this.globalId=e.globalId,this.revision=e.revision},reset:function(){this.revision=this.globalId=0}});var Ru=0;Object.assign(zn.prototype,{increment:function(){this.version.revision++}}),Object.assign(Vn.prototype,{setValue:function(e){this.value=e,this.versionObject.increment()},getValue:function(){return this.value}}),Object.assign(Gn.prototype,{resolve:function(e){return this.variables.hasOwnProperty(e)||(this.variables[e]=new Vn(e)),this.variables[e]},getSubSpace:function(e){return this.namespaces.hasOwnProperty(e)||(this.namespaces[e]=new Gn(e)),this.namespaces[e]}});var Du=function(e,t){var i=e.width,s=e.height;if(i>t||s>t){var n=t/Math.max(i,s),r=Math.floor(i*n);return n=Math.floor(s*n),console.warn("Image dimensions larger than max supported texture size of "+t+". Resizing from "+i+", "+s+" to "+r+", "+n+"."),(t=document.createElement("canvas")).width=r,t.height=n,t.getContext("2d").drawImage(e,0,0,i,s,0,0,r,n),t}return e},Lu=function(e,t){var i;r.call(this),this.canvas=e,this.indexBuffer=this.shader=null,this.vertexBuffers=[],this.vbOffsets=[],this._enableAutoInstancing=!1,this.autoInstancingMaxObjects=16384,this.attributesInvalidated=!0,this.boundElementBuffer=this.boundBuffer=this.defaultFramebuffer=null,this.instancedAttribs={},this.enabledAttributes={},this.activeFramebuffer=this.transformFeedbackBuffer=null,this.textureUnit=0,this.textureUnits=[],this._maxPixelRatio=1,this.feedback=this.renderTarget=null,this._tempEnableSafariTextureUnitWorkaround=!!window.safari,this._height=this._width=0,this.updateClientRect(),this.vertexShaderCache={},this.fragmentShaderCache={},this.shaders=[],this.buffers=[],this.textures=[],this.targets=[],this.contextLost=!1,this._contextLostHandler=function(e){e.preventDefault(),this.contextLost=!0,this.fire("devicelost")}.bind(this),this._contextRestoredHandler=function(){this.initializeContext(),this.contextLost=!1,this.fire("devicerestored")}.bind(this),e.addEventListener("webglcontextlost",this._contextLostHandler,!1),e.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1);var s,n,a,o,h,l=!t||void 0===t.preferWebGl2||t.preferWebGl2,c=l?["webgl2","experimental-webgl2","webgl","experimental-webgl"]:["webgl","experimental-webgl"],d=null;for((t=t||{}).stencil=!0,i=0;i<c.length;i++){try{d=e.getContext(c[i],t)}catch(e){}if(d){this.webgl2=l&&2>i;break}}if(!d)throw Error("WebGL not supported");for(this.gl=d,this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),i=0;i<this.maxCombinedTextures;i++)this.textureUnits.push([null,null,null]);for(var u in this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:3},this.glAddress=[d.REPEAT,d.CLAMP_TO_EDGE,d.MIRRORED_REPEAT],this.glBlendEquation=[d.FUNC_ADD,d.FUNC_SUBTRACT,d.FUNC_REVERSE_SUBTRACT,this.webgl2?d.MIN:this.extBlendMinmax?this.extBlendMinmax.MIN_EXT:d.FUNC_ADD,this.webgl2?d.MAX:this.extBlendMinmax?this.extBlendMinmax.MAX_EXT:d.FUNC_ADD],this.glBlendFunction=[d.ZERO,d.ONE,d.SRC_COLOR,d.ONE_MINUS_SRC_COLOR,d.DST_COLOR,d.ONE_MINUS_DST_COLOR,d.SRC_ALPHA,d.SRC_ALPHA_SATURATE,d.ONE_MINUS_SRC_ALPHA,d.DST_ALPHA,d.ONE_MINUS_DST_ALPHA],this.glComparison=[d.NEVER,d.LESS,d.EQUAL,d.LEQUAL,d.GREATER,d.NOTEQUAL,d.GEQUAL,d.ALWAYS],this.glStencilOp=[d.KEEP,d.ZERO,d.REPLACE,d.INCR,d.INCR_WRAP,d.DECR,d.DECR_WRAP,d.INVERT],this.glClearFlag=[0,d.COLOR_BUFFER_BIT,d.DEPTH_BUFFER_BIT,d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT,d.STENCIL_BUFFER_BIT,d.STENCIL_BUFFER_BIT|d.COLOR_BUFFER_BIT,d.STENCIL_BUFFER_BIT|d.DEPTH_BUFFER_BIT,d.STENCIL_BUFFER_BIT|d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT],this.glCull=[0,d.BACK,d.FRONT,d.FRONT_AND_BACK],this.glFilter=[d.NEAREST,d.LINEAR,d.NEAREST_MIPMAP_NEAREST,d.NEAREST_MIPMAP_LINEAR,d.LINEAR_MIPMAP_NEAREST,d.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[d.POINTS,d.LINES,d.LINE_LOOP,d.LINE_STRIP,d.TRIANGLES,d.TRIANGLE_STRIP,d.TRIANGLE_FAN],this.glType=[d.BYTE,d.UNSIGNED_BYTE,d.SHORT,d.UNSIGNED_SHORT,d.INT,d.UNSIGNED_INT,d.FLOAT],this.pcUniformType={},this.pcUniformType[d.BOOL]=0,this.pcUniformType[d.INT]=1,this.pcUniformType[d.FLOAT]=2,this.pcUniformType[d.FLOAT_VEC2]=3,this.pcUniformType[d.FLOAT_VEC3]=4,this.pcUniformType[d.FLOAT_VEC4]=5,this.pcUniformType[d.INT_VEC2]=6,this.pcUniformType[d.INT_VEC3]=7,this.pcUniformType[d.INT_VEC4]=8,this.pcUniformType[d.BOOL_VEC2]=9,this.pcUniformType[d.BOOL_VEC3]=10,this.pcUniformType[d.BOOL_VEC4]=11,this.pcUniformType[d.FLOAT_MAT2]=12,this.pcUniformType[d.FLOAT_MAT3]=13,this.pcUniformType[d.FLOAT_MAT4]=14,this.pcUniformType[d.SAMPLER_2D]=15,this.pcUniformType[d.SAMPLER_CUBE]=16,this.webgl2&&(this.pcUniformType[d.SAMPLER_2D_SHADOW]=18,this.pcUniformType[d.SAMPLER_CUBE_SHADOW]=19,this.pcUniformType[d.SAMPLER_3D]=20),this.targetToSlot={},this.targetToSlot[d.TEXTURE_2D]=0,this.targetToSlot[d.TEXTURE_CUBE_MAP]=1,this.targetToSlot[d.TEXTURE_3D]=2,this.commitFunction=[],this.commitFunction[0]=function(e,t){e.value!==t&&(d.uniform1i(e.locationId,t),e.value=t)},this.commitFunction[1]=this.commitFunction[0],this.commitFunction[2]=function(e,t){e.value!==t&&(d.uniform1f(e.locationId,t),e.value=t)},this.commitFunction[3]=function(e,t){h=e.value,s=t[0],n=t[1],h[0]===s&&h[1]===n||(d.uniform2fv(e.locationId,t),h[0]=s,h[1]=n)},this.commitFunction[4]=function(e,t){h=e.value,s=t[0],n=t[1],a=t[2],h[0]===s&&h[1]===n&&h[2]===a||(d.uniform3fv(e.locationId,t),h[0]=s,h[1]=n,h[2]=a)},this.commitFunction[5]=function(e,t){h=e.value,s=t[0],n=t[1],a=t[2],o=t[3],h[0]===s&&h[1]===n&&h[2]===a&&h[3]===o||(d.uniform4fv(e.locationId,t),h[0]=s,h[1]=n,h[2]=a,h[3]=o)},this.commitFunction[6]=function(e,t){h=e.value,s=t[0],n=t[1],h[0]===s&&h[1]===n||(d.uniform2iv(e.locationId,t),h[0]=s,h[1]=n)},this.commitFunction[9]=this.commitFunction[6],this.commitFunction[7]=function(e,t){h=e.value,s=t[0],n=t[1],a=t[2],h[0]===s&&h[1]===n&&h[2]===a||(d.uniform3iv(e.locationId,t),h[0]=s,h[1]=n,h[2]=a)},this.commitFunction[10]=this.commitFunction[7],this.commitFunction[8]=function(e,t){h=e.value,s=t[0],n=t[1],a=t[2],o=t[3],h[0]===s&&h[1]===n&&h[2]===a&&h[3]===o||(d.uniform4iv(e.locationId,t),h[0]=s,h[1]=n,h[2]=a,h[3]=o)},this.commitFunction[11]=this.commitFunction[8],this.commitFunction[12]=function(e,t){d.uniformMatrix2fv(e.locationId,!1,t)},this.commitFunction[13]=function(e,t){d.uniformMatrix3fv(e.locationId,!1,t)},this.commitFunction[14]=function(e,t){d.uniformMatrix4fv(e.locationId,!1,t)},this.commitFunction[17]=function(e,t){d.uniform1fv(e.locationId,t)},this.scope=new Gn("Device"),this.programLib=new kn(this),wa)this.programLib.register(u,wa[u]);for(this.supportsBoneTextures=this.extTextureFloat&&0<this.maxVertexTextures,this.useTexCubeLod=this.extTextureLod&&16>this.maxTextures,this.boneLimit=Math.floor((this.vertexUniformsCount-16-8-1-16)/4),this.boneLimit=Math.min(this.boneLimit,128),"Mali-450 MP"===this.unmaskedRenderer&&(this.boneLimit=34),this._shaderSwitchesPerFrame=this._drawCallsPerFrame=0,this._primsPerFrame=[],i=0;6>=i;i++)this._primsPerFrame[i]=0;this._renderTargetCreationTime=0,this._vram={tex:0,vb:0,ib:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.constantTexSource=this.scope.resolve("source"),this.textureFloatRenderable=!!this.extTextureFloat&&(this.webgl2?!!this.extColorBufferFloat:Wn(d,d.FLOAT)),this.textureHalfFloatRenderable=!!this.extTextureHalfFloat&&(this.webgl2?!!this.extColorBufferFloat:Wn(d,this.extTextureHalfFloat.HALF_FLOAT_OES)),this.supportsMorphTargetTexturesCore="highp"===this.maxPrecision&&2<=this.maxVertexTextures,this._textureHalfFloatUpdatable=this._textureFloatHighPrecision=void 0,this.createGrabPass(t.alpha),R.init(this)};Lu.prototype=Object.create(r.prototype),Lu.prototype.constructor=Lu,Object.assign(Lu.prototype,{getPrecision:function(){var e=this.gl,t="highp";if(e.getShaderPrecisionFormat){var i=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT),s=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT),n=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT);e=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT),s=0<s.precision&&0<e.precision,0<i.precision&&0<n.precision||(t=s?"mediump":"lowp")}return t},initializeExtensions:function(){var e=this.gl,t=e.getSupportedExtensions(),i=function(){for(var i=0;i<arguments.length;i++)if(-1!==t.indexOf(arguments[i]))return e.getExtension(arguments[i]);return null};if(this.webgl2)this.extVertexArrayObject=this.extUintElement=this.extTextureLod=this.extTextureHalfFloatLinear=this.extTextureHalfFloat=this.extTextureFloat=this.extStandardDerivatives=this.extInstancing=this.extDrawBuffers=this.extBlendMinmax=!0,this.extColorBufferFloat=i("EXT_color_buffer_float"),this.extDisjointTimerQuery=i("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query");else{if(this.extBlendMinmax=i("EXT_blend_minmax"),this.extDrawBuffers=i("EXT_draw_buffers"),this.extInstancing=i("ANGLE_instanced_arrays")){var s=this.extInstancing;e.drawArraysInstanced=s.drawArraysInstancedANGLE.bind(s),e.drawElementsInstanced=s.drawElementsInstancedANGLE.bind(s),e.vertexAttribDivisor=s.vertexAttribDivisorANGLE.bind(s)}this.extStandardDerivatives=i("OES_standard_derivatives"),this.extTextureFloat=i("OES_texture_float"),this.extTextureHalfFloat=i("OES_texture_half_float"),this.extTextureHalfFloatLinear=i("OES_texture_half_float_linear"),this.extTextureLod=i("EXT_shader_texture_lod"),this.extUintElement=i("OES_element_index_uint"),(this.extVertexArrayObject=i("OES_vertex_array_object"))&&(s=this.extVertexArrayObject,e.createVertexArray=s.createVertexArrayOES.bind(s),e.deleteVertexArray=s.deleteVertexArrayOES.bind(s),e.isVertexArray=s.isVertexArrayOES.bind(s),e.bindVertexArray=s.bindVertexArrayOES.bind(s)),this.extDisjointTimerQuery=this.extColorBufferFloat=null}this.extDebugRendererInfo=i("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=i("OES_texture_float_linear"),this.extFloatBlend=i("EXT_float_blend"),this.extTextureFilterAnisotropic=i("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extCompressedTextureETC1=i("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=i("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=i("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=i("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureATC=i("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=i("WEBGL_compressed_texture_astc"),this.extParallelShaderCompile=i("KHR_parallel_shader_compile"),this.supportsInstancing=!!this.extInstancing},initializeCapabilities:function(){var e=this.gl;this.maxPrecision=this.precision=this.getPrecision();var t=e.getContextAttributes();this.supportsMsaa=t.antialias,this.supportsStencil=t.stencil,this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxCubeMapSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=e.getParameter(e.MAX_RENDERBUFFER_SIZE),this.maxTextures=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this.webgl2?(this.maxDrawBuffers=e.getParameter(e.MAX_DRAW_BUFFERS),this.maxColorAttachments=e.getParameter(e.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=e.getParameter(e.MAX_3D_TEXTURE_SIZE)):(this.maxDrawBuffers=(t=this.extDrawBuffers)?e.getParameter(t.MAX_DRAW_BUFFERS_EXT):1,this.maxColorAttachments=t?e.getParameter(t.MAX_COLOR_ATTACHMENTS_EXT):1,this.maxVolumeSize=1),this.unmaskedRenderer=(t=this.extDebugRendererInfo)?e.getParameter(t.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=t?e.getParameter(t.UNMASKED_VENDOR_WEBGL):"",this.maxAnisotropy=(t=this.extTextureFilterAnisotropic)?e.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1,this.samples=e.getParameter(e.SAMPLES)},initializeRenderState:function(){var e=this.gl;this.blending=!1,e.disable(e.BLEND),this.blendSrc=1,this.blendDst=0,this.blendSrcAlpha=1,this.blendDstAlpha=0,this.separateAlphaBlend=!1,this.blendAlphaEquation=this.blendEquation=0,this.separateAlphaEquation=!1,e.blendFunc(e.ONE,e.ZERO),e.blendEquation(e.FUNC_ADD),this.writeAlpha=this.writeBlue=this.writeGreen=this.writeRed=!0,e.colorMask(!0,!0,!0,!0),this.cullMode=1,e.enable(e.CULL_FACE),e.cullFace(e.BACK),this.depthTest=!0,e.enable(e.DEPTH_TEST),this.depthFunc=3,e.depthFunc(e.LEQUAL),this.depthWrite=!0,e.depthMask(!0),this.stencil=!1,e.disable(e.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=7,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,e.stencilFunc(e.ALWAYS,0,255),this.stencilZpassFront=this.stencilZpassBack=this.stencilZfailFront=this.stencilZfailBack=this.stencilFailFront=this.stencilFailBack=0,this.stencilWriteMaskBack=this.stencilWriteMaskFront=255,e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,this.webgl2&&(e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.RASTERIZER_DISCARD)),this.depthBiasEnabled=!1,e.disable(e.POLYGON_OFFSET_FILL),this.clearDepth=1,e.clearDepth(1),this.clearAlpha=this.clearGreen=this.clearBlue=this.clearRed=0,e.clearColor(0,0,0,0),this.clearStencil=0,e.clearStencil(0),this.sx=this.sy=this.sw=this.sh=this.vx=this.vy=this.vw=this.vh=0,this.webgl2?e.hint(e.FRAGMENT_SHADER_DERIVATIVE_HINT,e.NICEST):this.extStandardDerivatives&&e.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,e.NICEST),e.enable(e.SCISSOR_TEST),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE),this.unpackFlipY=!1,e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1)},initializeContext:function(){var e;this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState();var t=0;for(e=this.shaders.length;t<e;t++)this.compileAndLinkShader(this.shaders[t]);for(this.shader=null,t=0,e=this.buffers.length;t<e;t++)this.buffers[t].bufferId=void 0,this.buffers[t].unlock();for(this.indexBuffer=this.boundElementBuffer=this.boundBuffer=null,this.attributesInvalidated=!0,this.enabledAttributes={},this.vertexBuffers=[],t=0,e=this.textures.length;t<e;t++){var i=this.textures[t];this.destroyTexture(i),i.dirtyAll()}for(this.textureUnit=0,t=this.textureUnits.length=0;t<this.maxCombinedTextures;t++)this.textureUnits.push([null,null,null]);for(t=0,e=this.targets.length;t<e;t++)this.targets[t]._glFrameBuffer=void 0,this.targets[t]._glDepthBuffer=void 0,this.targets[t]._glResolveFrameBuffer=void 0,this.targets[t]._glMsaaColorBuffer=void 0,this.targets[t]._glMsaaDepthBuffer=void 0;this.transformFeedbackBuffer=this.feedback=this.activeFramebuffer=this.renderTarget=null},createGrabPass:function(e){if(!this.grabPassTexture){(e=new K(this,{format:e?7:6,minFilter:1,magFilter:1,addressU:1,addressV:1,mipmaps:!1})).name="texture_grabPass";var t=this.scope.resolve(e.name);t.setValue(e),this.grabPassRenderTarget=new Bu({colorBuffer:e,depth:!1}),this.grabPassTextureId=t,this.grabPassTexture=e}},updateGrabPass:function(){var e=this.gl,t=this.renderTarget,i=t&&t._glResolveFrameBuffer,s=this.grabPassTexture,n=this.width,r=this.height;this.webgl2&&n===s._width&&r===s._height?(i&&t.resolve(!0),i=t?t._glFrameBuffer:null,t=t?t._glResolveFrameBuffer||t._glFrameBuffer:null,this.initRenderTarget(this.grabPassRenderTarget),s=this.grabPassRenderTarget._glFrameBuffer,e.bindFramebuffer(e.READ_FRAMEBUFFER,t),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,s),e.blitFramebuffer(0,0,n,r,0,0,n,r,e.COLOR_BUFFER_BIT,e.NEAREST),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,i)):(i&&(t.resolve(!0),e.bindFramebuffer(e.FRAMEBUFFER,t._glResolveFrameBuffer)),e.copyTexImage2D(e.TEXTURE_2D,0,s._glFormat,0,0,n,r,0),s._width=n,s._height=r,i&&e.bindFramebuffer(e.FRAMEBUFFER,t._glFrameBuffer))},destroyGrabPass:function(){this.grabPassRenderTarget.destroy(),this.grabPassTextureId=this.grabPassRenderTarget=null,this.grabPassTexture.destroy(),this.grabPassTexture=null},updateClientRect:function(){this.clientRect=this.canvas.getBoundingClientRect()},setViewport:function(e,t,i,s){this.vx===e&&this.vy===t&&this.vw===i&&this.vh===s||(this.gl.viewport(e,t,i,s),this.vx=e,this.vy=t,this.vw=i,this.vh=s)},setScissor:function(e,t,i,s){this.sx===e&&this.sy===t&&this.sw===i&&this.sh===s||(this.gl.scissor(e,t,i,s),this.sx=e,this.sy=t,this.sw=i,this.sh=s)},getProgramLibrary:function(){return this.programLib},setProgramLibrary:function(e){this.programLib=e},setFramebuffer:function(e){this.activeFramebuffer!==e&&(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,e),this.activeFramebuffer=e)},_checkFbo:function(){var e=this.gl;switch(e.checkFramebufferStatus(e.FRAMEBUFFER)){case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case e.FRAMEBUFFER_UNSUPPORTED:console.error("ERROR: FRAMEBUFFER_UNSUPPORTED")}},copyRenderTarget:function(e,t,i,s){var n=this.gl;if(!this.webgl2&&s)return!1;if(i)if(t){if(!e._colorBuffer||!t._colorBuffer||e._colorBuffer._format!==t._colorBuffer._format)return!1}else if(!e._colorBuffer)return!1;if(s&&(!e._depthBuffer||!t._depthBuffer||e._depthBuffer._format!==t._depthBuffer._format))return!1;if(this.webgl2&&t){var r=this.renderTarget;this.renderTarget=t,this.updateBegin(),n.bindFramebuffer(n.READ_FRAMEBUFFER,e?e._glFrameBuffer:null),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,t._glFrameBuffer);var a=e?e.width:t.width;e=e?e.height:t.height,n.blitFramebuffer(0,0,a,e,0,0,a,e,(i?n.COLOR_BUFFER_BIT:0)|(s?n.DEPTH_BUFFER_BIT:0),n.NEAREST),this.renderTarget=r,n.bindFramebuffer(n.FRAMEBUFFER,r?r._glFrameBuffer:null)}else i=this.getCopyShader(),this.constantTexSource.setValue(e._colorBuffer),q(this,t,i);return!0},initRenderTarget:function(e){if(!e._glFrameBuffer){e._device=this;var t=this.gl;e._glFrameBuffer=t.createFramebuffer(),this.setFramebuffer(e._glFrameBuffer);var i=e._colorBuffer;i&&(i._glTexture||(i._width=Math.min(i.width,this.maxRenderBufferSize),i._height=Math.min(i.height,this.maxRenderBufferSize),this.setTexture(i,0)),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,i._cubemap?t.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:t.TEXTURE_2D,i._glTexture,0));var s=e._depthBuffer;s&&this.webgl2?(s._glTexture||(s._width=Math.min(s.width,this.maxRenderBufferSize),s._height=Math.min(s.height,this.maxRenderBufferSize),this.setTexture(s,0)),e._stencil?t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,s._cubemap?t.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:t.TEXTURE_2D,e._depthBuffer._glTexture,0):t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,s._cubemap?t.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:t.TEXTURE_2D,e._depthBuffer._glTexture,0)):!e._depth||1<e._samples&&this.webgl2||(e._glDepthBuffer||(e._glDepthBuffer=t.createRenderbuffer()),t.bindRenderbuffer(t.RENDERBUFFER,e._glDepthBuffer),e._stencil?(t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_STENCIL,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,e._glDepthBuffer)):(t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,e._glDepthBuffer)),t.bindRenderbuffer(t.RENDERBUFFER,null)),this.webgl2&&1<e._samples&&(e._glResolveFrameBuffer=e._glFrameBuffer,e._glFrameBuffer=t.createFramebuffer(),this.setFramebuffer(e._glFrameBuffer),i&&(e._glMsaaColorBuffer||(e._glMsaaColorBuffer=t.createRenderbuffer()),t.bindRenderbuffer(t.RENDERBUFFER,e._glMsaaColorBuffer),t.renderbufferStorageMultisample(t.RENDERBUFFER,e._samples,i._glInternalFormat,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,e._glMsaaColorBuffer)),e._depth&&(e._glMsaaDepthBuffer||(e._glMsaaDepthBuffer=t.createRenderbuffer()),t.bindRenderbuffer(t.RENDERBUFFER,e._glMsaaDepthBuffer),e._stencil?(t.renderbufferStorageMultisample(t.RENDERBUFFER,e._samples,t.DEPTH24_STENCIL8,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,e._glMsaaDepthBuffer)):(t.renderbufferStorageMultisample(t.RENDERBUFFER,e._samples,t.DEPTH_COMPONENT32F,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,e._glMsaaDepthBuffer)))),this.targets.push(e)}},getCopyShader:function(){if(!this._copyShader){var e=Ma;this._copyShader=e.createShaderFromCode(this,e.fullscreenQuadVS,e.outputTex2DPS,"outputTex2D")}return this._copyShader},updateBegin:function(){if(this.boundElementBuffer=this.boundBuffer=null,this._tempEnableSafariTextureUnitWorkaround)for(var e=0;e<this.textureUnits.length;++e)for(var t=0;3>t;++t)this.textureUnits[e][t]=null;(e=this.renderTarget)?e._glFrameBuffer?this.setFramebuffer(e._glFrameBuffer):this.initRenderTarget(e):this.setFramebuffer(this.defaultFramebuffer)},updateEnd:function(){var e=this.gl,t=this.renderTarget;if(t){var i=t._colorBuffer;i&&i._glTexture&&i.mipmaps&&i.pot&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(i),e.generateMipmap(i._glTarget)),this.webgl2&&1<t._samples&&t.autoResolve&&t.resolve()}},initializeTexture:function(e){var t=this.gl;switch(e._glTexture=t.createTexture(),e._glTarget=e._cubemap?t.TEXTURE_CUBE_MAP:e._volume?t.TEXTURE_3D:t.TEXTURE_2D,e._format){case 0:e._glFormat=t.ALPHA,e._glInternalFormat=t.ALPHA,e._glPixelType=t.UNSIGNED_BYTE;break;case 1:e._glFormat=t.LUMINANCE,e._glInternalFormat=t.LUMINANCE,e._glPixelType=t.UNSIGNED_BYTE;break;case 2:e._glFormat=t.LUMINANCE_ALPHA,e._glInternalFormat=t.LUMINANCE_ALPHA,e._glPixelType=t.UNSIGNED_BYTE;break;case 3:e._glFormat=t.RGB,e._glInternalFormat=t.RGB,e._glPixelType=t.UNSIGNED_SHORT_5_6_5;break;case 4:e._glFormat=t.RGBA,e._glInternalFormat=t.RGBA,e._glPixelType=t.UNSIGNED_SHORT_5_5_5_1;break;case 5:e._glFormat=t.RGBA,e._glInternalFormat=t.RGBA,e._glPixelType=t.UNSIGNED_SHORT_4_4_4_4;break;case 6:e._glFormat=t.RGB,e._glInternalFormat=this.webgl2?t.RGB8:t.RGB,e._glPixelType=t.UNSIGNED_BYTE;break;case 7:e._glFormat=t.RGBA,e._glInternalFormat=this.webgl2?t.RGBA8:t.RGBA,e._glPixelType=t.UNSIGNED_BYTE;break;case 8:var i=this.extCompressedTextureS3TC;e._glFormat=t.RGB,e._glInternalFormat=i.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case 9:i=this.extCompressedTextureS3TC,e._glFormat=t.RGBA,e._glInternalFormat=i.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case 10:i=this.extCompressedTextureS3TC,e._glFormat=t.RGBA,e._glInternalFormat=i.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case 21:i=this.extCompressedTextureETC1,e._glFormat=t.RGB,e._glInternalFormat=i.COMPRESSED_RGB_ETC1_WEBGL;break;case 24:i=this.extCompressedTexturePVRTC,e._glFormat=t.RGB,e._glInternalFormat=i.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case 25:i=this.extCompressedTexturePVRTC,e._glFormat=t.RGBA,e._glInternalFormat=i.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case 26:i=this.extCompressedTexturePVRTC,e._glFormat=t.RGB,e._glInternalFormat=i.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case 27:i=this.extCompressedTexturePVRTC,e._glFormat=t.RGBA,e._glInternalFormat=i.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case 22:i=this.extCompressedTextureETC,e._glFormat=t.RGB,e._glInternalFormat=i.COMPRESSED_RGB8_ETC2;break;case 23:i=this.extCompressedTextureETC,e._glFormat=t.RGBA,e._glInternalFormat=i.COMPRESSED_RGBA8_ETC2_EAC;break;case 28:i=this.extCompressedTextureASTC,e._glFormat=t.RGBA,e._glInternalFormat=i.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case 29:i=this.extCompressedTextureATC,e._glFormat=t.RGB,e._glInternalFormat=i.COMPRESSED_RGB_ATC_WEBGL;break;case 30:i=this.extCompressedTextureATC,e._glFormat=t.RGBA,e._glInternalFormat=i.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case 11:i=this.extTextureHalfFloat,e._glFormat=t.RGB,this.webgl2?(e._glInternalFormat=t.RGB16F,e._glPixelType=t.HALF_FLOAT):(e._glInternalFormat=t.RGB,e._glPixelType=i.HALF_FLOAT_OES);break;case 12:i=this.extTextureHalfFloat,e._glFormat=t.RGBA,this.webgl2?(e._glInternalFormat=t.RGBA16F,e._glPixelType=t.HALF_FLOAT):(e._glInternalFormat=t.RGBA,e._glPixelType=i.HALF_FLOAT_OES);break;case 13:e._glFormat=t.RGB,e._glInternalFormat=this.webgl2?t.RGB32F:t.RGB,e._glPixelType=t.FLOAT;break;case 14:e._glFormat=t.RGBA,e._glInternalFormat=this.webgl2?t.RGBA32F:t.RGBA,e._glPixelType=t.FLOAT;break;case 15:e._glFormat=t.RED,e._glInternalFormat=t.R32F,e._glPixelType=t.FLOAT;break;case 16:this.webgl2?(e._glFormat=t.DEPTH_COMPONENT,e._glInternalFormat=t.DEPTH_COMPONENT32F,e._glPixelType=t.FLOAT):(e._glFormat=t.DEPTH_COMPONENT,e._glInternalFormat=t.DEPTH_COMPONENT,e._glPixelType=t.UNSIGNED_SHORT);break;case 17:e._glFormat=t.DEPTH_STENCIL,e._glInternalFormat=t.DEPTH24_STENCIL8,e._glPixelType=t.UNSIGNED_INT_24_8;break;case 18:e._glFormat=t.RGB,e._glInternalFormat=t.R11F_G11F_B10F,e._glPixelType=t.FLOAT;break;case 19:e._glFormat=t.RGB,e._glInternalFormat=t.SRGB8,e._glPixelType=t.UNSIGNED_BYTE;break;case 20:e._glFormat=t.RGBA,e._glInternalFormat=t.SRGB8_ALPHA8,e._glPixelType=t.UNSIGNED_BYTE}this.textures.push(e)},destroyTexture:function(e){if(e._glTexture){var t=this.textures.indexOf(e);for(var i in-1!==t&&this.textures.splice(t,1),this.scope.variables)(t=this.scope.variables[i]).value===e&&(t.value=null);for(i=0;i<this.textureUnits.length;i++){t=this.textureUnits[i];for(var s=0;s<t.length;s++)t[s]===e._glTexture&&(t[s]=null)}this.gl.deleteTexture(e._glTexture),delete e._glTexture,delete e._glTarget,delete e._glFormat,delete e._glInternalFormat,delete e._glPixelType,this._vram.tex-=e._gpuSize}},setUnpackFlipY:function(e){if(this.unpackFlipY!==e){this.unpackFlipY=e;var t=this.gl;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e)}},setUnpackPremultiplyAlpha:function(e){if(this.unpackPremultiplyAlpha!==e){this.unpackPremultiplyAlpha=e;var t=this.gl;t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e)}},uploadTexture:function(e){var t=this.gl;if(e._needsUpload||!(e._needsMipmapsUpload&&e._mipmapsUploaded||!e.pot)){for(var i,s,n=0,r=Math.log2(Math.max(e._width,e._height))+1;e._levels[n]||0===n;){if(e._needsUpload||0!==n){if(n&&(!e._needsMipmapsUpload||!e._mipmaps))break;var a;if(i=e._levels[n],1==n&&!e._compressed&&e._levels.length<r&&(t.generateMipmap(e._glTarget),e._mipmapsUploaded=!0),e._cubemap){if(i[0]instanceof HTMLCanvasElement||i[0]instanceof HTMLImageElement||i[0]instanceof HTMLVideoElement)for(a=0;6>a;a++)e._levelsUpdated[0][a]&&((s=i[a])instanceof HTMLImageElement&&(s.width>this.maxCubeMapSize||s.height>this.maxCubeMapSize)&&(s=Du(s,this.maxCubeMapSize),0===n&&(e._width=s.width,e._height=s.height)),this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(e._premultiplyAlpha),t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+a,n,e._glInternalFormat,e._glFormat,e._glPixelType,s));else for(s=1/Math.pow(2,n),a=0;6>a;a++)if(e._levelsUpdated[0][a]){var o=i[a];e._compressed?t.compressedTexImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+a,n,e._glInternalFormat,Math.max(e._width*s,1),Math.max(e._height*s,1),0,o):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(e._premultiplyAlpha),t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+a,n,e._glInternalFormat,Math.max(e._width*s,1),Math.max(e._height*s,1),0,e._glFormat,e._glPixelType,o))}}else e._volume?(s=1/Math.pow(2,n),e._compressed?t.compressedTexImage3D(t.TEXTURE_3D,n,e._glInternalFormat,Math.max(e._width*s,1),Math.max(e._height*s,1),Math.max(e._depth*s,1),0,i):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(e._premultiplyAlpha),t.texImage3D(t.TEXTURE_3D,n,e._glInternalFormat,Math.max(e._width*s,1),Math.max(e._height*s,1),Math.max(e._depth*s,1),0,e._glFormat,e._glPixelType,i))):(i instanceof HTMLCanvasElement||i instanceof HTMLImageElement||i instanceof HTMLVideoElement?(i instanceof HTMLImageElement&&(i.width>this.maxTextureSize||i.height>this.maxTextureSize)&&(i=Du(i,this.maxTextureSize),0===n&&(e._width=i.width,e._height=i.height)),this.setUnpackFlipY(e._flipY),this.setUnpackPremultiplyAlpha(e._premultiplyAlpha),t.texImage2D(t.TEXTURE_2D,n,e._glInternalFormat,e._glFormat,e._glPixelType,i)):(s=1/Math.pow(2,n),e._compressed?t.compressedTexImage2D(t.TEXTURE_2D,n,e._glInternalFormat,Math.max(e._width*s,1),Math.max(e._height*s,1),0,i):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(e._premultiplyAlpha),t.texImage2D(t.TEXTURE_2D,n,e._glInternalFormat,Math.max(e._width*s,1),Math.max(e._height*s,1),0,e._glFormat,e._glPixelType,i))),e._mipmapsUploaded=0!==n)}n++}if(e._needsUpload)if(e._cubemap)for(n=0;6>n;n++)e._levelsUpdated[0][n]=!1;else e._levelsUpdated[0]=!1;!e._compressed&&e._mipmaps&&e._needsMipmapsUpload&&e.pot&&1===e._levels.length&&(t.generateMipmap(e._glTarget),e._mipmapsUploaded=!0),e._gpuSize&&(this._vram.tex-=e._gpuSize),e._gpuSize=e.gpuSize,this._vram.tex+=e._gpuSize}},activeTexture:function(e){this.textureUnit!==e&&(this.gl.activeTexture(this.gl.TEXTURE0+e),this.textureUnit=e)},bindTexture:function(e){var t=e._glTarget;e=e._glTexture;var i=this.textureUnit,s=this.targetToSlot[t];this.textureUnits[i][s]!==e&&(this.gl.bindTexture(t,e),this.textureUnits[i][s]=e)},bindTextureOnUnit:function(e,t){var i=e._glTarget;e=e._glTexture;var s=this.targetToSlot[i];this.textureUnits[t][s]!==e&&(this.activeTexture(t),this.gl.bindTexture(i,e),this.textureUnits[t][s]=e)},setTextureParameters:function(e){var t=this.gl,i=e._parameterFlags,s=e._glTarget;if(1&i){var n=e._minFilter;(!e.pot||!e._mipmaps||e._compressed&&1===e._levels.length)&&(2===n||3===n?n=0:4!==n&&5!==n||(n=1)),t.texParameteri(s,t.TEXTURE_MIN_FILTER,this.glFilter[n])}2&i&&t.texParameteri(s,t.TEXTURE_MAG_FILTER,this.glFilter[e._magFilter]),4&i&&(this.webgl2?t.texParameteri(s,t.TEXTURE_WRAP_S,this.glAddress[e._addressU]):t.texParameteri(s,t.TEXTURE_WRAP_S,this.glAddress[e.pot?e._addressU:1])),8&i&&(this.webgl2?t.texParameteri(s,t.TEXTURE_WRAP_T,this.glAddress[e._addressV]):t.texParameteri(s,t.TEXTURE_WRAP_T,this.glAddress[e.pot?e._addressV:1])),16&i&&this.webgl2&&t.texParameteri(s,t.TEXTURE_WRAP_R,this.glAddress[e._addressW]),32&i&&this.webgl2&&t.texParameteri(s,t.TEXTURE_COMPARE_MODE,e._compareOnRead?t.COMPARE_REF_TO_TEXTURE:t.NONE),64&i&&this.webgl2&&t.texParameteri(s,t.TEXTURE_COMPARE_FUNC,this.glComparison[e._compareFunc]),128&i&&(i=this.extTextureFilterAnisotropic)&&t.texParameterf(s,i.TEXTURE_MAX_ANISOTROPY_EXT,Math.max(1,Math.min(Math.round(e._anisotropy),this.maxAnisotropy)))},setTexture:function(e,t){e._glTexture||this.initializeTexture(e),0<e._parameterFlags||e._needsUpload||e._needsMipmapsUpload||e===this.grabPassTexture?(this.activeTexture(t),this.bindTexture(e),e._parameterFlags&&(this.setTextureParameters(e),e._parameterFlags=0),e===this.grabPassTexture?this.updateGrabPass():(e._needsUpload||e._needsMipmapsUpload)&&(this.uploadTexture(e),e._needsUpload=!1,e._needsMipmapsUpload=!1)):this.bindTextureOnUnit(e,t)},setBuffers:function(e){var t,i=this.gl,s=this.shader.attributes;if(this.attributesInvalidated){for(var n=0,r=s.length;n<r;n++){var a=s[n],o=a.scopeId.value;if(null!==o){if(t=this.vertexBuffers[o.stream]){var h=this.vbOffsets[o.stream]||0;t=t.bufferId,this.boundBuffer!==t&&(i.bindBuffer(i.ARRAY_BUFFER,t),this.boundBuffer=t),a=a.locationId,this.enabledAttributes[a]||(i.enableVertexAttribArray(a),this.enabledAttributes[a]=!0),i.vertexAttribPointer(a,o.numComponents,this.glType[o.dataType],o.normalize,o.stride,o.offset+h),1===o.stream&&0<e?this.instancedAttribs[a]||(i.vertexAttribDivisor(a,1),this.instancedAttribs[a]=!0):this.instancedAttribs[a]&&(i.vertexAttribDivisor(a,0),this.instancedAttribs[a]=!1)}}else this.enabledAttributes[a.locationId]&&(i.disableVertexAttribArray(a.locationId),this.enabledAttributes[a.locationId]=!1)}this.attributesInvalidated=!1}t=this.indexBuffer?this.indexBuffer.bufferId:null,this.boundElementBuffer!==t&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t),this.boundElementBuffer=t)},draw:function(e,t){var i,s,n,r=this.gl,a=this.shader,o=a.samplers,h=a.uniforms;0<t&&(this.boundBuffer=null,this.attributesInvalidated=!0),this.setBuffers(t);var l=0;for(a=0,s=o.length;a<s;a++){var c=o[a];if(n=c.scopeId.value)if(n instanceof K){var d=n;this.setTexture(d,l),c.slot!==l&&(r.uniform1i(c.locationId,l),c.slot=l),l++}else{c.array.length=0;var u=n.length;for(i=0;i<u;i++)d=n[i],this.setTexture(d,l),c.array[i]=l,l++;r.uniform1iv(c.locationId,c.array)}}for(a=0,s=h.length;a<s;a++)i=(o=h[a]).scopeId,c=o.version,n=i.versionObject.version,(c.globalId!==n.globalId||c.revision!==n.revision)&&(c.globalId=n.globalId,c.revision=n.revision,null!==i.value&&this.commitFunction[o.dataType](o,i.value));this.webgl2&&this.transformFeedbackBuffer&&(r.bindBufferBase(r.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.bufferId),r.beginTransformFeedback(r.POINTS)),a=this.glPrimitive[e.type],s=e.count,e.indexed?(h=(o=this.indexBuffer).glFormat,e=e.base*o.bytesPerIndex,0<t?r.drawElementsInstanced(a,s,h,e,t):r.drawElements(a,s,h,e)):(e=e.base,0<t?r.drawArraysInstanced(a,e,s,t):r.drawArrays(a,e,s)),this.webgl2&&this.transformFeedbackBuffer&&(r.endTransformFeedback(),r.bindBufferBase(r.TRANSFORM_FEEDBACK_BUFFER,0,null))},clear:function(e){var t=this.defaultClearOptions,i=null==(e=e||t).flags?t.flags:e.flags;if(0!==i){var s=this.gl;if(1&i){var n=null==e.color?t.color:e.color;this.setClearColor(n[0],n[1],n[2],n[3])}2&i&&(this.setClearDepth(null==e.depth?t.depth:e.depth),this.depthWrite||s.depthMask(!0)),4&i&&this.setClearStencil(null==e.stencil?t.stencil:e.stencil),s.clear(this.glClearFlag[i]),2&i&&(this.depthWrite||s.depthMask(!1))}},readPixels:function(e,t,i,s,n){var r=this.gl;r.readPixels(e,t,i,s,r.RGBA,r.UNSIGNED_BYTE,n)},setClearDepth:function(e){e!==this.clearDepth&&(this.gl.clearDepth(e),this.clearDepth=e)},setClearColor:function(e,t,i,s){e===this.clearRed&&t===this.clearGreen&&i===this.clearBlue&&s===this.clearAlpha||(this.gl.clearColor(e,t,i,s),this.clearRed=e,this.clearGreen=t,this.clearBlue=i,this.clearAlpha=s)},setClearStencil:function(e){e!==this.clearStencil&&(this.gl.clearStencil(e),this.clearStencil=e)},setRenderTarget:function(e){this.renderTarget=e},getRenderTarget:function(){return this.renderTarget},getDepthTest:function(){return this.depthTest},setDepthTest:function(e){if(this.depthTest!==e){var t=this.gl;e?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST),this.depthTest=e}},setDepthFunc:function(e){this.depthFunc!==e&&(this.gl.depthFunc(this.glComparison[e]),this.depthFunc=e)},getDepthWrite:function(){return this.depthWrite},setDepthWrite:function(e){this.depthWrite!==e&&(this.gl.depthMask(e),this.depthWrite=e)},setColorWrite:function(e,t,i,s){this.writeRed===e&&this.writeGreen===t&&this.writeBlue===i&&this.writeAlpha===s||(this.gl.colorMask(e,t,i,s),this.writeRed=e,this.writeGreen=t,this.writeBlue=i,this.writeAlpha=s)},setAlphaToCoverage:function(e){this.webgl2&&this.alphaToCoverage!==e&&((this.alphaToCoverage=e)?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))},setTransformFeedbackBuffer:function(e){if(this.transformFeedbackBuffer!==e&&(this.transformFeedbackBuffer=e,this.webgl2)){var t=this.gl;e?(this.feedback||(this.feedback=t.createTransformFeedback()),t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,this.feedback)):t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,null)}},setRaster:function(e){this.raster!==e&&(this.raster=e,this.webgl2&&(e?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD)))},setDepthBias:function(e){this.depthBiasEnabled!==e&&((this.depthBiasEnabled=e)?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL))},setDepthBiasValues:function(e,t){this.gl.polygonOffset(t,e)},getBlending:function(){return this.blending},setBlending:function(e){if(this.blending!==e){var t=this.gl;e?t.enable(t.BLEND):t.disable(t.BLEND),this.blending=e}},setStencilTest:function(e){if(this.stencil!==e){var t=this.gl;e?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this.stencil=e}},setStencilFunc:function(e,t,i){this.stencilFuncFront===e&&this.stencilRefFront===t&&this.stencilMaskFront===i&&this.stencilFuncBack===e&&this.stencilRefBack===t&&this.stencilMaskBack===i||(this.gl.stencilFunc(this.glComparison[e],t,i),this.stencilFuncFront=this.stencilFuncBack=e,this.stencilRefFront=this.stencilRefBack=t,this.stencilMaskFront=this.stencilMaskBack=i)},setStencilFuncFront:function(e,t,i){if(this.stencilFuncFront!==e||this.stencilRefFront!==t||this.stencilMaskFront!==i){var s=this.gl;s.stencilFuncSeparate(s.FRONT,this.glComparison[e],t,i),this.stencilFuncFront=e,this.stencilRefFront=t,this.stencilMaskFront=i}},setStencilFuncBack:function(e,t,i){if(this.stencilFuncBack!==e||this.stencilRefBack!==t||this.stencilMaskBack!==i){var s=this.gl;s.stencilFuncSeparate(s.BACK,this.glComparison[e],t,i),this.stencilFuncBack=e,this.stencilRefBack=t,this.stencilMaskBack=i}},setStencilOperation:function(e,t,i,s){this.stencilFailFront===e&&this.stencilZfailFront===t&&this.stencilZpassFront===i&&this.stencilFailBack===e&&this.stencilZfailBack===t&&this.stencilZpassBack===i||(this.gl.stencilOp(this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[i]),this.stencilFailFront=this.stencilFailBack=e,this.stencilZfailFront=this.stencilZfailBack=t,this.stencilZpassFront=this.stencilZpassBack=i),this.stencilWriteMaskFront===s&&this.stencilWriteMaskBack===s||(this.gl.stencilMask(s),this.stencilWriteMaskBack=this.stencilWriteMaskFront=s)},setStencilOperationFront:function(e,t,i,s){this.stencilFailFront===e&&this.stencilZfailFront===t&&this.stencilZpassFront===i||(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[i]),this.stencilFailFront=e,this.stencilZfailFront=t,this.stencilZpassFront=i),this.stencilWriteMaskFront!==s&&(this.gl.stencilMaskSeparate(this.gl.FRONT,s),this.stencilWriteMaskFront=s)},setStencilOperationBack:function(e,t,i,s){this.stencilFailBack===e&&this.stencilZfailBack===t&&this.stencilZpassBack===i||(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[i]),this.stencilFailBack=e,this.stencilZfailBack=t,this.stencilZpassBack=i),this.stencilWriteMaskBack!==s&&(this.gl.stencilMaskSeparate(this.gl.BACK,s),this.stencilWriteMaskBack=s)},setBlendFunction:function(e,t){(this.blendSrc!==e||this.blendDst!==t||this.separateAlphaBlend)&&(this.gl.blendFunc(this.glBlendFunction[e],this.glBlendFunction[t]),this.blendSrc=e,this.blendDst=t,this.separateAlphaBlend=!1)},setBlendFunctionSeparate:function(e,t,i,s){this.blendSrc===e&&this.blendDst===t&&this.blendSrcAlpha===i&&this.blendDstAlpha===s&&this.separateAlphaBlend||(this.gl.blendFuncSeparate(this.glBlendFunction[e],this.glBlendFunction[t],this.glBlendFunction[i],this.glBlendFunction[s]),this.blendSrc=e,this.blendDst=t,this.blendSrcAlpha=i,this.blendDstAlpha=s,this.separateAlphaBlend=!0)},setBlendEquation:function(e){(this.blendEquation!==e||this.separateAlphaEquation)&&(this.gl.blendEquation(this.glBlendEquation[e]),this.blendEquation=e,this.separateAlphaEquation=!1)},setBlendEquationSeparate:function(e,t){this.blendEquation===e&&this.blendAlphaEquation===t&&this.separateAlphaEquation||(this.gl.blendEquationSeparate(this.glBlendEquation[e],this.glBlendEquation[t]),this.blendEquation=e,this.blendAlphaEquation=t,this.separateAlphaEquation=!0)},setCullMode:function(e){if(this.cullMode!==e){if(0===e)this.gl.disable(this.gl.CULL_FACE);else{0===this.cullMode&&this.gl.enable(this.gl.CULL_FACE);var t=this.glCull[e];this.cullFace!==t&&(this.gl.cullFace(t),this.cullFace=t)}this.cullMode=e}},getCullMode:function(){return this.cullMode},setIndexBuffer:function(e){this.indexBuffer=e},setVertexBuffer:function(e,t,i){if(this.vertexBuffers[t]!==e||this.vbOffsets[t]!==i){if(this.vertexBuffers[t]=e,this.vbOffsets[t]=i,e){i=0;for(var s=(e=e.getFormat().elements).length;i<s;){var n=e[i++];n.stream=t,n.scopeId.setValue(n)}}this.attributesInvalidated=!0}},disableVertexBufferElements:function(e){for(var t=0;t<e.length;t++){var i=this.scope.resolve(e[t]);i.value&&(this.attributesInvalidated=!0,i.setValue(null))}},compileShaderSource:function(e,t){var i=this.gl,s=t?this.vertexShaderCache[e]:this.fragmentShaderCache[e];return s||(s=i.createShader(t?i.VERTEX_SHADER:i.FRAGMENT_SHADER),i.shaderSource(s,e),i.compileShader(s),t?this.vertexShaderCache[e]=s:this.fragmentShaderCache[e]=s),s},compileAndLinkShader:function(e){var t=this.gl,i=e.definition,s=this.compileShaderSource(i.vshader,!0),n=this.compileShaderSource(i.fshader,!1),r=t.createProgram();if(t.attachShader(r,s),t.attachShader(r,n),this.webgl2&&i.useTransformFeedback){i=i.attributes;var a,o=[];for(a in i)i.hasOwnProperty(a)&&o.push("out_"+a);t.transformFeedbackVaryings(r,o,t.INTERLEAVED_ATTRIBS)}t.linkProgram(r),e._glVertexShader=s,e._glFragmentShader=n,e._glProgram=r},createShader:function(e){this.compileAndLinkShader(e),this.shaders.push(e)},destroyShader:function(e){var t=this.shaders.indexOf(e);-1!==t&&this.shaders.splice(t,1),e._glProgram&&(this.gl.deleteProgram(e._glProgram),e._glProgram=null,this.removeShaderFromCache(e))},_addLineNumbers:function(e){for(var t=0,i=(e=e.split("\n")).length;t<i;t++)e[t]=t+1+":\t"+e[t];return e.join("\n")},postLink:function(e){var t=this.gl,i=e._glVertexShader,s=e._glFragmentShader,n=e._glProgram,r=e.definition;if(!t.getShaderParameter(i,t.COMPILE_STATUS))return console.error("Failed to compile vertex shader:\n\n"+this._addLineNumbers(r.vshader)+"\n\n"+t.getShaderInfoLog(i)),!1;if(!t.getShaderParameter(s,t.COMPILE_STATUS))return console.error("Failed to compile fragment shader:\n\n"+this._addLineNumbers(r.fshader)+"\n\n"+t.getShaderInfoLog(s)),!1;if(!t.getProgramParameter(n,t.LINK_STATUS))return console.error("Failed to link shader program. Error: "+t.getProgramInfoLog(n)),!1;i=0;for(var a=t.getProgramParameter(n,t.ACTIVE_ATTRIBUTES);i<a;){s=t.getActiveAttrib(n,i++);var o=t.getAttribLocation(n,s.name);void 0===r.attributes[s.name]&&console.error('Vertex shader attribute "'+s.name+'" is not mapped to a semantic in shader definition.'),o=new jn(this,r.attributes[s.name],this.pcUniformType[s.type],o),e.attributes.push(o)}for(i=0,r=t.getProgramParameter(n,t.ACTIVE_UNIFORMS);i<r;)s=t.getActiveUniform(n,i++),o=t.getUniformLocation(n,s.name),o=new jn(this,s.name,this.pcUniformType[s.type],o),s.type===t.SAMPLER_2D||s.type===t.SAMPLER_CUBE||this.webgl2&&(s.type===t.SAMPLER_2D_SHADOW||s.type===t.SAMPLER_CUBE_SHADOW||s.type===t.SAMPLER_3D)?e.samplers.push(o):e.uniforms.push(o);return e.ready=!0},setShader:function(e){if(e!==this.shader){if(!e.ready&&!this.postLink(e))return!1;this.shader=e,this.gl.useProgram(e._glProgram),this.attributesInvalidated=!0}return!0},getHdrFormat:function(){return this.textureHalfFloatRenderable?11:this.textureFloatRenderable?13:7},getBoneLimit:function(){return this.boneLimit},setBoneLimit:function(e){this.boneLimit=e},resizeCanvas:function(e,t){this._width=e,this._height=t;var i=Math.min(this._maxPixelRatio,window.devicePixelRatio);e*=i,t*=i,this.canvas.width===e&&this.canvas.height===t||(this.canvas.width=e,this.canvas.height=t,this.fire("resizecanvas",e,t))},setResolution:function(e,t){this._width=e,this._height=t,this.canvas.width=e,this.canvas.height=t,this.fire("resizecanvas",e,t)},clearShaderCache:function(){var e,t=this.gl;for(e in this.fragmentShaderCache)t.deleteShader(this.fragmentShaderCache[e]),delete this.fragmentShaderCache[e];for(e in this.vertexShaderCache)t.deleteShader(this.vertexShaderCache[e]),delete this.vertexShaderCache[e];this.programLib.clearCache()},removeShaderFromCache:function(e){this.programLib.removeFromCache(e)},destroy:function(){var e=this.gl;this.destroyGrabPass(),this.webgl2&&this.feedback&&e.deleteTransformFeedback(this.feedback),this.clearShaderCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this.gl=this.canvas=this._contextRestoredHandler=this._contextLostHandler=null}}),Object.defineProperty(Lu.prototype,"width",{get:function(){return this.gl.drawingBufferWidth||this.canvas.width}}),Object.defineProperty(Lu.prototype,"height",{get:function(){return this.gl.drawingBufferHeight||this.canvas.height}}),Object.defineProperty(Lu.prototype,"fullscreen",{get:function(){return!!document.fullscreenElement},set:function(e){e?this.gl.canvas.requestFullscreen():document.exitFullscreen()}}),Object.defineProperty(Lu.prototype,"enableAutoInstancing",{get:function(){return this._enableAutoInstancing},set:function(e){this._enableAutoInstancing=e&&this.extInstancing}}),Object.defineProperty(Lu.prototype,"maxPixelRatio",{get:function(){return this._maxPixelRatio},set:function(e){this._maxPixelRatio=e,this.resizeCanvas(this._width,this._height)}}),Object.defineProperty(Lu.prototype,"textureFloatHighPrecision",{get:function(){if(void 0===this._textureFloatHighPrecision){if(this.textureFloatRenderable){var e=Ma,t=e.createShaderFromCode(this,e.fullscreenQuadVS,e.precisionTestPS,"ptest1"),i=e.createShaderFromCode(this,e.fullscreenQuadVS,e.precisionTest2PS,"ptest2"),s={format:14,width:1,height:1,mipmaps:!1,minFilter:0,magFilter:0};(e=new K(this,s)).name="testFHP";var n=new Bu(this,e,{depth:!1});q(this,n,t),s.format=7,(t=new K(this,s)).name="testFHP",s=new Bu(this,t,{depth:!1}),this.constantTexSource.setValue(e),q(this,s,i),i=this.activeFramebuffer,this.setFramebuffer(s._glFrameBuffer);var r=new Uint8Array(4);this.readPixels(0,0,1,1,r),this.setFramebuffer(i),i=r[0]/255/16777216+r[1]/255/65536+r[2]/255/256+r[3]/255,e.destroy(),n.destroy(),t.destroy(),s.destroy(),e=0===i}else e=!1;this._textureFloatHighPrecision=e}return this._textureFloatHighPrecision}}),Object.defineProperties(Lu.prototype,{textureHalfFloatUpdatable:{get:function(){if(void 0===this._textureHalfFloatUpdatable)if(this.webgl2)this._textureHalfFloatUpdatable=!0;else{var e=this.gl,t=this.extTextureHalfFloat.HALF_FLOAT_OES,i=!0,s=e.createTexture();e.bindTexture(e.TEXTURE_2D,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);var n=new Uint16Array(16);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,2,2,0,e.RGBA,t,n),e.getError()!==e.NO_ERROR&&(i=!1,console.log("Above error related to HALF_FLOAT_OES can be ignored, it was triggered by testing half float texture support")),e.bindTexture(e.TEXTURE_2D,null),e.deleteTexture(s),this._textureHalfFloatUpdatable=i}return this._textureHalfFloatUpdatable}}});var Fu={depth:!0,face:0},Bu=function(e,t,i){e instanceof Lu?(this._colorBuffer=t,e=i):this._colorBuffer=e.colorBuffer,this._glDepthBuffer=this._glFrameBuffer=null,e=void 0!==e?e:Fu,this._depthBuffer=e.depthBuffer,this._face=void 0!==e.face?e.face:0,this._depthBuffer?16===(t=this._depthBuffer._format)?(this._depth=!0,this._stencil=!1):this._stencil=this._depth=17===t:(this._depth=void 0===e.depth||e.depth,this._stencil=void 0!==e.stencil&&e.stencil),this._samples=void 0!==e.samples?e.samples:1,this.autoResolve=void 0===e.autoResolve||e.autoResolve,this._glMsaaDepthBuffer=this._glMsaaColorBuffer=this._glResolveFrameBuffer=null};Object.assign(Bu.prototype,{destroy:function(){if(this._device){var e=this._device,t=e.targets.indexOf(this);-1!==t&&e.targets.splice(t,1),e=e.gl,this._glFrameBuffer&&(e.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(e.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(e.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffer&&(e.deleteRenderbuffer(this._glMsaaColorBuffer),this._glMsaaColorBuffer=null),this._glMsaaDepthBuffer&&(e.deleteRenderbuffer(this._glMsaaDepthBuffer),this._glMsaaDepthBuffer=null)}},resolve:function(e,t){if(this._device&&this._device.webgl2){var i=this._device.gl;void 0===e&&(e=!0),void 0===t&&this._depthBuffer&&(t=!0),i.bindFramebuffer(i.READ_FRAMEBUFFER,this._glFrameBuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,this._glResolveFrameBuffer),i.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,(e?i.COLOR_BUFFER_BIT:0)|(t?i.DEPTH_BUFFER_BIT:0),i.NEAREST),i.bindFramebuffer(i.FRAMEBUFFER,this._glFrameBuffer)}},copy:function(e,t,i){if(!this._device){if(!e._device)return!1;this._device=e._device}return this._device.copyRenderTarget(e,this,t,i)}}),Object.defineProperty(Bu.prototype,"colorBuffer",{get:function(){return this._colorBuffer}}),Object.defineProperty(Bu.prototype,"depthBuffer",{get:function(){return this._depthBuffer}}),Object.defineProperty(Bu.prototype,"face",{get:function(){return this._face}}),Object.defineProperty(Bu.prototype,"width",{get:function(){return this._colorBuffer?this._colorBuffer.width:this._depthBuffer.width}}),Object.defineProperty(Bu.prototype,"height",{get:function(){return this._colorBuffer?this._colorBuffer.height:this._depthBuffer.height}});var Nu={type:5,base:0,count:4,indexed:!1};Object.assign(Yn.prototype,{render:function(e,t,i){}}),$n.createShader=function(e,t,i){return Ma.createShaderFromCode(e,t,null,i,!0)},Object.assign($n.prototype,{destroy:function(){this._outputBuffer.destroy()},process:function(e,t){void 0===t&&(t=!0);var i=this.device;i.setRenderTarget(null),i.updateBegin(),i.setVertexBuffer(this._inputBuffer,0),i.setRaster(!1),i.setTransformFeedbackBuffer(this._outputBuffer),i.setShader(e),i.draw({type:0,base:0,count:this._inputBuffer.numVertices,indexed:!1}),i.setTransformFeedbackBuffer(null),i.setRaster(!0),i.updateEnd(),t&&(e=this._inputBuffer.bufferId,this._inputBuffer.bufferId=this._outputBuffer.bufferId,this._outputBuffer.bufferId=e)}}),Object.defineProperty($n.prototype,"inputBuffer",{get:function(){return this._inputBuffer}}),Object.defineProperty($n.prototype,"outputBuffer",{get:function(){return this._outputBuffer}}),Qn.prototype=Object.create(Fn.prototype),Qn.prototype.constructor=Qn,Object.assign(Qn.prototype,{clone:function(){var e=new Qn;return Fn.prototype._cloneInternal.call(this,e),e},updateShader:function(e){var t={skin:!!this.meshInstances[0].skinInstance};this.shader=e.getProgramLibrary().getProgram("depth",t)}}),Jn.prototype.getSelection=function(e,t,i,s){var n=this.device;"object"==typeof e?(e=(s=e).x,t=s.y,i=s.width,s=s.height):t=this.layer.renderTarget.height-(t+(s||1)),i=i||1,s=s||1;var r=n.renderTarget;n.setRenderTarget(this.layer.renderTarget),n.updateBegin();var a=new Uint8Array(4*i*s);for(n.readPixels(e,t,i,s,a),n.updateEnd(),n.setRenderTarget(r),e=[],t=this.layer.instances.visibleOpaque[0].list,n=0;n<i*s;n++){16777215!==(r=(r=a[4*n])<<16|a[4*n+1]<<8|a[4*n+2])&&(r=t[r],-1===e.indexOf(r)&&e.push(r))}return e},Jn.prototype.prepare=function(e,t,i){var s=this.device,n=this;e instanceof _e&&(e=e._component),this.scene=t;var r=null,a=null;if(i instanceof Se?r=i:a=i,!this.layer){var o=s.scope.resolve("uColor");this.layer=new Se({name:"Picker",shaderPass:18,opaqueSortMode:0,onEnable:function(){if(!this.renderTarget){var e=new K(s,{format:7,width:n.width,height:n.height});e.name="pick",e.minFilter=0,e.magFilter=0,e.addressU=1,e.addressV=1,this.renderTarget=new Bu(s,e,{depth:!0})}},onDisable:function(){this.renderTarget&&(this.renderTarget._colorBuffer.destroy(),this.renderTarget.destroy(),this.renderTarget=null)},onDrawCall:function(e,t){n.pickColor[0]=(t>>16&255)/255,n.pickColor[1]=(t>>8&255)/255,n.pickColor[2]=(255&t)/255,o.setValue(n.pickColor),s.setBlending(!1)}}),this.layerComp=new Re,this.layerComp.pushOpaque(this.layer),this.meshInstances=this.layer.opaqueMeshInstances,this._instancesVersion=-1}if(r){if(this._instancesVersion!==r._version){for(this.layer.clearMeshInstances(),u=(d=r.instances.opaqueMeshInstances).length,c=0;c<u;c++)(p=d[c]).pick&&this.meshInstances.push(p);for(u=(d=r.instances.transparentMeshInstances).length,c=0;c<u;c++)(p=d[c]).pick&&this.meshInstances.push(p);this._instancesVersion=r._version}}else{this.layer.clearMeshInstances(),i=t.layers.layerList;var h=t.layers.subLayerEnabled,l=t.layers.subLayerList;for(t=0;t<i.length;t++)i[t].overrideClear&&i[t]._clearDepthBuffer&&(i[t]._pickerCleared=!1);for(t=0;t<i.length;t++){var c=i[t];if(c.renderTarget===a&&c.enabled&&h[t]){var d=c.cameras.indexOf(e);if(!(0>d)){c.overrideClear&&c._clearDepthBuffer&&!c._pickerCleared&&(this.meshInstances.push(this.clearDepthCommand),c._pickerCleared=!0);var u=(d=(d=l[t])?c.instances.transparentMeshInstances:c.instances.opaqueMeshInstances).length;for(c=0;c<u;c++){var p=d[c];p.pick&&this.meshInstances.push(p)}}}}}this.layer.cameras[0]!==e&&(this.layer.clearCameras(),this.layer.addCamera(e)),this.onLayerPreRender(this.layer,r,a),this.app.renderer.renderComposition(this.layerComp),this.onLayerPostRender(this.layer)},Jn.prototype.onLayerPreRender=function(e,t,i){this.width===e.renderTarget.width&&this.height===e.renderTarget.height||(e.onDisable(),e.onEnable()),e.oldClear=e.cameras[0].camera._clearOptions,e.oldAspectMode=e.cameras[0].aspectRatioMode,e.oldAspect=e.cameras[0].aspectRatio,e.cameras[0].camera._clearOptions=this.clearOptions,e.cameras[0].aspectRatioMode=1,e.cameras[0].aspectRatio=e.cameras[0].calculateAspectRatio(i||(t?t.renderTarget:null)),this.app.renderer.updateCameraFrustum(e.cameras[0].camera)},Jn.prototype.onLayerPostRender=function(e){e.cameras[0].camera._clearOptions=e.oldClear,e.cameras[0].aspectRatioMode=e.oldAspectMode,e.cameras[0].aspectRatio=e.oldAspect},Jn.prototype.resize=function(e,t){this.width=e,this.height=t},Object.defineProperty(Jn.prototype,"renderTarget",{get:function(){return this.layer.renderTarget}});var ku=function(){try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){var e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return!1}(),Uu=!1,zu=null,Vu={},Gu=null,ju=[];Object.assign(or.prototype,{load:function(e,t,i){throw Error("not implemented")},open:function(e,t,i){throw Error("not implemented")},patch:function(e,t){}});var Wu=new hr,Hu={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"};dr.prototype=Object.create(r.prototype),dr.prototype.constructor=dr,dr.prototype.attach=function(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("keydown",this._keyDownHandler,!1),this._element.addEventListener("keypress",this._keyPressHandler,!1),this._element.addEventListener("keyup",this._keyUpHandler,!1)},dr.prototype.detach=function(){this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null},dr.prototype.toKeyIdentifier=function(e){var t;if(e=cr(e),t=Hu[e.toString()])return t;var i=(t=e.toString(16).toUpperCase()).length;for(e=0;e<4-i;e++)t="0"+t;return"U+"+t},dr.prototype._handleKeyDown=function(e){var t=e.keyCode||e.charCode;void 0!==t&&(t=this.toKeyIdentifier(t),this._keymap[t]=!0,this.fire("keydown",lr(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation())},dr.prototype._handleKeyUp=function(e){var t=e.keyCode||e.charCode;void 0!==t&&(t=this.toKeyIdentifier(t),delete this._keymap[t],this.fire("keyup",lr(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation())},dr.prototype._handleKeyPress=function(e){this.fire("keypress",lr(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()},dr.prototype.update=function(){for(var e in this._lastmap)delete this._lastmap[e];for(e in this._keymap)this._keymap.hasOwnProperty(e)&&(this._lastmap[e]=this._keymap[e])},dr.prototype.isPressed=function(e){return e=cr(e),e=this.toKeyIdentifier(e),!!this._keymap[e]},dr.prototype.wasPressed=function(e){return e=cr(e),e=this.toKeyIdentifier(e),!!this._keymap[e]&&!this._lastmap[e]},dr.prototype.wasReleased=function(e){return e=cr(e),e=this.toKeyIdentifier(e),!this._keymap[e]&&!!this._lastmap[e]},pr.prototype=Object.create(r.prototype),pr.prototype.constructor=pr,pr.isPointerLocked=function(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)},Object.assign(pr.prototype,{attach:function(e){this._target=e,this._attached||(this._attached=!0,e=!!Vr.passiveEvents&&{passive:!1},window.addEventListener("mouseup",this._upHandler,e),window.addEventListener("mousedown",this._downHandler,e),window.addEventListener("mousemove",this._moveHandler,e),window.addEventListener("wheel",this._wheelHandler,e))},detach:function(){if(this._attached){this._attached=!1,this._target=null;var e=!!Vr.passiveEvents&&{passive:!1};window.removeEventListener("mouseup",this._upHandler,e),window.removeEventListener("mousedown",this._downHandler,e),window.removeEventListener("mousemove",this._moveHandler,e),window.removeEventListener("wheel",this._wheelHandler,e)}},disableContextMenu:function(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)},enableContextMenu:function(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)},enablePointerLock:function(e,t){if(document.body.requestPointerLock){var i=function(){e(),document.removeEventListener("pointerlockchange",i)},s=function(){t(),document.removeEventListener("pointerlockerror",s)};e&&document.addEventListener("pointerlockchange",i,!1),t&&document.addEventListener("pointerlockerror",s,!1),document.body.requestPointerLock()}else t&&t()},disablePointerLock:function(e){if(document.exitPointerLock){var t=function(){e(),document.removeEventListener("pointerlockchange",t)};e&&document.addEventListener("pointerlockchange",t,!1),document.exitPointerLock()}},update:function(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]},isPressed:function(e){return this._buttons[e]},wasPressed:function(e){return this._buttons[e]&&!this._lastbuttons[e]},wasReleased:function(e){return!this._buttons[e]&&this._lastbuttons[e]},_handleUp:function(e){this._buttons[e.button]=!1,(e=new ur(this,e)).event&&this.fire("mouseup",e)},_handleDown:function(e){this._buttons[e.button]=!0,(e=new ur(this,e)).event&&this.fire("mousedown",e)},_handleMove:function(e){(e=new ur(this,e)).event&&(this.fire("mousemove",e),this._lastX=e.x,this._lastY=e.y)},_handleWheel:function(e){(e=new ur(this,e)).event&&this.fire("mousewheel",e)},_getTargetCoords:function(e){var t=this._target.getBoundingClientRect(),i=Math.floor(t.left);return t=Math.floor(t.top),e.clientX<i||e.clientX>=i+this._target.clientWidth||e.clientY<t||e.clientY>=t+this._target.clientHeight?null:{x:e.clientX-i,y:e.clientY-t}}}),fr.prototype.attach=function(e){this._element=e,this._keyboard&&this._keyboard.attach(e),this._mouse&&this._mouse.attach(e)},fr.prototype.detach=function(){this._keyboard&&this._keyboard.detach(),this._mouse&&this._mouse.detach(),this._element=null},fr.prototype.disableContextMenu=function(){this._mouse||this._enableMouse(),this._mouse.disableContextMenu()},fr.prototype.enableContextMenu=function(){this._mouse||this._enableMouse(),this._mouse.enableContextMenu()},fr.prototype.update=function(e){for(var t in this._keyboard&&this._keyboard.update(e),this._mouse&&this._mouse.update(e),this._gamepads&&this._gamepads.update(e),this._axesValues={},this._axes)this._axesValues[t]=[]},fr.prototype.registerKeys=function(e,t){if(this._keyboard||this._enableKeyboard(),this._actions[e])throw Error("Action: "+e+" already registered");if(void 0===t)throw Error("Invalid button");t.length||(t=[t]),this._actions[e]?this._actions[e].push({type:"keyboard",keys:t}):this._actions[e]=[{type:"keyboard",keys:t}]},fr.prototype.registerMouse=function(e,t){if(this._mouse||this._enableMouse(),void 0===t)throw Error("Invalid button");this._actions[e]?this._actions[e].push({type:"mouse",button:t}):this._actions[e]=[{type:"mouse",button:-t}]},fr.prototype.registerPadButton=function(e,t,i){if(void 0===i)throw Error("Invalid button");this._actions[e]?this._actions[e].push({type:"gamepad",button:i,pad:t}):this._actions[e]=[{type:"gamepad",button:i,pad:t}]},fr.prototype.registerAxis=function(e){var t=e.name;this._axes[t]||(this._axes[t]=[]);var i=this._axes[t].push(t);(e=e||{}).pad=e.pad||0;var s=function(s,n,r,a){switch(n){case"mousex":s._mouse.on("mousemove",function(e){s._axesValues[t][i]=e.dx/10});break;case"mousey":s._mouse.on("mousemove",function(e){s._axesValues[t][i]=e.dy/10});break;case"key":s._axes[t].push(function(){return s._keyboard.isPressed(a)?r:0});break;case"padrx":s._axes[t].push(function(){return s._gamepads.getAxis(e.pad,2)});break;case"padry":s._axes[t].push(function(){return s._gamepads.getAxis(e.pad,3)});break;case"padlx":s._axes[t].push(function(){return s._gamepads.getAxis(e.pad,0)});break;case"padly":s._axes[t].push(function(){return s._gamepads.getAxis(e.pad,1)});break;default:throw Error("Unknown axis")}};s(this,e.positive,1,e.positiveKey),(e.negativeKey||e.negative!==e.positive)&&s(this,e.negative,-1,e.negativeKey)},fr.prototype.isPressed=function(e){if(!this._actions[e])return!1;var t,i=this._actions[e].length;for(t=0;t<i;++t){var s=this._actions[e][t];switch(s.type){case"keyboard":if(this._keyboard){var n,r=s.keys.length;for(n=0;n<r;n++)if(this._keyboard.isPressed(s.keys[n]))return!0}break;case"mouse":if(this._mouse&&this._mouse.isPressed(s.button))return!0;break;case"gamepad":if(this._gamepads&&this._gamepads.isPressed(s.pad,s.button))return!0}}return!1},fr.prototype.wasPressed=function(e){if(!this._actions[e])return!1;var t,i=this._actions[e].length;for(t=0;t<i;++t){var s=this._actions[e][t];switch(s.type){case"keyboard":if(this._keyboard){var n,r=s.keys.length;for(n=0;n<r;n++)if(this._keyboard.wasPressed(s.keys[n]))return!0}break;case"mouse":if(this._mouse&&this._mouse.wasPressed(s.button))return!0;break;case"gamepad":if(this._gamepads&&this._gamepads.wasPressed(s.pad,s.button))return!0}}return!1},fr.prototype.getAxis=function(e){var t=0;if(this._axes[e]){var s,n=this._axes[e].length;for(s=0;s<n;s++)if("function"===i(this._axes[e][s])){var r=this._axes[e][s]();Math.abs(r)>Math.abs(t)&&(t=r)}else this._axesValues[e]&&Math.abs(this._axesValues[e][s])>Math.abs(t)&&(t=this._axesValues[e][s])}return t},fr.prototype._enableMouse=function(){if(this._mouse=new pr,!this._element)throw Error("Controller must be attached to an Element");this._mouse.attach(this._element)},fr.prototype._enableKeyboard=function(){if(this._keyboard=new dr,!this._element)throw Error("Controller must be attached to an Element");this._keyboard.attach(this._element)};var Xu,qu,Yu=new v,Ku=new v,Zu=new A,$u=new A,Qu=new A;Zu.end=new v,$u.end=new v,Qu.end=new v;var Ju=new v,ep=new v,tp=new v,ip=new v,sp=new v,np=new v,rp=new v,ap=new T,op=new v,hp=new v,lp=new v,cp=new v,dp=new v,up=new v,pp=new v,fp=new v,mp=new b;Object.assign(mr.prototype,{stopPropagation:function(){this._stopPropagation=!0,this.event&&(this.event.stopImmediatePropagation(),this.event.stopPropagation())}}),_r.prototype=Object.create(mr.prototype),_r.prototype.constructor=_r,gr.prototype=Object.create(mr.prototype),gr.prototype.constructor=gr,yr.prototype=Object.create(mr.prototype),yr.prototype.constructor=yr,Object.assign(vr.prototype,{attach:function(e){this._attached&&(this._attached=!1,this.detach()),this._target=e,this._attached=!0,e=!!Vr.passiveEvents&&{passive:!0},this._useMouse&&(window.addEventListener("mouseup",this._upHandler,e),window.addEventListener("mousedown",this._downHandler,e),window.addEventListener("mousemove",this._moveHandler,e),window.addEventListener("wheel",this._wheelHandler,e)),this._useTouch&&Vr.touch&&(this._target.addEventListener("touchstart",this._touchstartHandler,e),this._target.addEventListener("touchend",this._touchendHandler,!1),this._target.addEventListener("touchmove",this._touchmoveHandler,!1),this._target.addEventListener("touchcancel",this._touchcancelHandler,!1)),this.attachSelectEvents()},attachSelectEvents:function(){!this._selectEventsAttached&&this._useXr&&this.app&&this.app.xr&&this.app.xr.supported&&(this._clickedEntities||(this._clickedEntities={}),this._selectEventsAttached=!0,this.app.xr.on("start",this._onXrStart,this))},detach:function(){if(this._attached){this._attached=!1;var e=!!Vr.passiveEvents&&{passive:!0};this._useMouse&&(window.removeEventListener("mouseup",this._upHandler,e),window.removeEventListener("mousedown",this._downHandler,e),window.removeEventListener("mousemove",this._moveHandler,e),window.removeEventListener("wheel",this._wheelHandler,e)),this._useTouch&&(this._target.removeEventListener("touchstart",this._touchstartHandler,e),this._target.removeEventListener("touchend",this._touchendHandler,!1),this._target.removeEventListener("touchmove",this._touchmoveHandler,!1),this._target.removeEventListener("touchcancel",this._touchcancelHandler,!1)),this._selectEventsAttached&&(this._selectEventsAttached=!1,this.app.xr.off("start",this._onXrStart,this),this.app.xr.off("end",this._onXrEnd,this),this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)),this._target=null}},addElement:function(e){-1===this._elements.indexOf(e)&&this._elements.push(e)},removeElement:function(e){-1!==(e=this._elements.indexOf(e))&&this._elements.splice(e,1)},_handleUp:function(e){this._enabled&&!pr.isPointerLocked()&&(this._calcMouseCoords(e),null!==Xu&&this._onElementMouseEvent("mouseup",e))},_handleDown:function(e){this._enabled&&!pr.isPointerLocked()&&(this._calcMouseCoords(e),null!==Xu&&this._onElementMouseEvent("mousedown",e))},_handleMove:function(e){this._enabled&&(this._calcMouseCoords(e),null!==Xu&&(this._onElementMouseEvent("mousemove",e),this._lastX=Xu,this._lastY=qu))},_handleWheel:function(e){this._enabled&&(this._calcMouseCoords(e),null!==Xu&&this._onElementMouseEvent("mousewheel",e))},_determineTouchedElements:function(e){var t,i,s={},n=this.app.systems.camera.cameras;for(t=n.length-1;0<=t;t--){var r=n[t],a=0,o=0;for(i=e.changedTouches.length;o<i;o++)if(s[e.changedTouches[o].identifier])a++;else{var h=this._calcTouchCoords(e.changedTouches[o]),l=this._getTargetElement(r,h.x,h.y);l&&(a++,s[e.changedTouches[o].identifier]={element:l,camera:r,x:h.x,y:h.y})}if(a===i)break}return s},_handleTouchStart:function(e){if(this._enabled){for(var t=this._determineTouchedElements(e),i=0,s=e.changedTouches.length;i<s;i++){var n=e.changedTouches[i],r=t[n.identifier],a=this._touchedElements[n.identifier];!r||a&&r.element===a.element||(this._fireEvent(e.type,new gr(e,r.element,r.camera,r.x,r.y,n)),this._touchesForWhichTouchLeaveHasFired[n.identifier]=!1)}for(var o in t)this._touchedElements[o]=t[o]}},_handleTouchEnd:function(e){if(this._enabled){var t=this.app.systems.camera.cameras;for(i in this._clickedEntities)delete this._clickedEntities[i];for(var i=0,s=e.changedTouches.length;i<s;i++){var n=e.changedTouches[i],r=this._touchedElements[n.identifier];if(r){var a=r.element,o=r.camera,h=r.x;if(r=r.y,delete this._touchedElements[n.identifier],delete this._touchesForWhichTouchLeaveHasFired[n.identifier],this._fireEvent(e.type,new gr(e,a,o,h,r,n)),0===e.touches.length)for(var l=this._calcTouchCoords(n),c=t.length-1;0<=c;c--)this._getTargetElement(t[c],l.x,l.y)!==a||this._clickedEntities[a.entity.getGuid()]||(this._fireEvent("click",new gr(e,a,o,h,r,n)),this._clickedEntities[a.entity.getGuid()]=!0)}}}},_handleTouchMove:function(e){if(e.preventDefault(),this._enabled)for(var t=this._determineTouchedElements(e),i=0,s=e.changedTouches.length;i<s;i++){var n=e.changedTouches[i],r=t[n.identifier],a=this._touchedElements[n.identifier];if(a){var o=this._calcTouchCoords(n);r&&r.element===a.element||this._touchesForWhichTouchLeaveHasFired[n.identifier]||(this._fireEvent("touchleave",new gr(e,a.element,a.camera,o.x,o.y,n)),this._touchesForWhichTouchLeaveHasFired[n.identifier]=!0),this._fireEvent("touchmove",new gr(e,a.element,a.camera,o.x,o.y,n))}}},_onElementMouseEvent:function(e,t){var i,s=this._hoveredElement;this._hoveredElement=null;for(var n,r=this.app.systems.camera.cameras,a=r.length-1;0<=a&&(n=r[a],!(i=this._getTargetElement(n,Xu,qu)));a--);i&&(this._fireEvent(e,new _r(t,i,n,Xu,qu,this._lastX,this._lastY)),this._hoveredElement=i,"mousedown"===e&&(this._pressedElement=i)),s!==this._hoveredElement&&(s&&this._fireEvent("mouseleave",new _r(t,s,n,Xu,qu,this._lastX,this._lastY)),this._hoveredElement&&this._fireEvent("mouseenter",new _r(t,this._hoveredElement,n,Xu,qu,this._lastX,this._lastY))),"mouseup"===e&&this._pressedElement&&(this._pressedElement===this._hoveredElement?(this._pressedElement=null,this._clickedEntities&&this._clickedEntities[this._hoveredElement.entity.getGuid()]||this._fireEvent("click",new _r(t,this._hoveredElement,n,Xu,qu,this._lastX,this._lastY))):this._pressedElement=null)},_onXrStart:function(){this.app.xr.on("end",this._onXrEnd,this),this.app.xr.on("update",this._onXrUpdate,this),this.app.xr.input.on("selectstart",this._onSelectStart,this),this.app.xr.input.on("selectend",this._onSelectEnd,this),this.app.xr.input.on("remove",this._onXrInputRemove,this)},_onXrEnd:function(){this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)},_onXrUpdate:function(){if(this._enabled)for(var e=this.app.xr.input.inputSources,t=0;t<e.length;t++)this._onElementSelectEvent("selectmove",e[t],null)},_onXrInputRemove:function(e){var t=this._selectedElements[e.id];t&&(e._elementEntity=null,this._fireEvent("selectleave",new yr(null,t,null,e))),delete this._selectedElements[e.id],delete this._selectedPressedElements[e.id]},_onSelectStart:function(e,t){this._enabled&&this._onElementSelectEvent("selectstart",e,t)},_onSelectEnd:function(e,t){this._enabled&&this._onElementSelectEvent("selectend",e,t)},_onElementSelectEvent:function(e,t,i){var s,n=this._selectedElements[t.id],r=this.app.systems.camera.cameras;if(t.elementInput){Qu.set(t.getOrigin(),t.getDirection());for(var a=r.length-1;0<=a;a--){var o=r[a];if(s=this._getTargetElementByRay(Qu,o))break}}if(t._elementEntity=s||null,s)var h=this._selectedElements[t.id]=s;else delete this._selectedElements[t.id];n!==h&&(n&&this._fireEvent("selectleave",new yr(i,n,o,t)),h&&this._fireEvent("selectenter",new yr(i,h,o,t))),"selectstart"===e&&(this._selectedPressedElements[t.id]=h)&&this._fireEvent("selectstart",new yr(i,h,o,t)),s=this._selectedPressedElements[t.id],!t.elementInput&&s&&(delete this._selectedPressedElements[t.id],n&&this._fireEvent("selectend",new yr(i,n,o,t))),"selectend"===e&&t.elementInput&&(delete this._selectedPressedElements[t.id],n&&this._fireEvent("selectend",new yr(i,n,o,t)),s&&s===n&&this._fireEvent("click",new yr(i,s,o,t)))},_fireEvent:function(e,t){for(var i=t.element;(i.fire(e,t),!t._stopPropagation)&&i.entity.parent&&(i=i.entity.parent.element););},_calcMouseCoords:function(e){var t=this._target.getBoundingClientRect(),i=Math.floor(t.left);t=Math.floor(t.top),e.clientX<i||e.clientX>=i+this._target.clientWidth||e.clientY<t||e.clientY>=t+this._target.clientHeight?qu=Xu=null:(Xu=e.clientX-i,qu=e.clientY-t)},_calcTouchCoords:function(e){for(var t=0,i=0,s=e.target;!(s instanceof HTMLElement);)s=s.parentNode;do{t+=s.offsetLeft-s.scrollLeft,i+=s.offsetTop-s.scrollTop,s=s.offsetParent}while(s);return{x:e.pageX-t,y:e.pageY-i}},_sortElements:function(e,t){var i=this.app.scene.layers.sortTransparentLayers(e.layers,t.layers);return 0!==i?i:e.screen&&!t.screen?-1:!e.screen&&t.screen?1:e.screen||t.screen?e.screen.screen.screenSpace&&!t.screen.screen.screenSpace?-1:t.screen.screen.screenSpace&&!e.screen.screen.screenSpace?1:t.drawOrder-e.drawOrder:0},_getTargetElement:function(e,t,i){var s=null;this._elements.sort(this._sortHandler);for(var n,r,a=0,o=this._elements.length;a<o;a++){var h=this._elements[a],l=!1;if(h.screen&&h.screen.screen.screenSpace){void 0===n&&(n=Zu,!1===this._calculateRayScreen(t,i,e,n)&&(n=null));var c=n;l=!0}else void 0===r&&(r=$u,!1===this._calculateRay3d(t,i,e,r)&&(r=null)),c=r;if(c&&this._checkElement(c,h,l)){s=h;break}}return s},_getTargetElementByRay:function(e,t){var i=null;for(Zu.origin.copy(e.origin),Zu.direction.copy(e.direction),Zu.end.copy(Zu.direction).scale(2*t.farClip).add(Zu.origin),this._elements.sort(this._sortHandler),e=0,t=this._elements.length;e<t;e++){var s=this._elements[e];if((!s.screen||!s.screen.screen.screenSpace)&&this._checkElement(Zu,s,!1)){i=s;break}}return i},_buildHitCorners:function(e,t,i,s){if(e.entity&&e.entity.button){var n=e.entity.button.hitPadding||mp;op.copy(e.entity.up),hp.copy(op).scale(-1),cp.copy(e.entity.right),lp.copy(cp).scale(-1),op.scale(n.w*s),hp.scale(n.y*s),cp.scale(n.z*i),lp.scale(n.x*i),dp.copy(t[0]).add(hp).add(lp),up.copy(t[1]).add(hp).add(cp),pp.copy(t[2]).add(op).add(cp),fp.copy(t[3]).add(op).add(lp),t=[dp,up,pp,fp]}return t},_calculateScaleToScreen:function(e){var t=e.entity;for(e=e.screen.screen.scale,ap.set(e,e);t&&!t.screen;)ap.mul(t.getLocalScale()),t=t.parent;return ap},_calculateRayScreen:function(e,t,i,s){var n=this.app.graphicsDevice.width,r=this.app.graphicsDevice.height,a=i.rect.z*n,o=i.rect.w*r,h=i.rect.x*n,l=(i=(1-i.rect.y)*r)-o;return e=e*n/this._target.clientWidth,t=t*r/this._target.clientHeight,e>=h&&e<=h+a&&t<=i&&t>=l&&(s.origin.set(n*(e-h)/a,r-r*(t-l)/o,1),s.direction.set(0,0,-1),s.end.copy(s.direction).scale(2).add(s.origin),!0)},_calculateRay3d:function(e,t,i,s){var n=this._target.clientWidth,r=this._target.clientHeight,a=i.rect.z*n,o=i.rect.w*r,h=i.rect.x*n,l=(1-i.rect.y)*r,c=l-o,d=t;return e>=h&&e<=h+a&&t<=l&&d>=c&&(e=n*(e-h)/a,d=r*(d-c)/o,i.screenToWorld(e,d,i.nearClip,Yu),i.screenToWorld(e,d,i.farClip,Ku),s.origin.copy(Yu),s.direction.set(0,0,-1),s.end.copy(Ku),!0)},_checkElement:function(e,t,i){if(t.maskedBy&&!this._checkElement(e,t.maskedBy.element,i))return!1;var s=i?this._calculateScaleToScreen(t):t.entity.getWorldTransform().getScale();return t=this._buildHitCorners(t,i?t.screenCorners:t.worldCorners,s.x,s.y),!!function(e,t,i){if(Ju.sub2(t,e),ep.sub2(i[0],e),tp.sub2(i[1],e),ip.sub2(i[2],e),np.cross(ip,Ju),0<=ep.dot(np)){if(0>-tp.dot(np))return!1;if(e=ep,0>rp.cross(Ju,tp).dot(e))return!1}else{if(sp.sub2(i[3],e),0>sp.dot(np))return!1;if(e=sp,0>rp.cross(Ju,ep).dot(e))return!1}return!(1e-8>Ju.sub2(i[0],i[2]).lengthSq()||1e-8>Ju.sub2(i[1],i[3]).lengthSq())}(e.origin,e.end,t)}}),Object.defineProperty(vr.prototype,"enabled",{get:function(){return this._enabled},set:function(e){this._enabled=e}}),Object.defineProperty(vr.prototype,"app",{get:function(){return this._app||Ln.getApplication()},set:function(e){this._app=e}});var _p={DEFAULT:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_3 PAD_FACE_4 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},PS3:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_4 PAD_FACE_3 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]}},gp={"Product: 0268":"PS3"};Object.assign(br.prototype,{update:function(){var e,t,i=0;for(t=this.current.length;i<t;i++){var s=this.current[i].pad.buttons,n=s.length;for(e=0;e<n;e++)void 0===this.previous[i]&&(this.previous[i]=[]),this.previous[i][e]=s[e].pressed}for(i=0,t=(e=this.poll()).length;i<t;i++)this.current[i]=e[i]},poll:function(){var e=[];if(this.gamepadsSupported){var t,i=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads(),s=i.length;for(t=0;t<s;t++)i[t]&&e.push({map:this.getMap(i[t]),pad:i[t]})}return e},getMap:function(e){for(var t in gp)if(0<=e.id.indexOf(t))return _p[gp[t]];return _p.DEFAULT},isPressed:function(e,t){return!!this.current[e]&&this.current[e].pad.buttons[pc[this.current[e].map.buttons[t]]].pressed},wasPressed:function(e,t){return!!this.current[e]&&(t=pc[this.current[e].map.buttons[t]],this.current[e].pad.buttons[t].pressed&&!this.previous[e][t])},getAxis:function(e,t){return!!this.current[e]&&(e=this.current[e].pad.axes[pc[this.current[e].map.axes[t]]],Math.abs(e)<this.deadZone&&(e=0),e)}}),Object.assign(Sr.prototype,{getTouchById:function(e,t){var i,s=t.length;for(i=0;i<s;i++)if(t[i].id===e)return t[i];return null}}),Tr.prototype=Object.create(r.prototype),Tr.prototype.constructor=Tr,Object.assign(Tr.prototype,{attach:function(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("touchstart",this._startHandler,!1),this._element.addEventListener("touchend",this._endHandler,!1),this._element.addEventListener("touchmove",this._moveHandler,!1),this._element.addEventListener("touchcancel",this._cancelHandler,!1)},detach:function(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1)),this._element=null},_handleTouchStart:function(e){this.fire("touchstart",new Sr(this,e))},_handleTouchEnd:function(e){this.fire("touchend",new Sr(this,e))},_handleTouchMove:function(e){e.preventDefault(),this.fire("touchmove",new Sr(this,e))},_handleTouchCancel:function(e){this.fire("touchcancel",new Sr(this,e))}}),Mr.prototype=Object.create(r.prototype),Mr.prototype.constructor=Mr,Mr.prototype.createTextures=function(e){if((e=this._normalizeCharsSet(e)).length!==this.chars.length)this._renderAtlas(e);else for(var t=0;t<e.length;t++)if(e[t]!==this.chars[t]){this._renderAtlas(e);break}},Mr.prototype.updateTextures=function(e){e=this._normalizeCharsSet(e);for(var t=[],i=0;i<e.length;i++){var s=e[i];this.data.chars[s]||t.push(s)}0<t.length&&this._renderAtlas(this.chars.concat(t))},Mr.prototype.destroy=function(){for(var e=0;e<this.textures.length;e++)this.textures[e].destroy();this.fontWeight=this.type=this.textures=this.intensity=this.glyphSize=this.fontSize=this.fontName=this.data=this.color=this.chars=null},Mr.prototype._getAndClearContext=function(e,t){var i=e.width,s=e.height;return(e=e.getContext("2d",{alpha:!0})).clearRect(0,0,i,s),e.fillStyle=t,e.fillRect(0,0,i,s),e},Mr.prototype._colorToRgbString=function(e,t){var i=Math.round(255*e.r),s=Math.round(255*e.g),n=Math.round(255*e.b);return t?"rgba("+i+", "+s+", "+n+", "+e.a+")":"rgb("+i+", "+s+", "+n+")"},Mr.prototype.renderCharacter=function(e,t,i,s,n){e.fillStyle=n,e.fillText(t,i,s)},Mr.prototype._renderAtlas=function(e){this.chars=e,e=1;var t=this.textures[e-1].getSource(),i=t.width,s=t.height,n=this._colorToRgbString(this.color,!1),r=this.color.a;this.color.a=1/255;var a=this._colorToRgbString(this.color,!0);this.color.a=r,(r=this._getAndClearContext(t,a)).font=this.fontWeight+" "+this.fontSize.toString()+"px "+this.fontName,r.textAlign="center",r.textBaseline="alphabetic",this.data=this._createJson(this.chars,this.fontName,i,s);var o,h=Wr.getSymbols(this.chars.join("")),l=this.textures.length,c=0,d=0,u={};for(o=0;o<h.length;o++)u[t=h[o]]=this._getTextMetrics(t),c=Math.max(c,u[t].height),d=Math.max(d,u[t].descent);this.glyphSize=Math.max(this.glyphSize,c),c=this.glyphSize+2*this.padding;var p=this.glyphSize+2*this.padding,f=this.glyphSize/2+this.padding,m=p-d-this.padding,_=0,g=0;for(o=0;o<h.length;o++){t=h[o];var y=Wr.getCodePoint(h[o]),v=this.fontSize;r.font=this.fontWeight+" "+v.toString()+"px "+this.fontName,r.textAlign="center",r.textBaseline="alphabetic";var b=r.measureText(t).width;b>v&&(v=this.fontSize*this.fontSize/b,r.font=this.fontWeight+" "+v.toString()+"px "+this.fontName,b=this.fontSize),this.renderCharacter(r,t,_+f,g+m,n),this._addChar(this.data,t,y,_,g,c,p,this.padding+(this.glyphSize-b)/2,-this.padding+u[t].descent-d,b,e-1,i,s),(_+=c)+c>i&&(_=0,(g+=p)+p>s&&(this.textures[e-1].upload(),g=0,++e>l?((t=document.createElement("canvas")).height=s,t.width=i,r=this._getAndClearContext(t,a),(y=new K(this.app.graphicsDevice,{format:7,autoMipmap:!0})).name="font-atlas",y.setSource(t),y.minFilter=5,y.magFilter=1,y.addressU=1,y.addressV=1,this.textures.push(y)):(t=this.textures[e-1].getSource(),r=this._getAndClearContext(t,a))))}if(this.textures[e-1].upload(),e<l){for(o=e;o<l;o++)this.textures[o].destroy();this.textures.splice(e)}this.fire("render")},Mr.prototype._createJson=function(e,t,i,s){return{version:3,intensity:this.intensity,info:{face:t,width:i,height:s,maps:[{width:i,height:s}]},chars:{}}},Mr.prototype._addChar=function(e,t,i,s,n,r,a,o,h,l,c,d,u){e.info.maps.length<c+1&&e.info.maps.push({width:d,height:u}),d=this.fontSize/32,e.chars[t]={id:i,letter:t,x:s,y:n,width:r,height:a,xadvance:l/d,xoffset:o/d,yoffset:(h+this.padding)/d,scale:d,range:1,map:c,bounds:[0,0,r/d,a/d]}},Mr.prototype._normalizeCharsSet=function(e){var t,i=this.app.systems.element.getUnicodeConverter();for(i&&(e=i(e)),i={},e=Wr.getSymbols(e),t=0;t<e.length;t++){var s=e[t];i[s]||(i[s]=s)}return Object.keys(i).sort()},Mr.prototype._getTextMetrics=function(e){var t=document.createElement("span");t.id="content-span",t.innerHTML=e,(e=document.createElement("div")).id="content-block",e.style.display="inline-block",e.style.width="1px",e.style.height="0px";var i=document.createElement("div");i.appendChild(t),i.appendChild(e),i.style.font=this.fontName,i.style.fontSize=this.fontSize+"px",document.body.appendChild(i);var s=-1,n=-1,r=-1;try{e.style["vertical-align"]="baseline",s=e.offsetTop-t.offsetTop,e.style["vertical-align"]="bottom",n=(r=e.offsetTop-t.offsetTop)-s}finally{document.body.removeChild(i)}return{ascent:s,descent:n,height:r}};var yp,vp=[null,null],bp=null,xp=new b,Sp=new Float32Array(4),Tp=[],wp=!1,Mp=!1,Pp=!1,Ap=/uniform[ \t\n\r]+\S+[ \t\n\r]+\S+[ \t\n\r]*;/g,Ep=/\S+[ \t\n\r]*;/,Cp=/[ \t\n\r]*;/,Ip=/(float|int|bool|vec2|vec3|vec4|struct)([ \t\n\r]+[^;]+[ \t\n\r]*,*)+;/g,Op=/(float|int|bool|vec2|vec3|vec4|struct|,|;|\{|\})/g,Rp=/(uniform|varying|in|out)[ \t\n\r]+(float|int|bool|vec2|vec3|vec4|struct)([ \t\n\r]+[^;]+[ \t\n\r]*,*)+;/g,Dp=/(float|int|bool|vec2|vec3|vec4|struct|uniform|varying|in|out|,|;|\{|\})/g,Lp=/#version/g,Fp=/out highp vec4 pc_fragColor;/g,Bp=/#define gl_FragColor/g,Np=/gl_FragColor/g,kp=/uniform[ \t\n\r]+sampler2D[ \t\n\r]+uColorBuffer;/g,Up=/(varying|in)[ \t\n\r]+vec2[ \t\n\r]+vUv0;/g,zp=/(texture2D|texture)[ \t\n\r]*\([ \t\n\r]*uColorBuffer/g,Vp=/void[ \t\n\r]+main/g;Cr.prototype.addToComposition=function(e){this.app.scene.layers.insertTransparent(this.layer,e)};var Gp={write:function(e){console.log(e)},open:function(){Gp.write("Powered by PlayCanvas 1.30.0 878f4ce")},info:function(e){console.info("INFO:\t"+e)},debug:function(e){console.debug("DEBUG:   "+e)},error:function(e){console.error("ERROR:   "+e)},warning:function(e){console.warn("WARNING: "+e)},alert:function(e){Gp.write("ALERT:   "+e),alert(e)},assert:function(e,t){!1===e&&Gp.write("ASSERT:  "+t)}};Wr.endsWith=function(e,t){return e.endsWith(t)},Wr.startsWith=function(e,t){return e.startsWith(t)};var jp={now:Xr,Timer:u};Object.defineProperty(h.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.r,this._data[1]=this.g,this._data[2]=this.b,this._data[3]=this.a,this._data}}),Object.defineProperty(h.prototype,"data3",{get:function(){return this._data3||(this._data3=new Float32Array(3)),this._data3[0]=this.r,this._data3[1]=this.g,this._data3[2]=this.b,this._data3}}),Hr.INV_LOG2=Math.LOG2E,Hr.intToBytes=Hr.intToBytes32,Hr.bytesToInt=Hr.bytesToInt32,Object.defineProperty(T.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(2)),this._data[0]=this.x,this._data[1]=this.y,this._data}}),Object.defineProperty(v.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(3)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data}}),Object.defineProperty(b.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data[3]=this.w,this._data}});var Wp={Aabb:w,Sphere:M,Plane:C};M.prototype.intersectRay=M.prototype.intersectsRay,Ir.prototype=Error.prototype,Or.prototype=Error.prototype;var Hp={ADDRESS_CLAMP_TO_EDGE:1,ADDRESS_MIRRORED_REPEAT:2,ADDRESS_REPEAT:0,BLENDMODE_ZERO:0,BLENDMODE_ONE:1,BLENDMODE_SRC_COLOR:2,BLENDMODE_ONE_MINUS_SRC_COLOR:3,BLENDMODE_DST_COLOR:4,BLENDMODE_ONE_MINUS_DST_COLOR:5,BLENDMODE_SRC_ALPHA:6,BLENDMODE_SRC_ALPHA_SATURATE:7,BLENDMODE_ONE_MINUS_SRC_ALPHA:8,BLENDMODE_DST_ALPHA:9,BLENDMODE_ONE_MINUS_DST_ALPHA:10,BUFFER_STATIC:0,BUFFER_DYNAMIC:1,BUFFER_STREAM:2,CULLFACE_NONE:0,CULLFACE_BACK:1,CULLFACE_FRONT:2,CULLFACE_FRONTANDBACK:3,ELEMENTTYPE_INT8:0,ELEMENTTYPE_UINT8:1,ELEMENTTYPE_INT16:2,ELEMENTTYPE_UINT16:3,ELEMENTTYPE_INT32:4,ELEMENTTYPE_UINT32:5,ELEMENTTYPE_FLOAT32:6,FILTER_NEAREST:0,FILTER_LINEAR:1,FILTER_NEAREST_MIPMAP_NEAREST:2,FILTER_NEAREST_MIPMAP_LINEAR:3,FILTER_LINEAR_MIPMAP_NEAREST:4,FILTER_LINEAR_MIPMAP_LINEAR:5,INDEXFORMAT_UINT8:0,INDEXFORMAT_UINT16:1,INDEXFORMAT_UINT32:2,PIXELFORMAT_R5_G6_B5:3,PIXELFORMAT_R8_G8_B8:6,PIXELFORMAT_R8_G8_B8_A8:7,PRIMITIVE_POINTS:0,PRIMITIVE_LINES:1,PRIMITIVE_LINELOOP:2,PRIMITIVE_LINESTRIP:3,PRIMITIVE_TRIANGLES:4,PRIMITIVE_TRISTRIP:5,PRIMITIVE_TRIFAN:6,SEMANTIC_POSITION:"POSITION",SEMANTIC_NORMAL:"NORMAL",SEMANTIC_COLOR:"COLOR",SEMANTIC_TEXCOORD:"TEXCOORD",SEMANTIC_TEXCOORD0:"TEXCOORD0",SEMANTIC_TEXCOORD1:"TEXCOORD1",SEMANTIC_ATTR0:"ATTR0",SEMANTIC_ATTR1:"ATTR1",SEMANTIC_ATTR2:"ATTR2",SEMANTIC_ATTR3:"ATTR3",TEXTURELOCK_READ:1,TEXTURELOCK_WRITE:2,drawQuadWithShader:q,programlib:wa,shaderChunks:Ma,ContextCreationError:Or,Device:Lu,IndexBuffer:Z,ProgramLibrary:kn,RenderTarget:Bu,ScopeId:Vn,Shader:Y,ShaderInput:jn,Texture:K,UnsupportedBrowserError:Ir,VertexBuffer:I,VertexFormat:R,VertexIterator:X},Xp={createFullscreenQuad:Kn,drawFullscreenQuad:Zn,PostEffect:Yn,PostEffectQueue:us};Object.defineProperty(Ma,"transformSkinnedVS",{get:function(){return"#define SKIN\n"+Ma.transformVS}}),Object.defineProperties(K.prototype,{rgbm:{get:function(){return"rgbm"===this.type},set:function(e){this.type=e?"rgbm":"default"}},swizzleGGGR:{get:function(){return"swizzleGGGR"===this.type},set:function(e){this.type=e?"swizzleGGGR":"default"}}});var qp=Nn,Yp={partitionSkin:ri,procedural:{calculateTangents:Xe,createMesh:qe,createTorus:Ye,createCylinder:Ze,createCapsule:$e,createCone:Qe,createSphere:Je,createPlane:et,createBox:tt},BasicMaterial:Ce,Command:te,DepthMaterial:Qn,ForwardRenderer:Ae,GraphNode:ge,Material:Fn,Mesh:J,MeshInstance:ee,Model:oe,ParticleEmitter:Bh,PhongMaterial:Nn,Picker:Jn,Projection:{ORTHOGRAPHIC:1,PERSPECTIVE:0},Scene:it,Skin:re,SkinInstance:ae};ge.prototype._dirtify=function(e){e?this._dirtifyLocal():this._dirtifyWorld()},ge.prototype.addLabel=function(e){this._labels[e]=!0},ge.prototype.getLabels=function(){return Object.keys(this._labels)},ge.prototype.hasLabel=function(e){return!!this._labels[e]},ge.prototype.removeLabel=function(e){delete this._labels[e]},ge.prototype.findByLabel=function(e,t){var i,s=this._children.length;for(t=t||[],this.hasLabel(e)&&t.push(this),i=0;i<s;++i)t=this._children[i].findByLabel(e,t);return t},ge.prototype.getChildren=function(){return this.children},ge.prototype.getName=function(){return this.name},ge.prototype.getPath=function(){return this.path},ge.prototype.getRoot=function(){return this.root},ge.prototype.getParent=function(){return this.parent},ge.prototype.setName=function(e){this.name=e},Fn.prototype.getName=function(){return this.name},Fn.prototype.setName=function(e){this.name=e},Fn.prototype.getShader=function(){return this.shader},Fn.prototype.setShader=function(e){this.shader=e};var Kp={Animation:lt,Key:ot,Node:ht,Skeleton:ji},Zp={AudioManager:at,Channel:Nh,Channel3d:Uh,Listener:rt,Sound:Rt};at.prototype.getListener=function(){return this.listener},at.prototype.getVolume=function(){return this.volume},at.prototype.setVolume=function(e){this.volume=e},Ei.prototype.getAssetById=function(e){return this.get(e)},Object.defineProperty(Fi.prototype,"ray",{get:function(){return this._rayLocal}}),Object.defineProperty(Fi.prototype,"position",{get:function(){return this._localPosition}}),Object.defineProperty(Fi.prototype,"rotation",{get:function(){return this._localRotation}});var $p={getTouchTargetCoords:wr,Controller:fr,GamePads:br,Keyboard:dr,KeyboardEvent:hr,Mouse:pr,MouseEvent:ur,Touch:xr,TouchDevice:Tr,TouchEvent:Sr};Object.defineProperty(vr.prototype,"wheel",{get:function(){return-2*this.wheelDelta}}),Object.defineProperty(ur.prototype,"wheel",{get:function(){return-2*this.wheelDelta}});var Qp=xc,Jp={Application:Ln,Component:Ui,ComponentData:Pr,ComponentSystem:zi,Entity:ut,FillMode:{NONE:"NONE",FILL_WINDOW:"FILL_WINDOW",KEEP_ASPECT:jl},ResolutionMode:{AUTO:"AUTO",FIXED:Wl}};Ln.prototype.isFullscreen=function(){return!!document.fullscreenElement},Ln.prototype.enableFullscreen=function(e,t,i){e=e||this.graphicsDevice.canvas;var s=function(){t(),document.removeEventListener("fullscreenchange",s)},n=function(){i(),document.removeEventListener("fullscreenerror",n)};t&&document.addEventListener("fullscreenchange",s,!1),i&&document.addEventListener("fullscreenerror",n,!1),e.requestFullscreen?e.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):i()},Ln.prototype.disableFullscreen=function(e){var t=function(){e(),document.removeEventListener("fullscreenchange",t)};e&&document.addEventListener("fullscreenchange",t,!1),document.exitFullscreen()},Object.defineProperty(Vs.prototype,"enable",{get:function(){return this.enabled},set:function(e){this.enabled=e}}),Object.defineProperty(Zs.prototype,"bodyType",{get:function(){return this.type},set:function(e){this.type=e}}),Zs.prototype.syncBodyToEntity=function(){this._updateDynamic()},sn.prototype.setGravity=function(){1===arguments.length?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])},e.ABSOLUTE_URL=qh,e.ACTION_GAMEPAD="gamepad",e.ACTION_KEYBOARD="keyboard",e.ACTION_MOUSE="mouse",e.ADDRESS_CLAMP_TO_EDGE=1,e.ADDRESS_MIRRORED_REPEAT=2,e.ADDRESS_REPEAT=0,e.ANIM_EQUAL_TO="EQUAL_TO",e.ANIM_GREATER_THAN="GREATER_THAN",e.ANIM_GREATER_THAN_EQUAL_TO="GREATER_THAN_EQUAL_TO",e.ANIM_INTERRUPTION_NEXT="NEXT_STATE",e.ANIM_INTERRUPTION_NEXT_PREV="NEXT_STATE_PREV_STATE",e.ANIM_INTERRUPTION_NONE="NONE",e.ANIM_INTERRUPTION_PREV="PREV_STATE",e.ANIM_INTERRUPTION_PREV_NEXT="PREV_STATE_NEXT_STATE",e.ANIM_LESS_THAN="LESS_THAN",e.ANIM_LESS_THAN_EQUAL_TO="LESS_THAN_EQUAL_TO",e.ANIM_NOT_EQUAL_TO="NOT_EQUAL_TO",e.ANIM_PARAMETER_BOOLEAN="BOOLEAN",e.ANIM_PARAMETER_FLOAT="FLOAT",e.ANIM_PARAMETER_INTEGER="INTEGER",e.ANIM_PARAMETER_TRIGGER="TRIGGER",e.ANIM_STATE_END="END",e.ANIM_STATE_START="START",e.ASPECT_AUTO=0,e.ASPECT_MANUAL=1,e.ASSET_ANIMATION="animation",e.ASSET_AUDIO="audio",e.ASSET_CONTAINER="container",e.ASSET_CSS="css",e.ASSET_CUBEMAP="cubemap",e.ASSET_HTML="html",e.ASSET_IMAGE="image",e.ASSET_JSON="json",e.ASSET_MATERIAL="material",e.ASSET_MODEL="model",e.ASSET_SCRIPT="script",e.ASSET_SHADER="shader",e.ASSET_TEXT="text",e.ASSET_TEXTURE="texture",e.AXIS_KEY="key",e.AXIS_MOUSE_X="mousex",e.AXIS_MOUSE_Y="mousey",e.AXIS_PAD_L_X="padlx",e.AXIS_PAD_L_Y="padly",e.AXIS_PAD_R_X="padrx",e.AXIS_PAD_R_Y="padry",e.AnimBinder=bt,e.AnimClip=yt,e.AnimClipHandler=Ct,e.AnimComponent=Qi,e.AnimComponentLayer=Yi,e.AnimComponentSystem=es,e.AnimController=$i,e.AnimCurve=mt,e.AnimData=pt,e.AnimEvaluator=St,e.AnimPropertyLocator=dt,e.AnimSnapshot=gt,e.AnimStateGraph=It,e.AnimStateGraphHandler=Ot,e.AnimTarget=vt,e.AnimTrack=_t,e.Animation=lt,e.AnimationComponent=Wi,e.AnimationComponentSystem=Xi,e.AnimationHandler=Et,e.Application=Ln,e.Asset=Pt,e.AssetListLoader=qt,e.AssetReference=Qt,e.AssetRegistry=Ei,e.AudioHandler=Dt,e.AudioListenerComponent=ts,e.AudioListenerComponentSystem=ss,e.AudioSourceComponent=ns,e.AudioSourceComponentSystem=as,e.BAKE_COLOR=0,e.BAKE_COLORDIR=1,e.BLENDEQUATION_ADD=0,e.BLENDEQUATION_MAX=4,e.BLENDEQUATION_MIN=3,e.BLENDEQUATION_REVERSE_SUBTRACT=2,e.BLENDEQUATION_SUBTRACT=1,e.BLENDMODE_DST_ALPHA=9,e.BLENDMODE_DST_COLOR=4,e.BLENDMODE_ONE=1,e.BLENDMODE_ONE_MINUS_DST_ALPHA=10,e.BLENDMODE_ONE_MINUS_DST_COLOR=5,e.BLENDMODE_ONE_MINUS_SRC_ALPHA=8,e.BLENDMODE_ONE_MINUS_SRC_COLOR=3,e.BLENDMODE_SRC_ALPHA=6,e.BLENDMODE_SRC_ALPHA_SATURATE=7,e.BLENDMODE_SRC_COLOR=2,e.BLENDMODE_ZERO=0,e.BLEND_ADDITIVE=1,e.BLEND_ADDITIVEALPHA=6,e.BLEND_MAX=10,e.BLEND_MIN=9,e.BLEND_MULTIPLICATIVE=5,e.BLEND_MULTIPLICATIVE2X=7,e.BLEND_NONE=3,e.BLEND_NORMAL=2,e.BLEND_PREMULTIPLIED=4,e.BLEND_SCREEN=8,e.BLEND_SUBTRACTIVE=0,e.BLUR_BOX=0,e.BLUR_GAUSSIAN=1,e.BODYFLAG_KINEMATIC_OBJECT=2,e.BODYFLAG_NORESPONSE_OBJECT=4,e.BODYFLAG_STATIC_OBJECT=1,e.BODYGROUP_DEFAULT=1,e.BODYGROUP_DYNAMIC=1,e.BODYGROUP_ENGINE_1=8,e.BODYGROUP_ENGINE_2=32,e.BODYGROUP_ENGINE_3=64,e.BODYGROUP_KINEMATIC=4,e.BODYGROUP_NONE=0,e.BODYGROUP_STATIC=Sc,e.BODYGROUP_TRIGGER=16,e.BODYGROUP_USER_1=128,e.BODYGROUP_USER_2=256,e.BODYGROUP_USER_3=512,e.BODYGROUP_USER_4=1024,e.BODYGROUP_USER_5=2048,e.BODYGROUP_USER_6=4096,e.BODYGROUP_USER_7=8192,e.BODYGROUP_USER_8=16384,e.BODYMASK_ALL=65535,e.BODYMASK_NONE=0,e.BODYMASK_NOT_STATIC=Tc,e.BODYMASK_NOT_STATIC_KINEMATIC=65529,e.BODYMASK_STATIC=2,e.BODYSTATE_ACTIVE_TAG=1,e.BODYSTATE_DISABLE_DEACTIVATION=4,e.BODYSTATE_DISABLE_SIMULATION=5,e.BODYSTATE_ISLAND_SLEEPING=2,e.BODYSTATE_WANTS_DEACTIVATION=3,e.BODYTYPE_DYNAMIC="dynamic",e.BODYTYPE_KINEMATIC="kinematic",e.BODYTYPE_STATIC=xc,e.BUFFER_DYNAMIC=1,e.BUFFER_GPUDYNAMIC=3,e.BUFFER_STATIC=0,e.BUFFER_STREAM=2,e.BUTTON_TRANSITION_MODE_SPRITE_CHANGE=1,e.BUTTON_TRANSITION_MODE_TINT=ac,e.BasicMaterial=Ce,e.BasisParser=Si,e.Batch=he,e.BatchGroup=le,e.BatchManager=de,e.BinaryHandler=Lt,e.BoundingBox=w,e.BoundingSphere=M,e.Bundle=Ft,e.BundleHandler=kt,e.BundleRegistry=Ci,e.ButtonComponent=hs,e.ButtonComponentSystem=cs,e.CLEARFLAG_COLOR=1,e.CLEARFLAG_DEPTH=2,e.CLEARFLAG_STENCIL=4,e.COMPUPDATED_BLEND=8,e.COMPUPDATED_CAMERAS=4,e.COMPUPDATED_INSTANCES=1,e.COMPUPDATED_LIGHTS=2,e.CUBEFACE_NEGX=1,e.CUBEFACE_NEGY=3,e.CUBEFACE_NEGZ=5,e.CUBEFACE_POSX=0,e.CUBEFACE_POSY=2,e.CUBEFACE_POSZ=4,e.CUBEPROJ_BOX=1,e.CUBEPROJ_NONE=0,e.CULLFACE_BACK=1,e.CULLFACE_FRONT=2,e.CULLFACE_FRONTANDBACK=3,e.CULLFACE_NONE=0,e.CURVE_CARDINAL=3,e.CURVE_CATMULL=2,e.CURVE_LINEAR=0,e.CURVE_SMOOTHSTEP=1,e.CURVE_SPLINE=4,e.CURVE_STEP=5,e.Camera=_e,e.CameraComponent=fc,e.CameraComponentSystem=_c,e.CanvasFont=Mr,e.CollisionComponent=gc,e.CollisionComponentSystem=Bc,e.Color=h,e.Command=te,e.Component=Ui,e.ComponentData=Pr,e.ComponentSystem=zi,e.ComponentSystemRegistry=ms,e.ContactPoint=en,e.ContactResult=tn,e.ContainerHandler=zt,e.ContainerResource=Ut,e.ContextCreationError=Or,e.Controller=fr,e.CssHandler=Vt,e.CubemapHandler=Gt,e.Curve=_,e.CurveSet=g,e.DETAILMODE_ADD="add",e.DETAILMODE_MAX="max",e.DETAILMODE_MIN="min",e.DETAILMODE_MUL="mul",e.DETAILMODE_OVERLAY="overlay",e.DETAILMODE_SCREEN="screen",e.DISTANCE_EXPONENTIAL="exponential",e.DISTANCE_INVERSE=kh,e.DISTANCE_LINEAR="linear",e.DefaultAnimBinder=xt,e.DepthMaterial=Qn,e.ELEMENTTYPE_FLOAT32=6,e.ELEMENTTYPE_GROUP=Nc,e.ELEMENTTYPE_IMAGE="image",e.ELEMENTTYPE_INT16=2,e.ELEMENTTYPE_INT32=4,e.ELEMENTTYPE_INT8=0,e.ELEMENTTYPE_TEXT="text",e.ELEMENTTYPE_UINT16=3,e.ELEMENTTYPE_UINT32=5,e.ELEMENTTYPE_UINT8=1,e.EMITTERSHAPE_BOX=0,e.EMITTERSHAPE_SPHERE=1,e.EVENT_KEYDOWN="keydown",e.EVENT_KEYUP="keyup",e.EVENT_MOUSEDOWN="mousedown",e.EVENT_MOUSEMOVE="mousemove",e.EVENT_MOUSEUP="mouseup",e.EVENT_MOUSEWHEEL="mousewheel",e.EVENT_SELECT="select",e.EVENT_SELECTEND="selectend",e.EVENT_SELECTSTART="selectstart",e.EVENT_TOUCHCANCEL="touchcancel",e.EVENT_TOUCHEND="touchend",e.EVENT_TOUCHMOVE="touchmove",e.EVENT_TOUCHSTART="touchstart",e.ElementComponent=As,e.ElementComponentSystem=Cs,e.ElementDragHelper=gn,e.ElementInput=vr,e.ElementInputEvent=mr,e.ElementMouseEvent=_r,e.ElementSelectEvent=yr,e.ElementTouchEvent=gr,e.Entity=ut,e.EntityReference=os,e.EventHandler=r,e.FILLMODE_FILL_WINDOW="FILL_WINDOW",e.FILLMODE_KEEP_ASPECT=jl,e.FILLMODE_NONE="NONE",e.FILTER_LINEAR=1,e.FILTER_LINEAR_MIPMAP_LINEAR=5,e.FILTER_LINEAR_MIPMAP_NEAREST=4,e.FILTER_NEAREST=0,e.FILTER_NEAREST_MIPMAP_LINEAR=3,e.FILTER_NEAREST_MIPMAP_NEAREST=2,e.FITTING_BOTH=3,e.FITTING_NONE=Qc,e.FITTING_SHRINK=2,e.FITTING_STRETCH=1,e.FOG_EXP="exp",e.FOG_EXP2="exp2",e.FOG_LINEAR="linear",e.FOG_NONE="none",e.FONT_BITMAP="bitmap",e.FONT_MSDF="msdf",e.FRESNEL_NONE=0,e.FRESNEL_SCHLICK=2,e.FUNC_ALWAYS=7,e.FUNC_EQUAL=2,e.FUNC_GREATER=4,e.FUNC_GREATEREQUAL=6,e.FUNC_LESS=1,e.FUNC_LESSEQUAL=3,e.FUNC_NEVER=0,e.FUNC_NOTEQUAL=5,e.FolderHandler=jt,e.Font=Wt,e.FontHandler=Xt,e.ForwardRenderer=Ae,e.Frustum=P,e.GAMMA_NONE=0,e.GAMMA_SRGB=1,e.GAMMA_SRGBFAST=2,e.GAMMA_SRGBHDR=3,e.GamePads=br,e.GraphNode=ge,e.GraphicsDevice=Lu,e.HierarchyHandler=Kt,e.HtmlHandler=Zt,e.Http=f,e.I18n=wt,e.INDEXFORMAT_UINT16=1,e.INDEXFORMAT_UINT32=2,e.INDEXFORMAT_UINT8=0,e.INTERPOLATION_CUBIC=2,e.INTERPOLATION_LINEAR=1,e.INTERPOLATION_STEP=0,e.ImageElement=ys,e.ImgParser=Ti,e.IndexBuffer=Z,e.IndexedList=l,e.JsonHandler=$t,e.JsonStandardMaterialParser=ei,e.KEY_0=48,e.KEY_1=49,e.KEY_2=50,e.KEY_3=51,e.KEY_4=52,e.KEY_5=53,e.KEY_6=54,e.KEY_7=55,e.KEY_8=56,e.KEY_9=57,e.KEY_A=65,e.KEY_ADD=107,e.KEY_ALT=18,e.KEY_B=66,e.KEY_BACKSPACE=8,e.KEY_BACK_SLASH=220,e.KEY_C=67,e.KEY_CAPS_LOCK=20,e.KEY_CLOSE_BRACKET=221,e.KEY_COMMA=188,e.KEY_CONTEXT_MENU=93,e.KEY_CONTROL=17,e.KEY_D=68,e.KEY_DECIMAL=110,e.KEY_DELETE=46,e.KEY_DIVIDE=111,e.KEY_DOWN=40,e.KEY_E=69,e.KEY_END=35,e.KEY_ENTER=13,e.KEY_EQUAL=61,e.KEY_ESCAPE=27,e.KEY_F=70,e.KEY_F1=112,e.KEY_F10=121,e.KEY_F11=122,e.KEY_F12=123,e.KEY_F2=113,e.KEY_F3=114,e.KEY_F4=115,e.KEY_F5=116,e.KEY_F6=117,e.KEY_F7=118,e.KEY_F8=119,e.KEY_F9=120,e.KEY_G=71,e.KEY_H=72,e.KEY_HOME=36,e.KEY_I=73,e.KEY_INSERT=45,e.KEY_J=74,e.KEY_K=75,e.KEY_L=76,e.KEY_LEFT=37,e.KEY_M=77,e.KEY_META=224,e.KEY_MULTIPLY=106,e.KEY_N=78,e.KEY_NUMPAD_0=96,e.KEY_NUMPAD_1=97,e.KEY_NUMPAD_2=98,e.KEY_NUMPAD_3=99,e.KEY_NUMPAD_4=100,e.KEY_NUMPAD_5=101,e.KEY_NUMPAD_6=102,e.KEY_NUMPAD_7=103,e.KEY_NUMPAD_8=104,e.KEY_NUMPAD_9=105,e.KEY_O=79,e.KEY_OPEN_BRACKET=219,e.KEY_P=80,e.KEY_PAGE_DOWN=34,e.KEY_PAGE_UP=33,e.KEY_PAUSE=19,e.KEY_PERIOD=190,e.KEY_PRINT_SCREEN=44,e.KEY_Q=81,e.KEY_R=82,e.KEY_RETURN=13,e.KEY_RIGHT=39,e.KEY_S=83,e.KEY_SEMICOLON=59,e.KEY_SEPARATOR=108,e.KEY_SHIFT=16,e.KEY_SLASH=191,e.KEY_SPACE=32,e.KEY_SUBTRACT=109,e.KEY_T=84,e.KEY_TAB=9,e.KEY_U=85,e.KEY_UP=38,e.KEY_V=86,e.KEY_W=87,e.KEY_WINDOWS=91,e.KEY_X=88,e.KEY_Y=89,e.KEY_Z=90,e.Key=ot,e.Keyboard=dr,e.KeyboardEvent=hr,e.KtxParser=wi,e.LAYERID_DEPTH=1,e.LAYERID_IMMEDIATE=3,e.LAYERID_SKYBOX=2,e.LAYERID_UI=4,e.LAYERID_WORLD=0,e.LAYER_FX=2,e.LAYER_GIZMO=1,e.LAYER_HUD=0,e.LAYER_WORLD=15,e.LIGHTFALLOFF_INVERSESQUARED=1,e.LIGHTFALLOFF_LINEAR=0,e.LIGHTTYPE_DIRECTIONAL=0,e.LIGHTTYPE_POINT=1,e.LIGHTTYPE_SPOT=2,e.LINEBATCH_GIZMO=2,e.LINEBATCH_OVERLAY=1,e.LINEBATCH_WORLD=0,e.Layer=Se,e.LayerComposition=Re,e.LayoutCalculator=Ds,e.LayoutChildComponent=Is,e.LayoutChildComponentSystem=$c,e.LayoutGroupComponent=Fs,e.LayoutGroupComponentSystem=zs,e.LegacyDdsParser=Mi,e.Light=cd,e.LightComponent=Vs,e.LightComponentSystem=js,e.Lightmapper=Le,e.LocalizedAsset=vs,e.MASK_BAKED=2,e.MASK_DYNAMIC=1,e.MASK_LIGHTMAP=4,e.MOUSEBUTTON_LEFT=0,e.MOUSEBUTTON_MIDDLE=1,e.MOUSEBUTTON_NONE=-1,e.MOUSEBUTTON_RIGHT=2,e.Mat3=y,e.Mat4=x,e.Material=Fn,e.MaterialHandler=ti,e.Mesh=J,e.MeshInstance=ee,e.Model=oe,e.ModelComponent=Ws,e.ModelComponentSystem=Xs,e.ModelHandler=oi,e.Morph=se,e.MorphInstance=ne,e.MorphTarget=ct,e.Mouse=pr,e.MouseEvent=ur,e.Node=ht,e.ORIENTATION_HORIZONTAL=0,e.ORIENTATION_VERTICAL=1,e.OrientedBox=E,e.PAD_1=0,e.PAD_2=1,e.PAD_3=2,e.PAD_4=3,e.PAD_DOWN=13,e.PAD_FACE_1=0,e.PAD_FACE_2=1,e.PAD_FACE_3=2,e.PAD_FACE_4=3,e.PAD_LEFT=14,e.PAD_L_SHOULDER_1=4,e.PAD_L_SHOULDER_2=6,e.PAD_L_STICK_BUTTON=10,e.PAD_L_STICK_X=0,e.PAD_L_STICK_Y=1,e.PAD_RIGHT=15,e.PAD_R_SHOULDER_1=5,e.PAD_R_SHOULDER_2=7,e.PAD_R_STICK_BUTTON=11,e.PAD_R_STICK_X=2,e.PAD_R_STICK_Y=3,e.PAD_SELECT=8,e.PAD_START=9,e.PAD_UP=12,e.PAD_VENDOR=16,e.PARTICLEMODE_CPU=1,e.PARTICLEMODE_GPU=0,e.PARTICLEORIENTATION_EMITTER=2,e.PARTICLEORIENTATION_SCREEN=0,e.PARTICLEORIENTATION_WORLD=1,e.PARTICLESORT_DISTANCE=1,e.PARTICLESORT_NEWER_FIRST=2,e.PARTICLESORT_NONE=0,e.PARTICLESORT_OLDER_FIRST=3,e.PIXELFORMAT_111110F=18,e.PIXELFORMAT_A8=0,e.PIXELFORMAT_ASTC_4x4=28,e.PIXELFORMAT_ATC_RGB=29,e.PIXELFORMAT_ATC_RGBA=30,e.PIXELFORMAT_DEPTH=16,e.PIXELFORMAT_DEPTHSTENCIL=17,e.PIXELFORMAT_DXT1=8,e.PIXELFORMAT_DXT3=9,e.PIXELFORMAT_DXT5=10,e.PIXELFORMAT_ETC1=21,e.PIXELFORMAT_ETC2_RGB=22,e.PIXELFORMAT_ETC2_RGBA=23,e.PIXELFORMAT_L8=1,e.PIXELFORMAT_L8_A8=2,e.PIXELFORMAT_PVRTC_2BPP_RGBA_1=25,e.PIXELFORMAT_PVRTC_2BPP_RGB_1=24,e.PIXELFORMAT_PVRTC_4BPP_RGBA_1=27,e.PIXELFORMAT_PVRTC_4BPP_RGB_1=26,e.PIXELFORMAT_R32F=15,e.PIXELFORMAT_R4_G4_B4_A4=5,e.PIXELFORMAT_R5_G5_B5_A1=4,e.PIXELFORMAT_R5_G6_B5=3,e.PIXELFORMAT_R8_G8_B8=6,e.PIXELFORMAT_R8_G8_B8_A8=7,e.PIXELFORMAT_RGB16F=11,e.PIXELFORMAT_RGB32F=13,e.PIXELFORMAT_RGBA16F=12,e.PIXELFORMAT_RGBA32F=14,e.PIXELFORMAT_SRGB=19,e.PIXELFORMAT_SRGBA=20,e.PRIMITIVE_LINELOOP=2,e.PRIMITIVE_LINES=1,e.PRIMITIVE_LINESTRIP=3,e.PRIMITIVE_POINTS=0,e.PRIMITIVE_TRIANGLES=4,e.PRIMITIVE_TRIFAN=6,e.PRIMITIVE_TRISTRIP=5,e.PROJECTION_ORTHOGRAPHIC=1,e.PROJECTION_PERSPECTIVE=0,e.ParticleEmitter=Bh,e.ParticleSystemComponent=Td,e.ParticleSystemComponentSystem=Ys,e.PhongMaterial=qp,e.Picker=Jn,e.Plane=C,e.PostEffect=Yn,e.PostEffectPass=Cr,e.PostEffectQueue=us,e.ProgramLibrary=kn,e.Quat=S,e.RENDERSTYLE_POINTS=2,e.RENDERSTYLE_SOLID=0,e.RENDERSTYLE_WIREFRAME=1,e.RESOLUTION_AUTO="AUTO",e.RESOLUTION_FIXED=Wl,e.RIGIDBODY_ACTIVE_TAG=1,e.RIGIDBODY_CF_KINEMATIC_OBJECT=2,e.RIGIDBODY_CF_NORESPONSE_OBJECT=4,e.RIGIDBODY_CF_STATIC_OBJECT=1,e.RIGIDBODY_DISABLE_DEACTIVATION=4,e.RIGIDBODY_DISABLE_SIMULATION=5,e.RIGIDBODY_ISLAND_SLEEPING=2,e.RIGIDBODY_TYPE_DYNAMIC="dynamic",e.RIGIDBODY_TYPE_KINEMATIC="kinematic",e.RIGIDBODY_TYPE_STATIC=Qp,e.RIGIDBODY_WANTS_DEACTIVATION=3,e.Ray=A,e.RaycastResult=Qs,e.RenderTarget=Bu,e.ResourceHandler=or,e.ResourceLoader=hi,e.RigidBodyComponent=Zs,e.RigidBodyComponentSystem=sn,e.SCALEMODE_BLEND="blend",e.SCALEMODE_NONE=Fd,e.SCROLLBAR_VISIBILITY_SHOW_ALWAYS=0,e.SCROLLBAR_VISIBILITY_SHOW_WHEN_REQUIRED=1,e.SCROLL_MODE_BOUNCE=1,e.SCROLL_MODE_CLAMP=0,e.SCROLL_MODE_INFINITE=2,e.SEMANTIC_ATTR="ATTR",e.SEMANTIC_ATTR0="ATTR0",e.SEMANTIC_ATTR1="ATTR1",e.SEMANTIC_ATTR10="ATTR10",e.SEMANTIC_ATTR11="ATTR11",e.SEMANTIC_ATTR12="ATTR12",e.SEMANTIC_ATTR13="ATTR13",e.SEMANTIC_ATTR14="ATTR14",e.SEMANTIC_ATTR15="ATTR15",e.SEMANTIC_ATTR2="ATTR2",e.SEMANTIC_ATTR3="ATTR3",e.SEMANTIC_ATTR4="ATTR4",e.SEMANTIC_ATTR5="ATTR5",e.SEMANTIC_ATTR6="ATTR6",e.SEMANTIC_ATTR7="ATTR7",e.SEMANTIC_ATTR8="ATTR8",e.SEMANTIC_ATTR9="ATTR9",e.SEMANTIC_BLENDINDICES="BLENDINDICES",e.SEMANTIC_BLENDWEIGHT="BLENDWEIGHT",e.SEMANTIC_COLOR="COLOR",e.SEMANTIC_NORMAL="NORMAL",e.SEMANTIC_POSITION="POSITION",e.SEMANTIC_TANGENT="TANGENT",e.SEMANTIC_TEXCOORD="TEXCOORD",e.SEMANTIC_TEXCOORD0="TEXCOORD0",e.SEMANTIC_TEXCOORD1="TEXCOORD1",e.SEMANTIC_TEXCOORD2="TEXCOORD2",e.SEMANTIC_TEXCOORD3="TEXCOORD3",e.SEMANTIC_TEXCOORD4="TEXCOORD4",e.SEMANTIC_TEXCOORD5="TEXCOORD5",e.SEMANTIC_TEXCOORD6="TEXCOORD6",e.SEMANTIC_TEXCOORD7="TEXCOORD7",e.SHADERDEF_DIRLM=128,e.SHADERDEF_INSTANCING=32,e.SHADERDEF_LM=64,e.SHADERDEF_MORPH_NORMAL=2048,e.SHADERDEF_MORPH_POSITION=1024,e.SHADERDEF_MORPH_TEXTURE_BASED=4096,e.SHADERDEF_NOSHADOW=1,e.SHADERDEF_SCREENSPACE=256,e.SHADERDEF_SKIN=2,e.SHADERDEF_TANGENTS=512,e.SHADERDEF_UV0=4,e.SHADERDEF_UV1=8,e.SHADERDEF_VCOLOR=16,e.SHADERTAG_MATERIAL=1,e.SHADER_DEPTH=2,e.SHADER_FORWARD=0,e.SHADER_FORWARDHDR=1,e.SHADER_PICK=18,e.SHADER_SHADOW=3,e.SHADOWUPDATE_NONE=0,e.SHADOWUPDATE_REALTIME=2,e.SHADOWUPDATE_THISFRAME=1,e.SHADOW_DEPTH=0,e.SHADOW_PCF3=0,e.SHADOW_PCF5=4,e.SHADOW_VSM16=2,e.SHADOW_VSM32=3,e.SHADOW_VSM8=1,e.SORTKEY_DEPTH=1,e.SORTKEY_FORWARD=0,e.SORTMODE_BACK2FRONT=3,e.SORTMODE_CUSTOM=5,e.SORTMODE_FRONT2BACK=4,e.SORTMODE_MANUAL=1,e.SORTMODE_MATERIALMESH=2,e.SORTMODE_NONE=0,e.SPECOCC_AO=1,e.SPECOCC_GLOSSDEPENDENT=2,e.SPECOCC_NONE=0,e.SPECULAR_BLINN=1,e.SPECULAR_PHONG=0,e.SPRITETYPE_ANIMATED="animated",e.SPRITETYPE_SIMPLE="simple",e.SPRITE_RENDERMODE_SIMPLE=0,e.SPRITE_RENDERMODE_SLICED=1,e.SPRITE_RENDERMODE_TILED=2,e.STENCILOP_DECREMENT=5,e.STENCILOP_DECREMENTWRAP=6,e.STENCILOP_INCREMENT=3,e.STENCILOP_INCREMENTWRAP=4,e.STENCILOP_INVERT=7,e.STENCILOP_KEEP=0,e.STENCILOP_REPLACE=2,e.STENCILOP_ZERO=1,e.Scene=it,e.SceneHandler=li,e.SceneRegistry=Dn,e.SceneRegistryItem=Rn,e.SceneSettingsHandler=ci,e.ScopeId=Vn,e.ScopeSpace=Gn,e.ScreenComponent=nn,e.ScreenComponentSystem=an,e.ScriptAttributes=on,e.ScriptComponent=un,e.ScriptComponentSystem=fn,e.ScriptHandler=di,e.ScriptLegacyComponent=mn,e.ScriptLegacyComponentSystem=Xd,e.ScriptRegistry=Ii,e.ScriptType=hn,e.ScrollViewComponent=yn,e.ScrollViewComponentSystem=su,e.ScrollbarComponent=bn,e.ScrollbarComponentSystem=Sn,e.Shader=Y,e.ShaderHandler=ui,e.SingleContactResult=Js,e.Skeleton=ji,e.Skin=re,e.SkinInstance=ae,e.SortedLoopArray=dn,e.Sound=Rt,e.SoundComponent=wn,e.SoundComponentSystem=hu,e.SoundManager=at,e.SoundSlot=Tn,e.Sprite=pi,e.SpriteAnimationClip=Pn,e.SpriteComponent=lu,e.SpriteComponentSystem=En,e.SpriteHandler=fi,e.StandardMaterial=Nn,e.StencilParameters=_s,e.TEXHINT_ASSET=2,e.TEXHINT_LIGHTMAP=3,e.TEXHINT_NONE=0,e.TEXHINT_SHADOWMAP=1,e.TEXTURELOCK_READ=1,e.TEXTURELOCK_WRITE=2,e.TEXTURETYPE_DEFAULT="default",e.TEXTURETYPE_RGBE="rgbe",e.TEXTURETYPE_RGBM="rgbm",e.TEXTURETYPE_SWIZZLEGGGR="swizzleGGGR",e.TONEMAP_ACES=3,e.TONEMAP_ACES2=4,e.TONEMAP_FILMIC=1,e.TONEMAP_HEJL=2,e.TONEMAP_LINEAR=0,e.TYPE_FLOAT32=6,e.TYPE_INT16=2,e.TYPE_INT32=4,e.TYPE_INT8=0,e.TYPE_UINT16=3,e.TYPE_UINT32=5,e.TYPE_UINT8=1,e.Tags=d,e.Template=gi,e.TemplateHandler=yi,e.TemplateUtils=xl,e.TextElement=Ps,e.TextHandler=vi,e.Texture=K,e.TextureAtlas=bi,e.TextureAtlasHandler=xi,e.TextureHandler=Ai,e.TextureParser=Pi,e.Timer=u,e.Touch=xr,e.TouchDevice=Tr,e.TouchEvent=Sr,e.TransformFeedback=$n,e.UNIFORMTYPE_BOOL=0,e.UNIFORMTYPE_BVEC2=9,e.UNIFORMTYPE_BVEC3=10,e.UNIFORMTYPE_BVEC4=11,e.UNIFORMTYPE_FLOAT=2,e.UNIFORMTYPE_FLOATARRAY=17,e.UNIFORMTYPE_INT=1,e.UNIFORMTYPE_IVEC2=6,e.UNIFORMTYPE_IVEC3=7,e.UNIFORMTYPE_IVEC4=8,e.UNIFORMTYPE_MAT2=12,e.UNIFORMTYPE_MAT3=13,e.UNIFORMTYPE_MAT4=14,e.UNIFORMTYPE_TEXTURE2D=15,e.UNIFORMTYPE_TEXTURE2D_SHADOW=18,e.UNIFORMTYPE_TEXTURE3D=20,e.UNIFORMTYPE_TEXTURECUBE=16,e.UNIFORMTYPE_TEXTURECUBE_SHADOW=19,e.UNIFORMTYPE_VEC2=3,e.UNIFORMTYPE_VEC3=4,e.UNIFORMTYPE_VEC4=5,e.URI=p,e.UnsupportedBrowserError=Ir,e.VIEW_CENTER=0,e.VIEW_LEFT=1,e.VIEW_RIGHT=2,e.Vec2=T,e.Vec3=v,e.Vec4=b,e.VertexBuffer=I,e.VertexFormat=R,e.VertexIterator=X,e.VrDisplay=Oi,e.VrManager=Ri,e.XRHAND_LEFT="left",e.XRHAND_NONE="none",e.XRHAND_RIGHT="right",e.XRSPACE_BOUNDEDFLOOR="bounded-floor",e.XRSPACE_LOCAL="local",e.XRSPACE_LOCALFLOOR="local-floor",e.XRSPACE_UNBOUNDED="unbounded",e.XRSPACE_VIEWER="viewer",e.XRTARGETRAY_GAZE="gaze",e.XRTARGETRAY_POINTER="tracked-pointer",e.XRTARGETRAY_SCREEN="screen",e.XRTRACKABLE_MESH="mesh";e.XRTRACKABLE_PLANE="plane",e.XRTRACKABLE_POINT="point",e.XRTYPE_AR=ql,e.XRTYPE_INLINE=Hl,e.XRTYPE_VR=Xl,e.XrHitTest=Li,e.XrHitTestSource=Di,e.XrInput=Bi,e.XrInputSource=Fi,e.XrLightEstimation=Ni,e.XrManager=ki,e.ZoneComponent=Cn,e.ZoneComponentSystem=uu,e.anim=Kp,e.apps={},e.asset={ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",ASSET_MODEL:"model",ASSET_MATERIAL:"material",ASSET_TEXT:"text",ASSET_TEXTURE:"texture",ASSET_CUBEMAP:"cubemap",ASSET_SCRIPT:"script"},e.audio=Zp,e.basisDownload=rr,e.basisDownloadFromConfig=ar,e.basisInitialize=nr,e.basisTargetFormat=tr,e.basisTranscode=function(e,t,i,s){zu?sr(e,t,i,s):(ju.push({url:e,data:t,callback:i,options:s}),Uu||ar())},e.calculateNormals=He,e.calculateTangents=Xe,e.common={},e.config={},e.createBox=tt,e.createCapsule=$e,e.createCone=Qe,e.createCylinder=Ze,e.createMesh=qe,e.createPlane=et,e.createScript=ln,e.createSphere=Je,e.createStyle=function(e){var t=document.createElement("style");return t.type="text/css",t.styleSheet?t.styleSheet.cssText=e:t.appendChild(document.createTextNode(e)),t},e.createTorus=Ye,e.createURI=function(e){var t="";if((e.authority||e.scheme)&&(e.host||e.hostpath))throw Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(e.host&&e.hostpath)throw Error("Can't have 'host' and 'hostpath' option");if(e.path&&e.hostpath)throw Error("Can't have 'path' and 'hostpath' option");return e.scheme&&(t+=e.scheme+":"),e.authority&&(t+="//"+e.authority),e.host&&(t+=e.host),e.path&&(t+=e.path),e.hostpath&&(t+=e.hostpath),e.query&&(t+="?"+e.query),e.fragment&&(t+="#"+e.fragment),t},e.data={},e.debug=Nr,e.drawFullscreenQuad=Zn,e.drawQuadWithShader=q,e.drawTexture=function(e,t,i,s,n,r,a){s=s||e.getCopyShader(),e.constantTexSource.setValue(t),q(e,i,s,n,r,a)},e.events=kr,e.extend=s,e.fw=Jp,e.getTouchTargetCoords=wr,e.gfx=Hp,e.guid=Ur,e.http=qr,e.inherits=function(e,t){var i=function(){},s=function(i,s,n,r,a,o,h,l){t.call(this,i,s,n,r,a,o,h,l),e.call(this,i,s,n,r,a,o,h,l)};return s._super=t.prototype,i.prototype=t.prototype,s.prototype=new i,s},e.input=$p,e.isDefined=n,e.log=Gp,e.makeArray=t,e.math=Hr,e.now=Xr,e.path=zr,e.platform=Vr,e.posteffect=Xp,e.prefilterCubemap=function(e){var t=e.device,i=e.sourceCubemap,s=e.method,n=e.samples,r=e.cpuSync;if(r&&!i._levels[0])console.error("ERROR: prefilter: cubemap must have _levels");else{var a=Ma,o=i.type,h="rgbm"===o;n=a.createShaderFromCode(t,a.fullscreenQuadVS,a.rgbmPS+a.prefilterCubemapPS.replace(/\$METHOD/g,0===s?"cos":"phong").replace(/\$NUMSAMPLES/g,n).replace(/\$textureCube/g,h?"textureCubeRGBM":"textureCube"),"prefilter"+s+n+h);var l=a.createShaderFromCode(t,a.fullscreenQuadVS,a.outputCubemapPS,"outputCubemap"),c=t.scope.resolve("source"),d=t.scope.resolve("params"),u=new b,p=i.width;a=i.format;var f,m=[[],e.filteredFixed,e.filteredRgbm,e.filteredFixedRgbm],_=0===s?[.9,.85,.7,.4,.25,.15,.1]:[512,128,32,8,2,1,1],g=[64,32,16,8,4,2,1],y=!1;if(r&&(y=i._levels[0][0]instanceof HTMLImageElement),(6===a||y)&&r){var v=new K(t,{cubemap:!0,type:o,format:a=7,width:p,height:p,mipmaps:!1});for(v.name="prefiltered-cube",f=0;6>f;f++){var x=new Bu(t,v,{face:f,depth:!1});u.x=f,u.y=0,c.setValue(i),d.setValue(u.data),q(t,x,l),Hn(t,x,f)}i=v}if(128<p){var S=Math.round(Math.log2(p))-Math.round(Math.log2(128));for(y=0;y<S;y++){p=.5*i.width;var T=0===s?1:Math.pow(2,Math.round(Math.log2(_[0])+2*(S-y)));for((v=new K(t,{cubemap:!0,type:o,format:a,width:p,height:p,mipmaps:!1})).name="prefiltered-cube",f=0;6>f;f++)x=new Bu(t,v,{face:f,depth:!1}),u.x=f,u.y=T,u.z=p,u.w=h?3:0,c.setValue(i),d.setValue(u.data),q(t,x,l),y===S-1&&r&&Hn(t,x,f);i=v}}if(e.sourceCubemap=i,v=null,!h&&e.filteredFixedRgbm)for((v=new K(t,{cubemap:!0,type:"rgbm",format:7,width:p,height:p,mipmaps:!1})).name="prefiltered-cube",f=0;6>f;f++)x=new Bu(t,v,{face:f,depth:!1}),u.x=f,u.w=2,c.setValue(i),d.setValue(u.data),q(t,x,l),Hn(t,x,f);for(p=0===s?1:2048,m[x=0===s?0:-1]=[],y=0;7>y;y++)for(l=x;l<m.length;l++)null!=m[l]&&(m[l][y]=new K(t,{cubemap:!0,type:2>l?o:"rgbm",format:2>l?a:7,fixCubemapSeams:1===l||3===l,width:g[y],height:g[y],mipmaps:!1}),m[l][y].name="prefiltered-cube");for(l=x;l<m.length;l++)if(null!=m[l])if(1<l&&h)m[l]=m[l-2];else for(y=0;7>y;y++)for(f=0;6>f;f++)x=new Bu(t,m[l][y],{face:f,depth:!1}),u.x=f,u.y=0>l?p:_[y],u.z=g[y],u.w=h?3:l,c.setValue(0===y?i:0===s?m[0][y-1]:m[-1][y-1]),d.setValue(u.data),q(t,x,n),r&&Hn(t,x,f);if(e.filtered=m[0],r&&e.singleFilteredFixed){for(i=[i].concat(e.filteredFixed),(o=new K(t,{cubemap:!0,type:o,fixCubemapSeams:!0,format:a,width:128,height:128,addressU:1,addressV:1})).name="prefiltered-cube",y=0;y<i.length;y++)o._levels[y]=i[y]._levels[0];o.upload(),o._prefilteredMips=!0,e.singleFilteredFixed=o}if(r&&e.singleFilteredFixedRgbm&&e.filteredFixedRgbm){for(i=[v].concat(e.filteredFixedRgbm),(o=new K(t,{cubemap:!0,type:"rgbm",fixCubemapSeams:!0,format:7,width:128,height:128,addressU:1,addressV:1})).name="prefiltered-cube",y=0;y<i.length;y++)o._levels[y]=i[y]._levels[0];o.upload(),o._prefilteredMips=!0,e.singleFilteredFixedRgbm=o}}},e.programlib=wa,e.registerScript=cn,e.revision="878f4ce",e.scene=Yp,e.script=Rl,e.shFromCubemap=qn,e.shaderChunks=Ma,e.shape=Wp,e.string=Wr,e.time=jp,e.type=i,e.typedArrayIndexFormats=ua,e.typedArrayIndexFormatsByteSize=[1,2,4],e.typedArrayToType=da,e.typedArrayTypes=la,e.typedArrayTypesByteSize=ca,e.version="1.30.0",Object.defineProperty(e,"__esModule",{value:!0})});
ASSET_PREFIX="",SCRIPT_PREFIX="",SCENE_PATH="892687.json",CONTEXT_OPTIONS={antialias:!0,alpha:!1,preserveDrawingBuffer:!1,preferWebGl2:!0},SCRIPTS=[29217846,29217847,29217848,29217851,29217886,29217935,29218045,29218046,29230451,29262865,29348088,29349871,29361088,29388506,29389312,29394825,29394899,29872519,30118591,30415659,30415883,30875037,31274743,31280084,31384750,31410658,31484611,31484614,31484615,31542400,31542406,31665318,31668601,31668833,31709780,31709940,31709994,31710014,31711871,31722134,31847869,31887379,31942724,31961989,32098386,32098574,32192797,32192815,32215465],CONFIG_FILENAME="config.json",INPUT_SETTINGS={useKeyboard:!0,useMouse:!0,useGamepads:!1,useTouch:!0},pc.script.legacy=!1,PRELOAD_MODULES=[{moduleName:"Ammo",glueUrl:"files/assets/31014538/1/ammo.wasm.js",wasmUrl:"files/assets/31014539/1/ammo.wasm.wasm",fallbackUrl:"files/assets/31014537/1/ammo.js",preload:!0}];
var loadModules=function(e,n,o){function t(e,n,o,t){!function(e,n){var o=document.createElement("script");o.onload=function(){n()},o.onerror=function(){throw new Error("failed to load "+e)},o.async=!0,o.src=e,document.head.appendChild(o)}(n,function(){var n=window[e];window[e+"Lib"]=n,n({locateFile:function(){return o}}).then(function(n){window[e]=n,t()})})}if(void 0===e||0===e.length)setTimeout(o);else{var l=e.length,r=function(){0===--l&&o()},a=function(){try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return!1}();e.forEach(function(e){if(!e.hasOwnProperty("preload")||e.preload)if(a)t(e.moduleName,n+e.glueUrl,n+e.wasmUrl,r);else{if(!e.fallbackUrl)throw new Error("wasm not supported and no fallback supplied for module "+e.moduleName);t(e.moduleName,n+e.fallbackUrl,"",r)}else r()})}};
!function(){var e,t,n,o=function(){n.resizeCanvas(e.width,e.height),e.style.width="",e.style.height="";var t=n._fillMode;t!=pc.FILLMODE_NONE&&t!=pc.FILLMODE_KEEP_ASPECT||(t==pc.FILLMODE_NONE&&e.clientHeight<window.innerHeight||e.clientWidth/e.clientHeight>=window.innerWidth/window.innerHeight?e.style.marginTop=Math.floor((window.innerHeight-e.clientHeight)/2)+"px":e.style.marginTop="")},i=function(e){var t=document.createElement("div");t.innerHTML=['<table style="background-color: #8CE; width: 100%; height: 100%;">',"  <tr>",'      <td align="center">','          <div style="display: table-cell; vertical-align: middle;">','              <div style="">'+e+"</div>","          </div>","      </td>","  </tr>","</table>"].join("\n"),document.body.appendChild(t)};(e=document.createElement("canvas")).setAttribute("id","application-canvas"),e.setAttribute("tabindex",0),e.onselectstart=function(){return!1},document.body.appendChild(e),t=function(e){return{elementInput:new pc.ElementInput(e,{useMouse:INPUT_SETTINGS.useMouse,useTouch:INPUT_SETTINGS.useTouch}),keyboard:INPUT_SETTINGS.useKeyboard?new pc.Keyboard(window):null,mouse:INPUT_SETTINGS.useMouse?new pc.Mouse(e):null,gamepads:INPUT_SETTINGS.useGamepads?new pc.GamePads:null,touch:INPUT_SETTINGS.useTouch&&pc.platform.touch?new pc.TouchDevice(e):null}}(e=e);try{n=new pc.Application(e,{elementInput:t.elementInput,keyboard:t.keyboard,mouse:t.mouse,gamepads:t.gamepads,touch:t.touch,graphicsDeviceOptions:window.CONTEXT_OPTIONS,assetPrefix:window.ASSET_PREFIX||"",scriptPrefix:window.SCRIPT_PREFIX||"",scriptsOrder:window.SCRIPTS||[]})}catch(e){return void(e instanceof pc.UnsupportedBrowserError?i('This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to find out more.</a>'):e instanceof pc.ContextCreationError?i('It doesn\'t appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>'):i("Could not initialize application. Error: "+e))}var r=function(){n.configure(CONFIG_FILENAME,function(t){t&&console.error(t),function(t,n,o){e.classList&&e.classList.add("fill-mode-"+t);var i="@media screen and (min-aspect-ratio: "+n+"/"+o+") {";i+="    #application-canvas.fill-mode-KEEP_ASPECT {",i+="        width: auto;",i+="        height: 100%;",i+="        margin: 0 auto;",i+="    }",i+="}",document.head.querySelector&&(document.head.querySelector("style").innerHTML+=i)}(n._fillMode,n._width,n._height),setTimeout(function(){o(),window.addEventListener("resize",o,!1),window.addEventListener("orientationchange",o,!1),n.preload(function(e){e&&console.error(e),n.loadScene(SCENE_PATH,function(e,t){e&&console.error(e),n.start()})})})})};PRELOAD_MODULES.length>0?loadModules(PRELOAD_MODULES,ASSET_PREFIX,r):r()}();